<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash ‚Äî Data Entry</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,700;9..40,800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#f0f2f6;--surface:#fff;--s2:#f7f8fa;
  --border:rgba(0,0,0,0.08);--dark:#111827;--accent:#FFFF00;
  --muted:#6b7280;--ok:#16a34a;--warn:#d97706;--danger:#dc2626;
  --r:14px;--sh:0 2px 16px rgba(0,0,0,0.08);
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--dark);min-height:100vh;}

/* TOPBAR */
.topbar{position:fixed;top:0;left:0;right:0;z-index:200;height:54px;background:var(--dark);
  border-bottom:3px solid var(--accent);display:flex;align-items:center;
  justify-content:space-between;padding:0 24px;}
.logo{font-size:20px;font-weight:800;color:#fff;text-decoration:none;}
.logo span{color:var(--accent);}
.tb-badge{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);
  color:#ccc;padding:4px 13px;border-radius:20px;font-size:11px;font-weight:600;}

/* STATES */
.state{display:none;flex-direction:column;align-items:center;justify-content:center;
  min-height:100vh;padding:80px 20px 40px;text-align:center;gap:14px;}
.state.active{display:flex;}
.state-icon{font-size:44px;}.state-title{font-size:22px;font-weight:800;}
.state-sub{font-size:14px;color:var(--muted);max-width:380px;line-height:1.6;}
.spinner{width:36px;height:36px;border:3px solid rgba(0,0,0,0.1);
  border-top-color:var(--dark);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* MAIN */
#app{display:none;padding:62px 0 70px;}
#app.active{display:block;}
.wrap{max-width:760px;margin:0 auto;padding:20px 16px;display:flex;flex-direction:column;gap:14px;}

/* PROJECT HEADER */
.phdr{background:var(--dark);border-radius:var(--r);padding:16px 20px;
  display:flex;align-items:flex-start;gap:13px;box-shadow:var(--sh);}
.phdr-ico{width:42px;height:42px;border-radius:10px;background:rgba(255,255,255,0.1);
  display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0;margin-top:1px;}
.phdr-info{flex:1;min-width:0;}
.phdr-name{font-size:17px;font-weight:800;color:#fff;letter-spacing:-0.3px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.phdr-meta{font-size:11px;color:#777;margin-top:2px;}
.phdr-notice{margin-top:9px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);
  border-radius:7px;padding:8px 12px;font-size:11px;color:#aaa;line-height:1.5;
  display:flex;align-items:flex-start;gap:6px;}
.phdr-badge{background:var(--accent);color:var(--dark);font-size:9px;font-weight:800;
  text-transform:uppercase;letter-spacing:0.4px;padding:4px 11px;border-radius:20px;
  flex-shrink:0;white-space:nowrap;margin-top:1px;}

/* PROGRESS */
.prog-card{background:var(--surface);border-radius:var(--r);padding:11px 18px;
  box-shadow:var(--sh);display:flex;align-items:center;gap:12px;}
.prog-lbl{font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.4px;white-space:nowrap;}
.prog-track{flex:1;height:5px;background:rgba(0,0,0,0.08);border-radius:3px;overflow:hidden;}
.prog-fill{height:100%;background:var(--dark);border-radius:3px;transition:width .4s;}
.prog-pct{font-size:11px;font-weight:800;color:var(--dark);min-width:32px;text-align:right;font-family:'DM Mono',monospace;}

/* SUCCESS BANNER */
.ok-banner{display:none;background:#f0fdf4;border:1.5px solid #bbf7d0;
  border-radius:var(--r);padding:13px 18px;align-items:center;gap:10px;}
.ok-banner.show{display:flex;}
.ok-ico{font-size:18px;flex-shrink:0;}
.ok-txt{font-size:12px;color:#166534;font-weight:600;line-height:1.4;}

/* SECTION CARDS (standard form) */
.sc{background:var(--surface);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh);}
.sc-hdr{padding:11px 18px;border-bottom:1px solid var(--border);display:flex;
  align-items:center;gap:8px;cursor:pointer;user-select:none;transition:background .12s;}
.sc-hdr:hover{background:var(--s2);}
.sc-ico{font-size:14px;flex-shrink:0;}
.sc-ttl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;color:var(--dark);flex:1;}
.sc-cnt{font-size:9px;font-weight:700;background:var(--dark);color:var(--accent);
  padding:2px 7px;border-radius:20px;font-family:'DM Mono',monospace;}
.sc-chev{font-size:10px;color:var(--muted);transition:transform .2s;}
.sc-chev.open{transform:rotate(180deg);}
.sc-body{display:none;padding:15px 18px;}
.sc-body.open{display:block;}

/* FIELD GRID (shared) */
.fg{display:grid;grid-template-columns:1fr 1fr;gap:10px 13px;}
.fw{display:flex;flex-direction:column;gap:4px;}
.fw.c2{grid-column:span 2;}
.fl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;color:var(--muted);}
.fi,.fs{width:100%;padding:8px 10px;background:var(--s2);border:1.5px solid var(--border);
  border-radius:7px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;
  color:var(--dark);outline:none;transition:border-color .15s;-webkit-appearance:none;}
.fi:focus,.fs:focus{border-color:var(--dark);box-shadow:0 0 0 3px rgba(17,24,39,0.08);}
.fi::placeholder{color:#c4c9d4;}
.tog-w{display:flex;align-items:center;gap:8px;margin-top:3px;}
.tog-t{width:34px;height:19px;background:rgba(0,0,0,0.12);border-radius:10px;
  position:relative;cursor:pointer;flex-shrink:0;transition:background .2s;}
.tog-t.on{background:var(--dark);}
.tog-k{position:absolute;top:2px;left:2px;width:15px;height:15px;background:#fff;
  border-radius:50%;transition:transform .2s;pointer-events:none;}
.tog-t.on .tog-k{transform:translateX(15px);}
.tog-l{font-size:11px;font-weight:600;color:var(--muted);}
.tog-t.on+.tog-l{color:var(--dark);}

/* ‚îÄ‚îÄ BUILDER SHARED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.bldr-hdr{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:12px;}
.bldr-ttl{font-size:12px;font-weight:800;color:var(--dark);}
.bldr-sub{font-size:10px;color:var(--muted);margin-top:2px;line-height:1.4;}
.bldr-badge{font-size:10px;font-weight:700;background:var(--dark);color:#fff;padding:3px 10px;border-radius:20px;white-space:nowrap;flex-shrink:0;}
.empty-state{text-align:center;padding:28px 16px;background:rgba(0,0,0,0.02);
  border:1.5px dashed rgba(0,0,0,0.12);border-radius:12px;}
.empty-ico{font-size:28px;margin-bottom:8px;}
.empty-ttl{font-size:12px;font-weight:700;margin-bottom:4px;}
.empty-sub{font-size:11px;color:var(--muted);line-height:1.5;}

/* BUILDER CARD */
.bcard{background:rgba(255,255,255,0.55);border-radius:12px;overflow:hidden;
  margin-bottom:10px;border:1px solid rgba(0,0,0,0.07);box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.bcard-hdr{padding:10px 14px;display:flex;align-items:center;gap:10px;
  background:rgba(255,255,255,0.35);border-bottom:1px solid rgba(0,0,0,0.06);cursor:pointer;user-select:none;}
.bcard-ico{font-size:17px;flex-shrink:0;}
.bcard-info{flex:1;min-width:0;}
.bcard-name{font-size:12px;font-weight:800;color:var(--dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bcard-sub{font-size:9px;color:var(--muted);margin-top:1px;}
.bcard-fill{font-size:9px;font-weight:700;background:rgba(0,0,0,0.07);color:var(--muted);
  padding:2px 8px;border-radius:20px;flex-shrink:0;}
.bcard-del{background:none;border:1px solid rgba(192,57,43,0.25);border-radius:20px;
  font-family:'DM Sans',sans-serif;font-size:9px;font-weight:700;color:#c0392b;
  cursor:pointer;padding:2px 8px;flex-shrink:0;}
.bcard-del:hover{background:#c0392b;color:#fff;}
.bcard-chev{font-size:9px;color:var(--muted);transition:transform .2s;flex-shrink:0;}
.bcard-chev.open{transform:rotate(180deg);}
.bcard-body{display:none;padding:10px 12px;flex-direction:column;gap:6px;}
.bcard-body.open{display:flex;}

/* SUB-SECTION inside bcard */
.bsub{background:rgba(255,255,255,0.6);border-radius:9px;overflow:hidden;border:1px solid rgba(0,0,0,0.06);}
.bsub-hdr{padding:7px 12px;display:flex;align-items:center;gap:7px;cursor:pointer;user-select:none;transition:background .12s;}
.bsub-hdr:hover{background:rgba(255,255,255,0.85);}
.bsub-ico{font-size:12px;flex-shrink:0;}
.bsub-ttl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.3px;color:var(--dark);flex:1;}
.bsub-cnt{font-size:8px;color:var(--muted);background:rgba(0,0,0,0.06);padding:1px 6px;border-radius:20px;}
.bsub-chev{font-size:8px;color:var(--muted);transition:transform .2s;}
.bsub-chev.open{transform:rotate(180deg);}
.bsub-body{display:none;padding:11px 13px;border-top:1px solid rgba(0,0,0,0.05);}
.bsub-body.open{display:block;}

/* ADD BUTTONS */
.add-btn{display:flex;align-items:center;justify-content:center;gap:7px;width:100%;
  padding:10px;background:rgba(0,0,0,0.03);border:1.5px dashed rgba(0,0,0,0.15);
  border-radius:10px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:700;
  color:var(--muted);cursor:pointer;transition:all .15s;margin-bottom:4px;}
.add-btn:hover{background:rgba(0,0,0,0.07);border-color:var(--dark);color:var(--dark);}
.add-btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;}
.add-btn-row .add-btn{flex:1;min-width:130px;font-size:10px;}

/* PICKER POPUP */
.picker{background:var(--surface);border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.13);
  padding:13px;margin-top:4px;display:none;}
.picker.open{display:block;}
.picker-lbl{font-size:8px;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:8px;letter-spacing:0.5px;}
.picker-chips{display:flex;flex-wrap:wrap;gap:6px;}
.pchip{display:flex;align-items:center;gap:5px;padding:7px 12px;background:#f0f2f6;
  border:none;border-radius:20px;font-family:'DM Sans',sans-serif;font-size:10px;
  font-weight:700;color:var(--muted);cursor:pointer;transition:all .12s;}
.pchip:hover{background:var(--dark);color:#FFFF00;}

/* MILESTONES */
.ms-grid{display:flex;flex-direction:column;gap:5px;}
.ms-row{display:flex;align-items:center;gap:8px;padding:5px 8px;
  background:rgba(255,255,255,0.6);border-radius:7px;}
.ms-dot{width:7px;height:7px;border-radius:50%;background:rgba(0,0,0,0.15);flex-shrink:0;}
.ms-lbl{font-size:10px;font-weight:600;color:var(--dark);flex:1;}
.ms-sel{font-size:10px;background:rgba(0,0,0,0.05);border:1px solid rgba(0,0,0,0.1);
  border-radius:5px;padding:2px 5px;color:var(--muted);cursor:pointer;-webkit-appearance:none;font-family:'DM Sans',sans-serif;}
.ms-date{font-size:10px;background:rgba(0,0,0,0.05);border:1px solid rgba(0,0,0,0.1);
  border-radius:5px;padding:2px 5px;color:var(--muted);cursor:pointer;font-family:'DM Sans',monospace;}

/* SECTION LABEL (inline heading) */
.bldr-section-wrap{background:var(--surface);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh);padding:16px 18px;}
.bldr-section-wrap+.bldr-section-wrap{margin-top:10px;}

/* SAVE BAR */
.savebar{position:fixed;bottom:0;left:0;right:0;z-index:100;background:var(--dark);
  border-top:1px solid rgba(255,255,255,0.08);padding:10px 24px;
  display:flex;align-items:center;justify-content:space-between;gap:12px;}
.sb-left{font-size:11px;color:#777;}
.sb-left strong{color:#fff;}
.sb-right{display:flex;align-items:center;gap:10px;}
.sb-msg{font-size:11px;font-weight:600;color:#4ade80;opacity:0;transition:opacity .3s;}
.sb-msg.show{opacity:1;}
.sb-msg.err{color:#f87171;}
.btn-save{padding:8px 20px;background:var(--accent);border:none;border-radius:20px;
  font-family:'DM Sans',sans-serif;font-size:12px;font-weight:800;color:var(--dark);
  cursor:pointer;text-transform:uppercase;letter-spacing:0.3px;transition:background .15s,transform .1s;}
.btn-save:hover{background:#e6e600;}
.btn-save:active{transform:scale(.97);}
.btn-save:disabled{opacity:.4;cursor:not-allowed;}

@media(max-width:560px){
  .fg{grid-template-columns:1fr;}.fw.c2{grid-column:span 1;}
  .wrap{padding:13px 10px;}.topbar{padding:0 14px;}
  .savebar{padding:10px 14px;}.add-btn-row{flex-direction:column;}
}
</style>
</head>
<body>

<div class="topbar">
  <a href="#" class="logo">Sun<span>Hash</span></a>
  <span class="tb-badge" id="tb-badge">Loading‚Ä¶</span>
</div>

<div class="state active" id="s-loading">
  <div class="spinner"></div>
  <div class="state-title">Loading form‚Ä¶</div>
  <div class="state-sub">Fetching project data from secure link.</div>
</div>
<div class="state" id="s-error">
  <div class="state-icon">üîí</div>
  <div class="state-title" id="err-t">Invalid Link</div>
  <div class="state-sub" id="err-s">This link is no longer valid.</div>
</div>

<div id="app">
  <div class="wrap">
    <div class="phdr">
      <div class="phdr-ico" id="h-ico">üìÑ</div>
      <div class="phdr-info">
        <div class="phdr-name" id="h-name">‚Äî</div>
        <div class="phdr-meta" id="h-meta">‚Äî</div>
        <div class="phdr-notice">
          <span>‚ÑπÔ∏è</span>
          <span>You have been invited to fill in data for this project. Your answers save directly to the project. Existing data is pre-populated ‚Äî update freely.</span>
        </div>
      </div>
      <div class="phdr-badge" id="h-badge">Category</div>
    </div>
    <div class="prog-card">
      <span class="prog-lbl">Completion</span>
      <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
      <span class="prog-pct" id="prog-pct">0%</span>
    </div>
    <div class="ok-banner" id="ok-banner">
      <span class="ok-ico">‚úÖ</span>
      <span class="ok-txt">Saved successfully. You can keep editing and save again at any time.</span>
    </div>
    <div id="form-body"></div>
  </div>
</div>

<div class="savebar" id="savebar" style="display:none;">
  <div class="sb-left">Submitting as <strong>Guest</strong> ¬∑ <span id="sb-cat">‚Äî</span></div>
  <div class="sb-right">
    <span class="sb-msg" id="sb-msg"></span>
    <button class="btn-save" id="btn-save" onclick="saveAll()">Save Data</button>
  </div>
</div>

<script>
var SUPABASE_URL="https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY="sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

var token=null,projectId=null,categoryKey=null,catDef=null;
var tf={};   // saved tally_fields
var lf={};   // local (unsaved) changes

/* ‚îÄ‚îÄ‚îÄ DATA DEFINITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

var STANDARD_CATS=[
  {key:"score_permit",label:"Permits & Entitlements",icon:"üìú",sections:[
    {icon:"üìç",title:"Project Location",fields:[
      {lbl:"Project Name",field:"proj_name",type:"text",col:2},
      {lbl:"County",field:"county",type:"text"},{lbl:"State",field:"state",type:"select",opts:["","AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"]},
      {lbl:"ISO / RTO",field:"iso_rto",type:"select",opts:["","PJM","CAISO","ERCOT","MISO","SPP","NYISO","ISO-NE","WECC","Other"]},
      {lbl:"Latitude",field:"latitude",type:"number"},{lbl:"Longitude",field:"longitude",type:"number"},
      {lbl:"Parcel Numbers",field:"parcel_numbers",type:"text",col:2},
      {lbl:"Flood Zone",field:"flood_zone",type:"select",opts:["","Zone X (minimal)","Zone AE","Zone A","Zone VE","Zone V","Unknown"]},
      {lbl:"Seismic Zone",field:"seismic_zone",type:"select",opts:["","Zone 0","Zone 1","Zone 2A","Zone 2B","Zone 3","Zone 4"]},
    ]},
    {icon:"üó∫Ô∏è",title:"Zoning & Land",fields:[
      {lbl:"Zoning Classification",field:"zoning_class",type:"text"},{lbl:"CUP Status",field:"cup_status",type:"select",opts:["","Approved","Pending","Not Required","Denied"]},
      {lbl:"Setback (ft)",field:"setback_ft",type:"number"},{lbl:"Total Site Acreage",field:"site_acres",type:"number"},
      {lbl:"Buildable Acreage",field:"buildable_acres",type:"number"},{lbl:"Land Ownership",field:"land_ownership",type:"select",opts:["","Fee Simple","Lease","Mixed","Option"]},
      {lbl:"Lease Term (yrs)",field:"lease_term_yrs",type:"number"},{lbl:"Lease Escalator (%/yr)",field:"lease_esc_pct",type:"number"},
      {lbl:"Decommissioning Bond ($)",field:"decomm_bond",type:"number"},
    ]},
    {icon:"üåø",title:"Environmental",fields:[
      {lbl:"Phase I ESA Status",field:"esa_status",type:"select",opts:["","Complete ‚Äì Clean","Complete ‚Äì REC Identified","In Progress","Not Started"]},
      {lbl:"Wetlands Acreage",field:"wetlands_acres",type:"number"},{lbl:"Endangered Species Impact",field:"esa_species",type:"toggle"},
      {lbl:"Mitigation Cost ($)",field:"mitigation_cost",type:"number"},{lbl:"Cultural Resource Constraints",field:"cultural_constraints",type:"toggle"},
      {lbl:"SWPPP Required",field:"swppp_req",type:"toggle"},{lbl:"NEPA Required",field:"nepa_req",type:"toggle"},
    ]},
  ]},
  {key:"score_contract",label:"Legal",icon:"‚öñÔ∏è",sections:[
    {icon:"üìë",title:"PPA / Offtake",fields:[
      {lbl:"Offtaker Name",field:"offtaker_name",type:"text",col:2},
      {lbl:"Offtaker Credit Rating",field:"offtaker_rating",type:"select",opts:["","AAA","AA+","AA","AA-","A+","A","A-","BBB+","BBB","BBB-","Below Investment Grade","Not Rated"]},
      {lbl:"PPA Term (years)",field:"ppa_term_yrs",type:"number"},{lbl:"Fixed Price ($/MWh)",field:"ppa_price",type:"number"},
      {lbl:"Price Escalator (%/yr)",field:"ppa_escalator_pct",type:"number"},{lbl:"PPA Start Date",field:"ppa_start_date",type:"date"},
      {lbl:"Merchant Tail (years)",field:"merchant_tail_yrs",type:"number"},{lbl:"Curtailment Compensation",field:"curtail_comp",type:"toggle"},
    ]},
    {icon:"üèõÔ∏è",title:"Tax & Incentives",fields:[
      {lbl:"ITC or PTC Election",field:"itc_ptc",type:"select",opts:["","ITC (30%)","PTC","Not Determined"]},
      {lbl:"ITC Percentage (%)",field:"itc_pct",type:"number"},{lbl:"Domestic Content Bonus",field:"dom_content_bonus",type:"toggle"},
      {lbl:"Energy Community Bonus",field:"energy_comm_bonus",type:"toggle"},{lbl:"Prevailing Wage Compliance",field:"prev_wage",type:"toggle"},
      {lbl:"State Incentives ($)",field:"state_incentives",type:"number"},{lbl:"Property Tax Abatement",field:"prop_tax_abate",type:"toggle"},
    ]},
    {icon:"üõ°Ô∏è",title:"Insurance",fields:[
      {lbl:"Builder's Risk Limit ($)",field:"builders_risk_limit",type:"number"},
      {lbl:"O&M Coverage Limit ($)",field:"om_coverage_limit",type:"number"},
      {lbl:"Business Interruption (months)",field:"bi_months",type:"number"},
    ]},
  ]},
  {key:"score_intercon",label:"Grid Connection",icon:"‚ö°",sections:[
    {icon:"üîå",title:"Interconnection",fields:[
      {lbl:"Queue Position",field:"queue_position",type:"text"},{lbl:"POI Substation Name",field:"poi_substation",type:"text"},
      {lbl:"Interconnection Voltage (kV)",field:"intercon_kv",type:"number"},{lbl:"Network Upgrade Cost ($)",field:"network_upgrade_cost",type:"number"},
      {lbl:"Upgrade Scope",field:"upgrade_scope",type:"text",col:2},{lbl:"Milestone Security ($)",field:"milestone_security",type:"number"},
      {lbl:"IA Execution Date",field:"ia_exec_date",type:"date"},{lbl:"Expected Upgrade Completion",field:"upgrade_complete_date",type:"date"},
    ]},
    {icon:"üìä",title:"Market & Deliverability",fields:[
      {lbl:"Capacity Accreditation (%)",field:"cap_accredit_pct",type:"number"},{lbl:"ELCC Methodology",field:"elcc_method",type:"text"},
      {lbl:"Congestion Risk Score (1‚Äì10)",field:"congestion_score",type:"number"},
      {lbl:"Deliverability Status",field:"deliverability",type:"select",opts:["","Full Capacity Deliverability","Partial Capacity Deliverability","Energy-Only","Unknown"]},
    ]},
  ]},
  {key:"score_financial",label:"Finance",icon:"üíµ",sections:[
    {icon:"üíµ",title:"Capital Stack",fields:[
      {lbl:"Total Capex ($)",field:"total_capex",type:"number"},{lbl:"Debt Amount ($)",field:"debt_amount",type:"number"},
      {lbl:"Debt Tenor (years)",field:"debt_tenor_yrs",type:"number"},{lbl:"Interest Rate (%)",field:"interest_rate_pct",type:"number"},
      {lbl:"Sculpted DSCR",field:"sculpted_dscr",type:"number"},{lbl:"Minimum DSCR",field:"min_dscr",type:"number"},
      {lbl:"Tax Equity Amount ($)",field:"tax_equity_amt",type:"number"},{lbl:"Target Flip Year",field:"flip_year",type:"number"},
      {lbl:"Sponsor Equity ($)",field:"sponsor_equity",type:"number"},
    ]},
    {icon:"üìà",title:"Financial Metrics",fields:[
      {lbl:"Levered IRR (%)",field:"levered_irr_pct",type:"number"},{lbl:"Unlevered IRR (%)",field:"unlevered_irr_pct",type:"number"},
      {lbl:"NPV ($)",field:"npv",type:"number"},{lbl:"LCOE ($/MWh)",field:"lcoe",type:"number"},
      {lbl:"Breakeven PPA ($/MWh)",field:"breakeven_ppa",type:"number"},{lbl:"P50 DSCR",field:"p50_dscr",type:"number"},
      {lbl:"P90 DSCR",field:"p90_dscr",type:"number"},
    ]},
  ]},
];

var DESIGN_ARRAY_SECTIONS=[
  {icon:'‚òÄÔ∏è',title:'Resource & Yield',key:'yield',fields:[
    {lbl:'Irradiance Data Source',field:'irr_source',type:'select',opts:['','NSRDB','Meteonorm','SolarAnywhere','Solargis','Other']},
    {lbl:'GHI (kWh/m¬≤/yr)',field:'ghi',type:'number'},{lbl:'P50 Production (MWh/yr)',field:'p50_mwh',type:'number'},
    {lbl:'P90 Production (MWh/yr)',field:'p90_mwh',type:'number'},{lbl:'P99 Production (MWh/yr)',field:'p99_mwh',type:'number'},
    {lbl:'Net Capacity Factor (%)',field:'net_cf_pct',type:'number'},{lbl:'Annual Degradation (%/yr)',field:'degradation_pct',type:'number'},
    {lbl:'Availability (%)',field:'availability_pct',type:'number'},{lbl:'Curtailment (%)',field:'curtailment_pct',type:'number'},
    {lbl:'DC Size (MWdc)',field:'dc_mw',type:'number'},{lbl:'AC Size (MWac)',field:'ac_mw',type:'number'},
    {lbl:'DC:AC Ratio (ILR)',field:'ilr',type:'number'},{lbl:'Yield Model Software',field:'yield_software',type:'select',opts:['','PVsyst','SAM','PVsol','Homer','Other']},
    {lbl:'Independent Engineer Review',field:'ie_review',type:'toggle'},
  ]},
  {icon:'üèóÔ∏è',title:'Civil & Structural',key:'civil',fields:[
    {lbl:'Racking System',field:'racking_type',type:'select',opts:['','Single-Axis Tracker','Fixed Tilt','Dual-Axis','Floating']},
    {lbl:'Pile Type',field:'pile_type',type:'select',opts:['','Driven Steel','Helical','Ground Screw','Ballasted','Concrete Cast In-Situ']},
    {lbl:'Max Wind Design (m/s)',field:'wind_speed_ms',type:'number'},{lbl:'Snow Load (kN/m¬≤)',field:'snow_load_knm2',type:'number'},
    {lbl:'Ground Coverage Ratio (%)',field:'gcr_pct',type:'number'},{lbl:'Row Pitch (m)',field:'row_pitch_m',type:'number'},
    {lbl:'Tilt Angle (¬∞)',field:'tilt_deg',type:'number'},{lbl:'Ground Clearance Min (mm)',field:'clearance_mm',type:'number'},
    {lbl:'Total Site Area (ha)',field:'site_ha',type:'number'},{lbl:'Access Road Length (km)',field:'road_km',type:'number'},
    {lbl:'Fencing (km)',field:'fence_km',type:'number'},{lbl:'Civil Design Firm',field:'civil_firm',type:'text',col:2},
  ]},
  {icon:'ü™®',title:'Geological Study',key:'geo',fields:[
    {lbl:'Geotechnical Firm',field:'geo_firm',type:'text',col:2},
    {lbl:'Study Status',field:'geo_status',type:'select',opts:['','Not Started','In Progress','Phase I Complete','Phase II Complete','Final Report Issued']},
    {lbl:'Soil Classification (USCS)',field:'soil_uscs',type:'select',opts:['','GW','GP','GM','GC','SW','SP','SM','SC','ML','CL','CH','MH','OH','PT','Other']},
    {lbl:'Rock Classification',field:'rock_class',type:'select',opts:['','None / Soil Only','Weathered Rock','Soft Rock','Medium Rock','Hard Rock','Very Hard Rock']},
    {lbl:'Rock Depth (m)',field:'rock_depth_m',type:'number'},{lbl:'Groundwater Depth (m)',field:'gw_depth_m',type:'number'},
    {lbl:'SPT N-value (avg)',field:'spt_n',type:'number'},{lbl:'Bearing Capacity (kN/m¬≤)',field:'bearing_kpa',type:'number'},
    {lbl:'Liquefaction Risk',field:'liquefaction',type:'select',opts:['','None','Low','Moderate','High','Not Assessed']},
    {lbl:'Expansive Soils',field:'expansive_soils',type:'toggle'},{lbl:'Contaminated Land',field:'contaminated',type:'toggle'},
    {lbl:'Pull-out Test Conducted',field:'pullout_test',type:'toggle'},{lbl:'Pull-out Resistance (kN)',field:'pullout_kn',type:'number'},
    {lbl:'Pile Embedment Depth (m)',field:'embedment_m',type:'number'},
    {lbl:'Seismic Zone / PGA (g)',field:'seismic_pga',type:'text'},{lbl:'Notes',field:'geo_notes',type:'text',col:2},
  ]},
  {icon:'‚ö°',title:'Electrical',key:'elec',fields:[
    {lbl:'Strings per Inverter',field:'strings_per_inv',type:'number'},{lbl:'Modules per String',field:'mods_per_string',type:'number'},
    {lbl:'Collector Voltage (kV)',field:'collector_kv',type:'number'},{lbl:'POI Voltage (kV)',field:'poi_kv',type:'number'},
    {lbl:'DC Cable Total (km)',field:'dc_cable_km',type:'number'},{lbl:'AC Cable Total (km)',field:'ac_cable_km',type:'number'},
    {lbl:'Number of Combiner Boxes',field:'combiner_boxes',type:'number'},{lbl:'SCADA Vendor',field:'scada_vendor',type:'text'},
    {lbl:'Reactive Power Capability',field:'reactive_power',type:'toggle'},{lbl:'IFC SLD Issued',field:'ifc_sld',type:'toggle'},
    {lbl:'Electrical Design Firm',field:'elec_firm',type:'text',col:2},
  ]},
  {icon:'üîß',title:'Mechanical & BESS',key:'mech',fields:[
    {lbl:'BESS Included in Array',field:'bess_included',type:'toggle'},{lbl:'BESS Energy (MWh)',field:'bess_mwh',type:'number'},
    {lbl:'BESS Power (MW)',field:'bess_mw',type:'number'},{lbl:'BESS Duration (hr)',field:'bess_dur_hr',type:'number'},
    {lbl:'BESS Coupling',field:'bess_coupling',type:'select',opts:['','AC-coupled','DC-coupled','Not applicable']},
    {lbl:'Shared POI (Solar+BESS)',field:'shared_poi',type:'toggle'},
    {lbl:'Firefighting System',field:'fire_system',type:'select',opts:['','Inert Gas','FM200','Water Mist','Dry Chemical','Sprinkler','Not Required']},
    {lbl:'Met Station',field:'met_station',type:'toggle'},{lbl:'O&M Building',field:'om_building',type:'toggle'},
    {lbl:'Mechanical Design Firm',field:'mech_firm',type:'text',col:2},
  ]},
];

var CREW_TYPES={
  civil:{icon:'üèóÔ∏è',label:'Civil Crew',color:'#d35400',
    manpower:[
      {lbl:'Crew Name / ID',field:'nickname',type:'text',col:2},{lbl:'Subcontractor',field:'subcontractor',type:'text',col:2},
      {lbl:'Crew Size (workers)',field:'crew_size',type:'number'},{lbl:'Supervisors',field:'supervisors',type:'number'},
      {lbl:'Shift Pattern',field:'shift',type:'select',opts:['','Single Shift','Double Shift','24/7']},
      {lbl:'Start Date',field:'start_date',type:'date'},{lbl:'End Date',field:'end_date',type:'date'},
      {lbl:'Scope',field:'scope',type:'select',opts:['','Earthworks','Pile Driving','Roads & Fencing','All Civil']},
      {lbl:'Pile Drive Rate (piles/day)',field:'pile_rate',type:'number'},{lbl:'Grading Rate (m¬≥/day)',field:'grade_rate',type:'number'},
      {lbl:'HSE Officer on Site',field:'hse_officer',type:'toggle'},
    ],
    equipment:[{lbl:'Bulldozer',key:'dozer'},{lbl:'Excavator',key:'excavator'},{lbl:'Pile Driver',key:'pile_driver'},{lbl:'Telehandler',key:'forklift'},{lbl:'Generator',key:'generator'}],
    milestones:['Mobilisation','Site Clearance','Grading Complete','Pile Driving Start','Pile Driving 50%','Pile Driving Complete','Roads Complete','Fencing Complete','Demobilisation'],
  },
  install:{icon:'‚òÄÔ∏è',label:'Module Install Crew',color:'#2471a3',
    manpower:[
      {lbl:'Crew Name / ID',field:'nickname',type:'text',col:2},{lbl:'Subcontractor',field:'subcontractor',type:'text',col:2},
      {lbl:'Crew Size (workers)',field:'crew_size',type:'number'},{lbl:'Supervisors',field:'supervisors',type:'number'},
      {lbl:'Shift Pattern',field:'shift',type:'select',opts:['','Single Shift','Double Shift']},
      {lbl:'Start Date',field:'start_date',type:'date'},{lbl:'End Date',field:'end_date',type:'date'},
      {lbl:'Modules per Crew per Day',field:'mod_rate',type:'number'},{lbl:'Peak Daily Output (mod/day)',field:'peak_daily',type:'number'},
      {lbl:'String Testing Rate (str/day)',field:'string_rate',type:'number'},{lbl:'HSE Officer on Site',field:'hse_officer',type:'toggle'},
    ],
    equipment:[{lbl:'Robot Installer',key:'robot_installer'},{lbl:'Telehandler',key:'forklift'},{lbl:'Generator',key:'generator'}],
    milestones:['Mobilisation','Rack Assembly Start','First Modules Racked','25% Complete','50% Complete','75% Complete','Last Module Racked','String Testing Complete','Final Inspection'],
  },
  electrical:{icon:'‚ö°',label:'Electrical Crew',color:'#117a65',
    manpower:[
      {lbl:'Crew Name / ID',field:'nickname',type:'text',col:2},{lbl:'Subcontractor',field:'subcontractor',type:'text',col:2},
      {lbl:'Crew Size (workers)',field:'crew_size',type:'number'},{lbl:'Electricians (licensed)',field:'electricians',type:'number'},
      {lbl:'Shift Pattern',field:'shift',type:'select',opts:['','Single Shift','Double Shift']},
      {lbl:'Start Date',field:'start_date',type:'date'},{lbl:'End Date',field:'end_date',type:'date'},
      {lbl:'DC Trench Rate (m/day)',field:'dc_rate',type:'number'},{lbl:'AC Trench Rate (m/day)',field:'ac_rate',type:'number'},
      {lbl:'MV Cable Pull Rate (m/day)',field:'mv_rate',type:'number'},{lbl:'HSE Officer on Site',field:'hse_officer',type:'toggle'},
    ],
    equipment:[{lbl:'Cable Trencher',key:'cable_trencher'},{lbl:'Excavator',key:'excavator'},{lbl:'Telehandler',key:'forklift'},{lbl:'Generator',key:'generator'}],
    milestones:['Mobilisation','DC Cable Trench Start','DC Cable Pull Complete','AC Cable Trench Start','AC Cable Pull Complete','MV Cable Complete','Inverter Terminations','Transformer Connections','SCADA Wiring','Energisation Test','PAC'],
  },
};

var EQUIP_TYPES={
  dozer:{icon:'üöú',label:'Bulldozer',fields:[
    {lbl:'Make / Brand',field:'mfr',type:'text',req:true},{lbl:'Model',field:'model',type:'text',req:true},
    {lbl:'Operating Weight (t)',field:'weight_t',type:'number'},{lbl:'Blade Capacity (m¬≥)',field:'blade_m3',type:'number'},
    {lbl:'Engine Power (kW)',field:'power_kw',type:'number'},{lbl:'Fuel Type',field:'fuel',type:'select',opts:['','Diesel','Electric','Hybrid']},
    {lbl:'GPS Grade Control',field:'gps_grade',type:'toggle'},{lbl:'Quantity on Site',field:'qty',type:'number'},
    {lbl:'Ownership',field:'ownership',type:'select',opts:['','Owned','Rented','Contractor-supplied']},
  ]},
  excavator:{icon:'‚õèÔ∏è',label:'Excavator',fields:[
    {lbl:'Make / Brand',field:'mfr',type:'text',req:true},{lbl:'Model',field:'model',type:'text',req:true},
    {lbl:'Operating Weight (t)',field:'weight_t',type:'number'},{lbl:'Bucket Capacity (m¬≥)',field:'bucket_m3',type:'number'},
    {lbl:'Max Dig Depth (m)',field:'dig_depth_m',type:'number'},{lbl:'Engine Power (kW)',field:'power_kw',type:'number'},
    {lbl:'Fuel Type',field:'fuel',type:'select',opts:['','Diesel','Electric','Hybrid']},
    {lbl:'Quantity on Site',field:'qty',type:'number'},{lbl:'Ownership',field:'ownership',type:'select',opts:['','Owned','Rented','Contractor-supplied']},
  ]},
  pile_driver:{icon:'üî®',label:'Pile Driver',fields:[
    {lbl:'Make / Brand',field:'mfr',type:'text',req:true},{lbl:'Model',field:'model',type:'text',req:true},
    {lbl:'Drive Method',field:'method',type:'select',opts:['','Hydraulic Impact','Vibratory','Hydraulic Press','Rotary']},
    {lbl:'Max Hammer Energy (J)',field:'energy_j',type:'number'},{lbl:'Driving Rate (piles/hr)',field:'rate_hr',type:'number'},
    {lbl:'GPS Positioning',field:'gps',type:'toggle'},{lbl:'Quantity on Site',field:'qty',type:'number'},
    {lbl:'Ownership',field:'ownership',type:'select',opts:['','Owned','Rented','Contractor-supplied']},
  ]},
  robot_installer:{icon:'ü§ñ',label:'Robot Module Installer',fields:[
    {lbl:'Manufacturer',field:'mfr',type:'text',req:true},{lbl:'Model',field:'model',type:'text',req:true},
    {lbl:'Install Rate (mod/hr)',field:'rate_mod_hr',type:'number'},{lbl:'Lifting Capacity (kg)',field:'lift_kg',type:'number'},
    {lbl:'Crew Required',field:'crew',type:'number'},{lbl:'Quantity on Site',field:'qty',type:'number'},
    {lbl:'Ownership',field:'ownership',type:'select',opts:['','Owned','Rented','Contractor-supplied']},
  ]},
  cable_trencher:{icon:'‚öôÔ∏è',label:'Cable Trencher',fields:[
    {lbl:'Make / Brand',field:'mfr',type:'text',req:true},{lbl:'Model',field:'model',type:'text',req:true},
    {lbl:'Trench Type',field:'method',type:'select',opts:['','Chain Trencher','Wheel Trencher','Micro-trencher','Plough']},
    {lbl:'Max Trench Depth (m)',field:'depth_m',type:'number'},{lbl:'Production Rate (m/hr)',field:'rate_m_hr',type:'number'},
    {lbl:'Quantity on Site',field:'qty',type:'number'},{lbl:'Ownership',field:'ownership',type:'select',opts:['','Owned','Rented','Contractor-supplied']},
  ]},
  forklift:{icon:'üèãÔ∏è',label:'Telehandler / Forklift',fields:[
    {lbl:'Make / Brand',field:'mfr',type:'text',req:true},{lbl:'Model',field:'model',type:'text',req:true},
    {lbl:'Max Lift Capacity (kg)',field:'lift_kg',type:'number'},{lbl:'Max Lift Height (m)',field:'lift_m',type:'number'},
    {lbl:'Fuel Type',field:'fuel',type:'select',opts:['','Diesel','Electric','LPG']},
    {lbl:'Quantity on Site',field:'qty',type:'number'},{lbl:'Ownership',field:'ownership',type:'select',opts:['','Owned','Rented','Contractor-supplied']},
  ]},
  generator:{icon:'‚ö°',label:'Generator Set',fields:[
    {lbl:'Make / Brand',field:'mfr',type:'text',req:true},{lbl:'Model',field:'model',type:'text',req:true},
    {lbl:'Rated Power (kVA)',field:'kva',type:'number'},{lbl:'Fuel Type',field:'fuel',type:'select',opts:['','Diesel','Gas','HVO','Hybrid']},
    {lbl:'Quantity on Site',field:'qty',type:'number'},{lbl:'Ownership',field:'ownership',type:'select',opts:['','Owned','Rented','Contractor-supplied']},
  ]},
};

var COMP_TYPES={
  module:{icon:'üîã',label:'PV Module',fields:[
    {lbl:'Manufacturer',field:'mfr',type:'text',req:true},{lbl:'Model / Part Number',field:'model',type:'text',req:true},
    {lbl:'Technology',field:'tech',type:'select',opts:['','Mono PERC','TOPCon','HJT','CIGS','CdTe','Bifacial TOPCon','Other']},
    {lbl:'Nominal Power (W)',field:'watt',type:'number',req:true},{lbl:'Module Efficiency (%)',field:'eff_pct',type:'number'},
    {lbl:'Bifaciality Factor (%)',field:'bifac_pct',type:'number'},{lbl:'Voc (V)',field:'voc',type:'number'},
    {lbl:'Length (mm)',field:'length_mm',type:'number'},{lbl:'Width (mm)',field:'width_mm',type:'number'},
    {lbl:'Weight (kg)',field:'weight_kg',type:'number'},{lbl:'Country of Manufacture',field:'country',type:'text'},
    {lbl:'Product Warranty (yrs)',field:'prod_warranty',type:'number'},{lbl:'Annual Degradation (%)',field:'degrad_ann',type:'number'},
    {lbl:'IEC Certifications',field:'iec_cert',type:'text',col:2},{lbl:'Domestic Content Eligible',field:'dom_content',type:'toggle'},
    {lbl:'Datasheet URL',field:'datasheet_url',type:'text',col:2},
  ]},
  inverter:{icon:'‚ö°',label:'Inverter',fields:[
    {lbl:'Manufacturer',field:'mfr',type:'text',req:true},{lbl:'Model / Part Number',field:'model',type:'text',req:true},
    {lbl:'Type',field:'type',type:'select',opts:['','Central','String','Micro','Hybrid']},
    {lbl:'AC Power Rating (kW)',field:'kw_ac',type:'number',req:true},{lbl:'DC Max Input (kW)',field:'kw_dc_max',type:'number'},
    {lbl:'Max DC Voltage (V)',field:'vdc_max',type:'number'},{lbl:'Number of MPPTs',field:'n_mppt',type:'number'},
    {lbl:'Peak Efficiency (%)',field:'eff_peak',type:'number'},{lbl:'CEC Efficiency (%)',field:'eff_cec',type:'number'},
    {lbl:'Warranty (years)',field:'warranty_yrs',type:'number'},{lbl:'Datasheet URL',field:'datasheet_url',type:'text',col:2},
  ]},
  racking:{icon:'üî©',label:'Racking / Structure',fields:[
    {lbl:'Manufacturer',field:'mfr',type:'text',req:true},{lbl:'System Name / Model',field:'model',type:'text',req:true},
    {lbl:'Type',field:'type',type:'select',opts:['','Fixed Tilt','Single-Axis Tracker','Dual-Axis Tracker','Ballasted','Floating']},
    {lbl:'Tilt Angle (¬∞)',field:'tilt_deg',type:'number'},{lbl:'Max Wind Speed (m/s)',field:'wind_ms',type:'number'},
    {lbl:'Snow Load (kN/m¬≤)',field:'snow_load',type:'number'},{lbl:'Material',field:'material',type:'select',opts:['','Hot-dip Galvanised Steel','Aluminium','Stainless Steel','Composite']},
    {lbl:'Design Lifetime (yrs)',field:'design_life',type:'number'},{lbl:'Warranty (years)',field:'warranty_yrs',type:'number'},
    {lbl:'Modules per Table',field:'mod_per_table',type:'number'},{lbl:'Datasheet URL',field:'datasheet_url',type:'text',col:2},
  ]},
  tracker:{icon:'üåû',label:'Solar Tracker',fields:[
    {lbl:'Manufacturer',field:'mfr',type:'text',req:true},{lbl:'Model',field:'model',type:'text',req:true},
    {lbl:'Type',field:'type',type:'select',opts:['','Single-Axis','Dual-Axis','Seasonal Tilt']},
    {lbl:'Drive Type',field:'drive',type:'select',opts:['','Slew Drive','Linear Actuator','Distributed Drive','Centralized Drive']},
    {lbl:'Max Tracking Angle (¬∞)',field:'max_angle',type:'number'},{lbl:'Backtracking Algorithm',field:'backtracking',type:'toggle'},
    {lbl:'Terrain Following',field:'terrain_follow',type:'toggle'},{lbl:'Max Wind Speed (m/s)',field:'wind_ms',type:'number'},
    {lbl:'Modules per Tracker',field:'mod_per_tracker',type:'number'},{lbl:'Warranty (years)',field:'warranty_yrs',type:'number'},
    {lbl:'Datasheet URL',field:'datasheet_url',type:'text',col:2},
  ]},
  transformer:{icon:'üîß',label:'Transformer',fields:[
    {lbl:'Manufacturer',field:'mfr',type:'text',req:true},{lbl:'Model / Tag',field:'model',type:'text',req:true},
    {lbl:'Type',field:'type',type:'select',opts:['','Oil-immersed','Dry-type','Cast Resin','Pad-mounted']},
    {lbl:'Rating (kVA)',field:'kva',type:'number',req:true},{lbl:'Primary Voltage (kV)',field:'hv_kv',type:'number'},
    {lbl:'Secondary Voltage (V)',field:'lv_v',type:'number'},{lbl:'Impedance (%)',field:'impedance_pct',type:'number'},
    {lbl:'IP Rating',field:'ip_rating',type:'text'},{lbl:'Datasheet URL',field:'datasheet_url',type:'text',col:2},
  ]},
};

var SUPPLIER_TYPES={
  epc:{icon:'üèóÔ∏è',label:'EPC Contractor'},module_supplier:{icon:'üîã',label:'Module Supplier'},
  inverter_supplier:{icon:'‚ö°',label:'Inverter Supplier'},tracker_supplier:{icon:'üåû',label:'Tracker Supplier'},
  bess_supplier:{icon:'üîå',label:'BESS Supplier'},cable_supplier:{icon:'üî¥',label:'Cable Supplier'},
  design_firm:{icon:'üìê',label:'Design Firm'},law_firm:{icon:'‚öñÔ∏è',label:'Law Firm'},
  offtaker:{icon:'üí°',label:'Offtaker / Utility'},lender:{icon:'üè¶',label:'Lender'},
  tax_equity:{icon:'üí∞',label:'Tax Equity Investor'},owner_engineer:{icon:'üî¨',label:"Owner's Engineer"},
  other_company:{icon:'üè¢',label:'Other Company'},
};
function companyFields(){return[
  {lbl:'Company Name',field:'name',type:'text',req:true,col:2},{lbl:'Country',field:'country',type:'text',req:true},
  {lbl:'Website',field:'website',type:'text'},{lbl:'Primary Contact Name',field:'contact_name',type:'text'},
  {lbl:'Contact Email',field:'contact_email',type:'text'},{lbl:'Contact Phone',field:'contact_phone',type:'text'},
  {lbl:'Credit Rating',field:'credit_rating',type:'select',opts:['','AAA','AA','A','BBB','BB','B','Not Rated','Public Entity']},
  {lbl:'Years in Business',field:'years_biz',type:'number'},{lbl:'Parent Company',field:'parent_co',type:'text'},
  {lbl:'Certifications / Quals',field:'certs',type:'text',col:2},{lbl:'Notes',field:'notes',type:'text',col:2},
];}

var PROC_COMMON=[
  {lbl:'Contract / Agreement Title',field:'title',type:'text',col:2},
  {lbl:'Contract Type',field:'contract_type',type:'select',opts:['','Lump-sum Turnkey','EPC','Supply Agreement','Service Agreement','Framework','Letter of Intent','MOU']},
  {lbl:'Contract Value ($)',field:'value_usd',type:'number'},{lbl:'Currency',field:'currency',type:'select',opts:['','USD','EUR','GBP','AUD','CAD','Other']},
  {lbl:'Contract Execution Date',field:'exec_date',type:'date'},{lbl:'Governing Law',field:'governing_law',type:'text'},
  {lbl:'Incoterms',field:'incoterms',type:'select',opts:['','DDP','DAP','FCA','EXW','CIF','FOB','CPT','Not Applicable']},
  {lbl:'Parent Guarantee',field:'parent_guar',type:'toggle'},{lbl:'Performance Bond (%)',field:'perf_bond_pct',type:'number'},
  {lbl:'Payment Bond (%)',field:'pay_bond_pct',type:'number'},
];
var PROC_PMT=[
  {lbl:'Milestone 1 ‚Äî Description',field:'pmt1_desc',type:'text'},{lbl:'Milestone 1 ‚Äî % of Value',field:'pmt1_pct',type:'number'},
  {lbl:'Milestone 2 ‚Äî Description',field:'pmt2_desc',type:'text'},{lbl:'Milestone 2 ‚Äî % of Value',field:'pmt2_pct',type:'number'},
  {lbl:'Milestone 3 ‚Äî Description',field:'pmt3_desc',type:'text'},{lbl:'Milestone 3 ‚Äî % of Value',field:'pmt3_pct',type:'number'},
  {lbl:'Milestone 4 ‚Äî Description',field:'pmt4_desc',type:'text'},{lbl:'Milestone 4 ‚Äî % of Value',field:'pmt4_pct',type:'number'},
  {lbl:'Milestone 5 ‚Äî Description',field:'pmt5_desc',type:'text'},{lbl:'Milestone 5 ‚Äî % of Value',field:'pmt5_pct',type:'number'},
  {lbl:'Retention (%)',field:'retention_pct',type:'number'},{lbl:'Retention Release Trigger',field:'retention_trig',type:'select',opts:['','At PAC','At FAC','12 months post-FAC','Split PAC/FAC']},
];
var PROC_LD=[
  {lbl:'Delivery / Completion Date',field:'delivery_date',type:'date'},{lbl:'Lead Time (weeks)',field:'lead_wks',type:'number'},
  {lbl:'Delay LD ($/day)',field:'ld_delay_day',type:'number'},{lbl:'Delay LD Cap (%)',field:'ld_delay_cap',type:'number'},
  {lbl:'Performance LD ($/day)',field:'ld_perf_day',type:'number'},{lbl:'Performance LD Cap (%)',field:'ld_perf_cap',type:'number'},
  {lbl:'Warranty Period (months)',field:'warranty_mo',type:'number'},{lbl:'Defects Liability Period (mo)',field:'dlp_mo',type:'number'},
];
var PROC_EXTRA={
  module_supplier:[
    {lbl:'Domestic Content Certification',field:'dom_content_cert',type:'toggle'},{lbl:'IRA Adder Eligible',field:'ira_adder',type:'toggle'},
    {lbl:'Annual Degradation Guarantee (%)',field:'degrad_guar',type:'number'},{lbl:'Insolvency / Repurchase Guarantee',field:'insolvency_guar',type:'toggle'},
  ],
  inverter_supplier:[{lbl:'Extended Warranty Option',field:'ext_warranty',type:'toggle'},{lbl:'Remote Monitoring Included',field:'remote_mon',type:'toggle'}],
  tracker_supplier:[{lbl:'Terrain Following Algorithm',field:'terrain_follow',type:'toggle'},{lbl:'Installation Assistance',field:'install_assist',type:'toggle'}],
  bess_supplier:[
    {lbl:'Capacity Guarantee (%)',field:'cap_guar_pct',type:'number'},{lbl:'Round-trip Efficiency Guarantee (%)',field:'rte_guar',type:'number'},
    {lbl:'Augmentation Commitment',field:'aug_commit',type:'toggle'},{lbl:'10-Year Service Agreement',field:'service_10yr',type:'toggle'},
  ],
  epc:[
    {lbl:'EPC Scope',field:'epc_scope',type:'select',opts:['','Full EPC','Civil Only','Electrical Only','Split EPC']},
    {lbl:'Prevailing Wage Compliance',field:'prev_wage',type:'toggle'},{lbl:'Domestic Content Compliance',field:'dom_content',type:'toggle'},
  ],
  design_firm:[
    {lbl:'Design Stage',field:'design_stage',type:'select',opts:['','Concept','30%','60%','90%','IFC','As-Built']},
    {lbl:'Stamped Drawings',field:'stamped',type:'toggle'},
  ],
};

/* ‚îÄ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
var openState={};  // bcard open/closed
(function init(){
  var p=new URLSearchParams(window.location.search);
  token=p.get('token');
  if(!token){showErr('No Token','This link is missing a share token.');return;}
  sb.from('share_tokens').select('*').eq('token',token).single().then(function(r){
    if(r.error){showErr('Invalid Link','This share link is invalid or has expired.');return;}
    var row=r.data;
    if(row.expires_at&&new Date(row.expires_at)<new Date()){
      showErr('Link Expired','This link expired on '+new Date(row.expires_at).toLocaleDateString()+'.');return;
    }
    projectId=row.project_id; categoryKey=row.category;
    catDef=STANDARD_CATS.find(function(c){return c.key===categoryKey;});
    sb.from('projects').select('id,name,capacity_mw,stage,tally_fields').eq('id',projectId).single().then(function(r2){
      if(r2.error||!r2.data){showErr('Project Not Found','The project could not be found.');return;}
      tf=r2.data.tally_fields||{};
      lf=Object.assign({},tf);
      renderPage(r2.data);
    });
  });
})();

/* ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderPage(proj){
  var catLabel=catDef?catDef.label:
    categoryKey==='score_design'?'Design & Engineering':
    categoryKey==='score_construct'?'Construction':
    categoryKey==='score_procurement'?'Procurement':'Category';
  var catIcon=catDef?catDef.icon:
    categoryKey==='score_design'?'‚öôÔ∏è':
    categoryKey==='score_construct'?'üèóÔ∏è':
    categoryKey==='score_procurement'?'üì¶':'üìÑ';

  document.getElementById('tb-badge').textContent=catIcon+' '+catLabel;
  document.getElementById('h-ico').textContent=catIcon;
  document.getElementById('h-name').textContent=proj.name||'Untitled Project';
  document.getElementById('h-meta').textContent=(proj.capacity_mw?proj.capacity_mw+' MWp':'')+
    (proj.stage?' ¬∑ '+proj.stage:'');
  document.getElementById('h-badge').textContent=catLabel;
  document.getElementById('sb-cat').textContent=catLabel;

  var body=document.getElementById('form-body');
  if(categoryKey==='score_design'){
    body.innerHTML=buildDesignPage();
  } else if(categoryKey==='score_construct'){
    body.innerHTML=buildConstructPage();
  } else if(categoryKey==='score_procurement'){
    body.innerHTML=buildProcPage();
  } else if(catDef){
    body.innerHTML=buildStandardPage();
  } else {
    body.innerHTML='<div class="sc" style="padding:20px;text-align:center;"><div style="font-size:13px;color:var(--muted);">No form available for this category.</div></div>';
  }

  updateProgress();
  document.getElementById('s-loading').classList.remove('active');
  document.getElementById('app').classList.add('active');
  document.getElementById('savebar').style.display='flex';
}

/* ‚îÄ‚îÄ‚îÄ STANDARD FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildStandardPage(){
  var h='';
  catDef.sections.forEach(function(sec,si){
    var filled=cntFilled(sec.fields,'');
    h+='<div class="sc">'+
      '<div class="sc-hdr" onclick="toggleSec(\'std-\'+'+si+')">'+
        '<span class="sc-ico">'+sec.icon+'</span>'+
        '<span class="sc-ttl">'+esc(sec.title)+'</span>'+
        '<span class="sc-cnt" id="cnt-std-'+si+'">'+filled+'/'+sec.fields.length+'</span>'+
        '<span class="sc-chev'+(si===0?' open':'')+'" id="chev-std-'+si+'">‚ñº</span>'+
      '</div>'+
      '<div class="sc-body'+(si===0?' open':'')+'" id="sb-std-'+si+'">'+
        buildFG(sec.fields,'','')+
      '</div>'+
    '</div>';
  });
  return h;
}

/* ‚îÄ‚îÄ‚îÄ DESIGN & ENGINEERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function getArrays(){try{return JSON.parse(lf.design_arrays||'[]');}catch(e){return[];}}
function setArrays(arr){lf.design_arrays=JSON.stringify(arr);updateProgress();}
function daUid(){return'da_'+Date.now()+'_'+Math.floor(Math.random()*9999);}

function buildDesignPage(){
  var arrays=getArrays();
  var h='<div class="sc" style="padding:16px 18px;">';
  h+='<div class="bldr-hdr">'+
    '<div><div class="bldr-ttl">‚òÄÔ∏è Design Arrays</div>'+
    '<div class="bldr-sub">Create one card per solar array or BESS unit. Fill in technical details for each.</div></div>'+
    '<div class="bldr-badge" id="da-badge">'+arrays.length+' array'+(arrays.length!==1?'s':'')+'</div>'+
  '</div>';
  h+='<div id="da-wrap">';
  if(!arrays.length){
    h+='<div class="empty-state"><div class="empty-ico">‚òÄÔ∏èüîã</div>'+
      '<div class="empty-ttl">No arrays yet</div>'+
      '<div class="empty-sub">Add your first design array to start filling in technical specifications.</div></div>';
  } else {
    arrays.forEach(function(a){h+=buildArrayCard(a);});
  }
  h+='</div>';
  h+='<button class="add-btn" style="margin-top:10px;" onclick="addArray()">Ôºã Add Design Array</button>';
  h+='</div>';

  // Main Components sub-section
  h+='<div class="sc" style="padding:16px 18px;">'+
    '<div class="bldr-hdr">'+
      '<div><div class="bldr-ttl">‚öôÔ∏è Main Components</div>'+
      '<div class="bldr-sub">Register PV modules, inverters, trackers, transformers and other major equipment.</div></div>'+
      '<div class="bldr-badge" id="comp-badge">'+getItems('reg_components').length+' items</div>'+
    '</div>'+
    '<div id="comp-wrap">';
  var comps=getItems('reg_components');
  if(!comps.length){
    h+='<div class="empty-state"><div class="empty-ico">‚öôÔ∏èüîã</div><div class="empty-ttl">No components yet</div><div class="empty-sub">Add modules, inverters, trackers and other equipment.</div></div>';
  } else {
    comps.forEach(function(c){h+=buildCompCard(c);});
  }
  h+='</div>';
  h+='<div class="picker" id="comp-picker">'+
    '<div class="picker-lbl">Select component type</div>'+
    '<div class="picker-chips">';
  Object.keys(COMP_TYPES).forEach(function(k){
    var t=COMP_TYPES[k];
    h+='<button class="pchip" onclick="addComp(\''+k+'\')">'+t.icon+' '+t.label+'</button>';
  });
  h+='</div></div>';
  h+='<button class="add-btn" style="margin-top:10px;" onclick="togglePicker(\'comp-picker\')">Ôºã Add Component</button>';
  h+='</div>';
  return h;
}

function buildArrayCard(a){
  var name=lf['arr_'+a.id+'_dc_mw']?'Array ‚Äî '+lf['arr_'+a.id+'_dc_mw']+' MWdc':(a.name||'New Array');
  var isOpen=openState['da_'+a.id]!==false;
  var h='<div class="bcard" id="bcard-da-'+a.id+'">'+
    '<div class="bcard-hdr" onclick="toggleBcard(\'da-\'+\''+a.id+'\')">'+
      '<span class="bcard-ico">‚òÄÔ∏è</span>'+
      '<div class="bcard-info"><div class="bcard-name" id="dname-'+a.id+'">'+esc(name)+'</div>'+
        '<div class="bcard-sub">Design Array</div></div>'+
      '<span class="bcard-fill" id="dfill-'+a.id+'">‚Äî</span>'+
      '<button class="bcard-del" onclick="event.stopPropagation();delArray(\''+a.id+'\')">‚úï Delete</button>'+
      '<span class="bcard-chev'+(isOpen?' open':'')+'" id="dchev-'+a.id+'">‚ñº</span>'+
    '</div>'+
    '<div class="bcard-body'+(isOpen?' open':'')+'" id="dbody-'+a.id+'">';
  DESIGN_ARRAY_SECTIONS.forEach(function(sec,si){
    var filled=cntFilled(sec.fields,'arr_'+a.id+'_');
    h+='<div class="bsub">'+
      '<div class="bsub-hdr" onclick="toggleBsub(\'da-'+a.id+'-'+si+'\')">'+
        '<span class="bsub-ico">'+sec.icon+'</span>'+
        '<span class="bsub-ttl">'+sec.title+'</span>'+
        '<span class="bsub-cnt" id="dsub-cnt-'+a.id+'-'+si+'">'+filled+'/'+sec.fields.length+'</span>'+
        '<span class="bsub-chev'+(si===0?' open':'')+'" id="dsubchev-'+a.id+'-'+si+'">‚ñº</span>'+
      '</div>'+
      '<div class="bsub-body'+(si===0?' open':'')+'" id="dsubbody-'+a.id+'-'+si+'">'+
        buildFG(sec.fields,'arr_'+a.id+'_','')+
      '</div>'+
    '</div>';
  });
  h+='</div></div>';
  return h;
}

function addArray(){
  var arrays=getArrays();
  var a={id:daUid(),name:'Array '+(arrays.length+1)};
  arrays.push(a);
  setArrays(arrays);
  var wrap=document.getElementById('da-wrap');
  var empty=wrap.querySelector('.empty-state');
  if(empty) empty.remove();
  wrap.insertAdjacentHTML('beforeend',buildArrayCard(a));
  document.getElementById('da-badge').textContent=arrays.length+' array'+(arrays.length!==1?'s':'');
}
function delArray(id){
  if(!confirm('Delete this design array?')) return;
  var arrays=getArrays().filter(function(a){return a.id!==id;});
  setArrays(arrays);
  // clear field keys for this array
  Object.keys(lf).forEach(function(k){if(k.startsWith('arr_'+id+'_')) delete lf[k];});
  var el=document.getElementById('bcard-da-'+id);
  if(el) el.remove();
  document.getElementById('da-badge').textContent=arrays.length+' array'+(arrays.length!==1?'s':'');
  var wrap=document.getElementById('da-wrap');
  if(!wrap.children.length) wrap.innerHTML='<div class="empty-state"><div class="empty-ico">‚òÄÔ∏èüîã</div><div class="empty-ttl">No arrays yet</div><div class="empty-sub">Add your first design array.</div></div>';
  updateProgress();
}

/* ‚îÄ‚îÄ‚îÄ COMPONENTS (inside Design) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function getItems(key){try{return JSON.parse(lf[key]||'[]');}catch(e){return[];}}
function setItems(key,items){lf[key]=JSON.stringify(items);updateProgress();}
function cmpUid(){return'cmp_'+Date.now()+'_'+Math.floor(Math.random()*9999);}

function buildCompCard(c){
  var td=COMP_TYPES[c.type]||{icon:'‚öôÔ∏è',label:'Component',fields:[]};
  var isOpen=openState['comp_'+c.id]!==false;
  var nm=(lf['cmp_'+c.id+'_mfr']||'')+' '+(lf['cmp_'+c.id+'_model']||'');
  nm=nm.trim()||td.label;
  var filled=cntFilled(td.fields,'cmp_'+c.id+'_');
  return '<div class="bcard" id="bcard-comp-'+c.id+'">'+
    '<div class="bcard-hdr" onclick="toggleBcard(\'comp-\'+\''+c.id+'\')">'+
      '<span class="bcard-ico">'+td.icon+'</span>'+
      '<div class="bcard-info"><div class="bcard-name">'+esc(nm)+'</div><div class="bcard-sub">'+td.label+'</div></div>'+
      '<span class="bcard-fill">'+filled+'/'+td.fields.length+'</span>'+
      '<button class="bcard-del" onclick="event.stopPropagation();delComp(\''+c.id+'\')">‚úï</button>'+
      '<span class="bcard-chev'+(isOpen?' open':'')+'" id="compchev-'+c.id+'">‚ñº</span>'+
    '</div>'+
    '<div class="bcard-body'+(isOpen?' open':'')+'" id="compbody-'+c.id+'">'+
      '<div class="bsub" style="background:none;border:none;"><div class="bsub-body open" style="padding:0;">'+
        buildFG(td.fields,'cmp_'+c.id+'_','')+
      '</div></div>'+
    '</div>'+
  '</div>';
}
function togglePicker(id){var el=document.getElementById(id);if(el)el.classList.toggle('open');}
function addComp(type){
  var items=getItems('reg_components');
  var c={id:cmpUid(),type:type};
  items.push(c);
  setItems('reg_components',items);
  var wrap=document.getElementById('comp-wrap');
  var empty=wrap.querySelector('.empty-state');
  if(empty) empty.remove();
  wrap.insertAdjacentHTML('beforeend',buildCompCard(c));
  document.getElementById('comp-badge').textContent=items.length+' items';
  var picker=document.getElementById('comp-picker');
  if(picker) picker.classList.remove('open');
}
function delComp(id){
  if(!confirm('Delete this component?')) return;
  var items=getItems('reg_components').filter(function(c){return c.id!==id;});
  setItems('reg_components',items);
  Object.keys(lf).forEach(function(k){if(k.startsWith('cmp_'+id+'_')) delete lf[k];});
  var el=document.getElementById('bcard-comp-'+id);
  if(el) el.remove();
  document.getElementById('comp-badge').textContent=items.length+' items';
}

/* ‚îÄ‚îÄ‚îÄ CONSTRUCTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function getCrews(){try{return JSON.parse(lf.construction_crews||'[]');}catch(e){return[];}}
function setCrews(c){lf.construction_crews=JSON.stringify(c);updateProgress();}
function crUid(){return'cr_'+Date.now()+'_'+Math.floor(Math.random()*9999);}
function getEquip(){try{return JSON.parse(lf.reg_equipment||'[]');}catch(e){return[];}}
function setEquip(e){lf.reg_equipment=JSON.stringify(e);updateProgress();}
function eqUid(){return'eq_'+Date.now()+'_'+Math.floor(Math.random()*9999);}

function buildConstructPage(){
  // Schedule & Budget sections from standard construct cat
  var constCat={sections:[
    {icon:'üìÖ',title:'Overall Schedule',fields:[
      {lbl:'NTP Date',field:'ntp_date',type:'date'},{lbl:'Construction Start',field:'construction_start',type:'date'},
      {lbl:'Mechanical Completion',field:'mech_complete_date',type:'date'},{lbl:'PAC Date',field:'pac_date',type:'date'},
      {lbl:'FAC / COD Target',field:'cod_target_date',type:'date'},{lbl:'Total Duration (months)',field:'const_duration_mo',type:'number'},
      {lbl:'Weather Contingency (days)',field:'weather_days',type:'number'},{lbl:'Float on Critical Path (days)',field:'cp_float_days',type:'number'},
    ]},
    {icon:'üí∞',title:'Budget & Cost',fields:[
      {lbl:'Total EPC Price ($)',field:'epc_price',type:'number'},{lbl:'EPC Price ($/Wdc)',field:'epc_per_wdc',type:'number'},
      {lbl:"Owner's Costs ($)",field:'owners_costs',type:'number'},{lbl:'Interconnection Cost ($)',field:'intercon_cost',type:'number'},
      {lbl:'Contingency ($)',field:'contingency_usd',type:'number'},{lbl:'Contingency (%)',field:'contingency_pct',type:'number'},
    ]},
  ]};
  var h='';
  constCat.sections.forEach(function(sec,si){
    var filled=cntFilled(sec.fields,'');
    h+='<div class="sc">'+
      '<div class="sc-hdr" onclick="toggleSec(\'cs-\'+'+si+')">'+
        '<span class="sc-ico">'+sec.icon+'</span>'+
        '<span class="sc-ttl">'+esc(sec.title)+'</span>'+
        '<span class="sc-cnt" id="cnt-cs-'+si+'">'+filled+'/'+sec.fields.length+'</span>'+
        '<span class="sc-chev'+(si===0?' open':'')+'" id="chev-cs-'+si+'">‚ñº</span>'+
      '</div>'+
      '<div class="sc-body'+(si===0?' open':'')+'" id="sb-cs-'+si+'">'+buildFG(sec.fields,'','')+'</div>'+
    '</div>';
  });

  // Crews
  var crews=getCrews();
  h+='<div class="sc" style="padding:16px 18px;">'+
    '<div class="bldr-hdr">'+
      '<div><div class="bldr-ttl">üë∑ Workforce & Crews</div>'+
      '<div class="bldr-sub">Add a crew card for civil earthworks, module installation, and electrical work.</div></div>'+
      '<div class="bldr-badge" id="crew-badge">'+crews.length+' crew'+(crews.length!==1?'s':'')+'</div>'+
    '</div>'+
    '<div id="crew-wrap">';
  if(!crews.length){
    h+='<div class="empty-state"><div class="empty-ico">üèóÔ∏è‚òÄÔ∏è‚ö°</div>'+
      '<div class="empty-ttl">No crews added yet</div>'+
      '<div class="empty-sub">Add a crew for each work type on site.</div></div>';
  } else {
    crews.forEach(function(c){h+=buildCrewCard(c);});
  }
  h+='</div>'+
    '<div class="add-btn-row" style="margin-top:10px;">';
  Object.keys(CREW_TYPES).forEach(function(t){
    var ct=CREW_TYPES[t];
    h+='<button class="add-btn" style="border-color:'+ct.color+';color:'+ct.color+';" onclick="addCrew(\''+t+'\')">'+ct.icon+' Add '+ct.label+'</button>';
  });
  h+='</div></div>';

  // Equipment
  var equip=getEquip();
  h+='<div class="sc" style="padding:16px 18px;">'+
    '<div class="bldr-hdr">'+
      '<div><div class="bldr-ttl">üöú Equipment Registry</div>'+
      '<div class="bldr-sub">Register construction machinery ‚Äî linked to crews above.</div></div>'+
      '<div class="bldr-badge" id="equip-badge">'+equip.length+' items</div>'+
    '</div>'+
    '<div id="equip-wrap">';
  if(!equip.length){
    h+='<div class="empty-state"><div class="empty-ico">üöú‚õèÔ∏èüî®</div><div class="empty-ttl">No equipment yet</div><div class="empty-sub">Add bulldozers, excavators, pile drivers, etc.</div></div>';
  } else {
    equip.forEach(function(e){h+=buildEquipCard(e);});
  }
  h+='</div>'+
    '<div class="picker" id="equip-picker">'+
      '<div class="picker-lbl">Select equipment type</div>'+
      '<div class="picker-chips">';
  Object.keys(EQUIP_TYPES).forEach(function(k){
    var t=EQUIP_TYPES[k];
    h+='<button class="pchip" onclick="addEquip(\''+k+'\')">'+t.icon+' '+t.label+'</button>';
  });
  h+='</div></div>'+
    '<button class="add-btn" style="margin-top:10px;" onclick="togglePicker(\'equip-picker\')">Ôºã Add Equipment</button>'+
  '</div>';
  return h;
}

function buildCrewCard(c){
  var ct=CREW_TYPES[c.type];if(!ct)return'';
  var name=lf['crew_'+c.id+'_nickname']||ct.label;
  var isOpen=openState['crew_'+c.id]!==false;
  var filled=cntFilled(ct.manpower,'crew_'+c.id+'_');
  var h='<div class="bcard" id="bcard-crew-'+c.id+'">'+
    '<div class="bcard-hdr" onclick="toggleBcard(\'crew-\'+\''+c.id+'\')" style="border-left:4px solid '+ct.color+';">'+
      '<span class="bcard-ico">'+ct.icon+'</span>'+
      '<div class="bcard-info"><div class="bcard-name">'+esc(name)+'</div><div class="bcard-sub">'+ct.label+'</div></div>'+
      '<span class="bcard-fill">'+filled+'/'+ct.manpower.length+'</span>'+
      '<button class="bcard-del" onclick="event.stopPropagation();delCrew(\''+c.id+'\')">‚úï</button>'+
      '<span class="bcard-chev'+(isOpen?' open':'')+'" id="crewchev-'+c.id+'">‚ñº</span>'+
    '</div>'+
    '<div class="bcard-body'+(isOpen?' open':'')+'" id="crewbody-'+c.id+'">';

  // Manpower sub
  h+='<div class="bsub">'+
    '<div class="bsub-hdr" onclick="toggleBsub(\'crewmp-'+c.id+'\')">'+
      '<span class="bsub-ico">üë∑</span><span class="bsub-ttl">Manpower & Schedule</span>'+
      '<span class="bsub-chev open" id="bsubchev-crewmp-'+c.id+'">‚ñº</span>'+
    '</div>'+
    '<div class="bsub-body open" id="bsubbody-crewmp-'+c.id+'">'+buildFG(ct.manpower,'crew_'+c.id+'_','')+'</div>'+
  '</div>';

  // Milestones sub
  h+='<div class="bsub">'+
    '<div class="bsub-hdr" onclick="toggleBsub(\'crewms-'+c.id+'\')">'+
      '<span class="bsub-ico">üìÖ</span><span class="bsub-ttl">Timeline Milestones</span>'+
      '<span class="bsub-chev" id="bsubchev-crewms-'+c.id+'">‚ñº</span>'+
    '</div>'+
    '<div class="bsub-body" id="bsubbody-crewms-'+c.id+'">'+buildMilestones(ct.milestones,'crew_'+c.id+'_ms_')+'</div>'+
  '</div>';

  h+='</div></div>';
  return h;
}
function addCrew(type){
  var crews=getCrews();
  var c={id:crUid(),type:type};
  crews.push(c);
  setCrews(crews);
  var wrap=document.getElementById('crew-wrap');
  var empty=wrap.querySelector('.empty-state');
  if(empty) empty.remove();
  wrap.insertAdjacentHTML('beforeend',buildCrewCard(c));
  document.getElementById('crew-badge').textContent=crews.length+' crew'+(crews.length!==1?'s':'');
}
function delCrew(id){
  if(!confirm('Delete this crew?')) return;
  var crews=getCrews().filter(function(c){return c.id!==id;});
  setCrews(crews);
  Object.keys(lf).forEach(function(k){if(k.startsWith('crew_'+id+'_')) delete lf[k];});
  var el=document.getElementById('bcard-crew-'+id);if(el)el.remove();
  document.getElementById('crew-badge').textContent=crews.length+' crew'+(crews.length!==1?'s':'');
  var wrap=document.getElementById('crew-wrap');
  if(!wrap.children.length) wrap.innerHTML='<div class="empty-state"><div class="empty-ico">üèóÔ∏è‚òÄÔ∏è‚ö°</div><div class="empty-ttl">No crews</div><div class="empty-sub">Add a crew for each work type.</div></div>';
}

function buildEquipCard(e){
  var td=EQUIP_TYPES[e.type]||{icon:'üöú',label:'Equipment',fields:[]};
  var isOpen=openState['eq_'+e.id]!==false;
  var nm=(lf['eq_'+e.id+'_mfr']||'')+' '+(lf['eq_'+e.id+'_model']||'');
  nm=nm.trim()||td.label;
  var filled=cntFilled(td.fields,'eq_'+e.id+'_');
  return '<div class="bcard" id="bcard-eq-'+e.id+'">'+
    '<div class="bcard-hdr" onclick="toggleBcard(\'eq-\'+\''+e.id+'\')">'+
      '<span class="bcard-ico">'+td.icon+'</span>'+
      '<div class="bcard-info"><div class="bcard-name">'+esc(nm)+'</div><div class="bcard-sub">'+td.label+'</div></div>'+
      '<span class="bcard-fill">'+filled+'/'+td.fields.length+'</span>'+
      '<button class="bcard-del" onclick="event.stopPropagation();delEquip(\''+e.id+'\')">‚úï</button>'+
      '<span class="bcard-chev'+(isOpen?' open':'')+'" id="eqchev-'+e.id+'">‚ñº</span>'+
    '</div>'+
    '<div class="bcard-body'+(isOpen?' open':'')+'" id="eqbody-'+e.id+'">'+
      '<div class="bsub" style="background:none;border:none;"><div class="bsub-body open" style="padding:0;">'+buildFG(td.fields,'eq_'+e.id+'_','')+'</div></div>'+
    '</div>'+
  '</div>';
}
function addEquip(type){
  var items=getEquip();
  var e={id:eqUid(),type:type};
  items.push(e);
  setEquip(items);
  var wrap=document.getElementById('equip-wrap');
  var empty=wrap.querySelector('.empty-state');
  if(empty) empty.remove();
  wrap.insertAdjacentHTML('beforeend',buildEquipCard(e));
  document.getElementById('equip-badge').textContent=items.length+' items';
  togglePicker('equip-picker');
}
function delEquip(id){
  if(!confirm('Delete this equipment?')) return;
  var items=getEquip().filter(function(e){return e.id!==id;});
  setEquip(items);
  Object.keys(lf).forEach(function(k){if(k.startsWith('eq_'+id+'_')) delete lf[k];});
  var el=document.getElementById('bcard-eq-'+id);if(el)el.remove();
  document.getElementById('equip-badge').textContent=items.length+' items';
}

/* ‚îÄ‚îÄ‚îÄ PROCUREMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function getContracts(){try{return JSON.parse(lf.procurement_contracts||'[]');}catch(e){return[];}}
function setContracts(c){lf.procurement_contracts=JSON.stringify(c);updateProgress();}
function getSuppliers(){try{return JSON.parse(lf.reg_suppliers||'[]');}catch(e){return[];}}
function setSuppliers(s){lf.reg_suppliers=JSON.stringify(s);updateProgress();}
function pcUid(){return'pc_'+Date.now()+'_'+Math.floor(Math.random()*9999);}
function spUid(){return'sp_'+Date.now()+'_'+Math.floor(Math.random()*9999);}

function buildProcPage(){
  var contracts=getContracts();
  var suppliers=getSuppliers();
  var h='';

  // Supplier registry
  h+='<div class="sc" style="padding:16px 18px;">'+
    '<div class="bldr-hdr">'+
      '<div><div class="bldr-ttl">üè¢ Suppliers & Contractors</div>'+
      '<div class="bldr-sub">Register all companies ‚Äî EPC, module supplier, law firm, etc. Then create contract cards below.</div></div>'+
      '<div class="bldr-badge" id="sup-badge">'+suppliers.length+' companies</div>'+
    '</div>'+
    '<div id="sup-wrap">';
  if(!suppliers.length){
    h+='<div class="empty-state"><div class="empty-ico">üè¢üèóÔ∏è</div><div class="empty-ttl">No companies yet</div>'+
      '<div class="empty-sub">Add your EPC contractor, module supplier, design firm, etc.</div></div>';
  } else {
    suppliers.forEach(function(s){h+=buildSupCard(s);});
  }
  h+='</div>'+
    '<div class="picker" id="sup-picker">'+
      '<div class="picker-lbl">Select company type</div>'+
      '<div class="picker-chips">';
  Object.keys(SUPPLIER_TYPES).forEach(function(k){
    var t=SUPPLIER_TYPES[k];
    h+='<button class="pchip" onclick="addSupplier(\''+k+'\')">'+t.icon+' '+t.label+'</button>';
  });
  h+='</div></div>'+
    '<button class="add-btn" style="margin-top:10px;" onclick="togglePicker(\'sup-picker\')">Ôºã Add Company</button>'+
  '</div>';

  // Contracts
  h+='<div class="sc" style="padding:16px 18px;">'+
    '<div class="bldr-hdr">'+
      '<div><div class="bldr-ttl">üìã Supplier Contracts</div>'+
      '<div class="bldr-sub">Define commercial terms for each supplier agreement ‚Äî select from the registry above.</div></div>'+
      '<div class="bldr-badge" id="pc-badge">'+contracts.length+' contracts</div>'+
    '</div>'+
    '<div id="pc-wrap">';
  if(!contracts.length){
    h+='<div class="empty-state"><div class="empty-ico">üìãü§ù</div><div class="empty-ttl">No contracts yet</div>'+
      '<div class="empty-sub">First add companies above, then create a contract card for each agreement.</div></div>';
  } else {
    contracts.forEach(function(c){h+=buildPcCard(c);});
  }
  h+='</div>'+
    '<div class="picker" id="pc-picker">'+
      '<div class="picker-lbl">Select supplier to create contract</div>'+
      '<div id="pc-picker-chips" class="picker-chips"></div>'+
    '</div>'+
    '<button class="add-btn" style="margin-top:10px;" onclick="openPcPicker()">Ôºã Add Contract from Supplier</button>'+
  '</div>';
  return h;
}

function buildSupCard(s){
  var td=SUPPLIER_TYPES[s.type]||{icon:'üè¢',label:'Company'};
  var fields=companyFields();
  var isOpen=openState['sp_'+s.id]!==false;
  var nm=lf['sp_'+s.id+'_name']||td.label;
  var filled=cntFilled(fields,'sp_'+s.id+'_');
  return '<div class="bcard" id="bcard-sp-'+s.id+'">'+
    '<div class="bcard-hdr" onclick="toggleBcard(\'sp-\'+\''+s.id+'\')">'+
      '<span class="bcard-ico">'+td.icon+'</span>'+
      '<div class="bcard-info"><div class="bcard-name">'+esc(nm)+'</div><div class="bcard-sub">'+td.label+'</div></div>'+
      '<span class="bcard-fill">'+filled+'/'+fields.length+'</span>'+
      '<button class="bcard-del" onclick="event.stopPropagation();delSupplier(\''+s.id+'\')">‚úï</button>'+
      '<span class="bcard-chev'+(isOpen?' open':'')+'" id="spchev-'+s.id+'">‚ñº</span>'+
    '</div>'+
    '<div class="bcard-body'+(isOpen?' open':'')+'" id="spbody-'+s.id+'">'+
      '<div class="bsub" style="background:none;border:none;"><div class="bsub-body open" style="padding:0;">'+buildFG(fields,'sp_'+s.id+'_','')+'</div></div>'+
    '</div>'+
  '</div>';
}
function addSupplier(type){
  var items=getSuppliers();
  var s={id:spUid(),type:type};
  items.push(s);
  setSuppliers(items);
  var wrap=document.getElementById('sup-wrap');
  var empty=wrap.querySelector('.empty-state');
  if(empty) empty.remove();
  wrap.insertAdjacentHTML('beforeend',buildSupCard(s));
  document.getElementById('sup-badge').textContent=items.length+' companies';
  togglePicker('sup-picker');
}
function delSupplier(id){
  if(!confirm('Delete this company?')) return;
  var items=getSuppliers().filter(function(s){return s.id!==id;});
  setSuppliers(items);
  Object.keys(lf).forEach(function(k){if(k.startsWith('sp_'+id+'_')) delete lf[k];});
  var el=document.getElementById('bcard-sp-'+id);if(el)el.remove();
  document.getElementById('sup-badge').textContent=items.length+' companies';
}

function openPcPicker(){
  var suppliers=getSuppliers();
  var chips=document.getElementById('pc-picker-chips');
  if(!chips) return;
  if(!suppliers.length){
    chips.innerHTML='<div style="font-size:11px;color:var(--muted);padding:8px;">Add companies in the registry above first.</div>';
  } else {
    chips.innerHTML='';
    suppliers.forEach(function(s){
      var td=SUPPLIER_TYPES[s.type]||{icon:'üè¢',label:'Company'};
      var nm=lf['sp_'+s.id+'_name']||td.label;
      chips.insertAdjacentHTML('beforeend',
        '<button class="pchip" onclick="addContract(\''+s.id+'\',\''+s.type+'\',\''+esc(nm).replace(/'/g,"\\'")+'\')">' +
        td.icon+' '+esc(nm)+'</button>');
    });
  }
  togglePicker('pc-picker');
}
function addContract(supplierId,supplierType,supplierName){
  var contracts=getContracts();
  var c={id:pcUid(),supplierId:supplierId,supplierType:supplierType,supplierName:supplierName};
  contracts.push(c);
  setContracts(contracts);
  var wrap=document.getElementById('pc-wrap');
  var empty=wrap.querySelector('.empty-state');
  if(empty) empty.remove();
  wrap.insertAdjacentHTML('beforeend',buildPcCard(c));
  document.getElementById('pc-badge').textContent=contracts.length+' contracts';
  togglePicker('pc-picker');
}
function delContract(id){
  if(!confirm('Delete this contract?')) return;
  var contracts=getContracts().filter(function(c){return c.id!==id;});
  setContracts(contracts);
  Object.keys(lf).forEach(function(k){if(k.startsWith('pc_'+id+'_')) delete lf[k];});
  var el=document.getElementById('bcard-pc-'+id);if(el)el.remove();
  document.getElementById('pc-badge').textContent=contracts.length+' contracts';
  var wrap=document.getElementById('pc-wrap');
  if(!wrap.children.length) wrap.innerHTML='<div class="empty-state"><div class="empty-ico">üìãü§ù</div><div class="empty-ttl">No contracts yet</div><div class="empty-sub">Select a supplier to create a contract.</div></div>';
}

function buildPcCard(c){
  var td=SUPPLIER_TYPES[c.supplierType]||{icon:'üè¢',label:'Supplier'};
  var nm=c.supplierName||lf['sp_'+c.supplierId+'_name']||td.label;
  var isOpen=openState['pc_'+c.id]!==false;
  var extra=PROC_EXTRA[c.supplierType]||[];
  var allF=PROC_COMMON.concat(PROC_PMT).concat(PROC_LD).concat(extra);
  var filled=cntFilled(allF,'pc_'+c.id+'_');
  var subs=[
    {icon:'üìã',title:'Contract Terms',fields:PROC_COMMON.concat(extra)},
    {icon:'üí≥',title:'Payment Milestones',fields:PROC_PMT},
    {icon:'‚ö†Ô∏è',title:'LDs, Delivery & Warranty',fields:PROC_LD},
  ];
  var h='<div class="bcard" id="bcard-pc-'+c.id+'">'+
    '<div class="bcard-hdr" onclick="toggleBcard(\'pc-\'+\''+c.id+'\')">'+
      '<span class="bcard-ico">'+td.icon+'</span>'+
      '<div class="bcard-info"><div class="bcard-name">'+esc(nm)+'</div><div class="bcard-sub">'+td.label+'</div></div>'+
      '<span class="bcard-fill">'+filled+'/'+allF.length+'</span>'+
      '<button class="bcard-del" onclick="event.stopPropagation();delContract(\''+c.id+'\')">‚úï</button>'+
      '<span class="bcard-chev'+(isOpen?' open':'')+'" id="pcchev-'+c.id+'">‚ñº</span>'+
    '</div>'+
    '<div class="bcard-body'+(isOpen?' open':'')+'" id="pcbody-'+c.id+'">';
  subs.forEach(function(sub,si){
    h+='<div class="bsub">'+
      '<div class="bsub-hdr" onclick="toggleBsub(\'pcsub-'+c.id+'-'+si+'\')">'+
        '<span class="bsub-ico">'+sub.icon+'</span><span class="bsub-ttl">'+sub.title+'</span>'+
        '<span class="bsub-chev'+(si===0?' open':'')+'" id="bsubchev-pcsub-'+c.id+'-'+si+'">‚ñº</span>'+
      '</div>'+
      '<div class="bsub-body'+(si===0?' open':'')+'" id="bsubbody-pcsub-'+c.id+'-'+si+'">'+
        buildFG(sub.fields,'pc_'+c.id+'_','')+
      '</div>'+
    '</div>';
  });
  h+='</div></div>';
  return h;
}

/* ‚îÄ‚îÄ‚îÄ FIELD GRID BUILDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildFG(fields,prefix,_unused){
  var h='<div class="fg">';
  fields.forEach(function(f){
    var id='f_'+prefix+f.field;
    var val=lf[prefix+f.field];
    var cls='fw'+(f.col===2?' c2':'');
    h+='<div class="'+cls+'"><label class="fl" for="'+id+'">'+esc(f.lbl)+'</label>';
    if(f.type==='toggle'){
      var on=(val===true||val==='true'||val===1);
      h+='<div class="tog-w">'+
        '<div class="tog-t'+(on?' on':'')+'" id="'+id+'" onclick="togF(\''+prefix+f.field+'\',\''+id+'\')">'+
          '<div class="tog-k"></div>'+
        '</div>'+
        '<span class="tog-l" id="'+id+'_l">'+(on?'Yes':'No')+'</span>'+
      '</div>';
    } else if(f.type==='select'){
      h+='<select class="fs" id="'+id+'" onchange="chgF(\''+prefix+f.field+'\',this.value)">';
      (f.opts||[]).forEach(function(o){
        h+='<option value="'+esc(o)+'"'+(String(val||'')===o?' selected':'')+'>'+esc(o||'‚Äî Select ‚Äî')+'</option>';
      });
      h+='</select>';
    } else {
      var t=f.type==='date'?'date':f.type==='number'?'number':'text';
      h+='<input class="fi" type="'+t+'" id="'+id+'" '+
        'value="'+esc(String(val!=null&&val!==''?val:''))+'" '+
        'placeholder="'+esc(f.lbl)+'" '+
        'oninput="chgF(\''+prefix+f.field+'\',this.value)"/>';
    }
    h+='</div>';
  });
  return h+'</div>';
}

function buildMilestones(milestones,prefix){
  var h='<div class="ms-grid">';
  milestones.forEach(function(m,i){
    var k=prefix+'ms_'+i;
    var stat=lf[k+'_status']||'';
    var dt=lf[k+'_date']||'';
    h+='<div class="ms-row">'+
      '<div class="ms-dot"></div>'+
      '<span class="ms-lbl">'+esc(m)+'</span>'+
      '<select class="ms-sel" onchange="chgF(\''+k+'_status\',this.value)">'+
        '<option value=""'+(stat===''?' selected':'')+'>‚Äî Status ‚Äî</option>'+
        '<option value="Pending"'+(stat==='Pending'?' selected':'')+'>Pending</option>'+
        '<option value="In Progress"'+(stat==='In Progress'?' selected':'')+'>In Progress</option>'+
        '<option value="Complete"'+(stat==='Complete'?' selected':'')+'>Complete</option>'+
        '<option value="Delayed"'+(stat==='Delayed'?' selected':'')+'>Delayed</option>'+
      '</select>'+
      '<input type="date" class="ms-date" value="'+esc(dt)+'" oninput="chgF(\''+k+'_date\',this.value)"/>'+
    '</div>';
  });
  return h+'</div>';
}

/* ‚îÄ‚îÄ‚îÄ TOGGLE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function toggleSec(id){
  document.getElementById('sb-'+id).classList.toggle('open');
  document.getElementById('chev-'+id).classList.toggle('open');
}
function toggleBcard(id){
  var prefix=id.split('-')[0];
  var itemId=id.substring(prefix.length+1);
  var bodyMap={da:'dbody-',comp:'compbody-',crew:'crewbody-',eq:'eqbody-',sp:'spbody-',pc:'pcbody-'};
  var chevMap={da:'dchev-', comp:'compchev-', crew:'crewchev-',eq:'eqchev-', sp:'spchev-', pc:'pcchev-'};
  var b=document.getElementById((bodyMap[prefix]||'x-')+itemId);
  var ch=document.getElementById((chevMap[prefix]||'x-')+itemId);
  if(b){b.classList.toggle('open');openState[prefix+'_'+itemId]=b.classList.contains('open');}
  if(ch) ch.classList.toggle('open');
}
function toggleBsub(id){
  var b=document.getElementById('bsubbody-'+id);
  var c=document.getElementById('bsubchev-'+id);
  if(b) b.classList.toggle('open');
  if(c) c.classList.toggle('open');
}

/* ‚îÄ‚îÄ‚îÄ FIELD CHANGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function chgF(k,v){lf[k]=v;updateProgress();}
function togF(k,id){
  var t=document.getElementById(id);
  var l=document.getElementById(id+'_l');
  var on=!t.classList.contains('on');
  t.classList.toggle('on',on);
  if(l) l.textContent=on?'Yes':'No';
  lf[k]=on;
  updateProgress();
}

/* ‚îÄ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function cntFilled(fields,prefix){
  return fields.filter(function(f){
    var v=lf[prefix+f.field];
    return v!==undefined&&v!==null&&v!==''&&v!==false&&v!=='false';
  }).length;
}
function updateProgress(){
  var total=0,filled=0;
  if(catDef){
    catDef.sections.forEach(function(sec){
      total+=sec.fields.length;filled+=cntFilled(sec.fields,'');
    });
  } else if(categoryKey==='score_design'){
    var arrays=getArrays();
    arrays.forEach(function(a){
      DESIGN_ARRAY_SECTIONS.forEach(function(sec){total+=sec.fields.length;filled+=cntFilled(sec.fields,'arr_'+a.id+'_');});
    });
    var comps=getItems('reg_components');
    comps.forEach(function(c){
      var td=COMP_TYPES[c.type];if(!td)return;
      total+=td.fields.length;filled+=cntFilled(td.fields,'cmp_'+c.id+'_');
    });
  } else if(categoryKey==='score_construct'){
    var schedFields=[
      {field:'ntp_date'},{field:'construction_start'},{field:'mech_complete_date'},{field:'pac_date'},
      {field:'cod_target_date'},{field:'epc_price'},{field:'contingency_pct'},
    ];
    total+=schedFields.length;filled+=cntFilled(schedFields,'');
    var crews=getCrews();
    crews.forEach(function(c){
      var ct=CREW_TYPES[c.type];if(!ct)return;
      total+=ct.manpower.length;filled+=cntFilled(ct.manpower,'crew_'+c.id+'_');
    });
  } else if(categoryKey==='score_procurement'){
    var contracts=getContracts();
    var suppliers=getSuppliers();
    var cflds=companyFields();
    suppliers.forEach(function(s){total+=cflds.length;filled+=cntFilled(cflds,'sp_'+s.id+'_');});
    contracts.forEach(function(c){
      var extra=PROC_EXTRA[c.supplierType]||[];
      var allF=PROC_COMMON.concat(PROC_PMT).concat(PROC_LD).concat(extra);
      total+=allF.length;filled+=cntFilled(allF,'pc_'+c.id+'_');
    });
  }
  var pct=total>0?Math.round(filled/total*100):0;
  document.getElementById('prog-fill').style.width=pct+'%';
  document.getElementById('prog-pct').textContent=pct+'%';
}

/* ‚îÄ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function saveAll(){
  var btn=document.getElementById('btn-save');
  var msg=document.getElementById('sb-msg');
  btn.disabled=true;btn.textContent='Saving‚Ä¶';
  msg.className='sb-msg';msg.textContent='';
  var updated=Object.assign({},tf,lf);
  sb.from('projects').update({tally_fields:updated,updated_at:new Date().toISOString()}).eq('id',projectId).then(function(r){
    btn.disabled=false;btn.textContent='Save Data';
    if(r.error){
      msg.className='sb-msg err show';msg.textContent='Save failed ‚Äî try again.';
      setTimeout(function(){msg.classList.remove('show');},3500);
    } else {
      tf=updated;
      msg.className='sb-msg show';msg.textContent='Saved ‚úì';
      setTimeout(function(){msg.classList.remove('show');},2500);
      document.getElementById('ok-banner').classList.add('show');
    }
  });
}

/* ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function showErr(t,s){
  document.getElementById('s-loading').classList.remove('active');
  document.getElementById('err-t').textContent=t;
  document.getElementById('err-s').textContent=s;
  document.getElementById('s-error').classList.add('active');
}
function esc(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
