<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash ‚Äî Data Entry</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,700;0,9..40,800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#f0f2f6; --surface:#fff; --surface2:#f7f8fa;
  --border:rgba(0,0,0,0.08); --dark:#111827; --accent:#FFFF00;
  --muted:#6b7280; --ok:#16a34a; --radius:14px;
  --shadow:0 2px 16px rgba(0,0,0,0.08);
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--dark);min-height:100vh;}

/* TOPBAR */
.topbar{position:fixed;top:0;left:0;right:0;z-index:100;height:54px;background:var(--dark);
  border-bottom:3px solid var(--accent);display:flex;align-items:center;
  justify-content:space-between;padding:0 28px;}
.logo{font-size:20px;font-weight:800;color:#fff;text-decoration:none;}
.logo span{color:var(--accent);}
.tb-badge{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);
  color:#ccc;padding:4px 13px;border-radius:20px;font-size:11px;font-weight:600;}

/* STATES */
.state{display:none;flex-direction:column;align-items:center;justify-content:center;
  min-height:100vh;padding:80px 20px 40px;text-align:center;gap:14px;}
.state.active{display:flex;}
.state-icon{font-size:44px;}
.state-title{font-size:22px;font-weight:800;}
.state-sub{font-size:14px;color:var(--muted);max-width:380px;line-height:1.6;}
.spinner{width:38px;height:38px;border:3px solid rgba(0,0,0,0.1);
  border-top-color:var(--dark);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* MAIN */
#main-screen{display:none;padding:70px 0 72px;}
#main-screen.active{display:block;}
.page-wrap{max-width:740px;margin:0 auto;padding:22px 18px;display:flex;flex-direction:column;gap:14px;}

/* PROJECT HEADER */
.proj-header{background:var(--dark);border-radius:var(--radius);padding:18px 22px;
  display:flex;align-items:flex-start;gap:14px;box-shadow:var(--shadow);}
.cat-icon-box{width:44px;height:44px;border-radius:11px;background:rgba(255,255,255,0.1);
  display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;margin-top:2px;}
.proj-info{flex:1;min-width:0;}
.proj-name{font-size:17px;font-weight:800;color:#fff;letter-spacing:-0.3px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.proj-meta{font-size:11px;color:#777;margin-top:3px;}
.proj-notice{margin-top:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);
  border-radius:8px;padding:9px 13px;font-size:11px;color:#aaa;line-height:1.5;
  display:flex;align-items:flex-start;gap:7px;}
.proj-notice-ico{flex-shrink:0;font-size:13px;margin-top:1px;}
.cat-badge{background:var(--accent);color:var(--dark);font-size:9px;font-weight:800;
  text-transform:uppercase;letter-spacing:0.4px;padding:4px 11px;border-radius:20px;
  flex-shrink:0;white-space:nowrap;margin-top:2px;}

/* PROGRESS */
.progress-card{background:var(--surface);border-radius:var(--radius);padding:12px 18px;
  box-shadow:var(--shadow);display:flex;align-items:center;gap:12px;}
.prog-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;
  letter-spacing:0.4px;white-space:nowrap;}
.prog-track{flex:1;height:6px;background:rgba(0,0,0,0.08);border-radius:3px;overflow:hidden;}
.prog-fill{height:100%;background:var(--dark);border-radius:3px;transition:width .4s ease;width:0%;}
.prog-pct{font-size:12px;font-weight:800;color:var(--dark);min-width:34px;text-align:right;
  font-family:'DM Mono',monospace;}

/* SECTION CARDS */
.section-card{background:var(--surface);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);}
.sec-hdr{padding:12px 18px;border-bottom:1px solid var(--border);display:flex;
  align-items:center;gap:9px;cursor:pointer;user-select:none;transition:background .12s;}
.sec-hdr:hover{background:var(--surface2);}
.sec-ico{font-size:15px;flex-shrink:0;}
.sec-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;
  color:var(--dark);flex:1;}
.sec-count{font-size:9px;font-weight:700;background:var(--dark);color:var(--accent);
  padding:2px 8px;border-radius:20px;font-family:'DM Mono',monospace;}
.sec-chev{font-size:10px;color:var(--muted);transition:transform .2s;}
.sec-chev.open{transform:rotate(180deg);}
.sec-body{display:none;padding:16px 18px;}
.sec-body.open{display:block;}

/* FIELD GRID */
.field-grid{display:grid;grid-template-columns:1fr 1fr;gap:11px 13px;}
.fw{display:flex;flex-direction:column;gap:4px;}
.fw.col2{grid-column:span 2;}
.flbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;color:var(--muted);}
.finput,.fselect{width:100%;padding:8px 11px;background:var(--surface2);
  border:1.5px solid var(--border);border-radius:8px;
  font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;color:var(--dark);
  outline:none;transition:border-color .15s,box-shadow .15s;-webkit-appearance:none;}
.finput:focus,.fselect:focus{border-color:var(--dark);box-shadow:0 0 0 3px rgba(17,24,39,0.08);}
.finput::placeholder{color:#c4c9d4;}

/* TOGGLE */
.tog-wrap{display:flex;align-items:center;gap:9px;margin-top:4px;}
.tog-track{width:36px;height:20px;background:rgba(0,0,0,0.12);border-radius:10px;
  position:relative;cursor:pointer;flex-shrink:0;transition:background .2s;}
.tog-track.on{background:var(--dark);}
.tog-knob{position:absolute;top:2px;left:2px;width:16px;height:16px;
  background:#fff;border-radius:50%;transition:transform .2s;pointer-events:none;}
.tog-track.on .tog-knob{transform:translateX(16px);}
.tog-lbl{font-size:12px;font-weight:600;color:var(--muted);}
.tog-track.on+.tog-lbl{color:var(--dark);}

/* DONE BANNER */
.done-banner{display:none;background:#f0fdf4;border:1.5px solid #bbf7d0;
  border-radius:var(--radius);padding:14px 18px;align-items:center;gap:11px;}
.done-banner.show{display:flex;}
.done-ico{font-size:20px;flex-shrink:0;}
.done-txt{font-size:13px;color:#166534;font-weight:600;line-height:1.4;}

/* SAVE BAR */
.save-bar{position:fixed;bottom:0;left:0;right:0;z-index:50;background:var(--dark);
  border-top:1px solid rgba(255,255,255,0.08);padding:11px 28px;
  display:flex;align-items:center;justify-content:space-between;gap:12px;}
.save-bar-left{font-size:11px;color:#777;}
.save-bar-left strong{color:#fff;}
.save-bar-right{display:flex;align-items:center;gap:10px;}
.save-msg{font-size:11px;font-weight:600;color:#4ade80;opacity:0;transition:opacity .3s;}
.save-msg.show{opacity:1;}
.save-msg.err{color:#f87171;}
.btn-save{padding:9px 22px;background:var(--accent);border:none;border-radius:20px;
  font-family:'DM Sans',sans-serif;font-size:12px;font-weight:800;color:var(--dark);
  cursor:pointer;text-transform:uppercase;letter-spacing:0.3px;transition:background .15s,transform .1s;}
.btn-save:hover{background:#e6e600;}
.btn-save:active{transform:scale(.97);}
.btn-save:disabled{opacity:.4;cursor:not-allowed;}

@media(max-width:560px){
  .field-grid{grid-template-columns:1fr;}
  .fw.col2{grid-column:span 1;}
  .proj-header{flex-wrap:wrap;}
  .save-bar,.topbar{padding:10px 16px;}
  .page-wrap{padding:14px 12px;}
}
</style>
</head>
<body>

<div class="topbar">
  <a href="#" class="logo">Sun<span>Hash</span></a>
  <div><span class="tb-badge" id="tb-badge">Loading‚Ä¶</span></div>
</div>

<div class="state active" id="state-loading">
  <div class="spinner"></div>
  <div class="state-title">Loading form‚Ä¶</div>
  <div class="state-sub">Fetching project data from secure link.</div>
</div>

<div class="state" id="state-error">
  <div class="state-icon">üîí</div>
  <div class="state-title" id="err-title">Link Invalid</div>
  <div class="state-sub" id="err-sub">This link is no longer valid.</div>
</div>

<div id="main-screen">
  <div class="page-wrap">

    <div class="proj-header">
      <div class="cat-icon-box" id="hdr-icon">üìÑ</div>
      <div class="proj-info">
        <div class="proj-name" id="hdr-proj-name">‚Äî</div>
        <div class="proj-meta" id="hdr-proj-meta">‚Äî</div>
        <div class="proj-notice">
          <span class="proj-notice-ico">‚ÑπÔ∏è</span>
          <span>You have been invited to fill in data for this project. Your answers are saved directly to the project file. Fields already entered by the team are pre-populated ‚Äî feel free to update them.</span>
        </div>
      </div>
      <div class="cat-badge" id="hdr-cat-badge">Category</div>
    </div>

    <div class="progress-card">
      <span class="prog-lbl">Completion</span>
      <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
      <span class="prog-pct" id="prog-pct">0%</span>
    </div>

    <div class="done-banner" id="done-banner">
      <span class="done-ico">‚úÖ</span>
      <span class="done-txt">Data saved successfully. You can continue filling fields and save again at any time.</span>
    </div>

    <div id="form-sections"></div>
  </div>
</div>

<div class="save-bar" id="save-bar" style="display:none;">
  <div class="save-bar-left">Submitting as <strong>Guest</strong> ¬∑ <span id="save-cat-lbl">‚Äî</span></div>
  <div class="save-bar-right">
    <span class="save-msg" id="save-msg"></span>
    <button class="btn-save" id="btn-save" onclick="saveData()">Save Data</button>
  </div>
</div>

<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

var token = null, projectId = null, categoryKey = null, catDef = null;
var tallyFields = {}, localFields = {};

var CATEGORIES = [
  {
    key:"score_permit",label:"Permits & Entitlements",icon:"üìú",
    sections:[
      {icon:"üìç",title:"Project Location",fields:[
        {lbl:"Project Name",field:"proj_name",type:"text",col:2},
        {lbl:"County",field:"county",type:"text"},
        {lbl:"State",field:"state",type:"select",opts:["","AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"]},
        {lbl:"ISO / RTO",field:"iso_rto",type:"select",opts:["","PJM","CAISO","ERCOT","MISO","SPP","NYISO","ISO-NE","WECC","Other"]},
        {lbl:"Latitude",field:"latitude",type:"number"},
        {lbl:"Longitude",field:"longitude",type:"number"},
        {lbl:"Parcel Numbers",field:"parcel_numbers",type:"text",col:2},
        {lbl:"Flood Zone",field:"flood_zone",type:"select",opts:["","Zone X (minimal)","Zone AE","Zone A","Zone VE","Zone V","Unknown"]},
        {lbl:"Seismic Zone",field:"seismic_zone",type:"select",opts:["","Zone 0","Zone 1","Zone 2A","Zone 2B","Zone 3","Zone 4"]},
      ]},
      {icon:"üó∫Ô∏è",title:"Zoning & Land",fields:[
        {lbl:"Zoning Classification",field:"zoning_class",type:"text"},
        {lbl:"CUP Status",field:"cup_status",type:"select",opts:["","Approved","Pending","Not Required","Denied"]},
        {lbl:"Setback Requirements (ft)",field:"setback_ft",type:"number"},
        {lbl:"Total Site Acreage",field:"site_acres",type:"number"},
        {lbl:"Buildable Acreage",field:"buildable_acres",type:"number"},
        {lbl:"Land Ownership",field:"land_ownership",type:"select",opts:["","Fee Simple","Lease","Mixed","Option"]},
        {lbl:"Lease Term (years)",field:"lease_term_yrs",type:"number"},
        {lbl:"Lease Escalator (%/yr)",field:"lease_esc_pct",type:"number"},
        {lbl:"Decommissioning Bond ($)",field:"decomm_bond",type:"number"},
      ]},
      {icon:"üåø",title:"Environmental",fields:[
        {lbl:"Phase I ESA Status",field:"esa_status",type:"select",opts:["","Complete ‚Äì Clean","Complete ‚Äì REC Identified","In Progress","Not Started"]},
        {lbl:"Wetlands Acreage",field:"wetlands_acres",type:"number"},
        {lbl:"Endangered Species Impact",field:"esa_species",type:"toggle"},
        {lbl:"Mitigation Cost ($)",field:"mitigation_cost",type:"number"},
        {lbl:"Cultural Resource Constraints",field:"cultural_constraints",type:"toggle"},
        {lbl:"SWPPP Required",field:"swppp_req",type:"toggle"},
        {lbl:"NEPA Required",field:"nepa_req",type:"toggle"},
      ]},
    ]
  },
  {
    key:"score_construct",label:"Construction",icon:"üèóÔ∏è",
    sections:[
      {icon:"üìÖ",title:"Overall Schedule",fields:[
        {lbl:"NTP Date",field:"ntp_date",type:"date"},
        {lbl:"Construction Start",field:"construction_start",type:"date"},
        {lbl:"Mechanical Completion",field:"mech_complete_date",type:"date"},
        {lbl:"PAC Date",field:"pac_date",type:"date"},
        {lbl:"FAC / COD Target",field:"cod_target_date",type:"date"},
        {lbl:"Total Duration (months)",field:"const_duration_mo",type:"number"},
        {lbl:"Weather Contingency (days)",field:"weather_days",type:"number"},
        {lbl:"Float on Critical Path (days)",field:"cp_float_days",type:"number"},
      ]},
      {icon:"üí∞",title:"Budget & Cost",fields:[
        {lbl:"Total EPC Price ($)",field:"epc_price",type:"number"},
        {lbl:"EPC Price ($/Wdc)",field:"epc_per_wdc",type:"number"},
        {lbl:"Owner's Costs ($)",field:"owners_costs",type:"number"},
        {lbl:"Interconnection Cost ($)",field:"intercon_cost",type:"number"},
        {lbl:"Land & Permitting ($)",field:"land_permit_cost",type:"number"},
        {lbl:"Contingency ($)",field:"contingency_usd",type:"number"},
        {lbl:"Contingency (%)",field:"contingency_pct",type:"number"},
        {lbl:"Sales / Use Tax ($)",field:"sales_tax",type:"number"},
      ]},
      {icon:"üë∑",title:"Workforce & Logistics",fields:[
        {lbl:"Peak Manpower (workers)",field:"peak_manpower",type:"number"},
        {lbl:"Total Labour Hours",field:"total_labour_hrs",type:"number"},
        {lbl:"Subcontractors Count",field:"subcontractor_count",type:"number"},
        {lbl:"Module Install Rate (mod/day)",field:"mod_rate_day",type:"number"},
        {lbl:"Pile Drive Rate (piles/day)",field:"pile_rate_day",type:"number"},
        {lbl:"Laydown Area (acres)",field:"laydown_acres",type:"number"},
        {lbl:"Nearest Truck Access (km)",field:"truck_access_km",type:"number"},
        {lbl:"HSE Plan Approved",field:"hse_plan",type:"toggle"},
        {lbl:"QA/QC Plan Approved",field:"qaqc_plan",type:"toggle"},
      ]},
    ]
  },
  {
    key:"score_procurement",label:"Procurement",icon:"üì¶",
    sections:[
      {icon:"üìã",title:"EPC Contract Terms",fields:[
        {lbl:"EPC Contractor",field:"epc_contractor_name",type:"text",col:2},
        {lbl:"Contract Type",field:"epc_contract_type",type:"select",opts:["","Lump-sum Turnkey (LSTK)","EPC with GMP","Cost-plus","Split-contract"]},
        {lbl:"Contract Value ($)",field:"epc_contract_value",type:"number"},
        {lbl:"$/Wdc",field:"epc_usd_wdc",type:"number"},
        {lbl:"Currency",field:"epc_currency",type:"select",opts:["","USD","EUR","GBP","AUD","CAD","Other"]},
        {lbl:"Incoterms",field:"epc_incoterms",type:"select",opts:["","DDP","DAP","FCA","EXW","CIF","FOB"]},
        {lbl:"Governing Law",field:"epc_governing_law",type:"text"},
        {lbl:"Parent Guarantee",field:"epc_parent_guarantee",type:"toggle"},
        {lbl:"Contract Execution Date",field:"epc_exec_date",type:"date"},
      ]},
      {icon:"üí≥",title:"Milestone Payment Schedule",fields:[
        {lbl:"NTP Payment (%)",field:"pmt_ntp_pct",type:"number"},
        {lbl:"Mobilisation (%)",field:"pmt_mob_pct",type:"number"},
        {lbl:"Module Delivery (%)",field:"pmt_mod_delivery_pct",type:"number"},
        {lbl:"Mechanical Complete (%)",field:"pmt_mech_comp_pct",type:"number"},
        {lbl:"PAC (%)",field:"pmt_pac_pct",type:"number"},
        {lbl:"FAC / Final (%)",field:"pmt_fac_pct",type:"number"},
        {lbl:"Retention Amount (%)",field:"pmt_retention_pct",type:"number"},
        {lbl:"Retention Release",field:"pmt_retention_release",type:"select",opts:["","At FAC","12 months post-FAC","Split PAC/FAC"]},
      ]},
      {icon:"‚ö†Ô∏è",title:"Liquidated Damages & Bonds",fields:[
        {lbl:"Performance LD ($/day)",field:"ld_perf_day",type:"number"},
        {lbl:"Delay LD ($/day)",field:"ld_delay_day",type:"number"},
        {lbl:"Performance LD Cap (%)",field:"ld_perf_cap_pct",type:"number"},
        {lbl:"Delay LD Cap (%)",field:"ld_delay_cap_pct",type:"number"},
        {lbl:"Performance Bond (%)",field:"perf_bond_pct",type:"number"},
        {lbl:"Payment Bond (%)",field:"pay_bond_pct",type:"number"},
      ]},
      {icon:"üîã",title:"Module Supply Agreement",fields:[
        {lbl:"Module Supplier",field:"mod_supplier_name",type:"text",col:2},
        {lbl:"Contract Value ($)",field:"mod_contract_value",type:"number"},
        {lbl:"Incoterms",field:"mod_incoterms",type:"select",opts:["","DDP","DAP","FCA","EXW","CIF","FOB"]},
        {lbl:"Price Validity Date",field:"mod_price_validity",type:"date"},
        {lbl:"Delivery LD ($/day)",field:"mod_del_ld_day",type:"number"},
        {lbl:"Insolvency Guarantee",field:"mod_insolvency_guar",type:"toggle"},
        {lbl:"Domestic Content Cert",field:"mod_dom_content_cert",type:"toggle"},
      ]},
      {icon:"‚ö°",title:"Major Equipment Agreements",fields:[
        {lbl:"Inverter Supplier",field:"inv_supplier_name",type:"text"},
        {lbl:"Inverter Agreement Date",field:"inv_agr_date",type:"date"},
        {lbl:"Tracker Supplier",field:"tracker_supplier_name",type:"text"},
        {lbl:"Tracker Agreement Date",field:"tracker_agr_date",type:"date"},
        {lbl:"BESS Supplier",field:"bess_supplier_name",type:"text"},
        {lbl:"BESS Agreement Date",field:"bess_agr_date",type:"date"},
        {lbl:"Transformer Lead Time (wks)",field:"xfmr_lead_wks",type:"number"},
        {lbl:"Spare Parts Budget ($)",field:"spare_parts_budget",type:"number"},
      ]},
    ]
  },
  {
    key:"score_contract",label:"Legal",icon:"‚öñÔ∏è",
    sections:[
      {icon:"üìë",title:"PPA / Offtake",fields:[
        {lbl:"Offtaker Name",field:"offtaker_name",type:"text",col:2},
        {lbl:"Offtaker Credit Rating",field:"offtaker_rating",type:"select",opts:["","AAA","AA+","AA","AA-","A+","A","A-","BBB+","BBB","BBB-","Below Investment Grade","Not Rated"]},
        {lbl:"PPA Term (years)",field:"ppa_term_yrs",type:"number"},
        {lbl:"Fixed Price ($/MWh)",field:"ppa_price",type:"number"},
        {lbl:"Price Escalator (%/yr)",field:"ppa_escalator_pct",type:"number"},
        {lbl:"PPA Start Date",field:"ppa_start_date",type:"date"},
        {lbl:"Merchant Tail (years)",field:"merchant_tail_yrs",type:"number"},
        {lbl:"Curtailment Compensation",field:"curtail_comp",type:"toggle"},
      ]},
      {icon:"üèõÔ∏è",title:"Tax & Incentives",fields:[
        {lbl:"ITC or PTC Election",field:"itc_ptc",type:"select",opts:["","ITC (30%)","PTC","Not Determined"]},
        {lbl:"ITC Percentage (%)",field:"itc_pct",type:"number"},
        {lbl:"Domestic Content Bonus",field:"dom_content_bonus",type:"toggle"},
        {lbl:"Energy Community Bonus",field:"energy_comm_bonus",type:"toggle"},
        {lbl:"Prevailing Wage Compliance",field:"prev_wage",type:"toggle"},
        {lbl:"State Incentives ($)",field:"state_incentives",type:"number"},
        {lbl:"Property Tax Abatement",field:"prop_tax_abate",type:"toggle"},
      ]},
      {icon:"üõ°Ô∏è",title:"Insurance",fields:[
        {lbl:"Builder's Risk Limit ($)",field:"builders_risk_limit",type:"number"},
        {lbl:"O&M Coverage Limit ($)",field:"om_coverage_limit",type:"number"},
        {lbl:"Business Interruption (months)",field:"bi_months",type:"number"},
      ]},
    ]
  },
  {
    key:"score_intercon",label:"Grid Connection",icon:"‚ö°",
    sections:[
      {icon:"üîå",title:"Interconnection",fields:[
        {lbl:"Queue Position",field:"queue_position",type:"text"},
        {lbl:"POI Substation Name",field:"poi_substation",type:"text"},
        {lbl:"Interconnection Voltage (kV)",field:"intercon_kv",type:"number"},
        {lbl:"Network Upgrade Cost ($)",field:"network_upgrade_cost",type:"number"},
        {lbl:"Upgrade Scope Description",field:"upgrade_scope",type:"text",col:2},
        {lbl:"Milestone Security Posted ($)",field:"milestone_security",type:"number"},
        {lbl:"IA Execution Date",field:"ia_exec_date",type:"date"},
        {lbl:"Expected Upgrade Completion",field:"upgrade_complete_date",type:"date"},
      ]},
      {icon:"üìä",title:"Market & Deliverability",fields:[
        {lbl:"Capacity Accreditation (%)",field:"cap_accredit_pct",type:"number"},
        {lbl:"ELCC Methodology",field:"elcc_method",type:"text"},
        {lbl:"Congestion Risk Score (1‚Äì10)",field:"congestion_score",type:"number"},
        {lbl:"Deliverability Status",field:"deliverability",type:"select",opts:["","Full Capacity Deliverability","Partial Capacity Deliverability","Energy-Only","Unknown"]},
      ]},
    ]
  },
  {
    key:"score_financial",label:"Finance",icon:"üíµ",
    sections:[
      {icon:"üíµ",title:"Capital Stack",fields:[
        {lbl:"Total Capex ($)",field:"total_capex",type:"number"},
        {lbl:"Debt Amount ($)",field:"debt_amount",type:"number"},
        {lbl:"Debt Tenor (years)",field:"debt_tenor_yrs",type:"number"},
        {lbl:"Interest Rate (%)",field:"interest_rate_pct",type:"number"},
        {lbl:"Sculpted DSCR",field:"sculpted_dscr",type:"number"},
        {lbl:"Minimum DSCR",field:"min_dscr",type:"number"},
        {lbl:"Tax Equity Amount ($)",field:"tax_equity_amt",type:"number"},
        {lbl:"Target Flip Year",field:"flip_year",type:"number"},
        {lbl:"Sponsor Equity ($)",field:"sponsor_equity",type:"number"},
      ]},
      {icon:"üìà",title:"Financial Metrics",fields:[
        {lbl:"Levered IRR (%)",field:"levered_irr_pct",type:"number"},
        {lbl:"Unlevered IRR (%)",field:"unlevered_irr_pct",type:"number"},
        {lbl:"NPV ($)",field:"npv",type:"number"},
        {lbl:"LCOE ($/MWh)",field:"lcoe",type:"number"},
        {lbl:"Breakeven PPA Price ($/MWh)",field:"breakeven_ppa",type:"number"},
        {lbl:"P50 DSCR",field:"p50_dscr",type:"number"},
        {lbl:"P90 DSCR",field:"p90_dscr",type:"number"},
      ]},
    ]
  },
];

/* BOOT */
(function init(){
  var p = new URLSearchParams(window.location.search);
  token = p.get('token');
  if(!token){ showError('No Token','This link is missing a share token. Please request a new one.'); return; }
  loadToken();
})();

function loadToken(){
  sb.from('share_tokens').select('*').eq('token',token).single().then(function(r){
    if(r.error){
      showError('Invalid Link','This share link is invalid or has expired. Please request a new link from the project owner.');
      return;
    }
    var row=r.data;
    if(row.expires_at && new Date(row.expires_at)<new Date()){
      showError('Link Expired','This share link expired on '+new Date(row.expires_at).toLocaleDateString()+'. Please request a new one.');
      return;
    }
    projectId=row.project_id;
    categoryKey=row.category;
    catDef=CATEGORIES.find(function(c){return c.key===categoryKey;});
    if(!catDef){
      showError('No Form Available','This category uses a specialised form not available via share link. Please contact the project team.');
      return;
    }
    loadProject();
  });
}

function loadProject(){
  sb.from('projects').select('id,name,capacity_mw,stage,tally_fields').eq('id',projectId).single().then(function(r){
    if(r.error||!r.data){ showError('Project Not Found','The project could not be found.'); return; }
    var proj=r.data;
    tallyFields=proj.tally_fields||{};
    localFields=Object.assign({},tallyFields);
    renderPage(proj);
  });
}

function renderPage(proj){
  document.getElementById('tb-badge').textContent=catDef.icon+' '+catDef.label;
  document.getElementById('hdr-icon').textContent=catDef.icon;
  document.getElementById('hdr-proj-name').textContent=proj.name||'Untitled Project';
  document.getElementById('hdr-proj-meta').textContent=
    (proj.capacity_mw?proj.capacity_mw+' MWp':'')+
    (proj.stage?' ¬∑ '+proj.stage:'');
  document.getElementById('hdr-cat-badge').textContent=catDef.label;
  document.getElementById('save-cat-lbl').textContent=catDef.label;

  var container=document.getElementById('form-sections');
  container.innerHTML='';
  catDef.sections.forEach(function(sec,si){
    var filled=countFilled(sec.fields);
    var total=sec.fields.length;
    var card=document.createElement('div');
    card.className='section-card';
    card.innerHTML=
      '<div class="sec-hdr" onclick="toggleSec('+si+')">' +
        '<span class="sec-ico">'+sec.icon+'</span>' +
        '<span class="sec-title">'+escHtml(sec.title)+'</span>' +
        '<span class="sec-count" id="sc-'+si+'">'+filled+'/'+total+'</span>' +
        '<span class="sec-chev'+(si===0?' open':'')+'" id="chev-'+si+'">‚ñº</span>' +
      '</div>' +
      '<div class="sec-body'+(si===0?' open':'')+'" id="sb-'+si+'">'+
        buildGrid(sec.fields)+
      '</div>';
    container.appendChild(card);
  });
  updateProgress();
  document.getElementById('state-loading').classList.remove('active');
  document.getElementById('main-screen').classList.add('active');
  document.getElementById('save-bar').style.display='flex';
}

function buildGrid(fields){
  var h='<div class="field-grid">';
  fields.forEach(function(f){
    var id='f_'+f.field;
    var val=localFields[f.field];
    var cls='fw'+(f.col===2?' col2':'');
    h+='<div class="'+cls+'">';
    h+='<label class="flbl" for="'+id+'">'+escHtml(f.lbl)+'</label>';
    if(f.type==='toggle'){
      var on=(val===true||val==='true'||val===1);
      h+='<div class="tog-wrap">'+
        '<div class="tog-track'+(on?' on':'')+'" id="'+id+'" onclick="togField(\''+f.field+'\',\''+id+'\')">'+
          '<div class="tog-knob"></div>'+
        '</div>'+
        '<span class="tog-lbl" id="'+id+'_l">'+(on?'Yes':'No')+'</span>'+
      '</div>';
    } else if(f.type==='select'){
      h+='<select class="fselect" id="'+id+'" onchange="fChanged(\''+f.field+'\',this.value)">';
      (f.opts||[]).forEach(function(o){
        h+='<option value="'+escHtml(o)+'"'+(String(val||'')===o?' selected':'')+'>'+escHtml(o||'‚Äî Select ‚Äî')+'</option>';
      });
      h+='</select>';
    } else {
      var t=f.type==='date'?'date':f.type==='number'?'number':'text';
      h+='<input class="finput" type="'+t+'" id="'+id+'" '+
        'value="'+escHtml(String(val!=null&&val!==''?val:''))+'" '+
        'placeholder="'+escHtml(f.lbl)+'" '+
        'oninput="fChanged(\''+f.field+'\',this.value)"/>';
    }
    h+='</div>';
  });
  return h+'</div>';
}

function toggleSec(si){
  document.getElementById('sb-'+si).classList.toggle('open');
  document.getElementById('chev-'+si).classList.toggle('open');
}

function fChanged(k,v){ localFields[k]=v; updateProgress(); updateCounts(); }

function togField(k,id){
  var t=document.getElementById(id);
  var l=document.getElementById(id+'_l');
  var on=!t.classList.contains('on');
  t.classList.toggle('on',on);
  if(l) l.textContent=on?'Yes':'No';
  localFields[k]=on;
  updateProgress(); updateCounts();
}

function countFilled(fields){
  return fields.filter(function(f){
    var v=localFields[f.field];
    return v!==undefined&&v!==null&&v!==''&&v!==false&&v!=='false';
  }).length;
}

function updateProgress(){
  var tot=0,fil=0;
  catDef.sections.forEach(function(s){tot+=s.fields.length;fil+=countFilled(s.fields);});
  var pct=tot>0?Math.round(fil/tot*100):0;
  document.getElementById('prog-fill').style.width=pct+'%';
  document.getElementById('prog-pct').textContent=pct+'%';
}

function updateCounts(){
  catDef.sections.forEach(function(s,si){
    var el=document.getElementById('sc-'+si);
    if(el) el.textContent=countFilled(s.fields)+'/'+s.fields.length;
  });
}

function saveData(){
  var btn=document.getElementById('btn-save');
  var msg=document.getElementById('save-msg');
  btn.disabled=true; btn.textContent='Saving‚Ä¶';
  msg.className='save-msg'; msg.textContent='';
  var updated=Object.assign({},tallyFields,localFields);
  sb.from('projects').update({tally_fields:updated,updated_at:new Date().toISOString()}).eq('id',projectId).then(function(r){
    btn.disabled=false; btn.textContent='Save Data';
    if(r.error){
      msg.className='save-msg err show'; msg.textContent='Save failed ‚Äî try again.';
      setTimeout(function(){msg.classList.remove('show');},3500);
    } else {
      tallyFields=updated;
      msg.className='save-msg show'; msg.textContent='Saved ‚úì';
      setTimeout(function(){msg.classList.remove('show');},2500);
      document.getElementById('done-banner').classList.add('show');
    }
  });
}

function showError(t,s){
  document.getElementById('state-loading').classList.remove('active');
  document.getElementById('err-title').textContent=t;
  document.getElementById('err-sub').textContent=s;
  document.getElementById('state-error').classList.add('active');
}

function escHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
