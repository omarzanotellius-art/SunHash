<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash - Project Overview</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #eef0f4; color: #1a1f2e; min-height: 100vh; }
body.hidden { visibility: hidden; }
a { text-decoration: none; }
.topbar { position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; background: #111; border-bottom: 3px solid #FFFF00; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
.logo { font-size: 22px; font-weight: 900; letter-spacing: 0.3px; text-transform: uppercase; color: #fff; }
.logo span { color: #FFFF00; }
.tb-right { display: flex; align-items: center; gap: 10px; }
.btn-back { padding: 7px 16px; border: none; background: rgba(255,255,255,0.1); color: #aaa; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; text-transform: uppercase; border-radius: 20px; cursor: pointer; }
.btn-back:hover { background: rgba(255,255,255,0.2); color: #fff; }
.btn-out { background: none; border: 1px solid #444; color: #777; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; padding: 7px 14px; cursor: pointer; text-transform: uppercase; border-radius: 20px; }
.btn-out:hover { border-color: #E83535; color: #E83535; }
.page { padding-top: 56px; }
.hero { background: #111; padding: 20px 14px 18px; }
.hero-tag { font-size: 10px; font-weight: 700; letter-spacing: 0.6px; text-transform: uppercase; color: #FFFF00; margin-bottom: 5px; opacity: 0.8; }
.hero h1 { font-size: 28px; font-weight: 900; letter-spacing: -0.8px; color: #fff; line-height: 1; }
.hero-sub { font-size: 12px; color: #555; margin-top: 5px; }

/* 3-column layout */
.layout { display: grid; grid-template-columns: 210px 1fr 210px; gap: 10px; padding: 12px 12px 60px; align-items: start; }

/* LEFT COLUMN */
.left-col { display: flex; flex-direction: column; gap: 8px; }
.score-card { background: #1a1f2e; border-radius: 12px; padding: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); text-align: center; }
.score-card-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #FFFF00; opacity: 0.7; margin-bottom: 8px; }
.score-ring { width: 72px; height: 72px; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.06); border: 3px solid rgba(255,255,255,0.08); transition: border-color .4s; }
.score-ring-val { font-size: 26px; font-weight: 900; color: #fff; letter-spacing: -1px; line-height: 1; }
.score-ring-sub { font-size: 9px; color: #555; margin-top: 1px; }
.score-ring-none { font-size: 11px; color: #444; font-weight: 600; }
.score-card-desc { font-size: 10px; color: #444; line-height: 1.5; }
.cat-item { background: #dde1ea; border-radius: 10px; padding: 9px 11px; box-shadow: 0 1px 5px rgba(0,0,0,0.06); transition: transform .12s, box-shadow .12s; }
.cat-item:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
.cat-item.active { box-shadow: 0 0 0 2px #1a1f2e; }
.cat-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.cat-name { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.3px; color: #1a1f2e; }
.cat-score-lbl { font-size: 9px; font-weight: 700; color: #6b7585; }
.cat-bar-track { height: 3px; background: rgba(0,0,0,0.1); border-radius: 2px; overflow: hidden; margin-bottom: 7px; }
.cat-bar-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }
.cat-btn-row { display: grid; gap: 5px; }
.cat-btn-row.two { grid-template-columns: 1fr 1fr; }
.cat-start-btn { display: block; width: 100%; padding: 4px 6px; background: rgba(255,255,255,0.55); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #1a1f2e; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.cat-start-btn:hover { background: #1a1f2e; color: #FFFF00; }
.cat-view-btn { display: block; width: 100%; padding: 4px 6px; background: #1a1f2e; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #FFFF00; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.cat-view-btn:hover { background: #FFFF00; color: #1a1f2e; }

/* CENTRE COLUMN */
.main { display: flex; flex-direction: column; gap: 10px; min-width: 0; }

/* Overview cards */
.ov-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.ov-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.ov-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.ov-card-body { padding: 10px 14px; }
.info-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 7px; }
.info-row { background: rgba(255,255,255,0.5); border-radius: 7px; padding: 7px 9px; }
.info-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #6b7585; margin-bottom: 3px; letter-spacing: 0.3px; }
.info-val { font-size: 11px; font-weight: 700; color: #1a1f2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.info-val a { color: #1a1f2e; text-decoration: underline; }
.ai-card { background: #1a1f2e; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 14px rgba(0,0,0,0.12); }
.ai-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: space-between; }
.ai-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: #FFFF00; opacity: 0.8; }
.ai-model { font-size: 9px; color: #444; }
.ai-card-body { padding: 14px; }
.ai-text { font-size: 12px; color: #bbb; line-height: 1.75; }
.ai-text p { margin-bottom: 10px; }
.ai-text p:last-child { margin-bottom: 0; }
.ai-loading { display: flex; align-items: center; gap: 8px; color: #555; font-size: 12px; }
.ai-dot { width: 5px; height: 5px; border-radius: 50%; background: #FFFF00; animation: pulse 1.2s ease-in-out infinite; }
.ai-dot:nth-child(2) { animation-delay: 0.2s; }
.ai-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes pulse { 0%,80%,100%{ opacity:0.2; transform:scale(0.8); } 40%{ opacity:1; transform:scale(1.1); } }
.ai-error { font-size: 12px; color: #e74c3c; }
.btn-regen { padding: 3px 10px; border: 1px solid #333; background: none; color: #555; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 600; cursor: pointer; border-radius: 20px; }
.btn-regen:hover { border-color: #FFFF00; color: #FFFF00; }
.coming-soon { background: #dde1ea; border-radius: 12px; padding: 22px 18px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.coming-soon h2 { font-size: 17px; font-weight: 900; letter-spacing: -0.3px; margin-bottom: 5px; }
.coming-soon p { font-size: 12px; color: #6b7585; line-height: 1.6; max-width: 360px; margin: 0 auto 14px; }
.btn-big { display: inline-block; padding: 9px 20px; background: #1a1f2e; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; cursor: pointer; border-radius: 30px; border: none; }
.btn-big:hover { background: #FFFF00; color: #1a1f2e; }

/* CATEGORY DETAIL PANEL (replaces centre content) */
.cat-panel { display: none; flex-direction: column; gap: 10px; min-width: 0; }
.cat-panel.open { display: flex; }

/* Panel header */
.cp-header { background: #1a1f2e; border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; }
.cp-header-left { display: flex; align-items: center; gap: 12px; }
.cp-back { background: rgba(255,255,255,0.1); border: none; color: #aaa; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; padding: 5px 12px; border-radius: 20px; cursor: pointer; transition: all .12s; }
.cp-back:hover { background: rgba(255,255,255,0.2); color: #fff; }
.cp-title { font-size: 16px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.3px; color: #fff; }
.cp-header-right { display: flex; align-items: center; gap: 8px; }

/* Score band inside panel */
.cp-score-band { background: #dde1ea; border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; gap: 16px; }
.cp-score-circle { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 3px solid rgba(0,0,0,0.1); }
.cp-score-num { font-size: 22px; font-weight: 900; line-height: 1; }
.cp-score-info { flex: 1; }
.cp-score-label { font-size: 9px; font-weight: 700; color: #6b7585; text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 3px; }
.cp-score-desc { font-size: 11px; color: #1a1f2e; font-weight: 600; margin-bottom: 6px; }
.cp-bar-track { height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; overflow: hidden; }
.cp-bar-fill { height: 100%; border-radius: 2px; transition: width .6s; }

/* Editable fields card */
.cp-fields-card { background: #dde1ea; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.cp-fields-hdr { padding: 10px 16px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; justify-content: space-between; }
.cp-fields-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.cp-fields-body { padding: 12px 16px; display: flex; flex-direction: column; gap: 8px; }
.cp-field { display: flex; flex-direction: column; gap: 4px; }
.cp-field-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #6b7585; letter-spacing: 0.3px; }
.cp-field-input { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #1a1f2e; outline: none; transition: border-color .12s, background .12s; }
.cp-field-input:focus { background: #fff; border-color: #1a1f2e; }
.cp-save-row { padding: 12px 16px; border-top: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; gap: 10px; }
.cp-save-btn { padding: 9px 22px; background: #1a1f2e; border: none; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; cursor: pointer; border-radius: 20px; transition: all .12s; }
.cp-save-btn:hover { background: #FFFF00; color: #1a1f2e; }
.cp-save-msg { font-size: 11px; color: #2e7d4f; font-weight: 600; opacity: 0; transition: opacity .3s; }
.cp-save-msg.show { opacity: 1; }
.cp-retake-btn { padding: 9px 16px; background: rgba(0,0,0,0.06); border: none; color: #6b7585; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; margin-left: auto; }
.cp-retake-btn:hover { background: rgba(0,0,0,0.12); color: #1a1f2e; }

/* Missing fields */
.cp-missing-card { background: #dde1ea; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.cp-missing-hdr { padding: 10px 16px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.cp-missing-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.cp-missing-body { padding: 12px 16px; display: flex; flex-direction: column; gap: 0; }
.cp-missing-item { display: flex; align-items: flex-start; gap: 8px; padding: 7px 0; border-bottom: 1px solid rgba(0,0,0,0.06); }
.cp-missing-item:last-child { border-bottom: none; }
.cp-missing-dot { width: 6px; height: 6px; border-radius: 50%; background: #e07b20; flex-shrink: 0; margin-top: 4px; }
.cp-missing-text { font-size: 11px; color: #1a1f2e; line-height: 1.5; }
.cp-missing-impact { font-size: 10px; color: #6b7585; margin-top: 1px; }

/* Share button */
.cp-share-btn { padding: 5px 14px; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); color: #ccc; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.cp-share-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }

/* ---- CAT PANEL TAB BAR ---- */
.cp-tabs { display: flex; gap: 2px; background: rgba(0,0,0,0.08); border-radius: 10px; padding: 3px; }
.cp-tab { flex: 1; padding: 7px 10px; background: none; border: none; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #8a95a5; cursor: pointer; border-radius: 8px; transition: all .15s; text-align: center; }
.cp-tab.active { background: #fff; color: #1a1f2e; box-shadow: 0 1px 4px rgba(0,0,0,0.12); }
.cp-tab-pane { display: none; flex-direction: column; gap: 10px; }
.cp-tab-pane.active { display: flex; }

/* ---- SPEC FORM ---- */
.spec-card { background: #dde1ea; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.spec-section-hdr { padding: 9px 16px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; transition: background .12s; }
.spec-section-hdr:hover { background: rgba(255,255,255,0.35); }
.spec-section-icon { font-size: 13px; flex-shrink: 0; }
.spec-section-title { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.4px; color: #1a1f2e; flex: 1; }
.spec-section-filled { font-size: 9px; color: #8a95a5; }
.spec-section-chev { font-size: 10px; color: #8a95a5; transition: transform .2s; }
.spec-section-chev.open { transform: rotate(180deg); }
.spec-section-body { display: none; padding: 14px 16px; display: none; }
.spec-section-body.open { display: block; }
.spec-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.spec-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.spec-grid-1 { display: grid; grid-template-columns: 1fr; gap: 10px; }
.spec-field { display: flex; flex-direction: column; gap: 4px; }
.spec-field.full { grid-column: 1 / -1; }
.spec-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #6b7585; }
.spec-lbl .req { color: #c0392b; margin-left: 2px; }
.spec-input { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 11px; color: #1a1f2e; outline: none; transition: border-color .12s, background .12s; }
.spec-input:focus { background: #fff; border-color: #1a1f2e; }
.spec-input[type=number] { -moz-appearance: textfield; }
.spec-input[type=number]::-webkit-outer-spin-button,
.spec-input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }
.spec-select { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 11px; color: #1a1f2e; outline: none; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236b7585'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; }
.spec-toggle-row { display: flex; align-items: center; gap: 8px; padding: 7px 0; }
.spec-toggle { position: relative; width: 34px; height: 18px; flex-shrink: 0; }
.spec-toggle input { opacity: 0; width: 0; height: 0; }
.spec-toggle-slider { position: absolute; inset: 0; background: rgba(0,0,0,0.12); border-radius: 9px; cursor: pointer; transition: background .2s; }
.spec-toggle-slider:before { content:''; position:absolute; height:12px; width:12px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition: transform .2s; }
.spec-toggle input:checked + .spec-toggle-slider { background: #2e7d4f; }
.spec-toggle input:checked + .spec-toggle-slider:before { transform: translateX(16px); }
.spec-toggle-lbl { font-size: 11px; color: #1a1f2e; }
.spec-hint { font-size: 9px; color: #8a95a5; margin-top: 2px; line-height: 1.4; }
.spec-save-row { padding: 12px 16px; border-top: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.3); }
.spec-save-btn { padding: 9px 24px; background: #1a1f2e; border: none; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.spec-save-btn:hover { background: #FFFF00; color: #1a1f2e; }
.spec-save-msg { font-size: 11px; color: #2e7d4f; font-weight: 600; opacity: 0; transition: opacity .3s; }
.spec-save-msg.show { opacity: 1; }
.spec-assess-btn { padding: 9px 20px; background: rgba(46,125,79,0.14); border: 1px solid rgba(46,125,79,0.3); color: #2e7d4f; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; margin-left: auto; }
.spec-assess-btn:hover { background: #2e7d4f; color: #fff; border-color: #2e7d4f; }

/* Completeness strip at top of spec tab */
.spec-completeness { background: #dde1ea; border-radius: 12px; padding: 12px 16px; display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.spec-comp-bar-wrap { flex: 1; }
.spec-comp-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #6b7585; margin-bottom: 5px; }
.spec-comp-track { height: 5px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden; }
.spec-comp-fill { height: 100%; border-radius: 3px; background: #2e7d4f; transition: width .5s; }
.spec-comp-pct { font-size: 14px; font-weight: 900; color: #1a1f2e; flex-shrink: 0; }
.spec-comp-hint { font-size: 10px; color: #8a95a5; }
.share-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; display: none; align-items: center; justify-content: center; }
.share-modal-overlay.open { display: flex; }
.share-modal { background: #eef0f4; border-radius: 14px; padding: 24px; width: 420px; max-width: 92vw; box-shadow: 0 8px 40px rgba(0,0,0,0.2); }
.share-modal h3 { font-size: 14px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 6px; }
.share-modal p { font-size: 12px; color: #6b7585; line-height: 1.6; margin-bottom: 16px; }
.share-url-box { background: #fff; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; padding: 10px 12px; font-size: 11px; color: #1a1f2e; word-break: break-all; margin-bottom: 12px; line-height: 1.6; }
.share-modal-btns { display: flex; gap: 8px; justify-content: flex-end; }
.share-copy-btn { padding: 8px 18px; background: #1a1f2e; border: none; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; }
.share-copy-btn:hover { background: #FFFF00; color: #1a1f2e; }
.share-close-btn { padding: 8px 16px; background: rgba(0,0,0,0.07); border: none; color: #6b7585; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 20px; }

/* AI Q&A card */
.cp-ai-card { background: #1a1f2e; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 14px rgba(0,0,0,0.12); }
.cp-ai-hdr { padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; gap: 8px; }
.cp-ai-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: #FFFF00; opacity: 0.8; }
.cp-ai-model { font-size: 9px; color: #444; margin-left: auto; }
.cp-ai-body { padding: 14px; display: flex; flex-direction: column; gap: 10px; }
.cp-ai-history { display: flex; flex-direction: column; gap: 8px; max-height: 220px; overflow-y: auto; }
.cp-ai-msg { font-size: 12px; line-height: 1.65; border-radius: 8px; padding: 8px 11px; }
.cp-ai-msg.user { background: rgba(255,255,255,0.07); color: #ccc; align-self: flex-end; max-width: 85%; }
.cp-ai-msg.assistant { background: rgba(255,255,0,0.06); color: #bbb; align-self: flex-start; max-width: 95%; }
.cp-ai-input-row { display: flex; gap: 7px; }
.cp-ai-input { flex: 1; padding: 8px 12px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 12px; color: #fff; outline: none; }
.cp-ai-input::placeholder { color: #444; }
.cp-ai-input:focus { border-color: rgba(255,255,0,0.3); background: rgba(255,255,255,0.09); }
.cp-ai-send { padding: 8px 16px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 20px; transition: all .12s; flex-shrink: 0; }
.cp-ai-send:hover { background: #fff; }
.cp-ai-send:disabled { opacity: 0.4; cursor: default; }

/* RIGHT COLUMN */
.right-col { display: flex; flex-direction: column; gap: 8px; }
.lock-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.lock-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; justify-content: space-between; }
.lock-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.lock-icon { font-size: 13px; opacity: 0.35; }
.lock-card-body { padding: 20px 14px; }
.lock-overlay { display: flex; flex-direction: column; align-items: center; text-align: center; gap: 10px; }
.lock-svg { width: 28px; height: 28px; opacity: 0.2; }
.lock-msg { font-size: 11px; color: #6b7585; line-height: 1.5; max-width: 160px; }
.lock-req { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #aaa; background: rgba(0,0,0,0.07); padding: 3px 9px; border-radius: 20px; }

/* Tally overlay */
#ov-tally-overlay { display:none; position:fixed; inset:0; z-index:300; background:rgba(0,0,0,0.85); flex-direction:column; }


/* Timeline date inputs */
.tl-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
.tl-date-input { border: none; background: rgba(0,0,0,0.06); border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 10px; color: #6b7585; padding: 3px 6px; cursor: pointer; outline: none; width: 110px; }
.tl-date-input:focus { background: rgba(0,0,0,0.1); color: #1a1f2e; }
.tl-date-input::-webkit-calendar-picker-indicator { opacity: 0.4; cursor: pointer; }

/* Procurement grey (same as cat-item) */
.proc-item { background: #dde1ea; border-radius: 10px; padding: 9px 11px; box-shadow: 0 1px 5px rgba(0,0,0,0.06); transition: transform .12s, box-shadow .12s; }
.proc-item:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
.proc-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.proc-name { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.3px; color: #1a1f2e; }
.proc-start-btn { display: block; width: 100%; padding: 4px 6px; background: rgba(255,255,255,0.55); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #1a1f2e; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.proc-start-btn:hover { background: #1a1f2e; color: #FFFF00; }

/* Completeness dot on cat buttons */
.cat-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; margin-left: 5px; flex-shrink: 0; }

/* Timeline card */
.timeline-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.timeline-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.timeline-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.timeline-body { padding: 14px 16px; display: flex; flex-direction: column; gap: 0; }
.tl-step { display: flex; align-items: flex-start; gap: 12px; position: relative; }
.tl-step:not(:last-child)::after { content: ''; position: absolute; left: 7px; top: 18px; width: 2px; bottom: -14px; background: rgba(0,0,0,0.12); }
.tl-dot-wrap { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; padding-top: 2px; }
.tl-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.15); flex-shrink: 0; z-index: 1; }
.tl-dot.green  { background: #2e7d4f; border-color: #2e7d4f; }
.tl-dot.yellow { background: #e07b20; border-color: #e07b20; }
.tl-dot.red    { background: #c0392b; border-color: #c0392b; }
.tl-dot.grey   { background: #b0b8c8; border-color: #b0b8c8; }
.tl-info { flex: 1; padding-bottom: 14px; }
.tl-label { font-size: 11px; font-weight: 700; color: #1a1f2e; }
.tl-status { font-size: 10px; color: #6b7585; margin-top: 2px; }


/* Split centre: brief (2/3) + timeline (1/3) */
.centre-split { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: start; }
.centre-main { display: flex; flex-direction: column; gap: 10px; min-width: 0; }
.centre-timeline { display: flex; flex-direction: column; gap: 8px; }

/* Upload Document card (sits below timeline card in right sidebar of centre-split) */
.upload-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; position: sticky; top: calc(68px + var(--tl-height, 0px) + 8px); }
.upload-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.upload-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.upload-card-body { padding: 10px 14px; display: flex; flex-direction: column; gap: 8px; }
.upload-doc-list { display: flex; flex-direction: column; gap: 4px; }
.upload-doc-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.55); border-radius: 8px; padding: 5px 9px; gap: 6px; }
.upload-doc-name { font-size: 10px; font-weight: 600; color: #1a1f2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90px; }
.upload-doc-type { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #6b7585; background: rgba(0,0,0,0.07); padding: 1px 6px; border-radius: 20px; flex-shrink: 0; }
.upload-doc-view { font-size: 9px; font-weight: 700; color: #1a1f2e; background: none; border: none; cursor: pointer; text-transform: uppercase; padding: 2px 6px; border-radius: 20px; transition: all .12s; flex-shrink: 0; }
.upload-doc-view:hover { background: #1a1f2e; color: #FFFF00; }
.upload-open-btn { display: block; width: 100%; padding: 6px 8px; background: #1a1f2e; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #FFFF00; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.upload-open-btn:hover { background: #FFFF00; color: #1a1f2e; }
.upload-empty { font-size: 10px; color: #8a95a5; text-align: center; padding: 4px 0; }

/* Document panel (replaces centre content just like cat-panel) */
.doc-panel { display: none; flex-direction: column; gap: 10px; min-width: 0; }
.doc-panel.open { display: flex; }
.dp-header { background: #1a1f2e; border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
.dp-back { background: rgba(255,255,255,0.1); border: none; color: #aaa; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; padding: 5px 12px; border-radius: 20px; cursor: pointer; transition: all .12s; }
.dp-back:hover { background: rgba(255,255,255,0.2); color: #fff; }
.dp-title { font-size: 16px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.3px; color: #fff; }
.dp-header-right { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
.dp-overall-badge { font-size: 10px; color: #666; font-weight: 600; }
.dp-overall-badge span { color: #FFFF00; font-size: 12px; font-weight: 800; }
.dp-progress-summary { background: #dde1ea; border-radius: 12px; padding: 14px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.dp-prog-cats { display: grid; grid-template-columns: repeat(7,1fr); gap: 8px; }
.dp-prog-cat { display: flex; flex-direction: column; align-items: center; gap: 5px; }
.dp-prog-cat-name { font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.2px; color: #6b7585; text-align: center; line-height: 1.3; }
.dp-prog-cat-ring { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: #1a1f2e; border: 3px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.6); }
.dp-prog-cat-ring.complete { border-color: #2e7d4f; background: rgba(46,125,79,0.12); color: #2e7d4f; }
.dp-prog-cat-ring.partial  { border-color: #e07b20; background: rgba(224,123,32,0.10); color: #b05a10; }
.dp-prog-cat-ring.empty    { border-color: rgba(0,0,0,0.1); color: #aaa; }
.dp-prog-cat-pct { font-size: 9px; font-weight: 700; color: #6b7585; }
.dd-cat-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.dd-cat-hdr { padding: 12px 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; transition: background .12s; }
.dd-cat-hdr:hover { background: rgba(255,255,255,0.35); }
.dd-cat-num { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; color: #fff; flex-shrink: 0; }
.dd-cat-name { font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.3px; color: #1a1f2e; flex: 1; }
.dd-cat-meta { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.dd-cat-check-pill { font-size: 9px; font-weight: 700; padding: 2px 9px; border-radius: 20px; }
.dd-cat-check-pill.done { background: rgba(46,125,79,0.14); color: #2e7d4f; }
.dd-cat-check-pill.part { background: rgba(224,123,32,0.14); color: #b05a10; }
.dd-cat-check-pill.none { background: rgba(0,0,0,0.07); color: #8a95a5; }
.dd-cat-file-pill { font-size: 9px; font-weight: 700; padding: 2px 9px; border-radius: 20px; background: rgba(26,31,46,0.09); color: #5a6474; }
.dd-cat-chevron { font-size: 10px; color: #8a95a5; transition: transform .2s; flex-shrink: 0; }
.dd-cat-chevron.open { transform: rotate(180deg); }
.dd-cat-body { display: none; border-top: 1px solid rgba(0,0,0,0.07); }
.dd-cat-body.open { display: block; }
.dd-section { padding: 12px 16px 8px; border-bottom: 1px solid rgba(0,0,0,0.06); }
.dd-section-title { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #8a95a5; margin-bottom: 9px; }
.dd-check-item { display: flex; align-items: flex-start; gap: 9px; padding: 5px 0; }
.dd-check-item + .dd-check-item { border-top: 1px solid rgba(0,0,0,0.04); }
.dd-check-cb { width: 15px; height: 15px; accent-color: #2e7d4f; cursor: pointer; flex-shrink: 0; margin-top: 2px; }
.dd-check-lbl { font-size: 11px; color: #1a1f2e; line-height: 1.5; cursor: pointer; }
.dd-check-lbl.done { color: #9aa3b0; text-decoration: line-through; }
.dd-priority-item { display: flex; align-items: center; gap: 10px; padding: 7px 0; }
.dd-priority-item + .dd-priority-item { border-top: 1px solid rgba(0,0,0,0.04); }
.dd-priority-star { font-size: 13px; flex-shrink: 0; }
.dd-priority-name { font-size: 11px; color: #1a1f2e; flex: 1; line-height: 1.4; }
.dd-priority-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 2px 9px; border-radius: 20px; flex-shrink: 0; white-space: nowrap; }
.dd-priority-badge.missing  { background: rgba(224,123,32,0.14); color: #b05a10; }
.dd-priority-badge.uploaded { background: rgba(46,125,79,0.14); color: #2e7d4f; }
.dd-view-link { font-size: 9px; font-weight: 700; color: #1a1f2e; background: rgba(255,255,255,0.7); border: none; border-radius: 20px; padding: 2px 9px; cursor: pointer; flex-shrink: 0; transition: all .12s; }
.dd-view-link:hover { background: #1a1f2e; color: #FFFF00; }
.dd-files-section { padding: 10px 16px 12px; border-bottom: 1px solid rgba(0,0,0,0.06); }
.dd-file-row { display: flex; align-items: center; gap: 9px; padding: 5px 0; }
.dd-file-row + .dd-file-row { border-top: 1px solid rgba(0,0,0,0.04); }
.dd-file-icon { font-size: 14px; flex-shrink: 0; }
.dd-file-info { flex: 1; min-width: 0; }
.dd-file-name { font-size: 11px; font-weight: 600; color: #1a1f2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dd-file-meta { font-size: 9px; color: #8a95a5; margin-top: 1px; }
.dd-file-actions { display: flex; gap: 5px; flex-shrink: 0; }
.dd-file-preview { padding: 3px 10px; background: rgba(255,255,255,0.7); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #1a1f2e; cursor: pointer; transition: all .12s; }
.dd-file-preview:hover { background: #1a1f2e; color: #FFFF00; }
.dd-file-rm { padding: 3px 9px; background: none; border: 1px solid rgba(192,57,43,0.25); border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #c0392b; cursor: pointer; transition: all .12s; }
.dd-file-rm:hover { background: #c0392b; color: #fff; border-color: #c0392b; }
.dd-files-empty { font-size: 10px; color: #a0a8b5; font-style: italic; padding: 2px 0; }
.dd-upload-row { padding: 10px 16px 14px; display: flex; align-items: center; gap: 8px; }
.dd-dropzone { flex: 1; border: 1.5px dashed rgba(0,0,0,0.14); border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: all .15s; background: rgba(255,255,255,0.3); }
.dd-dropzone:hover, .dd-dropzone.drag-over { border-color: #1a1f2e; background: rgba(255,255,255,0.55); }
.dd-dropzone-icon { font-size: 14px; opacity: 0.4; flex-shrink: 0; }
.dd-dropzone-text { font-size: 10px; color: #6b7585; }
.dd-upload-btn { padding: 7px 16px; background: #1a1f2e; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; color: #FFFF00; cursor: pointer; white-space: nowrap; transition: all .12s; flex-shrink: 0; }
.dd-upload-btn:hover { background: #FFFF00; color: #1a1f2e; }
.dd-upload-progress { display: none; padding: 0 16px 10px; align-items: center; gap: 8px; }
.dd-prog-bar { flex: 1; height: 3px; background: rgba(0,0,0,0.1); border-radius: 2px; overflow: hidden; }
.dd-prog-fill { height: 100%; background: #2e7d4f; border-radius: 2px; transition: width .3s; }
.dd-prog-txt { font-size: 10px; color: #6b7585; white-space: nowrap; }
.dd-upload-err { font-size: 10px; color: #c0392b; padding: 0 16px 8px; display: none; }
.dp-preview-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 500; display: none; flex-direction: column; }
.dp-preview-overlay.open { display: flex; }
.dp-preview-topbar { background: #111; padding: 10px 20px; display: flex; align-items: center; gap: 14px; border-bottom: 2px solid #FFFF00; flex-shrink: 0; }
.dp-preview-topbar-name { font-size: 13px; font-weight: 600; color: #fff; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dp-preview-topbar-dl { padding: 6px 18px; background: #FFFF00; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 800; color: #1a1f2e; cursor: pointer; text-transform: uppercase; }
.dp-preview-topbar-dl:hover { background: #fff; }
.dp-preview-topbar-close { padding: 6px 14px; background: rgba(255,255,255,0.08); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; color: #aaa; cursor: pointer; }
.dp-preview-topbar-close:hover { background: rgba(255,255,255,0.18); color: #fff; }
.dp-preview-frame-wrap { flex: 1; overflow: hidden; }
.dp-preview-iframe { width: 100%; height: 100%; border: none; display: block; background: #fff; }
.dp-preview-img-wrap { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px; background: #1a1f2e; }
.dp-preview-img-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 6px; }
.dp-preview-no-preview { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 10px; background: #1a1f2e; }
.dp-preview-no-preview p { font-size: 13px; color: #666; }
.dp-file-input { display: none; }

@media(max-width:900px){
  .layout { grid-template-columns: 1fr; }
  .left-col, .right-col { display: grid; grid-template-columns: repeat(3,1fr); }
  .score-card { grid-column: 1/-1; }
  .info-grid { grid-template-columns: repeat(3,1fr); }
}
</style>
</head>
<body class="hidden">

<!-- Share modal -->
<div class="share-modal-overlay" id="share-modal-overlay">
  <div class="share-modal">
    <h3 id="share-modal-title">Share Category</h3>
    <p>Anyone with this link can view this category's data without logging in. The link expires in 30 days.</p>
    <div class="share-url-box" id="share-url-box">Generating link...</div>
    <div class="share-modal-btns">
      <button class="share-close-btn" onclick="closeShareModal()">Close</button>
      <button class="share-copy-btn" onclick="copyShareLink()">Copy Link</button>
    </div>
  </div>
</div>

<!-- Tally form overlay -->
<div id="ov-tally-overlay">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#111;border-bottom:2px solid #FFFF00;flex-shrink:0;">
    <span style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;color:#FFFF00;" id="ov-tally-title">Assessment</span>
    <button onclick="closeTallyForm()" style="background:rgba(255,255,255,0.1);border:none;color:#aaa;font-size:18px;width:30px;height:30px;border-radius:50%;cursor:pointer;">&#215;</button>
  </div>
  <iframe id="ov-tally-frame" src="" title="Assessment Form" style="flex:1;border:none;width:100%;background:#fff;"></iframe>
</div>

<div class="topbar">
  <a href="dashboard.html" class="logo">Sun<span>Hash</span></a>
  <div class="tb-right">
    <a href="dashboard.html" class="btn-back">Back to Dashboard</a>
    <button class="btn-out" onclick="sb.auth.signOut().then(function(){ window.location.href='login.html'; })">Sign Out</button>
  </div>
</div>

<div class="page">
  <div class="hero">
    <div class="hero-tag">Project Overview</div>
    <h1 id="hero-name">Loading...</h1>
    <div class="hero-sub" id="hero-sub"></div>
  </div>

  <div class="layout">

    <!-- LEFT: score + categories -->
    <div class="left-col">
      <div class="score-card">
        <div class="score-card-lbl">Overall Risk Score</div>
        <div class="score-ring" id="score-ring">
          <div class="score-ring-none">N/A</div>
        </div>
        <div class="score-card-desc" id="score-card-desc">Complete at least one assessment to generate a score.</div>
      </div>
      <div id="sidebar" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>

    <!-- CENTRE: overview OR category panel -->
    <div class="main" id="main-overview">
      <div class="centre-split">
        <div class="centre-main">
        <div class="ov-card" id="info-card" style="display:none;">
        <div class="ov-card-hdr"><span class="ov-card-title">Project Details</span></div>
        <div class="ov-card-body">
          <div class="info-grid">
            <div class="info-row"><div class="info-lbl">Location</div><div class="info-val" id="inf-location">-</div></div>
            <div class="info-row"><div class="info-lbl">Capacity</div><div class="info-val" id="inf-capacity">-</div></div>
            <div class="info-row"><div class="info-lbl">Stage</div><div class="info-val" id="inf-stage">-</div></div>
            <div class="info-row"><div class="info-lbl">Status</div><div class="info-val" id="inf-status">-</div></div>
            <div class="info-row"><div class="info-lbl">Created</div><div class="info-val" id="inf-date">-</div></div>
          </div>
        </div>
      </div>
      <div class="ai-card">
        <div class="ai-card-hdr">
          <span class="ai-label">AI Project Brief</span>
          <div style="display:flex;align-items:center;gap:6px;">
            <span class="ai-model">gpt-4o-mini</span>
            <button class="btn-regen" id="btn-regen" onclick="generateSummary(true)" style="display:none;">Regenerate</button>
          </div>
        </div>
        <div class="ai-card-body">
          <div id="ai-content">
            <div class="ai-loading"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div><span>Loading...</span></div>
          </div>
        </div>
      </div>
        </div><!-- /centre-main -->
        <div class="centre-timeline">
        <!-- Timeline -->
        <div class="timeline-card" style="position:sticky;top:68px;">
        <div class="timeline-hdr" style="display:flex;align-items:center;justify-content:space-between;">
          <span class="timeline-title">Project Timeline</span>
          
        </div>
        <div class="timeline-body">
          <div class="tl-step">
            <div class="tl-dot-wrap"><div class="tl-dot grey" id="tl-permit"></div></div>
            <div class="tl-info">
              <div class="tl-label">Permitting</div>
              <div class="tl-status" id="tl-permit-status">Not started</div>
            </div>
          </div>
          <div class="tl-step">
            <div class="tl-dot-wrap"><div class="tl-dot grey" id="tl-design"></div></div>
            <div class="tl-info">
              <div class="tl-label">Engineering &amp; Design</div>
              <div class="tl-status" id="tl-design-status">Not started</div>
            </div>
          </div>
          <div class="tl-step">
            <div class="tl-dot-wrap"><div class="tl-dot grey" id="tl-construct"></div></div>
            <div class="tl-info">
              <div class="tl-label">Construction</div>
              <div class="tl-status" id="tl-construct-status">Not started</div>
            </div>
          </div>
          <div class="tl-step">
            <div class="tl-dot-wrap"><div class="tl-dot grey" id="tl-cod"></div></div>
            <div class="tl-info" style="padding-bottom:0;">
              <div class="tl-label">COD</div>
              <div class="tl-status" id="tl-cod-status">Pending</div>
            </div>
          </div>
        </div>
        </div><!-- /timeline-card -->
        <!-- Upload Document card -->
        <div class="upload-card">
          <div class="upload-card-hdr"><span class="upload-card-title">Documents</span></div>
          <div class="upload-card-body">
            <div class="upload-doc-list" id="upload-mini-list">
              <div class="upload-empty" id="upload-mini-empty">No files yet</div>
            </div>
            <button class="upload-open-btn" onclick="openDocPanel()">&#128196; Manage Documents</button>
          </div>
        </div>
        </div><!-- /centre-timeline -->
      </div><!-- /centre-split -->
    </div><!-- /main-overview -->

    <!-- CENTRE: category detail panel -->
    <div class="cat-panel" id="cat-panel">
      <!-- built dynamically by openCatPanel() -->
    </div>

    <!-- CENTRE: document panel -->
    <div class="doc-panel" id="doc-panel">

      <div class="dp-header">
        <div style="display:flex;align-items:center;gap:12px;">
          <button class="dp-back" onclick="closeDocPanel()">&#8592; Back</button>
          <span class="dp-title">Due Diligence Documents</span>
        </div>
        <div class="dp-header-right">
          <span class="dp-overall-badge">Priority docs: <span id="dp-priority-count">‚Äî</span></span>
          <span class="dp-overall-badge">Checklist: <span id="dp-check-count">‚Äî</span></span>
        </div>
      </div>

      <!-- 7-ring progress bar -->
      <div class="dp-progress-summary">
        <div class="dp-prog-cats" id="dp-prog-cats"></div>
      </div>

      <!-- Shared hidden file input -->
      <input type="file" class="dp-file-input" id="dp-file-input" accept="*/*" onchange="handleCatFileSelect(this.files)"/>

      <!-- 7 category accordion cards, built by JS -->
      <div id="dp-cat-sections"></div>

    </div>

    <!-- Fullscreen preview overlay -->
    <div class="dp-preview-overlay" id="dp-preview-overlay">
      <div class="dp-preview-topbar">
        <button class="dp-preview-topbar-close" onclick="closePreview()">&#8592; Close</button>
        <span class="dp-preview-topbar-name" id="dp-preview-name"></span>
        <button class="dp-preview-topbar-dl" id="dp-preview-dl-btn" onclick="downloadActiveDoc()">&#8681; Download</button>
      </div>
      <div class="dp-preview-frame-wrap" id="dp-preview-frame-wrap"></div>
    </div>

    <!-- RIGHT: locked cards -->
    <div class="right-col">

      <div class="lock-card">
        <div class="lock-card-hdr">
          <span class="lock-card-title">Critical Issues</span>
          <span class="lock-icon" id="icon-issues">&#128274;</span>
        </div>
        <div class="lock-card-body" id="body-issues">
          <div class="lock-overlay">
            <svg class="lock-svg" viewBox="0 0 24 24" fill="none" stroke="#1a1f2e" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <div class="lock-msg">Unlocks after the first assessment is completed.</div>
            <span class="lock-req">Requires 1+ assessment</span>
          </div>
        </div>
      </div>
      <div class="lock-card">
        <div class="lock-card-hdr">
          <span class="lock-card-title">Action Plan</span>
          <span class="lock-icon" id="icon-actions">&#128274;</span>
        </div>
        <div class="lock-card-body" id="body-actions">
          <div class="lock-overlay">
            <svg class="lock-svg" viewBox="0 0 24 24" fill="none" stroke="#1a1f2e" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <div class="lock-msg">Unlocks after the first assessment is completed.</div>
            <span class="lock-req">Requires 1+ assessment</span>
          </div>
        </div>
      </div>
      <div class="lock-card">
        <div class="lock-card-hdr">
          <span class="lock-card-title">Scenario Analysis</span>
          <span class="lock-icon" id="icon-scenario">&#128274;</span>
        </div>
        <div class="lock-card-body" id="body-scenario">
          <div class="lock-overlay">
            <svg class="lock-svg" viewBox="0 0 24 24" fill="none" stroke="#1a1f2e" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <div class="lock-msg">Unlocks after 2 or more assessments are completed.</div>
            <span class="lock-req">Requires 2+ assessments</span>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

var ADMIN_CONFIG = {};

// Load admin config (thresholds, required fields) from DB
sb.from("admin_config").select("key,value").then(function(res) {
  if (!res.error && res.data) {
    res.data.forEach(function(r) { ADMIN_CONFIG[r.key] = r.value; });
  }
});

var CAT_FORM_DESIGN    = "1ArXEg";
var CAT_FORM_CONSTRUCT = "0QEdP9";
var CAT_FORM_CONTRACT  = "D4VBel";
var CAT_FORM_INTERCON  = "Gxr6Le";
var CAT_FORM_FINANCIAL = "rjl5Vo";
var CAT_FORM_PERMIT    = "xXdr2d";

var currentProjectId = null;
var currentUserId    = null;
var currentProject   = null;
var authResolved     = false;
var summaryRunning   = false;
var activeCatKey     = null;
var aiHistory        = {};  // per category
var pollTimer        = null;
var shareToken       = null;

/* =============================================
   CATEGORY SPEC DEFINITIONS
   Each category has: key, label, color, icon,
   sections[] ‚Üí each with icon, title, fields[]
   field types: text | number | date | select | toggle
   ============================================= */
var CATEGORIES = [
  /* ‚îÄ‚îÄ 1. PERMITS & ENTITLEMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  {
    key: "score_permit", label: "Permits & Entitlements", icon: "üìú", color: "#c0392b",
    sections: [
      { icon: "üìç", title: "Project Location", fields: [
        { lbl: "Project Name",          field: "proj_name",       type: "text",   col: 2 },
        { lbl: "County",                field: "county",          type: "text" },
        { lbl: "State",                 field: "state",           type: "select",  opts: ["","AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"] },
        { lbl: "ISO / RTO",             field: "iso_rto",         type: "select",  opts: ["","PJM","CAISO","ERCOT","MISO","SPP","NYISO","ISO-NE","WECC","Other"] },
        { lbl: "Latitude",              field: "latitude",        type: "number" },
        { lbl: "Longitude",             field: "longitude",       type: "number" },
        { lbl: "Parcel Numbers",        field: "parcel_numbers",  type: "text",   col: 2 },
        { lbl: "Flood Zone Classification", field: "flood_zone",  type: "select",  opts: ["","Zone X (minimal)","Zone AE","Zone A","Zone VE","Zone V","Unknown"] },
        { lbl: "Seismic Zone",          field: "seismic_zone",    type: "select",  opts: ["","Zone 0","Zone 1","Zone 2A","Zone 2B","Zone 3","Zone 4"] },
      ]},
      { icon: "üó∫Ô∏è", title: "Zoning & Land", fields: [
        { lbl: "Zoning Classification", field: "zoning_class",   type: "text" },
        { lbl: "CUP Status",            field: "cup_status",     type: "select",  opts: ["","Approved","Pending","Not Required","Denied"] },
        { lbl: "Setback Requirements (ft)", field: "setback_ft", type: "number" },
        { lbl: "Total Site Acreage",    field: "site_acres",     type: "number" },
        { lbl: "Buildable Acreage",     field: "buildable_acres",type: "number" },
        { lbl: "Land Ownership",        field: "land_ownership", type: "select",  opts: ["","Fee Simple","Lease","Mixed","Option"] },
        { lbl: "Lease Term (years)",    field: "lease_term_yrs", type: "number" },
        { lbl: "Lease Escalator (%/yr)",field: "lease_esc_pct",  type: "number" },
        { lbl: "Decommissioning Bond ($)", field: "decomm_bond", type: "number" },
      ]},
      { icon: "üåø", title: "Environmental", fields: [
        { lbl: "Phase I ESA Status",    field: "esa_status",     type: "select",  opts: ["","Complete ‚Äì Clean","Complete ‚Äì REC Identified","In Progress","Not Started"] },
        { lbl: "Wetlands Acreage",      field: "wetlands_acres", type: "number" },
        { lbl: "Endangered Species Impact", field: "esa_species",type: "toggle" },
        { lbl: "Mitigation Cost ($)",   field: "mitigation_cost",type: "number" },
        { lbl: "Cultural Resource Constraints", field: "cultural_constraints", type: "toggle" },
        { lbl: "SWPPP Required",        field: "swppp_req",      type: "toggle" },
        { lbl: "NEPA Required",         field: "nepa_req",       type: "toggle" },
      ]},
    ],
    missing: [
      { text: "CUP / SUP approval", impact: "Cannot proceed to construction without entitlement" },
      { text: "Phase I ESA", impact: "Lender prerequisite; may reveal remediation cost" },
      { text: "ALTA Survey", impact: "Required for title insurance and boundary confirmation" },
    ]
  },

  /* ‚îÄ‚îÄ 2. DESIGN & ENGINEERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  {
    key: "score_design", label: "Design & Engineering", icon: "‚öôÔ∏è", color: "#2471a3",
    sections: [
      { icon: "‚òÄÔ∏è", title: "Resource & Yield", fields: [
        { lbl: "Irradiance Source",     field: "irr_source",     type: "select",  opts: ["","NSRDB","Meteonorm","SolarAnywhere","Solargis","Other"] },
        { lbl: "GHI (kWh/m¬≤/yr)",       field: "ghi",            type: "number" },
        { lbl: "P50 Production (MWh/yr)",field: "p50_mwh",       type: "number" },
        { lbl: "P90 Production (MWh/yr)",field: "p90_mwh",       type: "number" },
        { lbl: "Net Capacity Factor (%)",field: "net_cf_pct",    type: "number" },
        { lbl: "Degradation Rate (%/yr)",field: "degradation_pct",type: "number" },
        { lbl: "Availability (%)",      field: "availability_pct",type: "number" },
        { lbl: "Curtailment (%)",       field: "curtailment_pct", type: "number" },
        { lbl: "DC Size (MWdc)",        field: "dc_mw",          type: "number" },
        { lbl: "AC Size (MWac)",        field: "ac_mw",          type: "number" },
        { lbl: "DC:AC Ratio (ILR)",     field: "ilr",            type: "number" },
      ]},
      { icon: "üèóÔ∏è", title: "Civil & Structural", fields: [
        { lbl: "Racking Type",          field: "racking_type",   type: "select",  opts: ["","Single-Axis Tracker","Fixed Tilt","Dual-Axis Tracker"] },
        { lbl: "Tracker Manufacturer",  field: "tracker_mfr",    type: "text" },
        { lbl: "Pile Type",             field: "pile_type",      type: "select",  opts: ["","Driven","Helical","Ground Screw","Ballasted"] },
        { lbl: "Max Wind Speed Design (mph)", field: "wind_speed_mph", type: "number" },
        { lbl: "Snow Load (psf)",       field: "snow_load_psf",  type: "number" },
        { lbl: "Soil Classification",   field: "soil_class",     type: "text" },
        { lbl: "Corrosion Category",    field: "corrosion_cat",  type: "select",  opts: ["","C1 (Very Low)","C2 (Low)","C3 (Medium)","C4 (High)","C5 (Very High)"] },
      ]},
      { icon: "‚ö°", title: "Electrical", fields: [
        { lbl: "Inverter Manufacturer", field: "inv_mfr",        type: "text" },
        { lbl: "Inverter Model",        field: "inv_model",      type: "text" },
        { lbl: "Inverter Configuration",field: "inv_config",     type: "select",  opts: ["","Central","String","Micro","Hybrid"] },
        { lbl: "Transformer Rating (MVA)", field: "xfmr_mva",   type: "number" },
        { lbl: "Collector Voltage (kV)", field: "collector_kv",  type: "number" },
        { lbl: "POI Voltage (kV)",      field: "poi_kv",         type: "number" },
        { lbl: "Cable Type",            field: "cable_type",     type: "text" },
        { lbl: "SCADA Vendor",          field: "scada_vendor",   type: "text" },
        { lbl: "Reactive Power Capability", field: "reactive_power", type: "toggle" },
      ]},
    ],
    missing: [
      { text: "Energy Yield Assessment (P50/P90)", impact: "Core lender requirement; triggers cross-check against PVWatts" },
      { text: "Geotechnical Report", impact: "Determines pile type and foundation risk" },
      { text: "IFC Single-Line Diagram", impact: "Required before construction can begin" },
    ]
  },

  /* ‚îÄ‚îÄ 3. CONSTRUCTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  {
    key: "score_construct", label: "Construction", icon: "üèóÔ∏è", color: "#d35400",
    sections: [
      { icon: "üìÖ", title: "Schedule", fields: [
        { lbl: "NTP Date",              field: "ntp_date",        type: "date" },
        { lbl: "Construction Start",    field: "construction_start", type: "date" },
        { lbl: "Mechanical Completion", field: "mech_complete_date", type: "date" },
        { lbl: "COD Target",            field: "cod_target_date", type: "date" },
        { lbl: "Total Duration (months)", field: "const_duration_mo", type: "number" },
      ]},
      { icon: "üí∞", title: "Budget", fields: [
        { lbl: "Total EPC Price ($)",   field: "epc_price",       type: "number" },
        { lbl: "EPC Price ($/Wdc)",     field: "epc_per_wdc",     type: "number" },
        { lbl: "Owner's Costs ($)",     field: "owners_costs",    type: "number" },
        { lbl: "Interconnection Cost ($)", field: "intercon_cost",type: "number" },
        { lbl: "Contingency (%)",       field: "contingency_pct", type: "number" },
        { lbl: "Sales / Use Tax ($)",   field: "sales_tax",       type: "number" },
      ]},
      { icon: "üë∑", title: "Contractor", fields: [
        { lbl: "EPC Contractor Name",   field: "epc_contractor",  type: "text",   col: 2 },
        { lbl: "Parent Guarantee",      field: "parent_guarantee",type: "toggle" },
        { lbl: "Performance LD Cap (%)",field: "perf_ld_cap_pct", type: "number" },
        { lbl: "Delay LD Cap (%)",      field: "delay_ld_cap_pct",type: "number" },
      ]},
    ],
    missing: [
      { text: "Executed EPC Agreement", impact: "Pricing, liability and LDs unconfirmed until signed" },
      { text: "Critical Path Schedule", impact: "Cannot validate COD date risk without detailed schedule" },
      { text: "Performance & Payment Bonds", impact: "Lender requirement for EPC completion risk" },
    ]
  },

  /* ‚îÄ‚îÄ 4. PROCUREMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  {
    key: "score_procurement", label: "Procurement", icon: "üì¶", color: "#7d3c98",
    sections: [
      { icon: "üîã", title: "Modules", fields: [
        { lbl: "Manufacturer",          field: "mod_mfr",         type: "text" },
        { lbl: "Model",                 field: "mod_model",       type: "text" },
        { lbl: "Technology",            field: "mod_tech",        type: "select",  opts: ["","Mono PERC","TOPCon","HJT","CIGS","CdTe","Other"] },
        { lbl: "Wattage (W)",           field: "mod_watt",        type: "number" },
        { lbl: "Efficiency (%)",        field: "mod_eff_pct",     type: "number" },
        { lbl: "Bifaciality Factor (%)",field: "mod_bifac_pct",   type: "number" },
        { lbl: "Quantity (#)",          field: "mod_qty",         type: "number" },
        { lbl: "Country of Manufacture",field: "mod_country",     type: "text" },
        { lbl: "Warranty Term (years)", field: "mod_warranty_yrs",type: "number" },
        { lbl: "Annual Degradation (%)",field: "mod_degrad_pct",  type: "number" },
      ]},
      { icon: "üîå", title: "Inverters", fields: [
        { lbl: "Manufacturer",          field: "inv_proc_mfr",    type: "text" },
        { lbl: "Model",                 field: "inv_proc_model",  type: "text" },
        { lbl: "Power Rating (kW)",     field: "inv_kw",          type: "number" },
        { lbl: "Quantity",              field: "inv_qty",         type: "number" },
        { lbl: "Warranty Term (years)", field: "inv_warranty_yrs",type: "number" },
      ]},
      { icon: "üß±", title: "Balance of Plant", fields: [
        { lbl: "Tracker Supplier",      field: "tracker_supplier",type: "text" },
        { lbl: "Transformer Manufacturer", field: "xfmr_mfr",    type: "text" },
        { lbl: "Cable Supplier",        field: "cable_supplier",  type: "text" },
        { lbl: "SCADA Provider",        field: "scada_provider",  type: "text" },
        { lbl: "Spare Parts Budget ($)",field: "spare_parts_budget", type: "number" },
      ]},
    ],
    missing: [
      { text: "Module Supply Agreement", impact: "Delivery LDs and insolvency protection unconfirmed" },
      { text: "Module Warranty Certificate", impact: "Performance curve alignment with yield model unverified" },
      { text: "Domestic Content Documentation", impact: "IRA adder eligibility at risk without this package" },
    ]
  },

  /* ‚îÄ‚îÄ 5. LEGAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  {
    key: "score_contract", label: "Legal", icon: "‚öñÔ∏è", color: "#1e8449",
    sections: [
      { icon: "üìë", title: "PPA / Offtake", fields: [
        { lbl: "Offtaker Name",         field: "offtaker_name",   type: "text",   col: 2 },
        { lbl: "Offtaker Credit Rating",field: "offtaker_rating", type: "select",  opts: ["","AAA","AA+","AA","AA-","A+","A","A-","BBB+","BBB","BBB-","Below Investment Grade","Not Rated"] },
        { lbl: "PPA Term (years)",      field: "ppa_term_yrs",    type: "number" },
        { lbl: "Fixed Price ($/MWh)",   field: "ppa_price",       type: "number" },
        { lbl: "Price Escalator (%/yr)",field: "ppa_escalator_pct",type: "number" },
        { lbl: "PPA Start Date",        field: "ppa_start_date",  type: "date" },
        { lbl: "Merchant Tail (years)", field: "merchant_tail_yrs",type: "number" },
        { lbl: "Curtailment Compensation", field: "curtail_comp", type: "toggle" },
      ]},
      { icon: "üèõÔ∏è", title: "Tax & Incentives", fields: [
        { lbl: "ITC or PTC Election",   field: "itc_ptc",         type: "select",  opts: ["","ITC (30%)","PTC","Not Determined"] },
        { lbl: "ITC Percentage (%)",    field: "itc_pct",         type: "number" },
        { lbl: "Domestic Content Bonus",field: "dom_content_bonus",type: "toggle" },
        { lbl: "Energy Community Bonus",field: "energy_comm_bonus",type: "toggle" },
        { lbl: "Prevailing Wage Compliance", field: "prev_wage",  type: "toggle" },
        { lbl: "State Incentives ($)",  field: "state_incentives",type: "number" },
        { lbl: "Property Tax Abatement",field: "prop_tax_abate",  type: "toggle" },
      ]},
      { icon: "üõ°Ô∏è", title: "Insurance", fields: [
        { lbl: "Builder's Risk Limit ($)", field: "builders_risk_limit", type: "number" },
        { lbl: "O&M Coverage Limit ($)",   field: "om_coverage_limit",   type: "number" },
        { lbl: "Business Interruption (months)", field: "bi_months",     type: "number" },
      ]},
    ],
    missing: [
      { text: "Executed PPA", impact: "Revenue stream unconfirmed; project unbankable without it" },
      { text: "Land Lease Agreement", impact: "Site security and assignment rights unconfirmed" },
      { text: "ITC/PTC Tax Opinion", impact: "Tax credit eligibility unverified; lender requirement" },
    ]
  },

  /* ‚îÄ‚îÄ 6. GRID CONNECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  {
    key: "score_intercon", label: "Grid Connection", icon: "‚ö°", color: "#117a65",
    sections: [
      { icon: "üîå", title: "Interconnection", fields: [
        { lbl: "Queue Position",        field: "queue_position",  type: "text" },
        { lbl: "POI Substation Name",   field: "poi_substation",  type: "text" },
        { lbl: "Interconnection Voltage (kV)", field: "intercon_kv", type: "number" },
        { lbl: "Network Upgrade Cost ($)", field: "network_upgrade_cost", type: "number" },
        { lbl: "Upgrade Scope Description", field: "upgrade_scope", type: "text", col: 2 },
        { lbl: "Milestone Security Posted ($)", field: "milestone_security", type: "number" },
        { lbl: "IA Execution Date",     field: "ia_exec_date",    type: "date" },
        { lbl: "Expected Upgrade Completion", field: "upgrade_complete_date", type: "date" },
      ]},
      { icon: "üìä", title: "Market & Deliverability", fields: [
        { lbl: "Capacity Accreditation (%)", field: "cap_accredit_pct", type: "number" },
        { lbl: "ELCC Methodology",      field: "elcc_method",     type: "text" },
        { lbl: "Congestion Risk Score (1‚Äì10)", field: "congestion_score", type: "number" },
        { lbl: "Deliverability Status", field: "deliverability",  type: "select",  opts: ["","Full Capacity Deliverability","Partial Capacity Deliverability","Energy-Only","Unknown"] },
      ]},
    ],
    missing: [
      { text: "Executed Interconnection Agreement", impact: "Grid access unconfirmed; milestone costs may shift" },
      { text: "Facilities Study", impact: "Final upgrade scope and cost responsibility not established" },
      { text: "Deliverability / Capacity Accreditation Letter", impact: "Capacity revenue stream unconfirmed" },
    ]
  },

  /* ‚îÄ‚îÄ 7. FINANCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  {
    key: "score_financial", label: "Finance", icon: "üíµ", color: "#1a5276",
    sections: [
      { icon: "üíµ", title: "Capital Stack", fields: [
        { lbl: "Total Capex ($)",       field: "total_capex",     type: "number" },
        { lbl: "Debt Amount ($)",       field: "debt_amount",     type: "number" },
        { lbl: "Debt Tenor (years)",    field: "debt_tenor_yrs",  type: "number" },
        { lbl: "Interest Rate (%)",     field: "interest_rate_pct",type: "number" },
        { lbl: "Sculpted DSCR",         field: "sculpted_dscr",   type: "number" },
        { lbl: "Minimum DSCR",          field: "min_dscr",        type: "number" },
        { lbl: "Tax Equity Amount ($)", field: "tax_equity_amt",  type: "number" },
        { lbl: "Target Flip Year",      field: "flip_year",       type: "number" },
        { lbl: "Sponsor Equity ($)",    field: "sponsor_equity",  type: "number" },
      ]},
      { icon: "üìà", title: "Financial Metrics", fields: [
        { lbl: "Levered IRR (%)",       field: "levered_irr_pct", type: "number" },
        { lbl: "Unlevered IRR (%)",     field: "unlevered_irr_pct",type: "number" },
        { lbl: "NPV ($)",               field: "npv",             type: "number" },
        { lbl: "LCOE ($/MWh)",          field: "lcoe",            type: "number" },
        { lbl: "Breakeven PPA Price ($/MWh)", field: "breakeven_ppa", type: "number" },
        { lbl: "P50 DSCR",              field: "p50_dscr",        type: "number" },
        { lbl: "P90 DSCR",              field: "p90_dscr",        type: "number" },
      ]},
    ],
    missing: [
      { text: "Financial Model (native format)", impact: "Cannot validate DSCR, IRR or tax credit assumptions" },
      { text: "Independent Model Audit Report", impact: "Lender requirement before credit approval" },
      { text: "Tax Equity Commitment Letter", impact: "Tax equity terms and flip structure unconfirmed" },
    ]
  },
];

var CAT_MILESTONES = {
  "score_design": [
    { label: "30% Design", key: "tl_d_30" },
    { label: "60% Design", key: "tl_d_60" },
    { label: "90% Design", key: "tl_d_90" },
    { label: "IFC (Issued for Construction)", key: "tl_d_ifc" },
    { label: "As-Built", key: "tl_d_asbuilt" },
  ],
  "score_construct": [
    { label: "Contractor Appointed", key: "tl_c_appt" },
    { label: "Mobilisation", key: "tl_c_mob" },
    { label: "Foundation Complete", key: "tl_c_found" },
    { label: "Modules Installed", key: "tl_c_mod" },
    { label: "Energisation", key: "tl_c_enrg" },
    { label: "PAC (Provisional Acceptance)", key: "tl_c_pac" },
    { label: "FAC (Final Acceptance)", key: "tl_c_fac" },
  ],
  "score_contract": [
    { label: "Land Secured", key: "tl_l_land" },
    { label: "PPA Executed", key: "tl_l_ppa" },
    { label: "Financial Close", key: "tl_l_fc" },
    { label: "Legal Completion", key: "tl_l_comp" },
  ],
  "score_intercon": [
    { label: "Connection Study Submitted", key: "tl_g_study" },
    { label: "Offer Received", key: "tl_g_offer" },
    { label: "Offer Accepted", key: "tl_g_accept" },
    { label: "Agreement Signed", key: "tl_g_sign" },
    { label: "Energisation", key: "tl_g_enrg" },
  ],
  "score_financial": [
    { label: "Financial Model Complete", key: "tl_f_model" },
    { label: "Term Sheet Signed", key: "tl_f_ts" },
    { label: "Credit Approval", key: "tl_f_credit" },
    { label: "Financial Close", key: "tl_f_fc" },
  ],
  "score_permit": [
    { label: "Environmental Study Submitted", key: "tl_p_env_sub" },
    { label: "Environmental Approval", key: "tl_p_env_app" },
    { label: "Planning Application", key: "tl_p_plan_sub" },
    { label: "Planning Approval", key: "tl_p_plan_app" },
    { label: "Grid Permit Granted", key: "tl_p_grid" },
    { label: "Building Permit", key: "tl_p_build" },
  ],
  "score_procurement": [
    { label: "RFQ Issued", key: "tl_pr_rfq" },
    { label: "Bids Received", key: "tl_pr_bids" },
    { label: "Supplier Selected", key: "tl_pr_sel" },
    { label: "PO Issued", key: "tl_pr_po" },
    { label: "Equipment Delivered", key: "tl_pr_del" },
  ],
};

function scoreColor(s) {
  if (s == null) return "rgba(0,0,0,0.12)";
  if (s >= 70) return "#2e7d4f";
  if (s >= 40) return "#e07b20";
  return "#c0392b";
}

/* ---- SIDEBAR ---- */
function renderLeft(project) {
  var overall = project.score_overall;
  var ringEl  = document.getElementById("score-ring");
  var descEl  = document.getElementById("score-card-desc");
  if (overall != null) {
    var color = scoreColor(overall);
    ringEl.style.border    = "3px solid " + color;
    ringEl.style.background = "rgba(0,0,0,0.15)";
    ringEl.innerHTML = '<div><div class="score-ring-val" style="color:' + color + '">' + overall + '</div><div class="score-ring-sub">/100</div></div>';
    descEl.textContent = overall >= 70 ? "Good overall risk profile." :
                         overall >= 40 ? "Moderate risk - review flagged categories." :
                                         "High risk - action required.";
  }
  var sidebarEl = document.getElementById("sidebar");
  sidebarEl.innerHTML = "";
  var scoredCount = 0;
  CATEGORIES.forEach(function(cat) {
    var score    = project[cat.key];
    var hasScore = score != null;
    if (hasScore) scoredCount++;
    var pct   = hasScore ? Math.min(100, Math.max(0, score)) : 0;
    var color = scoreColor(score);
    var lbl   = hasScore ? score + "/100" : "--";

    // Spec completeness dot
    var allFields = [];
    cat.sections.forEach(function(s) { s.fields.forEach(function(f) { allFields.push(f.field); }); });
    var tallyData = project.tally_fields || {};
    var filled = allFields.filter(function(f) { return tallyData[f] && tallyData[f] !== ""; }).length;
    var specPct = allFields.length ? Math.round(filled / allFields.length * 100) : 0;
    var dotColor = specPct === 0 ? "#b0b8c8" : specPct === 100 ? "#2e7d4f" : "#e07b20";

    var item = document.createElement("div");
    item.className = "cat-item" + (activeCatKey === cat.key ? " active" : "");
    item.id = "cat-item-" + cat.key;

    var btnRow = hasScore
      ? '<div class="cat-btn-row two">' +
          '<button class="cat-view-btn"  onclick="openCatPanel(\'' + cat.key + '\')">View</button>' +
          '<button class="cat-start-btn" onclick="openCatForm(\''  + cat.key + '\')">Retake</button>' +
        '</div>'
      : '<div class="cat-btn-row">' +
          '<button class="cat-start-btn" onclick="openCatPanel(\'' + cat.key + '\')">+ Start</button>' +
        '</div>';

    item.innerHTML =
      '<div class="cat-top">' +
        '<span class="cat-icon" style="font-size:12px;margin-right:4px;">' + cat.icon + '</span>' +
        '<span class="cat-name">' + cat.label + '</span>' +
        '<span class="cat-score-lbl">' + lbl + '<span class="cat-dot" style="background:' + dotColor + ';"></span></span>' +
      '</div>' +
      '<div class="cat-bar-track"><div class="cat-bar-fill" style="width:' + pct + '%;background:' + color + ';"></div></div>' +
      btnRow;
    sidebarEl.appendChild(item);
  });
  if (scoredCount >= 1) { unlockCard("issues"); unlockCard("actions"); }
  if (scoredCount >= 2) { unlockCard("scenario"); }
  updateTimeline(project);
}

function unlockCard(id) {
  var iconEl = document.getElementById("icon-" + id);
  var bodyEl = document.getElementById("body-" + id);
  if (iconEl) iconEl.textContent = "";
  var labels = { issues: "critical issue analysis", actions: "action plan", scenario: "scenario analysis" };
  if (bodyEl) bodyEl.innerHTML =
    '<div style="padding:8px 0;text-align:center;"><div style="font-size:11px;color:#6b7585;line-height:1.6;">Coming soon -- full ' + (labels[id] || id) + ' will appear here once the report engine is live.</div></div>';
}

/* ---- CATEGORY PANEL (Spec-first) ---- */
var activeSpecSections = {};  // { catKey: { sectionIdx: true } }

function openCatPanel(catKey) {
  var cat = CATEGORIES.find(function(c) { return c.key === catKey; });
  if (!cat || !currentProject) return;
  activeCatKey = catKey;
  if (!activeSpecSections[catKey]) activeSpecSections[catKey] = { 0: true }; // first section open by default

  document.getElementById("main-overview").style.display = "none";
  document.getElementById("doc-panel").classList.remove("open");
  var panel = document.getElementById("cat-panel");
  panel.classList.add("open");

  CATEGORIES.forEach(function(c) {
    var el = document.getElementById("cat-item-" + c.key);
    if (el) el.classList.toggle("active", c.key === catKey);
  });

  var score     = currentProject[catKey];
  var color     = scoreColor(score);
  var pct       = score != null ? Math.min(100, Math.max(0, score)) : 0;
  var scoreDesc = score == null ? "Not yet scored" :
                  score >= 70   ? "Good risk profile" :
                  score >= 40   ? "Moderate risk" : "High risk";
  var hasScore  = score != null;

  // --- Tab labels ---
  var tabs = [
    { id: "spec",       label: "üìã Specifications" },
    { id: "timeline",   label: "üìÖ Timeline" },
    { id: "assessment", label: "‚úÖ Assessment" },
    { id: "ai",         label: "üí¨ AI Q&A" },
  ];
  var tabsHtml = '<div class="cp-tabs">' +
    tabs.map(function(t, i) {
      return '<button class="cp-tab' + (i === 0 ? ' active' : '') + '" id="tab-btn-' + t.id + '" onclick="switchCatTab(\'' + t.id + '\')">' + t.label + '</button>';
    }).join('') +
  '</div>';

  // --- Spec pane ---
  var specPaneHtml = buildSpecPane(cat, currentProject);

  // --- Timeline pane ---
  var timelinePaneHtml = '<div class="cp-tab-pane" id="tab-timeline">' + buildCatTimeline(catKey) + '</div>';

  // --- Assessment pane ---
  var assessPaneHtml = '<div class="cp-tab-pane" id="tab-assessment">' +
    '<div class="spec-card">' +
      '<div style="padding:20px 16px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:14px;">' +
        '<div style="font-size:36px;">' + cat.icon + '</div>' +
        (hasScore
          ? '<div style="font-size:28px;font-weight:900;color:' + color + '">' + score + '<span style="font-size:14px;color:#8a95a5;">/100</span></div>' +
            '<div style="font-size:12px;color:#6b7585;">' + scoreDesc + '</div>' +
            '<div style="width:100%;max-width:280px;height:6px;background:rgba(0,0,0,0.1);border-radius:3px;overflow:hidden;"><div style="height:100%;width:' + pct + '%;background:' + color + ';border-radius:3px;transition:width .6s;"></div></div>'
          : '<div style="font-size:12px;color:#8a95a5;max-width:280px;line-height:1.6;">Fill in your specifications first, then take the Tally assessment to get a risk score for this category.</div>') +
        '<button onclick="openCatForm(\'' + catKey + '\')" style="padding:11px 28px;background:#1a1f2e;border:none;color:#FFFF00;font-family:Inter,sans-serif;font-size:11px;font-weight:800;text-transform:uppercase;cursor:pointer;border-radius:20px;">' +
          (hasScore ? 'üîÑ Retake Assessment' : '‚ñ∂ Start Tally Assessment') +
        '</button>' +
        // Missing info
        '<div style="width:100%;text-align:left;background:rgba(0,0,0,0.04);border-radius:10px;padding:12px 14px;">' +
          '<div style="font-size:9px;font-weight:700;text-transform:uppercase;color:#8a95a5;letter-spacing:.4px;margin-bottom:8px;">Priority Documents Missing</div>' +
          cat.missing.map(function(m) {
            return '<div style="display:flex;gap:8px;align-items:flex-start;padding:5px 0;border-bottom:1px solid rgba(0,0,0,0.05);">' +
              '<div style="width:6px;height:6px;border-radius:50%;background:#e07b20;flex-shrink:0;margin-top:4px;"></div>' +
              '<div><div style="font-size:11px;color:#1a1f2e;font-weight:600;">' + m.text + '</div>' +
              '<div style="font-size:10px;color:#6b7585;">' + m.impact + '</div></div></div>';
          }).join('') +
        '</div>' +
      '</div>' +
    '</div>' +
  '</div>';

  // --- AI pane ---
  if (!aiHistory[catKey]) aiHistory[catKey] = [];
  var historyHtml = aiHistory[catKey].map(function(m) {
    return '<div class="cp-ai-msg ' + m.role + '">' + escHtml(m.content) + '</div>';
  }).join("");
  var aiPaneHtml = '<div class="cp-tab-pane" id="tab-ai">' +
    '<div class="cp-ai-card">' +
      '<div class="cp-ai-hdr">' +
        '<span class="cp-ai-label">Ask AI about ' + cat.label + '</span>' +
        '<span class="cp-ai-model">gpt-4o-mini</span>' +
      '</div>' +
      '<div class="cp-ai-body">' +
        '<div class="cp-ai-history" id="cp-ai-history">' + historyHtml + '</div>' +
        '<div class="cp-ai-input-row">' +
          '<input class="cp-ai-input" id="cp-ai-input" type="text" placeholder="Ask a question about this category..." onkeydown="if(event.key===\'Enter\')sendAiQuestion()"/>' +
          '<button class="cp-ai-send" id="cp-ai-send" onclick="sendAiQuestion()">Ask</button>' +
        '</div>' +
      '</div>' +
    '</div>' +
  '</div>';

  // --- Assemble ---
  panel.innerHTML =
    '<div class="cp-header">' +
      '<div class="cp-header-left">' +
        '<button class="cp-back" onclick="closeCatPanel()">&#8592; Overview</button>' +
        '<span style="font-size:18px;">' + cat.icon + '</span>' +
        '<span class="cp-title">' + cat.label + '</span>' +
      '</div>' +
      '<div class="cp-header-right">' +
        '<button class="cp-share-btn" onclick="openShareModal(\'' + catKey + '\')">&#128279; Share</button>' +
      '</div>' +
    '</div>' +
    tabsHtml +
    specPaneHtml +
    timelinePaneHtml +
    assessPaneHtml +
    aiPaneHtml;

  switchCatTab('spec');
  loadCatMilestones(catKey, currentProject);
  scrollAiHistory();
}

function switchCatTab(tabId) {
  ['spec','timeline','assessment','ai'].forEach(function(id) {
    var btn  = document.getElementById('tab-btn-' + id);
    var pane = document.getElementById('tab-' + id);
    if (btn)  btn.classList.toggle('active', id === tabId);
    if (pane) pane.classList.toggle('active', id === tabId);
  });
}

/* ---- BUILD SPEC PANE ---- */
function buildSpecPane(cat, project) {
  var tallyData = project.tally_fields || {};
  // Count filled fields for completeness
  var allFields = [];
  cat.sections.forEach(function(s) { s.fields.forEach(function(f) { allFields.push(f.field); }); });
  var filled = allFields.filter(function(f) { return tallyData[f] && String(tallyData[f]).trim() !== ""; }).length;
  var pct = allFields.length ? Math.round(filled / allFields.length * 100) : 0;
  var fillColor = pct === 100 ? '#2e7d4f' : pct > 40 ? '#e07b20' : '#c0392b';

  var html = '<div class="cp-tab-pane" id="tab-spec">';

  // Completeness strip
  html += '<div class="spec-completeness">' +
    '<div class="spec-comp-bar-wrap">' +
      '<div class="spec-comp-label">Specifications Completeness</div>' +
      '<div class="spec-comp-track"><div class="spec-comp-fill" style="width:' + pct + '%;background:' + fillColor + ';"></div></div>' +
    '</div>' +
    '<div style="text-align:right;">' +
      '<div class="spec-comp-pct">' + pct + '%</div>' +
      '<div class="spec-comp-hint">' + filled + ' / ' + allFields.length + ' fields</div>' +
    '</div>' +
  '</div>';

  // Sections
  cat.sections.forEach(function(section, sIdx) {
    var secOpen = activeSpecSections[cat.key] && activeSpecSections[cat.key][sIdx];
    var secFilled = section.fields.filter(function(f) { return tallyData[f.field] && String(tallyData[f.field]).trim() !== ""; }).length;

    html += '<div class="spec-card">' +
      '<div class="spec-section-hdr" onclick="toggleSpecSection(\'' + cat.key + '\',' + sIdx + ')">' +
        '<span class="spec-section-icon">' + section.icon + '</span>' +
        '<span class="spec-section-title">' + section.title + '</span>' +
        '<span class="spec-section-filled">' + secFilled + '/' + section.fields.length + '</span>' +
        '<span class="spec-section-chev' + (secOpen ? ' open' : '') + '">‚ñº</span>' +
      '</div>' +
      '<div class="spec-section-body' + (secOpen ? ' open' : '') + '" id="specsec-' + cat.key + '-' + sIdx + '">';

    // Group fields in a grid
    html += '<div class="spec-grid">';
    section.fields.forEach(function(f) {
      var val = tallyData[f.field] !== undefined ? tallyData[f.field] : (project[f.field] || '');
      var spanFull = (f.col === 2) ? ' full' : '';
      html += '<div class="spec-field' + spanFull + '">' +
        '<label class="spec-lbl" for="sf-' + f.field + '">' + f.lbl + '</label>';

      if (f.type === 'toggle') {
        var checked = val === true || val === 'true' || val === 'Y' || val === 'yes';
        html += '<div class="spec-toggle-row">' +
          '<label class="spec-toggle"><input type="checkbox" id="sf-' + f.field + '" data-field="' + f.field + '" data-type="toggle"' + (checked ? ' checked' : '') + ' onchange="onSpecChange()"/><span class="spec-toggle-slider"></span></label>' +
          '<span class="spec-toggle-lbl">' + (checked ? 'Yes' : 'No') + '</span>' +
        '</div>';
      } else if (f.type === 'select') {
        html += '<select class="spec-select" id="sf-' + f.field + '" data-field="' + f.field + '" data-type="select" onchange="onSpecChange()">';
        (f.opts || []).forEach(function(opt) {
          html += '<option value="' + escHtml(opt) + '"' + (String(val) === opt ? ' selected' : '') + '>' + (opt || '‚Äî Select ‚Äî') + '</option>';
        });
        html += '</select>';
      } else {
        html += '<input class="spec-input" id="sf-' + f.field + '" data-field="' + f.field + '" data-type="' + f.type + '" type="' + f.type + '" value="' + escHtml(String(val)) + '" placeholder="Enter value" oninput="onSpecChange()"/>';
      }

      html += '</div>'; // spec-field
    });
    html += '</div>'; // spec-grid
    html += '</div></div>'; // spec-section-body + spec-card
  });

  // Save row
  html += '<div class="spec-card">' +
    '<div class="spec-save-row">' +
      '<button class="spec-save-btn" onclick="saveSpecFields(\'' + cat.key + '\')">üíæ Save Specs</button>' +
      '<span class="spec-save-msg" id="spec-save-msg">Saved ‚úì</span>' +
      '<button class="spec-assess-btn" onclick="openCatForm(\'' + cat.key + '\')">‚ñ∂ ' + (cat.key && currentProject[cat.key] != null ? 'Retake Assessment' : 'Start Assessment') + '</button>' +
    '</div>' +
  '</div>';

  html += '</div>'; // tab-pane
  return html;
}

function toggleSpecSection(catKey, sIdx) {
  if (!activeSpecSections[catKey]) activeSpecSections[catKey] = {};
  activeSpecSections[catKey][sIdx] = !activeSpecSections[catKey][sIdx];
  var body = document.getElementById('specsec-' + catKey + '-' + sIdx);
  var hdr  = body && body.previousElementSibling;
  if (body) body.classList.toggle('open', activeSpecSections[catKey][sIdx]);
  if (hdr)  { var ch = hdr.querySelector('.spec-section-chev'); if (ch) ch.classList.toggle('open', activeSpecSections[catKey][sIdx]); }
}

function onSpecChange() {
  // Live toggle label update
  document.querySelectorAll('.spec-toggle input[type="checkbox"]').forEach(function(cb) {
    var lbl = cb.closest('.spec-toggle-row') && cb.closest('.spec-toggle-row').querySelector('.spec-toggle-lbl');
    if (lbl) lbl.textContent = cb.checked ? 'Yes' : 'No';
  });
}

/* ---- SAVE SPEC FIELDS ---- */
function saveSpecFields(catKey) {
  if (!currentProjectId || !currentUserId) return;
  var tallyFields = Object.assign({}, currentProject.tally_fields || {});

  // Collect all inputs in the spec pane
  var specPane = document.getElementById('tab-spec');
  if (!specPane) return;

  specPane.querySelectorAll('[data-field]').forEach(function(el) {
    var field = el.getAttribute('data-field');
    var type  = el.getAttribute('data-type');
    var val;
    if (type === 'toggle') {
      val = el.checked;
    } else {
      val = el.value.trim();
    }
    tallyFields[field] = val;
    if (currentProject) currentProject[field] = val;
  });

  currentProject.tally_fields = tallyFields;

  sb.from("projects").update({ tally_fields: tallyFields, updated_at: new Date().toISOString() })
    .eq("id", currentProjectId).eq("user_id", currentUserId)
    .then(function(res) {
      if (res.error) { alert("Save failed: " + res.error.message); return; }
      var msg = document.getElementById("spec-save-msg");
      if (msg) { msg.classList.add("show"); setTimeout(function() { msg.classList.remove("show"); }, 2500); }
      // Refresh completeness bar
      var cat = CATEGORIES.find(function(c) { return c.key === catKey; });
      if (!cat) return;
      var allFields = [];
      cat.sections.forEach(function(s) { s.fields.forEach(function(f) { allFields.push(f.field); }); });
      var filled = allFields.filter(function(f) { return tallyFields[f] && String(tallyFields[f]).trim() !== ''; }).length;
      var pct = allFields.length ? Math.round(filled / allFields.length * 100) : 0;
      var fill = document.querySelector('.spec-comp-fill');
      var pctEl = document.querySelector('.spec-comp-pct');
      var hintEl = document.querySelector('.spec-comp-hint');
      var fillColor = pct === 100 ? '#2e7d4f' : pct > 40 ? '#e07b20' : '#c0392b';
      if (fill)  { fill.style.width = pct + '%'; fill.style.background = fillColor; }
      if (pctEl) pctEl.textContent = pct + '%';
      if (hintEl) hintEl.textContent = filled + ' / ' + allFields.length + ' fields';
      // Refresh sidebar dot
      renderLeft(currentProject);
      // Re-highlight active
      CATEGORIES.forEach(function(c) {
        var el = document.getElementById("cat-item-" + c.key);
        if (el) el.classList.toggle("active", c.key === catKey);
      });
    });
}

/* ---- SAVE FIELDS (legacy, kept for compatibility) ---- */
function saveFields() { saveSpecFields(activeCatKey); }

/* ---- CLOSE CAT PANEL ---- */
function closeCatPanel() {
  activeCatKey = null;
  document.getElementById("cat-panel").classList.remove("open");
  document.getElementById("cat-panel").innerHTML = "";
  document.getElementById("main-overview").style.display = "flex";
  CATEGORIES.forEach(function(c) {
    var el = document.getElementById("cat-item-" + c.key);
    if (el) el.classList.remove("active");
  });
}

function escHtml(s) {
  return String(s||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

/* ---- AI Q&A ---- */
function sendAiQuestion() {
  var inputEl = document.getElementById("cp-ai-input");
  var sendBtn = document.getElementById("cp-ai-send");
  var question = inputEl ? inputEl.value.trim() : "";
  if (!question || !activeCatKey || !currentProject) return;

  var cat = CATEGORIES.find(function(c) { return c.key === activeCatKey; });

  // Add user message
  if (!aiHistory[activeCatKey]) aiHistory[activeCatKey] = [];
  aiHistory[activeCatKey].push({ role: "user", content: question });
  inputEl.value = "";
  if (sendBtn) sendBtn.disabled = true;
  renderAiHistory();

  // Add loading bubble
  var histEl = document.getElementById("cp-ai-history");
  var loadingId = "ai-loading-" + Date.now();
  if (histEl) {
    var loadingDiv = document.createElement("div");
    loadingDiv.className = "cp-ai-msg assistant";
    loadingDiv.id = loadingId;
    loadingDiv.innerHTML = '<div class="ai-loading"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div></div>';
    histEl.appendChild(loadingDiv);
    scrollAiHistory();
  }

  // Build context from project + category
  var projectContext = "Project: " + (currentProject.name || "Unknown") +
    "\nCapacity: " + (currentProject.capacity_mw || "N/A") + " MWp" +
    "\nStage: " + (currentProject.stage || "N/A") +
    "\nCategory: " + cat.label +
    "\nScore: " + (currentProject[activeCatKey] != null ? currentProject[activeCatKey] + "/100" : "Not yet scored") +
    "\nFields: " + cat.fields.map(function(f) {
      return f.lbl + ": " + (currentProject[f.field] || "Not provided");
    }).join(", ");

  var messages = [{ role: "user", content: "Project context:\n" + projectContext + "\n\nQuestion: " + question }];

  fetch(SUPABASE_URL + "/functions/v1/category-qa", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      project_id: currentProjectId,
      user_id: currentUserId,
      category: activeCatKey,
      question: question,
      history: (aiHistory[activeCatKey] || []).slice(0, -1).map(function(m) {
        return { role: m.role, content: m.content };
      })
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var answer = data.answer || data.error || "No response received.";
    aiHistory[activeCatKey].push({ role: "assistant", content: answer });
    var loadingEl = document.getElementById(loadingId);
    if (loadingEl) loadingEl.remove();
    renderAiHistory();
    if (sendBtn) sendBtn.disabled = false;
  })
  .catch(function(err) {
    var loadingEl = document.getElementById(loadingId);
    if (loadingEl) loadingEl.remove();
    aiHistory[activeCatKey].push({ role: "assistant", content: "Error: " + err.message });
    renderAiHistory();
    if (sendBtn) sendBtn.disabled = false;
  });
}

function renderAiHistory() {
  var histEl = document.getElementById("cp-ai-history");
  if (!histEl || !activeCatKey) return;
  var hist = aiHistory[activeCatKey] || [];
  histEl.innerHTML = hist.map(function(m) {
    return '<div class="cp-ai-msg ' + m.role + '">' + escHtml(m.content) + '</div>';
  }).join("");
  scrollAiHistory();
}

function scrollAiHistory() {
  var histEl = document.getElementById("cp-ai-history");
  if (histEl) histEl.scrollTop = histEl.scrollHeight;
}

/* ---- SHARE ---- */
function openShareModal(catKey) {
  var cat = CATEGORIES.find(function(c) { return c.key === catKey; });
  if (!cat || !currentProjectId) return;
  document.getElementById("share-modal-title").textContent = "Share " + cat.label + " Data";
  document.getElementById("share-url-box").textContent = "Generating link...";
  document.getElementById("share-modal-overlay").classList.add("open");

  // Generate token: store in share_tokens table
  var token = generateToken();
  var expires = new Date();
  expires.setDate(expires.getDate() + 30);

  sb.from("share_tokens").insert({
    token: token,
    project_id: currentProjectId,
    category: catKey,
    created_by: currentUserId,
    expires_at: expires.toISOString()
  }).then(function(res) {
    if (res.error) {
      // Table may not exist yet - show token anyway
      console.warn("share_tokens table missing:", res.error.message);
    }
    var url = window.location.origin + "/share.html?token=" + token;
    shareToken = token;
    document.getElementById("share-url-box").textContent = url;
  });
}

function closeShareModal() {
  document.getElementById("share-modal-overlay").classList.remove("open");
  shareToken = null;
}

function copyShareLink() {
  var box = document.getElementById("share-url-box");
  if (!box) return;
  navigator.clipboard.writeText(box.textContent).then(function() {
    var btn = document.querySelector(".share-copy-btn");
    if (btn) { btn.textContent = "Copied!"; setTimeout(function() { btn.textContent = "Copy Link"; }, 2000); }
  });
}

function generateToken() {
  var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  var token = "";
  for (var i = 0; i < 32; i++) token += chars.charAt(Math.floor(Math.random() * chars.length));
  return token;
}

/* ---- TALLY FORM ---- */
var CAT_TALLY_FORMS = {
  score_permit:       "xXdr2d",
  score_design:       "1ArXEg",
  score_construct:    "0QEdP9",
  score_procurement:  "rjl5Vo",
  score_contract:     "D4VBel",
  score_intercon:     "Gxr6Le",
  score_financial:    "rjl5Vo"
};

function openCatForm(catKey) {
  var cat = CATEGORIES.find(function(c) { return c.key === catKey; });
  var formId = CAT_TALLY_FORMS[catKey];
  if (!formId) { alert("This assessment form is not set up yet."); return; }
  var url = "https://tally.so/embed/" + formId + "?transparentBackground=1&hideTitle=1";
  if (currentUserId)    url += "&user_id="    + encodeURIComponent(currentUserId);
  if (currentProjectId) url += "&project_id=" + encodeURIComponent(currentProjectId);
  document.getElementById("ov-tally-title").textContent = (cat ? cat.label : catKey) + " Assessment";
  document.getElementById("ov-tally-frame").src = url;
  var ov = document.getElementById("ov-tally-overlay");
  ov.style.display = "flex";
  document.body.style.overflow = "hidden";
  startPolling();
}

function closeTallyForm() {
  document.getElementById("ov-tally-overlay").style.display = "none";
  document.getElementById("ov-tally-frame").src = "";
  document.body.style.overflow = "";
  stopPolling();
  reloadProject();
}

function startPolling() {
  stopPolling();
  pollTimer = setInterval(reloadProject, 8000);
}
function stopPolling() {
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}

function reloadProject() {
  if (!currentProjectId || !currentUserId) return;
  sb.from("projects").select("*").eq("id", currentProjectId).eq("user_id", currentUserId).single()
    .then(function(res) {
      if (res.error || !res.data) return;
      currentProject = res.data;
      renderLeft(res.data);
      loadTlDates(res.data);
      // If a cat panel is open, refresh its score band
      if (activeCatKey) {
        var score = currentProject[activeCatKey];
        var color = scoreColor(score);
        var pct   = score != null ? Math.min(100, Math.max(0, score)) : 0;
        var circle = document.querySelector(".cp-score-circle");
        var numEl  = document.querySelector(".cp-score-num");
        var barEl  = document.querySelector(".cp-bar-fill");
        var descEl = document.querySelector(".cp-score-desc");
        if (circle) circle.style.borderColor = color;
        if (numEl)  { numEl.style.color = color; numEl.textContent = score != null ? score : "N/A"; }
        if (barEl)  { barEl.style.width = pct + "%"; barEl.style.background = color; }
        if (descEl) descEl.textContent = score == null ? "Not yet scored" : score >= 70 ? "Good risk profile" : score >= 40 ? "Moderate risk" : "High risk";
      }
    });
}

/* ---- TIMELINE ---- */
function updateTimeline(project) {
  var permitScore   = project.score_permit;
  var designScore   = project.score_design;
  var constructScore = project.score_construct;
  var green  = parseInt(ADMIN_CONFIG["timeline_permit_green"]  || "70");
  var yellow = parseInt(ADMIN_CONFIG["timeline_permit_yellow"] || "40");

  function tlStatus(score) {
    if (score == null) return "grey";
    if (score >= green)  return "green";
    if (score >= yellow) return "yellow";
    return "red";
  }

  function tlLabel(score, stage) {
    if (score == null) return "Not started";
    if (score >= green)  return stage + " complete";
    if (score >= yellow) return "In progress";
    return "Action required";
  }

  setTl("permit",   tlStatus(permitScore),    tlLabel(permitScore,    "Permitting"));
  setTl("design",   tlStatus(designScore),    tlLabel(designScore,    "Engineering"));
  setTl("construct",tlStatus(constructScore), tlLabel(constructScore, "Construction"));

  // COD: green only if all three are green
  var allGreen = tlStatus(permitScore) === "green" && tlStatus(designScore) === "green" && tlStatus(constructScore) === "green";
  var anyStarted = permitScore != null || designScore != null || constructScore != null;
  setTl("cod", allGreen ? "green" : anyStarted ? "grey" : "grey", allGreen ? "Target reached" : "Pending");
}

function setTl(id, status, label) {
  var dot = document.getElementById("tl-" + id);
  var lbl = document.getElementById("tl-" + id + "-status");
  if (dot) {
    dot.className = "tl-dot " + status;
  }
  if (lbl) lbl.textContent = label;
}

function buildCatTimeline(catKey) {
  var milestones = CAT_MILESTONES[catKey] || [];
  if (!milestones.length) return '';
  var steps = milestones.map(function(m, i) {
    var last = i === milestones.length - 1;
    var pb = last ? ' style="padding-bottom:0;"' : '';
    return '<div class="tl-step">' +
      '<div class="tl-dot-wrap"><div class="tl-dot grey" id="ctld-' + m.key + '"></div></div>' +
      '<div class="tl-info"' + pb + '>' +
        '<div class="tl-label" style="font-size:10px;">' + m.label + '</div>' +
        '<div style="display:flex;align-items:center;gap:5px;margin-top:3px;">' +
          '<select class="ctld-status" data-key="' + m.key + '" onchange="saveCatMilestone(\'' + m.key + '\',this.value,document.getElementById(\'' + 'ctld-date-' + m.key + '\').value)" style="font-size:9px;padding:2px 5px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:5px;color:#aaa;font-family:Inter,sans-serif;outline:none;cursor:pointer;">' +
            '<option value="">Not started</option>' +
            '<option value="in_progress">In progress</option>' +
            '<option value="complete">Complete</option>' +
          '</select>' +
          '<input class="ctld-date" id="ctld-date-' + m.key + '" data-key="' + m.key + '" type="date" onchange="saveCatMilestone(\'' + m.key + '\',document.querySelector(\'[data-key=' + m.key + '].ctld-status\').value,this.value)" style="font-size:9px;padding:2px 5px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:5px;color:#aaa;font-family:Inter,sans-serif;outline:none;cursor:pointer;"/>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');
  return '<div class="cp-fields-card">' +
    '<div class="cp-fields-hdr"><span class="cp-fields-title">Milestones</span></div>' +
    '<div style="padding:10px 16px;"><div class="timeline-body" style="padding:0;">' +
    steps +
    '</div></div></div>';
}

/* ---- CATEGORY MILESTONES ---- */
function saveCatMilestone(key, status, date) {
  if (!currentProjectId || !currentUserId) return;
  var tally = Object.assign({}, currentProject.tally_fields || {});
  tally['ms_status_' + key] = status || '';
  tally['ms_date_'   + key] = date   || '';
  currentProject.tally_fields = tally;
  // Update dot colour
  var dot = document.getElementById('ctld-' + key);
  if (dot) {
    dot.className = 'tl-dot ' + (status === 'complete' ? 'green' : status === 'in_progress' ? 'yellow' : 'grey');
  }
  sb.from('projects').update({ tally_fields: tally, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(res) { if (res.error) console.error('Milestone save failed:', res.error.message); });
}

function loadCatMilestones(catKey, project) {
  var milestones = CAT_MILESTONES[catKey] || [];
  var tally = project.tally_fields || {};
  milestones.forEach(function(m) {
    var statusEl = document.querySelector('[data-key="' + m.key + '"].ctld-status');
    var dateEl   = document.getElementById('ctld-date-' + m.key);
    var dot      = document.getElementById('ctld-' + m.key);
    var status   = tally['ms_status_' + m.key] || '';
    var date     = tally['ms_date_'   + m.key] || '';
    if (statusEl) statusEl.value = status;
    if (dateEl)   dateEl.value   = date;
    if (dot) dot.className = 'tl-dot ' + (status === 'complete' ? 'green' : status === 'in_progress' ? 'yellow' : 'grey');
  });
}

/* ---- TIMELINE DATES ---- */
function saveTlDate(milestone, value) {
  if (!currentProjectId || !currentUserId) return;
  var field = 'tl_date_' + milestone;
  var tally = Object.assign({}, currentProject.tally_fields || {});
  tally[field] = value;
  currentProject.tally_fields = tally;
  sb.from('projects').update({ tally_fields: tally, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(res) {
      if (res.error) console.error('Date save failed:', res.error.message);
    });
}

function loadTlDates(project) {
  var tally = project.tally_fields || {};
  var milestones = ['permit','design','construct','cod'];
  milestones.forEach(function(m) {
    var el = document.getElementById('tl-' + m + '-date');
    if (el && tally['tl_date_' + m]) el.value = tally['tl_date_' + m];
  });
}

/* ---- AUTH & DATA ---- */
var authTimeout = setTimeout(function() {
  if (!authResolved) window.location.href = "login.html";
}, 6000);

sb.auth.onAuthStateChange(function(event, session) {
  if (session && session.user) {
    authResolved = true;
    clearTimeout(authTimeout);
    document.body.classList.remove("hidden");
    currentUserId = session.user.id;
    loadProject(session.user.id);
  } else if (event === "SIGNED_OUT") {
    window.location.href = "login.html";
  }
});

function loadProject(userId) {
  var params = new URLSearchParams(window.location.search);
  var projectId = params.get("id");
  if (!projectId) { window.location.href = "dashboard.html"; return; }
  sb.from("projects").select("*").eq("id", projectId).eq("user_id", userId).single()
    .then(function(res) {
      if (res.error || !res.data) { window.location.href = "dashboard.html"; return; }
      var p = res.data;
      currentProject   = p;
      currentProjectId = p.id;
      var stageShort = (p.stage || "").replace(/\s*\(.*?\)/g, "").trim();
      stageShort = stageShort.split(" - ").map(function(s) {
        return s.replace(/\s*\(.*?\)/g, "").trim();
      }).join(" - ");
      document.getElementById("hero-name").textContent = p.name || "Unnamed Project";
      document.getElementById("hero-sub").textContent = [
        p.capacity_mw ? p.capacity_mw + " MWp" : null,
        stageShort || null
      ].filter(Boolean).join("  -  ");
      document.getElementById("inf-capacity").textContent = p.capacity_mw ? p.capacity_mw + " MWp" : "-";
      document.getElementById("inf-stage").textContent    = stageShort || "-";
      document.getElementById("inf-status").textContent   = (p.status || "-").replace(/-/g, " ");
      document.getElementById("inf-date").textContent     = new Date(p.created_at).toLocaleDateString("en-GB", {day:"2-digit",month:"short",year:"numeric"});
      var locEl = document.getElementById("inf-location");
      if (p.location && p.location.startsWith("http")) {
        locEl.innerHTML = '<a href="' + p.location + '" target="_blank">Maps</a>';
      } else {
        locEl.textContent = p.location || "-";
      }
      document.getElementById("info-card").style.display = "block";
      renderLeft(p);
      loadTlDates(p);
      loadDocsMini();
      generateSummary(false);
    });
}

/* =============================================
   DOCUMENT PANEL ‚Äî DD CHECKLIST ENGINE
   ============================================= */

var projectDocuments = [];
var activeDocId = null;
var uploadingCatKey = null;

/* ‚îÄ‚îÄ DD CHECKLIST DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
var DD_CATS = [
  {
    key: 'permit', label: 'Permits & Entitlements', color: '#c0392b',
    checklist: [
      'Zoning confirmation and Conditional/Special Use Permit approval',
      'ALTA Survey and Title Commitment review',
      'Environmental approvals (ESA, wetlands, species, cultural)',
      'Stormwater permits (NPDES) and SWPPP',
      'Building, grading, electrical permits',
      'FAA determination (if applicable)',
      'Approved decommissioning plan and security'
    ],
    priority: [
      'Conditional Use Permit (conditions of approval, transferability, operating restrictions)',
      'Phase I Environmental Site Assessment (and Phase II if applicable)',
      'ALTA Title Commitment and Survey (Schedule B-II exceptions, easements, mineral rights)'
    ]
  },
  {
    key: 'design', label: 'Design & Engineering', color: '#2471a3',
    checklist: [
      'Energy Yield Assessment (P50/P90/P99)',
      'Geotechnical report',
      'Civil grading and drainage design',
      'Single-line diagram (IFC)',
      'Electrical studies (short circuit, grounding, arc flash)',
      'Structural calculations (ASCE 7 compliant)',
      'Independent Engineer review'
    ],
    priority: [
      'Energy Yield Assessment (resource assumptions, degradation, curtailment)',
      'Geotechnical Report (soil risk, corrosion, pile refusal)',
      'Issued-for-Construction Single Line Diagram'
    ]
  },
  {
    key: 'construct', label: 'Construction', color: '#d35400',
    checklist: [
      'Executed EPC agreement',
      'Detailed construction budget',
      'Project schedule (critical path)',
      'Performance and payment bonds',
      'HSE and QA/QC plans'
    ],
    priority: [
      'Executed EPC Agreement (LDs, guarantees, change orders, force majeure)',
      'Critical Path Schedule',
      'Detailed Line-Item Construction Budget'
    ]
  },
  {
    key: 'procurement', label: 'Procurement', color: '#7d3c98',
    checklist: [
      'Module supply agreement',
      'Inverter supply agreement',
      'Tracker/racking agreement',
      'Transformer procurement',
      'Warranty documentation',
      'Domestic content documentation (if applicable)'
    ],
    priority: [
      'Module Supply Agreement (delivery terms, LDs, insolvency protection)',
      'Module Warranty Certificate (performance curve alignment)',
      'Domestic Content Documentation Package'
    ]
  },
  {
    key: 'contract', label: 'Legal', color: '#1e8449',
    checklist: [
      'Executed land lease or purchase agreement',
      'Recorded memorandum of lease',
      'Title insurance policy',
      'Executed Power Purchase Agreement (PPA)',
      'Tax credit legal opinion (ITC/PTC)',
      'Insurance program documentation'
    ],
    priority: [
      'Power Purchase Agreement (curtailment, termination, credit support)',
      'Land Lease Agreement (assignment, subordination, termination rights)',
      'ITC/PTC Tax Opinion'
    ]
  },
  {
    key: 'intercon', label: 'Grid Connection', color: '#117a65',
    checklist: [
      'Feasibility, System Impact, and Facilities Studies',
      'Executed Interconnection Agreement',
      'Network upgrade cost breakdown',
      'Security postings',
      'Deliverability and capacity accreditation documentation'
    ],
    priority: [
      'Executed Interconnection Agreement (milestones, upgrade costs, curtailment)',
      'Facilities Study (final scope and cost responsibility)',
      'Deliverability / Capacity Accreditation Letter'
    ]
  },
  {
    key: 'financial', label: 'Finance', color: '#1a5276',
    checklist: [
      'Fully functional financial model (native format)',
      'Model audit report',
      'Debt term sheet',
      'Tax equity commitment letter',
      'Sources & Uses statement',
      'Sensitivity analyses'
    ],
    priority: [
      'Financial Model (revenue stack, DSCR, tax credits)',
      'Independent Model Audit Report',
      'Tax Equity Commitment Letter (conditions precedent, flip terms)'
    ]
  }
];

var checklistState = {};   // { catKey_itemIdx: true/false }
var openCats = {};         // { catKey: true/false }

/* ‚îÄ‚îÄ PANEL OPEN / CLOSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function openDocPanel() {
  if (typeof closeCatPanel === 'function') closeCatPanel();
  document.getElementById('main-overview').style.display = 'none';
  document.getElementById('cat-panel').classList.remove('open');
  document.getElementById('doc-panel').classList.add('open');
  loadDocuments();
}

function closeDocPanel() {
  document.getElementById('doc-panel').classList.remove('open');
  document.getElementById('main-overview').style.display = 'block';
}

/* ‚îÄ‚îÄ LOAD DOCUMENTS + STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function loadDocuments() {
  if (!currentProjectId || !currentUserId) return;
  // Load checklist state from tally_fields
  var saved = (currentProject && currentProject.tally_fields) || {};
  Object.keys(saved).forEach(function(k) {
    if (k.startsWith('dd_check_')) checklistState[k] = saved[k];
  });

  sb.from('project_documents')
    .select('*')
    .eq('project_id', currentProjectId)
    .order('created_at', { ascending: false })
    .then(function(res) {
      if (res.error) { console.error(res.error); return; }
      projectDocuments = res.data || [];
      buildDocPanel();
      renderMiniList();
    });
}

/* ‚îÄ‚îÄ BUILD FULL PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildDocPanel() {
  buildProgressBar();
  buildCatSections();
  updateGlobalCounts();
}

function buildProgressBar() {
  var html = DD_CATS.map(function(cat) {
    var docs = docsForCat(cat.key);
    var checks = checksForCat(cat.key);
    var total = cat.checklist.length + cat.priority.length;
    var done = checks + Math.min(docs.length, cat.priority.length);
    var pct = total ? Math.round(done / total * 100) : 0;
    var cls = pct === 100 ? 'complete' : pct > 0 ? 'partial' : 'empty';
    return '<div class="dp-prog-cat">' +
      '<div class="dp-prog-cat-ring ' + cls + '">' + pct + '%</div>' +
      '<div class="dp-prog-cat-name">' + escHtml(cat.label) + '</div>' +
    '</div>';
  }).join('');
  document.getElementById('dp-prog-cats').innerHTML = html;
}

function buildCatSections() {
  var container = document.getElementById('dp-cat-sections');
  container.innerHTML = '';
  DD_CATS.forEach(function(cat, idx) {
    container.appendChild(buildCatCard(cat, idx));
  });
}

function buildCatCard(cat, idx) {
  var wrap = document.createElement('div');
  wrap.className = 'dd-cat-card';
  wrap.id = 'ddcat-' + cat.key;

  var docs = docsForCat(cat.key);
  var checkedCount = checksForCat(cat.key);
  var totalChecks = cat.checklist.length;
  var pillCls = checkedCount === totalChecks ? 'done' : checkedCount > 0 ? 'part' : 'none';
  var priorityUploaded = priorityUploadedCount(cat);
  var isOpen = openCats[cat.key] || false;

  // Header
  var hdr = document.createElement('div');
  hdr.className = 'dd-cat-hdr' + (isOpen ? ' open' : '');
  hdr.innerHTML =
    '<div class="dd-cat-num" style="background:' + cat.color + '">' + (idx+1) + '</div>' +
    '<span class="dd-cat-name">' + escHtml(cat.label) + '</span>' +
    '<div class="dd-cat-meta">' +
      '<span class="dd-cat-check-pill ' + pillCls + '">' + checkedCount + '/' + totalChecks + ' checks</span>' +
      '<span class="dd-cat-file-pill">&#128196; ' + docs.length + ' file' + (docs.length !== 1 ? 's' : '') + '</span>' +
      '<span class="dd-cat-check-pill ' + (priorityUploaded === cat.priority.length ? 'done' : priorityUploaded > 0 ? 'part' : 'none') + '">&#9733; ' + priorityUploaded + '/' + cat.priority.length + '</span>' +
    '</div>' +
    '<span class="dd-cat-chevron' + (isOpen ? ' open' : '') + '">&#9660;</span>';
  hdr.onclick = function() { toggleCatAccordion(cat.key); };
  wrap.appendChild(hdr);

  // Body
  var body = document.createElement('div');
  body.className = 'dd-cat-body' + (isOpen ? ' open' : '');
  body.id = 'ddbody-' + cat.key;

  // 1. Checklist section
  var clHtml = '<div class="dd-section"><div class="dd-section-title">Full Checklist</div>';
  cat.checklist.forEach(function(item, i) {
    var stateKey = 'dd_check_' + cat.key + '_' + i;
    var checked = checklistState[stateKey] ? true : false;
    var cbId = 'cb-' + cat.key + '-' + i;
    clHtml +=
      '<div class="dd-check-item">' +
        '<input type="checkbox" class="dd-check-cb" id="' + cbId + '"' + (checked ? ' checked' : '') +
          ' onchange="toggleCheck(\'' + cat.key + '\',' + i + ',this.checked)"/>' +
        '<label class="dd-check-lbl' + (checked ? ' done' : '') + '" for="' + cbId + '">' + escHtml(item) + '</label>' +
      '</div>';
  });
  clHtml += '</div>';

  // 2. Priority documents section
  var prHtml = '<div class="dd-section"><div class="dd-section-title">&#9733; Priority Documents to Inspect</div>';
  cat.priority.forEach(function(pname, pi) {
    // Find a doc whose file_name loosely matches this priority item keyword
    var matchedDoc = findMatchingDoc(cat.key, pname);
    var badge = matchedDoc
      ? '<span class="dd-priority-badge uploaded">&#10003; Uploaded</span>' +
        '<button class="dd-view-link" onclick="previewDoc(\'' + escHtml(matchedDoc.id) + '\')">View</button>'
      : '<span class="dd-priority-badge missing">Missing</span>';
    prHtml +=
      '<div class="dd-priority-item">' +
        '<span class="dd-priority-star">&#9733;</span>' +
        '<span class="dd-priority-name">' + escHtml(pname) + '</span>' +
        badge +
      '</div>';
  });
  prHtml += '</div>';

  // 3. Uploaded files for this category
  var filesHtml = '<div class="dd-files-section"><div class="dd-section-title">Uploaded Files</div>';
  if (docs.length) {
    docs.forEach(function(doc) {
      var ext = docExt(doc.file_name);
      var icon = docIcon(ext);
      filesHtml +=
        '<div class="dd-file-row">' +
          '<span class="dd-file-icon">' + icon + '</span>' +
          '<div class="dd-file-info">' +
            '<div class="dd-file-name" title="' + escHtml(doc.file_name) + '">' + escHtml(doc.file_name) + '</div>' +
            '<div class="dd-file-meta">' + fmtBytes(doc.file_size) + ' &nbsp;¬∑&nbsp; ' + fmtDate(doc.created_at) + '</div>' +
          '</div>' +
          '<div class="dd-file-actions">' +
            '<button class="dd-file-preview" onclick="previewDoc(\'' + doc.id + '\')">Preview</button>' +
            '<button class="dd-file-rm" onclick="removeDoc(\'' + doc.id + '\',\'' + escHtml(doc.file_name) + '\',\'' + cat.key + '\')">Remove</button>' +
          '</div>' +
        '</div>';
    });
  } else {
    filesHtml += '<div class="dd-files-empty">No files uploaded for this category yet.</div>';
  }
  filesHtml += '</div>';

  // 4. Upload row
  var upHtml =
    '<div class="dd-upload-row">' +
      '<div class="dd-dropzone" id="ddzone-' + cat.key + '"' +
        ' onclick="triggerCatUpload(\'' + cat.key + '\')"' +
        ' ondragover="event.preventDefault();this.classList.add(\'drag-over\')"' +
        ' ondragleave="this.classList.remove(\'drag-over\')"' +
        ' ondrop="handleCatDrop(event,\'' + cat.key + '\')">' +
        '<span class="dd-dropzone-icon">&#128196;</span>' +
        '<span class="dd-dropzone-text">Drop file here or click Upload</span>' +
      '</div>' +
      '<button class="dd-upload-btn" onclick="triggerCatUpload(\'' + cat.key + '\')">&#8679; Upload</button>' +
    '</div>' +
    '<div class="dd-upload-progress" id="ddprog-' + cat.key + '">' +
      '<div class="dd-prog-bar"><div class="dd-prog-fill" id="ddprogfill-' + cat.key + '" style="width:0%"></div></div>' +
      '<span class="dd-prog-txt" id="ddprogtxt-' + cat.key + '">Uploading...</span>' +
    '</div>' +
    '<div class="dd-upload-err" id="dderr-' + cat.key + '"></div>';

  body.innerHTML = clHtml + prHtml + filesHtml + upHtml;
  wrap.appendChild(body);
  return wrap;
}

/* ‚îÄ‚îÄ ACCORDION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function toggleCatAccordion(catKey) {
  openCats[catKey] = !openCats[catKey];
  var body = document.getElementById('ddbody-' + catKey);
  var card = document.getElementById('ddcat-' + catKey);
  if (!body || !card) return;
  var isOpen = openCats[catKey];
  body.classList.toggle('open', isOpen);
  var chevron = card.querySelector('.dd-cat-chevron');
  if (chevron) chevron.classList.toggle('open', isOpen);
}

/* ‚îÄ‚îÄ CHECKLIST TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function toggleCheck(catKey, itemIdx, checked) {
  var stateKey = 'dd_check_' + catKey + '_' + itemIdx;
  checklistState[stateKey] = checked;

  // Update label style
  var lbl = document.querySelector('label[for="cb-' + catKey + '-' + itemIdx + '"]');
  if (lbl) lbl.classList.toggle('done', checked);

  // Persist to tally_fields
  if (!currentProjectId || !currentUserId) return;
  var tally = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  tally[stateKey] = checked;
  if (currentProject) currentProject.tally_fields = tally;
  sb.from('projects').update({ tally_fields: tally, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function() {
      // Refresh pill counts in header
      refreshCatHeader(catKey);
      updateGlobalCounts();
      buildProgressBar();
    });
}

function checksForCat(catKey) {
  var cat = DD_CATS.find(function(c) { return c.key === catKey; });
  if (!cat) return 0;
  var count = 0;
  cat.checklist.forEach(function(_, i) {
    if (checklistState['dd_check_' + catKey + '_' + i]) count++;
  });
  return count;
}

/* ‚îÄ‚îÄ PRIORITY MATCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function findMatchingDoc(catKey, priorityName) {
  // Docs tagged to this category
  var catDocs = docsForCat(catKey);
  if (!catDocs.length) return null;
  // Extract key words from priority name (first 2 meaningful words)
  var keywords = priorityName.toLowerCase()
    .replace(/[^a-z0-9 ]/g, ' ')
    .split(/\s+/)
    .filter(function(w) { return w.length > 3; })
    .slice(0, 3);
  return catDocs.find(function(doc) {
    var fname = doc.file_name.toLowerCase();
    return keywords.some(function(kw) { return fname.includes(kw); });
  }) || null;
}

function priorityUploadedCount(cat) {
  return cat.priority.filter(function(p) { return findMatchingDoc(cat.key, p); }).length;
}

/* ‚îÄ‚îÄ REFRESH CAT HEADER (after check/upload) ‚îÄ‚îÄ */
function refreshCatHeader(catKey) {
  var cat = DD_CATS.find(function(c) { return c.key === catKey; });
  if (!cat) return;
  var card = document.getElementById('ddcat-' + catKey);
  if (!card) return;
  var docs = docsForCat(catKey);
  var checkedCount = checksForCat(catKey);
  var totalChecks = cat.checklist.length;
  var pillCls = checkedCount === totalChecks ? 'done' : checkedCount > 0 ? 'part' : 'none';
  var priorityUploaded = priorityUploadedCount(cat);
  var priCls = priorityUploaded === cat.priority.length ? 'done' : priorityUploaded > 0 ? 'part' : 'none';
  var meta = card.querySelector('.dd-cat-meta');
  if (meta) {
    meta.innerHTML =
      '<span class="dd-cat-check-pill ' + pillCls + '">' + checkedCount + '/' + totalChecks + ' checks</span>' +
      '<span class="dd-cat-file-pill">&#128196; ' + docs.length + ' file' + (docs.length !== 1 ? 's' : '') + '</span>' +
      '<span class="dd-cat-check-pill ' + priCls + '">&#9733; ' + priorityUploaded + '/' + cat.priority.length + '</span>';
  }
}

function updateGlobalCounts() {
  var totalChecks = 0, doneChecks = 0, totalPri = 0, donePri = 0;
  DD_CATS.forEach(function(cat) {
    totalChecks += cat.checklist.length;
    doneChecks  += checksForCat(cat.key);
    totalPri    += cat.priority.length;
    donePri     += priorityUploadedCount(cat);
  });
  var cc = document.getElementById('dp-check-count');
  var pc = document.getElementById('dp-priority-count');
  if (cc) cc.textContent = doneChecks + ' / ' + totalChecks;
  if (pc) pc.textContent = donePri + ' / ' + totalPri;
}

/* ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function triggerCatUpload(catKey) {
  uploadingCatKey = catKey;
  var inp = document.getElementById('dp-file-input');
  inp.value = '';
  inp.click();
}

function handleCatDrop(e, catKey) {
  e.preventDefault();
  document.getElementById('ddzone-' + catKey).classList.remove('drag-over');
  var files = e.dataTransfer && e.dataTransfer.files;
  if (files && files.length) { uploadingCatKey = catKey; handleCatFileSelect(files); }
}

function handleCatFileSelect(files) {
  if (!files || !files.length) return;
  var file = files[0];
  if (file.size > 52428800) { showCatErr(uploadingCatKey, 'File exceeds 50 MB limit.'); return; }
  uploadCatDoc(file, uploadingCatKey);
}

function showCatErr(catKey, msg) {
  var el = document.getElementById('dderr-' + catKey);
  if (!el) return;
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(function() { el.style.display = 'none'; }, 4000);
}

function uploadCatDoc(file, catKey) {
  if (!currentProjectId || !currentUserId) return;
  var prog = document.getElementById('ddprog-' + catKey);
  var fill = document.getElementById('ddprogfill-' + catKey);
  var txt  = document.getElementById('ddprogtxt-' + catKey);
  var errEl = document.getElementById('dderr-' + catKey);
  if (prog) prog.style.display = 'flex';
  if (fill) fill.style.width = '10%';
  if (txt)  txt.textContent = 'Uploading‚Ä¶';
  if (errEl) errEl.style.display = 'none';

  var safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
  var path = currentProjectId + '/' + Date.now() + '_' + safeName;

  sb.storage.from('project_docs').upload(path, file, { upsert: false })
    .then(function(res) {
      if (res.error) {
        if (prog) prog.style.display = 'none';
        showCatErr(catKey, 'Upload failed: ' + res.error.message);
        return null;
      }
      if (fill) fill.style.width = '70%';
      if (txt)  txt.textContent = 'Saving‚Ä¶';
      var urlRes = sb.storage.from('project_docs').getPublicUrl(path);
      var publicUrl = (urlRes.data && urlRes.data.publicUrl) || '';
      return sb.from('project_documents').insert({
        project_id: currentProjectId,
        user_id:    currentUserId,
        file_name:  file.name,
        file_path:  path,
        file_size:  file.size,
        file_type:  file.type || 'application/octet-stream',
        tag:        catKey,
        public_url: publicUrl
      });
    })
    .then(function(res) {
      if (!res) return;
      if (res.error) {
        if (prog) prog.style.display = 'none';
        showCatErr(catKey, 'Save failed: ' + res.error.message);
        return;
      }
      if (fill) fill.style.width = '100%';
      if (txt)  txt.textContent = 'Done!';
      setTimeout(function() {
        if (prog) { prog.style.display = 'none'; }
        if (fill) fill.style.width = '0%';
        document.getElementById('dp-file-input').value = '';
      }, 700);
      // Reload and rebuild
      sb.from('project_documents').select('*').eq('project_id', currentProjectId)
        .order('created_at', { ascending: false })
        .then(function(r) {
          if (!r.error) { projectDocuments = r.data || []; }
          buildDocPanel();
          // Re-open the accordion that was uploading
          openCats[catKey] = true;
          var body = document.getElementById('ddbody-' + catKey);
          if (body) body.classList.add('open');
          var card = document.getElementById('ddcat-' + catKey);
          if (card) { var ch = card.querySelector('.dd-cat-chevron'); if (ch) ch.classList.add('open'); }
          renderMiniList();
        });
    })
    .catch(function(err) {
      if (prog) prog.style.display = 'none';
      showCatErr(catKey, 'Error: ' + err.message);
    });
}

/* ‚îÄ‚îÄ REMOVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function removeDoc(docId, fileName, catKey) {
  if (!confirm('Remove "' + fileName + '"?')) return;
  var doc = projectDocuments.find(function(d) { return d.id === docId; });
  var delStorage = (doc && doc.file_path)
    ? sb.storage.from('project_docs').remove([doc.file_path])
    : Promise.resolve();
  delStorage.then(function() {
    return sb.from('project_documents').delete().eq('id', docId).eq('user_id', currentUserId);
  }).then(function(res) {
    if (res && res.error) { alert('Remove failed: ' + res.error.message); return; }
    projectDocuments = projectDocuments.filter(function(d) { return d.id !== docId; });
    buildDocPanel();
    openCats[catKey] = true; // keep accordion open
    var body = document.getElementById('ddbody-' + catKey);
    if (body) body.classList.add('open');
    renderMiniList();
  });
}

/* ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function previewDoc(docId) {
  var doc = projectDocuments.find(function(d) { return d.id === docId; });
  if (!doc) return;
  activeDocId = docId;
  var overlay = document.getElementById('dp-preview-overlay');
  var nameEl  = document.getElementById('dp-preview-name');
  var wrap    = document.getElementById('dp-preview-frame-wrap');
  if (!overlay) return;
  nameEl.textContent = doc.file_name;
  overlay.classList.add('open');
  var ext = docExt(doc.file_name);
  var url = doc.public_url;
  var canEmbed = ['pdf','jpg','jpeg','png','gif','webp','svg'].includes(ext);
  if (url && ext === 'pdf') {
    wrap.innerHTML = '<iframe class="dp-preview-iframe" src="' + escHtml(url) + '#toolbar=0"></iframe>';
  } else if (url && ['jpg','jpeg','png','gif','webp','svg'].includes(ext)) {
    wrap.innerHTML = '<div class="dp-preview-img-wrap"><img src="' + escHtml(url) + '" alt="' + escHtml(doc.file_name) + '"/></div>';
  } else {
    wrap.innerHTML = '<div class="dp-preview-no-preview"><p>No preview available for this file type.</p></div>';
  }
}

function closePreview() {
  document.getElementById('dp-preview-overlay').classList.remove('open');
  document.getElementById('dp-preview-frame-wrap').innerHTML = '';
  activeDocId = null;
}

function downloadActiveDoc() {
  if (!activeDocId) return;
  var doc = projectDocuments.find(function(d) { return d.id === activeDocId; });
  if (!doc) return;
  if (doc.public_url) { window.open(doc.public_url, '_blank'); return; }
  sb.storage.from('project_docs').createSignedUrl(doc.file_path, 3600).then(function(res) {
    if (res.data && res.data.signedUrl) window.open(res.data.signedUrl, '_blank');
  });
}

/* ‚îÄ‚îÄ MINI LIST (sidebar card) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderMiniList() {
  var list  = document.getElementById('upload-mini-list');
  var empty = document.getElementById('upload-mini-empty');
  if (!list) return;
  Array.from(list.querySelectorAll('.upload-doc-item')).forEach(function(el) { el.remove(); });
  if (!projectDocuments.length) { if (empty) empty.style.display = 'block'; return; }
  if (empty) empty.style.display = 'none';
  var catMap = {};
  DD_CATS.forEach(function(c) { catMap[c.key] = c.label; });
  projectDocuments.slice(0, 3).forEach(function(doc) {
    var item = document.createElement('div');
    item.className = 'upload-doc-item';
    var tagLabel = (catMap[doc.tag] || doc.tag || 'File').split(' ')[0];
    item.innerHTML =
      '<span class="upload-doc-name" title="' + escHtml(doc.file_name) + '">' + escHtml(doc.file_name) + '</span>' +
      '<span class="upload-doc-type">' + escHtml(tagLabel) + '</span>' +
      '<button class="upload-doc-view" onclick="openDocPanel()">View</button>';
    list.insertBefore(item, list.firstChild);
  });
}

function loadDocsMini() {
  if (!currentProjectId || !currentUserId) return;
  sb.from('project_documents').select('id,file_name,tag,created_at')
    .eq('project_id', currentProjectId)
    .order('created_at', { ascending: false }).limit(3)
    .then(function(res) {
      if (!res.error) { projectDocuments = res.data || []; renderMiniList(); }
    });
}

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function docsForCat(catKey) {
  return projectDocuments.filter(function(d) { return d.tag === catKey; });
}

function docExt(name) { return (name.split('.').pop() || '').toLowerCase(); }
function docIcon(ext) {
  if (ext === 'pdf') return 'üìÑ';
  if (['jpg','jpeg','png','gif','webp','svg'].includes(ext)) return 'üñºÔ∏è';
  if (['xls','xlsx','csv'].includes(ext)) return 'üìä';
  if (['doc','docx'].includes(ext)) return 'üìù';
  return 'üìé';
}
function fmtBytes(b) {
  if (!b) return '';
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}
function fmtDate(iso) { return new Date(iso).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); }

function generateSummary(forceRegen) {
  if (!currentProjectId || !currentUserId) return;
  if (summaryRunning && !forceRegen) return;
  summaryRunning = true;
  var contentEl = document.getElementById("ai-content");
  var regenBtn  = document.getElementById("btn-regen");
  contentEl.innerHTML = '<div class="ai-loading"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div><span>' + (forceRegen ? "Regenerating..." : "Generating brief...") + "</span></div>";
  regenBtn.style.display = "none";
  function callEdge() {
    fetch(SUPABASE_URL + "/functions/v1/generate-overview", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ project_id: currentProjectId, user_id: currentUserId, force: forceRegen })
    })
    .then(function(r) { if (!r.ok) return r.text().then(function(t) { throw new Error("HTTP " + r.status + ": " + t); }); return r.json(); })
    .then(function(data) {
      summaryRunning = false;
      if (data.error) {
        contentEl.innerHTML = '<div class="ai-error">Error: ' + data.error + "</div>";
      } else {
        var paras = (data.summary || "").split(/\n+/).filter(function(p) { return p.trim(); });
        contentEl.innerHTML = '<div class="ai-text">' + paras.map(function(p) { return "<p>" + p.trim() + "</p>"; }).join("") + "</div>";
      }
      regenBtn.style.display = "inline-block";
    })
    .catch(function(err) {
      summaryRunning = false;
      contentEl.innerHTML = '<div class="ai-error">Error: ' + err.message + "</div>";
      regenBtn.style.display = "inline-block";
    });
  }
  if (forceRegen) {
    sb.from("projects").update({ ai_summary: null, ai_summary_at: null }).eq("id", currentProjectId)
      .then(function() { callEdge(); }).catch(function() { callEdge(); });
  } else { callEdge(); }
}
</script>
<script type="text/javascript">window.$crisp=[];window.CRISP_WEBSITE_ID="49df8fc4-e9b9-4f8d-b357-680e84e62c67";(function(){d=document;s=d.createElement("script");s.src="https://client.crisp.chat/l.js";s.async=1;d.getElementsByTagName("head")[0].appendChild(s);})();</script>
</body>
</html>
