<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash - Project Overview</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #eef0f4; color: #1a1f2e; min-height: 100vh; }
body.hidden { visibility: hidden; }
a { text-decoration: none; }
.topbar { position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; background: #111; border-bottom: 3px solid #FFFF00; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
.logo { font-size: 22px; font-weight: 900; letter-spacing: 0.3px; text-transform: uppercase; color: #fff; }
.logo span { color: #FFFF00; }
.tb-right { display: flex; align-items: center; gap: 10px; }
.btn-back { padding: 7px 16px; border: none; background: rgba(255,255,255,0.1); color: #aaa; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; text-transform: uppercase; border-radius: 20px; cursor: pointer; }
.btn-back:hover { background: rgba(255,255,255,0.2); color: #fff; }
.btn-out { background: none; border: 1px solid #444; color: #777; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; padding: 7px 14px; cursor: pointer; text-transform: uppercase; border-radius: 20px; }
.btn-out:hover { border-color: #E83535; color: #E83535; }
.page { padding-top: 56px; }
.hero { background: #111; padding: 20px 14px 18px; }
.hero-tag { font-size: 10px; font-weight: 700; letter-spacing: 0.6px; text-transform: uppercase; color: #FFFF00; margin-bottom: 5px; opacity: 0.8; }
.hero h1 { font-size: 28px; font-weight: 900; letter-spacing: -0.8px; color: #fff; line-height: 1; }
.hero-sub { font-size: 12px; color: #555; margin-top: 5px; }

/* 3-column layout */
.layout { display: grid; grid-template-columns: 210px 1fr 210px; gap: 10px; padding: 12px 12px 60px; align-items: start; }

/* LEFT COLUMN */
.left-col { display: flex; flex-direction: column; gap: 8px; }
.score-card { background: #1a1f2e; border-radius: 12px; padding: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); text-align: center; }
.score-card-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #FFFF00; opacity: 0.7; margin-bottom: 8px; }
.score-ring { width: 72px; height: 72px; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.06); border: 3px solid rgba(255,255,255,0.08); transition: border-color .4s; }
.score-ring-val { font-size: 26px; font-weight: 900; color: #fff; letter-spacing: -1px; line-height: 1; }
.score-ring-sub { font-size: 9px; color: #555; margin-top: 1px; }
.score-ring-none { font-size: 11px; color: #444; font-weight: 600; }
.score-card-desc { font-size: 10px; color: #444; line-height: 1.5; }
.cat-item { background: #dde1ea; border-radius: 10px; padding: 9px 11px; box-shadow: 0 1px 5px rgba(0,0,0,0.06); transition: transform .12s, box-shadow .12s; }
.cat-item:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
.cat-item.active { box-shadow: 0 0 0 2px #1a1f2e; }
.cat-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.cat-name { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.3px; color: #1a1f2e; }
.cat-score-lbl { font-size: 9px; font-weight: 700; color: #6b7585; }
.cat-bar-track { height: 3px; background: rgba(0,0,0,0.1); border-radius: 2px; overflow: hidden; margin-bottom: 7px; }
.cat-bar-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }
.cat-btn-row { display: grid; gap: 5px; }
.cat-btn-row.two { grid-template-columns: 1fr 1fr; }
.cat-start-btn { display: block; width: 100%; padding: 4px 6px; background: rgba(255,255,255,0.55); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #1a1f2e; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.cat-start-btn:hover { background: #1a1f2e; color: #FFFF00; }
.cat-view-btn { display: block; width: 100%; padding: 4px 6px; background: #1a1f2e; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #FFFF00; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.cat-view-btn:hover { background: #FFFF00; color: #1a1f2e; }

/* CENTRE COLUMN */
.main { display: flex; flex-direction: column; gap: 10px; min-width: 0; }

/* Overview cards */
.ov-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.ov-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.ov-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.ov-card-body { padding: 10px 14px; }
.info-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 7px; }
.info-row { background: rgba(255,255,255,0.5); border-radius: 7px; padding: 7px 9px; }
.info-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #6b7585; margin-bottom: 3px; letter-spacing: 0.3px; }
.info-val { font-size: 11px; font-weight: 700; color: #1a1f2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.info-val a { color: #1a1f2e; text-decoration: underline; }
.ai-card { background: #1a1f2e; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 14px rgba(0,0,0,0.12); }
.ai-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: space-between; }
.ai-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: #FFFF00; opacity: 0.8; }
.ai-model { font-size: 9px; color: #444; }
.ai-card-body { padding: 14px; }
.ai-text { font-size: 12px; color: #bbb; line-height: 1.75; }
.ai-text p { margin-bottom: 10px; }
.ai-text p:last-child { margin-bottom: 0; }
.ai-loading { display: flex; align-items: center; gap: 8px; color: #555; font-size: 12px; }
.ai-dot { width: 5px; height: 5px; border-radius: 50%; background: #FFFF00; animation: pulse 1.2s ease-in-out infinite; }
.ai-dot:nth-child(2) { animation-delay: 0.2s; }
.ai-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes pulse { 0%,80%,100%{ opacity:0.2; transform:scale(0.8); } 40%{ opacity:1; transform:scale(1.1); } }
.ai-error { font-size: 12px; color: #e74c3c; }
.btn-regen { padding: 3px 10px; border: 1px solid #333; background: none; color: #555; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 600; cursor: pointer; border-radius: 20px; }
.btn-regen:hover { border-color: #FFFF00; color: #FFFF00; }
.coming-soon { background: #dde1ea; border-radius: 12px; padding: 22px 18px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.coming-soon h2 { font-size: 17px; font-weight: 900; letter-spacing: -0.3px; margin-bottom: 5px; }
.coming-soon p { font-size: 12px; color: #6b7585; line-height: 1.6; max-width: 360px; margin: 0 auto 14px; }
.btn-big { display: inline-block; padding: 9px 20px; background: #1a1f2e; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; cursor: pointer; border-radius: 30px; border: none; }
.btn-big:hover { background: #FFFF00; color: #1a1f2e; }

/* CATEGORY DETAIL PANEL (replaces centre content) */
.cat-panel { display: none; flex-direction: column; gap: 10px; min-width: 0; }
.cat-panel.open { display: flex; }

/* Panel header */
.cp-header { background: #1a1f2e; border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; }
.cp-header-left { display: flex; align-items: center; gap: 12px; }
.cp-back { background: rgba(255,255,255,0.1); border: none; color: #aaa; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; padding: 5px 12px; border-radius: 20px; cursor: pointer; transition: all .12s; }
.cp-back:hover { background: rgba(255,255,255,0.2); color: #fff; }
.cp-title { font-size: 16px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.3px; color: #fff; }
.cp-header-right { display: flex; align-items: center; gap: 8px; }

/* Score band inside panel */
.cp-score-band { background: #dde1ea; border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; gap: 16px; }
.cp-score-circle { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 3px solid rgba(0,0,0,0.1); }
.cp-score-num { font-size: 22px; font-weight: 900; line-height: 1; }
.cp-score-info { flex: 1; }
.cp-score-label { font-size: 9px; font-weight: 700; color: #6b7585; text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 3px; }
.cp-score-desc { font-size: 11px; color: #1a1f2e; font-weight: 600; margin-bottom: 6px; }
.cp-bar-track { height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; overflow: hidden; }
.cp-bar-fill { height: 100%; border-radius: 2px; transition: width .6s; }

/* Editable fields card */
.cp-fields-card { background: #dde1ea; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.cp-fields-hdr { padding: 10px 16px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; justify-content: space-between; }
.cp-fields-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.cp-fields-body { padding: 12px 16px; display: flex; flex-direction: column; gap: 8px; }
.cp-field { display: flex; flex-direction: column; gap: 4px; }
.cp-field-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #6b7585; letter-spacing: 0.3px; }
.cp-field-input { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #1a1f2e; outline: none; transition: border-color .12s, background .12s; }
.cp-field-input:focus { background: #fff; border-color: #1a1f2e; }
.cp-save-row { padding: 12px 16px; border-top: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; gap: 10px; }
.cp-save-btn { padding: 9px 22px; background: #1a1f2e; border: none; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; cursor: pointer; border-radius: 20px; transition: all .12s; }
.cp-save-btn:hover { background: #FFFF00; color: #1a1f2e; }
.cp-save-msg { font-size: 11px; color: #2e7d4f; font-weight: 600; opacity: 0; transition: opacity .3s; }
.cp-save-msg.show { opacity: 1; }
.cp-retake-btn { padding: 9px 16px; background: rgba(0,0,0,0.06); border: none; color: #6b7585; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; margin-left: auto; }
.cp-retake-btn:hover { background: rgba(0,0,0,0.12); color: #1a1f2e; }

/* Missing fields */
.cp-missing-card { background: #dde1ea; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.cp-missing-hdr { padding: 10px 16px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.cp-missing-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.cp-missing-body { padding: 12px 16px; display: flex; flex-direction: column; gap: 0; }
.cp-missing-item { display: flex; align-items: flex-start; gap: 8px; padding: 7px 0; border-bottom: 1px solid rgba(0,0,0,0.06); }
.cp-missing-item:last-child { border-bottom: none; }
.cp-missing-dot { width: 6px; height: 6px; border-radius: 50%; background: #e07b20; flex-shrink: 0; margin-top: 4px; }
.cp-missing-text { font-size: 11px; color: #1a1f2e; line-height: 1.5; }
.cp-missing-impact { font-size: 10px; color: #6b7585; margin-top: 1px; }

/* Share button */
.cp-share-btn { padding: 5px 14px; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); color: #ccc; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.cp-share-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }

/* ---- CAT PANEL TAB BAR ---- */
.cp-tabs { display: flex; gap: 2px; background: rgba(0,0,0,0.08); border-radius: 10px; padding: 3px; }
.cp-tab { flex: 1; padding: 7px 10px; background: none; border: none; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #8a95a5; cursor: pointer; border-radius: 8px; transition: all .15s; text-align: center; }
.cp-tab.active { background: #fff; color: #1a1f2e; box-shadow: 0 1px 4px rgba(0,0,0,0.12); }
.cp-tab-pane { display: none; flex-direction: column; gap: 10px; }
.cp-tab-pane.active { display: flex; }

/* ---- SPEC FORM ---- */
.spec-card { background: #dde1ea; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.spec-section-hdr { padding: 9px 16px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; transition: background .12s; }
.spec-section-hdr:hover { background: rgba(255,255,255,0.35); }
.spec-section-icon { font-size: 13px; flex-shrink: 0; }
.spec-section-title { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.4px; color: #1a1f2e; flex: 1; }
.spec-section-filled { font-size: 9px; color: #8a95a5; }
.spec-section-chev { font-size: 10px; color: #8a95a5; transition: transform .2s; }
.spec-section-chev.open { transform: rotate(180deg); }
.spec-section-body { display: none; padding: 14px 16px; display: none; }
.spec-section-body.open { display: block; }
.spec-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.spec-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.spec-grid-1 { display: grid; grid-template-columns: 1fr; gap: 10px; }
.spec-field { display: flex; flex-direction: column; gap: 4px; }
.spec-field.full { grid-column: 1 / -1; }
.spec-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #6b7585; }
.spec-lbl .req { color: #c0392b; margin-left: 2px; }
.spec-input { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 11px; color: #1a1f2e; outline: none; transition: border-color .12s, background .12s; }
.spec-input:focus { background: #fff; border-color: #1a1f2e; }
.spec-input[type=number] { -moz-appearance: textfield; }
.spec-input[type=number]::-webkit-outer-spin-button,
.spec-input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }
.spec-select { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 11px; color: #1a1f2e; outline: none; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236b7585'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; }
.spec-toggle-row { display: flex; align-items: center; gap: 8px; padding: 7px 0; }
.spec-toggle { position: relative; width: 34px; height: 18px; flex-shrink: 0; }
.spec-toggle input { opacity: 0; width: 0; height: 0; }
.spec-toggle-slider { position: absolute; inset: 0; background: rgba(0,0,0,0.12); border-radius: 9px; cursor: pointer; transition: background .2s; }
.spec-toggle-slider:before { content:''; position:absolute; height:12px; width:12px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition: transform .2s; }
.spec-toggle input:checked + .spec-toggle-slider { background: #2e7d4f; }
.spec-toggle input:checked + .spec-toggle-slider:before { transform: translateX(16px); }
.spec-toggle-lbl { font-size: 11px; color: #1a1f2e; }
.spec-hint { font-size: 9px; color: #8a95a5; margin-top: 2px; line-height: 1.4; }
.spec-save-row { padding: 12px 16px; border-top: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.3); }
.spec-save-btn { padding: 9px 24px; background: #1a1f2e; border: none; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.spec-save-btn:hover { background: #FFFF00; color: #1a1f2e; }
.spec-save-msg { font-size: 11px; color: #2e7d4f; font-weight: 600; opacity: 0; transition: opacity .3s; }
.spec-save-msg.show { opacity: 1; }
.spec-assess-btn { padding: 9px 20px; background: rgba(46,125,79,0.14); border: 1px solid rgba(46,125,79,0.3); color: #2e7d4f; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; margin-left: auto; }
.spec-assess-btn:hover { background: #2e7d4f; color: #fff; border-color: #2e7d4f; }

/* Completeness strip at top of spec tab */
.spec-completeness { background: #dde1ea; border-radius: 12px; padding: 12px 16px; display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.spec-comp-bar-wrap { flex: 1; }
.spec-comp-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #6b7585; margin-bottom: 5px; }
.spec-comp-track { height: 5px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden; }
.spec-comp-fill { height: 100%; border-radius: 3px; background: #2e7d4f; transition: width .5s; }
.spec-comp-pct { font-size: 14px; font-weight: 900; color: #1a1f2e; flex-shrink: 0; }
.spec-comp-hint { font-size: 10px; color: #8a95a5; }

/* ── MULTI-COMPONENT (all categories) ─────── */
.mc-component-card { background: rgba(255,255,255,0.45); border-radius: 10px; overflow: hidden; margin-bottom: 10px; border: 1px solid rgba(0,0,0,0.07); }
.mc-component-hdr { padding: 9px 12px; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.3); border-bottom: 1px solid rgba(0,0,0,0.06); }
.mc-component-icon { font-size: 15px; flex-shrink: 0; }
.mc-component-title-wrap { flex: 1; display: flex; flex-direction: column; gap: 1px; min-width: 0; }
.mc-component-title { font-size: 12px; font-weight: 800; color: #1a1f2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.mc-component-type-badge { font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #8a95a5; }
.mc-component-toggle { padding: 3px 8px; background: rgba(0,0,0,0.06); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 10px; color: #6b7585; cursor: pointer; flex-shrink: 0; transition: all .12s; }
.mc-component-toggle:hover { background: rgba(0,0,0,0.12); }
.mc-component-del { padding: 3px 9px; background: none; border: 1px solid rgba(192,57,43,0.25); border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #c0392b; cursor: pointer; transition: all .12s; flex-shrink: 0; }
.mc-component-del:hover { background: #c0392b; color: #fff; border-color: #c0392b; }
.mc-component-body { padding: 12px 14px; }
.mc-empty-state { text-align: center; padding: 32px 16px; background: rgba(255,255,255,0.35); border-radius: 10px; border: 1.5px dashed rgba(0,0,0,0.12); margin-bottom: 10px; }
.mc-add-btn { display: flex; align-items: center; gap: 7px; width: 100%; padding: 9px 14px; background: rgba(255,255,255,0.4); border: 1.5px dashed rgba(0,0,0,0.15); border-radius: 10px; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; color: #6b7585; cursor: pointer; transition: all .15s; margin-top: 4px; justify-content: center; }
.mc-add-btn:hover { border-color: #1a1f2e; color: #1a1f2e; background: rgba(255,255,255,0.6); }
.mc-type-menu { background: #fff; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.14); padding: 10px; display: none; margin-top: 6px; }
.mc-type-menu.open { display: flex; flex-wrap: wrap; gap: 6px; }
.mc-type-chip { padding: 7px 14px; background: #f0f2f5; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; color: #5a6474; cursor: pointer; transition: all .12s; }
.mc-type-chip:hover { background: #1a1f2e; color: #FFFF00; }
.mc-tl-strip { padding: 12px 0 2px; border-top: 1px solid rgba(0,0,0,0.07); margin-top: 10px; }
.mc-tl-title { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #8a95a5; margin-bottom: 8px; }
.mc-tl-row { display: grid; grid-template-columns: 10px 1fr auto auto; gap: 8px; align-items: center; padding: 5px 0; border-top: 1px solid rgba(0,0,0,0.04); }
.mc-tl-label { font-size: 10px; font-weight: 600; color: #1a1f2e; }
.mc-tl-select { padding: 3px 7px; background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 9px; color: #6b7585; outline: none; cursor: pointer; }
.mc-tl-date { padding: 3px 7px; background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 9px; color: #6b7585; outline: none; width: 120px; }
.mc-tl-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; background: #b0b8c8; transition: background .2s; }
.mc-tl-dot.complete { background: #2e7d4f; }
.mc-tl-dot.in_progress { background: #e07b20; }

/* ── AI ASSESSMENT ──────────────────────────── */
.asmnt-panel { background: #1a1f2e; border-radius: 14px; overflow: hidden; }
.asmnt-topbar { padding: 14px 18px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; gap: 10px; }
.asmnt-icon { font-size: 20px; }
.asmnt-title { font-size: 13px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.3px; color: #fff; flex: 1; }
.asmnt-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #FFFF00; background: rgba(255,255,0,0.1); padding: 3px 10px; border-radius: 20px; }
.asmnt-body { padding: 18px; display: flex; flex-direction: column; gap: 16px; overflow-y: auto; max-height: 560px; }
.asmnt-progress-row { display: flex; align-items: center; gap: 10px; }
.asmnt-progress-bar { flex: 1; height: 3px; background: rgba(255,255,255,0.07); border-radius: 2px; overflow: hidden; }
.asmnt-progress-fill { height: 100%; background: #FFFF00; border-radius: 2px; transition: width .4s; }
.asmnt-progress-txt { font-size: 10px; color: #555; white-space: nowrap; }
.asmnt-q-block { display: flex; flex-direction: column; gap: 10px; }
.asmnt-q-num { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #555; }
.asmnt-q-text { font-size: 14px; font-weight: 700; color: #fff; line-height: 1.5; }
.asmnt-q-context { font-size: 11px; color: #46505e; line-height: 1.5; font-style: italic; background: rgba(255,255,255,0.03); border-left: 2px solid rgba(255,255,0,0.2); padding: 6px 10px; border-radius: 0 6px 6px 0; }
.asmnt-options { display: flex; flex-direction: column; gap: 7px; }
.asmnt-opt { display: flex; align-items: flex-start; gap: 12px; padding: 12px 14px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07); border-radius: 10px; cursor: pointer; transition: all .15s; }
.asmnt-opt:hover { background: rgba(255,255,255,0.07); border-color: rgba(255,255,255,0.14); }
.asmnt-opt.selected { background: rgba(255,255,0,0.07); border-color: rgba(255,255,0,0.3); }
.asmnt-opt-letter { width: 22px; height: 22px; border-radius: 50%; background: rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: #555; flex-shrink: 0; transition: all .15s; margin-top: 1px; }
.asmnt-opt.selected .asmnt-opt-letter { background: #FFFF00; color: #1a1f2e; }
.asmnt-opt-text { font-size: 12px; color: #99a0b0; line-height: 1.55; flex: 1; }
.asmnt-opt.selected .asmnt-opt-text { color: #e8e8e8; }
.asmnt-footer { padding: 14px 18px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 8px; }
.asmnt-next-btn { padding: 10px 24px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.asmnt-next-btn:hover { background: #fff; }
.asmnt-next-btn:disabled { opacity: 0.25; cursor: default; }
.asmnt-skip-btn { padding: 10px 14px; background: none; border: none; color: #3a404e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; }
.asmnt-skip-btn:hover { color: #777; }
.asmnt-back-btn { padding: 10px 14px; background: rgba(255,255,255,0.05); border: none; color: #555; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 20px; margin-right: auto; }
.asmnt-back-btn:hover { background: rgba(255,255,255,0.09); color: #888; }
.asmnt-note { font-size: 10px; color: #2e3340; flex: 1; line-height: 1.4; }
.asmnt-score-reveal { text-align: center; padding: 28px 0 12px; display: flex; flex-direction: column; align-items: center; gap: 14px; }
.asmnt-score-ring { width: 96px; height: 96px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column; border: 4px solid #2e7d4f; }
.asmnt-score-ring.amber { border-color: #e07b20; }
.asmnt-score-ring.red   { border-color: #c0392b; }
.asmnt-score-val { font-size: 32px; font-weight: 900; color: #fff; line-height: 1; }
.asmnt-score-sub { font-size: 10px; color: #555; margin-top: 1px; }
.asmnt-score-label { font-size: 14px; font-weight: 700; color: #fff; }
.asmnt-score-rationale { font-size: 11px; color: #666; line-height: 1.7; max-width: 380px; text-align: center; }
.asmnt-save-btn { padding: 12px 32px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.asmnt-save-btn:hover { background: #fff; }
.asmnt-loading { display: flex; flex-direction: column; align-items: center; gap: 14px; padding: 40px 0; }
.asmnt-loading-txt { font-size: 12px; color: #555; }
.share-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; display: none; align-items: center; justify-content: center; }
.share-modal-overlay.open { display: flex; }
.share-modal { background: #eef0f4; border-radius: 14px; padding: 24px; width: 420px; max-width: 92vw; box-shadow: 0 8px 40px rgba(0,0,0,0.2); }
.share-modal h3 { font-size: 14px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 6px; }
.share-modal p { font-size: 12px; color: #6b7585; line-height: 1.6; margin-bottom: 16px; }
.share-url-box { background: #fff; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; padding: 10px 12px; font-size: 11px; color: #1a1f2e; word-break: break-all; margin-bottom: 12px; line-height: 1.6; }
.share-modal-btns { display: flex; gap: 8px; justify-content: flex-end; }
.share-copy-btn { padding: 8px 18px; background: #1a1f2e; border: none; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; }
.share-copy-btn:hover { background: #FFFF00; color: #1a1f2e; }
.share-close-btn { padding: 8px 16px; background: rgba(0,0,0,0.07); border: none; color: #6b7585; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 20px; }

/* AI Q&A card */
.cp-ai-card { background: #1a1f2e; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 14px rgba(0,0,0,0.12); }
.cp-ai-hdr { padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; gap: 8px; }
.cp-ai-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: #FFFF00; opacity: 0.8; }
.cp-ai-model { font-size: 9px; color: #444; margin-left: auto; }
.cp-ai-body { padding: 14px; display: flex; flex-direction: column; gap: 10px; }
.cp-ai-history { display: flex; flex-direction: column; gap: 8px; max-height: 220px; overflow-y: auto; }
.cp-ai-msg { font-size: 12px; line-height: 1.65; border-radius: 8px; padding: 8px 11px; }
.cp-ai-msg.user { background: rgba(255,255,255,0.07); color: #ccc; align-self: flex-end; max-width: 85%; }
.cp-ai-msg.assistant { background: rgba(255,255,0,0.06); color: #bbb; align-self: flex-start; max-width: 95%; }
.cp-ai-input-row { display: flex; gap: 7px; }
.cp-ai-input { flex: 1; padding: 8px 12px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 12px; color: #fff; outline: none; }
.cp-ai-input::placeholder { color: #444; }
.cp-ai-input:focus { border-color: rgba(255,255,0,0.3); background: rgba(255,255,255,0.09); }
.cp-ai-send { padding: 8px 16px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 20px; transition: all .12s; flex-shrink: 0; }
.cp-ai-send:hover { background: #fff; }
.cp-ai-send:disabled { opacity: 0.4; cursor: default; }

/* ── DESIGN ARRAY CARDS ─────────────────────── */
.da-array-card { background: #fff; border-radius: 14px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1.5px solid rgba(36,113,163,0.18); margin-bottom: 10px; }
.da-array-hdr { padding: 12px 16px; background: linear-gradient(135deg,#1a2f45 0%,#2471a3 100%); display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
.da-array-icon { font-size: 18px; flex-shrink: 0; }
.da-array-name-wrap { flex: 1; min-width: 0; }
.da-array-name { font-size: 13px; font-weight: 900; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.da-array-meta { font-size: 9px; color: rgba(255,255,255,0.5); margin-top: 2px; }
.da-array-pct-badge { font-size: 10px; font-weight: 700; background: rgba(255,255,255,0.12); color: #fff; padding: 3px 9px; border-radius: 20px; flex-shrink: 0; }
.da-array-chev { font-size: 11px; color: rgba(255,255,255,0.5); transition: transform .2s; flex-shrink: 0; }
.da-array-chev.open { transform: rotate(180deg); }
.da-array-del { padding: 3px 9px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; font-family: 'Inter',sans-serif; font-size: 9px; font-weight: 700; color: rgba(255,255,255,0.6); cursor: pointer; flex-shrink: 0; transition: all .12s; }
.da-array-del:hover { background: #c0392b; border-color: #c0392b; color: #fff; }
.da-array-body { display: none; padding: 12px; background: #f5f7fa; }
.da-array-body.open { display: block; }
.da-name-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; padding: 8px 12px; background: #fff; border-radius: 8px; border: 1px solid rgba(0,0,0,0.08); }
.da-name-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #8a95a5; flex-shrink: 0; }
.da-name-input { flex: 1; border: none; outline: none; font-family: 'Inter',sans-serif; font-size: 13px; font-weight: 700; color: #1a1f2e; background: transparent; }
/* Sub-section inside array body — reuses spec-card but with slight indent */
.da-array-body .spec-card { background: #fff; margin-bottom: 6px; }
.da-array-body .spec-section-hdr { background: rgba(36,113,163,0.06); }
.da-array-body .spec-section-hdr:hover { background: rgba(36,113,163,0.12); }
/* Add array button */
.da-add-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px; background: rgba(36,113,163,0.07); border: 1.5px dashed rgba(36,113,163,0.3); border-radius: 12px; font-family: 'Inter',sans-serif; font-size: 11px; font-weight: 700; color: #2471a3; cursor: pointer; transition: all .15s; }
.da-add-btn:hover { background: rgba(36,113,163,0.14); border-color: #2471a3; }
.da-empty-state { text-align: center; padding: 36px 16px; background: rgba(36,113,163,0.05); border-radius: 12px; border: 1.5px dashed rgba(36,113,163,0.2); margin-bottom: 10px; }

/* ── DESIGN ARRAY CARDS ─────────────────────── */
.da-card { background: rgba(255,255,255,0.48); border-radius: 12px; overflow: hidden; margin-bottom: 10px; border: 1px solid rgba(0,0,0,0.07); box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
.da-card-hdr { padding: 11px 14px; display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.35); border-bottom: 1px solid rgba(0,0,0,0.06); }
.da-card-icon { font-size: 18px; flex-shrink: 0; }
.da-card-title-wrap { flex: 1; min-width: 0; }
.da-card-title { font-size: 13px; font-weight: 800; color: #1a1f2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.da-card-meta { font-size: 9px; color: #8a95a5; margin-top: 2px; font-weight: 600; }
.da-card-progress { height: 3px; background: rgba(0,0,0,0.07); }
.da-card-progress-fill { height: 100%; transition: width .4s, background .4s; }
.da-card-body { padding: 10px 12px; display: flex; flex-direction: column; gap: 6px; }
.da-section { background: rgba(255,255,255,0.55); border-radius: 9px; overflow: hidden; border: 1px solid rgba(0,0,0,0.06); }
.da-section-hdr { padding: 8px 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; transition: background .12s; }
.da-section-hdr:hover { background: rgba(255,255,255,0.7); }
.da-section-icon { font-size: 13px; flex-shrink: 0; }
.da-section-title { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.3px; color: #1a1f2e; flex: 1; }
.da-section-count { font-size: 9px; font-weight: 600; color: #8a95a5; background: rgba(0,0,0,0.07); padding: 1px 6px; border-radius: 20px; flex-shrink: 0; }
.da-section-chev { font-size: 9px; color: #8a95a5; flex-shrink: 0; transition: transform .2s; }
.da-section-chev.open { transform: rotate(180deg); }
.da-section-body { display: none; padding: 12px 14px; border-top: 1px solid rgba(0,0,0,0.05); }
.da-section-body.open { display: block; }

/* ── REGISTRY CARDS (right sidebar) ─────────── */
.reg-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; gap: 8px; }
.reg-card-icon { font-size: 14px; }
.reg-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; flex: 1; }
.reg-card-count { font-size: 9px; font-weight: 700; background: #1a1f2e; color: #FFFF00; padding: 2px 7px; border-radius: 20px; }
.reg-card-body { padding: 8px 14px 10px; display: flex; flex-direction: column; gap: 5px; }
.reg-mini-item { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.55); border-radius: 7px; padding: 4px 8px; }
.reg-mini-icon { font-size: 11px; flex-shrink: 0; }
.reg-mini-name { font-size: 10px; font-weight: 600; color: #1a1f2e; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.reg-mini-tag { font-size: 8px; font-weight: 700; text-transform: uppercase; color: #8a95a5; background: rgba(0,0,0,0.07); padding: 1px 5px; border-radius: 20px; flex-shrink: 0; }
.reg-open-btn { display: block; width: 100%; padding: 6px 8px; background: #1a1f2e; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #FFFF00; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; margin-top: 2px; }
.reg-open-btn:hover { background: #FFFF00; color: #1a1f2e; }
.reg-empty { font-size: 10px; color: #8a95a5; text-align: center; padding: 6px 0; }

/* ── REGISTRY SLIDE PANELS ──────────────────── */
.reg-panel { display: none; flex-direction: column; gap: 10px; min-width: 0; }
.reg-panel.open { display: flex; }
.reg-panel-hdr { background: #1a1f2e; border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
.reg-panel-back { background: rgba(255,255,255,0.1); border: none; color: #aaa; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; padding: 5px 12px; border-radius: 20px; cursor: pointer; transition: all .12s; }
.reg-panel-back:hover { background: rgba(255,255,255,0.2); color: #fff; }
.reg-panel-title { font-size: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.3px; color: #fff; flex: 1; }
.reg-panel-subtitle { font-size: 10px; color: #444; }

/* Registry item cards */
.reg-item-wrap { display: flex; flex-direction: column; gap: 8px; }
.reg-item-card { background: #dde1ea; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.reg-item-hdr { padding: 10px 14px; background: rgba(255,255,255,0.35); border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; gap: 9px; }
.reg-item-icon { font-size: 16px; flex-shrink: 0; }
.reg-item-name-wrap { flex: 1; min-width: 0; }
.reg-item-name { font-size: 12px; font-weight: 800; color: #1a1f2e; }
.reg-item-type { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #8a95a5; margin-top: 1px; }
.reg-item-toggle-btn { padding: 3px 9px; background: rgba(0,0,0,0.06); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 10px; color: #6b7585; cursor: pointer; flex-shrink: 0; }
.reg-item-del { padding: 3px 9px; background: none; border: 1px solid rgba(192,57,43,0.25); border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #c0392b; cursor: pointer; flex-shrink: 0; }
.reg-item-del:hover { background: #c0392b; color: #fff; }
.reg-item-body { padding: 12px 14px; }

/* Type picker */
.reg-type-menu { background: #fff; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.14); padding: 12px; margin-top: 4px; display: none; }
.reg-type-menu.open { display: flex; flex-wrap: wrap; gap: 7px; }
.reg-type-chip { display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: #f0f2f5; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; color: #5a6474; cursor: pointer; transition: all .12s; }
.reg-type-chip:hover { background: #1a1f2e; color: #FFFF00; }
.reg-type-chip-icon { font-size: 13px; }
.reg-add-btn { display: flex; align-items: center; gap: 7px; width: 100%; padding: 10px 14px; background: rgba(255,255,255,0.4); border: 1.5px dashed rgba(0,0,0,0.15); border-radius: 10px; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; color: #6b7585; cursor: pointer; transition: all .15s; justify-content: center; }
.reg-add-btn:hover { border-color: #1a1f2e; color: #1a1f2e; background: rgba(255,255,255,0.65); }
.reg-empty-state { text-align: center; padding: 36px 16px; background: rgba(255,255,255,0.3); border-radius: 10px; border: 1.5px dashed rgba(0,0,0,0.12); }
.reg-empty-state-icon { font-size: 32px; margin-bottom: 8px; }
.reg-empty-state-msg { font-size: 12px; color: #8a95a5; line-height: 1.5; }

/* Registry form fields reuse spec-field classes */
.reg-section-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #8a95a5; margin-bottom: 8px; padding-top: 4px; }
.reg-save-row { padding: 12px 14px; border-top: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.25); }
.reg-save-btn { padding: 8px 20px; background: #1a1f2e; border: none; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.reg-save-btn:hover { background: #FFFF00; color: #1a1f2e; }
.reg-save-msg { font-size: 10px; color: #2e7d4f; font-weight: 600; opacity: 0; transition: opacity .3s; }
.reg-save-msg.show { opacity: 1; }

.lock-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.lock-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; justify-content: space-between; }
.lock-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.lock-icon { font-size: 13px; opacity: 0.35; }
.lock-card-body { padding: 20px 14px; }
.lock-overlay { display: flex; flex-direction: column; align-items: center; text-align: center; gap: 10px; }
.lock-svg { width: 28px; height: 28px; opacity: 0.2; }
.lock-msg { font-size: 11px; color: #6b7585; line-height: 1.5; max-width: 160px; }
.lock-req { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #aaa; background: rgba(0,0,0,0.07); padding: 3px 9px; border-radius: 20px; }

/* Tally overlay */
#ov-tally-overlay { display:none; position:fixed; inset:0; z-index:300; background:rgba(0,0,0,0.85); flex-direction:column; }


/* Timeline date inputs */
.tl-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
.tl-date-input { border: none; background: rgba(0,0,0,0.06); border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 10px; color: #6b7585; padding: 3px 6px; cursor: pointer; outline: none; width: 110px; }
.tl-date-input:focus { background: rgba(0,0,0,0.1); color: #1a1f2e; }
.tl-date-input::-webkit-calendar-picker-indicator { opacity: 0.4; cursor: pointer; }

/* Procurement grey (same as cat-item) */
.proc-item { background: #dde1ea; border-radius: 10px; padding: 9px 11px; box-shadow: 0 1px 5px rgba(0,0,0,0.06); transition: transform .12s, box-shadow .12s; }
.proc-item:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
.proc-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.proc-name { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.3px; color: #1a1f2e; }
.proc-start-btn { display: block; width: 100%; padding: 4px 6px; background: rgba(255,255,255,0.55); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #1a1f2e; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.proc-start-btn:hover { background: #1a1f2e; color: #FFFF00; }

/* Completeness dot on cat buttons */
.cat-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; margin-left: 5px; flex-shrink: 0; }

/* Timeline card */
.timeline-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.timeline-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.timeline-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.timeline-body { padding: 14px 16px; display: flex; flex-direction: column; gap: 0; }
.tl-step { display: flex; align-items: flex-start; gap: 12px; position: relative; }
.tl-step:not(:last-child)::after { content: ''; position: absolute; left: 7px; top: 18px; width: 2px; bottom: -14px; background: rgba(0,0,0,0.12); }
.tl-dot-wrap { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; padding-top: 2px; }
.tl-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.15); flex-shrink: 0; z-index: 1; }
.tl-dot.green  { background: #2e7d4f; border-color: #2e7d4f; }
.tl-dot.yellow { background: #e07b20; border-color: #e07b20; }
.tl-dot.red    { background: #c0392b; border-color: #c0392b; }
.tl-dot.grey   { background: #b0b8c8; border-color: #b0b8c8; }
.tl-info { flex: 1; padding-bottom: 14px; }
.tl-label { font-size: 11px; font-weight: 700; color: #1a1f2e; }
.tl-status { font-size: 10px; color: #6b7585; margin-top: 2px; }


/* Split centre: brief (2/3) + timeline (1/3) */
.centre-split { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: start; }
.centre-main { display: flex; flex-direction: column; gap: 10px; min-width: 0; }
.centre-timeline { display: flex; flex-direction: column; gap: 8px; }

/* Upload Document card (sits below timeline card in right sidebar of centre-split) */
.upload-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; position: sticky; top: calc(68px + var(--tl-height, 0px) + 8px); }
.upload-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.upload-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.upload-card-body { padding: 10px 14px; display: flex; flex-direction: column; gap: 8px; }
.upload-doc-list { display: flex; flex-direction: column; gap: 4px; }
.upload-doc-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.55); border-radius: 8px; padding: 5px 9px; gap: 6px; }
.upload-doc-name { font-size: 10px; font-weight: 600; color: #1a1f2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90px; }
.upload-doc-type { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #6b7585; background: rgba(0,0,0,0.07); padding: 1px 6px; border-radius: 20px; flex-shrink: 0; }
.upload-doc-view { font-size: 9px; font-weight: 700; color: #1a1f2e; background: none; border: none; cursor: pointer; text-transform: uppercase; padding: 2px 6px; border-radius: 20px; transition: all .12s; flex-shrink: 0; }
.upload-doc-view:hover { background: #1a1f2e; color: #FFFF00; }
.upload-open-btn { display: block; width: 100%; padding: 6px 8px; background: #1a1f2e; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #FFFF00; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.upload-open-btn:hover { background: #FFFF00; color: #1a1f2e; }
.upload-empty { font-size: 10px; color: #8a95a5; text-align: center; padding: 4px 0; }

/* Document panel (replaces centre content just like cat-panel) */
.doc-panel { display: none; flex-direction: column; gap: 10px; min-width: 0; }
.doc-panel.open { display: flex; }
.dp-header { background: #1a1f2e; border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
.dp-back { background: rgba(255,255,255,0.1); border: none; color: #aaa; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; padding: 5px 12px; border-radius: 20px; cursor: pointer; transition: all .12s; }
.dp-back:hover { background: rgba(255,255,255,0.2); color: #fff; }
.dp-title { font-size: 16px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.3px; color: #fff; }
.dp-header-right { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
.dp-overall-badge { font-size: 10px; color: #666; font-weight: 600; }
.dp-overall-badge span { color: #FFFF00; font-size: 12px; font-weight: 800; }
.dp-progress-summary { background: #dde1ea; border-radius: 12px; padding: 14px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.dp-prog-cats { display: grid; grid-template-columns: repeat(7,1fr); gap: 8px; }
.dp-prog-cat { display: flex; flex-direction: column; align-items: center; gap: 5px; }
.dp-prog-cat-name { font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.2px; color: #6b7585; text-align: center; line-height: 1.3; }
.dp-prog-cat-ring { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: #1a1f2e; border: 3px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.6); }
.dp-prog-cat-ring.complete { border-color: #2e7d4f; background: rgba(46,125,79,0.12); color: #2e7d4f; }
.dp-prog-cat-ring.partial  { border-color: #e07b20; background: rgba(224,123,32,0.10); color: #b05a10; }
.dp-prog-cat-ring.empty    { border-color: rgba(0,0,0,0.1); color: #aaa; }
.dp-prog-cat-pct { font-size: 9px; font-weight: 700; color: #6b7585; }
.dd-cat-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.dd-cat-hdr { padding: 12px 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; transition: background .12s; }
.dd-cat-hdr:hover { background: rgba(255,255,255,0.35); }
.dd-cat-num { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; color: #fff; flex-shrink: 0; }
.dd-cat-name { font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.3px; color: #1a1f2e; flex: 1; }
.dd-cat-meta { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.dd-cat-check-pill { font-size: 9px; font-weight: 700; padding: 2px 9px; border-radius: 20px; }
.dd-cat-check-pill.done { background: rgba(46,125,79,0.14); color: #2e7d4f; }
.dd-cat-check-pill.part { background: rgba(224,123,32,0.14); color: #b05a10; }
.dd-cat-check-pill.none { background: rgba(0,0,0,0.07); color: #8a95a5; }
.dd-cat-file-pill { font-size: 9px; font-weight: 700; padding: 2px 9px; border-radius: 20px; background: rgba(26,31,46,0.09); color: #5a6474; }
.dd-cat-chevron { font-size: 10px; color: #8a95a5; transition: transform .2s; flex-shrink: 0; }
.dd-cat-chevron.open { transform: rotate(180deg); }
.dd-cat-body { display: none; border-top: 1px solid rgba(0,0,0,0.07); }
.dd-cat-body.open { display: block; }
.dd-section { padding: 12px 16px 8px; border-bottom: 1px solid rgba(0,0,0,0.06); }
.dd-section-title { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #8a95a5; margin-bottom: 9px; }
.dd-check-item { display: flex; align-items: flex-start; gap: 9px; padding: 5px 0; }
.dd-check-item + .dd-check-item { border-top: 1px solid rgba(0,0,0,0.04); }
.dd-check-cb { width: 15px; height: 15px; accent-color: #2e7d4f; cursor: pointer; flex-shrink: 0; margin-top: 2px; }
.dd-check-lbl { font-size: 11px; color: #1a1f2e; line-height: 1.5; cursor: pointer; }
.dd-check-lbl.done { color: #9aa3b0; text-decoration: line-through; }
.dd-priority-item { display: flex; align-items: center; gap: 10px; padding: 7px 0; }
.dd-priority-item + .dd-priority-item { border-top: 1px solid rgba(0,0,0,0.04); }
.dd-priority-star { font-size: 13px; flex-shrink: 0; }
.dd-priority-name { font-size: 11px; color: #1a1f2e; flex: 1; line-height: 1.4; }
.dd-priority-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 2px 9px; border-radius: 20px; flex-shrink: 0; white-space: nowrap; }
.dd-priority-badge.missing  { background: rgba(224,123,32,0.14); color: #b05a10; }
.dd-priority-badge.uploaded { background: rgba(46,125,79,0.14); color: #2e7d4f; }
.dd-view-link { font-size: 9px; font-weight: 700; color: #1a1f2e; background: rgba(255,255,255,0.7); border: none; border-radius: 20px; padding: 2px 9px; cursor: pointer; flex-shrink: 0; transition: all .12s; }
.dd-view-link:hover { background: #1a1f2e; color: #FFFF00; }
.dd-files-section { padding: 10px 16px 12px; border-bottom: 1px solid rgba(0,0,0,0.06); }
.dd-file-row { display: flex; align-items: center; gap: 9px; padding: 5px 0; }
.dd-file-row + .dd-file-row { border-top: 1px solid rgba(0,0,0,0.04); }
.dd-file-icon { font-size: 14px; flex-shrink: 0; }
.dd-file-info { flex: 1; min-width: 0; }
.dd-file-name { font-size: 11px; font-weight: 600; color: #1a1f2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dd-file-meta { font-size: 9px; color: #8a95a5; margin-top: 1px; }
.dd-file-actions { display: flex; gap: 5px; flex-shrink: 0; }
.dd-file-preview { padding: 3px 10px; background: rgba(255,255,255,0.7); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #1a1f2e; cursor: pointer; transition: all .12s; }
.dd-file-preview:hover { background: #1a1f2e; color: #FFFF00; }
.dd-file-rm { padding: 3px 9px; background: none; border: 1px solid rgba(192,57,43,0.25); border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #c0392b; cursor: pointer; transition: all .12s; }
.dd-file-rm:hover { background: #c0392b; color: #fff; border-color: #c0392b; }
.dd-files-empty { font-size: 10px; color: #a0a8b5; font-style: italic; padding: 2px 0; }
.dd-upload-row { padding: 10px 16px 14px; display: flex; align-items: center; gap: 8px; }
.dd-dropzone { flex: 1; border: 1.5px dashed rgba(0,0,0,0.14); border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: all .15s; background: rgba(255,255,255,0.3); }
.dd-dropzone:hover, .dd-dropzone.drag-over { border-color: #1a1f2e; background: rgba(255,255,255,0.55); }
.dd-dropzone-icon { font-size: 14px; opacity: 0.4; flex-shrink: 0; }
.dd-dropzone-text { font-size: 10px; color: #6b7585; }
.dd-upload-btn { padding: 7px 16px; background: #1a1f2e; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; color: #FFFF00; cursor: pointer; white-space: nowrap; transition: all .12s; flex-shrink: 0; }
.dd-upload-btn:hover { background: #FFFF00; color: #1a1f2e; }
.dd-upload-progress { display: none; padding: 0 16px 10px; align-items: center; gap: 8px; }
.dd-prog-bar { flex: 1; height: 3px; background: rgba(0,0,0,0.1); border-radius: 2px; overflow: hidden; }
.dd-prog-fill { height: 100%; background: #2e7d4f; border-radius: 2px; transition: width .3s; }
.dd-prog-txt { font-size: 10px; color: #6b7585; white-space: nowrap; }
.dd-upload-err { font-size: 10px; color: #c0392b; padding: 0 16px 8px; display: none; }
.dp-preview-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 500; display: none; flex-direction: column; }
.dp-preview-overlay.open { display: flex; }
.dp-preview-topbar { background: #111; padding: 10px 20px; display: flex; align-items: center; gap: 14px; border-bottom: 2px solid #FFFF00; flex-shrink: 0; }
.dp-preview-topbar-name { font-size: 13px; font-weight: 600; color: #fff; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dp-preview-topbar-dl { padding: 6px 18px; background: #FFFF00; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 800; color: #1a1f2e; cursor: pointer; text-transform: uppercase; }
.dp-preview-topbar-dl:hover { background: #fff; }
.dp-preview-topbar-close { padding: 6px 14px; background: rgba(255,255,255,0.08); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; color: #aaa; cursor: pointer; }
.dp-preview-topbar-close:hover { background: rgba(255,255,255,0.18); color: #fff; }
.dp-preview-frame-wrap { flex: 1; overflow: hidden; }
.dp-preview-iframe { width: 100%; height: 100%; border: none; display: block; background: #fff; }
.dp-preview-img-wrap { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px; background: #1a1f2e; }
.dp-preview-img-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 6px; }
.dp-preview-no-preview { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 10px; background: #1a1f2e; }
.dp-preview-no-preview p { font-size: 13px; color: #666; }
.dp-file-input { display: none; }

@media(max-width:900px){
  .layout { grid-template-columns: 1fr; }
  .left-col, .right-col { display: grid; grid-template-columns: repeat(3,1fr); }
  .score-card { grid-column: 1/-1; }
  .info-grid { grid-template-columns: repeat(3,1fr); }
}
</style>
</head>
<body class="hidden">

<!-- Share modal -->
<div class="share-modal-overlay" id="share-modal-overlay">
  <div class="share-modal">
    <h3 id="share-modal-title">Share Category</h3>
    <p>Anyone with this link can view this category's data without logging in. The link expires in 30 days.</p>
    <div class="share-url-box" id="share-url-box">Generating link...</div>
    <div class="share-modal-btns">
      <button class="share-close-btn" onclick="closeShareModal()">Close</button>
      <button class="share-copy-btn" onclick="copyShareLink()">Copy Link</button>
    </div>
  </div>
</div>

<!-- Assessment overlay removed — AI assessment runs inline in the Assessment tab -->

<div class="topbar">
  <a href="dashboard.html" class="logo">Sun<span>Hash</span></a>
  <div class="tb-right">
    <a href="dashboard.html" class="btn-back">Back to Dashboard</a>
    <button class="btn-out" onclick="sb.auth.signOut().then(function(){ window.location.href='login.html'; })">Sign Out</button>
  </div>
</div>

<div class="page">
  <div class="hero">
    <div class="hero-tag">Project Overview</div>
    <h1 id="hero-name">Loading...</h1>
    <div class="hero-sub" id="hero-sub"></div>
  </div>

  <div class="layout">

    <!-- LEFT: score + categories -->
    <div class="left-col">
      <div class="score-card">
        <div class="score-card-lbl">Overall Risk Score</div>
        <div class="score-ring" id="score-ring">
          <div class="score-ring-none">N/A</div>
        </div>
        <div class="score-card-desc" id="score-card-desc">Complete at least one assessment to generate a score.</div>
      </div>
      <div id="sidebar" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>

    <!-- CENTRE: overview OR category panel -->
    <div class="main" id="main-overview">
      <div class="centre-split">
        <div class="centre-main">
        <div class="ov-card" id="info-card" style="display:none;">
        <div class="ov-card-hdr"><span class="ov-card-title">Project Details</span></div>
        <div class="ov-card-body">
          <div class="info-grid">
            <div class="info-row"><div class="info-lbl">Location</div><div class="info-val" id="inf-location">-</div></div>
            <div class="info-row"><div class="info-lbl">Capacity</div><div class="info-val" id="inf-capacity">-</div></div>
            <div class="info-row"><div class="info-lbl">Stage</div><div class="info-val" id="inf-stage">-</div></div>
            <div class="info-row"><div class="info-lbl">Status</div><div class="info-val" id="inf-status">-</div></div>
            <div class="info-row"><div class="info-lbl">Created</div><div class="info-val" id="inf-date">-</div></div>
          </div>
        </div>
      </div>
      <div class="ai-card">
        <div class="ai-card-hdr">
          <span class="ai-label">AI Project Brief</span>
          <div style="display:flex;align-items:center;gap:6px;">
            <span class="ai-model">gpt-4o-mini</span>
            <button class="btn-regen" id="btn-regen" onclick="generateSummary(true)" style="display:none;">Regenerate</button>
          </div>
        </div>
        <div class="ai-card-body">
          <div id="ai-content">
            <div class="ai-loading"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div><span>Loading...</span></div>
          </div>
        </div>
      </div>
        </div><!-- /centre-main -->
        <div class="centre-timeline">
        <!-- Timeline -->
        <div class="timeline-card" style="position:sticky;top:68px;">
        <div class="timeline-hdr" style="display:flex;align-items:center;justify-content:space-between;">
          <span class="timeline-title">Project Timeline</span>
          
        </div>
        <div class="timeline-body">
          <div class="tl-step">
            <div class="tl-dot-wrap"><div class="tl-dot grey" id="tl-permit"></div></div>
            <div class="tl-info">
              <div class="tl-label">Permitting</div>
              <div class="tl-status" id="tl-permit-status">Not started</div>
            </div>
          </div>
          <div class="tl-step">
            <div class="tl-dot-wrap"><div class="tl-dot grey" id="tl-design"></div></div>
            <div class="tl-info">
              <div class="tl-label">Engineering &amp; Design</div>
              <div class="tl-status" id="tl-design-status">Not started</div>
            </div>
          </div>
          <div class="tl-step">
            <div class="tl-dot-wrap"><div class="tl-dot grey" id="tl-construct"></div></div>
            <div class="tl-info">
              <div class="tl-label">Construction</div>
              <div class="tl-status" id="tl-construct-status">Not started</div>
            </div>
          </div>
          <div class="tl-step">
            <div class="tl-dot-wrap"><div class="tl-dot grey" id="tl-cod"></div></div>
            <div class="tl-info" style="padding-bottom:0;">
              <div class="tl-label">COD</div>
              <div class="tl-status" id="tl-cod-status">Pending</div>
            </div>
          </div>
        </div>
        </div><!-- /timeline-card -->
        <!-- Upload Document card -->
        <div class="upload-card">
          <div class="upload-card-hdr"><span class="upload-card-title">Documents</span></div>
          <div class="upload-card-body">
            <div class="upload-doc-list" id="upload-mini-list">
              <div class="upload-empty" id="upload-mini-empty">No files yet</div>
            </div>
            <button class="upload-open-btn" onclick="openDocPanel()">&#128196; Manage Documents</button>
          </div>
        </div>
        </div><!-- /centre-timeline -->
      </div><!-- /centre-split -->
    </div><!-- /main-overview -->

    <!-- CENTRE: category detail panel -->
    <div class="cat-panel" id="cat-panel">
      <!-- built dynamically by openCatPanel() -->
    </div>

    <!-- CENTRE: document panel -->
    <div class="doc-panel" id="doc-panel">

      <div class="dp-header">
        <div style="display:flex;align-items:center;gap:12px;">
          <button class="dp-back" onclick="closeDocPanel()">&#8592; Back</button>
          <span class="dp-title">Due Diligence Documents</span>
        </div>
        <div class="dp-header-right">
          <span class="dp-overall-badge">Priority docs: <span id="dp-priority-count">—</span></span>
          <span class="dp-overall-badge">Checklist: <span id="dp-check-count">—</span></span>
        </div>
      </div>

      <!-- 7-ring progress bar -->
      <div class="dp-progress-summary">
        <div class="dp-prog-cats" id="dp-prog-cats"></div>
      </div>

      <!-- Shared hidden file input -->
      <input type="file" class="dp-file-input" id="dp-file-input" accept="*/*" onchange="handleCatFileSelect(this.files)"/>

      <!-- 7 category accordion cards, built by JS -->
      <div id="dp-cat-sections"></div>

    </div>

    <!-- Fullscreen preview overlay -->
    <div class="dp-preview-overlay" id="dp-preview-overlay">
      <div class="dp-preview-topbar">
        <button class="dp-preview-topbar-close" onclick="closePreview()">&#8592; Close</button>
        <span class="dp-preview-topbar-name" id="dp-preview-name"></span>
        <button class="dp-preview-topbar-dl" id="dp-preview-dl-btn" onclick="downloadActiveDoc()">&#8681; Download</button>
      </div>
      <div class="dp-preview-frame-wrap" id="dp-preview-frame-wrap"></div>
    </div>

    <!-- CENTRE: Components registry panel -->
    <div class="reg-panel" id="reg-panel-components">
      <div class="reg-panel-hdr">
        <button class="reg-panel-back" onclick="closeRegPanel('components')">&#8592; Overview</button>
        <div>
          <div class="reg-panel-title">⚙️ Main Components</div>
          <div class="reg-panel-subtitle">Technical specs for every major piece of equipment in this project</div>
        </div>
      </div>
      <div class="reg-item-wrap" id="comp-items-wrap"></div>
      <button class="reg-add-btn" onclick="toggleRegTypePicker('components')">＋ Add Component</button>
      <div class="reg-type-menu" id="reg-type-menu-components"></div>
      <div class="spec-card"><div class="reg-save-row">
        <button class="reg-save-btn" onclick="saveRegistry('components')">💾 Save All</button>
        <span class="reg-save-msg" id="reg-save-msg-components">Saved ✓</span>
      </div></div>
    </div>

    <!-- CENTRE: Suppliers & Contractors registry panel -->
    <div class="reg-panel" id="reg-panel-suppliers">
      <div class="reg-panel-hdr">
        <button class="reg-panel-back" onclick="closeRegPanel('suppliers')">&#8592; Overview</button>
        <div>
          <div class="reg-panel-title">🏢 Suppliers & Contractors</div>
          <div class="reg-panel-subtitle">Company directory — used for contract terms in Procurement</div>
        </div>
      </div>
      <div class="reg-item-wrap" id="supplier-items-wrap"></div>
      <button class="reg-add-btn" onclick="toggleRegTypePicker('suppliers')">＋ Add Company</button>
      <div class="reg-type-menu" id="reg-type-menu-suppliers"></div>
      <div class="spec-card"><div class="reg-save-row">
        <button class="reg-save-btn" onclick="saveRegistry('suppliers')">💾 Save All</button>
        <span class="reg-save-msg" id="reg-save-msg-suppliers">Saved ✓</span>
      </div></div>
    </div>

    <!-- CENTRE: Equipment registry panel -->
    <div class="reg-panel" id="reg-panel-equipment">
      <div class="reg-panel-hdr">
        <button class="reg-panel-back" onclick="closeRegPanel('equipment')">&#8592; Overview</button>
        <div>
          <div class="reg-panel-title">🚜 Equipment</div>
          <div class="reg-panel-subtitle">Construction equipment — linked to work packages in Construction</div>
        </div>
      </div>
      <div class="reg-item-wrap" id="equip-items-wrap"></div>
      <button class="reg-add-btn" onclick="toggleRegTypePicker('equipment')">＋ Add Equipment</button>
      <div class="reg-type-menu" id="reg-type-menu-equipment"></div>
      <div class="spec-card"><div class="reg-save-row">
        <button class="reg-save-btn" onclick="saveRegistry('equipment')">💾 Save All</button>
        <span class="reg-save-msg" id="reg-save-msg-equipment">Saved ✓</span>
      </div></div>
    </div>


    <div class="right-col">

      <div class="lock-card">
        <div class="lock-card-hdr">
          <span class="lock-card-title">Critical Issues</span>
          <span class="lock-icon" id="icon-issues">&#128274;</span>
        </div>
        <div class="lock-card-body" id="body-issues">
          <div class="lock-overlay">
            <svg class="lock-svg" viewBox="0 0 24 24" fill="none" stroke="#1a1f2e" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <div class="lock-msg">Unlocks after the first assessment is completed.</div>
            <span class="lock-req">Requires 1+ assessment</span>
          </div>
        </div>
      </div>
      <div class="lock-card">
        <div class="lock-card-hdr">
          <span class="lock-card-title">Action Plan</span>
          <span class="lock-icon" id="icon-actions">&#128274;</span>
        </div>
        <div class="lock-card-body" id="body-actions">
          <div class="lock-overlay">
            <svg class="lock-svg" viewBox="0 0 24 24" fill="none" stroke="#1a1f2e" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <div class="lock-msg">Unlocks after the first assessment is completed.</div>
            <span class="lock-req">Requires 1+ assessment</span>
          </div>
        </div>
      </div>
      <div class="lock-card">
        <div class="lock-card-hdr">
          <span class="lock-card-title">Scenario Analysis</span>
          <span class="lock-icon" id="icon-scenario">&#128274;</span>
        </div>
        <div class="lock-card-body" id="body-scenario">
          <div class="lock-overlay">
            <svg class="lock-svg" viewBox="0 0 24 24" fill="none" stroke="#1a1f2e" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <div class="lock-msg">Unlocks after 2 or more assessments are completed.</div>
            <span class="lock-req">Requires 2+ assessments</span>
          </div>
        </div>
      </div>
      <!-- Main Components card -->
      <div class="reg-card">
        <div class="reg-card-hdr">
          <span class="reg-card-icon">⚙️</span>
          <span class="reg-card-title">Main Components</span>
          <span class="reg-card-count" id="comp-reg-count">0</span>
        </div>
        <div class="reg-card-body">
          <div id="comp-reg-mini"></div>
          <button class="reg-open-btn" onclick="openRegPanel('components')">⚙️ Manage Components</button>
        </div>
      </div>

      <!-- Suppliers & Contractors card -->
      <div class="reg-card">
        <div class="reg-card-hdr">
          <span class="reg-card-icon">🏢</span>
          <span class="reg-card-title">Suppliers & Contractors</span>
          <span class="reg-card-count" id="supplier-reg-count">0</span>
        </div>
        <div class="reg-card-body">
          <div id="supplier-reg-mini"></div>
          <button class="reg-open-btn" onclick="openRegPanel('suppliers')">🏢 Manage Suppliers</button>
        </div>
      </div>

      <!-- Equipment card -->
      <div class="reg-card">
        <div class="reg-card-hdr">
          <span class="reg-card-icon">🚜</span>
          <span class="reg-card-title">Equipment</span>
          <span class="reg-card-count" id="equip-reg-count">0</span>
        </div>
        <div class="reg-card-body">
          <div id="equip-reg-mini"></div>
          <button class="reg-open-btn" onclick="openRegPanel('equipment')">🚜 Manage Equipment</button>
        </div>
      </div>

    </div>


<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

var ADMIN_CONFIG = {};

// Load admin config (thresholds, required fields) from DB
sb.from("admin_config").select("key,value").then(function(res) {
  if (!res.error && res.data) {
    res.data.forEach(function(r) { ADMIN_CONFIG[r.key] = r.value; });
  }
});

var CAT_FORM_DESIGN    = "1ArXEg";
var CAT_FORM_CONSTRUCT = "0QEdP9";
var CAT_FORM_CONTRACT  = "D4VBel";
var CAT_FORM_INTERCON  = "Gxr6Le";
var CAT_FORM_FINANCIAL = "rjl5Vo";
var CAT_FORM_PERMIT    = "xXdr2d";

var currentProjectId = null;
var currentUserId    = null;
var currentProject   = null;
var authResolved     = false;
var summaryRunning   = false;
var activeCatKey     = null;
var aiHistory        = {};  // per category
var pollTimer        = null;
var shareToken       = null;

/* =============================================
   CATEGORY SPEC DEFINITIONS
   Each category has: key, label, color, icon,
   sections[] → each with icon, title, fields[]
   field types: text | number | date | select | toggle
   ============================================= */
var CATEGORIES = [
  /* ── 1. PERMITS & ENTITLEMENTS ─────────────── */
  {
    key: "score_permit", label: "Permits & Entitlements", icon: "📜", color: "#c0392b",
    sections: [
      { icon: "📍", title: "Project Location", fields: [
        { lbl: "Project Name",          field: "proj_name",       type: "text",   col: 2 },
        { lbl: "County",                field: "county",          type: "text" },
        { lbl: "State",                 field: "state",           type: "select",  opts: ["","AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"] },
        { lbl: "ISO / RTO",             field: "iso_rto",         type: "select",  opts: ["","PJM","CAISO","ERCOT","MISO","SPP","NYISO","ISO-NE","WECC","Other"] },
        { lbl: "Latitude",              field: "latitude",        type: "number" },
        { lbl: "Longitude",             field: "longitude",       type: "number" },
        { lbl: "Parcel Numbers",        field: "parcel_numbers",  type: "text",   col: 2 },
        { lbl: "Flood Zone Classification", field: "flood_zone",  type: "select",  opts: ["","Zone X (minimal)","Zone AE","Zone A","Zone VE","Zone V","Unknown"] },
        { lbl: "Seismic Zone",          field: "seismic_zone",    type: "select",  opts: ["","Zone 0","Zone 1","Zone 2A","Zone 2B","Zone 3","Zone 4"] },
      ]},
      { icon: "🗺️", title: "Zoning & Land", fields: [
        { lbl: "Zoning Classification", field: "zoning_class",   type: "text" },
        { lbl: "CUP Status",            field: "cup_status",     type: "select",  opts: ["","Approved","Pending","Not Required","Denied"] },
        { lbl: "Setback Requirements (ft)", field: "setback_ft", type: "number" },
        { lbl: "Total Site Acreage",    field: "site_acres",     type: "number" },
        { lbl: "Buildable Acreage",     field: "buildable_acres",type: "number" },
        { lbl: "Land Ownership",        field: "land_ownership", type: "select",  opts: ["","Fee Simple","Lease","Mixed","Option"] },
        { lbl: "Lease Term (years)",    field: "lease_term_yrs", type: "number" },
        { lbl: "Lease Escalator (%/yr)",field: "lease_esc_pct",  type: "number" },
        { lbl: "Decommissioning Bond ($)", field: "decomm_bond", type: "number" },
      ]},
      { icon: "🌿", title: "Environmental", fields: [
        { lbl: "Phase I ESA Status",    field: "esa_status",     type: "select",  opts: ["","Complete – Clean","Complete – REC Identified","In Progress","Not Started"] },
        { lbl: "Wetlands Acreage",      field: "wetlands_acres", type: "number" },
        { lbl: "Endangered Species Impact", field: "esa_species",type: "toggle" },
        { lbl: "Mitigation Cost ($)",   field: "mitigation_cost",type: "number" },
        { lbl: "Cultural Resource Constraints", field: "cultural_constraints", type: "toggle" },
        { lbl: "SWPPP Required",        field: "swppp_req",      type: "toggle" },
        { lbl: "NEPA Required",         field: "nepa_req",       type: "toggle" },
      ]},
    ],
    missing: [
      { text: "CUP / SUP approval", impact: "Cannot proceed to construction without entitlement" },
      { text: "Phase I ESA", impact: "Lender prerequisite; may reveal remediation cost" },
      { text: "ALTA Survey", impact: "Required for title insurance and boundary confirmation" },
    ]
  },

  /* ── 2. DESIGN & ENGINEERING ────────────────── */
  {
    key: "score_design", label: "Design & Engineering", icon: "⚙️", color: "#2471a3",
    sections: [], // fields live inside per-array DESIGN_ARRAY_SECTIONS
    missing: [
      { text: "Energy Yield Assessment (P50/P90)", impact: "Core lender requirement; cross-check against PVWatts/Solargis" },
      { text: "Geotechnical Report with pile load test", impact: "Determines foundation design and cost risk" },
      { text: "IFC Single-Line Diagram", impact: "Required before construction start and grid connection" },
    ]
  },

  /* ── 3. CONSTRUCTION ────────────────────────── */
  {
    key: "score_construct", label: "Construction", icon: "🏗️", color: "#d35400",
    sections: [
      { icon: "📅", title: "Overall Schedule", fields: [
        { lbl: "NTP Date",                field: "ntp_date",            type: "date" },
        { lbl: "Construction Start",      field: "construction_start",  type: "date" },
        { lbl: "Mechanical Completion",   field: "mech_complete_date",  type: "date" },
        { lbl: "PAC Date",                field: "pac_date",            type: "date" },
        { lbl: "FAC / COD Target",        field: "cod_target_date",     type: "date" },
        { lbl: "Total Duration (months)", field: "const_duration_mo",   type: "number" },
        { lbl: "Weather Contingency (days)", field: "weather_days",     type: "number" },
        { lbl: "Float on Critical Path (days)", field: "cp_float_days", type: "number" },
      ]},
      { icon: "💰", title: "Budget & Cost", fields: [
        { lbl: "Total EPC Price ($)",     field: "epc_price",           type: "number" },
        { lbl: "EPC Price ($/Wdc)",       field: "epc_per_wdc",         type: "number" },
        { lbl: "Owner's Costs ($)",       field: "owners_costs",        type: "number" },
        { lbl: "Interconnection Cost ($)",field: "intercon_cost",       type: "number" },
        { lbl: "Land & Permitting ($)",   field: "land_permit_cost",    type: "number" },
        { lbl: "Contingency ($)",         field: "contingency_usd",     type: "number" },
        { lbl: "Contingency (%)",         field: "contingency_pct",     type: "number" },
        { lbl: "Sales / Use Tax ($)",     field: "sales_tax",           type: "number" },
      ]},
      { icon: "👷", title: "Workforce & Logistics", fields: [
        { lbl: "Peak Manpower (workers)", field: "peak_manpower",       type: "number" },
        { lbl: "Total Labour Hours",      field: "total_labour_hrs",    type: "number" },
        { lbl: "Subcontractors Count",    field: "subcontractor_count", type: "number" },
        { lbl: "Module Install Rate (mod/day)", field: "mod_rate_day",  type: "number" },
        { lbl: "Pile Drive Rate (piles/day)",   field: "pile_rate_day", type: "number" },
        { lbl: "Laydown Area (acres)",    field: "laydown_acres",       type: "number" },
        { lbl: "Nearest Truck Access (km)", field: "truck_access_km",  type: "number" },
        { lbl: "HSE Plan Approved",       field: "hse_plan",            type: "toggle" },
        { lbl: "QA/QC Plan Approved",     field: "qaqc_plan",           type: "toggle" },
      ]},
    ],
    missing: [
      { text: "Executed EPC Agreement", impact: "Pricing, liability and LDs unconfirmed until signed" },
      { text: "Critical Path Schedule (CPM)", impact: "Cannot validate COD date risk without detailed schedule" },
      { text: "Performance & Payment Bonds", impact: "Lender requirement for EPC completion risk" },
    ]
  },

  /* ── 4. PROCUREMENT ─────────────────────────── */
  {
    key: "score_procurement", label: "Procurement", icon: "📦", color: "#7d3c98",
    sections: [
      { icon: "📋", title: "EPC Contract Terms", fields: [
        { lbl: "EPC Contractor",        field: "epc_contractor_name", type: "text",   col: 2 },
        { lbl: "Contract Type",         field: "epc_contract_type",   type: "select", opts: ["","Lump-sum Turnkey (LSTK)","EPC with GMP","Cost-plus","Split-contract"] },
        { lbl: "Contract Value ($)",    field: "epc_contract_value",  type: "number" },
        { lbl: "$/Wdc",                 field: "epc_usd_wdc",         type: "number" },
        { lbl: "Currency",              field: "epc_currency",        type: "select", opts: ["","USD","EUR","GBP","AUD","CAD","Other"] },
        { lbl: "Incoterms",             field: "epc_incoterms",       type: "select", opts: ["","DDP","DAP","FCA","EXW","CIF","FOB"] },
        { lbl: "Governing Law",         field: "epc_governing_law",   type: "text" },
        { lbl: "Parent Guarantee",      field: "epc_parent_guarantee",type: "toggle" },
        { lbl: "Contract Execution Date", field: "epc_exec_date",     type: "date" },
      ]},
      { icon: "💳", title: "Milestone Payment Schedule", fields: [
        { lbl: "NTP Payment (%)",       field: "pmt_ntp_pct",         type: "number" },
        { lbl: "Mobilisation (%)",      field: "pmt_mob_pct",         type: "number" },
        { lbl: "Module Delivery (%)",   field: "pmt_mod_delivery_pct",type: "number" },
        { lbl: "Mechanical Complete (%)",field: "pmt_mech_comp_pct",  type: "number" },
        { lbl: "PAC (%)",               field: "pmt_pac_pct",         type: "number" },
        { lbl: "FAC / Final (%)",       field: "pmt_fac_pct",         type: "number" },
        { lbl: "Retention Amount (%)",  field: "pmt_retention_pct",   type: "number" },
        { lbl: "Retention Release",     field: "pmt_retention_release",type: "select", opts: ["","At FAC","12 months post-FAC","Split PAC/FAC"] },
      ]},
      { icon: "⚠️", title: "Liquidated Damages & Bonds", fields: [
        { lbl: "Performance LD ($/day)", field: "ld_perf_day",        type: "number" },
        { lbl: "Delay LD ($/day)",       field: "ld_delay_day",       type: "number" },
        { lbl: "Performance LD Cap (%)", field: "ld_perf_cap_pct",    type: "number" },
        { lbl: "Delay LD Cap (%)",       field: "ld_delay_cap_pct",   type: "number" },
        { lbl: "Performance Bond (%)",   field: "perf_bond_pct",      type: "number" },
        { lbl: "Payment Bond (%)",       field: "pay_bond_pct",       type: "number" },
      ]},
      { icon: "🔋", title: "Module Supply Agreement", fields: [
        { lbl: "Module Supplier",       field: "mod_supplier_name",   type: "text",   col: 2 },
        { lbl: "Contract Value ($)",    field: "mod_contract_value",  type: "number" },
        { lbl: "Incoterms",             field: "mod_incoterms",       type: "select", opts: ["","DDP","DAP","FCA","EXW","CIF","FOB"] },
        { lbl: "Price Validity Date",   field: "mod_price_validity",  type: "date" },
        { lbl: "Delivery LD ($/day)",   field: "mod_del_ld_day",      type: "number" },
        { lbl: "Insolvency Guarantee",  field: "mod_insolvency_guar", type: "toggle" },
        { lbl: "Domestic Content Cert", field: "mod_dom_content_cert",type: "toggle" },
      ]},
      { icon: "⚡", title: "Major Equipment Agreements", fields: [
        { lbl: "Inverter Supplier",     field: "inv_supplier_name",   type: "text" },
        { lbl: "Inverter Agreement Date",field:"inv_agr_date",        type: "date" },
        { lbl: "Tracker Supplier",      field: "tracker_supplier_name",type:"text" },
        { lbl: "Tracker Agreement Date",field: "tracker_agr_date",    type: "date" },
        { lbl: "BESS Supplier",         field: "bess_supplier_name",  type: "text" },
        { lbl: "BESS Agreement Date",   field: "bess_agr_date",       type: "date" },
        { lbl: "Transformer Lead Time (wks)", field: "xfmr_lead_wks",type: "number" },
        { lbl: "Spare Parts Budget ($)",field: "spare_parts_budget",  type: "number" },
      ]},
    ],
    missing: [
      { text: "Executed EPC Agreement", impact: "Price, LDs and liability unconfirmed until signed" },
      { text: "Module Supply Agreement with LDs", impact: "Delivery risk and IRA domestic content eligibility unverified" },
      { text: "Equipment availability letters (trackers, transformers)", impact: "Long-lead items may jeopardise COD date" },
    ]
  },

  /* ── 5. LEGAL ───────────────────────────────── */
  {
    key: "score_contract", label: "Legal", icon: "⚖️", color: "#1e8449",
    sections: [
      { icon: "📑", title: "PPA / Offtake", fields: [
        { lbl: "Offtaker Name",         field: "offtaker_name",   type: "text",   col: 2 },
        { lbl: "Offtaker Credit Rating",field: "offtaker_rating", type: "select",  opts: ["","AAA","AA+","AA","AA-","A+","A","A-","BBB+","BBB","BBB-","Below Investment Grade","Not Rated"] },
        { lbl: "PPA Term (years)",      field: "ppa_term_yrs",    type: "number" },
        { lbl: "Fixed Price ($/MWh)",   field: "ppa_price",       type: "number" },
        { lbl: "Price Escalator (%/yr)",field: "ppa_escalator_pct",type: "number" },
        { lbl: "PPA Start Date",        field: "ppa_start_date",  type: "date" },
        { lbl: "Merchant Tail (years)", field: "merchant_tail_yrs",type: "number" },
        { lbl: "Curtailment Compensation", field: "curtail_comp", type: "toggle" },
      ]},
      { icon: "🏛️", title: "Tax & Incentives", fields: [
        { lbl: "ITC or PTC Election",   field: "itc_ptc",         type: "select",  opts: ["","ITC (30%)","PTC","Not Determined"] },
        { lbl: "ITC Percentage (%)",    field: "itc_pct",         type: "number" },
        { lbl: "Domestic Content Bonus",field: "dom_content_bonus",type: "toggle" },
        { lbl: "Energy Community Bonus",field: "energy_comm_bonus",type: "toggle" },
        { lbl: "Prevailing Wage Compliance", field: "prev_wage",  type: "toggle" },
        { lbl: "State Incentives ($)",  field: "state_incentives",type: "number" },
        { lbl: "Property Tax Abatement",field: "prop_tax_abate",  type: "toggle" },
      ]},
      { icon: "🛡️", title: "Insurance", fields: [
        { lbl: "Builder's Risk Limit ($)", field: "builders_risk_limit", type: "number" },
        { lbl: "O&M Coverage Limit ($)",   field: "om_coverage_limit",   type: "number" },
        { lbl: "Business Interruption (months)", field: "bi_months",     type: "number" },
      ]},
    ],
    missing: [
      { text: "Executed PPA", impact: "Revenue stream unconfirmed; project unbankable without it" },
      { text: "Land Lease Agreement", impact: "Site security and assignment rights unconfirmed" },
      { text: "ITC/PTC Tax Opinion", impact: "Tax credit eligibility unverified; lender requirement" },
    ]
  },

  /* ── 6. GRID CONNECTION ─────────────────────── */
  {
    key: "score_intercon", label: "Grid Connection", icon: "⚡", color: "#117a65",
    sections: [
      { icon: "🔌", title: "Interconnection", fields: [
        { lbl: "Queue Position",        field: "queue_position",  type: "text" },
        { lbl: "POI Substation Name",   field: "poi_substation",  type: "text" },
        { lbl: "Interconnection Voltage (kV)", field: "intercon_kv", type: "number" },
        { lbl: "Network Upgrade Cost ($)", field: "network_upgrade_cost", type: "number" },
        { lbl: "Upgrade Scope Description", field: "upgrade_scope", type: "text", col: 2 },
        { lbl: "Milestone Security Posted ($)", field: "milestone_security", type: "number" },
        { lbl: "IA Execution Date",     field: "ia_exec_date",    type: "date" },
        { lbl: "Expected Upgrade Completion", field: "upgrade_complete_date", type: "date" },
      ]},
      { icon: "📊", title: "Market & Deliverability", fields: [
        { lbl: "Capacity Accreditation (%)", field: "cap_accredit_pct", type: "number" },
        { lbl: "ELCC Methodology",      field: "elcc_method",     type: "text" },
        { lbl: "Congestion Risk Score (1–10)", field: "congestion_score", type: "number" },
        { lbl: "Deliverability Status", field: "deliverability",  type: "select",  opts: ["","Full Capacity Deliverability","Partial Capacity Deliverability","Energy-Only","Unknown"] },
      ]},
    ],
    missing: [
      { text: "Executed Interconnection Agreement", impact: "Grid access unconfirmed; milestone costs may shift" },
      { text: "Facilities Study", impact: "Final upgrade scope and cost responsibility not established" },
      { text: "Deliverability / Capacity Accreditation Letter", impact: "Capacity revenue stream unconfirmed" },
    ]
  },

  /* ── 7. FINANCE ─────────────────────────────── */
  {
    key: "score_financial", label: "Finance", icon: "💵", color: "#1a5276",
    sections: [
      { icon: "💵", title: "Capital Stack", fields: [
        { lbl: "Total Capex ($)",       field: "total_capex",     type: "number" },
        { lbl: "Debt Amount ($)",       field: "debt_amount",     type: "number" },
        { lbl: "Debt Tenor (years)",    field: "debt_tenor_yrs",  type: "number" },
        { lbl: "Interest Rate (%)",     field: "interest_rate_pct",type: "number" },
        { lbl: "Sculpted DSCR",         field: "sculpted_dscr",   type: "number" },
        { lbl: "Minimum DSCR",          field: "min_dscr",        type: "number" },
        { lbl: "Tax Equity Amount ($)", field: "tax_equity_amt",  type: "number" },
        { lbl: "Target Flip Year",      field: "flip_year",       type: "number" },
        { lbl: "Sponsor Equity ($)",    field: "sponsor_equity",  type: "number" },
      ]},
      { icon: "📈", title: "Financial Metrics", fields: [
        { lbl: "Levered IRR (%)",       field: "levered_irr_pct", type: "number" },
        { lbl: "Unlevered IRR (%)",     field: "unlevered_irr_pct",type: "number" },
        { lbl: "NPV ($)",               field: "npv",             type: "number" },
        { lbl: "LCOE ($/MWh)",          field: "lcoe",            type: "number" },
        { lbl: "Breakeven PPA Price ($/MWh)", field: "breakeven_ppa", type: "number" },
        { lbl: "P50 DSCR",              field: "p50_dscr",        type: "number" },
        { lbl: "P90 DSCR",              field: "p90_dscr",        type: "number" },
      ]},
    ],
    missing: [
      { text: "Financial Model (native format)", impact: "Cannot validate DSCR, IRR or tax credit assumptions" },
      { text: "Independent Model Audit Report", impact: "Lender requirement before credit approval" },
      { text: "Tax Equity Commitment Letter", impact: "Tax equity terms and flip structure unconfirmed" },
    ]
  },
];

var CAT_MILESTONES = {
  "score_design": [
    { label: "30% Design", key: "tl_d_30" },
    { label: "60% Design", key: "tl_d_60" },
    { label: "90% Design", key: "tl_d_90" },
    { label: "IFC (Issued for Construction)", key: "tl_d_ifc" },
    { label: "As-Built", key: "tl_d_asbuilt" },
  ],
  "score_construct": [
    { label: "Contractor Appointed", key: "tl_c_appt" },
    { label: "Mobilisation", key: "tl_c_mob" },
    { label: "Foundation Complete", key: "tl_c_found" },
    { label: "Modules Installed", key: "tl_c_mod" },
    { label: "Energisation", key: "tl_c_enrg" },
    { label: "PAC (Provisional Acceptance)", key: "tl_c_pac" },
    { label: "FAC (Final Acceptance)", key: "tl_c_fac" },
  ],
  "score_contract": [
    { label: "Land Secured", key: "tl_l_land" },
    { label: "PPA Executed", key: "tl_l_ppa" },
    { label: "Financial Close", key: "tl_l_fc" },
    { label: "Legal Completion", key: "tl_l_comp" },
  ],
  "score_intercon": [
    { label: "Connection Study Submitted", key: "tl_g_study" },
    { label: "Offer Received", key: "tl_g_offer" },
    { label: "Offer Accepted", key: "tl_g_accept" },
    { label: "Agreement Signed", key: "tl_g_sign" },
    { label: "Energisation", key: "tl_g_enrg" },
  ],
  "score_financial": [
    { label: "Financial Model Complete", key: "tl_f_model" },
    { label: "Term Sheet Signed", key: "tl_f_ts" },
    { label: "Credit Approval", key: "tl_f_credit" },
    { label: "Financial Close", key: "tl_f_fc" },
  ],
  "score_permit": [
    { label: "Environmental Study Submitted", key: "tl_p_env_sub" },
    { label: "Environmental Approval", key: "tl_p_env_app" },
    { label: "Planning Application", key: "tl_p_plan_sub" },
    { label: "Planning Approval", key: "tl_p_plan_app" },
    { label: "Grid Permit Granted", key: "tl_p_grid" },
    { label: "Building Permit", key: "tl_p_build" },
  ],
  "score_procurement": [
    { label: "RFQ Issued", key: "tl_pr_rfq" },
    { label: "Bids Received", key: "tl_pr_bids" },
    { label: "Supplier Selected", key: "tl_pr_sel" },
    { label: "PO Issued", key: "tl_pr_po" },
    { label: "Equipment Delivered", key: "tl_pr_del" },
  ],
};

function scoreColor(s) {
  if (s == null) return "rgba(0,0,0,0.12)";
  if (s >= 70) return "#2e7d4f";
  if (s >= 40) return "#e07b20";
  return "#c0392b";
}

/* ---- SIDEBAR ---- */
function renderLeft(project) {
  var overall = project.score_overall;
  var ringEl  = document.getElementById("score-ring");
  var descEl  = document.getElementById("score-card-desc");
  if (overall != null) {
    var color = scoreColor(overall);
    ringEl.style.border    = "3px solid " + color;
    ringEl.style.background = "rgba(0,0,0,0.15)";
    ringEl.innerHTML = '<div><div class="score-ring-val" style="color:' + color + '">' + overall + '</div><div class="score-ring-sub">/100</div></div>';
    descEl.textContent = overall >= 70 ? "Good overall risk profile." :
                         overall >= 40 ? "Moderate risk - review flagged categories." :
                                         "High risk - action required.";
  }
  var sidebarEl = document.getElementById("sidebar");
  sidebarEl.innerHTML = "";
  var scoredCount = 0;
  CATEGORIES.forEach(function(cat) {
    var score    = project[cat.key];
    var hasScore = score != null;
    if (hasScore) scoredCount++;
    var pct   = hasScore ? Math.min(100, Math.max(0, score)) : 0;
    var color = scoreColor(score);
    var lbl   = hasScore ? score + "/100" : "--";

    // Spec completeness dot
    var tallyData = project.tally_fields || {};
    var dotColor;
    if (cat.key === 'score_design') {
      // Design uses per-array storage
      var daArrs = []; try { daArrs = JSON.parse(tallyData.design_arrays || '[]'); } catch(e){}
      var daTotal = 0, daFilled = 0;
      daArrs.forEach(function(arr) {
        if (typeof DESIGN_ARRAY_SECTIONS !== 'undefined') {
          DESIGN_ARRAY_SECTIONS.forEach(function(sec) {
            sec.fields.forEach(function(f) {
              daTotal++;
              var v = tallyData['arr_' + arr.id + '_' + f.field];
              if (v !== undefined && v !== null && String(v).trim() !== '' && v !== false) daFilled++;
            });
          });
        }
      });
      var daSpecPct = daTotal ? Math.round(daFilled / daTotal * 100) : 0;
      dotColor = daSpecPct === 0 ? '#b0b8c8' : daSpecPct === 100 ? '#2e7d4f' : '#e07b20';
    } else {
      var allFields = [];
      cat.sections.forEach(function(s) { s.fields.forEach(function(f) { allFields.push(f.field); }); });
      var filled = allFields.filter(function(f) { return tallyData[f] && tallyData[f] !== ''; }).length;
      var specPct = allFields.length ? Math.round(filled / allFields.length * 100) : 0;
      dotColor = specPct === 0 ? '#b0b8c8' : specPct === 100 ? '#2e7d4f' : '#e07b20';
    }

    var item = document.createElement("div");
    item.className = "cat-item" + (activeCatKey === cat.key ? " active" : "");
    item.id = "cat-item-" + cat.key;

    var btnRow = hasScore
      ? '<div class="cat-btn-row">' +
          '<button class="cat-start-btn" onclick="openCatPanel(\'' + cat.key + '\')">View</button>' +
        '</div>'
      : '<div class="cat-btn-row">' +
          '<button class="cat-start-btn" onclick="openCatPanel(\'' + cat.key + '\')">+ Start</button>' +
        '</div>';

    item.innerHTML =
      '<div class="cat-top">' +
        '<span class="cat-icon" style="font-size:12px;margin-right:4px;">' + cat.icon + '</span>' +
        '<span class="cat-name">' + cat.label + '</span>' +
        '<span class="cat-score-lbl">' + lbl + '<span class="cat-dot" style="background:' + dotColor + ';"></span></span>' +
      '</div>' +
      '<div class="cat-bar-track"><div class="cat-bar-fill" style="width:' + pct + '%;background:' + color + ';"></div></div>' +
      btnRow;
    sidebarEl.appendChild(item);
  });
  if (scoredCount >= 1) { unlockCard("issues"); unlockCard("actions"); }
  if (scoredCount >= 2) { unlockCard("scenario"); }
  updateTimeline(project);
}

function unlockCard(id) {
  var iconEl = document.getElementById("icon-" + id);
  var bodyEl = document.getElementById("body-" + id);
  if (iconEl) iconEl.textContent = "";
  var labels = { issues: "critical issue analysis", actions: "action plan", scenario: "scenario analysis" };
  if (bodyEl) bodyEl.innerHTML =
    '<div style="padding:8px 0;text-align:center;"><div style="font-size:11px;color:#6b7585;line-height:1.6;">Coming soon -- full ' + (labels[id] || id) + ' will appear here once the report engine is live.</div></div>';
}

/* ---- CATEGORY PANEL (Spec-first) ---- */
var activeSpecSections = {};  // { catKey: { sectionIdx: true } }

function openCatPanel(catKey) {
  var cat = CATEGORIES.find(function(c) { return c.key === catKey; });
  if (!cat || !currentProject) return;
  activeCatKey = catKey;
  if (!activeSpecSections[catKey]) activeSpecSections[catKey] = { 0: true }; // first section open by default

  document.getElementById("main-overview").style.display = "none";
  document.getElementById("doc-panel").classList.remove("open");
  ['components','suppliers','equipment'].forEach(function(k) {
    var p = document.getElementById('reg-panel-' + k); if (p) p.classList.remove('open');
  });
  var panel = document.getElementById("cat-panel");
  panel.classList.add("open");

  CATEGORIES.forEach(function(c) {
    var el = document.getElementById("cat-item-" + c.key);
    if (el) el.classList.toggle("active", c.key === catKey);
  });

  var score     = currentProject[catKey];
  var color     = scoreColor(score);
  var pct       = score != null ? Math.min(100, Math.max(0, score)) : 0;
  var scoreDesc = score == null ? "Not yet scored" :
                  score >= 70   ? "Good risk profile" :
                  score >= 40   ? "Moderate risk" : "High risk";
  var hasScore  = score != null;

  // --- Tab labels ---
  var scoreLabel = hasScore ? ' · ' + score : '';
  var tabs = [
    { id: "spec",       label: "📋 Specifications" },
    { id: "timeline",   label: "📅 Timeline" },
    { id: "assessment", label: "✅ Assessment" + scoreLabel },
    { id: "ai",         label: "💬 AI Q&A" },
  ];
  var tabsHtml = '<div class="cp-tabs">' +
    tabs.map(function(t, i) {
      return '<button class="cp-tab' + (i === 0 ? ' active' : '') + '" id="tab-btn-' + t.id + '" onclick="switchCatTab(\'' + t.id + '\')">' + t.label + '</button>';
    }).join('') +
  '</div>';

  // --- Spec pane: only Procurement uses the multi-component builder ---
  // Design and Construction have their own rich spec sections (Civil/Electrical/Mechanical etc.)
  var specPaneHtml = (catKey === 'score_procurement')
    ? buildProcurementContractsPane(currentProject)
    : (catKey === 'score_design')
      ? buildDesignPane(currentProject)
      : (catKey === 'score_construct')
        ? buildConstructionPane(currentProject)
        : buildSpecPane(cat, currentProject);

  // --- Timeline pane ---
  var timelinePaneHtml = '<div class="cp-tab-pane" id="tab-timeline">' + buildCatTimeline(catKey) + '</div>';

  // --- Assessment pane ---
  var assessPaneHtml = '<div class="cp-tab-pane" id="tab-assessment">' +
    '<div class="asmnt-panel">' +
      '<div class="asmnt-topbar">' +
        '<span class="asmnt-icon">' + cat.icon + '</span>' +
        '<span class="asmnt-title">' + cat.label + ' Assessment</span>' +
        '<span class="asmnt-badge">AI-Powered</span>' +
      '</div>' +
      '<div class="asmnt-body">' +
        (hasScore
          ? // Existing score — show it, offer retake
            '<div class="asmnt-score-reveal">' +
              '<div class="asmnt-score-ring" style="border-color:' + color + '">' +
                '<div class="asmnt-score-val" style="color:' + color + '">' + score + '</div>' +
                '<div class="asmnt-score-sub">/100</div>' +
              '</div>' +
              '<div class="asmnt-score-label" style="color:' + color + '">' + scoreDesc + '</div>' +
              (function(){
                var rat = ((currentProject.tally_fields||{})['asmnt_rationale_' + catKey] || '');
                return rat ? '<div class="asmnt-score-rationale">' + escHtml(rat) + '</div>' : '';
              })() +
              '<div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">' +
                '<button class="asmnt-save-btn" style="background:#2e7d4f;pointer-events:none;">✓ Score Saved</button>' +
                '<button class="asmnt-back-btn" style="padding:12px 18px;" onclick="startAiAssessment(\'' + catKey + '\')">🔄 Retake Assessment</button>' +
              '</div>' +
            '</div>'
          : // No score yet
            '<div style="text-align:center;padding:16px 0;display:flex;flex-direction:column;align-items:center;gap:18px;">' +
              '<div style="font-size:44px;opacity:0.4;">' + cat.icon + '</div>' +
              '<div style="font-size:13px;font-weight:700;color:#aaa;">No assessment yet</div>' +
              '<div style="font-size:11px;color:#555;max-width:280px;line-height:1.7;text-align:center;">Fill in your specifications first, then start the AI-powered assessment. Claude will generate 8 tailored due diligence questions based on your actual project data.</div>' +
              '<button onclick="startAiAssessment(\'' + catKey + '\')" class="spec-assess-btn" style="padding:13px 32px;font-size:12px;">▶ Start AI Assessment</button>' +
            '</div>'
        ) +
        // Priority missing docs always shown at bottom
        '<div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:12px 14px;margin-top:4px;">' +
          '<div style="font-size:9px;font-weight:700;text-transform:uppercase;color:#555;letter-spacing:.4px;margin-bottom:8px;">Priority Documents</div>' +
          cat.missing.map(function(m) {
            return '<div style="display:flex;gap:8px;align-items:flex-start;padding:5px 0;border-top:1px solid rgba(255,255,255,0.04);">' +
              '<div style="width:5px;height:5px;border-radius:50%;background:#e07b20;flex-shrink:0;margin-top:5px;"></div>' +
              '<div><div style="font-size:11px;color:#ccc;font-weight:600;">' + escHtml(m.text) + '</div>' +
              '<div style="font-size:10px;color:#555;margin-top:1px;">' + escHtml(m.impact) + '</div></div></div>';
          }).join('') +
        '</div>' +
      '</div>' +
    '</div>' +
  '</div>';

  // --- AI pane ---
  if (!aiHistory[catKey]) aiHistory[catKey] = [];
  var historyHtml = aiHistory[catKey].map(function(m) {
    return '<div class="cp-ai-msg ' + m.role + '">' + escHtml(m.content) + '</div>';
  }).join("");
  var aiPaneHtml = '<div class="cp-tab-pane" id="tab-ai">' +
    '<div class="cp-ai-card">' +
      '<div class="cp-ai-hdr">' +
        '<span class="cp-ai-label">Ask AI about ' + cat.label + '</span>' +
        '<span class="cp-ai-model">gpt-4o-mini</span>' +
      '</div>' +
      '<div class="cp-ai-body">' +
        '<div class="cp-ai-history" id="cp-ai-history">' + historyHtml + '</div>' +
        '<div class="cp-ai-input-row">' +
          '<input class="cp-ai-input" id="cp-ai-input" type="text" placeholder="Ask a question about this category..." onkeydown="if(event.key===\'Enter\')sendAiQuestion()"/>' +
          '<button class="cp-ai-send" id="cp-ai-send" onclick="sendAiQuestion()">Ask</button>' +
        '</div>' +
      '</div>' +
    '</div>' +
  '</div>';

  // --- Assemble ---
  panel.innerHTML =
    '<div class="cp-header">' +
      '<div class="cp-header-left">' +
        '<button class="cp-back" onclick="closeCatPanel()">&#8592; Overview</button>' +
        '<span style="font-size:18px;">' + cat.icon + '</span>' +
        '<span class="cp-title">' + cat.label + '</span>' +
      '</div>' +
      '<div class="cp-header-right">' +
        '<button class="cp-share-btn" onclick="openShareModal(\'' + catKey + '\')">&#128279; Share</button>' +
      '</div>' +
    '</div>' +
    tabsHtml +
    specPaneHtml +
    timelinePaneHtml +
    assessPaneHtml +
    aiPaneHtml;

  switchCatTab('spec');
  loadCatMilestones(catKey, currentProject);
  scrollAiHistory();
}

function switchCatTab(tabId) {
  ['spec','timeline','assessment','ai'].forEach(function(id) {
    var btn  = document.getElementById('tab-btn-' + id);
    var pane = document.getElementById('tab-' + id);
    if (btn)  btn.classList.toggle('active', id === tabId);
    if (pane) pane.classList.toggle('active', id === tabId);
  });
}

/* ================================================================
   DESIGN & ENGINEERING — ARRAY-LEVEL BUILDER
   tally_fields.design_arrays = [{id, name}]
   Field values stored as tally_fields['arr_{id}_{field}']
   ================================================================ */

var DESIGN_ARRAY_SECTIONS = [
  { icon: '☀️', title: 'Resource & Yield', key: 'yield', fields: [
    { lbl:'Irradiance Data Source',        field:'irr_source',       type:'select', opts:['','NSRDB','Meteonorm','SolarAnywhere','Solargis','Other'] },
    { lbl:'GHI (kWh/m²/yr)',               field:'ghi',              type:'number' },
    { lbl:'P50 Production (MWh/yr)',        field:'p50_mwh',          type:'number' },
    { lbl:'P90 Production (MWh/yr)',        field:'p90_mwh',          type:'number' },
    { lbl:'P99 Production (MWh/yr)',        field:'p99_mwh',          type:'number' },
    { lbl:'Net Capacity Factor (%)',        field:'net_cf_pct',       type:'number' },
    { lbl:'Annual Degradation (%/yr)',      field:'degradation_pct',  type:'number' },
    { lbl:'Availability (%)',               field:'availability_pct', type:'number' },
    { lbl:'Curtailment (%)',                field:'curtailment_pct',  type:'number' },
    { lbl:'DC Size (MWdc)',                 field:'dc_mw',            type:'number' },
    { lbl:'AC Size (MWac)',                 field:'ac_mw',            type:'number' },
    { lbl:'DC:AC Ratio (ILR)',              field:'ilr',              type:'number' },
    { lbl:'Yield Model Software',           field:'yield_software',   type:'select', opts:['','PVsyst','SAM','PVsol','Homer','Other'] },
    { lbl:'Independent Engineer Review',    field:'ie_review',        type:'toggle' },
  ]},
  { icon: '🏗️', title: 'Civil & Structural', key: 'civil', fields: [
    { lbl:'Racking System',                 field:'racking_type',     type:'select', opts:['','Single-Axis Tracker','Fixed Tilt','Dual-Axis','Floating'] },
    { lbl:'Pile Type',                      field:'pile_type',        type:'select', opts:['','Driven Steel','Helical','Ground Screw','Ballasted','Concrete Cast In-Situ'] },
    { lbl:'Max Wind Design (m/s)',          field:'wind_speed_ms',    type:'number' },
    { lbl:'Snow Load (kN/m²)',              field:'snow_load_knm2',   type:'number' },
    { lbl:'Ground Coverage Ratio (%)',      field:'gcr_pct',          type:'number' },
    { lbl:'Row Pitch (m)',                  field:'row_pitch_m',      type:'number' },
    { lbl:'Module Tilt Angle (°)',          field:'tilt_deg',         type:'number' },
    { lbl:'Ground Clearance Min (mm)',      field:'clearance_mm',     type:'number' },
    { lbl:'Total Site Area (ha)',           field:'site_ha',          type:'number' },
    { lbl:'Total Site Grading (m³)',        field:'grading_m3',       type:'number' },
    { lbl:'Access Road Length (km)',        field:'road_km',          type:'number' },
    { lbl:'Site Boundary Fencing (km)',     field:'fence_km',         type:'number' },
    { lbl:'Corrosion Category',             field:'corrosion_cat',    type:'select', opts:['','C1 (Very Low)','C2 (Low)','C3 (Medium)','C4 (High)','C5 (Very High)'] },
    { lbl:'Civil Design Firm',              field:'civil_firm',       type:'text',   col:2 },
  ]},
  { icon: '🪨', title: 'Geological Study', key: 'geo', fields: [
    { lbl:'Geotechnical Firm',              field:'geo_firm',         type:'text',   col:2 },
    { lbl:'Study Status',                   field:'geo_status',       type:'select', opts:['','Not Started','In Progress','Phase I Complete','Phase II Complete','Final Report Issued'] },
    { lbl:'Soil Classification (USCS)',     field:'soil_uscs',        type:'select', opts:['','GW (Well-graded gravel)','GP (Poorly-graded gravel)','GM (Silty gravel)','GC (Clayey gravel)','SW (Well-graded sand)','SP (Poorly-graded sand)','SM (Silty sand)','SC (Clayey sand)','ML (Silt low plasticity)','CL (Lean clay)','CH (Fat clay)','MH (Elastic silt)','OH (Organic clay)','PT (Peat)','Other'] },
    { lbl:'AASHTO Soil Classification',     field:'soil_aashto',      type:'text' },
    { lbl:'Rock Classification',            field:'rock_class',       type:'select', opts:['','None / Soil Only','Weathered Rock','Soft Rock','Medium Rock','Hard Rock','Very Hard Rock'] },
    { lbl:'Rock Depth (m)',                 field:'rock_depth_m',     type:'number' },
    { lbl:'Groundwater Depth (m)',          field:'gw_depth_m',       type:'number' },
    { lbl:'SPT N-value (avg)',              field:'spt_n',            type:'number' },
    { lbl:'Undrained Shear Strength (kPa)', field:'cu_kpa',           type:'number' },
    { lbl:'Bearing Capacity (kN/m²)',       field:'bearing_kpa',      type:'number' },
    { lbl:'Liquefaction Risk',              field:'liquefaction',     type:'select', opts:['','None','Low','Moderate','High','Not Assessed'] },
    { lbl:'Expansive Soils',                field:'expansive_soils',  type:'toggle' },
    { lbl:'Contaminated Land',              field:'contaminated',     type:'toggle' },
    { lbl:'Pull-out Test Conducted',        field:'pullout_test',     type:'toggle' },
    { lbl:'Pull-out Resistance (kN)',       field:'pullout_kn',       type:'number' },
    { lbl:'Pile Embedment Depth (m)',        field:'embedment_m',      type:'number' },
    { lbl:'Pile Design Load Compression (kN)', field:'pile_comp_kn', type:'number' },
    { lbl:'Pile Design Load Tension (kN)', field:'pile_tens_kn',     type:'number' },
    { lbl:'Pile Spacing (m)',               field:'pile_spacing_m',   type:'number' },
    { lbl:'Test Pile Report',               field:'test_pile_report', type:'toggle' },
    { lbl:'Slope Stability Analysis',       field:'slope_stability',  type:'toggle' },
    { lbl:'Erosion / Sedimentation Risk',   field:'erosion_risk',     type:'select', opts:['','Low','Moderate','High','Not Assessed'] },
    { lbl:'Seismic Zone / PGA (g)',         field:'seismic_pga',      type:'text' },
    { lbl:'Corrosion of Buried Steel',      field:'buried_corrosion', type:'select', opts:['','Low','Moderate','High — galv. required','Not Assessed'] },
    { lbl:'Notes',                          field:'geo_notes',        type:'text',   col:2 },
  ]},
  { icon: '⚡', title: 'Electrical', key: 'elec', fields: [
    { lbl:'Strings per Inverter',           field:'strings_per_inv',  type:'number' },
    { lbl:'Modules per String',             field:'mods_per_string',  type:'number' },
    { lbl:'Collector Voltage (kV)',         field:'collector_kv',     type:'number' },
    { lbl:'POI Voltage (kV)',               field:'poi_kv',           type:'number' },
    { lbl:'DC Cable Total (km)',            field:'dc_cable_km',      type:'number' },
    { lbl:'AC Cable Total (km)',            field:'ac_cable_km',      type:'number' },
    { lbl:'MV Cable (km)',                  field:'mv_cable_km',      type:'number' },
    { lbl:'Number of Combiner Boxes',       field:'combiner_boxes',   type:'number' },
    { lbl:'SCADA Vendor',                   field:'scada_vendor',     type:'text' },
    { lbl:'Reactive Power Capability',      field:'reactive_power',   type:'toggle' },
    { lbl:'Protection Relay Standard',      field:'protection_std',   type:'text' },
    { lbl:'Anti-Islanding Protection',      field:'anti_islanding',   type:'toggle' },
    { lbl:'IFC SLD Issued',                 field:'ifc_sld',          type:'toggle' },
    { lbl:'Electrical Design Firm',         field:'elec_firm',        type:'text',   col:2 },
  ]},
  { icon: '🔧', title: 'Mechanical & BESS Integration', key: 'mech', fields: [
    { lbl:'BESS Included in Array',         field:'bess_included',    type:'toggle' },
    { lbl:'BESS Energy (MWh)',              field:'bess_mwh',         type:'number' },
    { lbl:'BESS Power (MW)',                field:'bess_mw',          type:'number' },
    { lbl:'BESS Duration (hr)',             field:'bess_dur_hr',      type:'number' },
    { lbl:'BESS Coupling',                  field:'bess_coupling',    type:'select', opts:['','AC-coupled','DC-coupled','Not applicable'] },
    { lbl:'Shared POI (Solar+BESS)',        field:'shared_poi',       type:'toggle' },
    { lbl:'Firefighting System',            field:'fire_system',      type:'select', opts:['','Inert Gas','FM200','Water Mist','Dry Chemical','Sprinkler','Not Required'] },
    { lbl:'Security System',               field:'security_system',   type:'select', opts:['','CCTV + Motion','Perimeter Fence Sensor','Thermal','CCTV Only','None'] },
    { lbl:'Met Station',                    field:'met_station',      type:'toggle' },
    { lbl:'O&M Building',                   field:'om_building',      type:'toggle' },
    { lbl:'Mechanical Design Firm',         field:'mech_firm',        type:'text',   col:2 },
  ]},
];

/* Storage */
function getDesignArrays() {
  var tf = (currentProject && currentProject.tally_fields) || {};
  try { return JSON.parse(tf.design_arrays || '[]'); } catch(e) { return []; }
}
function saveDesignArrays(arrays, cb) {
  if (!currentProjectId || !currentUserId) return;
  var tf = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  tf.design_arrays = JSON.stringify(arrays);
  if (currentProject) currentProject.tally_fields = tf;
  sb.from('projects').update({ tally_fields: tf, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(r) { if (cb) cb(r); });
}
function daUid() { return 'da_' + Date.now() + '_' + Math.floor(Math.random()*9999); }

/* AI context */
function buildDesignAsmntContext() {
  var arrays = getDesignArrays();
  var tf     = (currentProject && currentProject.tally_fields) || {};
  if (!arrays.length) return 'No design arrays defined yet.';
  return arrays.map(function(arr, i) {
    var lines = ['Array ' + (i+1) + ': ' + (arr.name || 'Unnamed')];
    DESIGN_ARRAY_SECTIONS.forEach(function(sec) {
      var sl = sec.fields.map(function(f) {
        var v = tf['arr_' + arr.id + '_' + f.field];
        return (v !== undefined && v !== null && String(v).trim() !== '' && v !== false) ? '    ' + f.lbl + ': ' + v : null;
      }).filter(Boolean);
      if (sl.length) { lines.push('  [' + sec.title + ']'); lines = lines.concat(sl); }
    });
    return lines.join('\n');
  }).join('\n\n');
}

/* State */
var daOpenState = {};
var daSubState  = {};

/* Build pane */
function buildDesignPane(project) {
  var arrays = getDesignArrays();
  var tf     = project.tally_fields || {};
  var totalF = 0, filledF = 0;
  arrays.forEach(function(arr) {
    DESIGN_ARRAY_SECTIONS.forEach(function(sec) {
      sec.fields.forEach(function(f) {
        totalF++;
        var k = 'arr_' + arr.id + '_' + f.field;
        if (tf[k] !== undefined && tf[k] !== null && String(tf[k]).trim() !== '' && tf[k] !== false) filledF++;
      });
    });
  });
  var pct = totalF ? Math.round(filledF / totalF * 100) : 0;
  var fc  = pct === 100 ? '#2e7d4f' : pct > 40 ? '#e07b20' : '#c0392b';

  var html = '<div class="cp-tab-pane" id="tab-spec">';
  html += '<div class="spec-completeness">' +
    '<div class="spec-comp-bar-wrap"><div class="spec-comp-label">Design Specs Completeness</div>' +
    '<div class="spec-comp-track" style="margin-top:6px;"><div class="spec-comp-fill" id="da-comp-fill" style="width:' + pct + '%;background:' + fc + ';"></div></div></div>' +
    '<div style="text-align:right;flex-shrink:0;"><div class="spec-comp-pct" id="da-comp-pct">' + pct + '%</div>' +
    '<div class="spec-comp-hint" id="da-comp-hint">' + arrays.length + ' array' + (arrays.length !== 1 ? 's' : '') + ' · ' + filledF + '/' + totalF + ' fields</div></div></div>';

  html += '<div id="da-arrays-wrap">';
  if (!arrays.length) {
    html += '<div class="da-empty-state"><div style="font-size:32px;margin-bottom:8px;">☀️ 🔌</div>' +
      '<div style="font-size:12px;font-weight:700;color:#2471a3;margin-bottom:4px;">No arrays defined yet</div>' +
      '<div style="font-size:11px;color:#8a95a5;line-height:1.5;">Add a PV or BESS array below. Each array gets its own full set of specifications.</div></div>';
  } else {
    arrays.forEach(function(arr) { html += buildDaCard(arr, tf); });
  }
  html += '</div>';

  html += '<button class="da-add-btn" onclick="addDesignArray()"><span style="font-size:18px;">＋</span> Add PV / BESS Array</button>';

  html += '<div class="spec-card" style="margin-top:10px;"><div class="spec-save-row">' +
    '<button class="spec-save-btn" onclick="saveDesignSpec()">💾 Save All</button>' +
    '<span class="spec-save-msg" id="spec-save-msg">Saved ✓</span>' +
    '<button class="spec-assess-btn" onclick="openCatForm(\'score_design\')">▶ ' +
      (currentProject.score_design != null ? 'Retake Assessment' : 'Start Assessment') + '</button>' +
  '</div></div>';

  html += '</div>';
  return html;
}

function buildDaCard(arr, tf) {
  var name    = arr.name || 'Array';
  var arrOpen = daOpenState[arr.id] !== false;
  var total = 0, filled = 0;
  DESIGN_ARRAY_SECTIONS.forEach(function(sec) {
    sec.fields.forEach(function(f) {
      total++;
      var k = 'arr_' + arr.id + '_' + f.field;
      if (tf[k] !== undefined && tf[k] !== null && String(tf[k]).trim() !== '' && tf[k] !== false) filled++;
    });
  });
  var pct = total ? Math.round(filled / total * 100) : 0;

  var html = '<div class="da-array-card" id="dac-' + arr.id + '">' +
    '<div class="da-array-hdr" onclick="toggleDaArray(\'' + arr.id + '\')">' +
      '<span class="da-array-icon">☀️</span>' +
      '<div class="da-array-name-wrap">' +
        '<div class="da-array-name" id="daname-' + arr.id + '">' + escHtml(name) + '</div>' +
        '<div class="da-array-meta">' + filled + ' / ' + total + ' fields filled</div>' +
      '</div>' +
      '<span class="da-array-pct-badge" id="dapct-' + arr.id + '">' + pct + '%</span>' +
      '<span class="da-array-chev' + (arrOpen ? ' open' : '') + '" id="dachev-' + arr.id + '">▼</span>' +
      '<button class="da-array-del" onclick="deleteDesignArray(event,\'' + arr.id + '\')">✕ Remove</button>' +
    '</div>' +
    '<div class="da-array-body' + (arrOpen ? ' open' : '') + '" id="dabody-' + arr.id + '">' +
    '<div class="da-name-row">' +
      '<span class="da-name-lbl">Array Name</span>' +
      '<input class="da-name-input" type="text" data-arr-name="' + arr.id + '" value="' + escHtml(name) + '" placeholder="e.g. Phase 1 North Field" oninput="onDaNameChange(this)"/>' +
    '</div>';

  DESIGN_ARRAY_SECTIONS.forEach(function(sec, sIdx) {
    var stateKey = arr.id + '_' + sec.key;
    var secOpen  = daSubState[stateKey] === true;
    var secFill  = sec.fields.filter(function(f) {
      var k = 'arr_' + arr.id + '_' + f.field;
      return tf[k] !== undefined && tf[k] !== null && String(tf[k]).trim() !== '' && tf[k] !== false;
    }).length;

    html += '<div class="spec-card">' +
      '<div class="spec-section-hdr" onclick="toggleDaSubSection(\'' + arr.id + '\',\'' + sec.key + '\',' + sIdx + ')">' +
        '<span class="spec-section-icon">' + sec.icon + '</span>' +
        '<span class="spec-section-title">' + sec.title + '</span>' +
        '<span class="spec-section-filled">' + secFill + '/' + sec.fields.length + '</span>' +
        '<span class="spec-section-chev' + (secOpen ? ' open' : '') + '" id="dasubchev-' + stateKey + '">▼</span>' +
      '</div>' +
      '<div class="spec-section-body' + (secOpen ? ' open' : '') + '" id="dasub-' + stateKey + '">' +
      '<div class="spec-grid">';

    sec.fields.forEach(function(f) {
      var fKey = 'arr_' + arr.id + '_' + f.field;
      var val  = (tf[fKey] !== undefined) ? tf[fKey] : '';
      var full = f.col === 2 ? ' full' : '';
      html += '<div class="spec-field' + full + '"><label class="spec-lbl">' + f.lbl + '</label>';
      if (f.type === 'toggle') {
        var chk = val === true || val === 'true' || val === 'Y';
        html += '<div class="spec-toggle-row"><label class="spec-toggle"><input type="checkbox" data-arr="' + arr.id + '" data-field="' + f.field + '" data-type="toggle"' + (chk ? ' checked' : '') + ' onchange="onDaFieldChange(this)"/><span class="spec-toggle-slider"></span></label><span class="spec-toggle-lbl">' + (chk ? 'Yes' : 'No') + '</span></div>';
      } else if (f.type === 'select') {
        html += '<select class="spec-select" data-arr="' + arr.id + '" data-field="' + f.field + '" onchange="onDaFieldChange(this)">';
        (f.opts || []).forEach(function(o) { html += '<option value="' + escHtml(o) + '"' + (String(val) === o ? ' selected' : '') + '>' + escHtml(o || '— Select —') + '</option>'; });
        html += '</select>';
      } else {
        html += '<input class="spec-input" type="' + f.type + '" data-arr="' + arr.id + '" data-field="' + f.field + '" value="' + escHtml(String(val)) + '" placeholder="Enter value" oninput="onDaFieldChange(this)"/>';
      }
      html += '</div>';
    });
    html += '</div></div></div>';
  });

  html += '</div></div>';
  return html;
}

function toggleDaArray(arrId) {
  daOpenState[arrId] = daOpenState[arrId] === false ? true : false;
  var body = document.getElementById('dabody-' + arrId);
  var chev = document.getElementById('dachev-' + arrId);
  if (body) body.classList.toggle('open', daOpenState[arrId] !== false);
  if (chev) chev.classList.toggle('open', daOpenState[arrId] !== false);
}

function toggleDaSubSection(arrId, secKey, sIdx) {
  var stateKey = arrId + '_' + secKey;
  daSubState[stateKey] = !daSubState[stateKey];
  var body = document.getElementById('dasub-' + stateKey);
  var chev = document.getElementById('dasubchev-' + stateKey);
  if (body) body.classList.toggle('open', daSubState[stateKey]);
  if (chev) chev.classList.toggle('open', daSubState[stateKey]);
}

function onDaNameChange(el) {
  var arrId = el.getAttribute('data-arr-name');
  var el2   = document.getElementById('daname-' + arrId);
  if (el2) el2.textContent = el.value.trim() || 'Array';
}

function onDaFieldChange(el) {
  if (el.type === 'checkbox') {
    var row = el.closest('.spec-toggle-row');
    if (row) { var lbl = row.querySelector('.spec-toggle-lbl'); if (lbl) lbl.textContent = el.checked ? 'Yes' : 'No'; }
  }
}

function addDesignArray() {
  var arrays  = getDesignArrays();
  var newId   = daUid();
  var newName = 'Array ' + (arrays.length + 1);
  arrays.push({ id: newId, name: newName });
  daOpenState[newId] = true;
  saveDesignArrays(arrays, function() {
    var wrap = document.getElementById('da-arrays-wrap');
    if (!wrap) return;
    var tf = (currentProject && currentProject.tally_fields) || {};
    var empty = wrap.querySelector('.da-empty-state');
    if (empty) empty.remove();
    wrap.insertAdjacentHTML('beforeend', buildDaCard({ id: newId, name: newName }, tf));
    updateDaCompleteness();
    var card = document.getElementById('dac-' + newId);
    if (card) card.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
}

function deleteDesignArray(evt, arrId) {
  evt.stopPropagation();
  if (!confirm('Remove this array and all its specs?')) return;
  var arrays = getDesignArrays().filter(function(a) { return a.id !== arrId; });
  var tf = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  Object.keys(tf).forEach(function(k) { if (k.startsWith('arr_' + arrId + '_')) delete tf[k]; });
  tf.design_arrays = JSON.stringify(arrays);
  if (currentProject) currentProject.tally_fields = tf;
  sb.from('projects').update({ tally_fields: tf, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function() {
      var card = document.getElementById('dac-' + arrId);
      if (card) card.remove();
      var wrap = document.getElementById('da-arrays-wrap');
      if (wrap && !wrap.querySelector('.da-array-card')) {
        wrap.innerHTML = '<div class="da-empty-state"><div style="font-size:32px;margin-bottom:8px;">☀️ 🔌</div>' +
          '<div style="font-size:12px;font-weight:700;color:#2471a3;margin-bottom:4px;">No arrays defined yet</div>' +
          '<div style="font-size:11px;color:#8a95a5;line-height:1.5;">Add a PV or BESS array below.</div></div>';
      }
      updateDaCompleteness();
    });
}

function saveDesignSpec() {
  if (!currentProjectId || !currentUserId) return;
  var arrays = getDesignArrays();
  var tf     = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  document.querySelectorAll('[data-arr-name]').forEach(function(el) {
    var arrId = el.getAttribute('data-arr-name');
    var arr   = arrays.find(function(a) { return a.id === arrId; });
    if (arr) arr.name = el.value.trim() || 'Array';
  });
  document.querySelectorAll('[data-arr][data-field]').forEach(function(el) {
    var arrId = el.getAttribute('data-arr');
    var field = el.getAttribute('data-field');
    tf['arr_' + arrId + '_' + field] = el.type === 'checkbox' ? el.checked : el.value.trim();
  });
  tf.design_arrays = JSON.stringify(arrays);
  if (currentProject) currentProject.tally_fields = tf;
  sb.from('projects').update({ tally_fields: tf, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(res) {
      if (res && res.error) { alert('Save failed: ' + res.error.message); return; }
      var msg = document.getElementById('spec-save-msg');
      if (msg) { msg.classList.add('show'); setTimeout(function() { msg.classList.remove('show'); }, 2500); }
      updateDaCompleteness();
      renderLeft(currentProject);
    });
}

function updateDaCompleteness() {
  var arrays = getDesignArrays();
  var tf     = (currentProject && currentProject.tally_fields) || {};
  var total  = 0, filled = 0;
  arrays.forEach(function(arr) {
    DESIGN_ARRAY_SECTIONS.forEach(function(sec) {
      sec.fields.forEach(function(f) {
        total++;
        var k = 'arr_' + arr.id + '_' + f.field;
        if (tf[k] !== undefined && tf[k] !== null && String(tf[k]).trim() !== '' && tf[k] !== false) filled++;
      });
    });
  });
  var pct = total ? Math.round(filled / total * 100) : 0;
  var fc  = pct === 100 ? '#2e7d4f' : pct > 40 ? '#e07b20' : '#c0392b';
  var fillEl = document.getElementById('da-comp-fill');
  var pctEl  = document.getElementById('da-comp-pct');
  var hint   = document.getElementById('da-comp-hint');
  if (fillEl) { fillEl.style.width = pct + '%'; fillEl.style.background = fc; }
  if (pctEl)  pctEl.textContent  = pct + '%';
  if (hint)   hint.textContent   = arrays.length + ' array' + (arrays.length !== 1 ? 's' : '') + ' · ' + filled + '/' + total + ' fields';
  arrays.forEach(function(arr) {
    var at = 0, af = 0;
    DESIGN_ARRAY_SECTIONS.forEach(function(sec) {
      sec.fields.forEach(function(f) {
        at++;
        var k = 'arr_' + arr.id + '_' + f.field;
        if (tf[k] !== undefined && tf[k] !== null && String(tf[k]).trim() !== '' && tf[k] !== false) af++;
      });
    });
    var ap    = at ? Math.round(af / at * 100) : 0;
    var badge = document.getElementById('dapct-' + arr.id);
    var hdr   = badge && badge.closest('.da-array-hdr');
    var meta  = hdr && hdr.querySelector('.da-array-meta');
    if (badge) badge.textContent = ap + '%';
    if (meta)  meta.textContent  = af + ' / ' + at + ' fields filled';
  });
}

/* CSS for design array cards — injected once */
(function() {
  if (document.getElementById('da-css')) return;
  var s = document.createElement('style');
  s.id = 'da-css';
  s.textContent = [
    '.da-array-card{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.08);border:1.5px solid rgba(36,113,163,0.18);margin-bottom:10px;}',
    '.da-array-hdr{padding:12px 16px;background:linear-gradient(135deg,#1a2f45 0%,#2471a3 100%);display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none;}',
    '.da-array-icon{font-size:18px;flex-shrink:0;}',
    '.da-array-name-wrap{flex:1;min-width:0;}',
    '.da-array-name{font-size:13px;font-weight:900;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}',
    '.da-array-meta{font-size:9px;color:rgba(255,255,255,0.5);margin-top:2px;}',
    '.da-array-pct-badge{font-size:10px;font-weight:700;background:rgba(255,255,255,0.12);color:#fff;padding:3px 9px;border-radius:20px;flex-shrink:0;}',
    '.da-array-chev{font-size:11px;color:rgba(255,255,255,0.5);transition:transform .2s;flex-shrink:0;}',
    '.da-array-chev.open{transform:rotate(180deg);}',
    '.da-array-del{padding:3px 9px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:20px;font-family:Inter,sans-serif;font-size:9px;font-weight:700;color:rgba(255,255,255,0.6);cursor:pointer;flex-shrink:0;transition:all .12s;}',
    '.da-array-del:hover{background:#c0392b;border-color:#c0392b;color:#fff;}',
    '.da-array-body{display:none;padding:12px;background:#f5f7fa;}',
    '.da-array-body.open{display:block;}',
    '.da-name-row{display:flex;gap:8px;align-items:center;margin-bottom:10px;padding:8px 12px;background:#fff;border-radius:8px;border:1px solid rgba(0,0,0,0.08);}',
    '.da-name-lbl{font-size:9px;font-weight:700;text-transform:uppercase;color:#8a95a5;flex-shrink:0;}',
    '.da-name-input{flex:1;border:none;outline:none;font-family:Inter,sans-serif;font-size:13px;font-weight:700;color:#1a1f2e;background:transparent;}',
    '.da-array-body .spec-card{background:#fff;margin-bottom:6px;}',
    '.da-array-body .spec-section-hdr{background:rgba(36,113,163,0.06);}',
    '.da-array-body .spec-section-hdr:hover{background:rgba(36,113,163,0.12);}',
    '.da-add-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px;background:rgba(36,113,163,0.07);border:1.5px dashed rgba(36,113,163,0.3);border-radius:12px;font-family:Inter,sans-serif;font-size:11px;font-weight:700;color:#2471a3;cursor:pointer;transition:all .15s;margin-bottom:8px;}',
    '.da-add-btn:hover{background:rgba(36,113,163,0.14);border-color:#2471a3;}',
    '.da-empty-state{text-align:center;padding:36px 16px;background:rgba(36,113,163,0.05);border-radius:12px;border:1.5px dashed rgba(36,113,163,0.2);margin-bottom:10px;}',
  ].join('');
  document.head.appendChild(s);
})();

function buildSpecPane(cat, project) {
  var tallyData = project.tally_fields || {};
  var allFields = [];
  cat.sections.forEach(function(s) { s.fields.forEach(function(f) { allFields.push(f.field); }); });
  var filled = allFields.filter(function(f) { return tallyData[f] && String(tallyData[f]).trim() !== ''; }).length;
  var pct = allFields.length ? Math.round(filled / allFields.length * 100) : 0;
  var fillColor = pct === 100 ? '#2e7d4f' : pct > 40 ? '#e07b20' : '#c0392b';

  var html = '<div class="cp-tab-pane" id="tab-spec">';
  html += '<div class="spec-completeness">' +
    '<div class="spec-comp-bar-wrap">' +
      '<div class="spec-comp-label">Specifications Completeness</div>' +
      '<div class="spec-comp-track"><div class="spec-comp-fill" style="width:' + pct + '%;background:' + fillColor + ';"></div></div>' +
    '</div>' +
    '<div style="text-align:right;">' +
      '<div class="spec-comp-pct">' + pct + '%</div>' +
      '<div class="spec-comp-hint">' + filled + ' / ' + allFields.length + ' fields</div>' +
    '</div>' +
  '</div>';

  if (!activeSpecSections[cat.key]) activeSpecSections[cat.key] = { 0: true };
  cat.sections.forEach(function(section, sIdx) {
    var secOpen   = activeSpecSections[cat.key] && activeSpecSections[cat.key][sIdx];
    var secFilled = section.fields.filter(function(f) { return tallyData[f.field] && String(tallyData[f.field]).trim() !== ''; }).length;
    html += '<div class="spec-card">' +
      '<div class="spec-section-hdr" onclick="toggleSpecSection(\'' + cat.key + '\',' + sIdx + ')">' +
        '<span class="spec-section-icon">' + section.icon + '</span>' +
        '<span class="spec-section-title">' + section.title + '</span>' +
        '<span class="spec-section-filled">' + secFilled + '/' + section.fields.length + '</span>' +
        '<span class="spec-section-chev' + (secOpen ? ' open' : '') + '">▼</span>' +
      '</div>' +
      '<div class="spec-section-body' + (secOpen ? ' open' : '') + '" id="specsec-' + cat.key + '-' + sIdx + '">' +
      '<div class="spec-grid">';
    section.fields.forEach(function(f) {
      var val     = tallyData[f.field] !== undefined ? tallyData[f.field] : (project[f.field] || '');
      var full    = f.col === 2 ? ' full' : '';
      html += '<div class="spec-field' + full + '"><label class="spec-lbl">' + f.lbl + '</label>';
      if (f.type === 'toggle') {
        var chk = val === true || val === 'true' || val === 'Y' || val === 'yes';
        html += '<div class="spec-toggle-row"><label class="spec-toggle"><input type="checkbox" data-field="' + f.field + '" data-type="toggle"' + (chk ? ' checked' : '') + ' onchange="onSpecChange()"/><span class="spec-toggle-slider"></span></label><span class="spec-toggle-lbl">' + (chk ? 'Yes' : 'No') + '</span></div>';
      } else if (f.type === 'select') {
        html += '<select class="spec-select" data-field="' + f.field + '" data-type="select" onchange="onSpecChange()">';
        (f.opts || []).forEach(function(o) { html += '<option value="' + escHtml(o) + '"' + (String(val) === o ? ' selected' : '') + '>' + escHtml(o || '— Select —') + '</option>'; });
        html += '</select>';
      } else {
        html += '<input class="spec-input" type="' + f.type + '" data-field="' + f.field + '" data-type="' + f.type + '" value="' + escHtml(String(val)) + '" placeholder="Enter value" oninput="onSpecChange()"/>';
      }
      html += '</div>';
    });
    html += '</div></div></div>'; // spec-grid + spec-section-body + spec-card
  });

  html += '<div class="spec-card"><div class="spec-save-row">' +
    '<button class="spec-save-btn" onclick="saveSpecFields(\'' + cat.key + '\')">💾 Save Specs</button>' +
    '<span class="spec-save-msg" id="spec-save-msg">Saved ✓</span>' +
    '<button class="spec-assess-btn" onclick="openCatForm(\'' + cat.key + '\')">▶ ' + (cat.key && currentProject[cat.key] != null ? 'Retake Assessment' : 'Start Assessment') + '</button>' +
  '</div></div>';
  html += '</div>';
  return html;
}


function toggleSpecSection(catKey, sIdx) {
  if (!activeSpecSections[catKey]) activeSpecSections[catKey] = {};
  activeSpecSections[catKey][sIdx] = !activeSpecSections[catKey][sIdx];
  var body = document.getElementById('specsec-' + catKey + '-' + sIdx);
  var hdr  = body && body.previousElementSibling;
  if (body) body.classList.toggle('open', activeSpecSections[catKey][sIdx]);
  if (hdr)  { var ch = hdr.querySelector('.spec-section-chev'); if (ch) ch.classList.toggle('open', activeSpecSections[catKey][sIdx]); }
}

function onSpecChange() {
  // Live toggle label update
  document.querySelectorAll('.spec-toggle input[type="checkbox"]').forEach(function(cb) {
    var lbl = cb.closest('.spec-toggle-row') && cb.closest('.spec-toggle-row').querySelector('.spec-toggle-lbl');
    if (lbl) lbl.textContent = cb.checked ? 'Yes' : 'No';
  });
}

/* ---- SAVE SPEC FIELDS ---- */
function saveSpecFields(catKey) {
  if (!currentProjectId || !currentUserId) return;
  var tallyFields = Object.assign({}, currentProject.tally_fields || {});

  // Collect all inputs in the spec pane
  var specPane = document.getElementById('tab-spec');
  if (!specPane) return;

  specPane.querySelectorAll('[data-field]').forEach(function(el) {
    var field = el.getAttribute('data-field');
    var type  = el.getAttribute('data-type');
    var val;
    if (type === 'toggle') {
      val = el.checked;
    } else {
      val = el.value.trim();
    }
    tallyFields[field] = val;
    if (currentProject) currentProject[field] = val;
  });

  currentProject.tally_fields = tallyFields;

  sb.from("projects").update({ tally_fields: tallyFields, updated_at: new Date().toISOString() })
    .eq("id", currentProjectId).eq("user_id", currentUserId)
    .then(function(res) {
      if (res.error) { alert("Save failed: " + res.error.message); return; }
      var msg = document.getElementById("spec-save-msg");
      if (msg) { msg.classList.add("show"); setTimeout(function() { msg.classList.remove("show"); }, 2500); }
      // Refresh completeness bar
      var cat = CATEGORIES.find(function(c) { return c.key === catKey; });
      if (!cat) return;
      var allFields = [];
      cat.sections.forEach(function(s) { s.fields.forEach(function(f) { allFields.push(f.field); }); });
      var filled = allFields.filter(function(f) { return tallyFields[f] && String(tallyFields[f]).trim() !== ''; }).length;
      var pct = allFields.length ? Math.round(filled / allFields.length * 100) : 0;
      var fill = document.querySelector('.spec-comp-fill');
      var pctEl = document.querySelector('.spec-comp-pct');
      var hintEl = document.querySelector('.spec-comp-hint');
      var fillColor = pct === 100 ? '#2e7d4f' : pct > 40 ? '#e07b20' : '#c0392b';
      if (fill)  { fill.style.width = pct + '%'; fill.style.background = fillColor; }
      if (pctEl) pctEl.textContent = pct + '%';
      if (hintEl) hintEl.textContent = filled + ' / ' + allFields.length + ' fields';
      // Refresh sidebar dot
      renderLeft(currentProject);
      // Re-highlight active
      CATEGORIES.forEach(function(c) {
        var el = document.getElementById("cat-item-" + c.key);
        if (el) el.classList.toggle("active", c.key === catKey);
      });
    });
}

/* ---- SAVE FIELDS (legacy, kept for compatibility) ---- */
function saveFields() { saveSpecFields(activeCatKey); }

/* ---- CLOSE CAT PANEL ---- */
function closeCatPanel() {
  activeCatKey = null;
  document.getElementById("cat-panel").classList.remove("open");
  document.getElementById("cat-panel").innerHTML = "";
  document.getElementById("main-overview").style.display = "flex";
  ['components','suppliers','equipment'].forEach(function(k) {
    var p = document.getElementById('reg-panel-' + k); if (p) p.classList.remove('open');
  });
  CATEGORIES.forEach(function(c) {
    var el = document.getElementById("cat-item-" + c.key);
    if (el) el.classList.remove("active");
  });
}

function escHtml(s) {
  return String(s||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

/* ---- AI Q&A ---- */
function sendAiQuestion() {
  var inputEl = document.getElementById("cp-ai-input");
  var sendBtn = document.getElementById("cp-ai-send");
  var question = inputEl ? inputEl.value.trim() : "";
  if (!question || !activeCatKey || !currentProject) return;

  var cat = CATEGORIES.find(function(c) { return c.key === activeCatKey; });

  // Add user message
  if (!aiHistory[activeCatKey]) aiHistory[activeCatKey] = [];
  aiHistory[activeCatKey].push({ role: "user", content: question });
  inputEl.value = "";
  if (sendBtn) sendBtn.disabled = true;
  renderAiHistory();

  // Add loading bubble
  var histEl = document.getElementById("cp-ai-history");
  var loadingId = "ai-loading-" + Date.now();
  if (histEl) {
    var loadingDiv = document.createElement("div");
    loadingDiv.className = "cp-ai-msg assistant";
    loadingDiv.id = loadingId;
    loadingDiv.innerHTML = '<div class="ai-loading"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div></div>';
    histEl.appendChild(loadingDiv);
    scrollAiHistory();
  }

  // Build context from project + category
  var projectContext = "Project: " + (currentProject.name || "Unknown") +
    "\nCapacity: " + (currentProject.capacity_mw || "N/A") + " MWp" +
    "\nStage: " + (currentProject.stage || "N/A") +
    "\nCategory: " + cat.label +
    "\nScore: " + (currentProject[activeCatKey] != null ? currentProject[activeCatKey] + "/100" : "Not yet scored") +
    "\nFields: " + cat.fields.map(function(f) {
      return f.lbl + ": " + (currentProject[f.field] || "Not provided");
    }).join(", ");

  var messages = [{ role: "user", content: "Project context:\n" + projectContext + "\n\nQuestion: " + question }];

  fetch(SUPABASE_URL + "/functions/v1/category-qa", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      project_id: currentProjectId,
      user_id: currentUserId,
      category: activeCatKey,
      question: question,
      history: (aiHistory[activeCatKey] || []).slice(0, -1).map(function(m) {
        return { role: m.role, content: m.content };
      })
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var answer = data.answer || data.error || "No response received.";
    aiHistory[activeCatKey].push({ role: "assistant", content: answer });
    var loadingEl = document.getElementById(loadingId);
    if (loadingEl) loadingEl.remove();
    renderAiHistory();
    if (sendBtn) sendBtn.disabled = false;
  })
  .catch(function(err) {
    var loadingEl = document.getElementById(loadingId);
    if (loadingEl) loadingEl.remove();
    aiHistory[activeCatKey].push({ role: "assistant", content: "Error: " + err.message });
    renderAiHistory();
    if (sendBtn) sendBtn.disabled = false;
  });
}

function renderAiHistory() {
  var histEl = document.getElementById("cp-ai-history");
  if (!histEl || !activeCatKey) return;
  var hist = aiHistory[activeCatKey] || [];
  histEl.innerHTML = hist.map(function(m) {
    return '<div class="cp-ai-msg ' + m.role + '">' + escHtml(m.content) + '</div>';
  }).join("");
  scrollAiHistory();
}

function scrollAiHistory() {
  var histEl = document.getElementById("cp-ai-history");
  if (histEl) histEl.scrollTop = histEl.scrollHeight;
}

/* ---- SHARE ---- */
function openShareModal(catKey) {
  var cat = CATEGORIES.find(function(c) { return c.key === catKey; });
  if (!cat || !currentProjectId) return;
  document.getElementById("share-modal-title").textContent = "Share " + cat.label + " Data";
  document.getElementById("share-url-box").textContent = "Generating link...";
  document.getElementById("share-modal-overlay").classList.add("open");

  // Generate token: store in share_tokens table
  var token = generateToken();
  var expires = new Date();
  expires.setDate(expires.getDate() + 30);

  sb.from("share_tokens").insert({
    token: token,
    project_id: currentProjectId,
    category: catKey,
    created_by: currentUserId,
    expires_at: expires.toISOString()
  }).then(function(res) {
    if (res.error) {
      // Table may not exist yet - show token anyway
      console.warn("share_tokens table missing:", res.error.message);
    }
    var url = window.location.origin + "/share.html?token=" + token;
    shareToken = token;
    document.getElementById("share-url-box").textContent = url;
  });
}

function closeShareModal() {
  document.getElementById("share-modal-overlay").classList.remove("open");
  shareToken = null;
}

function copyShareLink() {
  var box = document.getElementById("share-url-box");
  if (!box) return;
  navigator.clipboard.writeText(box.textContent).then(function() {
    var btn = document.querySelector(".share-copy-btn");
    if (btn) { btn.textContent = "Copied!"; setTimeout(function() { btn.textContent = "Copy Link"; }, 2000); }
  });
}

function generateToken() {
  var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  var token = "";
  for (var i = 0; i < 32; i++) token += chars.charAt(Math.floor(Math.random() * chars.length));
  return token;
}

/* ==============================================
   MULTI-COMPONENT ENGINE
/* ================================================================
   CONSTRUCTION — CREW BUILDER
   tally_fields.construction_crews = [{id, type, name, fields:{}}]
   Fields namespaced: crew_{id}_{field}
   3 crew types: civil, install, electrical
   ================================================================ */

var CREW_TYPES = {
  civil: {
    icon: '🏗️', label: 'Civil Crew', color: '#d35400',
    manpower: [
      { lbl:'Crew Name / ID',             field:'nickname',        type:'text',   col:2 },
      { lbl:'Subcontractor',              field:'subcontractor',   type:'text',   col:2 },
      { lbl:'Crew Size (workers)',        field:'crew_size',       type:'number' },
      { lbl:'Supervisors',                field:'supervisors',     type:'number' },
      { lbl:'Shift Pattern',              field:'shift',           type:'select', opts:['','Single Shift','Double Shift','24/7'] },
      { lbl:'Start Date',                 field:'start_date',      type:'date' },
      { lbl:'End Date',                   field:'end_date',        type:'date' },
      { lbl:'Scope',                      field:'scope',           type:'select', opts:['','Earthworks','Pile Driving','Roads & Fencing','All Civil'] },
      { lbl:'Pile Drive Rate (piles/day)',field:'pile_rate',       type:'number' },
      { lbl:'Grading Rate (m³/day)',      field:'grade_rate',      type:'number' },
      { lbl:'HSE Officer on Site',        field:'hse_officer',     type:'toggle' },
    ],
    equipment: [
      { lbl:'Bulldozer',    key:'dozer' },
      { lbl:'Excavator',    key:'excavator' },
      { lbl:'Pile Driver',  key:'pile_driver' },
      { lbl:'Telehandler',  key:'forklift' },
      { lbl:'Generator',    key:'generator' },
    ],
    milestones: ['Mobilisation','Site Clearance','Grading Complete','Pile Driving Start','Pile Driving 50%','Pile Driving Complete','Roads Complete','Fencing Complete','Demobilisation'],
  },
  install: {
    icon: '☀️', label: 'Module Install Crew', color: '#2471a3',
    manpower: [
      { lbl:'Crew Name / ID',             field:'nickname',        type:'text',   col:2 },
      { lbl:'Subcontractor',              field:'subcontractor',   type:'text',   col:2 },
      { lbl:'Crew Size (workers)',        field:'crew_size',       type:'number' },
      { lbl:'Supervisors',                field:'supervisors',     type:'number' },
      { lbl:'Shift Pattern',              field:'shift',           type:'select', opts:['','Single Shift','Double Shift'] },
      { lbl:'Start Date',                 field:'start_date',      type:'date' },
      { lbl:'End Date',                   field:'end_date',        type:'date' },
      { lbl:'Modules per Crew per Day',   field:'mod_rate',        type:'number' },
      { lbl:'Peak Daily Output (mod/day)',field:'peak_daily',      type:'number' },
      { lbl:'String Testing Rate (str/day)',field:'string_rate',   type:'number' },
      { lbl:'HSE Officer on Site',        field:'hse_officer',     type:'toggle' },
    ],
    equipment: [
      { lbl:'Robot Installer', key:'robot_installer' },
      { lbl:'Telehandler',     key:'forklift' },
      { lbl:'Generator',       key:'generator' },
    ],
    milestones: ['Mobilisation','Rack Assembly Start','First Modules Racked','25% Complete','50% Complete','75% Complete','Last Module Racked','String Testing Complete','Final Inspection'],
  },
  electrical: {
    icon: '⚡', label: 'Electrical Crew', color: '#117a65',
    manpower: [
      { lbl:'Crew Name / ID',             field:'nickname',        type:'text',   col:2 },
      { lbl:'Subcontractor',              field:'subcontractor',   type:'text',   col:2 },
      { lbl:'Crew Size (workers)',        field:'crew_size',       type:'number' },
      { lbl:'Electricians (licensed)',    field:'electricians',    type:'number' },
      { lbl:'Shift Pattern',              field:'shift',           type:'select', opts:['','Single Shift','Double Shift'] },
      { lbl:'Start Date',                 field:'start_date',      type:'date' },
      { lbl:'End Date',                   field:'end_date',        type:'date' },
      { lbl:'DC Trench Rate (m/day)',     field:'dc_rate',         type:'number' },
      { lbl:'AC Trench Rate (m/day)',     field:'ac_rate',         type:'number' },
      { lbl:'MV Cable Pull Rate (m/day)', field:'mv_rate',         type:'number' },
      { lbl:'HSE Officer on Site',        field:'hse_officer',     type:'toggle' },
    ],
    equipment: [
      { lbl:'Cable Trencher', key:'cable_trencher' },
      { lbl:'Excavator',      key:'excavator' },
      { lbl:'Telehandler',    key:'forklift' },
      { lbl:'Generator',      key:'generator' },
    ],
    milestones: ['Mobilisation','DC Cable Trench Start','DC Cable Pull Complete','AC Cable Trench Start','AC Cable Pull Complete','MV Cable Complete','Inverter Terminations','Transformer Connections','SCADA Wiring','Energisation Test','PAC'],
  },
};

/* Storage */
function getCrews() {
  var tf = (currentProject && currentProject.tally_fields) || {};
  try { return JSON.parse(tf.construction_crews || '[]'); } catch(e) { return []; }
}
function saveCrews(crews, cb) {
  if (!currentProjectId || !currentUserId) return;
  var tf = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  tf.construction_crews = JSON.stringify(crews);
  if (currentProject) currentProject.tally_fields = tf;
  sb.from('projects').update({ tally_fields: tf, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(r) { if (cb) cb(r); });
}
function crewUid() { return 'cr_' + Date.now() + '_' + Math.floor(Math.random()*9999); }

var crewOpenState = {};
var crewSubState  = {};

function buildConstructionPane(project) {
  var tf     = project.tally_fields || {};
  var crews  = getCrews();

  // Completeness across all crews
  var totalF = 0, filledF = 0;
  crews.forEach(function(crew) {
    var ct = CREW_TYPES[crew.type]; if (!ct) return;
    ct.manpower.forEach(function(f) {
      totalF++;
      var k = 'crew_' + crew.id + '_' + f.field;
      if (tf[k] !== undefined && tf[k] !== null && String(tf[k]).trim() !== '' && tf[k] !== false) filledF++;
    });
  });
  var pct = totalF ? Math.round(filledF / totalF * 100) : 0;
  var fc  = pct === 100 ? '#2e7d4f' : pct > 40 ? '#e07b20' : '#c0392b';

  var html = '<div class="cp-tab-pane" id="tab-spec">';

  // Schedule + Budget sections from CATEGORIES (still useful as flat fields)
  var cat = CATEGORIES.find(function(c) { return c.key === 'score_construct'; });
  if (cat) {
    // Render Schedule and Budget sections as collapsible cards
    cat.sections.filter(function(s) { return s.title !== 'Workforce & Logistics'; }).forEach(function(section, sIdx) {
      var secOpen   = crewSubState['sched_' + sIdx] === true;
      var secFilled = section.fields.filter(function(f) { return tf[f.field] && String(tf[f.field]).trim() !== ''; }).length;
      html += '<div class="spec-card">' +
        '<div class="spec-section-hdr" onclick="toggleCrewSection(\'sched_\'+' + sIdx + ')">' +
          '<span class="spec-section-icon">' + section.icon + '</span>' +
          '<span class="spec-section-title">' + section.title + '</span>' +
          '<span class="spec-section-filled">' + secFilled + '/' + section.fields.length + '</span>' +
          '<span class="spec-section-chev' + (secOpen ? ' open' : '') + '" id="crewsubchev-sched_' + sIdx + '">▼</span>' +
        '</div>' +
        '<div class="spec-section-body' + (secOpen ? ' open' : '') + '" id="crewsub-sched_' + sIdx + '"><div class="spec-grid">';
      section.fields.forEach(function(f) {
        var val  = tf[f.field] !== undefined ? tf[f.field] : '';
        var full = f.col === 2 ? ' full' : '';
        html += '<div class="spec-field' + full + '"><label class="spec-lbl">' + f.lbl + '</label>';
        if (f.type === 'toggle') {
          var chk = val === true || val === 'true';
          html += '<div class="spec-toggle-row"><label class="spec-toggle"><input type="checkbox" data-field="' + f.field + '" data-type="toggle"' + (chk ? ' checked' : '') + ' onchange="onSpecChange()"/><span class="spec-toggle-slider"></span></label><span class="spec-toggle-lbl">' + (chk ? 'Yes' : 'No') + '</span></div>';
        } else if (f.type === 'select') {
          html += '<select class="spec-select" data-field="' + f.field + '" data-type="select" onchange="onSpecChange()">';
          (f.opts || []).forEach(function(o) { html += '<option value="' + escHtml(o) + '"' + (String(val) === o ? ' selected' : '') + '>' + escHtml(o || '— Select —') + '</option>'; });
          html += '</select>';
        } else {
          html += '<input class="spec-input" type="' + f.type + '" data-field="' + f.field + '" data-type="' + f.type + '" value="' + escHtml(String(val)) + '" placeholder="Enter value" oninput="onSpecChange()"/>';
        }
        html += '</div>';
      });
      html += '</div></div></div>';
    });
  }

  // Workforce & Crew section header
  html += '<div style="margin:14px 0 8px;padding:0 2px;display:flex;align-items:center;justify-content:space-between;">' +
    '<div>' +
      '<div style="font-size:12px;font-weight:800;color:#1a1f2e;">👷 Workforce & Crews</div>' +
      '<div style="font-size:10px;color:#8a95a5;margin-top:2px;">Add a crew card for each team on site — civil, module install, electrical.</div>' +
    '</div>' +
    '<div id="crew-comp-badge" style="font-size:10px;font-weight:700;background:' + fc + ';color:#fff;padding:3px 10px;border-radius:20px;">' + pct + '% filled</div>' +
  '</div>';

  html += '<div id="crew-cards-wrap">';
  if (!crews.length) {
    html += '<div class="da-empty-state"><div style="font-size:32px;margin-bottom:8px;">👷 ⚡ 🏗️</div>' +
      '<div style="font-size:12px;font-weight:700;color:#d35400;margin-bottom:4px;">No crews added yet</div>' +
      '<div style="font-size:11px;color:#8a95a5;line-height:1.5;">Add a crew for each work type: civil earthworks, module installation, electrical.</div></div>';
  } else {
    crews.forEach(function(crew) { html += buildCrewCard(crew, tf); });
  }
  html += '</div>';

  // Add crew buttons (one per type)
  html += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">';
  Object.keys(CREW_TYPES).forEach(function(t) {
    var ct = CREW_TYPES[t];
    html += '<button class="da-add-btn" style="flex:1;min-width:120px;border-color:' + ct.color + ';color:' + ct.color + ';" onclick="addCrew(\'' + t + '\')">' + ct.icon + ' Add ' + ct.label + '</button>';
  });
  html += '</div>';

  html += '<div class="spec-card"><div class="spec-save-row">' +
    '<button class="spec-save-btn" onclick="saveConstructionSpec()">💾 Save All</button>' +
    '<span class="spec-save-msg" id="spec-save-msg">Saved ✓</span>' +
    '<button class="spec-assess-btn" onclick="openCatForm(\'score_construct\')">▶ ' +
      (currentProject.score_construct != null ? 'Retake Assessment' : 'Start Assessment') + '</button>' +
  '</div></div>';

  html += '</div>';
  return html;
}

function buildCrewCard(crew, tf) {
  var ct      = CREW_TYPES[crew.type]; if (!ct) return '';
  var name    = (tf['crew_' + crew.id + '_nickname'] || crew.name || ct.label);
  var isOpen  = crewOpenState[crew.id] !== false;
  var total = ct.manpower.length, filled = 0;
  ct.manpower.forEach(function(f) {
    var k = 'crew_' + crew.id + '_' + f.field;
    if (tf[k] !== undefined && tf[k] !== null && String(tf[k]).trim() !== '' && tf[k] !== false) filled++;
  });
  var pct = total ? Math.round(filled / total * 100) : 0;

  var html = '<div class="da-array-card" id="crewc-' + crew.id + '" style="border-color:' + ct.color + '33;">' +
    '<div class="da-array-hdr" style="background:linear-gradient(135deg,' + ct.color + 'dd,' + ct.color + '88);" onclick="toggleCrewCard(\'' + crew.id + '\')">' +
      '<span class="da-array-icon">' + ct.icon + '</span>' +
      '<div class="da-array-name-wrap">' +
        '<div class="da-array-name" id="crewname-' + crew.id + '">' + escHtml(name) + '</div>' +
        '<div class="da-array-meta">' + ct.label + ' · ' + filled + '/' + total + ' fields</div>' +
      '</div>' +
      '<span class="da-array-pct-badge" id="crewpct-' + crew.id + '">' + pct + '%</span>' +
      '<span class="da-array-chev' + (isOpen ? ' open' : '') + '" id="crewchev-' + crew.id + '">▼</span>' +
      '<button class="da-array-del" onclick="deleteCrew(event,\'' + crew.id + '\')">✕ Remove</button>' +
    '</div>' +
    '<div class="da-array-body' + (isOpen ? ' open' : '') + '" id="crewbody-' + crew.id + '">';

  // Manpower fields
  var mpOpen = crewSubState['mp_' + crew.id] !== false;
  html += '<div class="spec-card">' +
    '<div class="spec-section-hdr" onclick="toggleCrewSub(\'mp_' + crew.id + '\')">' +
      '<span class="spec-section-icon">👷</span><span class="spec-section-title">Manpower & Schedule</span>' +
      '<span class="spec-section-chev' + (mpOpen ? ' open' : '') + '" id="crewsubchev-mp_' + crew.id + '">▼</span>' +
    '</div>' +
    '<div class="spec-section-body' + (mpOpen ? ' open' : '') + '" id="crewsub-mp_' + crew.id + '"><div class="spec-grid">';
  ct.manpower.forEach(function(f) {
    var k    = 'crew_' + crew.id + '_' + f.field;
    var val  = (tf[k] !== undefined) ? tf[k] : '';
    var full = f.col === 2 ? ' full' : '';
    html += '<div class="spec-field' + full + '"><label class="spec-lbl">' + f.lbl + '</label>';
    if (f.type === 'toggle') {
      var chk = val === true || val === 'true';
      html += '<div class="spec-toggle-row"><label class="spec-toggle"><input type="checkbox" data-crew="' + crew.id + '" data-field="' + f.field + '" data-type="toggle"' + (chk ? ' checked' : '') + ' onchange="onCrewFieldChange(this)"/><span class="spec-toggle-slider"></span></label><span class="spec-toggle-lbl">' + (chk ? 'Yes' : 'No') + '</span></div>';
    } else if (f.type === 'select') {
      html += '<select class="spec-select" data-crew="' + crew.id + '" data-field="' + f.field + '" onchange="onCrewFieldChange(this)">';
      (f.opts || []).forEach(function(o) { html += '<option value="' + escHtml(o) + '"' + (String(val) === o ? ' selected' : '') + '>' + escHtml(o || '— Select —') + '</option>'; });
      html += '</select>';
    } else {
      html += '<input class="spec-input" type="' + f.type + '" data-crew="' + crew.id + '" data-field="' + f.field + '" value="' + escHtml(String(val)) + '" placeholder="Enter value" oninput="onCrewFieldChange(this)"/>';
    }
    html += '</div>';
  });
  html += '</div></div></div>';

  // Equipment assignment
  var eqOpen = crewSubState['eq_' + crew.id] === true;
  var equipItems = getRegistry('equipment');
  html += '<div class="spec-card">' +
    '<div class="spec-section-hdr" onclick="toggleCrewSub(\'eq_' + crew.id + '\')">' +
      '<span class="spec-section-icon">🚜</span><span class="spec-section-title">Equipment Assigned</span>' +
      '<span class="spec-section-chev' + (eqOpen ? ' open' : '') + '" id="crewsubchev-eq_' + crew.id + '">▼</span>' +
    '</div>' +
    '<div class="spec-section-body' + (eqOpen ? ' open' : '') + '" id="crewsub-eq_' + crew.id + '"><div class="spec-grid">';
  ct.equipment.forEach(function(eq) {
    var fKey = 'crew_' + crew.id + '_eq_' + eq.key;
    var curVal = tf[fKey] || '';
    // Build dropdown from equipment registry filtered by type
    var matchItems = equipItems.filter(function(i) { return i.type === eq.key; });
    html += '<div class="spec-field"><label class="spec-lbl">' + eq.lbl + '</label>';
    html += '<select class="spec-select" data-crew="' + crew.id + '" data-field="eq_' + eq.key + '" onchange="onCrewFieldChange(this)">';
    html += '<option value="">— None assigned —</option>';
    matchItems.forEach(function(item) {
      var def = REG_DEFS.equipment.types[item.type] || {};
      var nf  = def.fields && def.fields.find(function(f) { return f.req; });
      var nm  = nf ? ((item.fields || {})[nf.field] || def.label) : (def.label || item.type);
      html += '<option value="' + item.id + '"' + (curVal === item.id ? ' selected' : '') + '>' + escHtml(nm) + '</option>';
    });
    html += '</select></div>';
  });
  if (!equipItems.length) {
    html += '<div class="spec-field full" style="color:#8a95a5;font-size:10px;padding:6px 0;">No equipment in registry yet — <button onclick="openRegPanel(\'equipment\')" style="background:none;border:none;color:#2471a3;font-size:10px;font-weight:700;cursor:pointer;">add equipment first</button></div>';
  }
  html += '</div></div></div>';

  // Timeline milestones
  var tlOpen = crewSubState['tl_' + crew.id] === true;
  html += '<div class="spec-card">' +
    '<div class="spec-section-hdr" onclick="toggleCrewSub(\'tl_' + crew.id + '\')">' +
      '<span class="spec-section-icon">📅</span><span class="spec-section-title">' + ct.label + ' Timeline</span>' +
      '<span class="spec-section-chev' + (tlOpen ? ' open' : '') + '" id="crewsubchev-tl_' + crew.id + '">▼</span>' +
    '</div>' +
    '<div class="spec-section-body' + (tlOpen ? ' open' : '') + '" id="crewsub-tl_' + crew.id + '">';
  ct.milestones.forEach(function(ms) {
    var msKey = ms.toLowerCase().replace(/[^a-z0-9]/g,'_');
    var stKey = 'crew_' + crew.id + '_tl_' + msKey + '_status';
    var dtKey = 'crew_' + crew.id + '_tl_' + msKey + '_date';
    var stVal = tf[stKey] || '';
    var dtVal = tf[dtKey] || '';
    var dotColor = stVal === 'Complete' ? '#2e7d4f' : stVal === 'In progress' ? '#e07b20' : '#b0b8c8';
    html += '<div class="mc-tl-row">' +
      '<div class="mc-tl-dot" style="background:' + dotColor + ';"></div>' +
      '<span class="mc-tl-ms">' + ms + '</span>' +
      '<select class="mc-tl-status" data-crew="' + crew.id + '" data-field="tl_' + msKey + '_status" onchange="onCrewFieldChange(this)">' +
        '<option value=""' + (!stVal ? ' selected' : '') + '>Not started</option>' +
        '<option value="In progress"' + (stVal==='In progress' ? ' selected' : '') + '>In progress</option>' +
        '<option value="Complete"' + (stVal==='Complete' ? ' selected' : '') + '>Complete</option>' +
      '</select>' +
      '<input type="date" class="mc-tl-date" data-crew="' + crew.id + '" data-field="tl_' + msKey + '_date" value="' + escHtml(dtVal) + '" oninput="onCrewFieldChange(this)"/>' +
    '</div>';
  });
  html += '</div></div>';

  html += '</div></div>'; // da-array-body + da-array-card
  return html;
}

function toggleCrewCard(crewId) {
  crewOpenState[crewId] = crewOpenState[crewId] === false ? true : false;
  var body = document.getElementById('crewbody-' + crewId);
  var chev = document.getElementById('crewchev-' + crewId);
  if (body) body.classList.toggle('open', crewOpenState[crewId] !== false);
  if (chev) chev.classList.toggle('open', crewOpenState[crewId] !== false);
}
function toggleCrewSub(key) {
  crewSubState[key] = !crewSubState[key];
  var body = document.getElementById('crewsub-' + key);
  var chev = document.getElementById('crewsubchev-' + key);
  if (body) body.classList.toggle('open', crewSubState[key]);
  if (chev) chev.classList.toggle('open', crewSubState[key]);
}
function toggleCrewSection(key) {
  crewSubState[key] = !crewSubState[key];
  var body = document.getElementById('crewsub-' + key);
  var chev = document.getElementById('crewsubchev-' + key);
  if (body) body.classList.toggle('open', crewSubState[key]);
  if (chev) chev.classList.toggle('open', crewSubState[key]);
}
function onCrewFieldChange(el) {
  if (el.type === 'checkbox') {
    var row = el.closest('.spec-toggle-row');
    if (row) { var lbl = row.querySelector('.spec-toggle-lbl'); if (lbl) lbl.textContent = el.checked ? 'Yes' : 'No'; }
  }
  // Live name update
  var crewId = el.getAttribute('data-crew');
  var field  = el.getAttribute('data-field');
  if (crewId && field === 'nickname' && el.value.trim()) {
    var nm = document.getElementById('crewname-' + crewId);
    if (nm) nm.textContent = el.value.trim();
  }
}
function addCrew(type) {
  var crews  = getCrews();
  var newId  = crewUid();
  var ct     = CREW_TYPES[type];
  var newName= (ct ? ct.label : 'Crew') + ' ' + (crews.filter(function(c){ return c.type===type; }).length + 1);
  crews.push({ id: newId, type: type, name: newName });
  crewOpenState[newId] = true;
  crewSubState['mp_' + newId] = true;
  saveCrews(crews, function() {
    var wrap = document.getElementById('crew-cards-wrap');
    if (!wrap) return;
    var tf = (currentProject && currentProject.tally_fields) || {};
    var empty = wrap.querySelector('.da-empty-state');
    if (empty) empty.remove();
    wrap.insertAdjacentHTML('beforeend', buildCrewCard({ id: newId, type: type, name: newName }, tf));
    var card = document.getElementById('crewc-' + newId);
    if (card) card.scrollIntoView({ behavior:'smooth', block:'start' });
  });
}
function deleteCrew(evt, crewId) {
  evt.stopPropagation();
  if (!confirm('Remove this crew?')) return;
  var crews = getCrews().filter(function(c) { return c.id !== crewId; });
  var tf = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  Object.keys(tf).forEach(function(k) { if (k.startsWith('crew_' + crewId + '_')) delete tf[k]; });
  tf.construction_crews = JSON.stringify(crews);
  if (currentProject) currentProject.tally_fields = tf;
  sb.from('projects').update({ tally_fields: tf, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function() {
      var card = document.getElementById('crewc-' + crewId);
      if (card) card.remove();
      var wrap = document.getElementById('crew-cards-wrap');
      if (wrap && !wrap.querySelector('.da-array-card')) {
        wrap.innerHTML = '<div class="da-empty-state"><div style="font-size:32px;margin-bottom:8px;">👷 ⚡ 🏗️</div>' +
          '<div style="font-size:12px;font-weight:700;color:#d35400;margin-bottom:4px;">No crews added yet</div>' +
          '<div style="font-size:11px;color:#8a95a5;">Add a crew below.</div></div>';
      }
    });
}
function saveConstructionSpec() {
  if (!currentProjectId || !currentUserId) return;
  var crews = getCrews();
  var tf    = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  // Flat spec fields (schedule, budget)
  document.querySelectorAll('#tab-spec [data-field]:not([data-crew])').forEach(function(el) {
    var field = el.getAttribute('data-field');
    tf[field] = el.type === 'checkbox' ? el.checked : el.value.trim();
  });
  // Crew fields
  document.querySelectorAll('[data-crew][data-field]').forEach(function(el) {
    var crewId = el.getAttribute('data-crew');
    var field  = el.getAttribute('data-field');
    tf['crew_' + crewId + '_' + field] = el.type === 'checkbox' ? el.checked : el.value.trim();
  });
  tf.construction_crews = JSON.stringify(crews);
  if (currentProject) currentProject.tally_fields = tf;
  sb.from('projects').update({ tally_fields: tf, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(res) {
      if (res && res.error) { alert('Save failed: ' + res.error.message); return; }
      var msg = document.getElementById('spec-save-msg');
      if (msg) { msg.classList.add('show'); setTimeout(function(){ msg.classList.remove('show'); }, 2500); }
      renderLeft(currentProject);
    });
}

/* ================================================================
   PROCUREMENT — SUPPLIER CONTRACT BUILDER
   tally_fields.procurement_contracts = [{id, supplierId, supplierType, name, fields:{}}]
   Fields namespaced: pc_{id}_{field}
   One card per supplier/contractor relationship
   ================================================================ */

// Contract fields per supplier category
var PROC_CONTRACT_SECTIONS = {
  // Used for ALL supplier types
  common: [
    { lbl:'Contract / Agreement Title',   field:'title',          type:'text',   col:2 },
    { lbl:'Contract Type',                 field:'contract_type',  type:'select', opts:['','Lump-sum Turnkey','EPC','Supply Agreement','Service Agreement','Framework','Letter of Intent','MOU'] },
    { lbl:'Contract Value ($)',            field:'value_usd',      type:'number' },
    { lbl:'Currency',                      field:'currency',       type:'select', opts:['','USD','EUR','GBP','AUD','CAD','Other'] },
    { lbl:'Contract Execution Date',       field:'exec_date',      type:'date' },
    { lbl:'Governing Law',                 field:'governing_law',  type:'text' },
    { lbl:'Incoterms',                     field:'incoterms',      type:'select', opts:['','DDP','DAP','FCA','EXW','CIF','FOB','CPT','Not Applicable'] },
    { lbl:'Parent Guarantee',              field:'parent_guar',    type:'toggle' },
    { lbl:'Performance Bond (%)',          field:'perf_bond_pct',  type:'number' },
    { lbl:'Payment Bond (%)',              field:'pay_bond_pct',   type:'number' },
  ],
  payments: [
    { lbl:'Milestone 1 — Description',    field:'pmt1_desc',      type:'text' },
    { lbl:'Milestone 1 — % of Value',     field:'pmt1_pct',       type:'number' },
    { lbl:'Milestone 2 — Description',    field:'pmt2_desc',      type:'text' },
    { lbl:'Milestone 2 — % of Value',     field:'pmt2_pct',       type:'number' },
    { lbl:'Milestone 3 — Description',    field:'pmt3_desc',      type:'text' },
    { lbl:'Milestone 3 — % of Value',     field:'pmt3_pct',       type:'number' },
    { lbl:'Milestone 4 — Description',    field:'pmt4_desc',      type:'text' },
    { lbl:'Milestone 4 — % of Value',     field:'pmt4_pct',       type:'number' },
    { lbl:'Milestone 5 — Description',    field:'pmt5_desc',      type:'text' },
    { lbl:'Milestone 5 — % of Value',     field:'pmt5_pct',       type:'number' },
    { lbl:'Retention (%)',                 field:'retention_pct',  type:'number' },
    { lbl:'Retention Release Trigger',     field:'retention_trig', type:'select', opts:['','At PAC','At FAC','12 months post-FAC','Split PAC/FAC'] },
  ],
  ld_delivery: [
    { lbl:'Delivery / Completion Date',   field:'delivery_date',  type:'date' },
    { lbl:'Lead Time (weeks)',             field:'lead_wks',       type:'number' },
    { lbl:'Delay LD ($/day)',             field:'ld_delay_day',   type:'number' },
    { lbl:'Delay LD Cap (%)',             field:'ld_delay_cap',   type:'number' },
    { lbl:'Performance LD ($/day)',       field:'ld_perf_day',    type:'number' },
    { lbl:'Performance LD Cap (%)',        field:'ld_perf_cap',    type:'number' },
    { lbl:'Warranty Period (months)',     field:'warranty_mo',    type:'number' },
    { lbl:'Defects Liability Period (mo)',field:'dlp_mo',         type:'number' },
  ],
};

// Extra fields per supplier category type
var PROC_EXTRA_FIELDS = {
  module_supplier: [
    { lbl:'Domestic Content Certification', field:'dom_content_cert', type:'toggle' },
    { lbl:'IRA Adder Eligible',              field:'ira_adder',        type:'toggle' },
    { lbl:'Annual Degradation Guarantee (%)',field:'degrad_guar',      type:'number' },
    { lbl:'Insolvency / Repurchase Guarantee', field:'insolvency_guar',type:'toggle' },
  ],
  inverter_supplier: [
    { lbl:'Extended Warranty Option',        field:'ext_warranty',     type:'toggle' },
    { lbl:'Remote Monitoring Included',      field:'remote_mon',       type:'toggle' },
  ],
  tracker_supplier: [
    { lbl:'Terrain Following Algorithm',     field:'terrain_follow',   type:'toggle' },
    { lbl:'Installation Assistance',         field:'install_assist',   type:'toggle' },
  ],
  bess_supplier: [
    { lbl:'Capacity Guarantee (%)',          field:'cap_guar_pct',     type:'number' },
    { lbl:'Round-trip Efficiency Guarantee (%)', field:'rte_guar',     type:'number' },
    { lbl:'Augmentation Commitment',         field:'aug_commit',       type:'toggle' },
    { lbl:'10-Year Service Agreement',        field:'service_10yr',     type:'toggle' },
  ],
  epc: [
    { lbl:'EPC Scope',                       field:'epc_scope',        type:'select', opts:['','Full EPC','Civil Only','Electrical Only','Split EPC'] },
    { lbl:'Prevailing Wage Compliance',       field:'prev_wage',        type:'toggle' },
    { lbl:'Domestic Content Compliance',      field:'dom_content',      type:'toggle' },
  ],
  design_firm: [
    { lbl:'Design Stage',                    field:'design_stage',     type:'select', opts:['','Concept','30%','60%','90%','IFC','As-Built'] },
    { lbl:'Stamped Drawings',                field:'stamped',          type:'toggle' },
  ],
};

function getProcContracts() {
  var tf = (currentProject && currentProject.tally_fields) || {};
  try { return JSON.parse(tf.procurement_contracts || '[]'); } catch(e) { return []; }
}
function saveProcContracts(contracts, cb) {
  if (!currentProjectId || !currentUserId) return;
  var tf = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  tf.procurement_contracts = JSON.stringify(contracts);
  if (currentProject) currentProject.tally_fields = tf;
  sb.from('projects').update({ tally_fields: tf, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(r) { if (cb) cb(r); });
}
function pcUid() { return 'pc_' + Date.now() + '_' + Math.floor(Math.random()*9999); }

var pcOpenState = {};
var pcSubState  = {};

function buildProcurementContractsPane(project) {
  var tf        = project.tally_fields || {};
  var contracts = getProcContracts();
  var suppliers = getRegistry('suppliers');

  var totalF = 0, filledF = 0;
  contracts.forEach(function(c) {
    var allF = PROC_CONTRACT_SECTIONS.common
      .concat(PROC_CONTRACT_SECTIONS.payments)
      .concat(PROC_CONTRACT_SECTIONS.ld_delivery)
      .concat(PROC_EXTRA_FIELDS[c.supplierType] || []);
    allF.forEach(function(f) {
      totalF++;
      var k = 'pc_' + c.id + '_' + f.field;
      if (tf[k] !== undefined && tf[k] !== null && String(tf[k]).trim() !== '' && tf[k] !== false) filledF++;
    });
  });
  var pct = totalF ? Math.round(filledF / totalF * 100) : 0;
  var fc  = pct === 100 ? '#2e7d4f' : pct > 40 ? '#e07b20' : '#c0392b';

  var html = '<div class="cp-tab-pane" id="tab-spec">';

  // Header
  html += '<div style="margin-bottom:12px;">' +
    '<div style="font-size:12px;font-weight:800;color:#1a1f2e;margin-bottom:3px;">📋 Supplier & Contractor Contracts</div>' +
    '<div style="font-size:10px;color:#8a95a5;line-height:1.5;">Select a supplier or contractor from your registry and define the commercial terms for each agreement.</div>' +
  '</div>';

  html += '<div class="spec-completeness">' +
    '<div class="spec-comp-bar-wrap"><div class="spec-comp-label">Contracts Completeness</div>' +
    '<div class="spec-comp-track" style="margin-top:6px;"><div class="spec-comp-fill" id="pc-comp-fill" style="width:' + pct + '%;background:' + fc + ';"></div></div></div>' +
    '<div style="text-align:right;flex-shrink:0;"><div class="spec-comp-pct" id="pc-comp-pct">' + pct + '%</div>' +
    '<div class="spec-comp-hint" id="pc-comp-hint">' + contracts.length + ' contract' + (contracts.length !== 1 ? 's' : '') + ' · ' + filledF + '/' + totalF + ' fields</div></div></div>';

  html += '<div id="pc-cards-wrap">';
  if (!contracts.length) {
    html += '<div class="da-empty-state" style="border-color:rgba(125,60,152,0.3);background:rgba(125,60,152,0.04);">' +
      '<div style="font-size:32px;margin-bottom:8px;">📋 🤝</div>' +
      '<div style="font-size:12px;font-weight:700;color:#7d3c98;margin-bottom:4px;">No contracts yet</div>' +
      '<div style="font-size:11px;color:#8a95a5;line-height:1.5;">Add a contract card for each supplier or contractor.<br>First add companies in the Suppliers & Contractors registry.</div>' +
    '</div>';
  } else {
    contracts.forEach(function(c) { html += buildPcCard(c, tf); });
  }
  html += '</div>';

  // Add contract button — picks from supplier registry
  html += '<button class="da-add-btn" style="border-color:rgba(125,60,152,0.4);color:#7d3c98;" onclick="openAddPcPicker()">' +
    '<span style="font-size:18px;">＋</span> Add Contract from Supplier Registry</button>';

  // Supplier picker (hidden by default)
  html += '<div id="pc-picker" style="display:none;background:#fff;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.14);padding:14px;margin-top:4px;">';
  if (!suppliers.length) {
    html += '<div style="font-size:11px;color:#8a95a5;text-align:center;padding:12px 0;">No suppliers in registry. <button onclick="openRegPanel(\'suppliers\')" style="background:none;border:none;color:#7d3c98;font-weight:700;cursor:pointer;font-size:11px;">Add suppliers first →</button></div>';
  } else {
    html += '<div style="font-size:9px;font-weight:700;text-transform:uppercase;color:#8a95a5;margin-bottom:8px;">Select a supplier to create a contract:</div>';
    html += '<div style="display:flex;flex-wrap:wrap;gap:7px;">';
    suppliers.forEach(function(sup) {
      var def = REG_DEFS.suppliers.types[sup.type] || {};
      var nf  = def.fields && def.fields.find(function(f) { return f.req; });
      var nm  = nf ? ((sup.fields || {})[nf.field] || def.label) : (def.label || sup.type);
      html += '<button class="reg-type-chip" onclick="addProcContract(\'' + sup.id + '\',\'' + sup.type + '\',\'' + escHtml(nm).replace(/'/g,'\\\'') + '\')">' +
        '<span class="reg-type-chip-icon">' + (def.icon || '🏢') + '</span>' + escHtml(nm) + '</button>';
    });
    html += '</div>';
  }
  html += '</div>';

  html += '<div class="spec-card" style="margin-top:10px;"><div class="spec-save-row">' +
    '<button class="spec-save-btn" onclick="saveProcurementSpec()">💾 Save All</button>' +
    '<span class="spec-save-msg" id="spec-save-msg">Saved ✓</span>' +
    '<button class="spec-assess-btn" onclick="openCatForm(\'score_procurement\')">▶ ' +
      (currentProject.score_procurement != null ? 'Retake Assessment' : 'Start Assessment') + '</button>' +
  '</div></div>';

  html += '</div>';
  return html;
}

function buildPcCard(contract, tf) {
  var supDef  = REG_DEFS.suppliers.types[contract.supplierType] || {};
  var icon    = supDef.icon || '🏢';
  var typeLabel = supDef.label || contract.supplierType;
  var color   = supDef.color || '#7d3c98';
  var isOpen  = pcOpenState[contract.id] !== false;

  var allF = PROC_CONTRACT_SECTIONS.common
    .concat(PROC_CONTRACT_SECTIONS.payments)
    .concat(PROC_CONTRACT_SECTIONS.ld_delivery)
    .concat(PROC_EXTRA_FIELDS[contract.supplierType] || []);
  var total = allF.length, filled = 0;
  allF.forEach(function(f) {
    var k = 'pc_' + contract.id + '_' + f.field;
    if (tf[k] !== undefined && tf[k] !== null && String(tf[k]).trim() !== '' && tf[k] !== false) filled++;
  });
  var pct = total ? Math.round(filled / total * 100) : 0;

  var html = '<div class="da-array-card" id="pcc-' + contract.id + '" style="border-color:' + color + '33;">' +
    '<div class="da-array-hdr" style="background:linear-gradient(135deg,' + color + 'dd 0%,' + color + '88 100%);" onclick="togglePcCard(\'' + contract.id + '\')">' +
      '<span class="da-array-icon">' + icon + '</span>' +
      '<div class="da-array-name-wrap">' +
        '<div class="da-array-name">' + escHtml(contract.supplierName) + '</div>' +
        '<div class="da-array-meta">' + typeLabel + ' · ' + filled + '/' + total + ' fields</div>' +
      '</div>' +
      '<span class="da-array-pct-badge" id="pcpct-' + contract.id + '">' + pct + '%</span>' +
      '<span class="da-array-chev' + (isOpen ? ' open' : '') + '" id="pcchev-' + contract.id + '">▼</span>' +
      '<button class="da-array-del" onclick="deleteProcContract(event,\'' + contract.id + '\')">✕ Remove</button>' +
    '</div>' +
    '<div class="da-array-body' + (isOpen ? ' open' : '') + '" id="pcbody-' + contract.id + '">';

  // 3 sub-sections: contract terms, payment milestones, LDs & delivery
  var sections = [
    { key: 'terms',    icon: '📋', title: 'Contract Terms',          fields: PROC_CONTRACT_SECTIONS.common.concat(PROC_EXTRA_FIELDS[contract.supplierType] || []) },
    { key: 'payments', icon: '💳', title: 'Payment Milestones',       fields: PROC_CONTRACT_SECTIONS.payments },
    { key: 'ld',       icon: '⚠️', title: 'LDs, Delivery & Warranty', fields: PROC_CONTRACT_SECTIONS.ld_delivery },
  ];

  sections.forEach(function(sec) {
    var stateKey = contract.id + '_' + sec.key;
    var secOpen  = pcSubState[stateKey] === true;
    var secFill  = sec.fields.filter(function(f) {
      var k = 'pc_' + contract.id + '_' + f.field;
      return tf[k] !== undefined && tf[k] !== null && String(tf[k]).trim() !== '' && tf[k] !== false;
    }).length;

    html += '<div class="spec-card">' +
      '<div class="spec-section-hdr" onclick="togglePcSub(\'' + stateKey + '\')">' +
        '<span class="spec-section-icon">' + sec.icon + '</span>' +
        '<span class="spec-section-title">' + sec.title + '</span>' +
        '<span class="spec-section-filled">' + secFill + '/' + sec.fields.length + '</span>' +
        '<span class="spec-section-chev' + (secOpen ? ' open' : '') + '" id="pcsubchev-' + stateKey + '">▼</span>' +
      '</div>' +
      '<div class="spec-section-body' + (secOpen ? ' open' : '') + '" id="pcsub-' + stateKey + '"><div class="spec-grid">';

    sec.fields.forEach(function(f) {
      var k    = 'pc_' + contract.id + '_' + f.field;
      var val  = (tf[k] !== undefined) ? tf[k] : '';
      var full = f.col === 2 ? ' full' : '';
      html += '<div class="spec-field' + full + '"><label class="spec-lbl">' + f.lbl + '</label>';
      if (f.type === 'toggle') {
        var chk = val === true || val === 'true';
        html += '<div class="spec-toggle-row"><label class="spec-toggle"><input type="checkbox" data-pc="' + contract.id + '" data-field="' + f.field + '" data-type="toggle"' + (chk ? ' checked' : '') + ' onchange="onPcFieldChange(this)"/><span class="spec-toggle-slider"></span></label><span class="spec-toggle-lbl">' + (chk ? 'Yes' : 'No') + '</span></div>';
      } else if (f.type === 'select') {
        html += '<select class="spec-select" data-pc="' + contract.id + '" data-field="' + f.field + '" onchange="onPcFieldChange(this)">';
        (f.opts || []).forEach(function(o) { html += '<option value="' + escHtml(o) + '"' + (String(val) === o ? ' selected' : '') + '>' + escHtml(o || '— Select —') + '</option>'; });
        html += '</select>';
      } else {
        html += '<input class="spec-input" type="' + f.type + '" data-pc="' + contract.id + '" data-field="' + f.field + '" value="' + escHtml(String(val)) + '" placeholder="Enter value" oninput="onPcFieldChange(this)"/>';
      }
      html += '</div>';
    });
    html += '</div></div></div>';
  });

  html += '</div></div>';
  return html;
}

function togglePcCard(cId) {
  pcOpenState[cId] = pcOpenState[cId] === false ? true : false;
  var body = document.getElementById('pcbody-' + cId);
  var chev = document.getElementById('pcchev-' + cId);
  if (body) body.classList.toggle('open', pcOpenState[cId] !== false);
  if (chev) chev.classList.toggle('open', pcOpenState[cId] !== false);
}
function togglePcSub(key) {
  pcSubState[key] = !pcSubState[key];
  var body = document.getElementById('pcsub-' + key);
  var chev = document.getElementById('pcsubchev-' + key);
  if (body) body.classList.toggle('open', pcSubState[key]);
  if (chev) chev.classList.toggle('open', pcSubState[key]);
}
function onPcFieldChange(el) {
  if (el.type === 'checkbox') {
    var row = el.closest('.spec-toggle-row');
    if (row) { var lbl = row.querySelector('.spec-toggle-lbl'); if (lbl) lbl.textContent = el.checked ? 'Yes' : 'No'; }
  }
}
function openAddPcPicker() {
  var picker = document.getElementById('pc-picker');
  if (picker) picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
}
function addProcContract(supplierId, supplierType, supplierName) {
  var picker = document.getElementById('pc-picker');
  if (picker) picker.style.display = 'none';
  var contracts = getProcContracts();
  var newId = pcUid();
  contracts.push({ id: newId, supplierId: supplierId, supplierType: supplierType, supplierName: supplierName });
  pcOpenState[newId] = true;
  pcSubState[newId + '_terms'] = true;
  saveProcContracts(contracts, function() {
    var wrap = document.getElementById('pc-cards-wrap');
    if (!wrap) return;
    var tf = (currentProject && currentProject.tally_fields) || {};
    var empty = wrap.querySelector('.da-empty-state');
    if (empty) empty.remove();
    wrap.insertAdjacentHTML('beforeend', buildPcCard({ id: newId, supplierId: supplierId, supplierType: supplierType, supplierName: supplierName }, tf));
    var card = document.getElementById('pcc-' + newId);
    if (card) card.scrollIntoView({ behavior:'smooth', block:'start' });
  });
}
function deleteProcContract(evt, cId) {
  evt.stopPropagation();
  if (!confirm('Remove this contract?')) return;
  var contracts = getProcContracts().filter(function(c) { return c.id !== cId; });
  var tf = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  Object.keys(tf).forEach(function(k) { if (k.startsWith('pc_' + cId + '_')) delete tf[k]; });
  tf.procurement_contracts = JSON.stringify(contracts);
  if (currentProject) currentProject.tally_fields = tf;
  sb.from('projects').update({ tally_fields: tf, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function() {
      var card = document.getElementById('pcc-' + cId);
      if (card) card.remove();
      var wrap = document.getElementById('pc-cards-wrap');
      if (wrap && !wrap.querySelector('.da-array-card')) {
        wrap.innerHTML = '<div class="da-empty-state" style="border-color:rgba(125,60,152,0.3);background:rgba(125,60,152,0.04);">' +
          '<div style="font-size:32px;margin-bottom:8px;">📋 🤝</div>' +
          '<div style="font-size:12px;font-weight:700;color:#7d3c98;margin-bottom:4px;">No contracts yet</div>' +
          '<div style="font-size:11px;color:#8a95a5;">Add from the supplier registry below.</div></div>';
      }
    });
}
function saveProcurementSpec() {
  if (!currentProjectId || !currentUserId) return;
  var contracts = getProcContracts();
  var tf = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  document.querySelectorAll('[data-pc][data-field]').forEach(function(el) {
    var cId   = el.getAttribute('data-pc');
    var field = el.getAttribute('data-field');
    tf['pc_' + cId + '_' + field] = el.type === 'checkbox' ? el.checked : el.value.trim();
  });
  tf.procurement_contracts = JSON.stringify(contracts);
  if (currentProject) currentProject.tally_fields = tf;
  sb.from('projects').update({ tally_fields: tf, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(res) {
      if (res && res.error) { alert('Save failed: ' + res.error.message); return; }
      var msg = document.getElementById('spec-save-msg');
      if (msg) { msg.classList.add('show'); setTimeout(function(){ msg.classList.remove('show'); }, 2500); }
      renderLeft(currentProject);
    });
}



/* ── COMPONENT TYPE DEFINITIONS ────────────── */
var MC_TYPES = {
  /* Procurement component types */
  module:      { icon: '🔋', label: 'Module Array',   fields: [
    { lbl:'Nickname / Array ID',    field:'nickname',      type:'text',   col:2 },
    { lbl:'Manufacturer',           field:'mfr',           type:'text' },
    { lbl:'Model',                  field:'model',         type:'text' },
    { lbl:'Technology',             field:'tech',          type:'select', opts:['','Mono PERC','TOPCon','HJT','CIGS','CdTe','Other'] },
    { lbl:'Wattage (W)',            field:'watt',          type:'number' },
    { lbl:'Efficiency (%)',         field:'eff_pct',       type:'number' },
    { lbl:'Bifaciality (%)',        field:'bifac_pct',     type:'number' },
    { lbl:'Quantity (#)',           field:'qty',           type:'number' },
    { lbl:'Country of Manufacture', field:'country',       type:'text' },
    { lbl:'Warranty (years)',       field:'warranty_yrs',  type:'number' },
    { lbl:'Annual Degradation (%)',  field:'degrad_pct',   type:'number' },
    { lbl:'Domestic Content',       field:'dom_content',   type:'toggle' },
  ], milestones:['RFQ Issued','Bids Received','Supplier Selected','Letter of Intent','PO Issued','Factory Inspection','Delivery to Site','Installation Complete'] },

  inverter:    { icon: '⚡', label: 'Inverter Set',  fields: [
    { lbl:'Nickname / Zone',        field:'nickname',      type:'text',   col:2 },
    { lbl:'Manufacturer',           field:'mfr',           type:'text' },
    { lbl:'Model',                  field:'model',         type:'text' },
    { lbl:'Configuration',          field:'config',        type:'select', opts:['','Central','String','Micro'] },
    { lbl:'Power Rating (kW)',      field:'kw',            type:'number' },
    { lbl:'Quantity',               field:'qty',           type:'number' },
    { lbl:'Warranty (years)',       field:'warranty_yrs',  type:'number' },
    { lbl:'Reactive Power Capability', field:'reactive',   type:'toggle' },
  ], milestones:['RFQ Issued','Supplier Selected','PO Issued','Factory Test','Delivery','Commissioning'] },

  bess:        { icon: '🔌', label: 'BESS Unit',     fields: [
    { lbl:'Nickname / Block ID',    field:'nickname',      type:'text',   col:2 },
    { lbl:'Manufacturer',           field:'mfr',           type:'text' },
    { lbl:'Model',                  field:'model',         type:'text' },
    { lbl:'Cell Chemistry',         field:'chemistry',     type:'select', opts:['','LFP','NMC','NCA','Other'] },
    { lbl:'Energy Capacity (MWh)',  field:'mwh',           type:'number' },
    { lbl:'Power Capacity (MW)',    field:'mw',            type:'number' },
    { lbl:'Duration (hours)',       field:'duration_h',    type:'number' },
    { lbl:'Round-trip Efficiency (%)', field:'rte_pct',   type:'number' },
    { lbl:'Cycle Life (at DoD)',    field:'cycle_life',    type:'number' },
    { lbl:'Depth of Discharge (%)', field:'dod_pct',       type:'number' },
    { lbl:'Number of Containers',   field:'containers',    type:'number' },
    { lbl:'Augmentation Plan (yr)', field:'aug_year',      type:'number' },
    { lbl:'Coupling',               field:'coupling',      type:'select', opts:['','AC-coupled','DC-coupled'] },
    { lbl:'Control Strategy',       field:'control',       type:'select', opts:['','Arbitrage','Capacity Firming','Frequency Regulation','Ancillary Services','Multiple'] },
    { lbl:'Shared POI with Solar',  field:'shared_poi',    type:'toggle' },
  ], milestones:['RFQ Issued','Supplier Selected','PO Issued','Factory Acceptance Test','Site Delivery','Container Installation','PCS Commissioning','Capacity Test','Grid Sync'] },

  tracker:     { icon: '🌞', label: 'Tracker System', fields: [
    { lbl:'Nickname / Zone',        field:'nickname',      type:'text',   col:2 },
    { lbl:'Manufacturer',           field:'mfr',           type:'text' },
    { lbl:'Model',                  field:'model',         type:'text' },
    { lbl:'Type',                   field:'type',          type:'select', opts:['','Single-Axis','Dual-Axis'] },
    { lbl:'Pile Type',              field:'pile_type',     type:'select', opts:['','Driven','Helical','Ground Screw'] },
    { lbl:'Warranty (years)',       field:'warranty_yrs',  type:'number' },
    { lbl:'Total Tracker Rows',     field:'rows',          type:'number' },
  ], milestones:['RFQ Issued','Supplier Selected','PO Issued','Delivery','Pile Driving Complete','Tracker Installation Complete'] },

  transformer: { icon: '🔧', label: 'Transformer',   fields: [
    { lbl:'Tag / ID',               field:'nickname',      type:'text',   col:2 },
    { lbl:'Manufacturer',           field:'mfr',           type:'text' },
    { lbl:'Rating (MVA)',           field:'mva',           type:'number' },
    { lbl:'Primary Voltage (kV)',   field:'primary_kv',    type:'number' },
    { lbl:'Secondary Voltage (kV)', field:'secondary_kv',  type:'number' },
    { lbl:'Quantity',               field:'qty',           type:'number' },
    { lbl:'Lead Time (weeks)',       field:'lead_wks',      type:'number' },
  ], milestones:['PO Issued','Factory Design Review','Factory Acceptance Test','Shipment','Delivery','Installation','Energisation'] },

  /* Design component types */
  array_zone:  { icon: '☀️', label: 'PV Array Zone',  fields: [
    { lbl:'Zone Name / ID',         field:'nickname',      type:'text',   col:2 },
    { lbl:'DC Capacity (MWdc)',     field:'dc_mw',         type:'number' },
    { lbl:'AC Capacity (MWac)',     field:'ac_mw',         type:'number' },
    { lbl:'DC:AC Ratio (ILR)',      field:'ilr',           type:'number' },
    { lbl:'P50 Yield (MWh/yr)',     field:'p50_mwh',       type:'number' },
    { lbl:'Racking Type',           field:'racking',       type:'select', opts:['','Single-Axis Tracker','Fixed Tilt'] },
    { lbl:'Collector Voltage (kV)', field:'collector_kv',  type:'number' },
    { lbl:'Module Technology',      field:'mod_tech',      type:'select', opts:['','Mono PERC','TOPCon','HJT','Other'] },
    { lbl:'Inverter Type',          field:'inv_type',      type:'select', opts:['','Central','String'] },
    { lbl:'Grid connection phase',  field:'phase',         type:'select', opts:['','Phase 1','Phase 2','Phase 3','Stand-alone'] },
  ], milestones:['30% Design','60% Design','90% Design','IFC Package','Permitting Submission','Construction Start','Energisation','As-Built'] },

  bess_design: { icon: '🔌', label: 'BESS Design Block', fields: [
    { lbl:'Block Name / ID',        field:'nickname',      type:'text',   col:2 },
    { lbl:'Energy Capacity (MWh)',  field:'mwh',           type:'number' },
    { lbl:'Power (MW)',             field:'mw',            type:'number' },
    { lbl:'Duration (hours)',       field:'duration_h',    type:'number' },
    { lbl:'Cell Chemistry',         field:'chemistry',     type:'select', opts:['','LFP','NMC','NCA','Other'] },
    { lbl:'Coupling',               field:'coupling',      type:'select', opts:['','AC-coupled','DC-coupled'] },
    { lbl:'PCS Rating (MW)',        field:'pcs_mw',        type:'number' },
    { lbl:'Control Strategy',       field:'control',       type:'select', opts:['','Arbitrage','Capacity','Frequency Reg','Ancillary Services','Multiple'] },
  ], milestones:['Concept Design','30% Design','60% Design','90% Design','IFC','Permitting','Construction Start','Commissioning'] },

  /* Construction work package types */
  civil_pkg:   { icon: '🏗️', label: 'Civil Package',  fields: [
    { lbl:'Package Name',           field:'nickname',      type:'text',   col:2 },
    { lbl:'Clearing / Grubbing (acres)', field:'clear_acres', type:'number' },
    { lbl:'Grading Volume (m³)',    field:'grade_m3',      type:'number' },
    { lbl:'Road Length (km)',       field:'road_km',       type:'number' },
    { lbl:'Fence Length (km)',      field:'fence_km',      type:'number' },
    { lbl:'Total Piles',            field:'piles',         type:'number' },
    { lbl:'Pile Drivers',           field:'pile_drivers',  type:'number' },
    { lbl:'Civil Contractor',       field:'contractor',    type:'text' },
    { lbl:'EPC Scope',              field:'epc_scope',     type:'toggle' },
  ], milestones:['Mobilisation','Clearing & Grubbing','Grading Complete','Pile Driving Start','Pile Driving Complete','Roads & Fencing Done'] },

  elec_pkg:    { icon: '⚡', label: 'Electrical Package', fields: [
    { lbl:'Package Name',           field:'nickname',      type:'text',   col:2 },
    { lbl:'DC Trenching (km)',      field:'dc_trench_km',  type:'number' },
    { lbl:'AC Trenching (km)',      field:'ac_trench_km',  type:'number' },
    { lbl:'Inverters in Scope',     field:'inv_count',     type:'number' },
    { lbl:'Transformers in Scope',  field:'xfmr_count',    type:'number' },
    { lbl:'Electrical Contractor',  field:'contractor',    type:'text' },
    { lbl:'EPC Scope',              field:'epc_scope',     type:'toggle' },
  ], milestones:['DC Trenching Start','DC Trenching Complete','AC Trenching Start','AC Trenching Complete','Inverter Commissioning','Transformer Energisation','SCADA Online'] },

  module_install: { icon: '☀️', label: 'Module Installation', fields: [
    { lbl:'Package Name',           field:'nickname',      type:'text',   col:2 },
    { lbl:'Total Modules in Scope', field:'mod_count',     type:'number' },
    { lbl:'Modules/Crew/Day',       field:'rate',          type:'number' },
    { lbl:'Number of Crews',        field:'crews',         type:'number' },
    { lbl:'Peak Manpower',          field:'peak_mp',       type:'number' },
    { lbl:'Install Contractor',     field:'contractor',    type:'text' },
  ], milestones:['Mobilisation','First Modules Racked','50% Complete','Last Module Racked','String Testing','Final Inspection'] },

  bess_install: { icon: '🔌', label: 'BESS Installation', fields: [
    { lbl:'Package Name',           field:'nickname',      type:'text',   col:2 },
    { lbl:'Foundation Type',        field:'found_type',    type:'select', opts:['','Concrete Pad','Piles','Gravel Pad'] },
    { lbl:'Containers to Install',  field:'containers',    type:'number' },
    { lbl:'Crane Capacity (tons)',   field:'crane_tons',    type:'number' },
    { lbl:'BESS Contractor',        field:'contractor',    type:'text' },
  ], milestones:['Foundation Complete','Container Delivery','Containers Set','DC String Assembly','PCS Installation','Fire Suppression','Functional Testing','Capacity Test','Grid Sync'] },

  other:       { icon: '📦', label: 'Other',            fields: [
    { lbl:'Description',            field:'nickname',      type:'text',   col:2 },
    { lbl:'Manufacturer / Vendor',  field:'mfr',           type:'text' },
    { lbl:'Quantity',               field:'qty',           type:'number' },
    { lbl:'Lead Time (weeks)',      field:'lead_wks',      type:'number' },
    { lbl:'Notes',                  field:'notes',         type:'text',   col:2 },
  ], milestones:['Order Placed','Delivery','Installation','Commissioning'] },
};

/* Which component types are available per category */
var CAT_MC_CONFIG = {
  score_procurement: {
    label: 'Equipment Components',
    hint:  'Add each major equipment type as a separate component. You can add multiple arrays, inverter sets, or BESS blocks.',
    types: ['module','inverter','bess','tracker','transformer','other'],
    storeKey: 'proc_components',
  },
  score_design: {
    label: 'Design Blocks',
    hint:  'Add a block for each distinct PV array zone or BESS block. Useful for multi-phase or hybrid solar+storage projects.',
    types: ['array_zone','bess_design'],
    storeKey: 'design_components',
  },
  score_construct: {
    label: 'Work Packages',
    hint:  'Break construction into packages — civil, electrical, module installation, BESS. Track each independently.',
    types: ['civil_pkg','elec_pkg','module_install','bess_install'],
    storeKey: 'construct_components',
  },
};

/* ── COMPONENT STORAGE HELPERS ─────────────── */
function getMcComponents(catKey) {
  var cfg = CAT_MC_CONFIG[catKey];
  if (!cfg) return [];
  var tf  = (currentProject && currentProject.tally_fields) || {};
  try { return JSON.parse(tf[cfg.storeKey] || '[]'); } catch(e) { return []; }
}

function saveMcComponents(catKey, comps, cb) {
  var cfg = CAT_MC_CONFIG[catKey];
  if (!cfg || !currentProjectId || !currentUserId) return;
  var tf = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  tf[cfg.storeKey] = JSON.stringify(comps);
  if (currentProject) currentProject.tally_fields = tf;
  sb.from('projects').update({ tally_fields: tf, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(res) { if (cb) cb(res); });
}

/* Legacy compat for procurement-specific calls */
function getProcComponents() { return getMcComponents('score_procurement'); }
function saveProcComponents(comps, cb) { saveMcComponents('score_procurement', comps, cb); }

function mcUid() {
  return 'mc_' + Date.now() + '_' + Math.floor(Math.random()*9999);
}

/* ── GENERIC MULTI-COMPONENT PANE ───────────── */
function buildMcPane(catKey, project) {
  var cfg   = CAT_MC_CONFIG[catKey];
  var comps = getMcComponents(catKey);
  var html  = '<div class="cp-tab-pane" id="tab-spec">';

  // Completeness header
  var totalF = 0, filledF = 0;
  comps.forEach(function(c) {
    var def = MC_TYPES[c.type]; if (!def) return;
    def.fields.forEach(function(f) {
      totalF++;
      var v = (c.fields || {})[f.field];
      if (v !== undefined && v !== null && String(v).trim() !== '') filledF++;
    });
  });
  var pct = totalF ? Math.round(filledF/totalF*100) : 0;
  var fc  = pct===100 ? '#2e7d4f' : pct>40 ? '#e07b20' : '#c0392b';

  html += '<div class="spec-completeness">' +
    '<div class="spec-comp-bar-wrap">' +
      '<div class="spec-comp-label">' + escHtml(cfg.label) + ' Completeness</div>' +
      '<div style="font-size:9px;color:#8a95a5;margin-top:2px;">' + escHtml(cfg.hint) + '</div>' +
      '<div class="spec-comp-track" style="margin-top:6px;"><div class="spec-comp-fill" style="width:'+pct+'%;background:'+fc+'"></div></div>' +
    '</div>' +
    '<div style="text-align:right;flex-shrink:0;">' +
      '<div class="spec-comp-pct">'+pct+'%</div>' +
      '<div class="spec-comp-hint">'+comps.length+' block'+(comps.length!==1?'s':'')+' · '+filledF+'/'+totalF+' fields</div>' +
    '</div>' +
  '</div>';

  // Component cards
  html += '<div id="mc-cards-wrap-'+catKey+'">';
  if (!comps.length) {
    html += buildMcEmptyState(cfg);
  } else {
    comps.forEach(function(comp) { html += buildMcCard(comp, comps, catKey); });
  }
  html += '</div>';

  // Add button + type picker
  html += buildMcAddRow(catKey, cfg);

  // Save row
  html += '<div class="spec-card"><div class="spec-save-row">' +
    '<button class="spec-save-btn" onclick="saveMcSpec(\''+catKey+'\')">💾 Save All</button>' +
    '<span class="spec-save-msg" id="spec-save-msg">Saved ✓</span>' +
    '<button class="spec-assess-btn" onclick="startAiAssessment(\''+catKey+'\')">▶ Start Assessment</button>' +
  '</div></div>';

  html += '</div>';
  return html;
}

/* Legacy alias kept for any calls to buildProcurementPane */
function buildProcurementPane(project) { return buildMcPane('score_procurement', project); }

function buildMcEmptyState(cfg) {
  var typeIcons = cfg.types.map(function(t){ return MC_TYPES[t] ? MC_TYPES[t].icon : '📦'; }).join(' ');
  return '<div class="mc-empty-state">' +
    '<div style="font-size:28px;margin-bottom:8px;">' + typeIcons + '</div>' +
    '<div style="font-size:12px;font-weight:700;color:#1a1f2e;margin-bottom:4px;">No blocks added yet</div>' +
    '<div style="font-size:11px;color:#8a95a5;line-height:1.5;">Use the button below to add your first block.</div>' +
  '</div>';
}

function buildMcAddRow(catKey, cfg) {
  var menuId = 'mc-type-menu-' + catKey;
  var chips  = cfg.types.map(function(t) {
    var def = MC_TYPES[t];
    if (!def) return '';
    return '<button class="mc-type-chip" onclick="addMcComponent(\''+catKey+'\',\''+t+'\')">' +
      def.icon + ' ' + def.label + '</button>';
  }).join('');
  return '<button class="mc-add-btn" onclick="toggleMcTypePicker(\''+catKey+'\')">' +
    '<span style="font-size:16px;">＋</span> Add ' + (CAT_MC_CONFIG[catKey] ? CAT_MC_CONFIG[catKey].label.replace('s','').trim() : 'Component') +
  '</button>' +
  '<div class="mc-type-menu" id="' + menuId + '">' + chips + '</div>';
}

/* Build one component card */
function buildMcCard(comp, allComps, catKey) {
  var def    = MC_TYPES[comp.type] || MC_TYPES.other;
  var fields = comp.fields   || {};
  var tl     = comp.timeline || {};

  // User-defined nickname or auto-label
  var nickname  = (fields.nickname || '').trim();
  var sameType  = allComps.filter(function(c){ return c.type === comp.type; });
  var typeIdx   = sameType.indexOf(comp) + 1;
  var autoLabel = def.label + (sameType.length > 1 ? ' #' + typeIdx : '');
  var title     = nickname || autoLabel;

  var html = '<div class="mc-component-card" id="mcc-'+comp.id+'">' +
    '<div class="mc-component-hdr">' +
      '<span class="mc-component-icon">'+def.icon+'</span>' +
      '<div class="mc-component-title-wrap">' +
        '<span class="mc-component-title">'+escHtml(title)+'</span>' +
        '<span class="mc-component-type-badge">'+escHtml(def.label)+'</span>' +
      '</div>' +
      '<button class="mc-component-toggle" onclick="toggleMcCard(\''+comp.id+'\')" id="mcc-toggle-'+comp.id+'">▼</button>' +
      '<button class="mc-component-del" onclick="deleteMcComponent(\''+catKey+'\',\''+comp.id+'\')">✕</button>' +
    '</div>' +
    '<div class="mc-component-body" id="mcc-body-'+comp.id+'">' +
    '<div class="spec-grid">';

  def.fields.forEach(function(f) {
    var val      = fields[f.field] !== undefined ? fields[f.field] : '';
    var spanFull = f.col === 2 ? ' full' : '';
    html += '<div class="spec-field'+spanFull+'">' +
      '<label class="spec-lbl">'+f.lbl+'</label>';

    if (f.type === 'toggle') {
      var checked = val===true||val==='true'||val==='Y';
      html += '<div class="spec-toggle-row">' +
        '<label class="spec-toggle"><input type="checkbox" data-comp="'+comp.id+'" data-field="'+f.field+'" data-type="toggle"'+(checked?' checked':'')+' onchange="onMcChange(this)"/><span class="spec-toggle-slider"></span></label>' +
        '<span class="spec-toggle-lbl">'+(checked?'Yes':'No')+'</span>' +
      '</div>';
    } else if (f.type === 'select') {
      html += '<select class="spec-select" data-comp="'+comp.id+'" data-field="'+f.field+'" data-type="select" onchange="onMcChange(this)">';
      (f.opts||[]).forEach(function(o) {
        html += '<option value="'+escHtml(o)+'"'+(String(val)===o?' selected':'')+'>'+escHtml(o||'— Select —')+'</option>';
      });
      html += '</select>';
    } else {
      html += '<input class="spec-input" type="'+f.type+'" data-comp="'+comp.id+'" data-field="'+f.field+'" data-type="'+f.type+'" value="'+escHtml(String(val))+'" placeholder="Enter value" oninput="onMcChange(this)"/>';
    }
    html += '</div>';
  });

  html += '</div>'; // spec-grid

  // Per-component timeline
  html += '<div class="mc-tl-strip">' +
    '<div class="mc-tl-title">📅 ' + escHtml(def.label) + ' Timeline</div>';
  def.milestones.forEach(function(ms) {
    var msKey  = comp.id + '_' + ms.replace(/[^a-zA-Z0-9]/g,'_').toLowerCase();
    var status = tl[msKey+'_status'] || '';
    var date   = tl[msKey+'_date']   || '';
    var dotCls = status==='complete'?'complete':status==='in_progress'?'in_progress':'';
    html += '<div class="mc-tl-row">' +
      '<div class="mc-tl-dot '+dotCls+'" id="mcdot-'+msKey+'"></div>' +
      '<span class="mc-tl-label">'+escHtml(ms)+'</span>' +
      '<select class="mc-tl-select" data-comp="'+comp.id+'" data-ms="'+msKey+'_status" onchange="onMcTlChange(this)">' +
        '<option value=""'+(status===''?' selected':'')+'>Not started</option>' +
        '<option value="in_progress"'+(status==='in_progress'?' selected':'')+'>In progress</option>' +
        '<option value="complete"'+(status==='complete'?' selected':'')+'>Complete</option>' +
      '</select>' +
      '<input class="mc-tl-date" type="date" data-comp="'+comp.id+'" data-ms="'+msKey+'_date" value="'+escHtml(date)+'" onchange="onMcTlChange(this)"/>' +
    '</div>';
  });
  html += '</div>'; // mc-tl-strip
  html += '</div></div>'; // mc-component-body + mc-component-card
  return html;
}

/* ── INTERACTIONS ───────────────────────────── */
function toggleMcTypePicker(catKey) {
  var menu = document.getElementById('mc-type-menu-' + catKey);
  if (menu) menu.classList.toggle('open');
}

function toggleMcCard(compId) {
  var body   = document.getElementById('mcc-body-'+compId);
  var toggle = document.getElementById('mcc-toggle-'+compId);
  if (!body) return;
  var collapsed = body.style.display === 'none';
  body.style.display = collapsed ? '' : 'none';
  if (toggle) toggle.textContent = collapsed ? '▼' : '▶';
}

function addMcComponent(catKey, type) {
  var menu = document.getElementById('mc-type-menu-' + catKey);
  if (menu) menu.classList.remove('open');
  var comps = getMcComponents(catKey);
  comps.push({ id: mcUid(), type: type, fields: {}, timeline: {} });
  saveMcComponents(catKey, comps, function() { rebuildMcCards(catKey, comps); });
}

function deleteMcComponent(catKey, compId) {
  if (!confirm('Remove this block?')) return;
  var comps = getMcComponents(catKey).filter(function(c){ return c.id !== compId; });
  saveMcComponents(catKey, comps, function() { rebuildMcCards(catKey, comps); });
}

function rebuildMcCards(catKey, comps) {
  var wrap = document.getElementById('mc-cards-wrap-'+catKey);
  if (!wrap) return;
  var cfg = CAT_MC_CONFIG[catKey];
  if (!comps.length) {
    wrap.innerHTML = buildMcEmptyState(cfg);
  } else {
    wrap.innerHTML = comps.map(function(c){ return buildMcCard(c, comps, catKey); }).join('');
  }
  rebuildMcCompleteness(catKey, comps);
}

function rebuildMcCompleteness(catKey, comps) {
  var totalF=0, filledF=0;
  comps.forEach(function(c) {
    var def=MC_TYPES[c.type]; if(!def) return;
    def.fields.forEach(function(f) {
      totalF++;
      var v=(c.fields||{})[f.field];
      if(v!==undefined&&v!==null&&String(v).trim()!=='') filledF++;
    });
  });
  var pct=totalF?Math.round(filledF/totalF*100):0;
  var fc=pct===100?'#2e7d4f':pct>40?'#e07b20':'#c0392b';
  var fill=document.querySelector('.spec-comp-fill');
  var pctEl=document.querySelector('.spec-comp-pct');
  var hintEl=document.querySelector('.spec-comp-hint');
  if(fill){fill.style.width=pct+'%';fill.style.background=fc;}
  if(pctEl) pctEl.textContent=pct+'%';
  var cfg=CAT_MC_CONFIG[catKey];
  if(hintEl) hintEl.textContent=comps.length+' block'+(comps.length!==1?'s':'')+' · '+filledF+'/'+totalF+' fields';
}

function onMcChange(el) {
  if (el.type === 'checkbox') {
    var row = el.closest('.spec-toggle-row');
    if (row) { var lbl = row.querySelector('.spec-toggle-lbl'); if (lbl) lbl.textContent = el.checked?'Yes':'No'; }
  }
  // Update card title if nickname field changed
  if (el.getAttribute('data-field') === 'nickname') {
    var compId = el.getAttribute('data-comp');
    var card   = document.getElementById('mcc-'+compId);
    if (card) {
      var titleEl = card.querySelector('.mc-component-title');
      if (titleEl && el.value.trim()) titleEl.textContent = el.value.trim();
    }
  }
}

function onMcTlChange(el) {
  var msKey = el.getAttribute('data-ms');
  if (msKey.endsWith('_status')) {
    var baseKey = msKey.replace('_status','');
    var dot = document.getElementById('mcdot-'+baseKey);
    if (dot) {
      dot.className = 'mc-tl-dot' + (el.value==='complete'?' complete':el.value==='in_progress'?' in_progress':'');
    }
  }
}

function saveMcSpec(catKey) {
  var comps = getMcComponents(catKey);
  document.querySelectorAll('[data-comp]').forEach(function(el) {
    var compId = el.getAttribute('data-comp');
    var field  = el.getAttribute('data-field');
    var ms     = el.getAttribute('data-ms');
    var comp   = comps.find(function(c){ return c.id===compId; });
    if (!comp) return;
    if (field) {
      if (!comp.fields) comp.fields = {};
      comp.fields[field] = el.type==='checkbox' ? el.checked : el.value.trim();
    }
    if (ms) {
      if (!comp.timeline) comp.timeline = {};
      comp.timeline[ms] = el.value;
    }
  });
  saveMcComponents(catKey, comps, function(res) {
    if (res && res.error) { alert('Save failed: '+res.error.message); return; }
    var msg = document.getElementById('spec-save-msg');
    if (msg) { msg.classList.add('show'); setTimeout(function(){msg.classList.remove('show');},2500); }
    rebuildMcCompleteness(catKey, comps);
  });
}

/* Legacy alias */
function saveProcSpec() { saveMcSpec('score_procurement'); }

/* ==============================================
   AI-DRIVEN ASSESSMENT ENGINE
   GPT generates tailored questions → user answers
   → GPT scores → saved to DB
   ============================================== */

var asmntState = {
  catKey:    null,
  questions: [],    // [{q, context, options:[{letter,text,score,why}]}]
  answers:   [],    // index matches questions, value = option index chosen
  current:   0,
  loading:   false,
  score:     null,
  rationale: null,
  label:     null,
};

/* Build rich project context for GPT */
function buildAsmntContext(catKey) {
  var cat = CATEGORIES.find(function(c){ return c.key === catKey; });
  var tf  = (currentProject && currentProject.tally_fields) || {};
  var lines = [
    'Project: ' + (currentProject.name || 'Unknown'),
    'Capacity: ' + (currentProject.capacity_mw || 'N/A') + ' MWp',
    'Stage: '    + (currentProject.stage || 'N/A'),
    'Category being assessed: ' + (cat ? cat.label : catKey),
    '',
  ];

  // Design uses per-array context; Procurement reads MC blocks; others read flat spec fields
  if (catKey === 'score_design') {
    lines.push(buildDesignAsmntContext());
  } else if (catKey === 'score_procurement') {
    var comps = getMcComponents(catKey);
    var cfg   = CAT_MC_CONFIG[catKey];
    if (comps.length) {
      lines.push((cfg ? cfg.label : 'Components') + ' (' + comps.length + ' blocks):');
      comps.forEach(function(c, i) {
        var def  = MC_TYPES[c.type] || { label: c.type, fields: [] };
        var nick = (c.fields && c.fields.nickname) ? ' "' + c.fields.nickname + '"' : '';
        var fStr = def.fields.filter(function(f){ return f.field !== 'nickname'; }).map(function(f) {
          var v = (c.fields || {})[f.field];
          return (v !== undefined && v !== null && String(v).trim() !== '') ? f.lbl + ': ' + v : null;
        }).filter(Boolean).join(', ');
        lines.push('  ' + (i+1) + '. ' + def.label + nick + (fStr ? ' — ' + fStr : ' (no specs entered)'));
        var tlDone = Object.keys(c.timeline || {}).filter(function(k){ return k.endsWith('_status') && c.timeline[k]; });
        if (tlDone.length) lines.push('     Timeline: ' + tlDone.length + ' milestones tracked');
      });
    } else {
      lines.push('No procurement contract blocks entered yet.');
    }
  } else if (cat) {
    cat.sections.forEach(function(s) {
      var sectionLines = [];
      s.fields.forEach(function(f) {
        var v = tf[f.field];
        if (v !== undefined && v !== null && String(v).trim() !== '') {
          sectionLines.push('  ' + f.lbl + ': ' + v);
        }
      });
      if (sectionLines.length) {
        lines.push(s.title + ':');
        lines = lines.concat(sectionLines);
        lines.push('');
      }
    });
  }

  // Add existing scores for context
  var otherScores = CATEGORIES.filter(function(c){ return c.key !== catKey && currentProject[c.key] != null; });
  if (otherScores.length) {
    lines.push('Other category scores already recorded:');
    otherScores.forEach(function(c){ lines.push('  ' + c.label + ': ' + currentProject[c.key] + '/100'); });
  }

  return lines.join('\n');
}

/* Launch the assessment */
function startAiAssessment(catKey) {
  var cat = CATEGORIES.find(function(c){ return c.key === catKey; });
  asmntState = { catKey: catKey, questions: [], answers: [], current: 0, loading: true, score: null, rationale: null, label: null };

  switchCatTab('assessment');
  renderAsmntLoading(cat, 'Analysing your project data and crafting tailored questions…');

  var ctx = buildAsmntContext(catKey);

  var systemPrompt =
    'You are a senior infrastructure and renewable energy investment analyst conducting a pre-financial-close due diligence review.\n' +
    'Based on the project data provided, generate exactly 8 targeted risk-assessment questions for the "' + (cat ? cat.label : catKey) + '" category.\n\n' +
    'RULES:\n' +
    '- Each question must be SPECIFIC to the actual data provided — reference real values, flag gaps, probe assumptions.\n' +
    '- If a field is missing from the data, ask about it directly.\n' +
    '- If a value looks unusual or risky, ask a pointed question about it.\n' +
    '- Options should be realistic, specific, and ordered from best (lowest risk) to worst (highest risk).\n' +
    '- Include a brief "why" for each option so the user understands the implication.\n\n' +
    'Respond ONLY with a valid JSON array (no markdown, no preamble) in this exact format:\n' +
    '[\n' +
    '  {\n' +
    '    "q": "Question text — be specific, reference real data points",\n' +
    '    "context": "1–2 sentences on why this matters for risk/bankability",\n' +
    '    "options": [\n' +
    '      {"letter":"A","text":"Best-case / lowest risk answer","why":"Implication","score":10},\n' +
    '      {"letter":"B","text":"Moderate / acceptable","why":"Implication","score":6},\n' +
    '      {"letter":"C","text":"Weak / needs attention","why":"Implication","score":3},\n' +
    '      {"letter":"D","text":"Missing / high risk / red flag","why":"Implication","score":0}\n' +
    '    ]\n' +
    '  }\n' +
    ']\n' +
    'Score 10=excellent/low risk, 0=critical gap/high risk. Always include exactly 4 options per question.';

  fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 3000,
      system: systemPrompt,
      messages: [{ role: 'user', content: 'Project data:\n\n' + ctx + '\n\nGenerate the 8 due diligence questions now.' }]
    })
  })
  .then(function(r){ return r.json(); })
  .then(function(data) {
    var raw = '';
    if (data.content && data.content[0]) raw = data.content[0].text || '';
    raw = raw.replace(/```json|```/g, '').trim();
    try {
      asmntState.questions = JSON.parse(raw);
    } catch(e) {
      asmntState.questions = [{
        q: 'Could not parse AI response. Please check the API connection and try again.',
        context: 'API returned: ' + raw.substring(0, 100),
        options: [{ letter:'A', text:'Understood — try again', why:'', score:5 }]
      }];
    }
    asmntState.loading  = false;
    asmntState.answers  = new Array(asmntState.questions.length).fill(null);
    asmntState.current  = 0;
    renderAsmntQuestion();
  })
  .catch(function(err) {
    asmntState.loading    = false;
    asmntState.questions  = [{ q: 'Failed to connect to AI: ' + err.message, context: '', options: [{ letter:'A', text:'OK', why:'', score:5 }] }];
    renderAsmntQuestion();
  });
}

function renderAsmntLoading(cat, msg) {
  var pane = document.getElementById('tab-assessment');
  if (!pane) return;
  pane.innerHTML =
    '<div class="asmnt-panel">' +
      '<div class="asmnt-topbar">' +
        '<span class="asmnt-icon">' + (cat ? cat.icon : '📋') + '</span>' +
        '<span class="asmnt-title">' + (cat ? cat.label : '') + ' Assessment</span>' +
        '<span class="asmnt-badge">AI-Powered</span>' +
      '</div>' +
      '<div class="asmnt-body" style="align-items:center;justify-content:center;min-height:200px;">' +
        '<div class="asmnt-loading">' +
          '<div class="ai-loading"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div></div>' +
          '<div class="asmnt-loading-txt">' + escHtml(msg || 'Loading…') + '</div>' +
        '</div>' +
      '</div>' +
    '</div>';
}

function renderAsmntQuestion() {
  var pane = document.getElementById('tab-assessment');
  if (!pane) return;
  var cat = CATEGORIES.find(function(c){ return c.key === asmntState.catKey; });
  var qs  = asmntState.questions;
  var idx = asmntState.current;
  if (!qs.length) return;
  if (idx >= qs.length) { renderAsmntScoring(); return; }

  var q      = qs[idx];
  var chosen = asmntState.answers[idx];
  var pct    = Math.round((idx / qs.length) * 100);

  var optionsHtml = (q.options || []).map(function(opt, oi) {
    var isSel = (chosen === oi);
    return '<div class="asmnt-opt' + (isSel ? ' selected' : '') + '" onclick="selectAsmntOption(' + oi + ')">' +
      '<div class="asmnt-opt-letter">' + escHtml(opt.letter) + '</div>' +
      '<div class="asmnt-opt-body">' +
        '<div class="asmnt-opt-text">' + escHtml(opt.text) + '</div>' +
        (opt.why ? '<div class="asmnt-opt-why">' + escHtml(opt.why) + '</div>' : '') +
      '</div>' +
      '<div class="asmnt-opt-score" style="color:' + (opt.score >= 7 ? '#2e7d4f' : opt.score >= 4 ? '#e07b20' : '#c0392b') + '">' +
        opt.score + '/10' +
      '</div>' +
    '</div>';
  }).join('');

  pane.innerHTML =
    '<div class="asmnt-panel">' +
      '<div class="asmnt-topbar">' +
        '<span class="asmnt-icon">' + (cat ? cat.icon : '📋') + '</span>' +
        '<span class="asmnt-title">' + (cat ? cat.label : '') + '</span>' +
        '<span class="asmnt-badge">' + (idx + 1) + ' / ' + qs.length + '</span>' +
      '</div>' +
      '<div class="asmnt-body">' +
        '<div class="asmnt-progress-row">' +
          '<div class="asmnt-progress-bar"><div class="asmnt-progress-fill" style="width:' + pct + '%"></div></div>' +
          '<span class="asmnt-progress-txt">' + pct + '%</span>' +
        '</div>' +
        '<div class="asmnt-q-block">' +
          '<div class="asmnt-q-num">Question ' + (idx + 1) + ' of ' + qs.length + '</div>' +
          '<div class="asmnt-q-text">' + escHtml(q.q) + '</div>' +
          (q.context ? '<div class="asmnt-q-context">' + escHtml(q.context) + '</div>' : '') +
        '</div>' +
        '<div class="asmnt-options">' + optionsHtml + '</div>' +
      '</div>' +
      '<div class="asmnt-footer">' +
        (idx > 0
          ? '<button class="asmnt-back-btn" onclick="asmntBack()">← Back</button>'
          : '<div></div>') +
        '<button class="asmnt-skip-btn" onclick="asmntSkip()">Skip</button>' +
        '<button class="asmnt-next-btn" onclick="asmntNext()" ' + (chosen === null ? 'disabled' : '') + '>' +
          (idx === qs.length - 1 ? 'Finish →' : 'Next →') +
        '</button>' +
      '</div>' +
    '</div>';
}

function selectAsmntOption(optIdx) {
  asmntState.answers[asmntState.current] = optIdx;
  renderAsmntQuestion();
  // Auto-scroll panel so footer is visible
  var panel = document.querySelector('.asmnt-panel');
  if (panel) setTimeout(function(){ panel.scrollTop = panel.scrollHeight; }, 50);
}

function asmntNext() {
  if (asmntState.answers[asmntState.current] === null) return;
  asmntState.current++;
  if (asmntState.current >= asmntState.questions.length) {
    renderAsmntScoring();
  } else {
    renderAsmntQuestion();
    var pane = document.getElementById('tab-assessment');
    if (pane) pane.scrollTop = 0;
  }
}

function asmntBack() {
  if (asmntState.current > 0) {
    asmntState.current--;
    renderAsmntQuestion();
    var pane = document.getElementById('tab-assessment');
    if (pane) pane.scrollTop = 0;
  }
}

function asmntSkip() {
  asmntState.answers[asmntState.current] = null; // null = skipped
  asmntState.current++;
  if (asmntState.current >= asmntState.questions.length) {
    renderAsmntScoring();
  } else {
    renderAsmntQuestion();
  }
}

function renderAsmntScoring() {
  var cat = CATEGORIES.find(function(c){ return c.key === asmntState.catKey; });
  renderAsmntLoading(cat, 'Calculating your risk score and generating rationale…');

  var qs = asmntState.questions;
  var summary = qs.map(function(q, i) {
    var chosen = asmntState.answers[i];
    var opt    = (chosen !== null && chosen !== undefined && q.options[chosen]) ? q.options[chosen] : null;
    return 'Q' + (i+1) + ': ' + q.q + '\n' +
      'Answer: ' + (opt ? '"' + opt.text + '" (score ' + opt.score + '/10)' : 'Skipped');
  }).join('\n\n');

  var ctx = buildAsmntContext(asmntState.catKey);

  var scoringPrompt =
    'You are a senior infrastructure investment analyst completing a due diligence risk assessment.\n\n' +
    'Based on the project data and Q&A answers below, calculate a final risk score 0–100 (100=excellent/investment-ready, 0=critical risk/not bankable).\n\n' +
    'Respond ONLY with valid JSON (no markdown):\n' +
    '{"score":<integer 0-100>,"label":"<Excellent|Good|Moderate|High Risk|Critical>","rationale":"<3–4 sentence plain English explanation referencing specific answers, values, and data points. Be specific — name actual numbers and flag specific risks found.>"}\n\n' +
    'Project data:\n' + ctx + '\n\n' +
    'Q&A Results:\n' + summary;

  fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 500,
      messages: [{ role: 'user', content: scoringPrompt }]
    })
  })
  .then(function(r){ return r.json(); })
  .then(function(data) {
    var raw = (data.content && data.content[0] && data.content[0].text) || '{}';
    raw = raw.replace(/```json|```/g, '').trim();
    var result = {};
    try { result = JSON.parse(raw); } catch(e) { result = { score: 50, label: 'Moderate', rationale: 'Score could not be parsed.' }; }
    asmntState.score     = parseInt(result.score) || 50;
    asmntState.label     = result.label || 'Moderate';
    asmntState.rationale = result.rationale || '';
    renderAsmntResult();
  })
  .catch(function(err) {
    asmntState.score     = 50;
    asmntState.label     = 'Unknown';
    asmntState.rationale = 'Scoring failed: ' + err.message;
    renderAsmntResult();
  });
}

function renderAsmntResult() {
  var pane = document.getElementById('tab-assessment');
  var cat  = CATEGORIES.find(function(c){ return c.key === asmntState.catKey; });
  if (!pane) return;
  var score      = asmntState.score;
  var scoreColor = score >= 70 ? '#2e7d4f' : score >= 40 ? '#e07b20' : '#c0392b';
  var ringCls    = score >= 70 ? '' : score >= 40 ? 'amber' : 'red';

  // Build Q&A review accordion
  var reviewHtml = asmntState.questions.map(function(q, i) {
    var chosen = asmntState.answers[i];
    var opt    = (chosen !== null && chosen !== undefined && q.options[chosen]) ? q.options[chosen] : null;
    var optColor = opt ? (opt.score >= 7 ? '#2e7d4f' : opt.score >= 4 ? '#e07b20' : '#c0392b') : '#555';
    return '<div style="padding:8px 0;border-top:1px solid rgba(255,255,255,0.05);">' +
      '<div style="font-size:10px;font-weight:700;color:#888;margin-bottom:4px;">Q' + (i+1) + '</div>' +
      '<div style="font-size:11px;color:#ccc;margin-bottom:4px;">' + escHtml(q.q) + '</div>' +
      '<div style="font-size:10px;font-weight:700;color:' + optColor + ';">' +
        (opt ? opt.letter + '. ' + escHtml(opt.text) : 'Skipped') +
      '</div>' +
    '</div>';
  }).join('');

  pane.innerHTML =
    '<div class="asmnt-panel">' +
      '<div class="asmnt-topbar">' +
        '<span class="asmnt-icon">' + (cat ? cat.icon : '📋') + '</span>' +
        '<span class="asmnt-title">' + (cat ? cat.label : '') + ' — Result</span>' +
        '<span class="asmnt-badge" style="color:' + scoreColor + '">' + escHtml(asmntState.label) + '</span>' +
      '</div>' +
      '<div class="asmnt-body">' +
        '<div class="asmnt-score-reveal">' +
          '<div class="asmnt-score-ring ' + ringCls + '" style="border-color:' + scoreColor + '">' +
            '<div class="asmnt-score-val" style="color:' + scoreColor + '">' + score + '</div>' +
            '<div class="asmnt-score-sub">/100</div>' +
          '</div>' +
          '<div class="asmnt-score-label" style="color:' + scoreColor + '">' + escHtml(asmntState.label) + '</div>' +
          '<div class="asmnt-score-rationale">' + escHtml(asmntState.rationale) + '</div>' +
          '<div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:6px;">' +
            '<button class="asmnt-save-btn" id="asmnt-save-btn" onclick="saveAsmntScore()">💾 Save Score</button>' +
            '<button class="asmnt-back-btn" style="padding:12px 18px;" onclick="startAiAssessment(\'' + escHtml(asmntState.catKey) + '\')">🔄 Retake</button>' +
          '</div>' +
        '</div>' +
        // Q&A review
        '<div style="background:rgba(255,255,255,0.02);border-radius:10px;padding:12px 14px;">' +
          '<div style="font-size:9px;font-weight:700;text-transform:uppercase;color:#555;letter-spacing:.4px;margin-bottom:4px;">Your Answers</div>' +
          reviewHtml +
        '</div>' +
      '</div>' +
    '</div>';
}

function saveAsmntScore() {
  if (!currentProjectId || !currentUserId || asmntState.score === null) return;
  var catKey = asmntState.catKey;
  var score  = asmntState.score;
  var update = { updated_at: new Date().toISOString() };
  update[catKey] = score;

  // Persist rationale + answers to tally_fields
  var tf = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  tf['asmnt_rationale_' + catKey] = asmntState.rationale;
  tf['asmnt_label_' + catKey]     = asmntState.label;
  tf['asmnt_answers_' + catKey]   = JSON.stringify(asmntState.answers);
  update.tally_fields = tf;
  if (currentProject) { currentProject[catKey] = score; currentProject.tally_fields = tf; }

  sb.from('projects').update(update).eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(res) {
      if (res && res.error) { alert('Save failed: ' + res.error.message); return; }
      // Recalculate overall
      var scoredKeys = ['score_permit','score_design','score_construct','score_procurement','score_contract','score_intercon','score_financial'];
      var scores = scoredKeys.map(function(k){ return currentProject[k]; }).filter(function(s){ return s != null; });
      var overall = scores.length ? Math.round(scores.reduce(function(a,b){ return a+b; }, 0) / scores.length) : null;
      var update2 = { score_overall: overall, updated_at: new Date().toISOString() };
      if (currentProject) currentProject.score_overall = overall;
      return sb.from('projects').update(update2).eq('id', currentProjectId).eq('user_id', currentUserId);
    })
    .then(function() {
      renderLeft(currentProject);
      var btn = document.getElementById('asmnt-save-btn');
      if (btn) { btn.textContent = '✓ Saved'; btn.style.background = '#2e7d4f'; btn.style.color = '#fff'; btn.onclick = null; }
      // Update tab label
      var tabBtn = document.getElementById('tab-btn-assessment');
      if (tabBtn) tabBtn.textContent = '✅ Assessment · ' + asmntState.score;
    });
}


/* ================================================================
   REGISTRY ENGINE
   Three registries: components | suppliers | equipment
   Stored in tally_fields: reg_components | reg_suppliers | reg_equipment
   ================================================================ */

/* ── TYPE DEFINITIONS ─────────────────────────────────────────── */

var REG_DEFS = {

  components: {
    storeKey: 'reg_components',
    miniCountId: 'comp-reg-count',
    miniWrapId:  'comp-reg-mini',
    itemsWrapId: 'comp-items-wrap',
    saveMsg:     'reg-save-msg-components',
    types: {
      module: { icon: '🔋', label: 'PV Module', color: '#2471a3', fields: [
        { lbl:'Manufacturer',           field:'mfr',          type:'text',    req:true },
        { lbl:'Model / Part Number',    field:'model',         type:'text',    req:true },
        { lbl:'Technology',             field:'tech',          type:'select',  opts:['','Mono PERC','TOPCon','HJT','CIGS','CdTe','Bifacial TOPCon','Other'] },
        { lbl:'Nominal Power (W)',      field:'watt',          type:'number',  req:true },
        { lbl:'Module Efficiency (%)',  field:'eff_pct',       type:'number' },
        { lbl:'Bifaciality Factor (%)', field:'bifac_pct',     type:'number' },
        { lbl:'Voc (V)',                field:'voc',           type:'number' },
        { lbl:'Vmp (V)',                field:'vmp',           type:'number' },
        { lbl:'Isc (A)',                field:'isc',           type:'number' },
        { lbl:'Imp (A)',                field:'imp',           type:'number' },
        { lbl:'Temp Coeff Pmax (%/°C)', field:'tempco',        type:'number' },
        { lbl:'NOCT (°C)',              field:'noct',          type:'number' },
        { lbl:'Length (mm)',            field:'length_mm',     type:'number' },
        { lbl:'Width (mm)',             field:'width_mm',      type:'number' },
        { lbl:'Weight (kg)',            field:'weight_kg',     type:'number' },
        { lbl:'Cells in Series',        field:'cells_s',       type:'number' },
        { lbl:'Cells in Parallel',      field:'cells_p',       type:'number' },
        { lbl:'Frames per Pallet',      field:'frames_pallet', type:'number' },
        { lbl:'Country of Manufacture', field:'country',       type:'text' },
        { lbl:'Product Warranty (yrs)', field:'prod_warranty', type:'number' },
        { lbl:'Linear Degradation (%)', field:'degrad_yr1',    type:'number' },
        { lbl:'Annual Degradation (%)', field:'degrad_ann',    type:'number' },
        { lbl:'IEC Certifications',     field:'iec_cert',      type:'text',    col:2 },
        { lbl:'Domestic Content Eligible', field:'dom_content', type:'toggle' },
        { lbl:'Datasheet URL',          field:'datasheet_url', type:'text',    col:2 },
      ]},
      inverter: { icon: '⚡', label: 'Inverter', color: '#e07b20', fields: [
        { lbl:'Manufacturer',           field:'mfr',           type:'text',   req:true },
        { lbl:'Model / Part Number',    field:'model',          type:'text',   req:true },
        { lbl:'Type',                   field:'type',           type:'select', opts:['','Central','String','Micro','Hybrid'] },
        { lbl:'AC Power Rating (kW)',   field:'kw_ac',          type:'number', req:true },
        { lbl:'DC Max Input (kW)',      field:'kw_dc_max',      type:'number' },
        { lbl:'Max DC Voltage (V)',     field:'vdc_max',        type:'number' },
        { lbl:'MPPT Range Low (V)',     field:'mppt_low',       type:'number' },
        { lbl:'MPPT Range High (V)',    field:'mppt_high',      type:'number' },
        { lbl:'Number of MPPTs',        field:'n_mppt',         type:'number' },
        { lbl:'Max Input Current (A)',  field:'idc_max',        type:'number' },
        { lbl:'AC Voltage (V)',         field:'vac',            type:'number' },
        { lbl:'Frequency (Hz)',         field:'freq_hz',        type:'select', opts:['','50','60'] },
        { lbl:'Peak Efficiency (%)',    field:'eff_peak',       type:'number' },
        { lbl:'CEC Efficiency (%)',     field:'eff_cec',        type:'number' },
        { lbl:'THD (%)',                field:'thd_pct',        type:'number' },
        { lbl:'Power Factor Range',     field:'pf_range',       type:'text' },
        { lbl:'Night Power (W)',        field:'night_power',    type:'number' },
        { lbl:'Weight (kg)',            field:'weight_kg',      type:'number' },
        { lbl:'IP Rating',              field:'ip_rating',      type:'text' },
        { lbl:'Operating Temp (°C)',    field:'temp_range',     type:'text' },
        { lbl:'Warranty (years)',       field:'warranty_yrs',   type:'number' },
        { lbl:'Datasheet URL',          field:'datasheet_url',  type:'text',   col:2 },
      ]},
      racking: { icon: '🔩', label: 'Racking / Structure', color: '#7d3c98', fields: [
        { lbl:'Manufacturer',           field:'mfr',            type:'text',   req:true },
        { lbl:'System Name / Model',    field:'model',          type:'text',   req:true },
        { lbl:'Type',                   field:'type',           type:'select', opts:['','Fixed Tilt','Single-Axis Tracker','Dual-Axis Tracker','Ballasted','Floating'] },
        { lbl:'Tilt Angle (°)',         field:'tilt_deg',       type:'number' },
        { lbl:'Max Module Rows',        field:'max_rows',       type:'number' },
        { lbl:'Max Wind Speed (m/s)',   field:'wind_ms',        type:'number' },
        { lbl:'Snow Load (kN/m²)',      field:'snow_load',      type:'number' },
        { lbl:'Ground Clearance (mm)',  field:'clearance_mm',   type:'number' },
        { lbl:'Material',               field:'material',       type:'select', opts:['','Hot-dip Galvanised Steel','Aluminium','Stainless Steel','Composite'] },
        { lbl:'Corrosion Category',     field:'corr_cat',       type:'select', opts:['','C1','C2','C3','C4','C5'] },
        { lbl:'Design Lifetime (yrs)',  field:'design_life',    type:'number' },
        { lbl:'Warranty (years)',       field:'warranty_yrs',   type:'number' },
        { lbl:'Modules per Table',      field:'mod_per_table',  type:'number' },
        { lbl:'Weight per Table (kg)',  field:'wt_per_table',   type:'number' },
        { lbl:'Certifications',         field:'certifications',  type:'text',   col:2 },
        { lbl:'Datasheet URL',          field:'datasheet_url',  type:'text',   col:2 },
      ]},
      tracker: { icon: '🌞', label: 'Solar Tracker', color: '#1e8449', fields: [
        { lbl:'Manufacturer',           field:'mfr',            type:'text',   req:true },
        { lbl:'Model',                  field:'model',          type:'text',   req:true },
        { lbl:'Type',                   field:'type',           type:'select', opts:['','Single-Axis','Dual-Axis','Seasonal Tilt'] },
        { lbl:'Drive Type',             field:'drive',          type:'select', opts:['','Slew Drive','Linear Actuator','Distributed Drive','Centralized Drive'] },
        { lbl:'Max Tracking Angle (°)', field:'max_angle',      type:'number' },
        { lbl:'Backtracking Algorithm', field:'backtracking',   type:'toggle' },
        { lbl:'Terrain Following',      field:'terrain_follow', type:'toggle' },
        { lbl:'Max Wind Speed (m/s)',   field:'wind_ms',        type:'number' },
        { lbl:'Snow Load (kN/m²)',      field:'snow_load',      type:'number' },
        { lbl:'Modules per Tracker',    field:'mod_per_tracker',type:'number' },
        { lbl:'Pile Type',              field:'pile_type',      type:'select', opts:['','Driven','Helical','Ground Screw','Concrete'] },
        { lbl:'Motor Power (W)',        field:'motor_w',        type:'number' },
        { lbl:'Communication Protocol',field:'comm_protocol',   type:'select', opts:['','RS-485','Modbus','CAN','Ethernet','Wireless'] },
        { lbl:'Warranty (years)',       field:'warranty_yrs',   type:'number' },
        { lbl:'Datasheet URL',          field:'datasheet_url',  type:'text',   col:2 },
      ]},
      transformer: { icon: '🔧', label: 'Transformer', color: '#117a65', fields: [
        { lbl:'Manufacturer',           field:'mfr',            type:'text',   req:true },
        { lbl:'Model / Tag',            field:'model',          type:'text',   req:true },
        { lbl:'Type',                   field:'type',           type:'select', opts:['','Oil-immersed','Dry-type','Cast Resin','Pad-mounted'] },
        { lbl:'Rating (kVA)',           field:'kva',            type:'number', req:true },
        { lbl:'Primary Voltage (kV)',   field:'hv_kv',          type:'number' },
        { lbl:'Secondary Voltage (V)',  field:'lv_v',           type:'number' },
        { lbl:'Vector Group',           field:'vector_group',   type:'text' },
        { lbl:'Cooling Type',           field:'cooling',        type:'select', opts:['','ONAN','ONAF','OFAF','AN','AF'] },
        { lbl:'Impedance (%)',          field:'impedance_pct',  type:'number' },
        { lbl:'No-Load Losses (W)',     field:'no_load_loss',   type:'number' },
        { lbl:'Load Losses (W)',        field:'load_loss',      type:'number' },
        { lbl:'IP Rating',              field:'ip_rating',      type:'text' },
        { lbl:'Weight Oil (kg)',        field:'wt_oil',         type:'number' },
        { lbl:'Weight Total (kg)',      field:'wt_total',       type:'number' },
        { lbl:'Insulation Class',       field:'insul_class',    type:'select', opts:['','A','B','F','H'] },
        { lbl:'Standards',              field:'standards',      type:'text',   col:2 },
        { lbl:'Datasheet URL',          field:'datasheet_url',  type:'text',   col:2 },
      ]},
      dc_cable: { icon: '🔴', label: 'DC Cable', color: '#c0392b', fields: [
        { lbl:'Manufacturer',           field:'mfr',            type:'text',   req:true },
        { lbl:'Product Name',           field:'model',          type:'text',   req:true },
        { lbl:'Conductor Size (mm²)',   field:'size_mm2',       type:'number', req:true },
        { lbl:'Rated Voltage (V)',      field:'rated_v',        type:'number' },
        { lbl:'Conductor Material',     field:'conductor',      type:'select', opts:['','Copper','Tinned Copper','Aluminium'] },
        { lbl:'Insulation Type',        field:'insulation',     type:'select', opts:['','XLPE','EPR','PVC','Silicone'] },
        { lbl:'Sheath Material',        field:'sheath',         type:'text' },
        { lbl:'Max Current (A)',        field:'max_a',          type:'number' },
        { lbl:'Temp Range (°C)',        field:'temp_range',     type:'text' },
        { lbl:'UV Resistant',           field:'uv_resistant',   type:'toggle' },
        { lbl:'Standard',               field:'standard',       type:'text' },
        { lbl:'Datasheet URL',          field:'datasheet_url',  type:'text',   col:2 },
      ]},
      ac_cable: { icon: '🟡', label: 'AC Cable', color: '#d4ac0d', fields: [
        { lbl:'Manufacturer',           field:'mfr',            type:'text',   req:true },
        { lbl:'Product Name',           field:'model',          type:'text',   req:true },
        { lbl:'Voltage Rating (kV)',    field:'rated_kv',       type:'number', req:true },
        { lbl:'Conductor Size (mm²)',   field:'size_mm2',       type:'number' },
        { lbl:'Number of Cores',        field:'cores',          type:'select', opts:['','1','3','4'] },
        { lbl:'Conductor Material',     field:'conductor',      type:'select', opts:['','Copper','Aluminium'] },
        { lbl:'Insulation',             field:'insulation',     type:'select', opts:['','XLPE','EPR','PVC'] },
        { lbl:'Armoring',               field:'armoring',       type:'select', opts:['','None','SWA','STA','AWA'] },
        { lbl:'Max Current (A)',        field:'max_a',          type:'number' },
        { lbl:'Short Circuit Rating (kA)', field:'sc_ka',      type:'number' },
        { lbl:'Standard',               field:'standard',       type:'text' },
        { lbl:'Datasheet URL',          field:'datasheet_url',  type:'text',   col:2 },
      ]},
      piles: { icon: '🪝', label: 'Piles / Foundation', color: '#6c3483', fields: [
        { lbl:'Manufacturer / Supplier',field:'mfr',            type:'text',   req:true },
        { lbl:'Product Name',           field:'model',          type:'text',   req:true },
        { lbl:'Pile Type',              field:'pile_type',      type:'select', opts:['','Driven Steel','Helical','Ground Screw','Concrete Cast In-Situ','Precast Concrete'] },
        { lbl:'Material',               field:'material',       type:'select', opts:['','Hot-rolled Steel','Cold-formed Steel','Galvanised Steel','Concrete'] },
        { lbl:'Cross Section (mm)',     field:'cross_section',  type:'text' },
        { lbl:'Standard Length (m)',    field:'length_m',       type:'number' },
        { lbl:'Max Penetration (m)',    field:'max_pen_m',      type:'number' },
        { lbl:'Load Capacity (kN)',     field:'load_kn',        type:'number' },
        { lbl:'Corrosion Protection',   field:'corr_prot',      type:'text' },
        { lbl:'Soil Class Suitability', field:'soil_class',     type:'text' },
        { lbl:'Standard',               field:'standard',       type:'text' },
        { lbl:'Datasheet URL',          field:'datasheet_url',  type:'text',   col:2 },
      ]},
    }
  },

  suppliers: {
    storeKey: 'reg_suppliers',
    miniCountId: 'supplier-reg-count',
    miniWrapId:  'supplier-reg-mini',
    itemsWrapId: 'supplier-items-wrap',
    saveMsg:     'reg-save-msg-suppliers',
    types: {
      epc:             { icon: '🏗️', label: 'EPC Contractor',    color: '#c0392b', fields: REG_COMPANY_FIELDS() },
      module_supplier: { icon: '🔋', label: 'Module Supplier',    color: '#2471a3', fields: REG_COMPANY_FIELDS() },
      inverter_supplier:{ icon: '⚡', label: 'Inverter Supplier', color: '#e07b20', fields: REG_COMPANY_FIELDS() },
      tracker_supplier:{ icon: '🌞', label: 'Tracker Supplier',   color: '#1e8449', fields: REG_COMPANY_FIELDS() },
      bess_supplier:   { icon: '🔌', label: 'BESS Supplier',      color: '#117a65', fields: REG_COMPANY_FIELDS() },
      cable_supplier:  { icon: '🔴', label: 'Cable Supplier',     color: '#d4ac0d', fields: REG_COMPANY_FIELDS() },
      design_firm:     { icon: '📐', label: 'Design Firm',        color: '#7d3c98', fields: REG_COMPANY_FIELDS() },
      law_firm:        { icon: '⚖️', label: 'Law Firm',           color: '#1a5276', fields: REG_COMPANY_FIELDS() },
      offtaker:        { icon: '💡', label: 'Offtaker / Utility', color: '#117a65', fields: REG_COMPANY_FIELDS() },
      lender:          { icon: '🏦', label: 'Lender',             color: '#1a5276', fields: REG_COMPANY_FIELDS() },
      tax_equity:      { icon: '💰', label: 'Tax Equity Investor',color: '#7d3c98', fields: REG_COMPANY_FIELDS() },
      owner_engineer:  { icon: '🔬', label: "Owner's Engineer",   color: '#c0392b', fields: REG_COMPANY_FIELDS() },
      other_company:   { icon: '🏢', label: 'Other Company',      color: '#5a6474', fields: REG_COMPANY_FIELDS() },
    }
  },

  equipment: {
    storeKey: 'reg_equipment',
    miniCountId: 'equip-reg-count',
    miniWrapId:  'equip-reg-mini',
    itemsWrapId: 'equip-items-wrap',
    saveMsg:     'reg-save-msg-equipment',
    types: {
      dozer:         { icon: '🚜', label: 'Bulldozer',              color: '#d35400', fields: [
        { lbl:'Make / Brand',         field:'mfr',          type:'text',   req:true },
        { lbl:'Model',                field:'model',         type:'text',   req:true },
        { lbl:'Operating Weight (t)', field:'weight_t',      type:'number' },
        { lbl:'Blade Capacity (m³)',  field:'blade_m3',      type:'number' },
        { lbl:'Engine Power (kW)',    field:'power_kw',      type:'number' },
        { lbl:'Track Type',           field:'track',         type:'select', opts:['','Steel Tracks','Rubber Tracks'] },
        { lbl:'Fuel Type',            field:'fuel',          type:'select', opts:['','Diesel','Electric','Hybrid'] },
        { lbl:'GPS Grade Control',    field:'gps_grade',     type:'toggle' },
        { lbl:'Quantity on Site',     field:'qty',           type:'number' },
        { lbl:'Ownership',            field:'ownership',     type:'select', opts:['','Owned','Rented','Contractor-supplied'] },
      ]},
      excavator:     { icon: '⛏️', label: 'Excavator',              color: '#d35400', fields: [
        { lbl:'Make / Brand',         field:'mfr',          type:'text',   req:true },
        { lbl:'Model',                field:'model',         type:'text',   req:true },
        { lbl:'Operating Weight (t)', field:'weight_t',      type:'number' },
        { lbl:'Bucket Capacity (m³)', field:'bucket_m3',     type:'number' },
        { lbl:'Max Dig Depth (m)',    field:'dig_depth_m',   type:'number' },
        { lbl:'Arm Reach (m)',        field:'arm_reach_m',   type:'number' },
        { lbl:'Engine Power (kW)',    field:'power_kw',      type:'number' },
        { lbl:'Fuel Type',            field:'fuel',          type:'select', opts:['','Diesel','Electric','Hybrid'] },
        { lbl:'Quantity on Site',     field:'qty',           type:'number' },
        { lbl:'Ownership',            field:'ownership',     type:'select', opts:['','Owned','Rented','Contractor-supplied'] },
      ]},
      pile_driver:   { icon: '🔨', label: 'Pile Driver',             color: '#1a5276', fields: [
        { lbl:'Make / Brand',         field:'mfr',          type:'text',   req:true },
        { lbl:'Model',                field:'model',         type:'text',   req:true },
        { lbl:'Drive Method',         field:'method',        type:'select', opts:['','Hydraulic Impact','Vibratory','Hydraulic Press','Rotary'] },
        { lbl:'Max Hammer Energy (J)',field:'energy_j',      type:'number' },
        { lbl:'Max Pile Length (m)',  field:'max_pile_m',    type:'number' },
        { lbl:'Max Pile Dia (mm)',    field:'max_dia_mm',    type:'number' },
        { lbl:'Driving Rate (piles/hr)', field:'rate_hr',   type:'number' },
        { lbl:'GPS Positioning',      field:'gps',           type:'toggle' },
        { lbl:'Quantity on Site',     field:'qty',           type:'number' },
        { lbl:'Ownership',            field:'ownership',     type:'select', opts:['','Owned','Rented','Contractor-supplied'] },
      ]},
      robot_installer:{ icon: '🤖', label: 'Robot Module Installer', color: '#1e8449', fields: [
        { lbl:'Manufacturer',         field:'mfr',          type:'text',   req:true },
        { lbl:'Model',                field:'model',         type:'text',   req:true },
        { lbl:'Install Rate (mod/hr)',field:'rate_mod_hr',   type:'number' },
        { lbl:'Module Compatibility', field:'mod_compat',    type:'text' },
        { lbl:'Tracker Compatible',   field:'tracker_compat',type:'toggle' },
        { lbl:'Lifting Capacity (kg)',field:'lift_kg',       type:'number' },
        { lbl:'Navigation',           field:'nav',           type:'select', opts:['','GPS + Vision','LiDAR','Camera Only','Manual Assist'] },
        { lbl:'Crew Required',        field:'crew',          type:'number' },
        { lbl:'Quantity on Site',     field:'qty',           type:'number' },
        { lbl:'Ownership',            field:'ownership',     type:'select', opts:['','Owned','Rented','Contractor-supplied'] },
      ]},
      crane:         { icon: '🏗️', label: 'Crane',                  color: '#7d3c98', fields: [
        { lbl:'Make / Brand',         field:'mfr',          type:'text',   req:true },
        { lbl:'Model',                field:'model',         type:'text',   req:true },
        { lbl:'Type',                 field:'type',          type:'select', opts:['','Mobile Crane','Tower Crane','Crawler Crane','All-Terrain'] },
        { lbl:'Max Lift Capacity (t)',field:'max_lift_t',    type:'number' },
        { lbl:'Boom Length (m)',      field:'boom_m',        type:'number' },
        { lbl:'Quantity on Site',     field:'qty',           type:'number' },
        { lbl:'Ownership',            field:'ownership',     type:'select', opts:['','Owned','Rented','Contractor-supplied'] },
      ]},
      cable_trencher:{ icon: '⚙️', label: 'Cable Trencher',          color: '#117a65', fields: [
        { lbl:'Make / Brand',         field:'mfr',          type:'text',   req:true },
        { lbl:'Model',                field:'model',         type:'text',   req:true },
        { lbl:'Trench Type',          field:'method',        type:'select', opts:['','Chain Trencher','Wheel Trencher','Micro-trencher','Plough'] },
        { lbl:'Max Trench Depth (m)', field:'depth_m',       type:'number' },
        { lbl:'Max Trench Width (mm)',field:'width_mm',      type:'number' },
        { lbl:'Production Rate (m/hr)',field:'rate_m_hr',    type:'number' },
        { lbl:'Engine Power (kW)',    field:'power_kw',      type:'number' },
        { lbl:'Quantity on Site',     field:'qty',           type:'number' },
        { lbl:'Ownership',            field:'ownership',     type:'select', opts:['','Owned','Rented','Contractor-supplied'] },
      ]},
      forklift:      { icon: '🏋️', label: 'Telehandler / Forklift', color: '#c0392b', fields: [
        { lbl:'Make / Brand',         field:'mfr',          type:'text',   req:true },
        { lbl:'Model',                field:'model',         type:'text',   req:true },
        { lbl:'Max Lift Capacity (kg)',field:'lift_kg',      type:'number' },
        { lbl:'Max Lift Height (m)',  field:'lift_m',        type:'number' },
        { lbl:'Reach (m)',            field:'reach_m',       type:'number' },
        { lbl:'Fuel Type',            field:'fuel',          type:'select', opts:['','Diesel','Electric','LPG'] },
        { lbl:'Quantity on Site',     field:'qty',           type:'number' },
        { lbl:'Ownership',            field:'ownership',     type:'select', opts:['','Owned','Rented','Contractor-supplied'] },
      ]},
      generator:     { icon: '⚡', label: 'Generator Set',           color: '#d4ac0d', fields: [
        { lbl:'Make / Brand',         field:'mfr',          type:'text',   req:true },
        { lbl:'Model',                field:'model',         type:'text',   req:true },
        { lbl:'Rated Power (kVA)',    field:'kva',           type:'number' },
        { lbl:'Fuel Type',            field:'fuel',          type:'select', opts:['','Diesel','Gas','HVO','Hybrid'] },
        { lbl:'Tank Capacity (L)',    field:'tank_l',        type:'number' },
        { lbl:'Fuel Consumption (L/hr)', field:'fuel_lhr',  type:'number' },
        { lbl:'Quantity on Site',     field:'qty',           type:'number' },
        { lbl:'Ownership',            field:'ownership',     type:'select', opts:['','Owned','Rented','Contractor-supplied'] },
      ]},
      other_equip:   { icon: '📦', label: 'Other Equipment',         color: '#5a6474', fields: [
        { lbl:'Description',          field:'model',         type:'text',   req:true, col:2 },
        { lbl:'Make / Brand',         field:'mfr',           type:'text' },
        { lbl:'Quantity on Site',     field:'qty',           type:'number' },
        { lbl:'Engine Power (kW)',    field:'power_kw',      type:'number' },
        { lbl:'Ownership',            field:'ownership',     type:'select', opts:['','Owned','Rented','Contractor-supplied'] },
        { lbl:'Notes',                field:'notes',         type:'text',   col:2 },
      ]},
    }
  }
};

/* Company fields reused for all supplier types */
function REG_COMPANY_FIELDS() {
  return [
    { lbl:'Company Name',             field:'name',          type:'text',   req:true, col:2 },
    { lbl:'Country',                  field:'country',       type:'text',   req:true },
    { lbl:'Website',                  field:'website',       type:'text' },
    { lbl:'Primary Contact Name',     field:'contact_name',  type:'text' },
    { lbl:'Contact Email',            field:'contact_email', type:'text' },
    { lbl:'Contact Phone',            field:'contact_phone', type:'text' },
    { lbl:'Credit Rating / Standing', field:'credit_rating', type:'select', opts:['','AAA','AA','A','BBB','BB','B','Not Rated','Public Entity'] },
    { lbl:'Years in Business',        field:'years_biz',     type:'number' },
    { lbl:'Parent Company',           field:'parent_co',     type:'text' },
    { lbl:'Certifications / Quals',   field:'certs',         type:'text',   col:2 },
    { lbl:'Notes',                    field:'notes',         type:'text',   col:2 },
  ];
}

/* ── STORAGE HELPERS ──────────────────────────────────────────── */
function getRegistry(regKey) {
  var def = REG_DEFS[regKey]; if (!def) return [];
  var tf  = (currentProject && currentProject.tally_fields) || {};
  try { return JSON.parse(tf[def.storeKey] || '[]'); } catch(e) { return []; }
}

function setRegistry(regKey, items, cb) {
  var def = REG_DEFS[regKey]; if (!def || !currentProjectId || !currentUserId) return;
  var tf  = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  tf[def.storeKey] = JSON.stringify(items);
  if (currentProject) currentProject.tally_fields = tf;
  sb.from('projects').update({ tally_fields: tf, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(res) { if (cb) cb(res); });
}

function regUid() { return 'reg_' + Date.now() + '_' + Math.floor(Math.random()*9999); }

/* ── PANEL OPEN / CLOSE ───────────────────────────────────────── */
function openRegPanel(regKey) {
  // Close other panels
  ['components','suppliers','equipment'].forEach(function(k) {
    document.getElementById('reg-panel-' + k).classList.remove('open');
  });
  document.getElementById('main-overview').style.display = 'none';
  document.getElementById('cat-panel').classList.remove('open');
  document.getElementById('doc-panel').classList.remove('open');

  var panel = document.getElementById('reg-panel-' + regKey);
  panel.classList.add('open');
  renderRegPanel(regKey);
}

function closeRegPanel(regKey) {
  document.getElementById('reg-panel-' + regKey).classList.remove('open');
  document.getElementById('main-overview').style.display = 'flex';
}

/* ── RENDER PANEL ─────────────────────────────────────────────── */
function renderRegPanel(regKey) {
  var def   = REG_DEFS[regKey];
  var items = getRegistry(regKey);
  var wrap  = document.getElementById(def.itemsWrapId);

  // Build type picker
  var menu = document.getElementById('reg-type-menu-' + regKey);
  if (menu && !menu.hasAttribute('data-built')) {
    menu.innerHTML = Object.keys(def.types).map(function(t) {
      var td = def.types[t];
      return '<button class="reg-type-chip" onclick="addRegItem(\'' + regKey + '\',\'' + t + '\')">' +
        '<span class="reg-type-chip-icon">' + td.icon + '</span>' + td.label + '</button>';
    }).join('');
    menu.setAttribute('data-built', '1');
  }

  if (!wrap) return;
  if (!items.length) {
    wrap.innerHTML = '<div class="reg-empty-state">' +
      '<div class="reg-empty-state-icon">' + { components:'⚙️', suppliers:'🏢', equipment:'🚜' }[regKey] + '</div>' +
      '<div class="reg-empty-state-msg">No ' + regKey + ' added yet.<br>Click the button below to get started.</div>' +
    '</div>';
  } else {
    wrap.innerHTML = items.map(function(item) { return buildRegCard(regKey, item); }).join('');
  }
  refreshRegMinis(regKey, items);
}

/* ── BUILD ONE REGISTRY CARD ──────────────────────────────────── */
function buildRegCard(regKey, item) {
  var def    = REG_DEFS[regKey];
  var td     = def.types[item.type] || Object.values(def.types)[0];
  var fields = item.fields || {};
  // Display name: first required field, or type label
  var nameField = td.fields.find(function(f){ return f.req; });
  var name  = nameField ? (fields[nameField.field] || td.label) : td.label;

  var html = '<div class="reg-item-card" id="reg-card-' + item.id + '">' +
    '<div class="reg-item-hdr" style="border-left: 3px solid ' + td.color + ';">' +
      '<span class="reg-item-icon">' + td.icon + '</span>' +
      '<div class="reg-item-name-wrap">' +
        '<div class="reg-item-name" id="regname-' + item.id + '">' + escHtml(name) + '</div>' +
        '<div class="reg-item-type">' + td.label + '</div>' +
      '</div>' +
      '<button class="reg-item-toggle-btn" onclick="toggleRegCard(\'' + item.id + '\')" id="regtoggle-' + item.id + '">▼</button>' +
      '<button class="reg-item-del" onclick="deleteRegItem(\'' + regKey + '\',\'' + item.id + '\')">✕</button>' +
    '</div>' +
    '<div class="reg-item-body" id="regbody-' + item.id + '">' +
    '<div class="spec-grid">';

  td.fields.forEach(function(f) {
    var val     = fields[f.field] !== undefined ? fields[f.field] : '';
    var full    = f.col === 2 ? ' full' : '';
    var reqStar = f.req ? '<span class="req">*</span>' : '';
    html += '<div class="spec-field' + full + '">' +
      '<label class="spec-lbl">' + f.lbl + reqStar + '</label>';

    if (f.type === 'toggle') {
      var checked = val === true || val === 'true' || val === 'Y';
      html += '<div class="spec-toggle-row">' +
        '<label class="spec-toggle"><input type="checkbox" data-reg="' + item.id + '" data-field="' + f.field + '" data-type="toggle"' + (checked ? ' checked' : '') + ' onchange="onRegChange(this)"/><span class="spec-toggle-slider"></span></label>' +
        '<span class="spec-toggle-lbl">' + (checked ? 'Yes' : 'No') + '</span>' +
      '</div>';
    } else if (f.type === 'select') {
      html += '<select class="spec-select" data-reg="' + item.id + '" data-field="' + f.field + '" onchange="onRegChange(this)">';
      (f.opts || []).forEach(function(o) {
        html += '<option value="' + escHtml(o) + '"' + (String(val) === o ? ' selected' : '') + '>' + escHtml(o || '— Select —') + '</option>';
      });
      html += '</select>';
    } else {
      html += '<input class="spec-input" type="' + f.type + '" data-reg="' + item.id + '" data-field="' + f.field + '" value="' + escHtml(String(val)) + '" placeholder="Enter value" oninput="onRegChange(this)"/>';
    }
    html += '</div>'; // spec-field
  });

  html += '</div></div></div>'; // spec-grid + reg-item-body + reg-item-card
  return html;
}

/* ── INTERACTIONS ─────────────────────────────────────────────── */
function toggleRegTypePicker(regKey) {
  var menu = document.getElementById('reg-type-menu-' + regKey);
  if (menu) menu.classList.toggle('open');
}

function toggleRegCard(itemId) {
  var body   = document.getElementById('regbody-' + itemId);
  var toggle = document.getElementById('regtoggle-' + itemId);
  if (!body) return;
  var collapsed = body.style.display === 'none';
  body.style.display = collapsed ? '' : 'none';
  if (toggle) toggle.textContent = collapsed ? '▼' : '▶';
}

function addRegItem(regKey, type) {
  var menu = document.getElementById('reg-type-menu-' + regKey);
  if (menu) menu.classList.remove('open');
  var items = getRegistry(regKey);
  items.push({ id: regUid(), type: type, fields: {} });
  setRegistry(regKey, items, function() { renderRegPanel(regKey); });
}

function deleteRegItem(regKey, itemId) {
  if (!confirm('Remove this item?')) return;
  var items = getRegistry(regKey).filter(function(i){ return i.id !== itemId; });
  setRegistry(regKey, items, function() { renderRegPanel(regKey); });
}

function onRegChange(el) {
  if (el.type === 'checkbox') {
    var row = el.closest('.spec-toggle-row');
    if (row) { var lbl = row.querySelector('.spec-toggle-lbl'); if (lbl) lbl.textContent = el.checked ? 'Yes' : 'No'; }
  }
  // Live update card name if it's the first required field
  var itemId  = el.getAttribute('data-reg');
  var field   = el.getAttribute('data-field');
  if (itemId && field) {
    var nameEl = document.getElementById('regname-' + itemId);
    if (nameEl && el.value && el.value.trim()) {
      // Only update if this field is the primary name field
      var regKey = el.closest('.reg-panel') && el.closest('.reg-panel').id.replace('reg-panel-','');
      if (regKey) {
        var items = getRegistry(regKey);
        var item  = items.find(function(i){ return i.id === itemId; });
        var def   = REG_DEFS[regKey];
        var td    = def && item && def.types[item.type];
        if (td) {
          var nameField = td.fields.find(function(f){ return f.req; });
          if (nameField && nameField.field === field) nameEl.textContent = el.value.trim();
        }
      }
    }
  }
}

function saveRegistry(regKey) {
  var def   = REG_DEFS[regKey];
  var items = getRegistry(regKey);

  // Harvest DOM values
  document.querySelectorAll('[data-reg]').forEach(function(el) {
    var itemId = el.getAttribute('data-reg');
    var field  = el.getAttribute('data-field');
    var item   = items.find(function(i){ return i.id === itemId; });
    if (!item || !field) return;
    if (!item.fields) item.fields = {};
    item.fields[field] = el.type === 'checkbox' ? el.checked : el.value.trim();
  });

  setRegistry(regKey, items, function(res) {
    if (res && res.error) { alert('Save failed: ' + res.error.message); return; }
    var msg = document.getElementById(def.saveMsg);
    if (msg) { msg.classList.add('show'); setTimeout(function(){ msg.classList.remove('show'); }, 2500); }
    refreshRegMinis(regKey, items);
  });
}

/* ── MINI LISTS IN RIGHT SIDEBAR ─────────────────────────────── */
function refreshRegMinis(regKey, items) {
  var def   = REG_DEFS[regKey];
  if (!def) return;
  var count = document.getElementById(def.miniCountId);
  var wrap  = document.getElementById(def.miniWrapId);
  if (count) count.textContent = items.length;
  if (!wrap) return;

  var show = items.slice(0, 3);
  if (!show.length) {
    wrap.innerHTML = '<div class="reg-empty">None added yet</div>';
    return;
  }
  wrap.innerHTML = show.map(function(item) {
    var td = def.types[item.type] || {};
    var nameField = td.fields && td.fields.find(function(f){ return f.req; });
    var name = nameField ? ((item.fields || {})[nameField.field] || td.label || item.type) : (td.label || item.type);
    return '<div class="reg-mini-item">' +
      '<span class="reg-mini-icon">' + (td.icon || '📦') + '</span>' +
      '<span class="reg-mini-name">' + escHtml(name) + '</span>' +
      '<span class="reg-mini-tag">' + escHtml((td.label || item.type).substring(0,8)) + '</span>' +
    '</div>';
  }).join('');
  if (items.length > 3) {
    wrap.innerHTML += '<div class="reg-empty">+' + (items.length - 3) + ' more</div>';
  }
}

/* Called on project load to populate mini lists */
function initRegistries() {
  ['components','suppliers','equipment'].forEach(function(k) { refreshRegMinis(k, getRegistry(k)); });
}

/* ── REGISTRY DROPDOWN HELPERS (used by Design/Construction) ──── */
/* Returns [{id, label}] for populating selects in category panels */
function getRegOptions(regKey, filterTypes) {
  var items = getRegistry(regKey);
  if (filterTypes && filterTypes.length) {
    items = items.filter(function(i){ return filterTypes.indexOf(i.type) !== -1; });
  }
  return items.map(function(item) {
    var def = REG_DEFS[regKey];
    var td  = def && def.types[item.type] || {};
    var nameField = td.fields && td.fields.find(function(f){ return f.req; });
    var name = nameField ? ((item.fields || {})[nameField.field] || td.label) : (td.label || item.type);
    return { id: item.id, label: (td.icon || '') + ' ' + name, type: item.type, typeLabel: td.label || item.type };
  });
}

function buildRegSelect(regKey, filterTypes, fieldId, currentVal, placeholder) {
  var opts = getRegOptions(regKey, filterTypes);
  var html = '<select class="spec-select" id="' + fieldId + '" data-field="' + fieldId + '">';
  html += '<option value="">' + (placeholder || '— Select from registry —') + '</option>';
  opts.forEach(function(o) {
    html += '<option value="' + o.id + '"' + (currentVal === o.id ? ' selected' : '') + '>' + escHtml(o.label) + '</option>';
  });
  html += '</select>';
  return html;
}


function closeTallyForm() {}
function startPolling() {}
function stopPolling() {}

function reloadProject() {
  if (!currentProjectId || !currentUserId) return;
  sb.from("projects").select("*").eq("id", currentProjectId).eq("user_id", currentUserId).single()
    .then(function(res) {
      if (res.error || !res.data) return;
      currentProject = res.data;
      renderLeft(res.data);
      loadTlDates(res.data);
      // If a cat panel is open, refresh its score band
      if (activeCatKey) {
        var score = currentProject[activeCatKey];
        var color = scoreColor(score);
        var pct   = score != null ? Math.min(100, Math.max(0, score)) : 0;
        var circle = document.querySelector(".cp-score-circle");
        var numEl  = document.querySelector(".cp-score-num");
        var barEl  = document.querySelector(".cp-bar-fill");
        var descEl = document.querySelector(".cp-score-desc");
        if (circle) circle.style.borderColor = color;
        if (numEl)  { numEl.style.color = color; numEl.textContent = score != null ? score : "N/A"; }
        if (barEl)  { barEl.style.width = pct + "%"; barEl.style.background = color; }
        if (descEl) descEl.textContent = score == null ? "Not yet scored" : score >= 70 ? "Good risk profile" : score >= 40 ? "Moderate risk" : "High risk";
      }
    });
}

/* ---- TIMELINE ---- */
function updateTimeline(project) {
  var permitScore   = project.score_permit;
  var designScore   = project.score_design;
  var constructScore = project.score_construct;
  var green  = parseInt(ADMIN_CONFIG["timeline_permit_green"]  || "70");
  var yellow = parseInt(ADMIN_CONFIG["timeline_permit_yellow"] || "40");

  function tlStatus(score) {
    if (score == null) return "grey";
    if (score >= green)  return "green";
    if (score >= yellow) return "yellow";
    return "red";
  }

  function tlLabel(score, stage) {
    if (score == null) return "Not started";
    if (score >= green)  return stage + " complete";
    if (score >= yellow) return "In progress";
    return "Action required";
  }

  setTl("permit",   tlStatus(permitScore),    tlLabel(permitScore,    "Permitting"));
  setTl("design",   tlStatus(designScore),    tlLabel(designScore,    "Engineering"));
  setTl("construct",tlStatus(constructScore), tlLabel(constructScore, "Construction"));

  // COD: green only if all three are green
  var allGreen = tlStatus(permitScore) === "green" && tlStatus(designScore) === "green" && tlStatus(constructScore) === "green";
  var anyStarted = permitScore != null || designScore != null || constructScore != null;
  setTl("cod", allGreen ? "green" : anyStarted ? "grey" : "grey", allGreen ? "Target reached" : "Pending");
}

function setTl(id, status, label) {
  var dot = document.getElementById("tl-" + id);
  var lbl = document.getElementById("tl-" + id + "-status");
  if (dot) {
    dot.className = "tl-dot " + status;
  }
  if (lbl) lbl.textContent = label;
}

function buildCatTimeline(catKey) {
  var milestones = CAT_MILESTONES[catKey] || [];
  if (!milestones.length) return '';
  var steps = milestones.map(function(m, i) {
    var last = i === milestones.length - 1;
    var pb = last ? ' style="padding-bottom:0;"' : '';
    return '<div class="tl-step">' +
      '<div class="tl-dot-wrap"><div class="tl-dot grey" id="ctld-' + m.key + '"></div></div>' +
      '<div class="tl-info"' + pb + '>' +
        '<div class="tl-label" style="font-size:10px;">' + m.label + '</div>' +
        '<div style="display:flex;align-items:center;gap:5px;margin-top:3px;">' +
          '<select class="ctld-status" data-key="' + m.key + '" onchange="saveCatMilestone(\'' + m.key + '\',this.value,document.getElementById(\'' + 'ctld-date-' + m.key + '\').value)" style="font-size:9px;padding:2px 5px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:5px;color:#aaa;font-family:Inter,sans-serif;outline:none;cursor:pointer;">' +
            '<option value="">Not started</option>' +
            '<option value="in_progress">In progress</option>' +
            '<option value="complete">Complete</option>' +
          '</select>' +
          '<input class="ctld-date" id="ctld-date-' + m.key + '" data-key="' + m.key + '" type="date" onchange="saveCatMilestone(\'' + m.key + '\',document.querySelector(\'[data-key=' + m.key + '].ctld-status\').value,this.value)" style="font-size:9px;padding:2px 5px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:5px;color:#aaa;font-family:Inter,sans-serif;outline:none;cursor:pointer;"/>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');
  return '<div class="cp-fields-card">' +
    '<div class="cp-fields-hdr"><span class="cp-fields-title">Milestones</span></div>' +
    '<div style="padding:10px 16px;"><div class="timeline-body" style="padding:0;">' +
    steps +
    '</div></div></div>';
}

/* ---- CATEGORY MILESTONES ---- */
function saveCatMilestone(key, status, date) {
  if (!currentProjectId || !currentUserId) return;
  var tally = Object.assign({}, currentProject.tally_fields || {});
  tally['ms_status_' + key] = status || '';
  tally['ms_date_'   + key] = date   || '';
  currentProject.tally_fields = tally;
  // Update dot colour
  var dot = document.getElementById('ctld-' + key);
  if (dot) {
    dot.className = 'tl-dot ' + (status === 'complete' ? 'green' : status === 'in_progress' ? 'yellow' : 'grey');
  }
  sb.from('projects').update({ tally_fields: tally, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(res) { if (res.error) console.error('Milestone save failed:', res.error.message); });
}

function loadCatMilestones(catKey, project) {
  var milestones = CAT_MILESTONES[catKey] || [];
  var tally = project.tally_fields || {};
  milestones.forEach(function(m) {
    var statusEl = document.querySelector('[data-key="' + m.key + '"].ctld-status');
    var dateEl   = document.getElementById('ctld-date-' + m.key);
    var dot      = document.getElementById('ctld-' + m.key);
    var status   = tally['ms_status_' + m.key] || '';
    var date     = tally['ms_date_'   + m.key] || '';
    if (statusEl) statusEl.value = status;
    if (dateEl)   dateEl.value   = date;
    if (dot) dot.className = 'tl-dot ' + (status === 'complete' ? 'green' : status === 'in_progress' ? 'yellow' : 'grey');
  });
}

/* ---- TIMELINE DATES ---- */
function saveTlDate(milestone, value) {
  if (!currentProjectId || !currentUserId) return;
  var field = 'tl_date_' + milestone;
  var tally = Object.assign({}, currentProject.tally_fields || {});
  tally[field] = value;
  currentProject.tally_fields = tally;
  sb.from('projects').update({ tally_fields: tally, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(res) {
      if (res.error) console.error('Date save failed:', res.error.message);
    });
}

function loadTlDates(project) {
  var tally = project.tally_fields || {};
  var milestones = ['permit','design','construct','cod'];
  milestones.forEach(function(m) {
    var el = document.getElementById('tl-' + m + '-date');
    if (el && tally['tl_date_' + m]) el.value = tally['tl_date_' + m];
  });
}

/* ---- AUTH & DATA ---- */
var authTimeout = setTimeout(function() {
  if (!authResolved) window.location.href = "login.html";
}, 6000);

sb.auth.onAuthStateChange(function(event, session) {
  if (session && session.user) {
    authResolved = true;
    clearTimeout(authTimeout);
    document.body.classList.remove("hidden");
    currentUserId = session.user.id;
    loadProject(session.user.id);
  } else if (event === "SIGNED_OUT") {
    window.location.href = "login.html";
  }
});

function loadProject(userId) {
  var params = new URLSearchParams(window.location.search);
  var projectId = params.get("id");
  if (!projectId) { window.location.href = "dashboard.html"; return; }
  sb.from("projects").select("*").eq("id", projectId).eq("user_id", userId).single()
    .then(function(res) {
      if (res.error || !res.data) { window.location.href = "dashboard.html"; return; }
      var p = res.data;
      currentProject   = p;
      currentProjectId = p.id;
      var stageShort = (p.stage || "").replace(/\s*\(.*?\)/g, "").trim();
      stageShort = stageShort.split(" - ").map(function(s) {
        return s.replace(/\s*\(.*?\)/g, "").trim();
      }).join(" - ");
      document.getElementById("hero-name").textContent = p.name || "Unnamed Project";
      document.getElementById("hero-sub").textContent = [
        p.capacity_mw ? p.capacity_mw + " MWp" : null,
        stageShort || null
      ].filter(Boolean).join("  -  ");
      document.getElementById("inf-capacity").textContent = p.capacity_mw ? p.capacity_mw + " MWp" : "-";
      document.getElementById("inf-stage").textContent    = stageShort || "-";
      document.getElementById("inf-status").textContent   = (p.status || "-").replace(/-/g, " ");
      document.getElementById("inf-date").textContent     = new Date(p.created_at).toLocaleDateString("en-GB", {day:"2-digit",month:"short",year:"numeric"});
      var locEl = document.getElementById("inf-location");
      if (p.location && p.location.startsWith("http")) {
        locEl.innerHTML = '<a href="' + p.location + '" target="_blank">Maps</a>';
      } else {
        locEl.textContent = p.location || "-";
      }
      document.getElementById("info-card").style.display = "block";
      renderLeft(p);
      loadTlDates(p);
      loadDocsMini();
      initRegistries();
      generateSummary(false);
    });
}

/* =============================================
   DOCUMENT PANEL — DD CHECKLIST ENGINE
   ============================================= */

var projectDocuments = [];
var activeDocId = null;
var uploadingCatKey = null;

/* ── DD CHECKLIST DATA ──────────────────────── */
var DD_CATS = [
  {
    key: 'permit', label: 'Permits & Entitlements', color: '#c0392b',
    checklist: [
      'Zoning confirmation and Conditional/Special Use Permit approval',
      'ALTA Survey and Title Commitment review',
      'Environmental approvals (ESA, wetlands, species, cultural)',
      'Stormwater permits (NPDES) and SWPPP',
      'Building, grading, electrical permits',
      'FAA determination (if applicable)',
      'Approved decommissioning plan and security'
    ],
    priority: [
      'Conditional Use Permit (conditions of approval, transferability, operating restrictions)',
      'Phase I Environmental Site Assessment (and Phase II if applicable)',
      'ALTA Title Commitment and Survey (Schedule B-II exceptions, easements, mineral rights)'
    ]
  },
  {
    key: 'design', label: 'Design & Engineering', color: '#2471a3',
    checklist: [
      'Energy Yield Assessment (P50/P90/P99)',
      'Geotechnical report',
      'Civil grading and drainage design',
      'Single-line diagram (IFC)',
      'Electrical studies (short circuit, grounding, arc flash)',
      'Structural calculations (ASCE 7 compliant)',
      'Independent Engineer review'
    ],
    priority: [
      'Energy Yield Assessment (resource assumptions, degradation, curtailment)',
      'Geotechnical Report (soil risk, corrosion, pile refusal)',
      'Issued-for-Construction Single Line Diagram'
    ]
  },
  {
    key: 'construct', label: 'Construction', color: '#d35400',
    checklist: [
      'Executed EPC agreement',
      'Detailed construction budget',
      'Project schedule (critical path)',
      'Performance and payment bonds',
      'HSE and QA/QC plans'
    ],
    priority: [
      'Executed EPC Agreement (LDs, guarantees, change orders, force majeure)',
      'Critical Path Schedule',
      'Detailed Line-Item Construction Budget'
    ]
  },
  {
    key: 'procurement', label: 'Procurement', color: '#7d3c98',
    checklist: [
      'Module supply agreement',
      'Inverter supply agreement',
      'Tracker/racking agreement',
      'Transformer procurement',
      'Warranty documentation',
      'Domestic content documentation (if applicable)'
    ],
    priority: [
      'Module Supply Agreement (delivery terms, LDs, insolvency protection)',
      'Module Warranty Certificate (performance curve alignment)',
      'Domestic Content Documentation Package'
    ]
  },
  {
    key: 'contract', label: 'Legal', color: '#1e8449',
    checklist: [
      'Executed land lease or purchase agreement',
      'Recorded memorandum of lease',
      'Title insurance policy',
      'Executed Power Purchase Agreement (PPA)',
      'Tax credit legal opinion (ITC/PTC)',
      'Insurance program documentation'
    ],
    priority: [
      'Power Purchase Agreement (curtailment, termination, credit support)',
      'Land Lease Agreement (assignment, subordination, termination rights)',
      'ITC/PTC Tax Opinion'
    ]
  },
  {
    key: 'intercon', label: 'Grid Connection', color: '#117a65',
    checklist: [
      'Feasibility, System Impact, and Facilities Studies',
      'Executed Interconnection Agreement',
      'Network upgrade cost breakdown',
      'Security postings',
      'Deliverability and capacity accreditation documentation'
    ],
    priority: [
      'Executed Interconnection Agreement (milestones, upgrade costs, curtailment)',
      'Facilities Study (final scope and cost responsibility)',
      'Deliverability / Capacity Accreditation Letter'
    ]
  },
  {
    key: 'financial', label: 'Finance', color: '#1a5276',
    checklist: [
      'Fully functional financial model (native format)',
      'Model audit report',
      'Debt term sheet',
      'Tax equity commitment letter',
      'Sources & Uses statement',
      'Sensitivity analyses'
    ],
    priority: [
      'Financial Model (revenue stack, DSCR, tax credits)',
      'Independent Model Audit Report',
      'Tax Equity Commitment Letter (conditions precedent, flip terms)'
    ]
  }
];

var checklistState = {};   // { catKey_itemIdx: true/false }
var openCats = {};         // { catKey: true/false }

/* ── PANEL OPEN / CLOSE ─────────────────────── */
function openDocPanel() {
  if (typeof closeCatPanel === 'function') closeCatPanel();
  document.getElementById('main-overview').style.display = 'none';
  document.getElementById('cat-panel').classList.remove('open');
  document.getElementById('doc-panel').classList.add('open');
  loadDocuments();
}

function closeDocPanel() {
  document.getElementById('doc-panel').classList.remove('open');
  document.getElementById('main-overview').style.display = 'block';
}

/* ── LOAD DOCUMENTS + STATE ─────────────────── */
function loadDocuments() {
  if (!currentProjectId || !currentUserId) return;
  // Load checklist state from tally_fields
  var saved = (currentProject && currentProject.tally_fields) || {};
  Object.keys(saved).forEach(function(k) {
    if (k.startsWith('dd_check_')) checklistState[k] = saved[k];
  });

  sb.from('project_documents')
    .select('*')
    .eq('project_id', currentProjectId)
    .order('created_at', { ascending: false })
    .then(function(res) {
      if (res.error) { console.error(res.error); return; }
      projectDocuments = res.data || [];
      buildDocPanel();
      renderMiniList();
    });
}

/* ── BUILD FULL PANEL ───────────────────────── */
function buildDocPanel() {
  buildProgressBar();
  buildCatSections();
  updateGlobalCounts();
}

function buildProgressBar() {
  var html = DD_CATS.map(function(cat) {
    var docs = docsForCat(cat.key);
    var checks = checksForCat(cat.key);
    var total = cat.checklist.length + cat.priority.length;
    var done = checks + Math.min(docs.length, cat.priority.length);
    var pct = total ? Math.round(done / total * 100) : 0;
    var cls = pct === 100 ? 'complete' : pct > 0 ? 'partial' : 'empty';
    return '<div class="dp-prog-cat">' +
      '<div class="dp-prog-cat-ring ' + cls + '">' + pct + '%</div>' +
      '<div class="dp-prog-cat-name">' + escHtml(cat.label) + '</div>' +
    '</div>';
  }).join('');
  document.getElementById('dp-prog-cats').innerHTML = html;
}

function buildCatSections() {
  var container = document.getElementById('dp-cat-sections');
  container.innerHTML = '';
  DD_CATS.forEach(function(cat, idx) {
    container.appendChild(buildCatCard(cat, idx));
  });
}

function buildCatCard(cat, idx) {
  var wrap = document.createElement('div');
  wrap.className = 'dd-cat-card';
  wrap.id = 'ddcat-' + cat.key;

  var docs = docsForCat(cat.key);
  var checkedCount = checksForCat(cat.key);
  var totalChecks = cat.checklist.length;
  var pillCls = checkedCount === totalChecks ? 'done' : checkedCount > 0 ? 'part' : 'none';
  var priorityUploaded = priorityUploadedCount(cat);
  var isOpen = openCats[cat.key] || false;

  // Header
  var hdr = document.createElement('div');
  hdr.className = 'dd-cat-hdr' + (isOpen ? ' open' : '');
  hdr.innerHTML =
    '<div class="dd-cat-num" style="background:' + cat.color + '">' + (idx+1) + '</div>' +
    '<span class="dd-cat-name">' + escHtml(cat.label) + '</span>' +
    '<div class="dd-cat-meta">' +
      '<span class="dd-cat-check-pill ' + pillCls + '">' + checkedCount + '/' + totalChecks + ' checks</span>' +
      '<span class="dd-cat-file-pill">&#128196; ' + docs.length + ' file' + (docs.length !== 1 ? 's' : '') + '</span>' +
      '<span class="dd-cat-check-pill ' + (priorityUploaded === cat.priority.length ? 'done' : priorityUploaded > 0 ? 'part' : 'none') + '">&#9733; ' + priorityUploaded + '/' + cat.priority.length + '</span>' +
    '</div>' +
    '<span class="dd-cat-chevron' + (isOpen ? ' open' : '') + '">&#9660;</span>';
  hdr.onclick = function() { toggleCatAccordion(cat.key); };
  wrap.appendChild(hdr);

  // Body
  var body = document.createElement('div');
  body.className = 'dd-cat-body' + (isOpen ? ' open' : '');
  body.id = 'ddbody-' + cat.key;

  // 1. Checklist section
  var clHtml = '<div class="dd-section"><div class="dd-section-title">Full Checklist</div>';
  cat.checklist.forEach(function(item, i) {
    var stateKey = 'dd_check_' + cat.key + '_' + i;
    var checked = checklistState[stateKey] ? true : false;
    var cbId = 'cb-' + cat.key + '-' + i;
    clHtml +=
      '<div class="dd-check-item">' +
        '<input type="checkbox" class="dd-check-cb" id="' + cbId + '"' + (checked ? ' checked' : '') +
          ' onchange="toggleCheck(\'' + cat.key + '\',' + i + ',this.checked)"/>' +
        '<label class="dd-check-lbl' + (checked ? ' done' : '') + '" for="' + cbId + '">' + escHtml(item) + '</label>' +
      '</div>';
  });
  clHtml += '</div>';

  // 2. Priority documents section
  var prHtml = '<div class="dd-section"><div class="dd-section-title">&#9733; Priority Documents to Inspect</div>';
  cat.priority.forEach(function(pname, pi) {
    // Find a doc whose file_name loosely matches this priority item keyword
    var matchedDoc = findMatchingDoc(cat.key, pname);
    var badge = matchedDoc
      ? '<span class="dd-priority-badge uploaded">&#10003; Uploaded</span>' +
        '<button class="dd-view-link" onclick="previewDoc(\'' + escHtml(matchedDoc.id) + '\')">View</button>'
      : '<span class="dd-priority-badge missing">Missing</span>';
    prHtml +=
      '<div class="dd-priority-item">' +
        '<span class="dd-priority-star">&#9733;</span>' +
        '<span class="dd-priority-name">' + escHtml(pname) + '</span>' +
        badge +
      '</div>';
  });
  prHtml += '</div>';

  // 3. Uploaded files for this category
  var filesHtml = '<div class="dd-files-section"><div class="dd-section-title">Uploaded Files</div>';
  if (docs.length) {
    docs.forEach(function(doc) {
      var ext = docExt(doc.file_name);
      var icon = docIcon(ext);
      filesHtml +=
        '<div class="dd-file-row">' +
          '<span class="dd-file-icon">' + icon + '</span>' +
          '<div class="dd-file-info">' +
            '<div class="dd-file-name" title="' + escHtml(doc.file_name) + '">' + escHtml(doc.file_name) + '</div>' +
            '<div class="dd-file-meta">' + fmtBytes(doc.file_size) + ' &nbsp;·&nbsp; ' + fmtDate(doc.created_at) + '</div>' +
          '</div>' +
          '<div class="dd-file-actions">' +
            '<button class="dd-file-preview" onclick="previewDoc(\'' + doc.id + '\')">Preview</button>' +
            '<button class="dd-file-rm" onclick="removeDoc(\'' + doc.id + '\',\'' + escHtml(doc.file_name) + '\',\'' + cat.key + '\')">Remove</button>' +
          '</div>' +
        '</div>';
    });
  } else {
    filesHtml += '<div class="dd-files-empty">No files uploaded for this category yet.</div>';
  }
  filesHtml += '</div>';

  // 4. Upload row
  var upHtml =
    '<div class="dd-upload-row">' +
      '<div class="dd-dropzone" id="ddzone-' + cat.key + '"' +
        ' onclick="triggerCatUpload(\'' + cat.key + '\')"' +
        ' ondragover="event.preventDefault();this.classList.add(\'drag-over\')"' +
        ' ondragleave="this.classList.remove(\'drag-over\')"' +
        ' ondrop="handleCatDrop(event,\'' + cat.key + '\')">' +
        '<span class="dd-dropzone-icon">&#128196;</span>' +
        '<span class="dd-dropzone-text">Drop file here or click Upload</span>' +
      '</div>' +
      '<button class="dd-upload-btn" onclick="triggerCatUpload(\'' + cat.key + '\')">&#8679; Upload</button>' +
    '</div>' +
    '<div class="dd-upload-progress" id="ddprog-' + cat.key + '">' +
      '<div class="dd-prog-bar"><div class="dd-prog-fill" id="ddprogfill-' + cat.key + '" style="width:0%"></div></div>' +
      '<span class="dd-prog-txt" id="ddprogtxt-' + cat.key + '">Uploading...</span>' +
    '</div>' +
    '<div class="dd-upload-err" id="dderr-' + cat.key + '"></div>';

  body.innerHTML = clHtml + prHtml + filesHtml + upHtml;
  wrap.appendChild(body);
  return wrap;
}

/* ── ACCORDION ──────────────────────────────── */
function toggleCatAccordion(catKey) {
  openCats[catKey] = !openCats[catKey];
  var body = document.getElementById('ddbody-' + catKey);
  var card = document.getElementById('ddcat-' + catKey);
  if (!body || !card) return;
  var isOpen = openCats[catKey];
  body.classList.toggle('open', isOpen);
  var chevron = card.querySelector('.dd-cat-chevron');
  if (chevron) chevron.classList.toggle('open', isOpen);
}

/* ── CHECKLIST TOGGLE ───────────────────────── */
function toggleCheck(catKey, itemIdx, checked) {
  var stateKey = 'dd_check_' + catKey + '_' + itemIdx;
  checklistState[stateKey] = checked;

  // Update label style
  var lbl = document.querySelector('label[for="cb-' + catKey + '-' + itemIdx + '"]');
  if (lbl) lbl.classList.toggle('done', checked);

  // Persist to tally_fields
  if (!currentProjectId || !currentUserId) return;
  var tally = Object.assign({}, (currentProject && currentProject.tally_fields) || {});
  tally[stateKey] = checked;
  if (currentProject) currentProject.tally_fields = tally;
  sb.from('projects').update({ tally_fields: tally, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function() {
      // Refresh pill counts in header
      refreshCatHeader(catKey);
      updateGlobalCounts();
      buildProgressBar();
    });
}

function checksForCat(catKey) {
  var cat = DD_CATS.find(function(c) { return c.key === catKey; });
  if (!cat) return 0;
  var count = 0;
  cat.checklist.forEach(function(_, i) {
    if (checklistState['dd_check_' + catKey + '_' + i]) count++;
  });
  return count;
}

/* ── PRIORITY MATCH ─────────────────────────── */
function findMatchingDoc(catKey, priorityName) {
  // Docs tagged to this category
  var catDocs = docsForCat(catKey);
  if (!catDocs.length) return null;
  // Extract key words from priority name (first 2 meaningful words)
  var keywords = priorityName.toLowerCase()
    .replace(/[^a-z0-9 ]/g, ' ')
    .split(/\s+/)
    .filter(function(w) { return w.length > 3; })
    .slice(0, 3);
  return catDocs.find(function(doc) {
    var fname = doc.file_name.toLowerCase();
    return keywords.some(function(kw) { return fname.includes(kw); });
  }) || null;
}

function priorityUploadedCount(cat) {
  return cat.priority.filter(function(p) { return findMatchingDoc(cat.key, p); }).length;
}

/* ── REFRESH CAT HEADER (after check/upload) ── */
function refreshCatHeader(catKey) {
  var cat = DD_CATS.find(function(c) { return c.key === catKey; });
  if (!cat) return;
  var card = document.getElementById('ddcat-' + catKey);
  if (!card) return;
  var docs = docsForCat(catKey);
  var checkedCount = checksForCat(catKey);
  var totalChecks = cat.checklist.length;
  var pillCls = checkedCount === totalChecks ? 'done' : checkedCount > 0 ? 'part' : 'none';
  var priorityUploaded = priorityUploadedCount(cat);
  var priCls = priorityUploaded === cat.priority.length ? 'done' : priorityUploaded > 0 ? 'part' : 'none';
  var meta = card.querySelector('.dd-cat-meta');
  if (meta) {
    meta.innerHTML =
      '<span class="dd-cat-check-pill ' + pillCls + '">' + checkedCount + '/' + totalChecks + ' checks</span>' +
      '<span class="dd-cat-file-pill">&#128196; ' + docs.length + ' file' + (docs.length !== 1 ? 's' : '') + '</span>' +
      '<span class="dd-cat-check-pill ' + priCls + '">&#9733; ' + priorityUploaded + '/' + cat.priority.length + '</span>';
  }
}

function updateGlobalCounts() {
  var totalChecks = 0, doneChecks = 0, totalPri = 0, donePri = 0;
  DD_CATS.forEach(function(cat) {
    totalChecks += cat.checklist.length;
    doneChecks  += checksForCat(cat.key);
    totalPri    += cat.priority.length;
    donePri     += priorityUploadedCount(cat);
  });
  var cc = document.getElementById('dp-check-count');
  var pc = document.getElementById('dp-priority-count');
  if (cc) cc.textContent = doneChecks + ' / ' + totalChecks;
  if (pc) pc.textContent = donePri + ' / ' + totalPri;
}

/* ── UPLOAD ─────────────────────────────────── */
function triggerCatUpload(catKey) {
  uploadingCatKey = catKey;
  var inp = document.getElementById('dp-file-input');
  inp.value = '';
  inp.click();
}

function handleCatDrop(e, catKey) {
  e.preventDefault();
  document.getElementById('ddzone-' + catKey).classList.remove('drag-over');
  var files = e.dataTransfer && e.dataTransfer.files;
  if (files && files.length) { uploadingCatKey = catKey; handleCatFileSelect(files); }
}

function handleCatFileSelect(files) {
  if (!files || !files.length) return;
  var file = files[0];
  if (file.size > 52428800) { showCatErr(uploadingCatKey, 'File exceeds 50 MB limit.'); return; }
  uploadCatDoc(file, uploadingCatKey);
}

function showCatErr(catKey, msg) {
  var el = document.getElementById('dderr-' + catKey);
  if (!el) return;
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(function() { el.style.display = 'none'; }, 4000);
}

function uploadCatDoc(file, catKey) {
  if (!currentProjectId || !currentUserId) return;
  var prog = document.getElementById('ddprog-' + catKey);
  var fill = document.getElementById('ddprogfill-' + catKey);
  var txt  = document.getElementById('ddprogtxt-' + catKey);
  var errEl = document.getElementById('dderr-' + catKey);
  if (prog) prog.style.display = 'flex';
  if (fill) fill.style.width = '10%';
  if (txt)  txt.textContent = 'Uploading…';
  if (errEl) errEl.style.display = 'none';

  var safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
  var path = currentProjectId + '/' + Date.now() + '_' + safeName;

  sb.storage.from('project_docs').upload(path, file, { upsert: false })
    .then(function(res) {
      if (res.error) {
        if (prog) prog.style.display = 'none';
        showCatErr(catKey, 'Upload failed: ' + res.error.message);
        return null;
      }
      if (fill) fill.style.width = '70%';
      if (txt)  txt.textContent = 'Saving…';
      var urlRes = sb.storage.from('project_docs').getPublicUrl(path);
      var publicUrl = (urlRes.data && urlRes.data.publicUrl) || '';
      return sb.from('project_documents').insert({
        project_id: currentProjectId,
        user_id:    currentUserId,
        file_name:  file.name,
        file_path:  path,
        file_size:  file.size,
        file_type:  file.type || 'application/octet-stream',
        tag:        catKey,
        public_url: publicUrl
      });
    })
    .then(function(res) {
      if (!res) return;
      if (res.error) {
        if (prog) prog.style.display = 'none';
        showCatErr(catKey, 'Save failed: ' + res.error.message);
        return;
      }
      if (fill) fill.style.width = '100%';
      if (txt)  txt.textContent = 'Done!';
      setTimeout(function() {
        if (prog) { prog.style.display = 'none'; }
        if (fill) fill.style.width = '0%';
        document.getElementById('dp-file-input').value = '';
      }, 700);
      // Reload and rebuild
      sb.from('project_documents').select('*').eq('project_id', currentProjectId)
        .order('created_at', { ascending: false })
        .then(function(r) {
          if (!r.error) { projectDocuments = r.data || []; }
          buildDocPanel();
          // Re-open the accordion that was uploading
          openCats[catKey] = true;
          var body = document.getElementById('ddbody-' + catKey);
          if (body) body.classList.add('open');
          var card = document.getElementById('ddcat-' + catKey);
          if (card) { var ch = card.querySelector('.dd-cat-chevron'); if (ch) ch.classList.add('open'); }
          renderMiniList();
        });
    })
    .catch(function(err) {
      if (prog) prog.style.display = 'none';
      showCatErr(catKey, 'Error: ' + err.message);
    });
}

/* ── REMOVE ─────────────────────────────────── */
function removeDoc(docId, fileName, catKey) {
  if (!confirm('Remove "' + fileName + '"?')) return;
  var doc = projectDocuments.find(function(d) { return d.id === docId; });
  var delStorage = (doc && doc.file_path)
    ? sb.storage.from('project_docs').remove([doc.file_path])
    : Promise.resolve();
  delStorage.then(function() {
    return sb.from('project_documents').delete().eq('id', docId).eq('user_id', currentUserId);
  }).then(function(res) {
    if (res && res.error) { alert('Remove failed: ' + res.error.message); return; }
    projectDocuments = projectDocuments.filter(function(d) { return d.id !== docId; });
    buildDocPanel();
    openCats[catKey] = true; // keep accordion open
    var body = document.getElementById('ddbody-' + catKey);
    if (body) body.classList.add('open');
    renderMiniList();
  });
}

/* ── PREVIEW ────────────────────────────────── */
function previewDoc(docId) {
  var doc = projectDocuments.find(function(d) { return d.id === docId; });
  if (!doc) return;
  activeDocId = docId;
  var overlay = document.getElementById('dp-preview-overlay');
  var nameEl  = document.getElementById('dp-preview-name');
  var wrap    = document.getElementById('dp-preview-frame-wrap');
  if (!overlay) return;
  nameEl.textContent = doc.file_name;
  overlay.classList.add('open');
  var ext = docExt(doc.file_name);
  var url = doc.public_url;
  var canEmbed = ['pdf','jpg','jpeg','png','gif','webp','svg'].includes(ext);
  if (url && ext === 'pdf') {
    wrap.innerHTML = '<iframe class="dp-preview-iframe" src="' + escHtml(url) + '#toolbar=0"></iframe>';
  } else if (url && ['jpg','jpeg','png','gif','webp','svg'].includes(ext)) {
    wrap.innerHTML = '<div class="dp-preview-img-wrap"><img src="' + escHtml(url) + '" alt="' + escHtml(doc.file_name) + '"/></div>';
  } else {
    wrap.innerHTML = '<div class="dp-preview-no-preview"><p>No preview available for this file type.</p></div>';
  }
}

function closePreview() {
  document.getElementById('dp-preview-overlay').classList.remove('open');
  document.getElementById('dp-preview-frame-wrap').innerHTML = '';
  activeDocId = null;
}

function downloadActiveDoc() {
  if (!activeDocId) return;
  var doc = projectDocuments.find(function(d) { return d.id === activeDocId; });
  if (!doc) return;
  if (doc.public_url) { window.open(doc.public_url, '_blank'); return; }
  sb.storage.from('project_docs').createSignedUrl(doc.file_path, 3600).then(function(res) {
    if (res.data && res.data.signedUrl) window.open(res.data.signedUrl, '_blank');
  });
}

/* ── MINI LIST (sidebar card) ───────────────── */
function renderMiniList() {
  var list  = document.getElementById('upload-mini-list');
  var empty = document.getElementById('upload-mini-empty');
  if (!list) return;
  Array.from(list.querySelectorAll('.upload-doc-item')).forEach(function(el) { el.remove(); });
  if (!projectDocuments.length) { if (empty) empty.style.display = 'block'; return; }
  if (empty) empty.style.display = 'none';
  var catMap = {};
  DD_CATS.forEach(function(c) { catMap[c.key] = c.label; });
  projectDocuments.slice(0, 3).forEach(function(doc) {
    var item = document.createElement('div');
    item.className = 'upload-doc-item';
    var tagLabel = (catMap[doc.tag] || doc.tag || 'File').split(' ')[0];
    item.innerHTML =
      '<span class="upload-doc-name" title="' + escHtml(doc.file_name) + '">' + escHtml(doc.file_name) + '</span>' +
      '<span class="upload-doc-type">' + escHtml(tagLabel) + '</span>' +
      '<button class="upload-doc-view" onclick="openDocPanel()">View</button>';
    list.insertBefore(item, list.firstChild);
  });
}

function loadDocsMini() {
  if (!currentProjectId || !currentUserId) return;
  sb.from('project_documents').select('id,file_name,tag,created_at')
    .eq('project_id', currentProjectId)
    .order('created_at', { ascending: false }).limit(3)
    .then(function(res) {
      if (!res.error) { projectDocuments = res.data || []; renderMiniList(); }
    });
}

/* ── HELPERS ────────────────────────────────── */
function docsForCat(catKey) {
  return projectDocuments.filter(function(d) { return d.tag === catKey; });
}

function docExt(name) { return (name.split('.').pop() || '').toLowerCase(); }
function docIcon(ext) {
  if (ext === 'pdf') return '📄';
  if (['jpg','jpeg','png','gif','webp','svg'].includes(ext)) return '🖼️';
  if (['xls','xlsx','csv'].includes(ext)) return '📊';
  if (['doc','docx'].includes(ext)) return '📝';
  return '📎';
}
function fmtBytes(b) {
  if (!b) return '';
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}
function fmtDate(iso) { return new Date(iso).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); }

function generateSummary(forceRegen) {
  if (!currentProjectId || !currentUserId) return;
  if (summaryRunning && !forceRegen) return;
  summaryRunning = true;
  var contentEl = document.getElementById("ai-content");
  var regenBtn  = document.getElementById("btn-regen");
  contentEl.innerHTML = '<div class="ai-loading"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div><span>' + (forceRegen ? "Regenerating..." : "Generating brief...") + "</span></div>";
  regenBtn.style.display = "none";
  function callEdge() {
    fetch(SUPABASE_URL + "/functions/v1/generate-overview", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ project_id: currentProjectId, user_id: currentUserId, force: forceRegen })
    })
    .then(function(r) { if (!r.ok) return r.text().then(function(t) { throw new Error("HTTP " + r.status + ": " + t); }); return r.json(); })
    .then(function(data) {
      summaryRunning = false;
      if (data.error) {
        contentEl.innerHTML = '<div class="ai-error">Error: ' + data.error + "</div>";
      } else {
        var paras = (data.summary || "").split(/\n+/).filter(function(p) { return p.trim(); });
        contentEl.innerHTML = '<div class="ai-text">' + paras.map(function(p) { return "<p>" + p.trim() + "</p>"; }).join("") + "</div>";
      }
      regenBtn.style.display = "inline-block";
    })
    .catch(function(err) {
      summaryRunning = false;
      contentEl.innerHTML = '<div class="ai-error">Error: ' + err.message + "</div>";
      regenBtn.style.display = "inline-block";
    });
  }
  if (forceRegen) {
    sb.from("projects").update({ ai_summary: null, ai_summary_at: null }).eq("id", currentProjectId)
      .then(function() { callEdge(); }).catch(function() { callEdge(); });
  } else { callEdge(); }
}
</script>
<script type="text/javascript">window.$crisp=[];window.CRISP_WEBSITE_ID="49df8fc4-e9b9-4f8d-b357-680e84e62c67";(function(){d=document;s=d.createElement("script");s.src="https://client.crisp.chat/l.js";s.async=1;d.getElementsByTagName("head")[0].appendChild(s);})();</script>
</body>
</html>
