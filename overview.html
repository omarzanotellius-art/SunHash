<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash - Project Overview</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #eef0f4; color: #1a1f2e; min-height: 100vh; }
body.hidden { visibility: hidden; }
a { text-decoration: none; }
.topbar { position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; background: #111; border-bottom: 3px solid #FFFF00; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
.logo { font-size: 22px; font-weight: 900; letter-spacing: 0.3px; text-transform: uppercase; color: #fff; }
.logo span { color: #FFFF00; }
.tb-right { display: flex; align-items: center; gap: 10px; }
.btn-back { padding: 7px 16px; border: none; background: rgba(255,255,255,0.1); color: #aaa; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; text-transform: uppercase; border-radius: 20px; cursor: pointer; }
.btn-back:hover { background: rgba(255,255,255,0.2); color: #fff; }
.btn-out { background: none; border: 1px solid #444; color: #777; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; padding: 7px 14px; cursor: pointer; text-transform: uppercase; border-radius: 20px; }
.btn-out:hover { border-color: #E83535; color: #E83535; }
.page { padding-top: 56px; }
.hero { background: #111; padding: 20px 14px 18px; }
.hero-tag { font-size: 10px; font-weight: 700; letter-spacing: 0.6px; text-transform: uppercase; color: #FFFF00; margin-bottom: 5px; opacity: 0.8; }
.hero h1 { font-size: 28px; font-weight: 900; letter-spacing: -0.8px; color: #fff; line-height: 1; }
.hero-sub { font-size: 12px; color: #555; margin-top: 5px; }

/* 3-column layout */
.layout { display: grid; grid-template-columns: 210px 1fr 210px; gap: 10px; padding: 12px 12px 60px; align-items: start; }

/* LEFT COLUMN */
.left-col { display: flex; flex-direction: column; gap: 8px; }
.score-card { background: #1a1f2e; border-radius: 12px; padding: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); text-align: center; }
.score-card-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #FFFF00; opacity: 0.7; margin-bottom: 8px; }
.score-ring { width: 72px; height: 72px; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.06); border: 3px solid rgba(255,255,255,0.08); transition: border-color .4s; }
.score-ring-val { font-size: 26px; font-weight: 900; color: #fff; letter-spacing: -1px; line-height: 1; }
.score-ring-sub { font-size: 9px; color: #555; margin-top: 1px; }
.score-ring-none { font-size: 11px; color: #444; font-weight: 600; }
.score-card-desc { font-size: 10px; color: #444; line-height: 1.5; }
.cat-item { background: #dde1ea; border-radius: 10px; padding: 9px 11px; box-shadow: 0 1px 5px rgba(0,0,0,0.06); transition: transform .12s, box-shadow .12s; }
.cat-item:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
.cat-item.active { box-shadow: 0 0 0 2px #1a1f2e; }
.cat-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.cat-name { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.3px; color: #1a1f2e; }
.cat-score-lbl { font-size: 9px; font-weight: 700; color: #6b7585; }
.cat-bar-track { height: 3px; background: rgba(0,0,0,0.1); border-radius: 2px; overflow: hidden; margin-bottom: 7px; }
.cat-bar-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }
.cat-btn-row { display: grid; gap: 5px; }
.cat-btn-row.two { grid-template-columns: 1fr 1fr; }
.cat-start-btn { display: block; width: 100%; padding: 4px 6px; background: rgba(255,255,255,0.55); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #1a1f2e; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.cat-start-btn:hover { background: #1a1f2e; color: #FFFF00; }
.cat-view-btn { display: block; width: 100%; padding: 4px 6px; background: #1a1f2e; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #FFFF00; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.cat-view-btn:hover { background: #FFFF00; color: #1a1f2e; }

/* CENTRE COLUMN */
.main { display: flex; flex-direction: column; gap: 10px; min-width: 0; }

/* Overview cards */
.ov-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.ov-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.ov-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.ov-card-body { padding: 10px 14px; }
.info-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 7px; }
.info-row { background: rgba(255,255,255,0.5); border-radius: 7px; padding: 7px 9px; }
.info-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #6b7585; margin-bottom: 3px; letter-spacing: 0.3px; }
.info-val { font-size: 11px; font-weight: 700; color: #1a1f2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.info-val a { color: #1a1f2e; text-decoration: underline; }
.ai-card { background: #1a1f2e; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 14px rgba(0,0,0,0.12); }
.ai-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: space-between; }
.ai-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: #FFFF00; opacity: 0.8; }
.ai-model { font-size: 9px; color: #444; }
.ai-card-body { padding: 14px; }
.ai-text { font-size: 12px; color: #bbb; line-height: 1.75; }
.ai-text p { margin-bottom: 10px; }
.ai-text p:last-child { margin-bottom: 0; }
.ai-loading { display: flex; align-items: center; gap: 8px; color: #555; font-size: 12px; }
.ai-dot { width: 5px; height: 5px; border-radius: 50%; background: #FFFF00; animation: pulse 1.2s ease-in-out infinite; }
.ai-dot:nth-child(2) { animation-delay: 0.2s; }
.ai-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes pulse { 0%,80%,100%{ opacity:0.2; transform:scale(0.8); } 40%{ opacity:1; transform:scale(1.1); } }
.ai-error { font-size: 12px; color: #e74c3c; }
.btn-regen { padding: 3px 10px; border: 1px solid #333; background: none; color: #555; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 600; cursor: pointer; border-radius: 20px; }
.btn-regen:hover { border-color: #FFFF00; color: #FFFF00; }
.coming-soon { background: #dde1ea; border-radius: 12px; padding: 22px 18px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.coming-soon h2 { font-size: 17px; font-weight: 900; letter-spacing: -0.3px; margin-bottom: 5px; }
.coming-soon p { font-size: 12px; color: #6b7585; line-height: 1.6; max-width: 360px; margin: 0 auto 14px; }
.btn-big { display: inline-block; padding: 9px 20px; background: #1a1f2e; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; cursor: pointer; border-radius: 30px; border: none; }
.btn-big:hover { background: #FFFF00; color: #1a1f2e; }

/* CATEGORY DETAIL PANEL (replaces centre content) */
.cat-panel { display: none; flex-direction: column; gap: 10px; min-width: 0; }
.cat-panel.open { display: flex; }

/* Panel header */
.cp-header { background: #1a1f2e; border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; }
.cp-header-left { display: flex; align-items: center; gap: 12px; }
.cp-back { background: rgba(255,255,255,0.1); border: none; color: #aaa; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; padding: 5px 12px; border-radius: 20px; cursor: pointer; transition: all .12s; }
.cp-back:hover { background: rgba(255,255,255,0.2); color: #fff; }
.cp-title { font-size: 16px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.3px; color: #fff; }
.cp-header-right { display: flex; align-items: center; gap: 8px; }

/* Score band inside panel */
.cp-score-band { background: #dde1ea; border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; gap: 16px; }
.cp-score-circle { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 3px solid rgba(0,0,0,0.1); }
.cp-score-num { font-size: 22px; font-weight: 900; line-height: 1; }
.cp-score-info { flex: 1; }
.cp-score-label { font-size: 9px; font-weight: 700; color: #6b7585; text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 3px; }
.cp-score-desc { font-size: 11px; color: #1a1f2e; font-weight: 600; margin-bottom: 6px; }
.cp-bar-track { height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; overflow: hidden; }
.cp-bar-fill { height: 100%; border-radius: 2px; transition: width .6s; }

/* Editable fields card */
.cp-fields-card { background: #dde1ea; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.cp-fields-hdr { padding: 10px 16px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; justify-content: space-between; }
.cp-fields-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.cp-fields-body { padding: 12px 16px; display: flex; flex-direction: column; gap: 8px; }
.cp-field { display: flex; flex-direction: column; gap: 4px; }
.cp-field-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #6b7585; letter-spacing: 0.3px; }
.cp-field-input { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #1a1f2e; outline: none; transition: border-color .12s, background .12s; }
.cp-field-input:focus { background: #fff; border-color: #1a1f2e; }
.cp-save-row { padding: 12px 16px; border-top: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; gap: 10px; }
.cp-save-btn { padding: 9px 22px; background: #1a1f2e; border: none; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; cursor: pointer; border-radius: 20px; transition: all .12s; }
.cp-save-btn:hover { background: #FFFF00; color: #1a1f2e; }
.cp-save-msg { font-size: 11px; color: #2e7d4f; font-weight: 600; opacity: 0; transition: opacity .3s; }
.cp-save-msg.show { opacity: 1; }
.cp-retake-btn { padding: 9px 16px; background: rgba(0,0,0,0.06); border: none; color: #6b7585; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; margin-left: auto; }
.cp-retake-btn:hover { background: rgba(0,0,0,0.12); color: #1a1f2e; }

/* Missing fields */
.cp-missing-card { background: #dde1ea; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.cp-missing-hdr { padding: 10px 16px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.cp-missing-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.cp-missing-body { padding: 12px 16px; display: flex; flex-direction: column; gap: 0; }
.cp-missing-item { display: flex; align-items: flex-start; gap: 8px; padding: 7px 0; border-bottom: 1px solid rgba(0,0,0,0.06); }
.cp-missing-item:last-child { border-bottom: none; }
.cp-missing-dot { width: 6px; height: 6px; border-radius: 50%; background: #e07b20; flex-shrink: 0; margin-top: 4px; }
.cp-missing-text { font-size: 11px; color: #1a1f2e; line-height: 1.5; }
.cp-missing-impact { font-size: 10px; color: #6b7585; margin-top: 1px; }

/* Share button */
.cp-share-btn { padding: 5px 14px; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); color: #ccc; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.cp-share-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }

/* Share modal */
.share-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; display: none; align-items: center; justify-content: center; }
.share-modal-overlay.open { display: flex; }
.share-modal { background: #eef0f4; border-radius: 14px; padding: 24px; width: 420px; max-width: 92vw; box-shadow: 0 8px 40px rgba(0,0,0,0.2); }
.share-modal h3 { font-size: 14px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 6px; }
.share-modal p { font-size: 12px; color: #6b7585; line-height: 1.6; margin-bottom: 16px; }
.share-url-box { background: #fff; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; padding: 10px 12px; font-size: 11px; color: #1a1f2e; word-break: break-all; margin-bottom: 12px; line-height: 1.6; }
.share-modal-btns { display: flex; gap: 8px; justify-content: flex-end; }
.share-copy-btn { padding: 8px 18px; background: #1a1f2e; border: none; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; }
.share-copy-btn:hover { background: #FFFF00; color: #1a1f2e; }
.share-close-btn { padding: 8px 16px; background: rgba(0,0,0,0.07); border: none; color: #6b7585; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 20px; }

/* AI Q&A card */
.cp-ai-card { background: #1a1f2e; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 14px rgba(0,0,0,0.12); }
.cp-ai-hdr { padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; gap: 8px; }
.cp-ai-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: #FFFF00; opacity: 0.8; }
.cp-ai-model { font-size: 9px; color: #444; margin-left: auto; }
.cp-ai-body { padding: 14px; display: flex; flex-direction: column; gap: 10px; }
.cp-ai-history { display: flex; flex-direction: column; gap: 8px; max-height: 220px; overflow-y: auto; }
.cp-ai-msg { font-size: 12px; line-height: 1.65; border-radius: 8px; padding: 8px 11px; }
.cp-ai-msg.user { background: rgba(255,255,255,0.07); color: #ccc; align-self: flex-end; max-width: 85%; }
.cp-ai-msg.assistant { background: rgba(255,255,0,0.06); color: #bbb; align-self: flex-start; max-width: 95%; }
.cp-ai-input-row { display: flex; gap: 7px; }
.cp-ai-input { flex: 1; padding: 8px 12px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 12px; color: #fff; outline: none; }
.cp-ai-input::placeholder { color: #444; }
.cp-ai-input:focus { border-color: rgba(255,255,0,0.3); background: rgba(255,255,255,0.09); }
.cp-ai-send { padding: 8px 16px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 20px; transition: all .12s; flex-shrink: 0; }
.cp-ai-send:hover { background: #fff; }
.cp-ai-send:disabled { opacity: 0.4; cursor: default; }

/* RIGHT COLUMN */
.right-col { display: flex; flex-direction: column; gap: 8px; }
.lock-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.lock-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; justify-content: space-between; }
.lock-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.lock-icon { font-size: 13px; opacity: 0.35; }
.lock-card-body { padding: 20px 14px; }
.lock-overlay { display: flex; flex-direction: column; align-items: center; text-align: center; gap: 10px; }
.lock-svg { width: 28px; height: 28px; opacity: 0.2; }
.lock-msg { font-size: 11px; color: #6b7585; line-height: 1.5; max-width: 160px; }
.lock-req { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #aaa; background: rgba(0,0,0,0.07); padding: 3px 9px; border-radius: 20px; }

/* Tally overlay */
#ov-tally-overlay { display:none; position:fixed; inset:0; z-index:300; background:rgba(0,0,0,0.85); flex-direction:column; }


/* Timeline date inputs */
.tl-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
.tl-date-input { border: none; background: rgba(0,0,0,0.06); border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 10px; color: #6b7585; padding: 3px 6px; cursor: pointer; outline: none; width: 110px; }
.tl-date-input:focus { background: rgba(0,0,0,0.1); color: #1a1f2e; }
.tl-date-input::-webkit-calendar-picker-indicator { opacity: 0.4; cursor: pointer; }

/* Procurement grey (same as cat-item) */
.proc-item { background: #dde1ea; border-radius: 10px; padding: 9px 11px; box-shadow: 0 1px 5px rgba(0,0,0,0.06); transition: transform .12s, box-shadow .12s; }
.proc-item:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
.proc-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.proc-name { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.3px; color: #1a1f2e; }
.proc-start-btn { display: block; width: 100%; padding: 4px 6px; background: rgba(255,255,255,0.55); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #1a1f2e; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.proc-start-btn:hover { background: #1a1f2e; color: #FFFF00; }

/* Completeness dot on cat buttons */
.cat-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; margin-left: 5px; flex-shrink: 0; }

/* Timeline card */
.timeline-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.timeline-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.timeline-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.timeline-body { padding: 14px 16px; display: flex; flex-direction: column; gap: 0; }
.tl-step { display: flex; align-items: flex-start; gap: 12px; position: relative; }
.tl-step:not(:last-child)::after { content: ''; position: absolute; left: 7px; top: 18px; width: 2px; bottom: -14px; background: rgba(0,0,0,0.12); }
.tl-dot-wrap { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; padding-top: 2px; }
.tl-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.15); flex-shrink: 0; z-index: 1; }
.tl-dot.green  { background: #2e7d4f; border-color: #2e7d4f; }
.tl-dot.yellow { background: #e07b20; border-color: #e07b20; }
.tl-dot.red    { background: #c0392b; border-color: #c0392b; }
.tl-dot.grey   { background: #b0b8c8; border-color: #b0b8c8; }
.tl-info { flex: 1; padding-bottom: 14px; }
.tl-label { font-size: 11px; font-weight: 700; color: #1a1f2e; }
.tl-status { font-size: 10px; color: #6b7585; margin-top: 2px; }


/* Split centre: brief (2/3) + timeline (1/3) */
.centre-split { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: start; }
.centre-main { display: flex; flex-direction: column; gap: 10px; min-width: 0; }
.centre-timeline { display: flex; flex-direction: column; gap: 8px; }

/* Upload Document card (sits below timeline card in right sidebar of centre-split) */
.upload-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; position: sticky; top: calc(68px + var(--tl-height, 0px) + 8px); }
.upload-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.upload-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.upload-card-body { padding: 10px 14px; display: flex; flex-direction: column; gap: 8px; }
.upload-doc-list { display: flex; flex-direction: column; gap: 4px; }
.upload-doc-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.55); border-radius: 8px; padding: 5px 9px; gap: 6px; }
.upload-doc-name { font-size: 10px; font-weight: 600; color: #1a1f2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90px; }
.upload-doc-type { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #6b7585; background: rgba(0,0,0,0.07); padding: 1px 6px; border-radius: 20px; flex-shrink: 0; }
.upload-doc-view { font-size: 9px; font-weight: 700; color: #1a1f2e; background: none; border: none; cursor: pointer; text-transform: uppercase; padding: 2px 6px; border-radius: 20px; transition: all .12s; flex-shrink: 0; }
.upload-doc-view:hover { background: #1a1f2e; color: #FFFF00; }
.upload-open-btn { display: block; width: 100%; padding: 6px 8px; background: #1a1f2e; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #FFFF00; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.upload-open-btn:hover { background: #FFFF00; color: #1a1f2e; }
.upload-empty { font-size: 10px; color: #8a95a5; text-align: center; padding: 4px 0; }

/* Document panel (replaces centre content just like cat-panel) */
.doc-panel { display: none; flex-direction: column; gap: 10px; min-width: 0; }
.doc-panel.open { display: flex; }
.dp-header { background: #1a1f2e; border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; }
.dp-back { background: rgba(255,255,255,0.1); border: none; color: #aaa; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; padding: 5px 12px; border-radius: 20px; cursor: pointer; transition: all .12s; }
.dp-back:hover { background: rgba(255,255,255,0.2); color: #fff; }
.dp-title { font-size: 16px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.3px; color: #fff; }
.dp-upload-zone { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.dp-upload-zone-hdr { padding: 10px 16px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; gap: 8px; }
.dp-upload-zone-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.dp-tag-select { padding: 4px 9px; background: rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.1); border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 10px; color: #1a1f2e; outline: none; cursor: pointer; margin-left: auto; }
.dp-dropzone { margin: 14px 16px; border: 2px dashed rgba(0,0,0,0.15); border-radius: 10px; padding: 24px 16px; text-align: center; cursor: pointer; transition: all .15s; }
.dp-dropzone:hover, .dp-dropzone.drag-over { border-color: #1a1f2e; background: rgba(255,255,255,0.4); }
.dp-drop-icon { font-size: 28px; margin-bottom: 8px; opacity: 0.4; }
.dp-drop-text { font-size: 12px; font-weight: 600; color: #1a1f2e; margin-bottom: 3px; }
.dp-drop-sub { font-size: 10px; color: #6b7585; margin-bottom: 12px; }
.dp-upload-btn { display: inline-block; padding: 7px 20px; background: #1a1f2e; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; color: #FFFF00; cursor: pointer; text-transform: uppercase; letter-spacing: 0.3px; transition: all .12s; }
.dp-upload-btn:hover { background: #FFFF00; color: #1a1f2e; }
.dp-file-input { display: none; }
.dp-upload-progress { display: none; align-items: center; gap: 10px; padding: 0 16px 14px; }
.dp-progress-bar { flex: 1; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; overflow: hidden; }
.dp-progress-fill { height: 100%; background: #1a1f2e; border-radius: 2px; transition: width .3s; }
.dp-progress-text { font-size: 10px; color: #6b7585; white-space: nowrap; }
.dp-upload-err { font-size: 11px; color: #c0392b; padding: 0 16px 14px; display: none; }
.dp-docs-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.dp-docs-hdr { padding: 10px 16px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; justify-content: space-between; }
.dp-docs-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.dp-docs-count { font-size: 10px; color: #8a95a5; }
.dp-docs-body { padding: 8px 0; }
.dp-doc-row { display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-bottom: 1px solid rgba(0,0,0,0.05); transition: background .1s; cursor: pointer; }
.dp-doc-row:last-child { border-bottom: none; }
.dp-doc-row:hover { background: rgba(255,255,255,0.3); }
.dp-doc-row.active { background: rgba(26,31,46,0.07); }
.dp-doc-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 16px; }
.dp-doc-icon.pdf  { background: rgba(192,57,43,0.12); }
.dp-doc-icon.img  { background: rgba(46,125,79,0.12); }
.dp-doc-icon.xls  { background: rgba(30,100,60,0.12); }
.dp-doc-icon.doc  { background: rgba(30,80,160,0.12); }
.dp-doc-icon.other{ background: rgba(0,0,0,0.07); }
.dp-doc-info { flex: 1; min-width: 0; }
.dp-doc-name { font-size: 12px; font-weight: 600; color: #1a1f2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dp-doc-meta { font-size: 10px; color: #6b7585; margin-top: 1px; }
.dp-doc-tag { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #6b7585; background: rgba(0,0,0,0.07); padding: 1px 7px; border-radius: 20px; margin-left: 6px; }
.dp-doc-actions { display: flex; gap: 6px; flex-shrink: 0; }
.dp-doc-dl { padding: 4px 11px; background: rgba(255,255,255,0.7); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #1a1f2e; cursor: pointer; text-transform: uppercase; transition: all .12s; }
.dp-doc-dl:hover { background: #1a1f2e; color: #FFFF00; }
.dp-doc-rm { padding: 4px 11px; background: none; border: 1px solid rgba(192,57,43,0.3); border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #c0392b; cursor: pointer; text-transform: uppercase; transition: all .12s; }
.dp-doc-rm:hover { background: #c0392b; color: #fff; border-color: #c0392b; }
.dp-empty { padding: 24px 16px; text-align: center; font-size: 11px; color: #8a95a5; }
.dp-preview-card { background: #1a1f2e; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 14px rgba(0,0,0,0.12); }
.dp-preview-hdr { padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; gap: 8px; }
.dp-preview-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #FFFF00; opacity: 0.8; }
.dp-preview-name { font-size: 11px; color: #888; margin-left: auto; max-width: 260px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dp-preview-close { background: rgba(255,255,255,0.1); border: none; color: #aaa; font-size: 12px; cursor: pointer; padding: 3px 10px; border-radius: 20px; font-family: 'Inter', sans-serif; font-weight: 700; }
.dp-preview-close:hover { background: rgba(255,255,255,0.2); color: #fff; }
.dp-preview-body { background: #fff; }
.dp-preview-iframe { width: 100%; height: 500px; border: none; display: block; }
.dp-preview-nopreview { padding: 32px 16px; text-align: center; }
.dp-preview-nopreview p { font-size: 12px; color: #888; margin-bottom: 14px; }
.dp-preview-dl-big { padding: 9px 22px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; }

@media(max-width:900px){
  .layout { grid-template-columns: 1fr; }
  .left-col, .right-col { display: grid; grid-template-columns: repeat(3,1fr); }
  .score-card { grid-column: 1/-1; }
  .info-grid { grid-template-columns: repeat(3,1fr); }
}
</style>
</head>
<body class="hidden">

<!-- Share modal -->
<div class="share-modal-overlay" id="share-modal-overlay">
  <div class="share-modal">
    <h3 id="share-modal-title">Share Category</h3>
    <p>Anyone with this link can view this category's data without logging in. The link expires in 30 days.</p>
    <div class="share-url-box" id="share-url-box">Generating link...</div>
    <div class="share-modal-btns">
      <button class="share-close-btn" onclick="closeShareModal()">Close</button>
      <button class="share-copy-btn" onclick="copyShareLink()">Copy Link</button>
    </div>
  </div>
</div>

<!-- Tally form overlay -->
<div id="ov-tally-overlay">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#111;border-bottom:2px solid #FFFF00;flex-shrink:0;">
    <span style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;color:#FFFF00;" id="ov-tally-title">Assessment</span>
    <button onclick="closeTallyForm()" style="background:rgba(255,255,255,0.1);border:none;color:#aaa;font-size:18px;width:30px;height:30px;border-radius:50%;cursor:pointer;">&#215;</button>
  </div>
  <iframe id="ov-tally-frame" src="" title="Assessment Form" style="flex:1;border:none;width:100%;background:#fff;"></iframe>
</div>

<div class="topbar">
  <a href="dashboard.html" class="logo">Sun<span>Hash</span></a>
  <div class="tb-right">
    <a href="dashboard.html" class="btn-back">Back to Dashboard</a>
    <button class="btn-out" onclick="sb.auth.signOut().then(function(){ window.location.href='login.html'; })">Sign Out</button>
  </div>
</div>

<div class="page">
  <div class="hero">
    <div class="hero-tag">Project Overview</div>
    <h1 id="hero-name">Loading...</h1>
    <div class="hero-sub" id="hero-sub"></div>
  </div>

  <div class="layout">

    <!-- LEFT: score + categories -->
    <div class="left-col">
      <div class="score-card">
        <div class="score-card-lbl">Overall Risk Score</div>
        <div class="score-ring" id="score-ring">
          <div class="score-ring-none">N/A</div>
        </div>
        <div class="score-card-desc" id="score-card-desc">Complete at least one assessment to generate a score.</div>
      </div>
      <div id="sidebar" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>

    <!-- CENTRE: overview OR category panel -->
    <div class="main" id="main-overview">
      <div class="centre-split">
        <div class="centre-main">
        <div class="ov-card" id="info-card" style="display:none;">
        <div class="ov-card-hdr"><span class="ov-card-title">Project Details</span></div>
        <div class="ov-card-body">
          <div class="info-grid">
            <div class="info-row"><div class="info-lbl">Location</div><div class="info-val" id="inf-location">-</div></div>
            <div class="info-row"><div class="info-lbl">Capacity</div><div class="info-val" id="inf-capacity">-</div></div>
            <div class="info-row"><div class="info-lbl">Stage</div><div class="info-val" id="inf-stage">-</div></div>
            <div class="info-row"><div class="info-lbl">Status</div><div class="info-val" id="inf-status">-</div></div>
            <div class="info-row"><div class="info-lbl">Created</div><div class="info-val" id="inf-date">-</div></div>
          </div>
        </div>
      </div>
      <div class="ai-card">
        <div class="ai-card-hdr">
          <span class="ai-label">AI Project Brief</span>
          <div style="display:flex;align-items:center;gap:6px;">
            <span class="ai-model">gpt-4o-mini</span>
            <button class="btn-regen" id="btn-regen" onclick="generateSummary(true)" style="display:none;">Regenerate</button>
          </div>
        </div>
        <div class="ai-card-body">
          <div id="ai-content">
            <div class="ai-loading"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div><span>Loading...</span></div>
          </div>
        </div>
      </div>
        </div><!-- /centre-main -->
        <div class="centre-timeline">
        <!-- Timeline -->
        <div class="timeline-card" style="position:sticky;top:68px;">
        <div class="timeline-hdr" style="display:flex;align-items:center;justify-content:space-between;">
          <span class="timeline-title">Project Timeline</span>
          
        </div>
        <div class="timeline-body">
          <div class="tl-step">
            <div class="tl-dot-wrap"><div class="tl-dot grey" id="tl-permit"></div></div>
            <div class="tl-info">
              <div class="tl-label">Permitting</div>
              <div class="tl-status" id="tl-permit-status">Not started</div>
            </div>
          </div>
          <div class="tl-step">
            <div class="tl-dot-wrap"><div class="tl-dot grey" id="tl-design"></div></div>
            <div class="tl-info">
              <div class="tl-label">Engineering &amp; Design</div>
              <div class="tl-status" id="tl-design-status">Not started</div>
            </div>
          </div>
          <div class="tl-step">
            <div class="tl-dot-wrap"><div class="tl-dot grey" id="tl-construct"></div></div>
            <div class="tl-info">
              <div class="tl-label">Construction</div>
              <div class="tl-status" id="tl-construct-status">Not started</div>
            </div>
          </div>
          <div class="tl-step">
            <div class="tl-dot-wrap"><div class="tl-dot grey" id="tl-cod"></div></div>
            <div class="tl-info" style="padding-bottom:0;">
              <div class="tl-label">COD</div>
              <div class="tl-status" id="tl-cod-status">Pending</div>
            </div>
          </div>
        </div>
        </div><!-- /timeline-card -->
        <!-- Upload Document card -->
        <div class="upload-card">
          <div class="upload-card-hdr"><span class="upload-card-title">Documents</span></div>
          <div class="upload-card-body">
            <div class="upload-doc-list" id="upload-mini-list">
              <div class="upload-empty" id="upload-mini-empty">No files yet</div>
            </div>
            <button class="upload-open-btn" onclick="openDocPanel()">&#128196; Manage Documents</button>
          </div>
        </div>
        </div><!-- /centre-timeline -->
      </div><!-- /centre-split -->
    </div><!-- /main-overview -->

    <!-- CENTRE: category detail panel -->
    <div class="cat-panel" id="cat-panel">
      <!-- built dynamically by openCatPanel() -->
    </div>

    <!-- CENTRE: document panel -->
    <div class="doc-panel" id="doc-panel">
      <div class="dp-header">
        <div style="display:flex;align-items:center;gap:12px;">
          <button class="dp-back" onclick="closeDocPanel()">&#8592; Back</button>
          <span class="dp-title">Documents</span>
        </div>
        <span style="font-size:11px;color:#555;">Attach files to this project for reference &amp; AI context</span>
      </div>

      <!-- Upload zone -->
      <div class="dp-upload-zone">
        <div class="dp-upload-zone-hdr">
          <span class="dp-upload-zone-title">Upload New Document</span>
          <select class="dp-tag-select" id="dp-tag-select">
            <option value="general">General</option>
            <option value="alta">ALTA Survey</option>
            <option value="environmental">Environmental Study</option>
            <option value="geotech">Geotechnical Report</option>
            <option value="ppa">PPA / Offtake</option>
            <option value="land">Land Agreement / Lease</option>
            <option value="epc">EPC Contract</option>
            <option value="interconnection">Interconnection Agreement</option>
            <option value="permitting">Permit / Approval</option>
            <option value="financial">Financial Model</option>
            <option value="energy">Energy Report (P50/P90)</option>
            <option value="procurement">Procurement / PO</option>
            <option value="insurance">Insurance / Bond</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="dp-dropzone" id="dp-dropzone" onclick="document.getElementById('dp-file-input').click()"
          ondragover="event.preventDefault();this.classList.add('drag-over')"
          ondragleave="this.classList.remove('drag-over')"
          ondrop="handleDrop(event)">
          <div class="dp-drop-icon">&#128196;</div>
          <div class="dp-drop-text">Drop a file here or click to browse</div>
          <div class="dp-drop-sub">PDF, Word, Excel, images — up to 50 MB</div>
          <button class="dp-upload-btn" onclick="event.stopPropagation();document.getElementById('dp-file-input').click()">Choose File</button>
        </div>
        <input type="file" class="dp-file-input" id="dp-file-input" accept="*/*" onchange="handleFileSelect(this.files)"/>
        <div class="dp-upload-progress" id="dp-upload-progress">
          <div class="dp-progress-bar"><div class="dp-progress-fill" id="dp-progress-fill" style="width:0%"></div></div>
          <span class="dp-progress-text" id="dp-progress-text">Uploading...</span>
        </div>
        <div class="dp-upload-err" id="dp-upload-err"></div>
      </div>

      <!-- Document list -->
      <div class="dp-docs-card">
        <div class="dp-docs-hdr">
          <span class="dp-docs-title">Uploaded Files</span>
          <span class="dp-docs-count" id="dp-docs-count"></span>
        </div>
        <div class="dp-docs-body" id="dp-docs-body">
          <div class="dp-empty">No documents uploaded yet.</div>
        </div>
      </div>

      <!-- Preview pane (shown when a doc is clicked) -->
      <div class="dp-preview-card" id="dp-preview-card" style="display:none;">
        <div class="dp-preview-hdr">
          <span class="dp-preview-label">Preview</span>
          <span class="dp-preview-name" id="dp-preview-name"></span>
          <button class="dp-preview-close" onclick="closePreview()">✕ Close</button>
        </div>
        <div class="dp-preview-body" id="dp-preview-body"></div>
      </div>
    </div>

    <!-- RIGHT: locked cards -->
    <div class="right-col">

      <div class="lock-card">
        <div class="lock-card-hdr">
          <span class="lock-card-title">Critical Issues</span>
          <span class="lock-icon" id="icon-issues">&#128274;</span>
        </div>
        <div class="lock-card-body" id="body-issues">
          <div class="lock-overlay">
            <svg class="lock-svg" viewBox="0 0 24 24" fill="none" stroke="#1a1f2e" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <div class="lock-msg">Unlocks after the first assessment is completed.</div>
            <span class="lock-req">Requires 1+ assessment</span>
          </div>
        </div>
      </div>
      <div class="lock-card">
        <div class="lock-card-hdr">
          <span class="lock-card-title">Action Plan</span>
          <span class="lock-icon" id="icon-actions">&#128274;</span>
        </div>
        <div class="lock-card-body" id="body-actions">
          <div class="lock-overlay">
            <svg class="lock-svg" viewBox="0 0 24 24" fill="none" stroke="#1a1f2e" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <div class="lock-msg">Unlocks after the first assessment is completed.</div>
            <span class="lock-req">Requires 1+ assessment</span>
          </div>
        </div>
      </div>
      <div class="lock-card">
        <div class="lock-card-hdr">
          <span class="lock-card-title">Scenario Analysis</span>
          <span class="lock-icon" id="icon-scenario">&#128274;</span>
        </div>
        <div class="lock-card-body" id="body-scenario">
          <div class="lock-overlay">
            <svg class="lock-svg" viewBox="0 0 24 24" fill="none" stroke="#1a1f2e" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <div class="lock-msg">Unlocks after 2 or more assessments are completed.</div>
            <span class="lock-req">Requires 2+ assessments</span>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

var ADMIN_CONFIG = {};

// Load admin config (thresholds, required fields) from DB
sb.from("admin_config").select("key,value").then(function(res) {
  if (!res.error && res.data) {
    res.data.forEach(function(r) { ADMIN_CONFIG[r.key] = r.value; });
  }
});

var CAT_FORM_DESIGN    = "1ArXEg";
var CAT_FORM_CONSTRUCT = "0QEdP9";
var CAT_FORM_CONTRACT  = "D4VBel";
var CAT_FORM_INTERCON  = "Gxr6Le";
var CAT_FORM_FINANCIAL = "rjl5Vo";
var CAT_FORM_PERMIT    = "xXdr2d";

var currentProjectId = null;
var currentUserId    = null;
var currentProject   = null;
var authResolved     = false;
var summaryRunning   = false;
var activeCatKey     = null;
var aiHistory        = {};  // per category
var pollTimer        = null;
var shareToken       = null;

var CATEGORIES = [
  {
    key: "score_design", label: "Design",
    fields: [
      { lbl: "Technology Type",      field: "technology_type" },
      { lbl: "Module Brand",         field: "module_brand" },
      { lbl: "Inverter Type",        field: "inverter_type" },
      { lbl: "Mounting System",      field: "mounting_system" },
      { lbl: "Single-Line Diagram",  field: "single_line_diagram" }
    ],
    missing: [
      { text: "Single-line diagram not uploaded",   impact: "Reduces Design score reliability" },
      { text: "Inverter specifications missing",    impact: "Cannot validate yield assumptions" },
      { text: "Structural engineering report",      impact: "Required for grid connection approval" }
    ]
  },
  {
    key: "score_construct", label: "Build",
    fields: [
      { lbl: "EPC Contractor",       field: "epc_contractor" },
      { lbl: "Construction Start",   field: "construction_start" },
      { lbl: "Construction End",     field: "construction_end" },
      { lbl: "Performance Bond",     field: "performance_bond" }
    ],
    missing: [
      { text: "EPC contract not finalised",         impact: "Key Build risk factor unverified" },
      { text: "Performance bond not confirmed",     impact: "Completion risk unmitigated" }
    ]
  },
  {
    key: "score_contract", label: "Legal",
    fields: [
      { lbl: "Land Ownership",       field: "land_ownership" },
      { lbl: "Land Lease Term",      field: "land_lease_term" },
      { lbl: "PPA Status",           field: "ppa_status" },
      { lbl: "PPA Counterparty",     field: "ppa_counterparty" },
      { lbl: "Legal Counsel",        field: "legal_counsel" }
    ],
    missing: [
      { text: "PPA not yet signed",                 impact: "Revenue risk unmitigated" },
      { text: "Land lease term under 25 years",     impact: "May not cover full project life" }
    ]
  },
  {
    key: "score_intercon", label: "Grid",
    fields: [
      { lbl: "Grid Operator",        field: "grid_operator" },
      { lbl: "Connection Voltage",   field: "connection_voltage" },
      { lbl: "Connection Study",     field: "grid_connection_study" },
      { lbl: "Offer Accepted",       field: "grid_offer_accepted" }
    ],
    missing: [
      { text: "Grid connection study not complete", impact: "Cannot confirm capacity or costs" },
      { text: "Grid offer not yet accepted",        impact: "Connection timeline uncertain" }
    ]
  },
  {
    key: "score_financial", label: "Finance",
    fields: [
      { lbl: "Financial Model",      field: "financial_model" },
      { lbl: "Equity Source",        field: "equity_source" },
      { lbl: "Debt Source",          field: "debt_source" },
      { lbl: "IRR (Unlevered)",      field: "irr_unlevered" },
      { lbl: "DSCR",                 field: "dscr" }
    ],
    missing: [
      { text: "Financial model not uploaded",       impact: "Cannot validate return assumptions" },
      { text: "Debt terms not confirmed",           impact: "Financing risk unmitigated" }
    ]
  },
  {
    key: "score_permit", label: "Permit",
    fields: [
      { lbl: "Environmental Study",  field: "environmental_study" },
      { lbl: "Planning Permit",      field: "planning_permit" },
      { lbl: "Grid Permit",          field: "grid_permit" },
      { lbl: "Building Permit",      field: "building_permit" }
    ],
    missing: [
      { text: "Environmental impact study pending", impact: "May delay planning decision" },
      { text: "Grid permit not yet issued",         impact: "Connection cannot proceed without it" }
    ]
  }
];

var CAT_MILESTONES = {
  "score_design": [
    { label: "30% Design", key: "tl_d_30" },
    { label: "60% Design", key: "tl_d_60" },
    { label: "90% Design", key: "tl_d_90" },
    { label: "IFC (Issued for Construction)", key: "tl_d_ifc" },
    { label: "As-Built", key: "tl_d_asbuilt" },
  ],
  "score_construct": [
    { label: "Contractor Appointed", key: "tl_c_appt" },
    { label: "Mobilisation", key: "tl_c_mob" },
    { label: "Foundation Complete", key: "tl_c_found" },
    { label: "Modules Installed", key: "tl_c_mod" },
    { label: "Energisation", key: "tl_c_enrg" },
    { label: "PAC (Provisional Acceptance)", key: "tl_c_pac" },
    { label: "FAC (Final Acceptance)", key: "tl_c_fac" },
  ],
  "score_contract": [
    { label: "Land Secured", key: "tl_l_land" },
    { label: "PPA Executed", key: "tl_l_ppa" },
    { label: "Financial Close", key: "tl_l_fc" },
    { label: "Legal Completion", key: "tl_l_comp" },
  ],
  "score_intercon": [
    { label: "Connection Study Submitted", key: "tl_g_study" },
    { label: "Offer Received", key: "tl_g_offer" },
    { label: "Offer Accepted", key: "tl_g_accept" },
    { label: "Agreement Signed", key: "tl_g_sign" },
    { label: "Energisation", key: "tl_g_enrg" },
  ],
  "score_financial": [
    { label: "Financial Model Complete", key: "tl_f_model" },
    { label: "Term Sheet Signed", key: "tl_f_ts" },
    { label: "Credit Approval", key: "tl_f_credit" },
    { label: "Financial Close", key: "tl_f_fc" },
  ],
  "score_permit": [
    { label: "Environmental Study Submitted", key: "tl_p_env_sub" },
    { label: "Environmental Approval", key: "tl_p_env_app" },
    { label: "Planning Application", key: "tl_p_plan_sub" },
    { label: "Planning Approval", key: "tl_p_plan_app" },
    { label: "Grid Permit Granted", key: "tl_p_grid" },
    { label: "Building Permit", key: "tl_p_build" },
  ],
  "score_procurement": [
    { label: "RFQ Issued", key: "tl_pr_rfq" },
    { label: "Bids Received", key: "tl_pr_bids" },
    { label: "Supplier Selected", key: "tl_pr_sel" },
    { label: "PO Issued", key: "tl_pr_po" },
    { label: "Equipment Delivered", key: "tl_pr_del" },
  ],
};

function scoreColor(s) {
  if (s == null) return "rgba(0,0,0,0.12)";
  if (s >= 70) return "#2e7d4f";
  if (s >= 40) return "#e07b20";
  return "#c0392b";
}

/* ---- SIDEBAR ---- */
function renderLeft(project) {
  var overall = project.score_overall;
  var ringEl  = document.getElementById("score-ring");
  var descEl  = document.getElementById("score-card-desc");
  if (overall != null) {
    var color = scoreColor(overall);
    ringEl.style.border    = "3px solid " + color;
    ringEl.style.background = "rgba(0,0,0,0.15)";
    ringEl.innerHTML = '<div><div class="score-ring-val" style="color:' + color + '">' + overall + '</div><div class="score-ring-sub">/100</div></div>';
    descEl.textContent = overall >= 70 ? "Good overall risk profile." :
                         overall >= 40 ? "Moderate risk - review flagged categories." :
                                         "High risk - action required.";
  }
  var sidebarEl = document.getElementById("sidebar");
  sidebarEl.innerHTML = "";
  var scoredCount = 0;
  CATEGORIES.forEach(function(cat) {
    var score    = project[cat.key];
    var hasScore = score != null;
    if (hasScore) scoredCount++;
    var pct   = hasScore ? Math.min(100, Math.max(0, score)) : 0;
    var color = scoreColor(score);
    var lbl   = hasScore ? score + "/100" : "--";
    // Completeness dot
    var requiredFields = (ADMIN_CONFIG["cat_required_" + cat.key.replace("score_","")] || "").split(",").filter(Boolean);
    var tallyData = project.tally_fields || {};
    var filled = requiredFields.filter(function(f) { return tallyData[f] && tallyData[f] !== ""; }).length;
    var dotColor = !requiredFields.length ? "#b0b8c8" :
                   filled >= requiredFields.length ? "#2e7d4f" :
                   filled > 0 ? "#e07b20" : "#b0b8c8";
    var item  = document.createElement("div");
    item.className = "cat-item" + (activeCatKey === cat.key ? " active" : "");
    item.id = "cat-item-" + cat.key;
    var btnRow = hasScore
      ? '<div class="cat-btn-row two">' +
          '<button class="cat-view-btn"  onclick="openCatPanel(\'' + cat.key + '\')">View</button>' +
          '<button class="cat-start-btn" onclick="openCatForm(\''  + cat.key + '\')">Retake</button>' +
        '</div>'
      : '<div class="cat-btn-row">' +
          '<button class="cat-start-btn" onclick="openCatForm(\'' + cat.key + '\')">+ Start</button>' +
        '</div>';
    item.innerHTML =
      '<div class="cat-top"><span class="cat-name">' + cat.label + '</span><span class="cat-score-lbl">' + lbl + '<span class="cat-dot" style="background:' + dotColor + ';"></span></span></div>' +
      '<div class="cat-bar-track"><div class="cat-bar-fill" style="width:' + pct + '%;background:' + color + ';"></div></div>' +
      btnRow;
    sidebarEl.appendChild(item);
  });
  if (scoredCount >= 1) { unlockCard("issues"); unlockCard("actions"); }
  if (scoredCount >= 2) { unlockCard("scenario"); }

  // Procurement button (7th)
  var procExisting = document.getElementById("proc-item");
  if (!procExisting) {
    var proc = document.createElement("div");
    proc.className = "proc-item";
    proc.id = "proc-item";
    proc.innerHTML =
      '<div class="proc-top"><span class="proc-name">Procurement</span></div>' +
      '<button class="proc-start-btn" onclick="openCatForm(\'score_procurement\')">+ Start</button>';
    sidebarEl.appendChild(proc);
  }

  // Update timeline
  updateTimeline(project);
}

function unlockCard(id) {
  var iconEl = document.getElementById("icon-" + id);
  var bodyEl = document.getElementById("body-" + id);
  if (iconEl) iconEl.textContent = "";
  var labels = { issues: "critical issue analysis", actions: "action plan", scenario: "scenario analysis" };
  if (bodyEl) bodyEl.innerHTML =
    '<div style="padding:8px 0;text-align:center;"><div style="font-size:11px;color:#6b7585;line-height:1.6;">Coming soon -- full ' + (labels[id] || id) + ' will appear here once the report engine is live.</div></div>';
}

/* ---- CATEGORY PANEL ---- */
function openCatPanel(catKey) {
  var cat = CATEGORIES.find(function(c) { return c.key === catKey; });
  if (!cat || !currentProject) return;
  activeCatKey = catKey;

  // Swap centre content
  document.getElementById("main-overview").style.display = "none";
  var panel = document.getElementById("cat-panel");
  panel.classList.add("open");

  // Highlight active cat
  CATEGORIES.forEach(function(c) {
    var el = document.getElementById("cat-item-" + c.key);
    if (el) el.classList.toggle("active", c.key === catKey);
  });

  var score    = currentProject[catKey];
  var color    = scoreColor(score);
  var pct      = score != null ? Math.min(100, Math.max(0, score)) : 0;
  var scoreDesc = score == null ? "Not yet scored" :
                  score >= 70   ? "Good risk profile" :
                  score >= 40   ? "Moderate risk" : "High risk";

  // Build fields HTML
  var fieldsHtml = cat.fields.map(function(f) {
    var tallyData = currentProject.tally_fields || {};
    var val = tallyData[f.field] || currentProject[f.field] || "";
    return '<div class="cp-field">' +
      '<label class="cp-field-lbl">' + f.lbl + '</label>' +
      '<input class="cp-field-input" data-field="' + f.field + '" type="text" value="' + escHtml(String(val)) + '" placeholder="Enter ' + f.lbl.toLowerCase() + '"/>' +
    '</div>';
  }).join("");

  // Build missing HTML
  var missingHtml = cat.missing.map(function(m) {
    return '<div class="cp-missing-item"><div class="cp-missing-dot"></div>' +
      '<div><div class="cp-missing-text">' + m.text + '</div>' +
      '<div class="cp-missing-impact">' + m.impact + '</div></div></div>';
  }).join("");

  // Build AI history
  if (!aiHistory[catKey]) aiHistory[catKey] = [];
  var historyHtml = aiHistory[catKey].map(function(m) {
    return '<div class="cp-ai-msg ' + m.role + '">' + escHtml(m.content) + '</div>';
  }).join("");

  panel.innerHTML =

    // Header
    '<div class="cp-header">' +
      '<div class="cp-header-left">' +
        '<button class="cp-back" onclick="closeCatPanel()">&#8592; Overview</button>' +
        '<span class="cp-title">' + cat.label + '</span>' +
      '</div>' +
      '<div class="cp-header-right">' +
        '<button class="cp-share-btn" onclick="openShareModal(\'' + catKey + '\')">&#128279; Share</button>' +
      '</div>' +
    '</div>' +

    // Score band
    '<div class="cp-score-band">' +
      '<div class="cp-score-circle" style="border-color:' + color + ';background:rgba(0,0,0,0.06);">' +
        '<span class="cp-score-num" style="color:' + color + '">' + (score != null ? score : "N/A") + '</span>' +
      '</div>' +
      '<div class="cp-score-info">' +
        '<div class="cp-score-label">' + cat.label + ' Risk Score</div>' +
        '<div class="cp-score-desc">' + scoreDesc + '</div>' +
        '<div class="cp-bar-track"><div class="cp-bar-fill" style="width:' + pct + '%;background:' + color + ';"></div></div>' +
      '</div>' +
    '</div>' +

    // Editable fields
    '<div class="cp-fields-card">' +
      '<div class="cp-fields-hdr"><span class="cp-fields-title">Project Data</span></div>' +
      '<div class="cp-fields-body" id="cp-fields-body">' + fieldsHtml + '</div>' +
      '<div class="cp-save-row">' +
        '<button class="cp-save-btn" onclick="saveFields()">Save All</button>' +
        '<span class="cp-save-msg" id="cp-save-msg">Saved</span>' +
        '<button class="cp-retake-btn" onclick="openCatForm(\'' + catKey + '\')">Retake Assessment</button>' +
      '</div>' +
    '</div>' +

    // Missing info
    '<div class="cp-missing-card">' +
      '<div class="cp-missing-hdr"><span class="cp-missing-title">Missing Information</span></div>' +
      '<div class="cp-missing-body">' + missingHtml + '</div>' +
    '</div>' +

    // Category milestone timeline
    buildCatTimeline(catKey) +

    // AI Q&A
    '<div class="cp-ai-card">' +
      '<div class="cp-ai-hdr">' +
        '<span class="cp-ai-label">Ask AI about ' + cat.label + '</span>' +
        '<span class="cp-ai-model">gpt-4o-mini</span>' +
      '</div>' +
      '<div class="cp-ai-body">' +
        '<div class="cp-ai-history" id="cp-ai-history">' + historyHtml + '</div>' +
        '<div class="cp-ai-input-row">' +
          '<input class="cp-ai-input" id="cp-ai-input" type="text" placeholder="Ask a question about this category..." onkeydown="if(event.key===\'Enter\')sendAiQuestion()"/>' +
          '<button class="cp-ai-send" id="cp-ai-send" onclick="sendAiQuestion()">Ask</button>' +
        '</div>' +
      '</div>' +
    '</div>';

  loadCatMilestones(catKey, currentProject);
  scrollAiHistory();
}

function closeCatPanel() {
  activeCatKey = null;
  document.getElementById("cat-panel").classList.remove("open");
  document.getElementById("cat-panel").innerHTML = "";
  document.getElementById("main-overview").style.display = "flex";
  CATEGORIES.forEach(function(c) {
    var el = document.getElementById("cat-item-" + c.key);
    if (el) el.classList.remove("active");
  });
}

function escHtml(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

/* ---- SAVE FIELDS ---- */
function saveFields() {
  if (!currentProjectId || !currentUserId) return;
  var inputs = document.querySelectorAll("#cp-fields-body .cp-field-input");
  // Write into tally_fields JSON (safe - no schema changes needed)
  var tallyFields = Object.assign({}, currentProject.tally_fields || {});
  inputs.forEach(function(inp) {
    var field = inp.getAttribute("data-field");
    var val   = inp.value.trim();
    if (field) {
      tallyFields[field] = val || null;
      if (currentProject) currentProject[field] = val || null;
    }
  });
  var update = { tally_fields: tallyFields, updated_at: new Date().toISOString() };
  sb.from("projects").update(update).eq("id", currentProjectId).eq("user_id", currentUserId)
    .then(function(res) {
      if (res.error) { alert("Save failed: " + res.error.message); return; }
      currentProject.tally_fields = tallyFields;
      var msg = document.getElementById("cp-save-msg");
      if (msg) {
        msg.classList.add("show");
        setTimeout(function() { msg.classList.remove("show"); }, 2500);
      }
    });
}

/* ---- AI Q&A ---- */
function sendAiQuestion() {
  var inputEl = document.getElementById("cp-ai-input");
  var sendBtn = document.getElementById("cp-ai-send");
  var question = inputEl ? inputEl.value.trim() : "";
  if (!question || !activeCatKey || !currentProject) return;

  var cat = CATEGORIES.find(function(c) { return c.key === activeCatKey; });

  // Add user message
  if (!aiHistory[activeCatKey]) aiHistory[activeCatKey] = [];
  aiHistory[activeCatKey].push({ role: "user", content: question });
  inputEl.value = "";
  if (sendBtn) sendBtn.disabled = true;
  renderAiHistory();

  // Add loading bubble
  var histEl = document.getElementById("cp-ai-history");
  var loadingId = "ai-loading-" + Date.now();
  if (histEl) {
    var loadingDiv = document.createElement("div");
    loadingDiv.className = "cp-ai-msg assistant";
    loadingDiv.id = loadingId;
    loadingDiv.innerHTML = '<div class="ai-loading"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div></div>';
    histEl.appendChild(loadingDiv);
    scrollAiHistory();
  }

  // Build context from project + category
  var projectContext = "Project: " + (currentProject.name || "Unknown") +
    "\nCapacity: " + (currentProject.capacity_mw || "N/A") + " MWp" +
    "\nStage: " + (currentProject.stage || "N/A") +
    "\nCategory: " + cat.label +
    "\nScore: " + (currentProject[activeCatKey] != null ? currentProject[activeCatKey] + "/100" : "Not yet scored") +
    "\nFields: " + cat.fields.map(function(f) {
      return f.lbl + ": " + (currentProject[f.field] || "Not provided");
    }).join(", ");

  var messages = [{ role: "user", content: "Project context:\n" + projectContext + "\n\nQuestion: " + question }];

  fetch(SUPABASE_URL + "/functions/v1/category-qa", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      project_id: currentProjectId,
      user_id: currentUserId,
      category: activeCatKey,
      question: question,
      history: (aiHistory[activeCatKey] || []).slice(0, -1).map(function(m) {
        return { role: m.role, content: m.content };
      })
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var answer = data.answer || data.error || "No response received.";
    aiHistory[activeCatKey].push({ role: "assistant", content: answer });
    var loadingEl = document.getElementById(loadingId);
    if (loadingEl) loadingEl.remove();
    renderAiHistory();
    if (sendBtn) sendBtn.disabled = false;
  })
  .catch(function(err) {
    var loadingEl = document.getElementById(loadingId);
    if (loadingEl) loadingEl.remove();
    aiHistory[activeCatKey].push({ role: "assistant", content: "Error: " + err.message });
    renderAiHistory();
    if (sendBtn) sendBtn.disabled = false;
  });
}

function renderAiHistory() {
  var histEl = document.getElementById("cp-ai-history");
  if (!histEl || !activeCatKey) return;
  var hist = aiHistory[activeCatKey] || [];
  histEl.innerHTML = hist.map(function(m) {
    return '<div class="cp-ai-msg ' + m.role + '">' + escHtml(m.content) + '</div>';
  }).join("");
  scrollAiHistory();
}

function scrollAiHistory() {
  var histEl = document.getElementById("cp-ai-history");
  if (histEl) histEl.scrollTop = histEl.scrollHeight;
}

/* ---- SHARE ---- */
function openShareModal(catKey) {
  var cat = CATEGORIES.find(function(c) { return c.key === catKey; });
  if (!cat || !currentProjectId) return;
  document.getElementById("share-modal-title").textContent = "Share " + cat.label + " Data";
  document.getElementById("share-url-box").textContent = "Generating link...";
  document.getElementById("share-modal-overlay").classList.add("open");

  // Generate token: store in share_tokens table
  var token = generateToken();
  var expires = new Date();
  expires.setDate(expires.getDate() + 30);

  sb.from("share_tokens").insert({
    token: token,
    project_id: currentProjectId,
    category: catKey,
    created_by: currentUserId,
    expires_at: expires.toISOString()
  }).then(function(res) {
    if (res.error) {
      // Table may not exist yet - show token anyway
      console.warn("share_tokens table missing:", res.error.message);
    }
    var url = window.location.origin + "/share.html?token=" + token;
    shareToken = token;
    document.getElementById("share-url-box").textContent = url;
  });
}

function closeShareModal() {
  document.getElementById("share-modal-overlay").classList.remove("open");
  shareToken = null;
}

function copyShareLink() {
  var box = document.getElementById("share-url-box");
  if (!box) return;
  navigator.clipboard.writeText(box.textContent).then(function() {
    var btn = document.querySelector(".share-copy-btn");
    if (btn) { btn.textContent = "Copied!"; setTimeout(function() { btn.textContent = "Copy Link"; }, 2000); }
  });
}

function generateToken() {
  var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  var token = "";
  for (var i = 0; i < 32; i++) token += chars.charAt(Math.floor(Math.random() * chars.length));
  return token;
}

/* ---- TALLY FORM ---- */
function openCatForm(catKey) {
  var catForms = {
    score_design: CAT_FORM_DESIGN, score_construct: CAT_FORM_CONSTRUCT,
    score_contract: CAT_FORM_CONTRACT, score_intercon: CAT_FORM_INTERCON,
    score_financial: CAT_FORM_FINANCIAL, score_permit: CAT_FORM_PERMIT
  };
  var catLabels = {
    score_design: "Design", score_construct: "Build", score_contract: "Legal",
    score_intercon: "Grid", score_financial: "Finance", score_permit: "Permit"
  };
  var formId = catForms[catKey];
  if (!formId) { alert("This assessment form is not set up yet."); return; }
  var url = "https://tally.so/embed/" + formId + "?transparentBackground=1&hideTitle=1";
  if (currentUserId)    url += "&user_id="    + encodeURIComponent(currentUserId);
  if (currentProjectId) url += "&project_id=" + encodeURIComponent(currentProjectId);
  document.getElementById("ov-tally-title").textContent = catLabels[catKey] + " Assessment";
  document.getElementById("ov-tally-frame").src = url;
  var ov = document.getElementById("ov-tally-overlay");
  ov.style.display = "flex";
  document.body.style.overflow = "hidden";
  startPolling();
}

function closeTallyForm() {
  document.getElementById("ov-tally-overlay").style.display = "none";
  document.getElementById("ov-tally-frame").src = "";
  document.body.style.overflow = "";
  stopPolling();
  reloadProject();
}

function startPolling() {
  stopPolling();
  pollTimer = setInterval(reloadProject, 8000);
}
function stopPolling() {
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}

function reloadProject() {
  if (!currentProjectId || !currentUserId) return;
  sb.from("projects").select("*").eq("id", currentProjectId).eq("user_id", currentUserId).single()
    .then(function(res) {
      if (res.error || !res.data) return;
      currentProject = res.data;
      renderLeft(res.data);
      loadTlDates(res.data);
      // If a cat panel is open, refresh its score band
      if (activeCatKey) {
        var score = currentProject[activeCatKey];
        var color = scoreColor(score);
        var pct   = score != null ? Math.min(100, Math.max(0, score)) : 0;
        var circle = document.querySelector(".cp-score-circle");
        var numEl  = document.querySelector(".cp-score-num");
        var barEl  = document.querySelector(".cp-bar-fill");
        var descEl = document.querySelector(".cp-score-desc");
        if (circle) circle.style.borderColor = color;
        if (numEl)  { numEl.style.color = color; numEl.textContent = score != null ? score : "N/A"; }
        if (barEl)  { barEl.style.width = pct + "%"; barEl.style.background = color; }
        if (descEl) descEl.textContent = score == null ? "Not yet scored" : score >= 70 ? "Good risk profile" : score >= 40 ? "Moderate risk" : "High risk";
      }
    });
}

/* ---- TIMELINE ---- */
function updateTimeline(project) {
  var permitScore   = project.score_permit;
  var designScore   = project.score_design;
  var constructScore = project.score_construct;
  var green  = parseInt(ADMIN_CONFIG["timeline_permit_green"]  || "70");
  var yellow = parseInt(ADMIN_CONFIG["timeline_permit_yellow"] || "40");

  function tlStatus(score) {
    if (score == null) return "grey";
    if (score >= green)  return "green";
    if (score >= yellow) return "yellow";
    return "red";
  }

  function tlLabel(score, stage) {
    if (score == null) return "Not started";
    if (score >= green)  return stage + " complete";
    if (score >= yellow) return "In progress";
    return "Action required";
  }

  setTl("permit",   tlStatus(permitScore),    tlLabel(permitScore,    "Permitting"));
  setTl("design",   tlStatus(designScore),    tlLabel(designScore,    "Engineering"));
  setTl("construct",tlStatus(constructScore), tlLabel(constructScore, "Construction"));

  // COD: green only if all three are green
  var allGreen = tlStatus(permitScore) === "green" && tlStatus(designScore) === "green" && tlStatus(constructScore) === "green";
  var anyStarted = permitScore != null || designScore != null || constructScore != null;
  setTl("cod", allGreen ? "green" : anyStarted ? "grey" : "grey", allGreen ? "Target reached" : "Pending");
}

function setTl(id, status, label) {
  var dot = document.getElementById("tl-" + id);
  var lbl = document.getElementById("tl-" + id + "-status");
  if (dot) {
    dot.className = "tl-dot " + status;
  }
  if (lbl) lbl.textContent = label;
}

function buildCatTimeline(catKey) {
  var milestones = CAT_MILESTONES[catKey] || [];
  if (!milestones.length) return '';
  var steps = milestones.map(function(m, i) {
    var last = i === milestones.length - 1;
    var pb = last ? ' style="padding-bottom:0;"' : '';
    return '<div class="tl-step">' +
      '<div class="tl-dot-wrap"><div class="tl-dot grey" id="ctld-' + m.key + '"></div></div>' +
      '<div class="tl-info"' + pb + '>' +
        '<div class="tl-label" style="font-size:10px;">' + m.label + '</div>' +
        '<div style="display:flex;align-items:center;gap:5px;margin-top:3px;">' +
          '<select class="ctld-status" data-key="' + m.key + '" onchange="saveCatMilestone(\'' + m.key + '\',this.value,document.getElementById(\'' + 'ctld-date-' + m.key + '\').value)" style="font-size:9px;padding:2px 5px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:5px;color:#aaa;font-family:Inter,sans-serif;outline:none;cursor:pointer;">' +
            '<option value="">Not started</option>' +
            '<option value="in_progress">In progress</option>' +
            '<option value="complete">Complete</option>' +
          '</select>' +
          '<input class="ctld-date" id="ctld-date-' + m.key + '" data-key="' + m.key + '" type="date" onchange="saveCatMilestone(\'' + m.key + '\',document.querySelector(\'[data-key=' + m.key + '].ctld-status\').value,this.value)" style="font-size:9px;padding:2px 5px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:5px;color:#aaa;font-family:Inter,sans-serif;outline:none;cursor:pointer;"/>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');
  return '<div class="cp-fields-card">' +
    '<div class="cp-fields-hdr"><span class="cp-fields-title">Milestones</span></div>' +
    '<div style="padding:10px 16px;"><div class="timeline-body" style="padding:0;">' +
    steps +
    '</div></div></div>';
}

/* ---- CATEGORY MILESTONES ---- */
function saveCatMilestone(key, status, date) {
  if (!currentProjectId || !currentUserId) return;
  var tally = Object.assign({}, currentProject.tally_fields || {});
  tally['ms_status_' + key] = status || '';
  tally['ms_date_'   + key] = date   || '';
  currentProject.tally_fields = tally;
  // Update dot colour
  var dot = document.getElementById('ctld-' + key);
  if (dot) {
    dot.className = 'tl-dot ' + (status === 'complete' ? 'green' : status === 'in_progress' ? 'yellow' : 'grey');
  }
  sb.from('projects').update({ tally_fields: tally, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(res) { if (res.error) console.error('Milestone save failed:', res.error.message); });
}

function loadCatMilestones(catKey, project) {
  var milestones = CAT_MILESTONES[catKey] || [];
  var tally = project.tally_fields || {};
  milestones.forEach(function(m) {
    var statusEl = document.querySelector('[data-key="' + m.key + '"].ctld-status');
    var dateEl   = document.getElementById('ctld-date-' + m.key);
    var dot      = document.getElementById('ctld-' + m.key);
    var status   = tally['ms_status_' + m.key] || '';
    var date     = tally['ms_date_'   + m.key] || '';
    if (statusEl) statusEl.value = status;
    if (dateEl)   dateEl.value   = date;
    if (dot) dot.className = 'tl-dot ' + (status === 'complete' ? 'green' : status === 'in_progress' ? 'yellow' : 'grey');
  });
}

/* ---- TIMELINE DATES ---- */
function saveTlDate(milestone, value) {
  if (!currentProjectId || !currentUserId) return;
  var field = 'tl_date_' + milestone;
  var tally = Object.assign({}, currentProject.tally_fields || {});
  tally[field] = value;
  currentProject.tally_fields = tally;
  sb.from('projects').update({ tally_fields: tally, updated_at: new Date().toISOString() })
    .eq('id', currentProjectId).eq('user_id', currentUserId)
    .then(function(res) {
      if (res.error) console.error('Date save failed:', res.error.message);
    });
}

function loadTlDates(project) {
  var tally = project.tally_fields || {};
  var milestones = ['permit','design','construct','cod'];
  milestones.forEach(function(m) {
    var el = document.getElementById('tl-' + m + '-date');
    if (el && tally['tl_date_' + m]) el.value = tally['tl_date_' + m];
  });
}

/* ---- AUTH & DATA ---- */
var authTimeout = setTimeout(function() {
  if (!authResolved) window.location.href = "login.html";
}, 6000);

sb.auth.onAuthStateChange(function(event, session) {
  if (session && session.user) {
    authResolved = true;
    clearTimeout(authTimeout);
    document.body.classList.remove("hidden");
    currentUserId = session.user.id;
    loadProject(session.user.id);
  } else if (event === "SIGNED_OUT") {
    window.location.href = "login.html";
  }
});

function loadProject(userId) {
  var params = new URLSearchParams(window.location.search);
  var projectId = params.get("id");
  if (!projectId) { window.location.href = "dashboard.html"; return; }
  sb.from("projects").select("*").eq("id", projectId).eq("user_id", userId).single()
    .then(function(res) {
      if (res.error || !res.data) { window.location.href = "dashboard.html"; return; }
      var p = res.data;
      currentProject   = p;
      currentProjectId = p.id;
      var stageShort = (p.stage || "").replace(/\s*\(.*?\)/g, "").trim();
      stageShort = stageShort.split(" - ").map(function(s) {
        return s.replace(/\s*\(.*?\)/g, "").trim();
      }).join(" - ");
      document.getElementById("hero-name").textContent = p.name || "Unnamed Project";
      document.getElementById("hero-sub").textContent = [
        p.capacity_mw ? p.capacity_mw + " MWp" : null,
        stageShort || null
      ].filter(Boolean).join("  -  ");
      document.getElementById("inf-capacity").textContent = p.capacity_mw ? p.capacity_mw + " MWp" : "-";
      document.getElementById("inf-stage").textContent    = stageShort || "-";
      document.getElementById("inf-status").textContent   = (p.status || "-").replace(/-/g, " ");
      document.getElementById("inf-date").textContent     = new Date(p.created_at).toLocaleDateString("en-GB", {day:"2-digit",month:"short",year:"numeric"});
      var locEl = document.getElementById("inf-location");
      if (p.location && p.location.startsWith("http")) {
        locEl.innerHTML = '<a href="' + p.location + '" target="_blank">Maps</a>';
      } else {
        locEl.textContent = p.location || "-";
      }
      document.getElementById("info-card").style.display = "block";
      renderLeft(p);
      loadTlDates(p);
      loadDocsMini();
      generateSummary(false);
    });
}

/* =============================================
   DOCUMENT PANEL
   ============================================= */
var docPanelOpen = false;
var projectDocuments = [];

function openDocPanel() {
  // Close cat panel if open
  closeCatPanel && closeCatPanel();
  document.getElementById("main-overview").style.display = "none";
  document.getElementById("cat-panel").classList.remove("open");
  document.getElementById("doc-panel").classList.add("open");
  docPanelOpen = true;
  loadDocuments();
}

function closeDocPanel() {
  document.getElementById("doc-panel").classList.remove("open");
  document.getElementById("main-overview").style.display = "block";
  docPanelOpen = false;
}

function docFileExt(name) {
  return (name.split('.').pop() || '').toLowerCase();
}

function docIconInfo(name) {
  var ext = docFileExt(name);
  if (['pdf'].includes(ext))                         return { cls:'pdf', icon:'📄' };
  if (['jpg','jpeg','png','gif','webp','svg'].includes(ext)) return { cls:'img', icon:'🖼️' };
  if (['xls','xlsx','csv'].includes(ext))             return { cls:'xls', icon:'📊' };
  if (['doc','docx'].includes(ext))                   return { cls:'doc', icon:'📝' };
  return { cls:'other', icon:'📎' };
}

function fmtBytes(b) {
  if (!b) return '';
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}

function fmtDate(iso) {
  return new Date(iso).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
}

function TAG_LABELS() {
  return { alta:'ALTA Survey', environmental:'Environmental', geotech:'Geotech', ppa:'PPA',
    land:'Land Agreement', epc:'EPC Contract', interconnection:'Interconnection',
    permitting:'Permitting', financial:'Financial Model', energy:'Energy Report',
    procurement:'Procurement', insurance:'Insurance', general:'General', other:'Other' };
}

function loadDocuments() {
  if (!currentProjectId || !currentUserId) return;
  var body = document.getElementById('dp-docs-body');
  if (body) body.innerHTML = '<div class="dp-empty" style="color:#888;">Loading...</div>';

  sb.from('project_documents')
    .select('*')
    .eq('project_id', currentProjectId)
    .order('created_at', { ascending: false })
    .then(function(res) {
      if (res.error) { console.error('Doc load error:', res.error); return; }
      projectDocuments = res.data || [];
      renderDocList();
      renderMiniList();
    });
}

function renderDocList() {
  var body = document.getElementById('dp-docs-body');
  var count = document.getElementById('dp-docs-count');
  if (!body) return;
  if (count) count.textContent = projectDocuments.length ? projectDocuments.length + ' file' + (projectDocuments.length !== 1 ? 's' : '') : '';

  if (!projectDocuments.length) {
    body.innerHTML = '<div class="dp-empty">No documents uploaded yet.<br>Use the upload zone above to add your first file.</div>';
    return;
  }

  var tags = TAG_LABELS();
  body.innerHTML = projectDocuments.map(function(doc) {
    var inf = docIconInfo(doc.file_name);
    var tagLabel = tags[doc.tag] || doc.tag || 'General';
    return '<div class="dp-doc-row" id="docrow-' + doc.id + '" onclick="previewDoc(\'' + doc.id + '\')">' +
      '<div class="dp-doc-icon ' + inf.cls + '">' + inf.icon + '</div>' +
      '<div class="dp-doc-info">' +
        '<div class="dp-doc-name">' + escHtml(doc.file_name) + '<span class="dp-doc-tag">' + escHtml(tagLabel) + '</span></div>' +
        '<div class="dp-doc-meta">' + fmtBytes(doc.file_size) + ' &nbsp;·&nbsp; ' + fmtDate(doc.created_at) + '</div>' +
      '</div>' +
      '<div class="dp-doc-actions" onclick="event.stopPropagation()">' +
        '<button class="dp-doc-dl" onclick="downloadDoc(\'' + doc.id + '\')">Download</button>' +
        '<button class="dp-doc-rm" onclick="removeDoc(\'' + doc.id + '\', \'' + escHtml(doc.file_name) + '\')">Remove</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

function renderMiniList() {
  var list   = document.getElementById('upload-mini-list');
  var empty  = document.getElementById('upload-mini-empty');
  if (!list) return;
  // Remove all items except empty msg
  Array.from(list.querySelectorAll('.upload-doc-item')).forEach(function(el) { el.remove(); });
  if (!projectDocuments.length) {
    if (empty) empty.style.display = 'block';
    return;
  }
  if (empty) empty.style.display = 'none';
  // Show up to 3 most recent
  projectDocuments.slice(0, 3).forEach(function(doc) {
    var tags = TAG_LABELS();
    var item = document.createElement('div');
    item.className = 'upload-doc-item';
    item.innerHTML =
      '<span class="upload-doc-name" title="' + escHtml(doc.file_name) + '">' + escHtml(doc.file_name) + '</span>' +
      '<span class="upload-doc-type">' + escHtml((tags[doc.tag] || doc.tag || 'File').split(' ')[0]) + '</span>' +
      '<button class="upload-doc-view" onclick="openDocPanel()">View</button>';
    list.insertBefore(item, list.firstChild);
  });
}

function escHtml(str) {
  return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('dp-dropzone').classList.remove('drag-over');
  var files = e.dataTransfer.files;
  if (files && files.length) handleFileSelect(files);
}

function handleFileSelect(files) {
  if (!files || !files.length) return;
  var file = files[0];
  if (file.size > 52428800) { showDocErr('File exceeds 50 MB limit.'); return; }
  uploadDoc(file);
}

function showDocErr(msg) {
  var el = document.getElementById('dp-upload-err');
  if (!el) return;
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(function() { el.style.display = 'none'; }, 4000);
}

function uploadDoc(file) {
  if (!currentProjectId || !currentUserId) return;
  var tag      = document.getElementById('dp-tag-select').value;
  var progress = document.getElementById('dp-upload-progress');
  var fill     = document.getElementById('dp-progress-fill');
  var txt      = document.getElementById('dp-progress-text');
  var errEl    = document.getElementById('dp-upload-err');

  errEl.style.display  = 'none';
  progress.style.display = 'flex';
  fill.style.width = '10%';
  txt.textContent = 'Uploading...';

  // Path: project_docs/{project_id}/{timestamp}_{filename}
  var safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
  var path = currentProjectId + '/' + Date.now() + '_' + safeName;

  sb.storage.from('project_docs').upload(path, file, { upsert: false })
    .then(function(res) {
      if (res.error) { progress.style.display='none'; showDocErr('Upload failed: ' + res.error.message); return; }
      fill.style.width = '70%';
      txt.textContent = 'Saving record...';

      // Get public URL
      var urlRes = sb.storage.from('project_docs').getPublicUrl(path);
      var publicUrl = urlRes.data && urlRes.data.publicUrl ? urlRes.data.publicUrl : '';

      return sb.from('project_documents').insert({
        project_id: currentProjectId,
        user_id:    currentUserId,
        file_name:  file.name,
        file_path:  path,
        file_size:  file.size,
        file_type:  file.type || 'application/octet-stream',
        tag:        tag,
        public_url: publicUrl
      });
    })
    .then(function(res) {
      if (!res) return;
      if (res.error) { progress.style.display='none'; showDocErr('Record save failed: ' + res.error.message); return; }
      fill.style.width = '100%';
      txt.textContent  = 'Done!';
      setTimeout(function() {
        progress.style.display = 'none';
        fill.style.width = '0%';
        document.getElementById('dp-file-input').value = '';
      }, 800);
      loadDocuments();
    })
    .catch(function(err) {
      progress.style.display = 'none';
      showDocErr('Error: ' + err.message);
    });
}

function downloadDoc(docId) {
  var doc = projectDocuments.find(function(d) { return d.id === docId; });
  if (!doc) return;
  if (doc.public_url) { window.open(doc.public_url, '_blank'); return; }
  sb.storage.from('project_docs').createSignedUrl(doc.file_path, 3600)
    .then(function(res) {
      if (res.data && res.data.signedUrl) window.open(res.data.signedUrl, '_blank');
    });
}

function removeDoc(docId, fileName) {
  if (!confirm('Remove "' + fileName + '" from this project?')) return;
  var doc = projectDocuments.find(function(d) { return d.id === docId; });
  var row = document.getElementById('docrow-' + docId);
  if (row) { row.style.opacity = '0.4'; row.style.pointerEvents = 'none'; }

  var deleteStorage = doc && doc.file_path
    ? sb.storage.from('project_docs').remove([doc.file_path])
    : Promise.resolve({ error: null });

  deleteStorage.then(function() {
    return sb.from('project_documents').delete().eq('id', docId).eq('user_id', currentUserId);
  }).then(function(res) {
    if (res && res.error) { alert('Remove failed: ' + res.error.message); if (row) { row.style.opacity='1'; row.style.pointerEvents=''; } return; }
    // Close preview if this doc was being shown
    var previewCard = document.getElementById('dp-preview-card');
    if (previewCard && previewCard.dataset.docId === docId) closePreview();
    loadDocuments();
  }).catch(function(err) {
    alert('Error: ' + err.message);
    if (row) { row.style.opacity='1'; row.style.pointerEvents=''; }
  });
}

function previewDoc(docId) {
  var doc = projectDocuments.find(function(d) { return d.id === docId; });
  if (!doc) return;

  // Highlight active row
  document.querySelectorAll('.dp-doc-row').forEach(function(r) { r.classList.remove('active'); });
  var row = document.getElementById('docrow-' + docId);
  if (row) row.classList.add('active');

  var card  = document.getElementById('dp-preview-card');
  var name  = document.getElementById('dp-preview-name');
  var body  = document.getElementById('dp-preview-body');
  card.style.display = 'block';
  card.dataset.docId = docId;
  name.textContent   = doc.file_name;

  var ext = docFileExt(doc.file_name);
  var url = doc.public_url;

  var canEmbed = ['pdf','jpg','jpeg','png','gif','webp','svg'].includes(ext);

  if (url && canEmbed) {
    if (ext === 'pdf') {
      body.innerHTML = '<iframe class="dp-preview-iframe" src="' + escHtml(url) + '#toolbar=0" title="' + escHtml(doc.file_name) + '"></iframe>';
    } else {
      body.innerHTML = '<div style="padding:16px;text-align:center;background:#fff;"><img src="' + escHtml(url) + '" style="max-width:100%;max-height:500px;border-radius:6px;" alt="' + escHtml(doc.file_name) + '"/></div>';
    }
  } else {
    body.innerHTML = '<div class="dp-preview-nopreview"><p>Preview not available for this file type.</p>' +
      '<button class="dp-preview-dl-big" onclick="downloadDoc(\'' + docId + '\')">&#8681; Download File</button></div>';
  }

  // Scroll preview into view
  setTimeout(function() { card.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
}

function closePreview() {
  var card = document.getElementById('dp-preview-card');
  if (card) { card.style.display='none'; card.dataset.docId=''; }
  document.querySelectorAll('.dp-doc-row').forEach(function(r) { r.classList.remove('active'); });
}

// Load docs on page load (for mini list in overview)
function loadDocsMini() {
  if (!currentProjectId || !currentUserId) return;
  sb.from('project_documents')
    .select('id, file_name, tag, created_at')
    .eq('project_id', currentProjectId)
    .order('created_at', { ascending: false })
    .limit(3)
    .then(function(res) {
      if (res.error) return;
      projectDocuments = res.data || [];
      renderMiniList();
    });
}

function generateSummary(forceRegen) {
  if (!currentProjectId || !currentUserId) return;
  if (summaryRunning && !forceRegen) return;
  summaryRunning = true;
  var contentEl = document.getElementById("ai-content");
  var regenBtn  = document.getElementById("btn-regen");
  contentEl.innerHTML = '<div class="ai-loading"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div><span>' + (forceRegen ? "Regenerating..." : "Generating brief...") + "</span></div>";
  regenBtn.style.display = "none";
  function callEdge() {
    fetch(SUPABASE_URL + "/functions/v1/generate-overview", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ project_id: currentProjectId, user_id: currentUserId, force: forceRegen })
    })
    .then(function(r) { if (!r.ok) return r.text().then(function(t) { throw new Error("HTTP " + r.status + ": " + t); }); return r.json(); })
    .then(function(data) {
      summaryRunning = false;
      if (data.error) {
        contentEl.innerHTML = '<div class="ai-error">Error: ' + data.error + "</div>";
      } else {
        var paras = (data.summary || "").split(/\n+/).filter(function(p) { return p.trim(); });
        contentEl.innerHTML = '<div class="ai-text">' + paras.map(function(p) { return "<p>" + p.trim() + "</p>"; }).join("") + "</div>";
      }
      regenBtn.style.display = "inline-block";
    })
    .catch(function(err) {
      summaryRunning = false;
      contentEl.innerHTML = '<div class="ai-error">Error: ' + err.message + "</div>";
      regenBtn.style.display = "inline-block";
    });
  }
  if (forceRegen) {
    sb.from("projects").update({ ai_summary: null, ai_summary_at: null }).eq("id", currentProjectId)
      .then(function() { callEdge(); }).catch(function() { callEdge(); });
  } else { callEdge(); }
}
</script>
<script type="text/javascript">window.$crisp=[];window.CRISP_WEBSITE_ID="49df8fc4-e9b9-4f8d-b357-680e84e62c67";(function(){d=document;s=d.createElement("script");s.src="https://client.crisp.chat/l.js";s.async=1;d.getElementsByTagName("head")[0].appendChild(s);})();</script>
</body>
</html>
