<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash - Project Overview</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #eef0f4; color: #1a1f2e; min-height: 100vh; }
body.hidden { visibility: hidden; }
a { text-decoration: none; }
.topbar { position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; background: #111; border-bottom: 3px solid #FFFF00; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
.logo { font-size: 22px; font-weight: 900; letter-spacing: 0.3px; text-transform: uppercase; color: #fff; }
.logo span { color: #FFFF00; }
.tb-right { display: flex; align-items: center; gap: 10px; }
.btn-back { padding: 7px 16px; border: none; background: rgba(255,255,255,0.1); color: #aaa; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; text-transform: uppercase; border-radius: 20px; cursor: pointer; }
.btn-back:hover { background: rgba(255,255,255,0.2); color: #fff; }
.btn-out { background: none; border: 1px solid #444; color: #777; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; padding: 7px 14px; cursor: pointer; text-transform: uppercase; border-radius: 20px; }
.btn-out:hover { border-color: #E83535; color: #E83535; }
.page { padding-top: 56px; }
.hero { background: #111; padding: 20px 14px 18px; }
.hero-tag { font-size: 10px; font-weight: 700; letter-spacing: 0.6px; text-transform: uppercase; color: #FFFF00; margin-bottom: 5px; opacity: 0.8; }
.hero h1 { font-size: 28px; font-weight: 900; letter-spacing: -0.8px; color: #fff; line-height: 1; }
.hero-sub { font-size: 12px; color: #555; margin-top: 5px; }

/* 3-column layout */
.layout { display: grid; grid-template-columns: 210px 1fr 210px; gap: 10px; padding: 12px 12px 60px; align-items: start; }

/* LEFT COLUMN */
.left-col { display: flex; flex-direction: column; gap: 8px; }
.score-card { background: #1a1f2e; border-radius: 12px; padding: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); text-align: center; }
.score-card-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #FFFF00; opacity: 0.7; margin-bottom: 8px; }
.score-ring { width: 72px; height: 72px; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.06); border: 3px solid rgba(255,255,255,0.08); }
.score-ring-val { font-size: 26px; font-weight: 900; color: #fff; letter-spacing: -1px; line-height: 1; }
.score-ring-sub { font-size: 9px; color: #555; margin-top: 1px; }
.score-ring-none { font-size: 11px; color: #444; font-weight: 600; }
.score-card-desc { font-size: 10px; color: #444; line-height: 1.5; }

/* Category items */
.cat-item { background: #dde1ea; border-radius: 10px; padding: 9px 11px; box-shadow: 0 1px 5px rgba(0,0,0,0.06); transition: transform .12s, box-shadow .12s; }
.cat-item:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
.cat-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.cat-name { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.3px; color: #1a1f2e; }
.cat-score-lbl { font-size: 9px; font-weight: 700; color: #6b7585; }
.cat-bar-track { height: 3px; background: rgba(0,0,0,0.1); border-radius: 2px; overflow: hidden; margin-bottom: 7px; }
.cat-bar-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }
.cat-btn-row { display: grid; gap: 5px; }
.cat-btn-row.two { grid-template-columns: 1fr 1fr; }
.cat-start-btn { display: block; width: 100%; padding: 4px 6px; background: rgba(255,255,255,0.55); border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #1a1f2e; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.cat-start-btn:hover { background: #1a1f2e; color: #FFFF00; }
.cat-view-btn { display: block; width: 100%; padding: 4px 6px; background: #1a1f2e; border: none; border-radius: 20px; font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: #FFFF00; cursor: pointer; text-align: center; text-transform: uppercase; letter-spacing: 0.2px; transition: all .12s; }
.cat-view-btn:hover { background: #FFFF00; color: #1a1f2e; }

/* CENTRE COLUMN */
.main { display: flex; flex-direction: column; gap: 10px; min-width: 0; }
.ov-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.ov-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.ov-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.ov-card-body { padding: 10px 14px; }
.info-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 7px; }
.info-row { background: rgba(255,255,255,0.5); border-radius: 7px; padding: 7px 9px; }
.info-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #6b7585; margin-bottom: 3px; letter-spacing: 0.3px; }
.info-val { font-size: 11px; font-weight: 700; color: #1a1f2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.info-val a { color: #1a1f2e; text-decoration: underline; }
.ai-card { background: #1a1f2e; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 14px rgba(0,0,0,0.12); }
.ai-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: space-between; }
.ai-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: #FFFF00; opacity: 0.8; }
.ai-model { font-size: 9px; color: #444; font-weight: 500; }
.ai-card-body { padding: 14px; }
.ai-text { font-size: 12px; color: #bbb; line-height: 1.75; }
.ai-text p { margin-bottom: 10px; }
.ai-text p:last-child { margin-bottom: 0; }
.ai-loading { display: flex; align-items: center; gap: 8px; color: #555; font-size: 12px; }
.ai-dot { width: 5px; height: 5px; border-radius: 50%; background: #FFFF00; animation: pulse 1.2s ease-in-out infinite; }
.ai-dot:nth-child(2) { animation-delay: 0.2s; }
.ai-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes pulse { 0%,80%,100%{ opacity:0.2; transform:scale(0.8); } 40%{ opacity:1; transform:scale(1.1); } }
.ai-error { font-size: 12px; color: #e74c3c; }
.btn-regen { padding: 3px 10px; border: 1px solid #333; background: none; color: #555; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 600; cursor: pointer; border-radius: 20px; }
.btn-regen:hover { border-color: #FFFF00; color: #FFFF00; }
.coming-soon { background: #dde1ea; border-radius: 12px; padding: 22px 18px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.coming-soon h2 { font-size: 17px; font-weight: 900; letter-spacing: -0.3px; margin-bottom: 5px; }
.coming-soon p { font-size: 12px; color: #6b7585; line-height: 1.6; max-width: 360px; margin: 0 auto 14px; }
.btn-big { display: inline-block; padding: 9px 20px; background: #1a1f2e; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; cursor: pointer; border-radius: 30px; border: none; }
.btn-big:hover { background: #FFFF00; color: #1a1f2e; }

/* RIGHT COLUMN */
.right-col { display: flex; flex-direction: column; gap: 8px; }
.lock-card { background: #dde1ea; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
.lock-card-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; justify-content: space-between; }
.lock-card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.lock-icon { font-size: 13px; opacity: 0.35; }
.lock-card-body { padding: 20px 14px; }
.lock-overlay { display: flex; flex-direction: column; align-items: center; text-align: center; gap: 10px; }
.lock-svg { width: 28px; height: 28px; opacity: 0.2; }
.lock-msg { font-size: 11px; color: #6b7585; line-height: 1.5; max-width: 160px; }
.lock-req { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #aaa; background: rgba(0,0,0,0.07); padding: 3px 9px; border-radius: 20px; }

/* DRAWER */
.drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 200; opacity: 0; pointer-events: none; transition: opacity .25s; }
.drawer-overlay.open { opacity: 1; pointer-events: all; }
.drawer { position: fixed; top: 56px; right: 0; bottom: 0; width: 420px; max-width: 92vw; background: #eef0f4; z-index: 201; transform: translateX(100%); transition: transform .28s cubic-bezier(.4,0,.2,1); display: flex; flex-direction: column; box-shadow: -4px 0 24px rgba(0,0,0,0.14); }
.drawer.open { transform: translateX(0); }
.drawer-hdr { padding: 16px 18px 14px; background: #1a1f2e; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
.drawer-title { font-size: 14px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.4px; color: #fff; }
.drawer-close { background: rgba(255,255,255,0.1); border: none; color: #aaa; font-size: 18px; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all .12s; }
.drawer-close:hover { background: rgba(255,255,255,0.2); color: #fff; }
.drawer-body { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }

/* Drawer score band */
.drawer-score-band { background: #1a1f2e; border-radius: 10px; padding: 14px 16px; display: flex; align-items: center; gap: 16px; }
.drawer-score-circle { width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 3px solid rgba(255,255,255,0.1); }
.drawer-score-num { font-size: 20px; font-weight: 900; color: #fff; line-height: 1; }
.drawer-score-info { flex: 1; }
.drawer-score-label { font-size: 10px; font-weight: 700; color: #FFFF00; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 4px; }
.drawer-score-date { font-size: 11px; color: #555; }
.drawer-score-bar-track { height: 4px; background: rgba(255,255,255,0.08); border-radius: 2px; margin-top: 6px; overflow: hidden; }
.drawer-score-bar-fill { height: 100%; border-radius: 2px; }

/* Drawer sections */
.drawer-section { background: #dde1ea; border-radius: 10px; overflow: hidden; }
.drawer-section-hdr { padding: 10px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; gap: 8px; }
.drawer-section-icon { font-size: 13px; }
.drawer-section-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #5a6474; }
.drawer-section-body { padding: 12px 14px; display: flex; flex-direction: column; gap: 7px; }
.drawer-field { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
.drawer-field-lbl { font-size: 11px; color: #6b7585; flex: 1; }
.drawer-field-val { font-size: 11px; font-weight: 700; color: #1a1f2e; text-align: right; max-width: 55%; }
.drawer-missing-item { display: flex; align-items: flex-start; gap: 8px; padding: 7px 0; border-bottom: 1px solid rgba(0,0,0,0.06); }
.drawer-missing-item:last-child { border-bottom: none; }
.drawer-missing-dot { width: 6px; height: 6px; border-radius: 50%; background: #e07b20; flex-shrink: 0; margin-top: 4px; }
.drawer-missing-text { font-size: 11px; color: #1a1f2e; line-height: 1.5; }
.drawer-missing-impact { font-size: 10px; color: #6b7585; margin-top: 2px; }
.drawer-all-good { font-size: 12px; color: #2e7d4f; font-weight: 600; text-align: center; padding: 8px 0; }

/* Drawer footer */
.drawer-footer { padding: 14px 16px; background: #dde1ea; border-top: 1px solid rgba(0,0,0,0.07); display: flex; gap: 8px; flex-shrink: 0; }
.drawer-btn-retake { flex: 1; padding: 10px; background: #1a1f2e; border: none; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; cursor: pointer; border-radius: 20px; transition: all .12s; }
.drawer-btn-retake:hover { background: #FFFF00; color: #1a1f2e; }
.drawer-btn-close { padding: 10px 16px; background: rgba(0,0,0,0.08); border: none; color: #6b7585; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.drawer-btn-close:hover { background: rgba(0,0,0,0.14); color: #1a1f2e; }

@media(max-width:900px){
  .layout { grid-template-columns: 1fr; }
  .left-col, .right-col { display: grid; grid-template-columns: repeat(3,1fr); }
  .score-card { grid-column: 1 / -1; }
  .info-grid { grid-template-columns: repeat(3,1fr); }
  .drawer { width: 100%; max-width: 100%; top: 56px; }
}
</style>
</head>
<body class="hidden">

<!-- Drawer overlay -->
<div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawer()"></div>

<!-- Category detail drawer -->
<div class="drawer" id="drawer">
  <div class="drawer-hdr">
    <span class="drawer-title" id="drawer-title">Category</span>
    <button class="drawer-close" onclick="closeDrawer()">&#215;</button>
  </div>
  <div class="drawer-body" id="drawer-body"></div>
  <div class="drawer-footer">
    <button class="drawer-btn-retake" id="drawer-btn-retake">Retake Assessment</button>
    <button class="drawer-btn-close" onclick="closeDrawer()">Close</button>
  </div>
</div>

<div class="topbar">
  <a href="dashboard.html" class="logo">Sun<span>Hash</span></a>
  <div class="tb-right">
    <a href="dashboard.html" class="btn-back">Back to Dashboard</a>
    <button class="btn-out" onclick="sb.auth.signOut().then(function(){ window.location.href='login.html'; })">Sign Out</button>
  </div>
</div>

<div class="page">
  <div class="hero">
    <div class="hero-tag">Project Overview</div>
    <h1 id="hero-name">Loading...</h1>
    <div class="hero-sub" id="hero-sub"></div>
  </div>

  <div class="layout">

    <!-- LEFT -->
    <div class="left-col">
      <div class="score-card">
        <div class="score-card-lbl">Overall Risk Score</div>
        <div class="score-ring" id="score-ring">
          <div class="score-ring-none">N/A</div>
        </div>
        <div class="score-card-desc" id="score-card-desc">Complete at least one assessment to generate a score.</div>
      </div>
      <div id="sidebar" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>

    <!-- Tally form overlay (same pattern as dashboard) -->
<div id="ov-tally-overlay" style="display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.85);flex-direction:column;">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#111;border-bottom:2px solid #FFFF00;flex-shrink:0;">
    <span style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;color:#FFFF00;" id="ov-tally-title">Assessment</span>
    <button onclick="closeTallyForm()" style="background:rgba(255,255,255,0.1);border:none;color:#aaa;font-size:18px;width:30px;height:30px;border-radius:50%;cursor:pointer;">&#215;</button>
  </div>
  <iframe id="ov-tally-frame" src="" title="Assessment Form" style="flex:1;border:none;width:100%;background:#fff;"></iframe>
</div>

<!-- CENTRE -->
    <div class="main">
      <div class="ov-card" id="info-card" style="display:none;">
        <div class="ov-card-hdr"><span class="ov-card-title">Project Details</span></div>
        <div class="ov-card-body">
          <div class="info-grid">
            <div class="info-row"><div class="info-lbl">Location</div><div class="info-val" id="inf-location">-</div></div>
            <div class="info-row"><div class="info-lbl">Capacity</div><div class="info-val" id="inf-capacity">-</div></div>
            <div class="info-row"><div class="info-lbl">Stage</div><div class="info-val" id="inf-stage">-</div></div>
            <div class="info-row"><div class="info-lbl">Status</div><div class="info-val" id="inf-status">-</div></div>
            <div class="info-row"><div class="info-lbl">Created</div><div class="info-val" id="inf-date">-</div></div>
          </div>
        </div>
      </div>

      <div class="ai-card">
        <div class="ai-card-hdr">
          <span class="ai-label">AI Project Brief</span>
          <div style="display:flex;align-items:center;gap:6px;">
            <span class="ai-model">gpt-4o-mini</span>
            <button class="btn-regen" id="btn-regen" onclick="generateSummary(true)" style="display:none;">Regenerate</button>
          </div>
        </div>
        <div class="ai-card-body">
          <div id="ai-content">
            <div class="ai-loading"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div><span>Loading...</span></div>
          </div>
        </div>
      </div>

      <div class="coming-soon">
        <h2>Full Report Coming Soon</h2>
        <p>Complete risk scores, critical issues, and a prioritised action plan across all six categories.</p>
        <a href="dashboard.html" class="btn-big">Back to Dashboard</a>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right-col">

      <div class="lock-card">
        <div class="lock-card-hdr">
          <span class="lock-card-title">Critical Issues</span>
          <span class="lock-icon" id="icon-issues">&#128274;</span>
        </div>
        <div class="lock-card-body" id="body-issues">
          <div class="lock-overlay">
            <svg class="lock-svg" viewBox="0 0 24 24" fill="none" stroke="#1a1f2e" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <div class="lock-msg">Unlocks after the first assessment is completed.</div>
            <span class="lock-req">Requires 1+ assessment</span>
          </div>
        </div>
      </div>

      <div class="lock-card">
        <div class="lock-card-hdr">
          <span class="lock-card-title">Action Plan</span>
          <span class="lock-icon" id="icon-actions">&#128274;</span>
        </div>
        <div class="lock-card-body" id="body-actions">
          <div class="lock-overlay">
            <svg class="lock-svg" viewBox="0 0 24 24" fill="none" stroke="#1a1f2e" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <div class="lock-msg">Unlocks after the first assessment is completed.</div>
            <span class="lock-req">Requires 1+ assessment</span>
          </div>
        </div>
      </div>

      <div class="lock-card">
        <div class="lock-card-hdr">
          <span class="lock-card-title">Scenario Analysis</span>
          <span class="lock-icon" id="icon-scenario">&#128274;</span>
        </div>
        <div class="lock-card-body" id="body-scenario">
          <div class="lock-overlay">
            <svg class="lock-svg" viewBox="0 0 24 24" fill="none" stroke="#1a1f2e" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <div class="lock-msg">Unlocks after 2 or more assessments are completed.</div>
            <span class="lock-req">Requires 2+ assessments</span>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";

// Category Tally form IDs - keep in sync with dashboard.html
var CAT_FORM_DESIGN    = "1ArXEg";  // Design & Engineering
var CAT_FORM_CONSTRUCT = "0QEdP9";  // Construction
var CAT_FORM_CONTRACT  = "D4VBel";  // Contract & Legal
var CAT_FORM_INTERCON  = "Gxr6Le";  // Interconnection
var CAT_FORM_FINANCIAL = "rjl5Vo";  // Financial
var CAT_FORM_PERMIT    = "xXdr2d";  // Permitting
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

var currentProjectId = null;
var currentUserId = null;
var authResolved = false;
var summaryRunning = false;
var currentProject = null;

var CATEGORIES = [
  {
    key: "score_design", label: "Design",
    fields: [
      { lbl: "Technology type",   field: "technology_type" },
      { lbl: "Module brand",      field: "module_brand" },
      { lbl: "Inverter type",     field: "inverter_type" },
      { lbl: "Mounting system",   field: "mounting_system" },
      { lbl: "Single-line diagram", field: "single_line_diagram" }
    ],
    missing: [
      { text: "Single-line diagram not uploaded", impact: "Reduces Design score reliability" },
      { text: "Inverter specifications missing",  impact: "Cannot validate yield assumptions" },
      { text: "Structural engineering report",    impact: "Required for grid connection approval" }
    ]
  },
  {
    key: "score_construct", label: "Build",
    fields: [
      { lbl: "EPC contractor",    field: "epc_contractor" },
      { lbl: "Construction start", field: "construction_start" },
      { lbl: "Construction end",  field: "construction_end" },
      { lbl: "Performance bond",  field: "performance_bond" }
    ],
    missing: [
      { text: "EPC contract not finalised",       impact: "Key Build risk factor unverified" },
      { text: "Performance bond not confirmed",   impact: "Completion risk unmitigated" }
    ]
  },
  {
    key: "score_contract", label: "Legal",
    fields: [
      { lbl: "Land ownership",    field: "land_ownership" },
      { lbl: "Land lease term",   field: "land_lease_term" },
      { lbl: "PPA status",        field: "ppa_status" },
      { lbl: "PPA counterparty",  field: "ppa_counterparty" },
      { lbl: "Legal counsel",     field: "legal_counsel" }
    ],
    missing: [
      { text: "PPA not yet signed",               impact: "Revenue risk unmitigated" },
      { text: "Land lease term under 25 years",   impact: "May not cover full project life" }
    ]
  },
  {
    key: "score_intercon", label: "Grid",
    fields: [
      { lbl: "Grid operator",     field: "grid_operator" },
      { lbl: "Connection voltage", field: "connection_voltage" },
      { lbl: "Connection study",  field: "grid_connection_study" },
      { lbl: "Offer accepted",    field: "grid_offer_accepted" }
    ],
    missing: [
      { text: "Grid connection study not complete", impact: "Cannot confirm capacity or costs" },
      { text: "Grid offer not yet accepted",        impact: "Connection timeline uncertain" }
    ]
  },
  {
    key: "score_financial", label: "Finance",
    fields: [
      { lbl: "Financial model",   field: "financial_model" },
      { lbl: "Equity source",     field: "equity_source" },
      { lbl: "Debt source",       field: "debt_source" },
      { lbl: "IRR (unlevered)",   field: "irr_unlevered" },
      { lbl: "DSCR",              field: "dscr" }
    ],
    missing: [
      { text: "Financial model not uploaded",     impact: "Cannot validate return assumptions" },
      { text: "Debt terms not confirmed",         impact: "Financing risk unmitigated" }
    ]
  },
  {
    key: "score_permit", label: "Permit",
    fields: [
      { lbl: "Environmental study", field: "environmental_study" },
      { lbl: "Planning permit",   field: "planning_permit" },
      { lbl: "Grid permit",       field: "grid_permit" },
      { lbl: "Building permit",   field: "building_permit" }
    ],
    missing: [
      { text: "Environmental impact study pending", impact: "May delay planning decision" },
      { text: "Grid permit not yet issued",         impact: "Connection cannot proceed without it" }
    ]
  }
];

function scoreColor(s) {
  if (s == null) return "rgba(0,0,0,0.12)";
  if (s >= 70) return "#2e7d4f";
  if (s >= 40) return "#e07b20";
  return "#c0392b";
}

function renderLeft(project) {
  var overall = project.score_overall;
  var ringEl = document.getElementById("score-ring");
  var descEl = document.getElementById("score-card-desc");

  if (overall != null) {
    var color = scoreColor(overall);
    ringEl.style.border = "3px solid " + color;
    ringEl.style.background = "rgba(0,0,0,0.15)";
    ringEl.innerHTML =
      '<div><div class="score-ring-val" style="color:' + color + '">' + overall + '</div>' +
      '<div class="score-ring-sub">/100</div></div>';
    descEl.textContent = overall >= 70 ? "Good overall risk profile." :
                         overall >= 40 ? "Moderate risk - review flagged categories." :
                                         "High risk - action required.";
  }

  var sidebarEl = document.getElementById("sidebar");
  sidebarEl.innerHTML = "";
  var scoredCount = 0;

  CATEGORIES.forEach(function(cat) {
    var score = project[cat.key];
    var hasScore = score != null;
    if (hasScore) scoredCount++;
    var pct = hasScore ? Math.min(100, Math.max(0, score)) : 0;
    var color = scoreColor(score);
    var lbl = hasScore ? score + "/100" : "--";

    var item = document.createElement("div");
    item.className = "cat-item";

    var btnRow = hasScore
      ? '<div class="cat-btn-row two">' +
          '<button class="cat-view-btn" onclick="openDrawer(\'' + cat.key + '\')">View</button>' +
          '<button class="cat-start-btn" onclick="openCatForm(\'' + cat.key + '\')">Retake</button>' +
        '</div>'
      : '<div class="cat-btn-row">' +
          '<button class="cat-start-btn" onclick="openCatForm(\'' + cat.key + '\')">+ Start</button>' +
        '</div>';

    item.innerHTML =
      '<div class="cat-top">' +
        '<span class="cat-name">' + cat.label + '</span>' +
        '<span class="cat-score-lbl">' + lbl + '</span>' +
      '</div>' +
      '<div class="cat-bar-track">' +
        '<div class="cat-bar-fill" style="width:' + pct + '%;background:' + color + ';"></div>' +
      '</div>' + btnRow;
    sidebarEl.appendChild(item);
  });

  // Unlock right cards
  if (scoredCount >= 1) {
    unlockCard("issues");
    unlockCard("actions");
  }
  if (scoredCount >= 2) {
    unlockCard("scenario");
  }
}

function unlockCard(id) {
  var iconEl = document.getElementById("icon-" + id);
  var bodyEl = document.getElementById("body-" + id);
  if (iconEl) iconEl.textContent = "";
  if (bodyEl) {
    var labels = { issues: "critical issue analysis", actions: "action plan", scenario: "scenario analysis" };
    bodyEl.innerHTML =
      '<div style="padding:8px 0;text-align:center;">' +
        '<div style="font-size:11px;color:#6b7585;line-height:1.6;">' +
          'Coming soon -- full ' + (labels[id] || id) + ' will appear here once the report engine is live.' +
        '</div>' +
      '</div>';
  }
}

/* -- DRAWER -- */
function openDrawer(catKey) {
  var cat = CATEGORIES.find(function(c) { return c.key === catKey; });
  if (!cat || !currentProject) return;

  var score = currentProject[cat.key];
  var color = scoreColor(score);
  var pct = score != null ? Math.min(100, Math.max(0, score)) : 0;

  document.getElementById("drawer-title").textContent = cat.label + " Assessment";

  // Score band
  var scoreBand =
    '<div class="drawer-score-band">' +
      '<div class="drawer-score-circle" style="border-color:' + color + ';background:rgba(0,0,0,0.2);">' +
        '<div class="drawer-score-num" style="color:' + color + '">' + (score != null ? score : "N/A") + '</div>' +
      '</div>' +
      '<div class="drawer-score-info">' +
        '<div class="drawer-score-label">' + cat.label + ' Score</div>' +
        '<div class="drawer-score-date">Last updated: ' + new Date().toLocaleDateString("en-GB", {day:"2-digit",month:"short",year:"numeric"}) + '</div>' +
        '<div class="drawer-score-bar-track">' +
          '<div class="drawer-score-bar-fill" style="width:' + pct + '%;background:' + color + ';"></div>' +
        '</div>' +
      '</div>' +
    '</div>';

  // Submitted data
  var submittedRows = cat.fields.map(function(f) {
    var val = currentProject[f.field];
    var display = val ? String(val) : '<span style="color:#bbb;font-style:italic;">Not provided</span>';
    return '<div class="drawer-field">' +
      '<span class="drawer-field-lbl">' + f.lbl + '</span>' +
      '<span class="drawer-field-val">' + display + '</span>' +
    '</div>';
  }).join("");

  var submittedSection =
    '<div class="drawer-section">' +
      '<div class="drawer-section-hdr">' +
        '<span class="drawer-section-icon">&#9989;</span>' +
        '<span class="drawer-section-title">Submitted Data</span>' +
      '</div>' +
      '<div class="drawer-section-body">' + submittedRows + '</div>' +
    '</div>';

  // Missing fields
  var missingRows = cat.missing.map(function(m) {
    return '<div class="drawer-missing-item">' +
      '<div class="drawer-missing-dot"></div>' +
      '<div><div class="drawer-missing-text">' + m.text + '</div>' +
      '<div class="drawer-missing-impact">' + m.impact + '</div></div>' +
    '</div>';
  }).join("");

  var missingSection =
    '<div class="drawer-section">' +
      '<div class="drawer-section-hdr">' +
        '<span class="drawer-section-icon">&#9888;&#65039;</span>' +
        '<span class="drawer-section-title">Missing Information</span>' +
      '</div>' +
      '<div class="drawer-section-body">' +
        (cat.missing.length > 0 ? missingRows : '<div class="drawer-all-good">All key fields are complete.</div>') +
      '</div>' +
    '</div>';

  document.getElementById("drawer-body").innerHTML = scoreBand + submittedSection + missingSection;
  document.getElementById("drawer-btn-retake").onclick = function() { openCatForm(catKey); };

  document.getElementById("drawer-overlay").classList.add("open");
  document.getElementById("drawer").classList.add("open");
  document.body.style.overflow = "hidden";
}

function closeDrawer() {
  document.getElementById("drawer-overlay").classList.remove("open");
  document.getElementById("drawer").classList.remove("open");
  document.body.style.overflow = "";
}

function openCatForm(catKey) {
  var catForms = {
    score_design:    CAT_FORM_DESIGN,
    score_construct: CAT_FORM_CONSTRUCT,
    score_contract:  CAT_FORM_CONTRACT,
    score_intercon:  CAT_FORM_INTERCON,
    score_financial: CAT_FORM_FINANCIAL,
    score_permit:    CAT_FORM_PERMIT
  };
  var catLabels = {
    score_design: "Design", score_construct: "Build", score_contract: "Legal",
    score_intercon: "Grid", score_financial: "Finance", score_permit: "Permit"
  };
  var formId = catForms[catKey];
  if (!formId || formId === "") {
    alert("This assessment form is not set up yet. Add the Tally form ID to overview.html.");
    return;
  }
  var url = "https://tally.so/embed/" + formId + "?transparentBackground=1&hideTitle=1";
  if (currentUserId) url += "&user_id=" + encodeURIComponent(currentUserId);
  if (currentProjectId) url += "&project_id=" + encodeURIComponent(currentProjectId);

  document.getElementById("ov-tally-title").textContent = catLabels[catKey] + " Assessment";
  document.getElementById("ov-tally-frame").src = url;
  var overlay = document.getElementById("ov-tally-overlay");
  overlay.style.display = "flex";
  document.body.style.overflow = "hidden";

  // Close drawer if open
  closeDrawer();

  // Poll for score updates while form is open
  startPolling();
}

function closeTallyForm() {
  document.getElementById("ov-tally-overlay").style.display = "none";
  document.getElementById("ov-tally-frame").src = "";
  document.body.style.overflow = "";
  stopPolling();
  // Reload project data to reflect any submitted scores
  if (currentProjectId && currentUserId) {
    reloadProject();
  }
}

var pollTimer = null;
function startPolling() {
  stopPolling();
  pollTimer = setInterval(function() {
    reloadProject();
  }, 8000);
}
function stopPolling() {
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}

function reloadProject() {
  if (!currentProjectId || !currentUserId) return;
  sb.from("projects").select("*").eq("id", currentProjectId).eq("user_id", currentUserId).single()
    .then(function(res) {
      if (res.error || !res.data) return;
      currentProject = res.data;
      renderLeft(res.data);
      // Update project details fields too
      var p = res.data;
      var stageShort = (p.stage || "").replace(/\s*\(.*?\)/g, "").trim();
      stageShort = stageShort.split(" - ").map(function(s) {
        return s.replace(/\s*\(.*?\)/g, "").trim();
      }).join(" - ");
      if (document.getElementById("inf-capacity"))
        document.getElementById("inf-capacity").textContent = p.capacity_mw ? p.capacity_mw + " MWp" : "-";
      if (document.getElementById("inf-stage"))
        document.getElementById("inf-stage").textContent = stageShort || "-";
    });
}

/* -- AUTH & DATA -- */
var authTimeout = setTimeout(function() {
  if (!authResolved) window.location.href = "login.html";
}, 6000);

sb.auth.onAuthStateChange(function(event, session) {
  if (session && session.user) {
    authResolved = true;
    clearTimeout(authTimeout);
    document.body.classList.remove("hidden");
    currentUserId = session.user.id;
    loadProject(session.user.id);
  } else if (event === "SIGNED_OUT") {
    window.location.href = "login.html";
  }
});

function loadProject(userId) {
  var params = new URLSearchParams(window.location.search);
  var projectId = params.get("id");
  if (!projectId) { window.location.href = "dashboard.html"; return; }

  sb.from("projects").select("*").eq("id", projectId).eq("user_id", userId).single()
    .then(function(res) {
      if (res.error || !res.data) { window.location.href = "dashboard.html"; return; }
      var p = res.data;
      currentProject = p;
      currentProjectId = p.id;

      var stageShort = (p.stage || "").replace(/\s*\(.*?\)/g, "").trim();
      stageShort = stageShort.split(" - ").map(function(s) {
        return s.replace(/\s*\(.*?\)/g, "").trim();
      }).join(" - ");

      document.getElementById("hero-name").textContent = p.name || "Unnamed Project";
      document.getElementById("hero-sub").textContent = [
        p.capacity_mw ? p.capacity_mw + " MWp" : null,
        stageShort || null
      ].filter(Boolean).join("  -  ");

      document.getElementById("inf-capacity").textContent = p.capacity_mw ? p.capacity_mw + " MWp" : "-";
      document.getElementById("inf-stage").textContent = stageShort || "-";
      document.getElementById("inf-status").textContent = (p.status || "-").replace(/-/g, " ");
      document.getElementById("inf-date").textContent = new Date(p.created_at).toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" });

      var locEl = document.getElementById("inf-location");
      if (p.location && p.location.startsWith("http")) {
        locEl.innerHTML = '<a href="' + p.location + '" target="_blank">Maps</a>';
      } else {
        locEl.textContent = p.location || "-";
      }

      document.getElementById("info-card").style.display = "block";
      renderLeft(p);
      generateSummary(false);
    });
}

function generateSummary(forceRegen) {
  if (!currentProjectId || !currentUserId) return;
  if (summaryRunning && !forceRegen) return;
  summaryRunning = true;
  var contentEl = document.getElementById("ai-content");
  var regenBtn  = document.getElementById("btn-regen");
  contentEl.innerHTML = '<div class="ai-loading"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div><span>' + (forceRegen ? "Regenerating..." : "Generating brief...") + "</span></div>";
  regenBtn.style.display = "none";

  function callEdge() {
    fetch(SUPABASE_URL + "/functions/v1/generate-overview", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ project_id: currentProjectId, user_id: currentUserId, force: forceRegen })
    })
    .then(function(r) {
      if (!r.ok) return r.text().then(function(t) { throw new Error("HTTP " + r.status + ": " + t); });
      return r.json();
    })
    .then(function(data) {
      summaryRunning = false;
      if (data.error) {
        contentEl.innerHTML = '<div class="ai-error">Error: ' + data.error + "</div>";
      } else {
        var paras = (data.summary || "").split(/\n+/).filter(function(p) { return p.trim(); });
        contentEl.innerHTML = '<div class="ai-text">' + paras.map(function(p) {
          return "<p>" + p.trim() + "</p>";
        }).join("") + "</div>";
      }
      regenBtn.style.display = "inline-block";
    })
    .catch(function(err) {
      summaryRunning = false;
      contentEl.innerHTML = '<div class="ai-error">Error: ' + err.message + "</div>";
      regenBtn.style.display = "inline-block";
    });
  }

  if (forceRegen) {
    sb.from("projects").update({ ai_summary: null, ai_summary_at: null }).eq("id", currentProjectId)
      .then(function() { callEdge(); }).catch(function() { callEdge(); });
  } else {
    callEdge();
  }
}
</script>
<script type="text/javascript">window.$crisp=[];window.CRISP_WEBSITE_ID="49df8fc4-e9b9-4f8d-b357-680e84e62c67";(function(){d=document;s=d.createElement("script");s.src="https://client.crisp.chat/l.js";s.async=1;d.getElementsByTagName("head")[0].appendChild(s);})();</script>
</body>
</html>
