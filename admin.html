<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #0f1117; color: #e0e0e0; min-height: 100vh; }

/* Login screen */
.login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
.login-box { background: #1a1f2e; border-radius: 16px; padding: 36px 32px; width: 360px; box-shadow: 0 8px 40px rgba(0,0,0,0.4); }
.login-logo { font-size: 22px; font-weight: 900; text-transform: uppercase; color: #fff; margin-bottom: 4px; }
.login-logo span { color: #FFFF00; }
.login-sub { font-size: 11px; color: #444; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 28px; }
.login-field { margin-bottom: 14px; }
.login-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #666; margin-bottom: 5px; display: block; }
.login-input { width: 100%; padding: 10px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 13px; color: #fff; outline: none; }
.login-input:focus { border-color: #FFFF00; }
.login-btn { width: 100%; padding: 12px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 8px; margin-top: 8px; }
.login-btn:hover { background: #fff; }
.login-err { font-size: 12px; color: #e74c3c; margin-top: 10px; text-align: center; display: none; }

/* Admin layout */
.admin-screen { display: none; }
.topbar { height: 52px; background: #111; border-bottom: 2px solid #FFFF00; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; position: fixed; top: 0; left: 0; right: 0; z-index: 10; }
.topbar-logo { font-size: 18px; font-weight: 900; text-transform: uppercase; color: #fff; }
.topbar-logo span { color: #FFFF00; }
.topbar-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; background: #FFFF00; color: #1a1f2e; padding: 2px 8px; border-radius: 20px; margin-left: 8px; }
.topbar-right { display: flex; align-items: center; gap: 12px; }
.topbar-lock { font-size: 11px; color: #555; cursor: pointer; }
.topbar-lock:hover { color: #e74c3c; }

.admin-body { padding-top: 52px; display: flex; min-height: 100vh; }

/* Sidebar nav */
.admin-nav { width: 200px; background: #111; padding: 20px 0; position: fixed; top: 52px; bottom: 0; display: flex; flex-direction: column; gap: 2px; border-right: 1px solid #1e1e1e; }
.nav-item { padding: 10px 20px; font-size: 12px; font-weight: 600; color: #555; cursor: pointer; text-transform: uppercase; letter-spacing: 0.3px; transition: all .12s; border-left: 3px solid transparent; }
.nav-item:hover { color: #aaa; background: rgba(255,255,255,0.03); }
.nav-item.active { color: #FFFF00; border-left-color: #FFFF00; background: rgba(255,255,0,0.04); }
.nav-section { padding: 16px 20px 6px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #333; }

/* Main content */
.admin-main { margin-left: 200px; flex: 1; padding: 28px 32px; }
.admin-panel { display: none; }
.admin-panel.active { display: block; }
.panel-title { font-size: 20px; font-weight: 900; color: #fff; margin-bottom: 4px; }
.panel-sub { font-size: 12px; color: #555; margin-bottom: 24px; }

/* Cards */
.admin-card { background: #1a1f2e; border-radius: 12px; padding: 20px 22px; margin-bottom: 16px; }
.admin-card-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #FFFF00; opacity: 0.7; margin-bottom: 14px; }
.field-row { margin-bottom: 14px; }
.field-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #666; margin-bottom: 5px; display: block; }
.field-input { width: 100%; padding: 9px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; transition: border-color .12s; }
.field-input:focus { border-color: #FFFF00; }
.field-textarea { width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; resize: vertical; min-height: 120px; line-height: 1.6; transition: border-color .12s; }
.field-textarea:focus { border-color: #FFFF00; }
.field-hint { font-size: 10px; color: #444; margin-top: 4px; }
.save-btn { padding: 9px 22px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.save-btn:hover { background: #fff; }
.save-msg { font-size: 11px; color: #2e7d4f; margin-left: 12px; opacity: 0; transition: opacity .3s; display: inline-block; }
.save-msg.show { opacity: 1; }

/* Data Sources panel */
.ds-toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.ds-search { flex: 1; min-width: 200px; padding: 9px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; }
.ds-search::placeholder { color: #444; }
.ds-search:focus { border-color: #FFFF00; }
.ds-filter { padding: 9px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #aaa; outline: none; cursor: pointer; }
.ds-filter:focus { border-color: #FFFF00; }
.ds-add-btn { padding: 9px 18px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; white-space: nowrap; }
.ds-add-btn:hover { background: #fff; }

/* Source card grid */
.ds-grid { display: flex; flex-direction: column; gap: 10px; }
.ds-card { background: #1a1f2e; border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.04); transition: border-color .15s; }
.ds-card:hover { border-color: rgba(255,255,0,0.15); }
.ds-card-top { display: flex; align-items: center; gap: 14px; padding: 14px 18px; cursor: pointer; }
.ds-status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.ds-status-dot.active   { background: #2e7d4f; box-shadow: 0 0 6px rgba(46,125,79,0.5); }
.ds-status-dot.inactive { background: #555; }
.ds-status-dot.error    { background: #c0392b; box-shadow: 0 0 6px rgba(192,57,43,0.5); }
.ds-card-name { font-size: 13px; font-weight: 700; color: #fff; flex: 1; }
.ds-card-type { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; padding: 2px 9px; border-radius: 20px; flex-shrink: 0; }
.ds-card-type.api      { background: rgba(30,80,200,0.18); color: #7aa3f5; }
.ds-card-type.webpage  { background: rgba(100,50,200,0.18); color: #b08af5; }
.ds-card-type.file     { background: rgba(46,125,79,0.18); color: #6ec997; }
.ds-card-type.scrape   { background: rgba(180,83,9,0.18); color: #f5a742; }
.ds-card-category { font-size: 10px; color: #555; margin-left: auto; padding-right: 4px; }
.ds-card-chevron { font-size: 10px; color: #444; transition: transform .2s; flex-shrink: 0; }
.ds-card-chevron.open { transform: rotate(180deg); }
.ds-card-body { display: none; padding: 0 18px 16px; border-top: 1px solid rgba(255,255,255,0.04); }
.ds-card-body.open { display: block; }
.ds-field-row { margin-bottom: 12px; margin-top: 12px; }
.ds-field-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #555; margin-bottom: 5px; display: block; }
.ds-field-input { width: 100%; padding: 8px 11px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; transition: border-color .12s; }
.ds-field-input:focus { border-color: #FFFF00; }
.ds-field-textarea { width: 100%; padding: 8px 11px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; resize: vertical; min-height: 80px; line-height: 1.6; transition: border-color .12s; }
.ds-field-textarea:focus { border-color: #FFFF00; }
.ds-field-hint { font-size: 10px; color: #444; margin-top: 4px; }
.ds-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.ds-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.ds-card-actions { display: flex; align-items: center; gap: 8px; margin-top: 14px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
.ds-save-btn { padding: 7px 18px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; }
.ds-save-btn:hover { background: #fff; }
.ds-test-btn { padding: 7px 16px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: #aaa; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.ds-test-btn:hover { border-color: #FFFF00; color: #FFFF00; }
.ds-del-btn { padding: 7px 16px; background: none; border: 1px solid rgba(192,57,43,0.3); color: #c0392b; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; margin-left: auto; transition: all .12s; }
.ds-del-btn:hover { background: #c0392b; color: #fff; border-color: #c0392b; }
.ds-save-msg { font-size: 11px; color: #2e7d4f; opacity: 0; transition: opacity .3s; }
.ds-save-msg.show { opacity: 1; }
.ds-test-result { font-size: 11px; margin-top: 8px; padding: 8px 11px; border-radius: 7px; display: none; line-height: 1.5; }
.ds-test-result.ok  { background: rgba(46,125,79,0.12); color: #6ec997; display: block; }
.ds-test-result.err { background: rgba(192,57,43,0.12); color: #f08080; display: block; }

/* Add modal */
.ds-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; display: none; align-items: center; justify-content: center; }
.ds-modal-overlay.open { display: flex; }
.ds-modal { background: #1a1f2e; border-radius: 14px; padding: 28px 26px; width: 560px; max-width: 95vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 12px 60px rgba(0,0,0,0.5); }
.ds-modal h3 { font-size: 16px; font-weight: 900; color: #fff; margin-bottom: 4px; }
.ds-modal-sub { font-size: 12px; color: #555; margin-bottom: 22px; }
.ds-type-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; margin-bottom: 20px; }
.ds-type-btn { padding: 10px 6px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 9px; cursor: pointer; text-align: center; transition: all .12s; }
.ds-type-btn:hover, .ds-type-btn.selected { border-color: #FFFF00; background: rgba(255,255,0,0.06); }
.ds-type-icon { font-size: 22px; margin-bottom: 4px; }
.ds-type-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #aaa; }
.ds-modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 22px; }
.ds-modal-cancel { padding: 9px 18px; background: rgba(255,255,255,0.06); border: none; color: #aaa; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 20px; }
.ds-modal-create { padding: 9px 22px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; }
.ds-modal-create:hover { background: #fff; }
.ds-empty-state { text-align: center; padding: 48px 20px; color: #444; }
.ds-empty-icon { font-size: 36px; margin-bottom: 12px; opacity: 0.4; }
.ds-empty-text { font-size: 13px; margin-bottom: 6px; color: #555; }
.ds-empty-sub { font-size: 11px; color: #333; }
.score-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.threshold-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.threshold-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.threshold-label { font-size: 11px; color: #aaa; width: 60px; }
.threshold-input { width: 70px; padding: 5px 9px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; text-align: center; }
.threshold-suffix { font-size: 11px; color: #555; }

/* User table */
.user-table { width: 100%; border-collapse: collapse; }
.user-table th { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #555; padding: 8px 12px; text-align: left; border-bottom: 1px solid #222; }
.user-table td { font-size: 12px; color: #aaa; padding: 10px 12px; border-bottom: 1px solid #1a1a1a; }
.user-table tr:hover td { background: rgba(255,255,255,0.02); }
.user-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 2px 8px; border-radius: 20px; }
.user-badge.pro { background: rgba(255,255,0,0.15); color: #FFFF00; }
.user-badge.free { background: rgba(255,255,255,0.06); color: #666; }
.user-count { font-size: 24px; font-weight: 900; color: #fff; }
.user-count-lbl { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 0.4px; margin-top: 2px; }
.stats-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 20px; }
.stat-box { background: #1a1f2e; border-radius: 10px; padding: 14px 16px; }

/* Intake question editor */
.iq-card { background: #1e2535; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; transition: border-color .15s; }
.iq-card:hover { border-color: rgba(255,255,0,0.12); }
.iq-card-header { display: flex; align-items: center; gap: 10px; padding: 11px 14px; background: rgba(255,255,255,0.02); cursor: grab; }
.iq-card-header:active { cursor: grabbing; }
.iq-drag-handle { color: #333; font-size: 14px; flex-shrink: 0; }
.iq-card-label { flex: 1; font-size: 12px; font-weight: 700; color: #ddd; }
.iq-card-type-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; padding: 2px 8px; border-radius: 20px; background: rgba(255,255,0,0.1); color: #FFFF00; flex-shrink: 0; }
.iq-card-req { font-size: 9px; font-weight: 700; color: #c0392b; padding: 2px 6px; border-radius: 20px; background: rgba(192,57,43,0.15); flex-shrink: 0; }
.iq-card-body { padding: 12px 14px; border-top: 1px solid rgba(255,255,255,0.04); display: flex; flex-direction: column; gap: 10px; }
.iq-row { display: grid; gap: 10px; }
.iq-row-2 { grid-template-columns: 1fr 1fr; }
.iq-row-3 { grid-template-columns: 1fr 1fr auto; align-items: end; }
.iq-field-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #555; margin-bottom: 4px; display: block; }
.iq-field-input { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; transition: border-color .12s; }
.iq-field-input:focus { border-color: #FFFF00; }
.iq-field-select { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; cursor: pointer; }
.iq-field-select:focus { border-color: #FFFF00; }
.iq-check-row { display: flex; align-items: center; gap: 7px; }
.iq-check-row input[type=checkbox] { accent-color: #FFFF00; width: 14px; height: 14px; cursor: pointer; }
.iq-check-row label { font-size: 11px; color: #aaa; cursor: pointer; }
.iq-del-btn { padding: 7px 14px; background: none; border: 1px solid rgba(192,57,43,0.3); color: #c0392b; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; white-space: nowrap; }
.iq-del-btn:hover { background: #c0392b; color: #fff; border-color: #c0392b; }
.iq-move-btn { padding: 6px 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); color: #555; font-family: 'Inter', sans-serif; font-size: 11px; cursor: pointer; border-radius: 7px; }
.iq-move-btn:hover { border-color: #FFFF00; color: #FFFF00; }
.iq-empty { text-align: center; padding: 40px 20px; color: #333; font-size: 13px; }


/* Intake question cards */
.iq-card{background:#1e2535;border-radius:10px;border:1px solid rgba(255,255,255,0.05);margin-bottom:10px;overflow:hidden;transition:border-color .15s;}
.iq-card:hover{border-color:rgba(255,255,0,0.12);}
.iq-card[style*="0.4"]{border:2px dashed rgba(255,255,0,0.3);}
.iq-card-hdr{display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(0,0,0,0.15);cursor:grab;user-select:none;}
.iq-card-hdr:active{cursor:grabbing;}
.iq-drag{color:#2a2a2a;font-size:15px;flex-shrink:0;letter-spacing:-2px;}
.iq-hdr-label{flex:1;font-size:12px;font-weight:700;color:#ccc;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.iq-req-badge{font-size:9px;font-weight:700;text-transform:uppercase;padding:2px 7px;border-radius:20px;background:rgba(192,57,43,0.2);color:#e07b7b;flex-shrink:0;}
.iq-type-badge{font-size:9px;font-weight:700;text-transform:uppercase;padding:2px 8px;border-radius:20px;flex-shrink:0;}
.iq-move-btn{padding:4px 8px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:#444;font-family:'Inter',sans-serif;font-size:11px;cursor:pointer;border-radius:6px;flex-shrink:0;transition:all .1s;}
.iq-move-btn:hover{border-color:#FFFF00;color:#FFFF00;}
.iq-move-btn:disabled{opacity:.2;cursor:default;}
.iq-card-body{padding:12px 14px;border-top:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:10px;}
.iq-row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.iq-fl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.3px;color:#555;margin-bottom:4px;display:block;}
.iq-fi{width:100%;padding:7px 10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:7px;font-family:'Inter',sans-serif;font-size:12px;color:#ddd;outline:none;transition:border-color .12s;}
.iq-fi:focus{border-color:#FFFF00;}
.iq-fs{width:100%;padding:7px 10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:7px;font-family:'Inter',sans-serif;font-size:12px;color:#ddd;outline:none;cursor:pointer;}
.iq-fs:focus{border-color:#FFFF00;}
.iq-del-btn{padding:5px 12px;background:none;border:1px solid rgba(192,57,43,0.3);color:#c0392b;font-family:'Inter',sans-serif;font-size:10px;font-weight:700;text-transform:uppercase;cursor:pointer;border-radius:20px;transition:all .12s;flex-shrink:0;}
.iq-del-btn:hover{background:#c0392b;color:#fff;border-color:#c0392b;}

/* ‚îÄ‚îÄ FIELD REGISTRY PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.reg-drop-zone{border:2px dashed rgba(255,255,0,0.25);border-radius:12px;padding:40px 24px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(255,255,0,0.02);margin-bottom:16px;}
.reg-drop-zone:hover,.reg-drop-zone.drag-over{border-color:#FFFF00;background:rgba(255,255,0,0.06);}
.reg-drop-icon{font-size:36px;margin-bottom:10px;}
.reg-drop-text{font-size:13px;font-weight:700;color:#ccc;margin-bottom:4px;}
.reg-drop-sub{font-size:11px;color:#444;}
.reg-file-input{display:none;}
.reg-preview{background:#12161f;border-radius:10px;padding:16px 18px;margin-bottom:16px;border:1px solid rgba(255,255,0,0.08);}
.reg-preview-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;color:#FFFF00;opacity:0.6;margin-bottom:12px;}
.reg-cat-row{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04);}
.reg-cat-row:last-child{border-bottom:none;}
.reg-cat-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.reg-cat-name{font-size:12px;font-weight:700;color:#ccc;flex:1;}
.reg-cat-count{font-size:10px;color:#555;}
.reg-cat-subs{font-size:10px;color:#444;font-style:italic;}
.reg-warn{background:rgba(192,57,43,0.12);border:1px solid rgba(192,57,43,0.3);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:11px;color:#e07b7b;display:none;}
.reg-warn.show{display:block;}
.reg-status{background:#1a1f2e;border-radius:10px;padding:14px 18px;border:1px solid rgba(255,255,255,0.06);}
.reg-status-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.reg-status-row:last-child{margin-bottom:0;}
.reg-status-lbl{font-size:10px;color:#555;text-transform:uppercase;font-weight:700;letter-spacing:0.3px;}
.reg-status-val{font-size:11px;color:#aaa;font-weight:600;}
.reg-version-badge{display:inline-block;background:rgba(255,255,0,0.12);color:#FFFF00;font-size:10px;font-weight:700;padding:2px 10px;border-radius:20px;border:1px solid rgba(255,255,0,0.25);}

/* ‚îÄ‚îÄ Field Registry panel ‚îÄ‚îÄ */
.fr-upload-zone { border: 2px dashed rgba(255,255,0,0.2); border-radius: 12px; padding: 28px 20px; text-align: center; cursor: pointer; transition: all .2s; margin-bottom: 16px; }
.fr-upload-zone:hover, .fr-upload-zone.drag { border-color: #FFFF00; background: rgba(255,255,0,0.03); }
.fr-upload-icon { font-size: 28px; margin-bottom: 8px; }
.fr-upload-title { font-size: 13px; font-weight: 700; color: #ddd; margin-bottom: 4px; }
.fr-upload-hint { font-size: 11px; color: #444; }
.fr-status-bar { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 9px; margin-bottom: 14px; font-size: 11px; }
.fr-status-bar.none  { background: rgba(255,255,255,0.03); color: #444; }
.fr-status-bar.ok    { background: rgba(46,125,79,0.12);   color: #6ec997; }
.fr-status-bar.warn  { background: rgba(224,123,32,0.12);  color: #f5a742; }
.fr-status-bar.error { background: rgba(192,57,43,0.12);   color: #f08080; }
.fr-status-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.fr-status-bar.none  .fr-status-dot { background: #444; }
.fr-status-bar.ok    .fr-status-dot { background: #6ec997; box-shadow: 0 0 5px rgba(110,201,151,.6); }
.fr-status-bar.warn  .fr-status-dot { background: #f5a742; }
.fr-status-bar.error .fr-status-dot { background: #f08080; }
.fr-status-text { flex: 1; line-height: 1.5; }
.fr-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 2px 8px; border-radius: 20px; background: rgba(255,255,0,0.12); color: #FFFF00; flex-shrink: 0; }
.fr-preview { background: rgba(0,0,0,0.2); border-radius: 9px; padding: 12px 14px; margin-bottom: 14px; max-height: 220px; overflow-y: auto; }
.fr-preview::-webkit-scrollbar { width: 3px; }
.fr-preview::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius:2px; }
.fr-preview-row { display: grid; grid-template-columns: 160px 1fr 80px 80px; gap: 6px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 10px; color: #888; }
.fr-preview-row.hdr { color: #FFFF00; opacity: 0.6; font-weight: 700; text-transform: uppercase; font-size: 9px; letter-spacing: 0.4px; }
.fr-preview-row.new-field { color: #6ec997; }
.fr-preview-row.changed  { color: #f5a742; }
.fr-preview-row.removed  { color: #f08080; text-decoration: line-through; }
.fr-warn-list { margin: 10px 0; padding: 10px 14px; background: rgba(192,57,43,0.08); border-radius: 8px; border-left: 3px solid #c0392b; }
.fr-warn-list p { font-size: 10px; color: #f08080; margin-bottom: 4px; }
.fr-warn-list p:last-child { margin-bottom: 0; }
.fr-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.fr-versions { font-size: 10px; color: #444; margin-top: 16px; }
.fr-versions table { width: 100%; border-collapse: collapse; margin-top: 6px; }
.fr-versions td { padding: 5px 8px; font-size: 10px; color: #666; border-bottom: 1px solid rgba(255,255,255,0.04); }
.fr-versions td:first-child { color: #FFFF00; opacity: 0.7; font-weight: 700; }

</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">Sun<span>Hash</span></div>
    <div class="login-sub">Admin Panel</div>
    <div class="login-field">
      <label class="login-label">Username</label>
      <input class="login-input" id="adm-user" type="text" autocomplete="off" onkeydown="if(event.key==='Enter')adminLogin()"/>
    </div>
    <div class="login-field">
      <label class="login-label">Password</label>
      <input class="login-input" id="adm-pass" type="password" onkeydown="if(event.key==='Enter')adminLogin()"/>
    </div>
    <button class="login-btn" onclick="adminLogin()">Enter Admin</button>
    <div class="login-err" id="login-err">Invalid credentials</div>
  </div>
</div>

<!-- ADMIN -->
<div class="admin-screen" id="admin-screen">
  <div class="topbar">
    <div style="display:flex;align-items:center;">
      <span class="topbar-logo">Sun<span>Hash</span></span>
      <span class="topbar-badge">Admin</span>
    </div>
    <div class="topbar-right">
      <span class="topbar-lock" onclick="adminLogout()">&#128274; Lock</span>
    </div>
  </div>

  <div class="admin-body">
    <div class="admin-nav">
      <div class="nav-section">Verification</div>
      <div class="nav-item" onclick="showPanel('datasources')">Data Sources</div>
      <div class="nav-section">Registry</div>
      <div class="nav-item" onclick="showPanel('registry')">Field Registry</div>
      <div class="nav-item" onclick="showPanel('scoring_rules')">Score Weights</div>
      <div class="nav-section">Content</div>
      <div class="nav-item active" onclick="showPanel('terms')">Terms & Conditions</div>
      <div class="nav-item" onclick="showPanel('intake')">Intake Questions</div>
      <div class="nav-section">AI Configuration</div>
      <div class="nav-item" onclick="showPanel('prompts')">GPT Prompts</div>
      <div class="nav-section">Scoring</div>
      <div class="nav-item" onclick="showPanel('scoring')">Score Thresholds</div>
      <div class="nav-item" onclick="showPanel('required')">Required Fields</div>
      <div class="nav-section">Users</div>
      <div class="nav-item" onclick="showPanel('users')">User Management</div>
      <div class="nav-section">Security</div>
      <div class="nav-item" onclick="showPanel('credentials')">Admin Credentials</div>
    </div>

    <div class="admin-main">

      <!-- TERMS -->
      <div class="admin-panel active" id="panel-terms">
        <div class="panel-title">Terms & Conditions</div>
        <div class="panel-sub">This text is shown to users at signup. Update the version number when making significant changes.</div>
        <div class="admin-card">
          <div class="admin-card-title">Current T&C</div>
          <div class="field-row">
            <label class="field-label">Version</label>
            <input class="field-input" id="terms-version" type="text" style="width:120px;" placeholder="e.g. 1.0"/>
          </div>
          <div class="field-row">
            <label class="field-label">Terms Text</label>
            <textarea class="field-textarea" id="terms-text" style="min-height:200px;" placeholder="Enter your terms and conditions text..."></textarea>
            <div class="field-hint">Plain text. Line breaks are preserved.</div>
          </div>
          <button class="save-btn" onclick="saveTerms()">Save Terms</button>
          <span class="save-msg" id="msg-terms">Saved</span>
        </div>
      </div>


      <!-- FIELD REGISTRY -->
      <div class="admin-panel" id="panel-registry">
        <div class="panel-title">Field Registry</div>
        <div class="panel-sub">One Excel file controls all 7 category buttons, Design Array sub-sections, Crews, Procurement Contracts, Components, Suppliers, Equipment and the Intake form. Field IDs are immutable ‚Äî labels, types, options and sections update on next page load.</div>

        <!-- Status row -->
        <div class="admin-card" style="margin-bottom:14px;">
          <div class="admin-card-title">Active Registry</div>
          <div id="reg-cur-status" class="fr-status-bar none" style="margin-bottom:8px;">
            <div class="fr-status-dot"></div>
            <div class="fr-status-text" id="reg-cur-status-txt">No registry published yet.</div>
            <div class="fr-badge" id="reg-cur-badge" style="display:none;"></div>
          </div>
          <div style="display:flex;gap:24px;flex-wrap:wrap;margin-top:4px;">
            <div><div style="font-size:9px;text-transform:uppercase;color:#444;letter-spacing:.4px;">Version</div><div id="reg-cur-version" style="font-size:12px;color:#FFFF00;font-weight:700;">‚Äî</div></div>
            <div><div style="font-size:9px;text-transform:uppercase;color:#444;letter-spacing:.4px;">Published</div><div id="reg-cur-date" style="font-size:11px;color:#888;">‚Äî</div></div>
            <div><div style="font-size:9px;text-transform:uppercase;color:#444;letter-spacing:.4px;">Sheets</div><div id="reg-cur-cats" style="font-size:12px;color:#aaa;font-weight:700;">‚Äî</div></div>
            <div><div style="font-size:9px;text-transform:uppercase;color:#444;letter-spacing:.4px;">Total Fields</div><div id="reg-cur-fields" style="font-size:12px;color:#aaa;font-weight:700;">‚Äî</div></div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
            <button class="save-btn" style="background:rgba(122,163,245,0.15);color:#7aa3f5;border:1px solid rgba(122,163,245,0.3);" onclick="regDownloadTemplate()">‚¨á Download Latest Template</button>
            <button class="save-btn" style="background:rgba(255,255,255,0.06);color:#888;" onclick="regQuerySupabase()">üîç Query Supabase</button>
          </div>
        </div>

        <!-- Upload -->
        <div class="admin-card">
          <div class="admin-card-title">Upload New Registry</div>
          <div class="reg-warn" id="reg-warn"></div>
          <div class="reg-drop-zone" id="reg-drop-zone"
               onclick="document.getElementById('reg-file-input').click()"
               ondragover="regDragOver(event)" ondragleave="regDragLeave(event)" ondrop="regDrop(event)">
            <div class="reg-drop-icon">üìä</div>
            <div class="reg-drop-text">Drop SunHash_Full_Field_Registry.xlsx here</div>
            <div class="reg-drop-sub">14 sheets: 7 category specs ¬∑ Design Arrays ¬∑ Crews ¬∑ Contracts ¬∑ Components ¬∑ Suppliers ¬∑ Equipment ¬∑ Intake</div>
          </div>
          <input type="file" id="reg-file-input" class="reg-file-input" accept=".xlsx" onchange="regFileSelected(this)"/>

          <div id="reg-parse-status" style="display:none;margin-top:8px;" class="fr-status-bar none">
            <div class="fr-status-dot"></div>
            <div class="fr-status-text" id="reg-parse-msg">Parsing‚Ä¶</div>
            <div class="fr-badge" id="reg-parse-badge"></div>
          </div>
          <div id="reg-preview" class="reg-preview" style="display:none;margin-top:8px;">
            <div class="reg-preview-title">Parsed Sheets</div>
            <div id="reg-preview-body"></div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;margin-top:8px;">
            <button class="save-btn" id="reg-publish-btn" onclick="publishRegistry()" style="display:none;">‚¨Ü Publish Registry</button>
            <span class="save-msg" id="reg-save-msg">Published ‚úì</span>
          </div>
        </div>

        <!-- Supabase query output -->
        <div class="admin-card" id="reg-supabase-out" style="display:none;">
          <div class="admin-card-title">Supabase Registry Data</div>
          <pre id="reg-supabase-json" style="font-size:10px;color:#7aa3f5;max-height:300px;overflow:auto;white-space:pre-wrap;word-break:break-all;background:#0a0d15;padding:10px;border-radius:6px;"></pre>
        </div>
      </div>

      <!-- INTAKE QUESTIONS -->
      <div class="admin-panel" id="panel-intake">
        <div class="panel-title">Intake Questions</div>
        <div class="panel-sub">Questions shown when a user clicks "New Assessment" or "Edit Intake" on the dashboard. Drag rows to reorder. Save to publish changes immediately.</div>

        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
          <div style="font-size:11px;color:#555;line-height:1.7;">
            <span id="iq-count">0</span> questions &nbsp;&middot;&nbsp;
            Fields with IDs <span style="color:#FFFF00;">q_name</span>, <span style="color:#FFFF00;">q_cap</span>, <span style="color:#FFFF00;">q_stage</span> &amp; <span style="color:#FFFF00;">q_location</span> auto-populate project card data.
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="save-btn" onclick="addIQ()">+ Add Question</button>
            <button class="save-btn" style="background:rgba(255,255,255,0.06);color:#aaa;" onclick="saveIntakeQs()">&#10003; Save All</button>
            <span class="save-msg" id="iq-save-msg">Saved</span>
          </div>
        </div>

        <div id="iq-cards"></div>

        <div style="margin-top:20px;background:#12161f;border-radius:10px;padding:14px 18px;border:1px solid rgba(255,255,0,0.06);">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;color:#FFFF00;opacity:0.55;margin-bottom:10px;">Field Type Reference</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px 16px;">
            <div style="font-size:11px;color:#444;"><span style="color:#7aa3f5;font-weight:700;">text</span> &mdash; Short free text</div>
            <div style="font-size:11px;color:#444;"><span style="color:#c39af5;font-weight:700;">number</span> &mdash; Numeric input</div>
            <div style="font-size:11px;color:#444;"><span style="color:#6ec997;font-weight:700;">select</span> &mdash; Dropdown (comma list)</div>
            <div style="font-size:11px;color:#444;"><span style="color:#f5a742;font-weight:700;">date</span> &mdash; Date picker</div>
            <div style="font-size:11px;color:#444;"><span style="color:#4ecdc4;font-weight:700;">toggle</span> &mdash; Yes / No switch</div>
            <div style="font-size:11px;color:#444;"><span style="color:#aaa;font-weight:700;">textarea</span> &mdash; Multi-line text</div>
          </div>
        </div>
      </div>

      <!-- DATA SOURCES -->
      <div class="admin-panel" id="panel-datasources">
        <div class="panel-title">Data Sources</div>
        <div class="panel-sub">APIs, webpages, and files used by the cross-verification engine. Add, configure, enable, or disable without redeploying.</div>

        <div class="ds-toolbar">
          <input class="ds-search" id="ds-search" type="text" placeholder="Search sources..." oninput="filterSources()"/>
          <select class="ds-filter" id="ds-filter-type" onchange="filterSources()">
            <option value="">All types</option>
            <option value="api">API</option>
            <option value="webpage">Webpage</option>
            <option value="file">File / CSV</option>
            <option value="scrape">Scrape</option>
          </select>
          <select class="ds-filter" id="ds-filter-cat" onchange="filterSources()">
            <option value="">All categories</option>
            <option value="solar">Solar Yield</option>
            <option value="financial">Financial</option>
            <option value="weather">Weather / Climate</option>
            <option value="land">Land & Site</option>
            <option value="regulatory">Regulatory</option>
            <option value="grid">Grid & Power</option>
            <option value="cost">Cost Benchmarks</option>
            <option value="environmental">Environmental</option>
            <option value="labor">Labor & Compliance</option>
            <option value="other">Other</option>
          </select>
          <button class="ds-add-btn" onclick="openAddSourceModal()">&#43; Add Source</button>
        </div>

        <div class="ds-grid" id="ds-grid">
          <div class="ds-empty-state">
            <div class="ds-empty-icon">üîå</div>
            <div class="ds-empty-text">Loading sources...</div>
          </div>
        </div>
      </div>

      <!-- Add Source Modal -->
      <div class="ds-modal-overlay" id="ds-modal-overlay">
        <div class="ds-modal">
          <h3>Add Data Source</h3>
          <div class="ds-modal-sub">Choose the type of source you want to connect.</div>
          <div class="ds-type-grid" id="ds-type-grid">
            <div class="ds-type-btn selected" onclick="selectSourceType('api',this)">
              <div class="ds-type-icon">‚ö°</div>
              <div class="ds-type-label">REST API</div>
            </div>
            <div class="ds-type-btn" onclick="selectSourceType('webpage',this)">
              <div class="ds-type-icon">üåê</div>
              <div class="ds-type-label">Webpage</div>
            </div>
            <div class="ds-type-btn" onclick="selectSourceType('file',this)">
              <div class="ds-type-icon">üìÑ</div>
              <div class="ds-type-label">File / CSV</div>
            </div>
            <div class="ds-type-btn" onclick="selectSourceType('scrape',this)">
              <div class="ds-type-icon">üï∑</div>
              <div class="ds-type-label">Scrape</div>
            </div>
          </div>

          <div class="ds-row-2">
            <div class="ds-field-row">
              <label class="ds-field-label">Source Name *</label>
              <input class="ds-field-input" id="new-ds-name" type="text" placeholder="e.g. NREL PVWatts V8"/>
            </div>
            <div class="ds-field-row">
              <label class="ds-field-label">Category *</label>
              <select class="ds-field-input" id="new-ds-category">
                <option value="solar">Solar Yield</option>
                <option value="financial">Financial</option>
                <option value="weather">Weather / Climate</option>
                <option value="land">Land & Site</option>
                <option value="regulatory">Regulatory</option>
                <option value="grid">Grid & Power</option>
                <option value="cost">Cost Benchmarks</option>
                <option value="environmental">Environmental</option>
                <option value="labor">Labor & Compliance</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="ds-field-row">
            <label class="ds-field-label">Base URL / Endpoint *</label>
            <input class="ds-field-input" id="new-ds-url" type="url" placeholder="https://developer.nrel.gov/api/pvwatts/v8.json"/>
          </div>

          <div class="ds-field-row">
            <label class="ds-field-label">Description</label>
            <input class="ds-field-input" id="new-ds-desc" type="text" placeholder="What this source verifies"/>
          </div>

          <div class="ds-modal-actions">
            <button class="ds-modal-cancel" onclick="closeAddSourceModal()">Cancel</button>
            <button class="ds-modal-create" onclick="createSource()">Add Source</button>
          </div>
        </div>
      </div>

      <!-- GPT PROMPTS -->
      <div class="admin-panel" id="panel-prompts">
        <div class="panel-title">GPT Prompts</div>
        <div class="panel-sub">Customize the AI instructions sent to GPT-4o-mini for overview summaries and category Q&amp;A. Use {project_data} as a placeholder for project fields.</div>

        <div class="admin-card">
          <div class="admin-card-title">Overview Brief Prompt</div>
          <div class="field-row">
            <label class="field-label">System prompt ‚Äî Overview generation</label>
            <textarea class="field-textarea" id="prompt-overview" style="min-height:160px;" placeholder="You are a solar project analyst. Generate a concise professional brief for the following project data: {project_data}"></textarea>
            <div class="field-hint">Sent to GPT-4o-mini when generating the AI Project Brief on the overview page.</div>
          </div>
          <button class="save-btn" onclick="savePrompt('overview')">Save</button>
          <span class="save-msg" id="msg-prompt-overview">Saved</span>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">Category Q&amp;A Prompt</div>
          <div class="field-row">
            <label class="field-label">System prompt ‚Äî Category Q&amp;A assistant</label>
            <textarea class="field-textarea" id="prompt-category-qa" style="min-height:160px;" placeholder="You are a due diligence expert in solar energy projects. Answer the user's question using the provided project data."></textarea>
            <div class="field-hint">Sent to GPT-4o-mini for the AI Q&amp;A tab inside each category panel.</div>
          </div>
          <button class="save-btn" onclick="savePrompt('category-qa')">Save</button>
          <span class="save-msg" id="msg-prompt-category-qa">Saved</span>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">Per-Category AI Prompts</div>
          <div class="panel-sub" style="margin-bottom:16px;">Override the general Q&amp;A prompt for specific categories. Leave blank to use the default above.</div>
          <div class="field-row">
            <label class="field-label">Design & Engineering</label>
            <textarea class="field-textarea" id="prompt-cat-design" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <div class="field-row">
            <label class="field-label">Construction</label>
            <textarea class="field-textarea" id="prompt-cat-construct" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <div class="field-row">
            <label class="field-label">Legal & Contract</label>
            <textarea class="field-textarea" id="prompt-cat-contract" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <div class="field-row">
            <label class="field-label">Grid Interconnection</label>
            <textarea class="field-textarea" id="prompt-cat-intercon" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <div class="field-row">
            <label class="field-label">Financial</label>
            <textarea class="field-textarea" id="prompt-cat-financial" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <div class="field-row">
            <label class="field-label">Permitting</label>
            <textarea class="field-textarea" id="prompt-cat-permit" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <div class="field-row">
            <label class="field-label">Procurement</label>
            <textarea class="field-textarea" id="prompt-cat-procurement" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <button class="save-btn" onclick="saveCatPrompts()">Save All Category Prompts</button>
          <span class="save-msg" id="msg-cat-all">Saved</span>
        </div>
      </div>

      <!-- SCORE WEIGHTS -->
      <div class="admin-panel" id="panel-scoring_rules">
        <div class="panel-title">Score Weights</div>
        <div class="panel-sub">Download the scoring weights template pre-filled with all current fields. Edit weights, logic operators and formulas in Excel, then upload to publish a new scoring version. A version badge appears on the dashboard.</div>

        <div class="admin-card" style="margin-bottom:14px;">
          <div class="admin-card-title">Current Scoring Version</div>
          <div id="sw-current-status" class="fr-status-bar none">
            <div class="fr-status-dot"></div>
            <div class="fr-status-text" id="sw-status-text">No scoring rules uploaded yet ‚Äî default weights are active.</div>
            <div class="fr-badge" id="sw-version-badge" style="display:none;"></div>
          </div>
        </div>

        <div class="admin-card" style="margin-bottom:14px;">
          <div class="admin-card-title">Step 1 ‚Äî Download Template</div>
          <div style="font-size:11px;color:#666;margin-bottom:12px;line-height:1.7;">
            Generates an Excel with every field from the current registry, pre-filled with current weights.<br>
            Columns: <span style="color:#ddd;">field_id ¬∑ field_label ¬∑ category ¬∑ section ¬∑ weight ¬∑ logic ¬∑ threshold ¬∑ direction ¬∑ notes</span>
          </div>
          <button class="save-btn" onclick="swDownloadTemplate()">‚¨á Download Scoring Template</button>
          <span style="font-size:10px;color:#444;margin-left:10px;" id="sw-dl-hint"></span>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">Step 2 ‚Äî Upload Scoring Rules</div>
          <div class="fr-upload-zone" id="sw-drop-zone"
               onclick="document.getElementById('sw-file-input').click()"
               ondragover="event.preventDefault();this.classList.add('drag')"
               ondragleave="this.classList.remove('drag')"
               ondrop="swHandleDrop(event)">
            <div class="fr-upload-icon">‚öñÔ∏è</div>
            <div class="fr-upload-title">Drop scoring rules .xlsx here</div>
            <div class="fr-upload-hint">or click to browse ‚Äî must use the downloaded template format</div>
          </div>
          <input type="file" id="sw-file-input" accept=".xlsx" style="display:none" onchange="swHandleFile(this.files[0])"/>

          <div id="sw-preview-wrap" style="display:none;">
            <div id="sw-parse-status" class="fr-status-bar none" style="margin-top:10px;">
              <div class="fr-status-dot"></div>
              <div class="fr-status-text" id="sw-parse-msg">Parsing‚Ä¶</div>
              <div class="fr-badge" id="sw-parse-badge"></div>
            </div>
            <div id="sw-warn-wrap" style="display:none;" class="fr-warn-list"></div>
            <div class="fr-preview" id="sw-preview">
              <div class="fr-preview-row hdr" style="grid-template-columns:160px 1fr 80px 80px 80px;">
                <span>Field ID</span><span>Label</span><span>Category</span><span>Weight</span><span>Logic</span>
              </div>
              <div id="sw-preview-rows"></div>
            </div>
            <div class="fr-actions" style="margin-top:10px;">
              <button class="save-btn" id="sw-publish-btn" onclick="swPublish()" disabled>‚úì Publish Scoring Rules</button>
              <button class="save-btn" style="background:rgba(255,255,255,0.06);color:#aaa;" onclick="swCancel()">‚úï Cancel</button>
              <span class="save-msg" id="sw-save-msg">Published!</span>
            </div>
          </div>
        </div>
      </div>

      <!-- SCORING -->
      <div class="admin-panel" id="panel-scoring">
        <div class="panel-title">Score Thresholds</div>
        <div class="panel-sub">Define the score boundaries for red, yellow, and green status across all categories and the timeline.</div>
        <div class="admin-card">
          <div class="admin-card-title">Category Score Colours</div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#2e7d4f;"></div>
            <span class="threshold-label">Green above</span>
            <input class="threshold-input" id="score-green" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#e07b20;"></div>
            <span class="threshold-label">Yellow above</span>
            <input class="threshold-input" id="score-yellow" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#c0392b;"></div>
            <span class="threshold-label">Red below</span>
            <span style="font-size:11px;color:#555;" id="score-red-label">--</span>
          </div>
          <button class="save-btn" onclick="saveScoreThresholds()">Save</button>
          <span class="save-msg" id="msg-scoring">Saved</span>
        </div>
        <div class="admin-card">
          <div class="admin-card-title">Timeline Milestone Thresholds (based on Permit score)</div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#2e7d4f;"></div>
            <span class="threshold-label">Green above</span>
            <input class="threshold-input" id="tl-green" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#e07b20;"></div>
            <span class="threshold-label">Yellow above</span>
            <input class="threshold-input" id="tl-yellow" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <button class="save-btn" onclick="saveTimelineThresholds()">Save</button>
          <span class="save-msg" id="msg-timeline">Saved</span>
        </div>
      </div>

      <!-- REQUIRED FIELDS -->
      <div class="admin-panel" id="panel-required">
        <div class="panel-title">Required Fields</div>
        <div class="panel-sub">Comma-separated field keys for each category. Used to calculate the completeness indicator on each button.</div>
        <div class="admin-card">
          <div class="admin-card-title">Per-Category Required Fields</div>
          <div id="required-fields-body"></div>
          <button class="save-btn" onclick="saveRequiredFields()">Save All</button>
          <span class="save-msg" id="msg-required">Saved</span>
        </div>
      </div>

      <!-- USERS -->
      <div class="admin-panel" id="panel-users">
        <div class="panel-title">User Management</div>
        <div class="panel-sub">All registered accounts. Subscription status reflects latest Stripe sync.</div>
        <div class="stats-row" id="user-stats"></div>
        <div class="admin-card">
          <div class="admin-card-title">All Users</div>
          <table class="user-table">
            <thead><tr><th>Email</th><th>Joined</th><th>Plan</th><th>T&C Accepted</th><th>Projects</th></tr></thead>
            <tbody id="user-table-body"><tr><td colspan="5" style="color:#444;text-align:center;padding:20px;">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- CREDENTIALS -->
      <div class="admin-panel" id="panel-credentials">
        <div class="panel-title">Admin Credentials</div>
        <div class="panel-sub">Change the username and password used to access this admin panel.</div>
        <div class="admin-card">
          <div class="admin-card-title">Update Login</div>
          <div class="field-row">
            <label class="field-label">New Username</label>
            <input class="field-input" id="new-username" type="text" style="max-width:300px;"/>
          </div>
          <div class="field-row">
            <label class="field-label">New Password</label>
            <input class="field-input" id="new-password" type="password" style="max-width:300px;"/>
          </div>
          <div class="field-row">
            <label class="field-label">Confirm Password</label>
            <input class="field-input" id="new-password2" type="password" style="max-width:300px;"/>
          </div>
          <button class="save-btn" onclick="saveCredentials()">Update Credentials</button>
          <span class="save-msg" id="msg-credentials">Updated</span>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

var CONFIG_KEYS = [
  "admin_username","admin_password","terms_text","terms_version",
  "prompt_overview","prompt_category_qa",
  "score_green_threshold","score_yellow_threshold",
  "timeline_permit_green","timeline_permit_yellow",
  "cat_required_design","cat_required_construct","cat_required_contract",
  "cat_required_intercon","cat_required_financial","cat_required_permit"
];

var config = {};
var CAT_LABELS = {
  design: "Design & Engineering", construct: "Construction",
  contract: "Legal & Contract", intercon: "Grid Interconnection",
  financial: "Financial", permit: "Permitting"
};

/* ---- AUTH ---- */
function adminLogin() {
  var user = document.getElementById("adm-user").value.trim();
  var pass = document.getElementById("adm-pass").value.trim();

  // Load config to verify credentials
  sb.from("admin_config").select("key,value").then(function(res) {
    if (res.error) { showLoginErr("Database error: " + res.error.message); return; }
    var cfg = {};
    (res.data || []).forEach(function(r) { cfg[r.key] = r.value; });

    var validUser = cfg["admin_username"] || "sunhash_admin";
    var validPass = cfg["admin_password"] || "SunHash2026!";

    if (user === validUser && pass === validPass) {
      config = cfg;
      sessionStorage.setItem("admin_auth", "1");
      showAdmin();
    } else {
      showLoginErr("Invalid credentials");
    }
  });
}

function showLoginErr(msg) {
  var el = document.getElementById("login-err");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(function() { el.style.display = "none"; }, 3000);
}

function adminLogout() {
  sessionStorage.removeItem("admin_auth");
  document.getElementById("admin-screen").style.display = "none";
  document.getElementById("login-screen").style.display = "flex";
  document.getElementById("adm-pass").value = "";
}

function showAdmin() {
  document.getElementById("login-screen").style.display = "none";
  document.getElementById("admin-screen").style.display = "block";
  populateFields();
  loadUsers();
  loadIntakeQs();
}

// Check session on load
window.addEventListener("load", function() {
  if (sessionStorage.getItem("admin_auth") === "1") {
    sb.from("admin_config").select("key,value").then(function(res) {
      if (!res.error) {
        (res.data || []).forEach(function(r) { config[r.key] = r.value; });
        showAdmin();
      }
    });
  }
});

/* ---- NAVIGATION ---- */
function showPanel(id) {
  document.querySelectorAll(".admin-panel").forEach(function(p) { p.classList.remove("active"); });
  document.querySelectorAll(".nav-item").forEach(function(n) { n.classList.remove("active"); });
  document.getElementById("panel-" + id).classList.add("active");
  event.target.classList.add("active");
  if (id === "users") loadUsers();
}

/* ---- POPULATE ---- */
function populateFields() {
  setValue("terms-version",    config["terms_version"]         || "1.0");
  setValue("terms-text",       config["terms_text"]            || "");
  setValue("prompt-overview",  config["prompt_overview"]       || "");
  setValue("prompt-category-qa", config["prompt_category_qa"] || "");
  setValue("score-green",      config["score_green_threshold"] || "70");
  setValue("score-yellow",     config["score_yellow_threshold"]|| "40");
  setValue("tl-green",         config["timeline_permit_green"] || "70");
  setValue("tl-yellow",        config["timeline_permit_yellow"]|| "40");
  updateRedLabel();

  // Per-category AI prompts
  var catKeys = ['design','construct','contract','intercon','financial','permit','procurement'];
  catKeys.forEach(function(k) {
    var el = document.getElementById('prompt-cat-' + k);
    if (el) el.value = config['prompt_cat_' + k] || '';
  });

  // Overview + QA prompts
  setValue("prompt-overview",     config["prompt_overview"]     || "");
  setValue("prompt-category-qa",  config["prompt_category_qa"]  || "");
  setValue("prompt-category_qa",  config["prompt_category_qa"]  || "");

  // Per-category prompts
  var catKeys2 = ['design','construct','contract','intercon','financial','permit','procurement'];
  catKeys2.forEach(function(k) {
    var el = document.getElementById('prompt-cat-' + k);
    if (el) el.value = config['prompt_cat_' + k] || '';
  });

  // Required fields per category
  var body = document.getElementById("required-fields-body");
  body.innerHTML = Object.keys(CAT_LABELS).map(function(cat) {
    var val = config["cat_required_" + cat] || "";
    return '<div class="field-row">' +
      '<label class="field-label">' + CAT_LABELS[cat] + '</label>' +
      '<input class="field-input" id="req-' + cat + '" type="text" value="' + val + '"/>' +
      '<div class="field-hint">Comma-separated field keys. Used for completeness indicator.</div>' +
    '</div>';
  }).join("");
}

function setValue(id, val) {
  var el = document.getElementById(id);
  if (el) el.value = val;
}

function updateRedLabel() {
  var y = document.getElementById("score-yellow");
  var lbl = document.getElementById("score-red-label");
  if (y && lbl) lbl.textContent = "Score below " + (y.value || "40");
}
document.addEventListener("input", function(e) {
  if (e.target.id === "score-yellow") updateRedLabel();
});

/* ---- SAVE FUNCTIONS ---- */
function saveConfig(updates, msgId) {
  var rows = Object.keys(updates).map(function(k) {
    return { key: k, value: String(updates[k]), updated_at: new Date().toISOString() };
  });
  // Get fresh session token so RLS allows the upsert
  sb.auth.getSession().then(function(sessionRes) {
    var token = sessionRes.data && sessionRes.data.session && sessionRes.data.session.access_token;
    var client = token
      ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { global: { headers: { Authorization: 'Bearer ' + token } } })
      : sb;
    var chain = Promise.resolve();
    rows.forEach(function(row) {
      chain = chain.then(function() {
        return client.from("admin_config").upsert(row, { onConflict: "key" });
      });
    });
    chain.then(function() {
      Object.assign(config, updates);
      showMsg(msgId);
    }).catch(function(e) { alert("Save failed: " + e.message); });
  });
}

function showMsg(id) {
  var el = document.getElementById(id);
  if (!el) return;
  el.classList.add("show");
  setTimeout(function() { el.classList.remove("show"); }, 2500);
}

function saveTerms() {
  saveConfig({
    terms_text:    document.getElementById("terms-text").value,
    terms_version: document.getElementById("terms-version").value
  }, "msg-terms");
}

function savePrompt(key) {
  var inputId = "prompt-" + key;
  var configKey = "prompt_" + key.replace(/-/g, '_');
  var updates = {};
  var el = document.getElementById(inputId);
  if (el) updates[configKey] = el.value;
  saveConfig(updates, "msg-prompt-" + key);
}

function saveCatPrompts() {
  var cats = ['design','construct','contract','intercon','financial','permit','procurement'];
  var updates = {};
  cats.forEach(function(k) {
    var el = document.getElementById('prompt-cat-' + k);
    if (el) updates['prompt_cat_' + k] = el.value.trim();
  });
  saveConfig(updates, 'msg-cat-all');
}

function saveScoreThresholds() {
  saveConfig({
    score_green_threshold:  document.getElementById("score-green").value,
    score_yellow_threshold: document.getElementById("score-yellow").value
  }, "msg-scoring");
}

function saveTimelineThresholds() {
  saveConfig({
    timeline_permit_green:  document.getElementById("tl-green").value,
    timeline_permit_yellow: document.getElementById("tl-yellow").value
  }, "msg-timeline");
}

function saveRequiredFields() {
  var updates = {};
  Object.keys(CAT_LABELS).forEach(function(cat) {
    var el = document.getElementById("req-" + cat);
    if (el) updates["cat_required_" + cat] = el.value.trim();
  });
  saveConfig(updates, "msg-required");
}

function saveCredentials() {
  var u  = document.getElementById("new-username").value.trim();
  var p  = document.getElementById("new-password").value;
  var p2 = document.getElementById("new-password2").value;
  if (!u || !p) { alert("Username and password required."); return; }
  if (p !== p2) { alert("Passwords do not match."); return; }
  saveConfig({ admin_username: u, admin_password: p }, "msg-credentials");
  document.getElementById("new-password").value  = "";
  document.getElementById("new-password2").value = "";
}

/* ---- USERS ---- */
function loadUsers() {
  sb.from("profiles").select("id, email, subscription_status, subscription_plan, terms_accepted_at, created_at")
    .order("created_at", { ascending: false })
    .then(function(res) {
      if (res.error) { console.error(res.error); return; }
      var users = res.data || [];
      var pro   = users.filter(function(u) { return u.subscription_status === "active"; }).length;
      var tac   = users.filter(function(u) { return u.terms_accepted_at; }).length;

      document.getElementById("user-stats").innerHTML =
        stat(users.length, "Total Users") +
        stat(pro, "Pro Subscribers") +
        stat(users.length - pro, "Free Users") +
        stat(tac, "T&C Accepted");

      // Load project counts
      sb.from("projects").select("user_id").then(function(pr) {
        var counts = {};
        (pr.data || []).forEach(function(p) { counts[p.user_id] = (counts[p.user_id] || 0) + 1; });

        document.getElementById("user-table-body").innerHTML = users.map(function(u) {
          var plan = u.subscription_status === "active"
            ? '<span class="user-badge pro">' + (u.subscription_plan || "Pro") + '</span>'
            : '<span class="user-badge free">Free</span>';
          var tac = u.terms_accepted_at
            ? new Date(u.terms_accepted_at).toLocaleDateString("en-GB")
            : '<span style="color:#444;">No</span>';
          var joined = new Date(u.created_at).toLocaleDateString("en-GB", {day:"2-digit",month:"short",year:"numeric"});
          return '<tr>' +
            '<td>' + (u.email || u.id.slice(0,8) + "...") + '</td>' +
            '<td>' + joined + '</td>' +
            '<td>' + plan + '</td>' +
            '<td>' + tac + '</td>' +
            '<td>' + (counts[u.id] || 0) + '</td>' +
            '</tr>';
        }).join("");
      });
    });
}

function stat(val, lbl) {
  return '<div class="stat-box"><div class="user-count">' + val + '</div><div class="user-count-lbl">' + lbl + '</div></div>';
}
/* =============================================
   DATA SOURCES PANEL
   ============================================= */
var allSources = [];
var newSourceType = 'api';

// Load sources when panel shown
var _origShowPanel = showPanel;
showPanel = function(id) {
  _origShowPanel.call(this, id);
  if (id === 'datasources') loadSources();
  if (id === 'intake') loadIntakeQs();
  if (id === 'registry') frLoadCurrentStatus();
};

function loadSources() {
  sb.from('data_sources').select('*').order('created_at', { ascending: false })
    .then(function(res) {
      if (res.error) { console.error('DS load error:', res.error); return; }
      allSources = res.data || [];
      renderSources(allSources);
    });
}

var CAT_LABELS_DS = {
  solar:'Solar Yield', financial:'Financial', weather:'Weather / Climate',
  land:'Land & Site', regulatory:'Regulatory', grid:'Grid & Power',
  cost:'Cost Benchmarks', environmental:'Environmental', labor:'Labor & Compliance', other:'Other'
};
var TYPE_LABELS = { api:'API', webpage:'Webpage', file:'File / CSV', scrape:'Scrape' };

function filterSources() {
  var q    = (document.getElementById('ds-search').value || '').toLowerCase();
  var type = document.getElementById('ds-filter-type').value;
  var cat  = document.getElementById('ds-filter-cat').value;
  var filtered = allSources.filter(function(s) {
    var matchQ = !q || (s.name||'').toLowerCase().includes(q) || (s.description||'').toLowerCase().includes(q) || (s.base_url||'').toLowerCase().includes(q);
    var matchT = !type || s.source_type === type;
    var matchC = !cat  || s.category === cat;
    return matchQ && matchT && matchC;
  });
  renderSources(filtered);
}

function renderSources(sources) {
  var grid = document.getElementById('ds-grid');
  if (!sources.length) {
    grid.innerHTML = '<div class="ds-empty-state"><div class="ds-empty-icon">üîå</div><div class="ds-empty-text">No sources found.</div><div class="ds-empty-sub">Click "+ Add Source" to connect your first API or webpage.</div></div>';
    return;
  }
  grid.innerHTML = sources.map(function(s) { return buildSourceCard(s); }).join('');
}

function buildSourceCard(s) {
  var statusCls = s.enabled ? (s.last_test_ok === false ? 'error' : 'active') : 'inactive';
  var typeCls   = s.source_type || 'api';
  var typeLabel = TYPE_LABELS[typeCls] || typeCls;
  var catLabel  = CAT_LABELS_DS[s.category] || s.category || '';
  var freq_opts = ['realtime','hourly','daily','weekly','monthly','manual'].map(function(f) {
    return '<option value="' + f + '"' + (s.refresh_frequency===f?' selected':'') + '>' + f.charAt(0).toUpperCase()+f.slice(1) + '</option>';
  }).join('');
  var cat_opts = Object.keys(CAT_LABELS_DS).map(function(k) {
    return '<option value="'+k+'"'+(s.category===k?' selected':'')+'>'+CAT_LABELS_DS[k]+'</option>';
  }).join('');
  var type_opts = Object.keys(TYPE_LABELS).map(function(k) {
    return '<option value="'+k+'"'+(s.source_type===k?' selected':'')+'>'+TYPE_LABELS[k]+'</option>';
  }).join('');
  var lastTested = s.last_tested_at ? new Date(s.last_tested_at).toLocaleString() : 'Never';
  var testResult = '';
  if (s.last_test_ok === true)  testResult = '<div class="ds-test-result ok">‚úì Last test passed ‚Äî ' + lastTested + '</div>';
  if (s.last_test_ok === false) testResult = '<div class="ds-test-result err">‚úó Last test failed ‚Äî ' + lastTested + (s.last_test_error ? '<br>' + escAdm(s.last_test_error) : '') + '</div>';

  return '<div class="ds-card" id="dscard-' + s.id + '">' +
    '<div class="ds-card-top" onclick="toggleDsCard(\'' + s.id + '\')">' +
      '<div class="ds-status-dot ' + statusCls + '"></div>' +
      '<span class="ds-card-name">' + escAdm(s.name) + '</span>' +
      '<span class="ds-card-type ' + typeCls + '">' + typeLabel + '</span>' +
      '<span class="ds-card-category">' + escAdm(catLabel) + '</span>' +
      '<span class="ds-card-chevron" id="dsv-' + s.id + '">‚ñº</span>' +
    '</div>' +
    '<div class="ds-card-body" id="dsbody-' + s.id + '">' +
      '<div class="ds-row-3">' +
        '<div class="ds-field-row"><label class="ds-field-label">Source Name</label>' +
          '<input class="ds-field-input" id="dsf-name-' + s.id + '" value="' + escAdm(s.name) + '"/></div>' +
        '<div class="ds-field-row"><label class="ds-field-label">Type</label>' +
          '<select class="ds-field-input" id="dsf-type-' + s.id + '">' + type_opts + '</select></div>' +
        '<div class="ds-field-row"><label class="ds-field-label">Category</label>' +
          '<select class="ds-field-input" id="dsf-cat-' + s.id + '">' + cat_opts + '</select></div>' +
      '</div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Base URL / Endpoint</label>' +
        '<input class="ds-field-input" id="dsf-url-' + s.id + '" type="url" value="' + escAdm(s.base_url||'') + '"/>' +
        '<div class="ds-field-hint">Full URL. Use {PARAM} placeholders for dynamic values, e.g. {lat}, {lon}, {api_key}</div></div>' +
      '<div class="ds-row-2">' +
        '<div class="ds-field-row"><label class="ds-field-label">API Key / Auth Token</label>' +
          '<input class="ds-field-input" id="dsf-key-' + s.id + '" type="password" value="' + escAdm(s.api_key||'') + '" placeholder="Leave blank if none"/></div>' +
        '<div class="ds-field-row"><label class="ds-field-label">Refresh Frequency</label>' +
          '<select class="ds-field-input" id="dsf-freq-' + s.id + '">' + freq_opts + '</select></div>' +
      '</div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Request Parameters (JSON)</label>' +
        '<textarea class="ds-field-textarea" id="dsf-params-' + s.id + '" placeholder=\'{"format":"json","units":"metric"}\'>' + escAdm(s.request_params||'') + '</textarea>' +
        '<div class="ds-field-hint">Extra query parameters sent with every request. Use {project_lat}, {project_lon}, {api_key} as runtime substitutions.</div></div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Response Path (dot notation)</label>' +
        '<input class="ds-field-input" id="dsf-path-' + s.id + '" value="' + escAdm(s.response_path||'') + '" placeholder="e.g. outputs.ac_annual or data[0].value"/>' +
        '<div class="ds-field-hint">Where to find the benchmark value in the JSON response. Leave blank for full response.</div></div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Verification Rules (one per line)</label>' +
        '<textarea class="ds-field-textarea" id="dsf-rules-' + s.id + '" style="min-height:100px;" placeholder="e.g. user_yield > baseline * 1.15 ‚Üí RED \'Yield exceeds satellite model\'">' + escAdm(s.verification_rules||'') + '</textarea>' +
        '<div class="ds-field-hint">Plain-text rule descriptions. The cross-verify edge function reads these to apply logic.</div></div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Notes / Documentation</label>' +
        '<textarea class="ds-field-textarea" id="dsf-notes-' + s.id + '" style="min-height:60px;">' + escAdm(s.notes||'') + '</textarea></div>' +
      '<div class="ds-field-row" style="display:flex;align-items:center;gap:12px;">' +
        '<label style="font-size:11px;color:#aaa;cursor:pointer;display:flex;align-items:center;gap:7px;">' +
          '<input type="checkbox" id="dsf-enabled-' + s.id + '"' + (s.enabled?' checked':'') + ' style="accent-color:#FFFF00;width:14px;height:14px;cursor:pointer;"/> Enabled' +
        '</label>' +
        '<label style="font-size:11px;color:#aaa;cursor:pointer;display:flex;align-items:center;gap:7px;">' +
          '<input type="checkbox" id="dsf-cache-' + s.id + '"' + (s.cache_results?' checked':'') + ' style="accent-color:#FFFF00;width:14px;height:14px;cursor:pointer;"/> Cache results in market_benchmarks' +
        '</label>' +
      '</div>' +
      testResult +
      '<div class="ds-card-actions">' +
        '<button class="ds-save-btn" onclick="saveSource(\'' + s.id + '\')">Save</button>' +
        '<button class="ds-test-btn" onclick="testSource(\'' + s.id + '\')">Test Connection</button>' +
        '<span class="ds-save-msg" id="ds-msg-' + s.id + '">Saved</span>' +
        '<button class="ds-del-btn" onclick="deleteSource(\'' + s.id + '\',\'' + escAdm(s.name) + '\')">Delete</button>' +
      '</div>' +
    '</div>' +
  '</div>';
}

function toggleDsCard(id) {
  var body = document.getElementById('dsbody-' + id);
  var chev = document.getElementById('dsv-' + id);
  if (!body) return;
  var isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  if (chev) chev.classList.toggle('open', !isOpen);
}

function escAdm(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function saveSource(id) {
  var updates = {
    name:               (document.getElementById('dsf-name-' + id)||{}).value || '',
    source_type:        (document.getElementById('dsf-type-' + id)||{}).value || 'api',
    category:           (document.getElementById('dsf-cat-' + id)||{}).value  || 'other',
    base_url:           (document.getElementById('dsf-url-' + id)||{}).value  || '',
    api_key:            (document.getElementById('dsf-key-' + id)||{}).value  || '',
    refresh_frequency:  (document.getElementById('dsf-freq-' + id)||{}).value || 'manual',
    request_params:     (document.getElementById('dsf-params-' + id)||{}).value || '',
    response_path:      (document.getElementById('dsf-path-' + id)||{}).value  || '',
    verification_rules: (document.getElementById('dsf-rules-' + id)||{}).value || '',
    notes:              (document.getElementById('dsf-notes-' + id)||{}).value || '',
    enabled:            (document.getElementById('dsf-enabled-' + id)||{}).checked || false,
    cache_results:      (document.getElementById('dsf-cache-' + id)||{}).checked || false,
    updated_at:         new Date().toISOString()
  };
  sb.from('data_sources').update(updates).eq('id', id).then(function(res) {
    if (res.error) { alert('Save failed: ' + res.error.message); return; }
    // update local cache
    var idx = allSources.findIndex(function(s) { return s.id === id; });
    if (idx >= 0) Object.assign(allSources[idx], updates);
    var msg = document.getElementById('ds-msg-' + id);
    if (msg) { msg.classList.add('show'); setTimeout(function() { msg.classList.remove('show'); }, 2500); }
  });
}

function testSource(id) {
  var src = allSources.find(function(s) { return s.id === id; });
  if (!src) return;
  var btn  = document.querySelector('#dscard-' + id + ' .ds-test-btn');
  if (btn) { btn.textContent = 'Testing...'; btn.disabled = true; }

  // Attempt a lightweight HEAD/GET to the base URL
  var url  = src.base_url || '';
  var ok   = false;
  var errMsg = '';

  if (!url) { recordTestResult(id, false, 'No URL configured', btn); return; }

  fetch(url, { method: 'HEAD', mode: 'no-cors' })
    .then(function() {
      // no-cors always "succeeds" ‚Äî treat as reachable
      recordTestResult(id, true, '', btn);
    })
    .catch(function(err) {
      recordTestResult(id, false, err.message, btn);
    });
}

function recordTestResult(id, success, errMsg, btn) {
  var now = new Date().toISOString();
  var update = { last_tested_at: now, last_test_ok: success, last_test_error: errMsg || null, updated_at: now };
  sb.from('data_sources').update(update).eq('id', id).then(function() {
    Object.assign(allSources.find(function(s){return s.id===id;})||{}, update);
    if (btn) { btn.textContent = 'Test Connection'; btn.disabled = false; }
    // Re-render just this card
    var card = document.getElementById('dscard-' + id);
    var src  = allSources.find(function(s){return s.id===id;});
    if (card && src) {
      var wasOpen = document.getElementById('dsbody-' + id).classList.contains('open');
      card.outerHTML = buildSourceCard(src);
      if (wasOpen) {
        document.getElementById('dsbody-' + id).classList.add('open');
        document.getElementById('dsv-' + id).classList.add('open');
      }
    }
  });
}

function deleteSource(id, name) {
  if (!confirm('Delete source "' + name + '"? This cannot be undone.')) return;
  sb.from('data_sources').delete().eq('id', id).then(function(res) {
    if (res.error) { alert('Delete failed: ' + res.error.message); return; }
    allSources = allSources.filter(function(s) { return s.id !== id; });
    renderSources(allSources);
  });
}

/* Add modal */
function openAddSourceModal() {
  document.getElementById('ds-modal-overlay').classList.add('open');
  document.getElementById('new-ds-name').value = '';
  document.getElementById('new-ds-url').value  = '';
  document.getElementById('new-ds-desc').value = '';
  newSourceType = 'api';
  document.querySelectorAll('.ds-type-btn').forEach(function(b,i) {
    b.classList.toggle('selected', i===0);
  });
}

function closeAddSourceModal() {
  document.getElementById('ds-modal-overlay').classList.remove('open');
}

function selectSourceType(type, el) {
  newSourceType = type;
  document.querySelectorAll('.ds-type-btn').forEach(function(b) { b.classList.remove('selected'); });
  el.classList.add('selected');
}

function createSource() {
  var name = (document.getElementById('new-ds-name').value||'').trim();
  var url  = (document.getElementById('new-ds-url').value||'').trim();
  var cat  = document.getElementById('new-ds-category').value;
  var desc = (document.getElementById('new-ds-desc').value||'').trim();
  if (!name) { alert('Source name is required.'); return; }
  var row = {
    name: name, source_type: newSourceType, category: cat,
    base_url: url, description: desc,
    enabled: true, cache_results: false,
    refresh_frequency: 'manual',
    api_key: '', request_params: '', response_path: '',
    verification_rules: '', notes: '',
    created_at: new Date().toISOString(), updated_at: new Date().toISOString()
  };
  sb.from('data_sources').insert(row).select().then(function(res) {
    if (res.error) { alert('Create failed: ' + res.error.message); return; }
    var created = res.data && res.data[0];
    if (created) { allSources.unshift(created); renderSources(allSources); }
    closeAddSourceModal();
    // Auto-open new card
    if (created) {
      setTimeout(function() { toggleDsCard(created.id); }, 100);
    }
  });
}

// Close modal on overlay click
window.addEventListener('load', function() {
  var overlay = document.getElementById('ds-modal-overlay');
  if (overlay) overlay.addEventListener('click', function(e) {
    if (e.target === this) closeAddSourceModal();
  });
});

function saveCatPrompt(catKey) {
  var el = document.getElementById('prompt-cat-' + catKey);
  if (!el) return;
  var updates = {};
  updates['prompt_cat_' + catKey] = el.value.trim();
  saveConfig(updates, 'msg-cat-' + catKey);
}


/* ================================================================
   INTAKE QUESTIONS PANEL
   Stored in admin_config: key="intake_questions", value=JSON array
   Each question: { id, label, type, opts, required, order }
   Types: text | number | select | date | toggle | textarea
   ================================================================ */

var iqList    = [];   // working copy
var iqDragId  = null; // id of card being dragged

/* Called on panel load and on showPanel('intake') */
function loadIntakeQs() {
  sb.from("admin_config").select("value").eq("key", "intake_questions").single().then(function(res) {
    if (res.data && res.data.value) {
      try {
        var p = JSON.parse(res.data.value);
        if (Array.isArray(p) && p.length > 0) {
          iqList = p.slice().sort(function(a, b) { return (a.order || 0) - (b.order || 0); });
          renderIQPanel();
          return;
        }
      } catch (e) {}
    }
    // Seed with defaults
    iqList = [
      { id:"q_name",     label:"Project Name",                        type:"text",     required:true,  order:1, opts:"" },
      { id:"q_cap",      label:"Capacity (MWp)",                      type:"number",   required:true,  order:2, opts:"" },
      { id:"q_state",    label:"State / Province",                    type:"select",   required:true,  order:3,
        opts:"Alabama,Alaska,Arizona,Arkansas,California,Colorado,Connecticut,Delaware,Florida,Georgia,Hawaii,Idaho,Illinois,Indiana,Iowa,Kansas,Kentucky,Louisiana,Maine,Maryland,Massachusetts,Michigan,Minnesota,Mississippi,Missouri,Montana,Nebraska,Nevada,New Hampshire,New Jersey,New Mexico,New York,North Carolina,North Dakota,Ohio,Oklahoma,Oregon,Pennsylvania,Rhode Island,South Carolina,South Dakota,Tennessee,Texas,Utah,Vermont,Virginia,Washington,West Virginia,Wisconsin,Wyoming" },
      { id:"q_stage",    label:"Project Stage",                       type:"select",   required:true,  order:4, opts:"Development,Pre-Construction,Construction,Operational" },
      { id:"q_location", label:"Google Maps Link",                    type:"text",     required:false, order:5, opts:"" },
      { id:"q_notes",    label:"Brief Project Description",           type:"textarea", required:false, order:6, opts:"" }
    ];
    renderIQPanel();
  });
}

function saveIntakeQs() {
  // Pull current values from DOM into iqList
  iqList.forEach(function(q) {
    var lblEl  = document.getElementById("iq_lbl_"  + q.id);
    var typEl  = document.getElementById("iq_typ_"  + q.id);
    var optEl  = document.getElementById("iq_opt_"  + q.id);
    var reqEl  = document.getElementById("iq_req_"  + q.id);
    if (lblEl) q.label    = lblEl.value.trim()  || q.label;
    if (typEl) q.type     = typEl.value;
    if (optEl) q.opts     = optEl.value.trim();
    if (reqEl) q.required = reqEl.checked;
  });
  iqList.forEach(function(q, i) { q.order = i + 1; });

  saveConfig({ intake_questions: JSON.stringify(iqList) }, "iq-save-msg");
  renderIQPanel();
}

function addIQ() {
  iqList.push({
    id:       "q_" + Date.now(),
    label:    "New Question",
    type:     "text",
    opts:     "",
    required: false,
    order:    iqList.length + 1
  });
  renderIQPanel();
  setTimeout(function() {
    var last = document.querySelector("#iq-cards .iq-card:last-child");
    if (last) last.scrollIntoView({ behavior: "smooth", block: "center" });
  }, 60);
}

function deleteIQ(id) {
  if (!confirm("Delete this question? This cannot be undone.")) return;
  iqList = iqList.filter(function(q) { return q.id !== id; });
  renderIQPanel();
}

function moveIQ(id, dir) {
  var idx = iqList.findIndex(function(q) { return q.id === id; });
  var to  = idx + dir;
  if (idx < 0 || to < 0 || to >= iqList.length) return;
  // Read DOM values before re-render to preserve unsaved edits
  iqList.forEach(function(q) {
    var lblEl = document.getElementById("iq_lbl_" + q.id);
    var typEl = document.getElementById("iq_typ_" + q.id);
    var optEl = document.getElementById("iq_opt_" + q.id);
    var reqEl = document.getElementById("iq_req_" + q.id);
    if (lblEl) q.label    = lblEl.value;
    if (typEl) q.type     = typEl.value;
    if (optEl) q.opts     = optEl.value;
    if (reqEl) q.required = reqEl.checked;
  });
  var tmp       = iqList[idx];
  iqList[idx]   = iqList[to];
  iqList[to]    = tmp;
  renderIQPanel();
}

function iqTypeChange(id) {
  var el = document.getElementById("iq_typ_" + id);
  if (!el) return;
  var q = iqList.find(function(q) { return q.id === id; });
  if (q) q.type = el.value;
  var wrap = document.getElementById("iq_optwrap_" + id);
  if (wrap) wrap.style.display = el.value === "select" ? "block" : "none";
  var badge = document.getElementById("iq_typbadge_" + id);
  if (badge) { badge.textContent = el.value; badge.setAttribute("data-t", el.value); }
}

function iqLabelChange(id) {
  var el = document.getElementById("iq_lbl_" + id);
  if (!el) return;
  var q = iqList.find(function(q) { return q.id === id; });
  if (q) q.label = el.value;
  var hdr = document.getElementById("iq_hdrlbl_" + id);
  if (hdr) hdr.textContent = el.value || "Untitled";
}

function iqReqChange(id) {
  var el = document.getElementById("iq_req_" + id);
  if (!el) return;
  var q = iqList.find(function(q) { return q.id === id; });
  if (q) q.required = el.checked;
  var badge = document.getElementById("iq_reqbadge_" + id);
  if (badge) badge.style.display = el.checked ? "inline-flex" : "none";
}

function renderIQPanel() {
  var countEl = document.getElementById("iq-count");
  if (countEl) countEl.textContent = iqList.length;

  var container = document.getElementById("iq-cards");
  if (!container) return;

  if (!iqList.length) {
    container.innerHTML = '<div style="text-align:center;padding:48px 20px;color:#444;font-size:13px;">No questions yet. Click <strong>+ Add Question</strong> to start.</div>';
    return;
  }

  var TYPE_COLORS = {
    text:     "rgba(36,113,163,0.25);color:#7aa3f5",
    number:   "rgba(125,60,152,0.25);color:#c39af5",
    select:   "rgba(46,125,79,0.25);color:#6ec997",
    date:     "rgba(224,123,32,0.25);color:#f5a742",
    toggle:   "rgba(17,122,101,0.25);color:#4ecdc4",
    textarea: "rgba(90,90,90,0.25);color:#aaa"
  };

  container.innerHTML = iqList.map(function(q, i) {
    var tc  = TYPE_COLORS[q.type] || TYPE_COLORS.text;
    var last = i === iqList.length - 1;
    return '<div class="iq-card" id="iqcard_' + q.id + '" draggable="true" ' +
      'ondragstart="iqDragStart(event,\'' + q.id + '\')" ' +
      'ondragover="iqDragOver(event)" ' +
      'ondrop="iqDrop(event,\'' + q.id + '\')" ' +
      'ondragend="iqDragEnd()">' +

      // Header row
      '<div class="iq-card-hdr">' +
        '<span class="iq-drag">&#8942;&#8942;</span>' +
        '<span class="iq-hdr-label" id="iq_hdrlbl_' + q.id + '">' + escAdm(q.label) + '</span>' +
        '<span class="iq-req-badge" id="iq_reqbadge_' + q.id + '" style="display:' + (q.required ? "inline-flex" : "none") + ';">Required</span>' +
        '<span class="iq-type-badge" id="iq_typbadge_' + q.id + '" data-t="' + q.type + '" style="background:' + tc + '">' + q.type + '</span>' +
        '<button class="iq-move-btn" onclick="moveIQ(\'' + q.id + '\',-1)"' + (i === 0 ? ' disabled' : '') + '>&#8593;</button>' +
        '<button class="iq-move-btn" onclick="moveIQ(\'' + q.id + '\',1)"' + (last ? ' disabled' : '') + '>&#8595;</button>' +
      '</div>' +

      // Body
      '<div class="iq-card-body">' +
        '<div class="iq-row2">' +
          '<div>' +
            '<label class="iq-fl">Question Label</label>' +
            '<input class="iq-fi" id="iq_lbl_' + q.id + '" type="text" value="' + escAdm(q.label) + '" placeholder="e.g. Project Name" oninput="iqLabelChange(\'' + q.id + '\')" />' +
          '</div>' +
          '<div>' +
            '<label class="iq-fl">Field Type</label>' +
            '<select class="iq-fs" id="iq_typ_' + q.id + '" onchange="iqTypeChange(\'' + q.id + '\')">' +
              ['text','number','select','date','toggle','textarea'].map(function(t) {
                return '<option value="' + t + '"' + (q.type === t ? ' selected' : '') + '>' + t + '</option>';
              }).join('') +
            '</select>' +
          '</div>' +
        '</div>' +
        '<div id="iq_optwrap_' + q.id + '" style="display:' + (q.type === 'select' ? 'block' : 'none') + ';">' +
          '<label class="iq-fl">Options <span style="color:#555;font-weight:400;">(comma-separated)</span></label>' +
          '<input class="iq-fi" id="iq_opt_' + q.id + '" type="text" value="' + escAdm(q.opts || '') + '" placeholder="Option A, Option B, Option C" />' +
        '</div>' +
        '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:4px;">' +
          '<label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px;color:#aaa;">' +
            '<input type="checkbox" id="iq_req_' + q.id + '"' + (q.required ? ' checked' : '') + ' onchange="iqReqChange(\'' + q.id + '\')" style="accent-color:#FFFF00;width:13px;height:13px;"/>' +
            'Required field' +
          '</label>' +
          '<span style="font-size:9px;color:#2a2a2a;">id: ' + escAdm(q.id) + '</span>' +
          '<button class="iq-del-btn" onclick="deleteIQ(\'' + q.id + '\')">&#x2715; Delete</button>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join("");
}

/* Drag & drop reorder */
function iqDragStart(e, id) {
  iqDragId = id;
  e.dataTransfer.effectAllowed = "move";
  setTimeout(function() {
    var el = document.getElementById("iqcard_" + id);
    if (el) el.style.opacity = "0.4";
  }, 0);
}
function iqDragOver(e) { e.preventDefault(); return false; }
function iqDrop(e, targetId) {
  e.stopPropagation();
  if (!iqDragId || iqDragId === targetId) return;
  // Read DOM before re-render
  iqList.forEach(function(q) {
    var l = document.getElementById("iq_lbl_" + q.id);
    var t = document.getElementById("iq_typ_" + q.id);
    var o = document.getElementById("iq_opt_" + q.id);
    var r = document.getElementById("iq_req_" + q.id);
    if (l) q.label    = l.value;
    if (t) q.type     = t.value;
    if (o) q.opts     = o.value;
    if (r) q.required = r.checked;
  });
  var srcIdx = iqList.findIndex(function(q) { return q.id === iqDragId; });
  var tgtIdx = iqList.findIndex(function(q) { return q.id === targetId; });
  if (srcIdx < 0 || tgtIdx < 0) return;
  var moved = iqList.splice(srcIdx, 1)[0];
  iqList.splice(tgtIdx, 0, moved);
  renderIQPanel();
}
function iqDragEnd() {
  iqDragId = null;
  document.querySelectorAll(".iq-card").forEach(function(c) { c.style.opacity = ""; });
}

/* ================================================================
   FIELD REGISTRY ‚Äî Excel upload, parse, diff, publish
   ================================================================ */

var frParsed       = null;   // parsed registry object from Excel
var frCurrentReg   = null;   // registry currently live in admin_config

// Expected category sheet names ‚Üí CATEGORIES keys
var FR_CAT_SHEETS = [
  'score_permit','score_design','score_construct',
  'score_procurement','score_contract','score_intercon','score_financial'
];

/* Load current registry status from admin_config */
function frLoadCurrentStatus() {
  sb.from('admin_config').select('value').eq('key','field_registry_meta').single()
    .then(function(res) {
      var el = document.getElementById('fr-current-status');
      var hist = document.getElementById('fr-version-history');
      if (!el) return;
      if (res.error || !res.data) {
        el.className = 'fr-status-bar none';
        el.innerHTML = '<div class="fr-status-dot"></div><div class="fr-status-text">No registry uploaded yet ‚Äî hardcoded defaults are active.</div>';
        return;
      }
      try {
        var meta = JSON.parse(res.data.value);
        el.className = 'fr-status-bar ok';
        el.innerHTML = '<div class="fr-status-dot"></div>' +
          '<div class="fr-status-text">Registry <strong>' + escAdm(meta.version) + '</strong> active ‚Äî ' +
          escAdm(meta.total_fields) + ' fields across ' + escAdm(meta.total_cats) + ' categories. ' +
          'Published ' + new Date(meta.published_at).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}) + '</div>' +
          '<div class="fr-badge">' + escAdm(meta.version) + '</div>';
        // History
        if (meta.history && meta.history.length) {
          hist.style.display = 'block';
          var htbl = document.getElementById('fr-history-table');
          if (htbl) htbl.innerHTML = meta.history.slice().reverse().slice(0,5).map(function(h) {
            return '<tr><td>' + escAdm(h.version) + '</td><td>' + escAdm(h.total_fields) + ' fields</td>' +
              '<td>' + new Date(h.published_at).toLocaleDateString('en-GB') + '</td></tr>';
          }).join('');
        }
      } catch(e) {
        el.className = 'fr-status-bar warn';
        el.innerHTML = '<div class="fr-status-dot"></div><div class="fr-status-text">Registry metadata corrupt.</div>';
      }
    });

  // Also load the actual registry for diffing
  sb.from('admin_config').select('value').eq('key','field_registry').single()
    .then(function(res) {
      if (!res.error && res.data) {
        try { frCurrentReg = JSON.parse(res.data.value); } catch(e) { frCurrentReg = null; }
      }
    });
}

/* Handle drag drop */
function frHandleDrop(e) {
  e.preventDefault();
  document.getElementById('fr-drop-zone').classList.remove('drag');
  var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) frHandleFile(f);
}

/* Parse the uploaded Excel into a registry object */
function frHandleFile(file) {
  if (!file) return;
  if (!file.name.match(/\.xlsx$/i)) {
    frShowParseStatus('error', 'Invalid file type ‚Äî please upload a .xlsx file.', '');
    return;
  }
  document.getElementById('fr-preview-wrap').style.display = 'block';
  frShowParseStatus('none', 'Reading file‚Ä¶', '');

  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = new Uint8Array(e.target.result);
      var wb   = XLSX.read(data, { type: 'array' });

      var registry  = {};   // { catKey: [ {id,label,section,section_icon,type,opts,required,col}, ‚Ä¶ ] }
      var errors    = [];
      var totalFields = 0;
      var foundCats   = 0;

      FR_CAT_SHEETS.forEach(function(catKey) {
        // Accept sheet named exactly catKey OR the human label
        var sheetName = wb.SheetNames.find(function(n) {
          return n.trim() === catKey ||
                 n.trim().toLowerCase().replace(/[^a-z]/g,'') === catKey.replace(/[^a-z]/g,'');
        });
        if (!sheetName) {
          // Not present ‚Äî keep existing definition for this cat (won't overwrite)
          return;
        }
        var ws   = wb.Sheets[sheetName];
        var rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
        if (!rows.length) return;
        foundCats++;

        // sheet_to_json uses row 1 as headers. If the sheet has a hint row (row 2)
        // that SheetJS might pick up, normalise and filter it out.
        // Normalise column names: lowercase + trim
        var norm = rows.map(function(r) {
          var out = {};
          Object.keys(r).forEach(function(k) { out[k.trim().toLowerCase().replace(/^‚Ü≥\s*/,'')] = r[k]; });
          return out;
        // Filter: keep only rows where id is a non-empty string NOT starting with ‚Ü≥ or a space
        }).filter(function(r) {
          var id = String(r.id || '').trim();
          return id && !id.startsWith('‚Ü≥') && !id.startsWith('Field key') && id.length > 0;
        });

        // Validate required columns
        if (!rows.length || !('id' in rows[0]) && !('ID' in rows[0])) {
          // Try to detect if user uploaded with wrong header ‚Äî scan all SheetNames for id column
          var rawKeys = rows.length ? Object.keys(rows[0]) : [];
          var hasId = rawKeys.some(function(k){ return k.trim().toLowerCase() === 'id'; });
          if (!hasId) {
            errors.push('Sheet "' + sheetName + '" is missing required column: id  (found columns: ' + rawKeys.slice(0,5).join(', ') + ')');
            return;
          }
        }
        if (!norm.length) return; // empty after filtering

        // Check for duplicate IDs within sheet
        var seen = {};
        norm.forEach(function(r) {
          var id = String(r.id || '').trim();
          if (!id) return;
          if (seen[id]) errors.push('Duplicate field id "' + id + '" in sheet ' + sheetName);
          seen[id] = true;
        });

        registry[catKey] = norm.filter(function(r) { return String(r.id||'').trim(); }).map(function(r) {
          var opts = String(r.opts || '').trim();
          var optsArr = opts ? opts.split(',').map(function(o){return o.trim();}) : [];
          return {
            id:           String(r.id).trim(),
            label:        String(r.label || '').trim(),
            section:      String(r.section || 'General').trim(),
            section_icon: String(r.section_icon || 'üìã').trim(),
            type:         String(r.type || 'text').trim().toLowerCase(),
            opts:         optsArr,
            required:     String(r.required || '').toLowerCase() === 'true' || r.required === 1,
            col:          parseInt(r.col) === 2 ? 2 : 1
          };
        });
        totalFields += registry[catKey].length;
      });

      if (errors.length) {
        document.getElementById('fr-warn-wrap').style.display = 'block';
        document.getElementById('fr-warn-wrap').innerHTML = errors.map(function(e) {
          return '<p>‚ö† ' + escAdm(e) + '</p>';
        }).join('');
      } else {
        document.getElementById('fr-warn-wrap').style.display = 'none';
      }

      frParsed = { registry: registry, totalFields: totalFields, foundCats: foundCats };
      frRenderDiff(registry, totalFields, foundCats, errors.length > 0);

    } catch(err) {
      frShowParseStatus('error', 'Parse error: ' + err.message, '');
    }
  };
  reader.readAsArrayBuffer(file);
}

/* Build diff view comparing parsed vs current */
function frRenderDiff(registry, totalFields, foundCats, hasErrors) {
  var rows   = [];
  var newCnt = 0, changedCnt = 0, removedCnt = 0;

  FR_CAT_SHEETS.forEach(function(catKey) {
    var newFields = registry[catKey] || [];
    var oldFields = (frCurrentReg && frCurrentReg[catKey]) || [];
    var oldById   = {};
    oldFields.forEach(function(f) { oldById[f.id] = f; });
    var newById   = {};
    newFields.forEach(function(f) { newById[f.id] = f; });

    // New or changed
    newFields.forEach(function(f) {
      var old = oldById[f.id];
      if (!old) {
        rows.push({ id: f.id, label: f.label, cat: catKey, change: 'new' });
        newCnt++;
      } else if (old.label !== f.label || old.type !== f.type || old.section !== f.section) {
        rows.push({ id: f.id, label: f.label, cat: catKey, change: 'changed' });
        changedCnt++;
      }
    });

    // Removed
    oldFields.forEach(function(f) {
      if (!newById[f.id]) {
        rows.push({ id: f.id, label: f.label, cat: catKey, change: 'removed' });
        removedCnt++;
      }
    });
  });

  var summaryParts = [totalFields + ' fields', foundCats + ' sheets'];
  if (newCnt)     summaryParts.push('+' + newCnt + ' new');
  if (changedCnt) summaryParts.push(changedCnt + ' changed');
  if (removedCnt) summaryParts.push(removedCnt + ' removed');

  var statusClass = hasErrors ? 'error' : (removedCnt > 0 ? 'warn' : 'ok');
  var statusMsg   = hasErrors
    ? 'Errors found ‚Äî fix the Excel before publishing.'
    : (removedCnt > 0
      ? removedCnt + ' field(s) will be removed. Check scoring rules still reference valid IDs.'
      : 'Registry parsed successfully. Review changes below and publish when ready.');

  frShowParseStatus(statusClass, statusMsg, summaryParts.join('  ¬∑  '));

  // Render diff rows (show all if ‚â§50, else show changed/new/removed only)
  var showRows = rows.length ? rows : [{ id:'(no changes)', label:'All fields match current registry', cat:'', change:'ok' }];
  document.getElementById('fr-preview-rows').innerHTML = showRows.slice(0,60).map(function(r) {
    var cls = r.change === 'new' ? 'new-field' : r.change === 'changed' ? 'changed' : r.change === 'removed' ? 'removed' : '';
    var tag = r.change === 'new' ? '+ new' : r.change === 'changed' ? '~ changed' : r.change === 'removed' ? '‚úï removed' : '‚úì';
    return '<div class="fr-preview-row ' + cls + '">' +
      '<span>' + escAdm(r.id) + '</span>' +
      '<span>' + escAdm(r.label) + '</span>' +
      '<span>' + escAdm(r.cat) + '</span>' +
      '<span>' + tag + '</span></div>';
  }).join('');

  var publishBtn = document.getElementById('fr-publish-btn');
  if (publishBtn) publishBtn.disabled = hasErrors;
}

function frShowParseStatus(cls, msg, badge) {
  var el   = document.getElementById('fr-parse-status');
  var msgEl = document.getElementById('fr-parse-msg');
  var bdgEl = document.getElementById('fr-parse-badge');
  if (!el) return;
  el.className = 'fr-status-bar ' + cls;
  if (msgEl) msgEl.textContent = msg;
  if (bdgEl) { bdgEl.textContent = badge; bdgEl.style.display = badge ? 'inline-block' : 'none'; }
}

/* Publish ‚Äî save to admin_config */
function frPublish() {
  if (!frParsed) return;
  var publishBtn = document.getElementById('fr-publish-btn');
  if (publishBtn) { publishBtn.disabled = true; publishBtn.textContent = 'Publishing‚Ä¶'; }

  // Calculate version string
  var now     = new Date();
  var version = 'v' + now.getFullYear().toString().slice(2) + '.' +
    String(now.getMonth()+1).padStart(2,'0') + '.' +
    String(now.getDate()).padStart(2,'0') + '.' +
    String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');

  var meta = {
    version:      version,
    total_fields: frParsed.totalFields,
    total_cats:   frParsed.foundCats,
    published_at: now.toISOString(),
    history:      []
  };

  // Merge history from existing meta
  sb.from('admin_config').select('value').eq('key','field_registry_meta').single()
    .then(function(res) {
      if (!res.error && res.data) {
        try {
          var existing = JSON.parse(res.data.value);
          meta.history = (existing.history || []).concat([{
            version: existing.version,
            total_fields: existing.total_fields,
            published_at: existing.published_at
          }]).slice(-10); // keep last 10
        } catch(e) {}
      }

      // Save both registry data and meta
      var rows = [
        { key: 'field_registry',      value: JSON.stringify(frParsed.registry),  updated_at: now.toISOString() },
        { key: 'field_registry_meta', value: JSON.stringify(meta),               updated_at: now.toISOString() },
        { key: 'field_registry_version', value: version,                         updated_at: now.toISOString() }
      ];

      sb.auth.getSession().then(function(sessionRes) {
        var token  = sessionRes.data && sessionRes.data.session && sessionRes.data.session.access_token;
        var client = token
          ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth:{ persistSession:false }, global:{ headers:{ Authorization:'Bearer '+token } } })
          : sb;

        var chain = Promise.resolve();
        rows.forEach(function(row) {
          chain = chain.then(function() {
            return client.from('admin_config').upsert(row, { onConflict:'key' });
          });
        });
        chain.then(function() {
          // Also update local config
          config['field_registry']         = rows[0].value;
          config['field_registry_meta']     = rows[1].value;
          config['field_registry_version']  = version;
          showMsg('fr-save-msg');
          frLoadCurrentStatus();
          frCancelUpload();
          if (publishBtn) { publishBtn.disabled = false; publishBtn.textContent = '‚úì Publish Registry'; }
        }).catch(function(e) {
          alert('Publish failed: ' + e.message);
          if (publishBtn) { publishBtn.disabled = false; publishBtn.textContent = '‚úì Publish Registry'; }
        });
      });
    });
}

function frCancelUpload() {
  frParsed = null;
  document.getElementById('fr-preview-wrap').style.display = 'none';
  document.getElementById('fr-file-input').value = '';
}



/* ================================================================
   UNIVERSAL FIELD REGISTRY ‚Äî parses all 14 sheet types
   Sheets: 7 category specs | Design Arrays | Crews |
           Procurement Contracts | Components | Suppliers |
           Equipment | Intake Questions
   
   Every spec sheet uses the legacy column format:
     Row 1: Category title (merged)
     Row 2: blank
     Row 3: Headers ‚Äî col0=Sub-Category, col2="Field Label", col3=key, col4=type, col5=opts
     Data rows: section separator (col0 filled, col2/3 blank) OR field row
   
   Builder sheets (Design Arrays, Crews, Contracts, Components, Equipment):
     Row 1: title, Row 2: hint (sheet_type=xxx), Row 3: headers
     Data rows: section header (merged) OR field row (col0=type/section key)
   
   Suppliers sheet: flat ‚Äî all fields apply to all types
   Intake sheet: flat ‚Äî each row = one question
   ================================================================ */

var parsedRegistry = null;  // full payload saved to admin_config

/* ‚îÄ‚îÄ Category key lookup (for the 7 spec sheets) ‚îÄ‚îÄ */
var SHEET_TO_CAT = {
  'Design & Engineering':  'score_design',
  'Construction':          'score_construct',
  'Legal & Contract':      'score_contract',
  'Grid Interconnection':  'score_intercon',
  'Financial':             'score_financial',
  'Permitting':            'score_permit',
  'Procurement':           'score_procurement',
};

/* ‚îÄ‚îÄ Drag/drop helpers ‚îÄ‚îÄ */
function regDragOver(e)  { e.preventDefault(); document.getElementById('reg-drop-zone').classList.add('drag-over'); }
function regDragLeave()  { document.getElementById('reg-drop-zone').classList.remove('drag-over'); }
function regDrop(e) {
  e.preventDefault();
  document.getElementById('reg-drop-zone').classList.remove('drag-over');
  var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) parseRegistryFile(f);
}
function regFileSelected(input) {
  var f = input && input.files && input.files[0];
  if (f) parseRegistryFile(f);
}

/* ‚îÄ‚îÄ Parse spec sheet (7 category sheets) ‚îÄ‚îÄ */
function parseSpecSheet(ws, sheetName) {
  var rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
  // Find header row: col index 2 === "Field Label"
  var headerIdx = -1;
  for (var i = 0; i < rows.length; i++) {
    if (rows[i] && String(rows[i][2] || '').trim() === 'Field Label') { headerIdx = i; break; }
  }
  if (headerIdx < 0) return null;

  var sections = [], curSec = null;
  for (var r = headerIdx + 1; r < rows.length; r++) {
    var row   = rows[r]; if (!row) continue;
    var sub   = String(row[0] || '').trim();
    var label = row[2] != null ? String(row[2]).trim() : '';
    var key   = row[3] != null ? String(row[3]).trim() : '';
    var type  = row[4] != null ? String(row[4]).trim().toLowerCase() : '';
    var desc  = row[5] != null ? String(row[5]).trim() : '';
    if (sub.startsWith('Total fields')) break;
    if (!sub && !label && !key) continue;
    if (!label || !key) {
      if (sub) { curSec = { title: sub, icon: 'üìã', fields: [] }; sections.push(curSec); }
      continue;
    }
    if (key.indexOf('{id}') >= 0) continue;
    if (!curSec) { curSec = { title: 'General', icon: 'üìã', fields: [] }; sections.push(curSec); }
    var opts = [];
    if ((type === 'select') && desc && desc.indexOf('/') >= 0)
      opts = [''].concat(desc.split('/').map(function(o){ return o.trim(); }).filter(Boolean));
    curSec.fields.push({ id: key, lbl: label, field: key, type: type||'text', opts: opts, desc: desc });
  }
  return sections.length ? { key: SHEET_TO_CAT[sheetName], label: sheetName, sections: sections } : null;
}

/* ‚îÄ‚îÄ Parse a builder sheet (Design Arrays / Crews / Contracts / Components / Equipment) ‚îÄ‚îÄ
   Format: row 1 = title, row 2 = hint (sheet_type=xxx), row 3 = headers,
           section row = merged/all cols, field rows = col0=type_key, col2=label, col3=field, col4=type, col5=opts */
function parseBuilderSheet(ws) {
  var rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
  if (rows.length < 4) return null;

  // Find header row by looking for "Field Label" in any column
  var hdrIdx = -1;
  for (var i = 0; i < Math.min(5, rows.length); i++) {
    if (rows[i] && rows[i].some(function(c){ return String(c||'').trim() === 'Field Label'; }))
      { hdrIdx = i; break; }
  }
  if (hdrIdx < 0) hdrIdx = 2; // fallback to row 3

  var groups = {}, groupOrder = [];
  var curGroup = null;

  for (var r = hdrIdx + 1; r < rows.length; r++) {
    var row = rows[r]; if (!row) continue;
    var c0  = String(row[0] || '').trim();
    var c2  = row[2] != null ? String(row[2]).trim() : '';
    var c3  = row[3] != null ? String(row[3]).trim() : '';
    var c4  = row[4] != null ? String(row[4]).trim().toLowerCase() : '';
    var c5  = row[5] != null ? String(row[5]).trim() : '';

    // Section header: only col 0/1 have content and c2/c3 are blank, OR row is fully merged
    if (c2 === '' && c3 === '' && c0 !== '') {
      // Extract group key from [key=xxx] in title
      var keyMatch = c0.match(/\[(?:type|key)=([^\]]+)\]/);
      var groupKey = keyMatch ? keyMatch[1].trim() : c0.replace(/[^\w]/g,'_').toLowerCase();
      curGroup = groupKey;
      if (!groups[curGroup]) { groups[curGroup] = []; groupOrder.push(curGroup); }
      continue;
    }
    if (!c2 && !c3) continue;
    if (!curGroup) { curGroup = '__default'; if (!groups[curGroup]) { groups[curGroup] = []; groupOrder.push(curGroup); } }

    var opts2 = [];
    if (c4 === 'select' && c5 && c5.indexOf('/') >= 0)
      opts2 = [''].concat(c5.split('/').map(function(o){ return o.trim(); }).filter(Boolean));

    groups[curGroup].push({ id: c3, lbl: c2, field: c3, type: c4||'text', opts: opts2, desc: c5 });
  }

  if (!groupOrder.length) return null;
  return groupOrder.map(function(k){ return { key: k, fields: groups[k] }; });
}

/* ‚îÄ‚îÄ Parse Suppliers sheet (flat ‚Äî same fields for all types) ‚îÄ‚îÄ */
function parseSuppliersSheet(ws) {
  var rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
  var hdrIdx = -1;
  for (var i = 0; i < Math.min(6, rows.length); i++) {
    if (rows[i] && rows[i].some(function(c){ return String(c||'').trim() === 'Field Label'; }))
      { hdrIdx = i; break; }
  }
  if (hdrIdx < 0) return null;
  var fields = [];
  for (var r = hdrIdx + 1; r < rows.length; r++) {
    var row = rows[r]; if (!row) continue;
    var lbl = row[2] != null ? String(row[2]).trim() : '';
    var key = row[3] != null ? String(row[3]).trim() : '';
    var typ = row[4] != null ? String(row[4]).trim().toLowerCase() : '';
    var dsc = row[5] != null ? String(row[5]).trim() : '';
    if (!lbl || !key || key === 'field key') continue;
    var opts = [];
    if (typ === 'select' && dsc && dsc.indexOf('/') >= 0)
      opts = [''].concat(dsc.split('/').map(function(o){ return o.trim(); }).filter(Boolean));
    fields.push({ id: key, lbl: lbl, field: key, type: typ||'text', opts: opts, desc: dsc });
  }
  return fields.length ? fields : null;
}

/* ‚îÄ‚îÄ Parse Intake Questions sheet ‚îÄ‚îÄ */
function parseIntakeSheet(ws) {
  var rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
  var hdrIdx = -1;
  for (var i = 0; i < Math.min(5, rows.length); i++) {
    if (rows[i] && String(rows[i][1]||'').trim() === 'Label')
      { hdrIdx = i; break; }
  }
  if (hdrIdx < 0) return null;
  var qs = [];
  for (var r = hdrIdx + 1; r < rows.length; r++) {
    var row = rows[r]; if (!row) continue;
    var id  = String(row[0]||'').trim();
    var lbl = String(row[1]||'').trim();
    var typ = String(row[2]||'').trim().toLowerCase() || 'text';
    var req = String(row[3]||'').trim().toLowerCase() === 'true';
    var ord = parseInt(row[4]) || (r - hdrIdx);
    var opt = String(row[5]||'').trim();
    if (!id || !lbl) continue;
    qs.push({ id: id, label: lbl, type: typ, required: req, order: ord, opts: opt });
  }
  return qs.length ? qs : null;
}

/* ‚îÄ‚îÄ Master parse function ‚îÄ‚îÄ */
function parseRegistryFile(file) {
  var warn = document.getElementById('reg-warn');
  warn.className = 'reg-warn'; warn.textContent = '';
  document.getElementById('reg-preview').style.display = 'none';
  document.getElementById('reg-parse-status').style.display = 'none';
  document.getElementById('reg-publish-btn').style.display = 'none';
  parsedRegistry = null;

  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = new Uint8Array(e.target.result);
      var xlwb = XLSX.read(data, { type: 'array' });

      var payload = {
        categories:            [],   // 7 spec sheets
        design_array_sections: [],   // per-array sections
        crews:                 [],   // crew types
        procurement_contracts: [],   // contract sections
        components:            [],   // component types
        suppliers:             null, // flat field list
        equipment:             [],   // equipment types
        intake:                null, // intake questions
        total_sheets: 0,
        total_fields: 0,
      };

      var previewRows = [];
      var warnings = [];

      xlwb.SheetNames.forEach(function(sName) {
        if (sName === 'INDEX') return;
        var ws = xlwb.Sheets[sName];

        // ‚îÄ‚îÄ 7 Category spec sheets ‚îÄ‚îÄ
        if (SHEET_TO_CAT[sName]) {
          var cat = parseSpecSheet(ws, sName);
          if (cat) {
            payload.categories.push(cat);
            var fc = cat.sections.reduce(function(n,s){return n+s.fields.length;},0);
            payload.total_fields += fc;
            payload.total_sheets++;
            previewRows.push({ sheet: sName, icon:'üìã', count: fc, type:'Category spec' });
          }
          return;
        }

        var lname = sName.toLowerCase().replace(/[^a-z ]/g,'').trim();

        // ‚îÄ‚îÄ Design Arrays ‚îÄ‚îÄ
        if (lname === 'design arrays') {
          var groups = parseBuilderSheet(ws);
          if (groups) {
            payload.design_array_sections = groups;
            var fc2 = groups.reduce(function(n,g){return n+g.fields.length;},0);
            payload.total_fields += fc2; payload.total_sheets++;
            previewRows.push({ sheet: sName, icon:'‚òÄÔ∏è', count: fc2, type:'Design array sections (' + groups.length + ' sections)' });
          }
          return;
        }

        // ‚îÄ‚îÄ Construction Crews ‚îÄ‚îÄ
        if (lname === 'construction crews') {
          var cg = parseBuilderSheet(ws);
          if (cg) {
            payload.crews = cg;
            var fc3 = cg.reduce(function(n,g){return n+g.fields.length;},0);
            payload.total_fields += fc3; payload.total_sheets++;
            previewRows.push({ sheet: sName, icon:'üë∑', count: fc3, type:'Crew types (' + cg.length + ' types)' });
          }
          return;
        }

        // ‚îÄ‚îÄ Procurement Contracts ‚îÄ‚îÄ
        if (lname === 'procurement contracts') {
          var pcg = parseBuilderSheet(ws);
          if (pcg) {
            payload.procurement_contracts = pcg;
            var fc4 = pcg.reduce(function(n,g){return n+g.fields.length;},0);
            payload.total_fields += fc4; payload.total_sheets++;
            previewRows.push({ sheet: sName, icon:'üìë', count: fc4, type:'Contract sections (' + pcg.length + ' sections)' });
          }
          return;
        }

        // ‚îÄ‚îÄ Components ‚îÄ‚îÄ
        if (lname === 'components') {
          var compg = parseBuilderSheet(ws);
          if (compg) {
            payload.components = compg;
            var fc5 = compg.reduce(function(n,g){return n+g.fields.length;},0);
            payload.total_fields += fc5; payload.total_sheets++;
            previewRows.push({ sheet: sName, icon:'‚öôÔ∏è', count: fc5, type:'Component types (' + compg.length + ' types)' });
          }
          return;
        }

        // ‚îÄ‚îÄ Suppliers ‚îÄ‚îÄ
        if (lname === 'suppliers') {
          var supf = parseSuppliersSheet(ws);
          if (supf) {
            payload.suppliers = supf;
            payload.total_fields += supf.length; payload.total_sheets++;
            previewRows.push({ sheet: sName, icon:'üè¢', count: supf.length, type:'Supplier fields (shared by all types)' });
          }
          return;
        }

        // ‚îÄ‚îÄ Equipment ‚îÄ‚îÄ
        if (lname === 'equipment') {
          var eqg = parseBuilderSheet(ws);
          if (eqg) {
            payload.equipment = eqg;
            var fc6 = eqg.reduce(function(n,g){return n+g.fields.length;},0);
            payload.total_fields += fc6; payload.total_sheets++;
            previewRows.push({ sheet: sName, icon:'üöú', count: fc6, type:'Equipment types (' + eqg.length + ' types)' });
          }
          return;
        }

        // ‚îÄ‚îÄ Intake Questions ‚îÄ‚îÄ
        if (lname === 'intake questions') {
          var iqd = parseIntakeSheet(ws);
          if (iqd) {
            payload.intake = iqd;
            payload.total_fields += iqd.length; payload.total_sheets++;
            previewRows.push({ sheet: sName, icon:'üìù', count: iqd.length, type:'Intake questions' });
          }
          return;
        }
      });

      if (!previewRows.length) {
        showRegWarn('No recognisable sheets found. Make sure sheet names match exactly (see INDEX tab).');
        return;
      }

      // Show warnings
      if (warnings.length) {
        var wEl = document.getElementById('reg-warn');
        wEl.textContent = warnings.join(' ¬∑ ');
        wEl.className = 'reg-warn show';
      }

      parsedRegistry = payload;

      // Status bar
      var status = document.getElementById('reg-parse-status');
      var msg    = document.getElementById('reg-parse-msg');
      var badge  = document.getElementById('reg-parse-badge');
      status.style.display = '';
      status.className = 'fr-status-bar ok';
      msg.textContent = payload.total_sheets + ' sheets parsed ¬∑ ' + payload.total_fields + ' fields total';
      badge.textContent = payload.total_sheets + ' sheets'; badge.style.display = 'inline-block';

      // Preview
      var html = previewRows.map(function(r) {
        return '<div class="reg-cat-row">' +
          '<span class="reg-cat-dot" style="background:#2471a3;width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:6px;flex-shrink:0;"></span>' +
          '<span class="reg-cat-name" style="font-size:11px;color:#ccc;">' + r.icon + ' ' + escAdm(r.sheet) + '</span>' +
          '<span class="reg-cat-count" style="font-size:10px;color:#FFFF00;margin-left:auto;">' + r.count + ' fields</span>' +
          '</div>' +
          '<div style="padding:0 0 4px 18px;font-size:10px;color:#444;">' + r.type + '</div>';
      }).join('');
      document.getElementById('reg-preview-body').innerHTML = html;
      document.getElementById('reg-preview').style.display = 'block';
      document.getElementById('reg-publish-btn').style.display = 'inline-block';

    } catch(err) {
      showRegWarn('Parse error: ' + err.message);
      var st = document.getElementById('reg-parse-status');
      st.style.display = '';
      st.className = 'fr-status-bar error';
      document.getElementById('reg-parse-msg').textContent = 'Parse error: ' + err.message;
    }
  };
  reader.readAsArrayBuffer(file);
}

function showRegWarn(msg) {
  var el = document.getElementById('reg-warn');
  el.textContent = msg; el.className = 'reg-warn show';
}

/* ‚îÄ‚îÄ Publish ‚îÄ‚îÄ saves entire payload to admin_config ‚îÄ‚îÄ */
function publishRegistry() {
  if (!parsedRegistry) return;
  var btn = document.getElementById('reg-publish-btn');
  btn.disabled = true; btn.textContent = 'Publishing‚Ä¶';

  var now     = new Date();
  var version = 'v' + now.getFullYear().toString().slice(2) + '.' +
    String(now.getMonth()+1).padStart(2,'0') + '.' +
    String(now.getDate()).padStart(2,'0') + '.' +
    String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');

  // Build the flat catKey‚Üífields format applyFieldRegistry() reads
  var flatSpec = {};
  (parsedRegistry.categories||[]).forEach(function(cat) {
    flatSpec[cat.key] = [];
    (cat.sections||[]).forEach(function(sec) {
      (sec.fields||[]).forEach(function(f) {
        flatSpec[cat.key].push({
          id: f.id||f.field, label: f.lbl||f.label||'',
          section: sec.title, section_icon: sec.icon||'üìã',
          type: f.type||'text', opts: f.opts||[], required: false, col: f.col||1
        });
      });
    });
  });

  var rows = [
    { key: 'field_registry',         value: JSON.stringify(flatSpec) },
    { key: 'field_registry_version', value: version },
    { key: 'field_registry_date',    value: now.toISOString() },
    { key: 'field_registry_meta',    value: JSON.stringify({ version: version, total_sheets: parsedRegistry.total_sheets, total_fields: parsedRegistry.total_fields, published_at: now.toISOString() }) },
    // Builder payloads
    { key: 'reg_design_arrays',      value: JSON.stringify(parsedRegistry.design_array_sections||[]) },
    { key: 'reg_crews',              value: JSON.stringify(parsedRegistry.crews||[]) },
    { key: 'reg_procurement_contracts', value: JSON.stringify(parsedRegistry.procurement_contracts||[]) },
    { key: 'reg_components',         value: JSON.stringify(parsedRegistry.components||[]) },
    { key: 'reg_suppliers',          value: JSON.stringify(parsedRegistry.suppliers||[]) },
    { key: 'reg_equipment',          value: JSON.stringify(parsedRegistry.equipment||[]) },
  ];

  // Intake is saved separately via intake_questions key
  if (parsedRegistry.intake) {
    rows.push({ key: 'intake_questions', value: JSON.stringify(parsedRegistry.intake) });
  }

  rows.forEach(function(r) { r.updated_at = now.toISOString(); });

  sb.auth.getSession().then(function(sRes) {
    var token  = sRes.data && sRes.data.session && sRes.data.session.access_token;
    var client = token
      ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth:{ persistSession:false }, global:{ headers:{ Authorization:'Bearer '+token } } })
      : sb;
    var chain = Promise.resolve();
    rows.forEach(function(row) {
      chain = chain.then(function() {
        return client.from('admin_config').upsert({ key: row.key, value: row.value, updated_at: row.updated_at }, { onConflict: 'key' });
      });
    });
    chain.then(function() {
      var msg = document.getElementById('reg-save-msg');
      if (msg) { msg.style.opacity = 1; setTimeout(function(){ msg.style.opacity = 0; }, 2500); }
      loadRegistryStatus();
      btn.disabled = false; btn.textContent = '‚¨Ü Publish Registry';
    }).catch(function(e) {
      alert('Publish failed: ' + e.message);
      btn.disabled = false; btn.textContent = '‚¨Ü Publish Registry';
    });
  });
}

/* ‚îÄ‚îÄ Download current registry as Excel (re-fetches from Supabase, falls back to hardcoded) ‚îÄ‚îÄ */
function regDownloadTemplate() {
  var a = document.createElement('a');
  a.href = 'https://supabase.co'; // placeholder ‚Äî we just trigger download of the static template
  // Since we can't run Python in-browser, we tell the user to use the prebuilt template
  alert('The pre-built template is the SunHash_Field_Registry.xlsx file. To get the latest version reflecting any published edits, use the Query Supabase button to inspect the saved JSON, then re-export from the admin panel when the Excel-from-DB feature is added.');
}

/* ‚îÄ‚îÄ Query Supabase ‚Äî show current registry JSON ‚îÄ‚îÄ */
function regQuerySupabase() {
  var out  = document.getElementById('reg-supabase-out');
  var json = document.getElementById('reg-supabase-json');
  out.style.display = 'block';
  json.textContent = 'Loading‚Ä¶';
  sb.from('admin_config').select('key,value,updated_at')
    .in('key',['field_registry','field_registry_version','field_registry_date','field_registry_meta',
                'reg_design_arrays','reg_crews','reg_procurement_contracts','reg_components','reg_suppliers','reg_equipment','intake_questions'])
    .then(function(res) {
      if (res.error) { json.textContent = 'Error: ' + res.error.message; return; }
      var map = {};
      (res.data||[]).forEach(function(r) {
        try { map[r.key] = { updated_at: r.updated_at, data: JSON.parse(r.value) }; }
        catch(e) { map[r.key] = { updated_at: r.updated_at, raw: r.value }; }
      });
      json.textContent = JSON.stringify(map, null, 2);
    });
}

/* ‚îÄ‚îÄ Load and display current registry status ‚îÄ‚îÄ */
function loadRegistryStatus() {
  sb.from('admin_config').select('key,value')
    .in('key', ['field_registry_version','field_registry_date','field_registry_meta'])
    .then(function(res) {
      if (res.error || !res.data) return;
      var map = {};
      res.data.forEach(function(r) { map[r.key] = r.value; });

      var ver  = map['field_registry_version'] || '‚Äî';
      var date = map['field_registry_date'] ? new Date(map['field_registry_date']).toLocaleString() : '‚Äî';
      var meta = null;
      try { meta = map['field_registry_meta'] ? JSON.parse(map['field_registry_meta']) : null; } catch(e) {}

      var sheets = meta ? (meta.total_sheets || '‚Äî') : '‚Äî';
      var fields = meta ? (meta.total_fields || '‚Äî') : '‚Äî';

      var statusEl  = document.getElementById('reg-cur-status');
      var statusTxt = document.getElementById('reg-cur-status-txt');
      var badge     = document.getElementById('reg-cur-badge');
      if (statusEl) {
        if (ver !== '‚Äî') {
          statusEl.className = 'fr-status-bar ok';
          statusTxt.textContent = 'Registry ' + ver + ' active ¬∑ published ' + date;
          badge.textContent = ver; badge.style.display = 'inline-block';
        } else {
          statusEl.className = 'fr-status-bar none';
          statusTxt.textContent = 'No registry published yet ‚Äî hardcoded defaults are active.';
          badge.style.display = 'none';
        }
      }
      var vEl = document.getElementById('reg-cur-version');
      var dEl = document.getElementById('reg-cur-date');
      var cEl = document.getElementById('reg-cur-cats');
      var fEl = document.getElementById('reg-cur-fields');
      if (vEl) vEl.innerHTML = ver !== '‚Äî' ? '<span class="reg-version-badge">' + ver + '</span>' : '‚Äî';
      if (dEl) dEl.textContent = date;
      if (cEl) cEl.textContent = sheets;
      if (fEl) fEl.textContent = fields;
    });
}

/* ‚îÄ‚îÄ Hook into showPanel ‚îÄ‚îÄ */
var _origShowPanelReg = showPanel;
showPanel = function(id) {
  _origShowPanelReg.call(this, id);
  if (id === 'registry') loadRegistryStatus();
};


/* ================================================================
   SCORE WEIGHTS ‚Äî download template, upload rules, publish version
   ================================================================ */

var swParsed = null;

// Load status on panel open
var _origShowPanelSW = showPanel;
showPanel = function(id) {
  _origShowPanelSW.call(this, id);
  if (id === 'scoring_rules') swLoadStatus();
};

function swLoadStatus() {
  sb.from('admin_config').select('key,value')
    .in('key', ['scoring_rules_version', 'scoring_rules_date', 'scoring_rules'])
    .then(function(res) {
      if (res.error || !res.data) return;
      var map = {};
      res.data.forEach(function(r) { map[r.key] = r.value; });
      var ver  = map['scoring_rules_version'];
      var date = map['scoring_rules_date'];
      var el   = document.getElementById('sw-current-status');
      var txt  = document.getElementById('sw-status-text');
      var bdg  = document.getElementById('sw-version-badge');
      if (!el) return;
      if (ver) {
        el.className = 'fr-status-bar ok';
        txt.textContent = 'Scoring rules ' + ver + ' active ¬∑ published ' +
          new Date(date).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
        bdg.textContent = ver;
        bdg.style.display = 'inline-block';
      } else {
        el.className = 'fr-status-bar none';
        txt.textContent = 'No scoring rules uploaded yet ‚Äî default weights are active.';
        bdg.style.display = 'none';
      }
    });
}

/* Build and download scoring template using current field registry */
function swDownloadTemplate() {
  document.getElementById('sw-dl-hint').textContent = 'Loading registry‚Ä¶';

  Promise.all([
    sb.from('admin_config').select('value').eq('key','field_registry').single(),
    sb.from('admin_config').select('value').eq('key','scoring_rules').single()
  ]).then(function(results) {
    var regRes  = results[0];
    var rulesRes = results[1];

    var flat = {};
    if (!regRes.error && regRes.data) {
      try { flat = JSON.parse(regRes.data.value); } catch(e) {}
    }

    // Load existing rules for pre-filling weights
    var existingRules = {};
    if (!rulesRes.error && rulesRes.data) {
      try {
        var rules = JSON.parse(rulesRes.data.value);
        (rules.rules || rules).forEach && (rules.rules || rules).forEach(function(r){
          existingRules[r.field_id] = r;
        });
      } catch(e) {}
    }

    // Build CSV rows
    var rows = [['field_id','field_label','category','section','weight','logic','threshold','direction','notes']];

    var CAT_LABELS = {
      score_permit:'Permits', score_design:'Design', score_construct:'Construction',
      score_procurement:'Procurement', score_contract:'Legal',
      score_intercon:'Grid Connection', score_financial:'Finance'
    };

    Object.keys(flat).forEach(function(catKey) {
      var fields = flat[catKey] || [];
      fields.forEach(function(f) {
        var ex = existingRules[f.id] || {};
        rows.push([
          f.id,
          f.label,
          CAT_LABELS[catKey] || catKey,
          f.section || '',
          ex.weight     !== undefined ? ex.weight     : 1,
          ex.logic      || 'any',          // any | filled | equals | gte | lte | between
          ex.threshold  || '',             // value or "min,max" for between
          ex.direction  || 'higher_better',// higher_better | lower_better | neutral
          ex.notes      || ''
        ]);
      });
    });

    // Convert to CSV and trigger download
    var csv = rows.map(function(r) {
      return r.map(function(v) {
        var s = String(v === null || v === undefined ? '' : v);
        return (s.indexOf(',') >= 0 || s.indexOf('"') >= 0 || s.indexOf('\n') >= 0)
          ? '"' + s.replace(/"/g, '""') + '"' : s;
      }).join(',');
    }).join('\n');

    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href   = url;
    a.download = 'SunHash_Scoring_Rules.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    document.getElementById('sw-dl-hint').textContent = 'Downloaded ‚úì  ‚Äî edit and re-upload as .xlsx or .csv';
  });
}

function swHandleDrop(e) {
  e.preventDefault();
  document.getElementById('sw-drop-zone').classList.remove('drag');
  var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) swHandleFile(f);
}

function swHandleFile(file) {
  if (!file) return;
  var ext = file.name.split('.').pop().toLowerCase();
  if (ext !== 'xlsx' && ext !== 'csv') {
    alert('Please upload a .xlsx or .csv file');
    return;
  }
  document.getElementById('sw-preview-wrap').style.display = 'block';
  swSetStatus('none', 'Reading file‚Ä¶', '');

  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var rows;
      if (ext === 'csv') {
        // Parse CSV manually
        var text = e.target.result;
        var lines = text.split('\n').filter(function(l){ return l.trim(); });
        var headers = lines[0].split(',').map(function(h){ return h.trim().replace(/^"|"$/g,''); });
        rows = lines.slice(1).map(function(line) {
          // handle quoted commas
          var vals = []; var cur = ''; var inQ = false;
          for (var i=0;i<line.length;i++){
            var c=line[i];
            if(c==='"'){inQ=!inQ;}
            else if(c===','&&!inQ){vals.push(cur.replace(/^"|"$/g,'').replace(/""/g,'"'));cur='';}
            else{cur+=c;}
          }
          vals.push(cur.replace(/^"|"$/g,'').replace(/""/g,'"'));
          var obj = {};
          headers.forEach(function(h,i){ obj[h] = vals[i] !== undefined ? vals[i] : ''; });
          return obj;
        });
      } else {
        var data = new Uint8Array(e.target.result);
        var wb   = XLSX.read(data, { type: 'array' });
        rows     = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' });
      }

      // Validate
      if (!rows.length) { swSetStatus('error', 'File is empty.', ''); return; }
      var sample = rows[0];
      if (!('field_id' in sample)) { swSetStatus('error', 'Missing required column: field_id', ''); return; }
      if (!('weight' in sample))   { swSetStatus('error', 'Missing required column: weight', ''); return; }

      // Filter blank rows
      rows = rows.filter(function(r){ return String(r.field_id||'').trim(); });

      swParsed = rows;
      swSetStatus('ok', rows.length + ' rules parsed. Review and publish when ready.', rows.length + ' rules');

      // Preview
      document.getElementById('sw-preview-rows').innerHTML = rows.slice(0,40).map(function(r) {
        return '<div class="fr-preview-row" style="grid-template-columns:160px 1fr 80px 80px 80px;">' +
          '<span style="color:#7aa3f5;">' + escAdm(r.field_id) + '</span>' +
          '<span>' + escAdm(r.field_label||'') + '</span>' +
          '<span>' + escAdm(r.category||'') + '</span>' +
          '<span style="color:#FFFF00;">' + escAdm(String(r.weight)) + '</span>' +
          '<span>' + escAdm(r.logic||'any') + '</span>' +
          '</div>';
      }).join('');

      document.getElementById('sw-publish-btn').disabled = false;

    } catch(err) {
      swSetStatus('error', 'Parse error: ' + err.message, '');
    }
  };
  if (ext === 'csv') {
    reader.readAsText(file);
  } else {
    reader.readAsArrayBuffer(file);
  }
}

function swSetStatus(cls, msg, badge) {
  var el  = document.getElementById('sw-parse-status');
  var msgEl = document.getElementById('sw-parse-msg');
  var bdgEl = document.getElementById('sw-parse-badge');
  if (!el) return;
  el.className = 'fr-status-bar ' + cls;
  if (msgEl) msgEl.textContent = msg;
  if (bdgEl) { bdgEl.textContent = badge; bdgEl.style.display = badge ? 'inline-block' : 'none'; }
}

function swPublish() {
  if (!swParsed) return;
  var btn = document.getElementById('sw-publish-btn');
  btn.disabled = true;
  btn.textContent = 'Publishing‚Ä¶';

  var now     = new Date();
  var version = 'v' + now.getFullYear().toString().slice(2) + '.' +
    String(now.getMonth()+1).padStart(2,'0') + '.' +
    String(now.getDate()).padStart(2,'0') + '.' +
    String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');

  var payload = {
    version:    version,
    published_at: now.toISOString(),
    total_rules:  swParsed.length,
    rules: swParsed.map(function(r) {
      return {
        field_id:  String(r.field_id  || '').trim(),
        field_label: String(r.field_label || '').trim(),
        category:  String(r.category  || '').trim(),
        section:   String(r.section   || '').trim(),
        weight:    parseFloat(r.weight) || 1,
        logic:     String(r.logic     || 'any').trim(),
        threshold: String(r.threshold || '').trim(),
        direction: String(r.direction || 'higher_better').trim(),
        notes:     String(r.notes     || '').trim(),
      };
    })
  };

  var rows = [
    { key: 'scoring_rules',         value: JSON.stringify(payload),  updated_at: now.toISOString() },
    { key: 'scoring_rules_version', value: version,                  updated_at: now.toISOString() },
    { key: 'scoring_rules_date',    value: now.toISOString(),        updated_at: now.toISOString() },
  ];

  sb.auth.getSession().then(function(sessionRes) {
    var token  = sessionRes.data && sessionRes.data.session && sessionRes.data.session.access_token;
    var client = token
      ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth:{ persistSession:false }, global:{ headers:{ Authorization:'Bearer '+token } } })
      : sb;

    var chain = Promise.resolve();
    rows.forEach(function(row) {
      chain = chain.then(function() {
        return client.from('admin_config').upsert(row, { onConflict:'key' });
      });
    });
    chain.then(function() {
      var msg = document.getElementById('sw-save-msg');
      if (msg) { msg.style.opacity = 1; setTimeout(function(){ msg.style.opacity = 0; }, 2500); }
      swLoadStatus();
      swCancel();
      btn.disabled = false;
      btn.textContent = '‚úì Publish Scoring Rules';
    }).catch(function(e) {
      alert('Publish failed: ' + e.message);
      btn.disabled = false;
      btn.textContent = '‚úì Publish Scoring Rules';
    });
  });
}

function swCancel() {
  swParsed = null;
  document.getElementById('sw-preview-wrap').style.display = 'none';
  document.getElementById('sw-file-input').value = '';
}

</script>
</body>
</html>
