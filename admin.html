<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #0f1117; color: #e0e0e0; min-height: 100vh; }

/* Login screen */
.login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
.login-box { background: #1a1f2e; border-radius: 16px; padding: 36px 32px; width: 360px; box-shadow: 0 8px 40px rgba(0,0,0,0.4); }
.login-logo { font-size: 22px; font-weight: 900; text-transform: uppercase; color: #fff; margin-bottom: 4px; }
.login-logo span { color: #FFFF00; }
.login-sub { font-size: 11px; color: #444; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 28px; }
.login-field { margin-bottom: 14px; }
.login-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #666; margin-bottom: 5px; display: block; }
.login-input { width: 100%; padding: 10px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 13px; color: #fff; outline: none; }
.login-input:focus { border-color: #FFFF00; }
.login-btn { width: 100%; padding: 12px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 8px; margin-top: 8px; }
.login-btn:hover { background: #fff; }
.login-err { font-size: 12px; color: #e74c3c; margin-top: 10px; text-align: center; display: none; }

/* Admin layout */
.admin-screen { display: none; }
.topbar { height: 52px; background: #111; border-bottom: 2px solid #FFFF00; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; position: fixed; top: 0; left: 0; right: 0; z-index: 10; }
.topbar-logo { font-size: 18px; font-weight: 900; text-transform: uppercase; color: #fff; }
.topbar-logo span { color: #FFFF00; }
.topbar-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; background: #FFFF00; color: #1a1f2e; padding: 2px 8px; border-radius: 20px; margin-left: 8px; }
.topbar-right { display: flex; align-items: center; gap: 12px; }
.topbar-lock { font-size: 11px; color: #555; cursor: pointer; }
.topbar-lock:hover { color: #e74c3c; }

.admin-body { padding-top: 52px; display: flex; min-height: 100vh; }

/* Sidebar nav */
.admin-nav { width: 200px; background: #111; padding: 20px 0; position: fixed; top: 52px; bottom: 0; display: flex; flex-direction: column; gap: 2px; border-right: 1px solid #1e1e1e; }
.nav-item { padding: 10px 20px; font-size: 12px; font-weight: 600; color: #555; cursor: pointer; text-transform: uppercase; letter-spacing: 0.3px; transition: all .12s; border-left: 3px solid transparent; }
.nav-item:hover { color: #aaa; background: rgba(255,255,255,0.03); }
.nav-item.active { color: #FFFF00; border-left-color: #FFFF00; background: rgba(255,255,0,0.04); }
.nav-section { padding: 16px 20px 6px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #333; }

/* Main content */
.admin-main { margin-left: 200px; flex: 1; padding: 28px 32px; }
.admin-panel { display: none; }
.admin-panel.active { display: block; }
.panel-title { font-size: 20px; font-weight: 900; color: #fff; margin-bottom: 4px; }
.panel-sub { font-size: 12px; color: #555; margin-bottom: 24px; }

/* Cards */
.admin-card { background: #1a1f2e; border-radius: 12px; padding: 20px 22px; margin-bottom: 16px; }
.admin-card-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #FFFF00; opacity: 0.7; margin-bottom: 14px; }
.field-row { margin-bottom: 14px; }
.field-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #666; margin-bottom: 5px; display: block; }
.field-input { width: 100%; padding: 9px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; transition: border-color .12s; }
.field-input:focus { border-color: #FFFF00; }
.field-textarea { width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; resize: vertical; min-height: 120px; line-height: 1.6; transition: border-color .12s; }
.field-textarea:focus { border-color: #FFFF00; }
.field-hint { font-size: 10px; color: #444; margin-top: 4px; }
.save-btn { padding: 9px 22px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.save-btn:hover { background: #fff; }
.save-msg { font-size: 11px; color: #2e7d4f; margin-left: 12px; opacity: 0; transition: opacity .3s; display: inline-block; }
.save-msg.show { opacity: 1; }

/* Data Sources panel */
.ds-toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.ds-search { flex: 1; min-width: 200px; padding: 9px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; }
.ds-search::placeholder { color: #444; }
.ds-search:focus { border-color: #FFFF00; }
.ds-filter { padding: 9px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #aaa; outline: none; cursor: pointer; }
.ds-filter:focus { border-color: #FFFF00; }
.ds-add-btn { padding: 9px 18px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; white-space: nowrap; }
.ds-add-btn:hover { background: #fff; }

/* Source card grid */
.ds-grid { display: flex; flex-direction: column; gap: 10px; }
.ds-card { background: #1a1f2e; border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.04); transition: border-color .15s; }
.ds-card:hover { border-color: rgba(255,255,0,0.15); }
.ds-card-top { display: flex; align-items: center; gap: 14px; padding: 14px 18px; cursor: pointer; }
.ds-status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.ds-status-dot.active   { background: #2e7d4f; box-shadow: 0 0 6px rgba(46,125,79,0.5); }
.ds-status-dot.inactive { background: #555; }
.ds-status-dot.error    { background: #c0392b; box-shadow: 0 0 6px rgba(192,57,43,0.5); }
.ds-card-name { font-size: 13px; font-weight: 700; color: #fff; flex: 1; }
.ds-card-type { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; padding: 2px 9px; border-radius: 20px; flex-shrink: 0; }
.ds-card-type.api      { background: rgba(30,80,200,0.18); color: #7aa3f5; }
.ds-card-type.webpage  { background: rgba(100,50,200,0.18); color: #b08af5; }
.ds-card-type.file     { background: rgba(46,125,79,0.18); color: #6ec997; }
.ds-card-type.scrape   { background: rgba(180,83,9,0.18); color: #f5a742; }
.ds-card-category { font-size: 10px; color: #555; margin-left: auto; padding-right: 4px; }
.ds-card-chevron { font-size: 10px; color: #444; transition: transform .2s; flex-shrink: 0; }
.ds-card-chevron.open { transform: rotate(180deg); }
.ds-card-body { display: none; padding: 0 18px 16px; border-top: 1px solid rgba(255,255,255,0.04); }
.ds-card-body.open { display: block; }
.ds-field-row { margin-bottom: 12px; margin-top: 12px; }
.ds-field-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #555; margin-bottom: 5px; display: block; }
.ds-field-input { width: 100%; padding: 8px 11px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; transition: border-color .12s; }
.ds-field-input:focus { border-color: #FFFF00; }
.ds-field-textarea { width: 100%; padding: 8px 11px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; resize: vertical; min-height: 80px; line-height: 1.6; transition: border-color .12s; }
.ds-field-textarea:focus { border-color: #FFFF00; }
.ds-field-hint { font-size: 10px; color: #444; margin-top: 4px; }
.ds-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.ds-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.ds-card-actions { display: flex; align-items: center; gap: 8px; margin-top: 14px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
.ds-save-btn { padding: 7px 18px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; }
.ds-save-btn:hover { background: #fff; }
.ds-test-btn { padding: 7px 16px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: #aaa; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.ds-test-btn:hover { border-color: #FFFF00; color: #FFFF00; }
.ds-del-btn { padding: 7px 16px; background: none; border: 1px solid rgba(192,57,43,0.3); color: #c0392b; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; margin-left: auto; transition: all .12s; }
.ds-del-btn:hover { background: #c0392b; color: #fff; border-color: #c0392b; }
.ds-save-msg { font-size: 11px; color: #2e7d4f; opacity: 0; transition: opacity .3s; }
.ds-save-msg.show { opacity: 1; }
.ds-test-result { font-size: 11px; margin-top: 8px; padding: 8px 11px; border-radius: 7px; display: none; line-height: 1.5; }
.ds-test-result.ok  { background: rgba(46,125,79,0.12); color: #6ec997; display: block; }
.ds-test-result.err { background: rgba(192,57,43,0.12); color: #f08080; display: block; }

/* Add modal */
.ds-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; display: none; align-items: center; justify-content: center; }
.ds-modal-overlay.open { display: flex; }
.ds-modal { background: #1a1f2e; border-radius: 14px; padding: 28px 26px; width: 560px; max-width: 95vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 12px 60px rgba(0,0,0,0.5); }
.ds-modal h3 { font-size: 16px; font-weight: 900; color: #fff; margin-bottom: 4px; }
.ds-modal-sub { font-size: 12px; color: #555; margin-bottom: 22px; }
.ds-type-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; margin-bottom: 20px; }
.ds-type-btn { padding: 10px 6px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 9px; cursor: pointer; text-align: center; transition: all .12s; }
.ds-type-btn:hover, .ds-type-btn.selected { border-color: #FFFF00; background: rgba(255,255,0,0.06); }
.ds-type-icon { font-size: 22px; margin-bottom: 4px; }
.ds-type-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #aaa; }
.ds-modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 22px; }
.ds-modal-cancel { padding: 9px 18px; background: rgba(255,255,255,0.06); border: none; color: #aaa; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 20px; }
.ds-modal-create { padding: 9px 22px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; }
.ds-modal-create:hover { background: #fff; }
.ds-empty-state { text-align: center; padding: 48px 20px; color: #444; }
.ds-empty-icon { font-size: 36px; margin-bottom: 12px; opacity: 0.4; }
.ds-empty-text { font-size: 13px; margin-bottom: 6px; color: #555; }
.ds-empty-sub { font-size: 11px; color: #333; }
.score-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.threshold-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.threshold-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.threshold-label { font-size: 11px; color: #aaa; width: 60px; }
.threshold-input { width: 70px; padding: 5px 9px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; text-align: center; }
.threshold-suffix { font-size: 11px; color: #555; }

/* User table */
.user-table { width: 100%; border-collapse: collapse; }
.user-table th { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #555; padding: 8px 12px; text-align: left; border-bottom: 1px solid #222; }
.user-table td { font-size: 12px; color: #aaa; padding: 10px 12px; border-bottom: 1px solid #1a1a1a; }
.user-table tr:hover td { background: rgba(255,255,255,0.02); }
.user-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 2px 8px; border-radius: 20px; }
.user-badge.pro { background: rgba(255,255,0,0.15); color: #FFFF00; }
.user-badge.free { background: rgba(255,255,255,0.06); color: #666; }
.user-count { font-size: 24px; font-weight: 900; color: #fff; }
.user-count-lbl { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 0.4px; margin-top: 2px; }
.stats-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 20px; }
.stat-box { background: #1a1f2e; border-radius: 10px; padding: 14px 16px; }
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">Sun<span>Hash</span></div>
    <div class="login-sub">Admin Panel</div>
    <div class="login-field">
      <label class="login-label">Username</label>
      <input class="login-input" id="adm-user" type="text" autocomplete="off" onkeydown="if(event.key==='Enter')adminLogin()"/>
    </div>
    <div class="login-field">
      <label class="login-label">Password</label>
      <input class="login-input" id="adm-pass" type="password" onkeydown="if(event.key==='Enter')adminLogin()"/>
    </div>
    <button class="login-btn" onclick="adminLogin()">Enter Admin</button>
    <div class="login-err" id="login-err">Invalid credentials</div>
  </div>
</div>

<!-- ADMIN -->
<div class="admin-screen" id="admin-screen">
  <div class="topbar">
    <div style="display:flex;align-items:center;">
      <span class="topbar-logo">Sun<span>Hash</span></span>
      <span class="topbar-badge">Admin</span>
    </div>
    <div class="topbar-right">
      <span class="topbar-lock" onclick="adminLogout()">&#128274; Lock</span>
    </div>
  </div>

  <div class="admin-body">
    <div class="admin-nav">
      <div class="nav-section">Verification</div>
      <div class="nav-item" onclick="showPanel('datasources')">Data Sources</div>
      <div class="nav-section">Content</div>
      <div class="nav-item active" onclick="showPanel('terms')">Terms & Conditions</div>
      <div class="nav-section">AI Configuration</div>
      <div class="nav-item" onclick="showPanel('prompts')">GPT Prompts</div>
      <div class="nav-section">Scoring</div>
      <div class="nav-item" onclick="showPanel('scoring')">Score Thresholds</div>
      <div class="nav-item" onclick="showPanel('required')">Required Fields</div>
      <div class="nav-section">Users</div>
      <div class="nav-item" onclick="showPanel('users')">User Management</div>
      <div class="nav-section">Security</div>
      <div class="nav-item" onclick="showPanel('credentials')">Admin Credentials</div>
    </div>

    <div class="admin-main">

      <!-- TERMS -->
      <div class="admin-panel active" id="panel-terms">
        <div class="panel-title">Terms & Conditions</div>
        <div class="panel-sub">This text is shown to users at signup. Update the version number when making significant changes.</div>
        <div class="admin-card">
          <div class="admin-card-title">Current T&C</div>
          <div class="field-row">
            <label class="field-label">Version</label>
            <input class="field-input" id="terms-version" type="text" style="width:120px;" placeholder="e.g. 1.0"/>
          </div>
          <div class="field-row">
            <label class="field-label">Terms Text</label>
            <textarea class="field-textarea" id="terms-text" style="min-height:200px;" placeholder="Enter your terms and conditions text..."></textarea>
            <div class="field-hint">Plain text. Line breaks are preserved.</div>
          </div>
          <button class="save-btn" onclick="saveTerms()">Save Terms</button>
          <span class="save-msg" id="msg-terms">Saved</span>
        </div>
      </div>

      <!-- PROMPTS -->
      <div class="admin-panel" id="panel-prompts">
        <div class="panel-title">GPT Prompts</div>
        <div class="panel-sub">System prompts sent to OpenAI. Changes take effect immediately on next AI request.</div>
        <div class="admin-card">
          <div class="admin-card-title">Project Brief Prompt (generate-overview)</div>
          <div class="field-row">
            <textarea class="field-textarea" id="prompt-overview" style="min-height:150px;"></textarea>
            <div class="field-hint">Injected as the system prompt when generating the AI project brief on the overview page.</div>
          </div>
          <button class="save-btn" onclick="savePrompt('overview')">Save</button>
          <span class="save-msg" id="msg-prompt-overview">Saved</span>
        </div>
        <div style="font-size:11px;color:#555;margin-bottom:14px;line-height:1.6;">Each category has its own system prompt. The AI will only answer questions relevant to that category. Leave blank to use the built-in default.</div>
        <div class="admin-card">
          <div class="admin-card-title">Design & Engineering Q&A Prompt</div>
          <div class="field-row">
            <textarea class="field-textarea" id="prompt-cat-design" style="min-height:120px;" placeholder="Leave blank to use default prompt for Design & Engineering..."></textarea>
            <div class="field-hint">Overrides the default Design & Engineering system prompt. The AI will restrict answers to Design & Engineering topics only.</div>
          </div>
          <button class="save-btn" onclick="saveCatPrompt('design')">Save</button>
          <span class="save-msg" id="msg-cat-design">Saved</span>
        </div>
        <div class="admin-card">
          <div class="admin-card-title">Construction Q&A Prompt</div>
          <div class="field-row">
            <textarea class="field-textarea" id="prompt-cat-construct" style="min-height:120px;" placeholder="Leave blank to use default prompt for Construction..."></textarea>
            <div class="field-hint">Overrides the default Construction system prompt. The AI will restrict answers to Construction topics only.</div>
          </div>
          <button class="save-btn" onclick="saveCatPrompt('construct')">Save</button>
          <span class="save-msg" id="msg-cat-construct">Saved</span>
        </div>
        <div class="admin-card">
          <div class="admin-card-title">Legal & Contract Q&A Prompt</div>
          <div class="field-row">
            <textarea class="field-textarea" id="prompt-cat-contract" style="min-height:120px;" placeholder="Leave blank to use default prompt for Legal & Contract..."></textarea>
            <div class="field-hint">Overrides the default Legal & Contract system prompt. The AI will restrict answers to Legal & Contract topics only.</div>
          </div>
          <button class="save-btn" onclick="saveCatPrompt('contract')">Save</button>
          <span class="save-msg" id="msg-cat-contract">Saved</span>
        </div>
        <div class="admin-card">
          <div class="admin-card-title">Grid Interconnection Q&A Prompt</div>
          <div class="field-row">
            <textarea class="field-textarea" id="prompt-cat-intercon" style="min-height:120px;" placeholder="Leave blank to use default prompt for Grid Interconnection..."></textarea>
            <div class="field-hint">Overrides the default Grid Interconnection system prompt. The AI will restrict answers to Grid Interconnection topics only.</div>
          </div>
          <button class="save-btn" onclick="saveCatPrompt('intercon')">Save</button>
          <span class="save-msg" id="msg-cat-intercon">Saved</span>
        </div>
        <div class="admin-card">
          <div class="admin-card-title">Financial Q&A Prompt</div>
          <div class="field-row">
            <textarea class="field-textarea" id="prompt-cat-financial" style="min-height:120px;" placeholder="Leave blank to use default prompt for Financial..."></textarea>
            <div class="field-hint">Overrides the default Financial system prompt. The AI will restrict answers to Financial topics only.</div>
          </div>
          <button class="save-btn" onclick="saveCatPrompt('financial')">Save</button>
          <span class="save-msg" id="msg-cat-financial">Saved</span>
        </div>
        <div class="admin-card">
          <div class="admin-card-title">Permitting Q&A Prompt</div>
          <div class="field-row">
            <textarea class="field-textarea" id="prompt-cat-permit" style="min-height:120px;" placeholder="Leave blank to use default prompt for Permitting..."></textarea>
            <div class="field-hint">Overrides the default Permitting system prompt. The AI will restrict answers to Permitting topics only.</div>
          </div>
          <button class="save-btn" onclick="saveCatPrompt('permit')">Save</button>
          <span class="save-msg" id="msg-cat-permit">Saved</span>
        </div>
        <div class="admin-card">
          <div class="admin-card-title">Procurement Q&A Prompt</div>
          <div class="field-row">
            <textarea class="field-textarea" id="prompt-cat-procurement" style="min-height:120px;" placeholder="Leave blank to use default prompt for Procurement..."></textarea>
            <div class="field-hint">Overrides the default Procurement system prompt. The AI will restrict answers to Procurement topics only.</div>
          </div>
          <button class="save-btn" onclick="saveCatPrompt('procurement')">Save</button>
          <span class="save-msg" id="msg-cat-procurement">Saved</span>
        </div>

      </div>

      <!-- DATA SOURCES -->
      <div class="admin-panel" id="panel-datasources">
        <div class="panel-title">Data Sources</div>
        <div class="panel-sub">APIs, webpages, and files used by the cross-verification engine. Add, configure, enable, or disable without redeploying.</div>

        <div class="ds-toolbar">
          <input class="ds-search" id="ds-search" type="text" placeholder="Search sources..." oninput="filterSources()"/>
          <select class="ds-filter" id="ds-filter-type" onchange="filterSources()">
            <option value="">All types</option>
            <option value="api">API</option>
            <option value="webpage">Webpage</option>
            <option value="file">File / CSV</option>
            <option value="scrape">Scrape</option>
          </select>
          <select class="ds-filter" id="ds-filter-cat" onchange="filterSources()">
            <option value="">All categories</option>
            <option value="solar">Solar Yield</option>
            <option value="financial">Financial</option>
            <option value="weather">Weather / Climate</option>
            <option value="land">Land & Site</option>
            <option value="regulatory">Regulatory</option>
            <option value="grid">Grid & Power</option>
            <option value="cost">Cost Benchmarks</option>
            <option value="environmental">Environmental</option>
            <option value="labor">Labor & Compliance</option>
            <option value="other">Other</option>
          </select>
          <button class="ds-add-btn" onclick="openAddSourceModal()">&#43; Add Source</button>
        </div>

        <div class="ds-grid" id="ds-grid">
          <div class="ds-empty-state">
            <div class="ds-empty-icon">üîå</div>
            <div class="ds-empty-text">Loading sources...</div>
          </div>
        </div>
      </div>

      <!-- Add Source Modal -->
      <div class="ds-modal-overlay" id="ds-modal-overlay">
        <div class="ds-modal">
          <h3>Add Data Source</h3>
          <div class="ds-modal-sub">Choose the type of source you want to connect.</div>
          <div class="ds-type-grid" id="ds-type-grid">
            <div class="ds-type-btn selected" onclick="selectSourceType('api',this)">
              <div class="ds-type-icon">‚ö°</div>
              <div class="ds-type-label">REST API</div>
            </div>
            <div class="ds-type-btn" onclick="selectSourceType('webpage',this)">
              <div class="ds-type-icon">üåê</div>
              <div class="ds-type-label">Webpage</div>
            </div>
            <div class="ds-type-btn" onclick="selectSourceType('file',this)">
              <div class="ds-type-icon">üìÑ</div>
              <div class="ds-type-label">File / CSV</div>
            </div>
            <div class="ds-type-btn" onclick="selectSourceType('scrape',this)">
              <div class="ds-type-icon">üï∑</div>
              <div class="ds-type-label">Scrape</div>
            </div>
          </div>

          <div class="ds-row-2">
            <div class="ds-field-row">
              <label class="ds-field-label">Source Name *</label>
              <input class="ds-field-input" id="new-ds-name" type="text" placeholder="e.g. NREL PVWatts V8"/>
            </div>
            <div class="ds-field-row">
              <label class="ds-field-label">Category *</label>
              <select class="ds-field-input" id="new-ds-category">
                <option value="solar">Solar Yield</option>
                <option value="financial">Financial</option>
                <option value="weather">Weather / Climate</option>
                <option value="land">Land & Site</option>
                <option value="regulatory">Regulatory</option>
                <option value="grid">Grid & Power</option>
                <option value="cost">Cost Benchmarks</option>
                <option value="environmental">Environmental</option>
                <option value="labor">Labor & Compliance</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="ds-field-row">
            <label class="ds-field-label">Base URL / Endpoint *</label>
            <input class="ds-field-input" id="new-ds-url" type="url" placeholder="https://developer.nrel.gov/api/pvwatts/v8.json"/>
          </div>

          <div class="ds-field-row">
            <label class="ds-field-label">Description</label>
            <input class="ds-field-input" id="new-ds-desc" type="text" placeholder="What this source verifies"/>
          </div>

          <div class="ds-modal-actions">
            <button class="ds-modal-cancel" onclick="closeAddSourceModal()">Cancel</button>
            <button class="ds-modal-create" onclick="createSource()">Add Source</button>
          </div>
        </div>
      </div>

      <!-- SCORING -->
      <div class="admin-panel" id="panel-scoring">
        <div class="panel-title">Score Thresholds</div>
        <div class="panel-sub">Define the score boundaries for red, yellow, and green status across all categories and the timeline.</div>
        <div class="admin-card">
          <div class="admin-card-title">Category Score Colours</div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#2e7d4f;"></div>
            <span class="threshold-label">Green above</span>
            <input class="threshold-input" id="score-green" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#e07b20;"></div>
            <span class="threshold-label">Yellow above</span>
            <input class="threshold-input" id="score-yellow" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#c0392b;"></div>
            <span class="threshold-label">Red below</span>
            <span style="font-size:11px;color:#555;" id="score-red-label">--</span>
          </div>
          <button class="save-btn" onclick="saveScoreThresholds()">Save</button>
          <span class="save-msg" id="msg-scoring">Saved</span>
        </div>
        <div class="admin-card">
          <div class="admin-card-title">Timeline Milestone Thresholds (based on Permit score)</div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#2e7d4f;"></div>
            <span class="threshold-label">Green above</span>
            <input class="threshold-input" id="tl-green" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#e07b20;"></div>
            <span class="threshold-label">Yellow above</span>
            <input class="threshold-input" id="tl-yellow" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <button class="save-btn" onclick="saveTimelineThresholds()">Save</button>
          <span class="save-msg" id="msg-timeline">Saved</span>
        </div>
      </div>

      <!-- REQUIRED FIELDS -->
      <div class="admin-panel" id="panel-required">
        <div class="panel-title">Required Fields</div>
        <div class="panel-sub">Comma-separated field keys for each category. Used to calculate the completeness indicator on each button.</div>
        <div class="admin-card">
          <div class="admin-card-title">Per-Category Required Fields</div>
          <div id="required-fields-body"></div>
          <button class="save-btn" onclick="saveRequiredFields()">Save All</button>
          <span class="save-msg" id="msg-required">Saved</span>
        </div>
      </div>

      <!-- USERS -->
      <div class="admin-panel" id="panel-users">
        <div class="panel-title">User Management</div>
        <div class="panel-sub">All registered accounts. Subscription status reflects latest Stripe sync.</div>
        <div class="stats-row" id="user-stats"></div>
        <div class="admin-card">
          <div class="admin-card-title">All Users</div>
          <table class="user-table">
            <thead><tr><th>Email</th><th>Joined</th><th>Plan</th><th>T&C Accepted</th><th>Projects</th></tr></thead>
            <tbody id="user-table-body"><tr><td colspan="5" style="color:#444;text-align:center;padding:20px;">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- CREDENTIALS -->
      <div class="admin-panel" id="panel-credentials">
        <div class="panel-title">Admin Credentials</div>
        <div class="panel-sub">Change the username and password used to access this admin panel.</div>
        <div class="admin-card">
          <div class="admin-card-title">Update Login</div>
          <div class="field-row">
            <label class="field-label">New Username</label>
            <input class="field-input" id="new-username" type="text" style="max-width:300px;"/>
          </div>
          <div class="field-row">
            <label class="field-label">New Password</label>
            <input class="field-input" id="new-password" type="password" style="max-width:300px;"/>
          </div>
          <div class="field-row">
            <label class="field-label">Confirm Password</label>
            <input class="field-input" id="new-password2" type="password" style="max-width:300px;"/>
          </div>
          <button class="save-btn" onclick="saveCredentials()">Update Credentials</button>
          <span class="save-msg" id="msg-credentials">Updated</span>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

var CONFIG_KEYS = [
  "admin_username","admin_password","terms_text","terms_version",
  "prompt_overview","prompt_category_qa",
  "score_green_threshold","score_yellow_threshold",
  "timeline_permit_green","timeline_permit_yellow",
  "cat_required_design","cat_required_construct","cat_required_contract",
  "cat_required_intercon","cat_required_financial","cat_required_permit"
];

var config = {};
var CAT_LABELS = {
  design: "Design & Engineering", construct: "Construction",
  contract: "Legal & Contract", intercon: "Grid Interconnection",
  financial: "Financial", permit: "Permitting"
};

/* ---- AUTH ---- */
function adminLogin() {
  var user = document.getElementById("adm-user").value.trim();
  var pass = document.getElementById("adm-pass").value.trim();

  // Load config to verify credentials
  sb.from("admin_config").select("key,value").then(function(res) {
    if (res.error) { showLoginErr("Database error: " + res.error.message); return; }
    var cfg = {};
    (res.data || []).forEach(function(r) { cfg[r.key] = r.value; });

    var validUser = cfg["admin_username"] || "sunhash_admin";
    var validPass = cfg["admin_password"] || "SunHash2026!";

    if (user === validUser && pass === validPass) {
      config = cfg;
      sessionStorage.setItem("admin_auth", "1");
      showAdmin();
    } else {
      showLoginErr("Invalid credentials");
    }
  });
}

function showLoginErr(msg) {
  var el = document.getElementById("login-err");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(function() { el.style.display = "none"; }, 3000);
}

function adminLogout() {
  sessionStorage.removeItem("admin_auth");
  document.getElementById("admin-screen").style.display = "none";
  document.getElementById("login-screen").style.display = "flex";
  document.getElementById("adm-pass").value = "";
}

function showAdmin() {
  document.getElementById("login-screen").style.display = "none";
  document.getElementById("admin-screen").style.display = "block";
  populateFields();
  loadUsers();
}

// Check session on load
window.addEventListener("load", function() {
  if (sessionStorage.getItem("admin_auth") === "1") {
    sb.from("admin_config").select("key,value").then(function(res) {
      if (!res.error) {
        (res.data || []).forEach(function(r) { config[r.key] = r.value; });
        showAdmin();
      }
    });
  }
});

/* ---- NAVIGATION ---- */
function showPanel(id) {
  document.querySelectorAll(".admin-panel").forEach(function(p) { p.classList.remove("active"); });
  document.querySelectorAll(".nav-item").forEach(function(n) { n.classList.remove("active"); });
  document.getElementById("panel-" + id).classList.add("active");
  event.target.classList.add("active");
  if (id === "users") loadUsers();
}

/* ---- POPULATE ---- */
function populateFields() {
  setValue("terms-version",    config["terms_version"]         || "1.0");
  setValue("terms-text",       config["terms_text"]            || "");
  setValue("prompt-overview",  config["prompt_overview"]       || "");
  setValue("prompt-category-qa", config["prompt_category_qa"] || "");
  setValue("score-green",      config["score_green_threshold"] || "70");
  setValue("score-yellow",     config["score_yellow_threshold"]|| "40");
  setValue("tl-green",         config["timeline_permit_green"] || "70");
  setValue("tl-yellow",        config["timeline_permit_yellow"]|| "40");
  updateRedLabel();

  // Per-category AI prompts
  var catKeys = ['design','construct','contract','intercon','financial','permit','procurement'];
  catKeys.forEach(function(k) {
    var el = document.getElementById('prompt-cat-' + k);
    if (el) el.value = config['prompt_cat_' + k] || '';
  });

  // Required fields per category
  var body = document.getElementById("required-fields-body");
  body.innerHTML = Object.keys(CAT_LABELS).map(function(cat) {
    var val = config["cat_required_" + cat] || "";
    return '<div class="field-row">' +
      '<label class="field-label">' + CAT_LABELS[cat] + '</label>' +
      '<input class="field-input" id="req-' + cat + '" type="text" value="' + val + '"/>' +
      '<div class="field-hint">Comma-separated field keys. Used for completeness indicator.</div>' +
    '</div>';
  }).join("");
}

function setValue(id, val) {
  var el = document.getElementById(id);
  if (el) el.value = val;
}

function updateRedLabel() {
  var y = document.getElementById("score-yellow");
  var lbl = document.getElementById("score-red-label");
  if (y && lbl) lbl.textContent = "Score below " + (y.value || "40");
}
document.addEventListener("input", function(e) {
  if (e.target.id === "score-yellow") updateRedLabel();
});

/* ---- SAVE FUNCTIONS ---- */
function saveConfig(updates, msgId) {
  var rows = Object.keys(updates).map(function(k) {
    return { key: k, value: String(updates[k]), updated_at: new Date().toISOString() };
  });
  var chain = Promise.resolve();
  rows.forEach(function(row) {
    chain = chain.then(function() {
      return sb.from("admin_config").upsert(row, { onConflict: "key" });
    });
  });
  chain.then(function() {
    Object.assign(config, updates);
    showMsg(msgId);
  }).catch(function(e) { alert("Save failed: " + e.message); });
}

function showMsg(id) {
  var el = document.getElementById(id);
  if (!el) return;
  el.classList.add("show");
  setTimeout(function() { el.classList.remove("show"); }, 2500);
}

function saveTerms() {
  saveConfig({
    terms_text:    document.getElementById("terms-text").value,
    terms_version: document.getElementById("terms-version").value
  }, "msg-terms");
}

function savePrompt(key) {
  var inputId = key === "overview" ? "prompt-overview" : "prompt-category-qa";
  var configKey = "prompt_" + key;
  var updates = {};
  updates[configKey] = document.getElementById(inputId).value;
  saveConfig(updates, "msg-prompt-" + key);
}

function saveScoreThresholds() {
  saveConfig({
    score_green_threshold:  document.getElementById("score-green").value,
    score_yellow_threshold: document.getElementById("score-yellow").value
  }, "msg-scoring");
}

function saveTimelineThresholds() {
  saveConfig({
    timeline_permit_green:  document.getElementById("tl-green").value,
    timeline_permit_yellow: document.getElementById("tl-yellow").value
  }, "msg-timeline");
}

function saveRequiredFields() {
  var updates = {};
  Object.keys(CAT_LABELS).forEach(function(cat) {
    var el = document.getElementById("req-" + cat);
    if (el) updates["cat_required_" + cat] = el.value.trim();
  });
  saveConfig(updates, "msg-required");
}

function saveCredentials() {
  var u  = document.getElementById("new-username").value.trim();
  var p  = document.getElementById("new-password").value;
  var p2 = document.getElementById("new-password2").value;
  if (!u || !p) { alert("Username and password required."); return; }
  if (p !== p2) { alert("Passwords do not match."); return; }
  saveConfig({ admin_username: u, admin_password: p }, "msg-credentials");
  document.getElementById("new-password").value  = "";
  document.getElementById("new-password2").value = "";
}

/* ---- USERS ---- */
function loadUsers() {
  sb.from("profiles").select("id, email, subscription_status, subscription_plan, terms_accepted_at, created_at")
    .order("created_at", { ascending: false })
    .then(function(res) {
      if (res.error) { console.error(res.error); return; }
      var users = res.data || [];
      var pro   = users.filter(function(u) { return u.subscription_status === "active"; }).length;
      var tac   = users.filter(function(u) { return u.terms_accepted_at; }).length;

      document.getElementById("user-stats").innerHTML =
        stat(users.length, "Total Users") +
        stat(pro, "Pro Subscribers") +
        stat(users.length - pro, "Free Users") +
        stat(tac, "T&C Accepted");

      // Load project counts
      sb.from("projects").select("user_id").then(function(pr) {
        var counts = {};
        (pr.data || []).forEach(function(p) { counts[p.user_id] = (counts[p.user_id] || 0) + 1; });

        document.getElementById("user-table-body").innerHTML = users.map(function(u) {
          var plan = u.subscription_status === "active"
            ? '<span class="user-badge pro">' + (u.subscription_plan || "Pro") + '</span>'
            : '<span class="user-badge free">Free</span>';
          var tac = u.terms_accepted_at
            ? new Date(u.terms_accepted_at).toLocaleDateString("en-GB")
            : '<span style="color:#444;">No</span>';
          var joined = new Date(u.created_at).toLocaleDateString("en-GB", {day:"2-digit",month:"short",year:"numeric"});
          return '<tr>' +
            '<td>' + (u.email || u.id.slice(0,8) + "...") + '</td>' +
            '<td>' + joined + '</td>' +
            '<td>' + plan + '</td>' +
            '<td>' + tac + '</td>' +
            '<td>' + (counts[u.id] || 0) + '</td>' +
            '</tr>';
        }).join("");
      });
    });
}

function stat(val, lbl) {
  return '<div class="stat-box"><div class="user-count">' + val + '</div><div class="user-count-lbl">' + lbl + '</div></div>';
}
/* =============================================
   DATA SOURCES PANEL
   ============================================= */
var allSources = [];
var newSourceType = 'api';

// Load sources when panel shown
var _origShowPanel = showPanel;
showPanel = function(id) {
  _origShowPanel.call(this, id);
  if (id === 'datasources') loadSources();
};

function loadSources() {
  sb.from('data_sources').select('*').order('created_at', { ascending: false })
    .then(function(res) {
      if (res.error) { console.error('DS load error:', res.error); return; }
      allSources = res.data || [];
      renderSources(allSources);
    });
}

var CAT_LABELS_DS = {
  solar:'Solar Yield', financial:'Financial', weather:'Weather / Climate',
  land:'Land & Site', regulatory:'Regulatory', grid:'Grid & Power',
  cost:'Cost Benchmarks', environmental:'Environmental', labor:'Labor & Compliance', other:'Other'
};
var TYPE_LABELS = { api:'API', webpage:'Webpage', file:'File / CSV', scrape:'Scrape' };

function filterSources() {
  var q    = (document.getElementById('ds-search').value || '').toLowerCase();
  var type = document.getElementById('ds-filter-type').value;
  var cat  = document.getElementById('ds-filter-cat').value;
  var filtered = allSources.filter(function(s) {
    var matchQ = !q || (s.name||'').toLowerCase().includes(q) || (s.description||'').toLowerCase().includes(q) || (s.base_url||'').toLowerCase().includes(q);
    var matchT = !type || s.source_type === type;
    var matchC = !cat  || s.category === cat;
    return matchQ && matchT && matchC;
  });
  renderSources(filtered);
}

function renderSources(sources) {
  var grid = document.getElementById('ds-grid');
  if (!sources.length) {
    grid.innerHTML = '<div class="ds-empty-state"><div class="ds-empty-icon">üîå</div><div class="ds-empty-text">No sources found.</div><div class="ds-empty-sub">Click "+ Add Source" to connect your first API or webpage.</div></div>';
    return;
  }
  grid.innerHTML = sources.map(function(s) { return buildSourceCard(s); }).join('');
}

function buildSourceCard(s) {
  var statusCls = s.enabled ? (s.last_test_ok === false ? 'error' : 'active') : 'inactive';
  var typeCls   = s.source_type || 'api';
  var typeLabel = TYPE_LABELS[typeCls] || typeCls;
  var catLabel  = CAT_LABELS_DS[s.category] || s.category || '';
  var freq_opts = ['realtime','hourly','daily','weekly','monthly','manual'].map(function(f) {
    return '<option value="' + f + '"' + (s.refresh_frequency===f?' selected':'') + '>' + f.charAt(0).toUpperCase()+f.slice(1) + '</option>';
  }).join('');
  var cat_opts = Object.keys(CAT_LABELS_DS).map(function(k) {
    return '<option value="'+k+'"'+(s.category===k?' selected':'')+'>'+CAT_LABELS_DS[k]+'</option>';
  }).join('');
  var type_opts = Object.keys(TYPE_LABELS).map(function(k) {
    return '<option value="'+k+'"'+(s.source_type===k?' selected':'')+'>'+TYPE_LABELS[k]+'</option>';
  }).join('');
  var lastTested = s.last_tested_at ? new Date(s.last_tested_at).toLocaleString() : 'Never';
  var testResult = '';
  if (s.last_test_ok === true)  testResult = '<div class="ds-test-result ok">‚úì Last test passed ‚Äî ' + lastTested + '</div>';
  if (s.last_test_ok === false) testResult = '<div class="ds-test-result err">‚úó Last test failed ‚Äî ' + lastTested + (s.last_test_error ? '<br>' + escAdm(s.last_test_error) : '') + '</div>';

  return '<div class="ds-card" id="dscard-' + s.id + '">' +
    '<div class="ds-card-top" onclick="toggleDsCard(\'' + s.id + '\')">' +
      '<div class="ds-status-dot ' + statusCls + '"></div>' +
      '<span class="ds-card-name">' + escAdm(s.name) + '</span>' +
      '<span class="ds-card-type ' + typeCls + '">' + typeLabel + '</span>' +
      '<span class="ds-card-category">' + escAdm(catLabel) + '</span>' +
      '<span class="ds-card-chevron" id="dsv-' + s.id + '">‚ñº</span>' +
    '</div>' +
    '<div class="ds-card-body" id="dsbody-' + s.id + '">' +
      '<div class="ds-row-3">' +
        '<div class="ds-field-row"><label class="ds-field-label">Source Name</label>' +
          '<input class="ds-field-input" id="dsf-name-' + s.id + '" value="' + escAdm(s.name) + '"/></div>' +
        '<div class="ds-field-row"><label class="ds-field-label">Type</label>' +
          '<select class="ds-field-input" id="dsf-type-' + s.id + '">' + type_opts + '</select></div>' +
        '<div class="ds-field-row"><label class="ds-field-label">Category</label>' +
          '<select class="ds-field-input" id="dsf-cat-' + s.id + '">' + cat_opts + '</select></div>' +
      '</div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Base URL / Endpoint</label>' +
        '<input class="ds-field-input" id="dsf-url-' + s.id + '" type="url" value="' + escAdm(s.base_url||'') + '"/>' +
        '<div class="ds-field-hint">Full URL. Use {PARAM} placeholders for dynamic values, e.g. {lat}, {lon}, {api_key}</div></div>' +
      '<div class="ds-row-2">' +
        '<div class="ds-field-row"><label class="ds-field-label">API Key / Auth Token</label>' +
          '<input class="ds-field-input" id="dsf-key-' + s.id + '" type="password" value="' + escAdm(s.api_key||'') + '" placeholder="Leave blank if none"/></div>' +
        '<div class="ds-field-row"><label class="ds-field-label">Refresh Frequency</label>' +
          '<select class="ds-field-input" id="dsf-freq-' + s.id + '">' + freq_opts + '</select></div>' +
      '</div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Request Parameters (JSON)</label>' +
        '<textarea class="ds-field-textarea" id="dsf-params-' + s.id + '" placeholder=\'{"format":"json","units":"metric"}\'>' + escAdm(s.request_params||'') + '</textarea>' +
        '<div class="ds-field-hint">Extra query parameters sent with every request. Use {project_lat}, {project_lon}, {api_key} as runtime substitutions.</div></div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Response Path (dot notation)</label>' +
        '<input class="ds-field-input" id="dsf-path-' + s.id + '" value="' + escAdm(s.response_path||'') + '" placeholder="e.g. outputs.ac_annual or data[0].value"/>' +
        '<div class="ds-field-hint">Where to find the benchmark value in the JSON response. Leave blank for full response.</div></div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Verification Rules (one per line)</label>' +
        '<textarea class="ds-field-textarea" id="dsf-rules-' + s.id + '" style="min-height:100px;" placeholder="e.g. user_yield > baseline * 1.15 ‚Üí RED \'Yield exceeds satellite model\'">' + escAdm(s.verification_rules||'') + '</textarea>' +
        '<div class="ds-field-hint">Plain-text rule descriptions. The cross-verify edge function reads these to apply logic.</div></div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Notes / Documentation</label>' +
        '<textarea class="ds-field-textarea" id="dsf-notes-' + s.id + '" style="min-height:60px;">' + escAdm(s.notes||'') + '</textarea></div>' +
      '<div class="ds-field-row" style="display:flex;align-items:center;gap:12px;">' +
        '<label style="font-size:11px;color:#aaa;cursor:pointer;display:flex;align-items:center;gap:7px;">' +
          '<input type="checkbox" id="dsf-enabled-' + s.id + '"' + (s.enabled?' checked':'') + ' style="accent-color:#FFFF00;width:14px;height:14px;cursor:pointer;"/> Enabled' +
        '</label>' +
        '<label style="font-size:11px;color:#aaa;cursor:pointer;display:flex;align-items:center;gap:7px;">' +
          '<input type="checkbox" id="dsf-cache-' + s.id + '"' + (s.cache_results?' checked':'') + ' style="accent-color:#FFFF00;width:14px;height:14px;cursor:pointer;"/> Cache results in market_benchmarks' +
        '</label>' +
      '</div>' +
      testResult +
      '<div class="ds-card-actions">' +
        '<button class="ds-save-btn" onclick="saveSource(\'' + s.id + '\')">Save</button>' +
        '<button class="ds-test-btn" onclick="testSource(\'' + s.id + '\')">Test Connection</button>' +
        '<span class="ds-save-msg" id="ds-msg-' + s.id + '">Saved</span>' +
        '<button class="ds-del-btn" onclick="deleteSource(\'' + s.id + '\',\'' + escAdm(s.name) + '\')">Delete</button>' +
      '</div>' +
    '</div>' +
  '</div>';
}

function toggleDsCard(id) {
  var body = document.getElementById('dsbody-' + id);
  var chev = document.getElementById('dsv-' + id);
  if (!body) return;
  var isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  if (chev) chev.classList.toggle('open', !isOpen);
}

function escAdm(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function saveSource(id) {
  var updates = {
    name:               (document.getElementById('dsf-name-' + id)||{}).value || '',
    source_type:        (document.getElementById('dsf-type-' + id)||{}).value || 'api',
    category:           (document.getElementById('dsf-cat-' + id)||{}).value  || 'other',
    base_url:           (document.getElementById('dsf-url-' + id)||{}).value  || '',
    api_key:            (document.getElementById('dsf-key-' + id)||{}).value  || '',
    refresh_frequency:  (document.getElementById('dsf-freq-' + id)||{}).value || 'manual',
    request_params:     (document.getElementById('dsf-params-' + id)||{}).value || '',
    response_path:      (document.getElementById('dsf-path-' + id)||{}).value  || '',
    verification_rules: (document.getElementById('dsf-rules-' + id)||{}).value || '',
    notes:              (document.getElementById('dsf-notes-' + id)||{}).value || '',
    enabled:            (document.getElementById('dsf-enabled-' + id)||{}).checked || false,
    cache_results:      (document.getElementById('dsf-cache-' + id)||{}).checked || false,
    updated_at:         new Date().toISOString()
  };
  sb.from('data_sources').update(updates).eq('id', id).then(function(res) {
    if (res.error) { alert('Save failed: ' + res.error.message); return; }
    // update local cache
    var idx = allSources.findIndex(function(s) { return s.id === id; });
    if (idx >= 0) Object.assign(allSources[idx], updates);
    var msg = document.getElementById('ds-msg-' + id);
    if (msg) { msg.classList.add('show'); setTimeout(function() { msg.classList.remove('show'); }, 2500); }
  });
}

function testSource(id) {
  var src = allSources.find(function(s) { return s.id === id; });
  if (!src) return;
  var btn  = document.querySelector('#dscard-' + id + ' .ds-test-btn');
  if (btn) { btn.textContent = 'Testing...'; btn.disabled = true; }

  // Attempt a lightweight HEAD/GET to the base URL
  var url  = src.base_url || '';
  var ok   = false;
  var errMsg = '';

  if (!url) { recordTestResult(id, false, 'No URL configured', btn); return; }

  fetch(url, { method: 'HEAD', mode: 'no-cors' })
    .then(function() {
      // no-cors always "succeeds" ‚Äî treat as reachable
      recordTestResult(id, true, '', btn);
    })
    .catch(function(err) {
      recordTestResult(id, false, err.message, btn);
    });
}

function recordTestResult(id, success, errMsg, btn) {
  var now = new Date().toISOString();
  var update = { last_tested_at: now, last_test_ok: success, last_test_error: errMsg || null, updated_at: now };
  sb.from('data_sources').update(update).eq('id', id).then(function() {
    Object.assign(allSources.find(function(s){return s.id===id;})||{}, update);
    if (btn) { btn.textContent = 'Test Connection'; btn.disabled = false; }
    // Re-render just this card
    var card = document.getElementById('dscard-' + id);
    var src  = allSources.find(function(s){return s.id===id;});
    if (card && src) {
      var wasOpen = document.getElementById('dsbody-' + id).classList.contains('open');
      card.outerHTML = buildSourceCard(src);
      if (wasOpen) {
        document.getElementById('dsbody-' + id).classList.add('open');
        document.getElementById('dsv-' + id).classList.add('open');
      }
    }
  });
}

function deleteSource(id, name) {
  if (!confirm('Delete source "' + name + '"? This cannot be undone.')) return;
  sb.from('data_sources').delete().eq('id', id).then(function(res) {
    if (res.error) { alert('Delete failed: ' + res.error.message); return; }
    allSources = allSources.filter(function(s) { return s.id !== id; });
    renderSources(allSources);
  });
}

/* Add modal */
function openAddSourceModal() {
  document.getElementById('ds-modal-overlay').classList.add('open');
  document.getElementById('new-ds-name').value = '';
  document.getElementById('new-ds-url').value  = '';
  document.getElementById('new-ds-desc').value = '';
  newSourceType = 'api';
  document.querySelectorAll('.ds-type-btn').forEach(function(b,i) {
    b.classList.toggle('selected', i===0);
  });
}

function closeAddSourceModal() {
  document.getElementById('ds-modal-overlay').classList.remove('open');
}

function selectSourceType(type, el) {
  newSourceType = type;
  document.querySelectorAll('.ds-type-btn').forEach(function(b) { b.classList.remove('selected'); });
  el.classList.add('selected');
}

function createSource() {
  var name = (document.getElementById('new-ds-name').value||'').trim();
  var url  = (document.getElementById('new-ds-url').value||'').trim();
  var cat  = document.getElementById('new-ds-category').value;
  var desc = (document.getElementById('new-ds-desc').value||'').trim();
  if (!name) { alert('Source name is required.'); return; }
  var row = {
    name: name, source_type: newSourceType, category: cat,
    base_url: url, description: desc,
    enabled: true, cache_results: false,
    refresh_frequency: 'manual',
    api_key: '', request_params: '', response_path: '',
    verification_rules: '', notes: '',
    created_at: new Date().toISOString(), updated_at: new Date().toISOString()
  };
  sb.from('data_sources').insert(row).select().then(function(res) {
    if (res.error) { alert('Create failed: ' + res.error.message); return; }
    var created = res.data && res.data[0];
    if (created) { allSources.unshift(created); renderSources(allSources); }
    closeAddSourceModal();
    // Auto-open new card
    if (created) {
      setTimeout(function() { toggleDsCard(created.id); }, 100);
    }
  });
}

// Close modal on overlay click
document.getElementById('ds-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeAddSourceModal();
});
  var el = document.getElementById('prompt-cat-' + catKey);
  if (!el) return;
  var updates = {};
  updates['prompt_cat_' + catKey] = el.value.trim();
  saveConfig(updates, 'msg-cat-' + catKey);
}
</script>
</body>
</html>
