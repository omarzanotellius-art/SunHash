<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #0f1117; color: #e0e0e0; min-height: 100vh; }

/* Login screen */
.login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
.login-box { background: #1a1f2e; border-radius: 16px; padding: 36px 32px; width: 360px; box-shadow: 0 8px 40px rgba(0,0,0,0.4); }
.login-logo { font-size: 22px; font-weight: 900; text-transform: uppercase; color: #fff; margin-bottom: 4px; }
.login-logo span { color: #FFFF00; }
.login-sub { font-size: 11px; color: #444; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 28px; }
.login-field { margin-bottom: 14px; }
.login-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #666; margin-bottom: 5px; display: block; }
.login-input { width: 100%; padding: 10px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 13px; color: #fff; outline: none; }
.login-input:focus { border-color: #FFFF00; }
.login-btn { width: 100%; padding: 12px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 8px; margin-top: 8px; }
.login-btn:hover { background: #fff; }
.login-err { font-size: 12px; color: #e74c3c; margin-top: 10px; text-align: center; display: none; }

/* Admin layout */
.admin-screen { display: none; }
.topbar { height: 52px; background: #111; border-bottom: 2px solid #FFFF00; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; position: fixed; top: 0; left: 0; right: 0; z-index: 10; }
.topbar-logo { font-size: 18px; font-weight: 900; text-transform: uppercase; color: #fff; }
.topbar-logo span { color: #FFFF00; }
.topbar-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; background: #FFFF00; color: #1a1f2e; padding: 2px 8px; border-radius: 20px; margin-left: 8px; }
.topbar-right { display: flex; align-items: center; gap: 12px; }
.topbar-lock { font-size: 11px; color: #555; cursor: pointer; }
.topbar-lock:hover { color: #e74c3c; }

.admin-body { padding-top: 52px; display: flex; min-height: 100vh; }

/* Sidebar nav */
.admin-nav { width: 200px; background: #111; padding: 20px 0; position: fixed; top: 52px; bottom: 0; display: flex; flex-direction: column; gap: 2px; border-right: 1px solid #1e1e1e; }
.nav-item { padding: 10px 20px; font-size: 12px; font-weight: 600; color: #555; cursor: pointer; text-transform: uppercase; letter-spacing: 0.3px; transition: all .12s; border-left: 3px solid transparent; }
.nav-item:hover { color: #aaa; background: rgba(255,255,255,0.03); }
.nav-item.active { color: #FFFF00; border-left-color: #FFFF00; background: rgba(255,255,0,0.04); }
.nav-section { padding: 16px 20px 6px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #333; }

/* Main content */
.admin-main { margin-left: 200px; flex: 1; padding: 28px 32px; }
.admin-panel { display: none; }
.admin-panel.active { display: block; }
.panel-title { font-size: 20px; font-weight: 900; color: #fff; margin-bottom: 4px; }
.panel-sub { font-size: 12px; color: #555; margin-bottom: 24px; }

/* Cards */
.admin-card { background: #1a1f2e; border-radius: 12px; padding: 20px 22px; margin-bottom: 16px; }
.admin-card-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #FFFF00; opacity: 0.7; margin-bottom: 14px; }
.field-row { margin-bottom: 14px; }
.field-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #666; margin-bottom: 5px; display: block; }
.field-input { width: 100%; padding: 9px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; transition: border-color .12s; }
.field-input:focus { border-color: #FFFF00; }
.field-textarea { width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; resize: vertical; min-height: 120px; line-height: 1.6; transition: border-color .12s; }
.field-textarea:focus { border-color: #FFFF00; }
.field-hint { font-size: 10px; color: #444; margin-top: 4px; }
.save-btn { padding: 9px 22px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.save-btn:hover { background: #fff; }
.save-msg { font-size: 11px; color: #2e7d4f; margin-left: 12px; opacity: 0; transition: opacity .3s; display: inline-block; }
.save-msg.show { opacity: 1; }

/* Data Sources panel */
.ds-toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.ds-search { flex: 1; min-width: 200px; padding: 9px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; }
.ds-search::placeholder { color: #444; }
.ds-search:focus { border-color: #FFFF00; }
.ds-filter { padding: 9px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #aaa; outline: none; cursor: pointer; }
.ds-filter:focus { border-color: #FFFF00; }
.ds-add-btn { padding: 9px 18px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; white-space: nowrap; }
.ds-add-btn:hover { background: #fff; }

/* Source card grid */
.ds-grid { display: flex; flex-direction: column; gap: 10px; }
.ds-card { background: #1a1f2e; border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.04); transition: border-color .15s; }
.ds-card:hover { border-color: rgba(255,255,0,0.15); }
.ds-card-top { display: flex; align-items: center; gap: 14px; padding: 14px 18px; cursor: pointer; }
.ds-status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.ds-status-dot.active   { background: #2e7d4f; box-shadow: 0 0 6px rgba(46,125,79,0.5); }
.ds-status-dot.inactive { background: #555; }
.ds-status-dot.error    { background: #c0392b; box-shadow: 0 0 6px rgba(192,57,43,0.5); }
.ds-card-name { font-size: 13px; font-weight: 700; color: #fff; flex: 1; }
.ds-card-type { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; padding: 2px 9px; border-radius: 20px; flex-shrink: 0; }
.ds-card-type.api      { background: rgba(30,80,200,0.18); color: #7aa3f5; }
.ds-card-type.webpage  { background: rgba(100,50,200,0.18); color: #b08af5; }
.ds-card-type.file     { background: rgba(46,125,79,0.18); color: #6ec997; }
.ds-card-type.scrape   { background: rgba(180,83,9,0.18); color: #f5a742; }
.ds-card-category { font-size: 10px; color: #555; margin-left: auto; padding-right: 4px; }
.ds-card-chevron { font-size: 10px; color: #444; transition: transform .2s; flex-shrink: 0; }
.ds-card-chevron.open { transform: rotate(180deg); }
.ds-card-body { display: none; padding: 0 18px 16px; border-top: 1px solid rgba(255,255,255,0.04); }
.ds-card-body.open { display: block; }
.ds-field-row { margin-bottom: 12px; margin-top: 12px; }
.ds-field-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #555; margin-bottom: 5px; display: block; }
.ds-field-input { width: 100%; padding: 8px 11px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; transition: border-color .12s; }
.ds-field-input:focus { border-color: #FFFF00; }
.ds-field-textarea { width: 100%; padding: 8px 11px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; resize: vertical; min-height: 80px; line-height: 1.6; transition: border-color .12s; }
.ds-field-textarea:focus { border-color: #FFFF00; }
.ds-field-hint { font-size: 10px; color: #444; margin-top: 4px; }
.ds-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.ds-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.ds-card-actions { display: flex; align-items: center; gap: 8px; margin-top: 14px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
.ds-save-btn { padding: 7px 18px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; }
.ds-save-btn:hover { background: #fff; }
.ds-test-btn { padding: 7px 16px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: #aaa; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.ds-test-btn:hover { border-color: #FFFF00; color: #FFFF00; }
.ds-del-btn { padding: 7px 16px; background: none; border: 1px solid rgba(192,57,43,0.3); color: #c0392b; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; margin-left: auto; transition: all .12s; }
.ds-del-btn:hover { background: #c0392b; color: #fff; border-color: #c0392b; }
.ds-save-msg { font-size: 11px; color: #2e7d4f; opacity: 0; transition: opacity .3s; }
.ds-save-msg.show { opacity: 1; }
.ds-test-result { font-size: 11px; margin-top: 8px; padding: 8px 11px; border-radius: 7px; display: none; line-height: 1.5; }
.ds-test-result.ok  { background: rgba(46,125,79,0.12); color: #6ec997; display: block; }
.ds-test-result.err { background: rgba(192,57,43,0.12); color: #f08080; display: block; }

/* Add modal */
.ds-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; display: none; align-items: center; justify-content: center; }
.ds-modal-overlay.open { display: flex; }
.ds-modal { background: #1a1f2e; border-radius: 14px; padding: 28px 26px; width: 560px; max-width: 95vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 12px 60px rgba(0,0,0,0.5); }
.ds-modal h3 { font-size: 16px; font-weight: 900; color: #fff; margin-bottom: 4px; }
.ds-modal-sub { font-size: 12px; color: #555; margin-bottom: 22px; }
.ds-type-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; margin-bottom: 20px; }
.ds-type-btn { padding: 10px 6px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 9px; cursor: pointer; text-align: center; transition: all .12s; }
.ds-type-btn:hover, .ds-type-btn.selected { border-color: #FFFF00; background: rgba(255,255,0,0.06); }
.ds-type-icon { font-size: 22px; margin-bottom: 4px; }
.ds-type-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #aaa; }
.ds-modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 22px; }
.ds-modal-cancel { padding: 9px 18px; background: rgba(255,255,255,0.06); border: none; color: #aaa; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 20px; }
.ds-modal-create { padding: 9px 22px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; }
.ds-modal-create:hover { background: #fff; }
.ds-empty-state { text-align: center; padding: 48px 20px; color: #444; }
.ds-empty-icon { font-size: 36px; margin-bottom: 12px; opacity: 0.4; }
.ds-empty-text { font-size: 13px; margin-bottom: 6px; color: #555; }
.ds-empty-sub { font-size: 11px; color: #333; }
.sw-cat-btn { padding: 7px 14px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); color: #555; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; letter-spacing: .3px; }
.sw-cat-btn:hover { border-color: #FFFF00; color: #FFFF00; }
.sw-cat-btn.active { background: rgba(255,255,0,0.1); border-color: #FFFF00; color: #FFFF00; }
.sw-field-row { background: #1a1f2e; border: 1px solid rgba(255,255,255,0.04); border-radius: 8px; padding: 12px 14px; margin-bottom: 8px; transition: border-color .15s; }
.sw-field-row:hover { border-color: rgba(255,255,0,0.1); }
.sw-field-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.sw-field-lbl { flex: 1; font-size: 12px; font-weight: 700; color: #ccc; }
.sw-field-key { font-size: 9px; color: #444; font-family: monospace; background: rgba(255,255,255,0.04); padding: 2px 6px; border-radius: 4px; }
.sw-field-type { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #555; }
.sw-field-section { font-size: 9px; color: #333; }
.sw-field-body { display: grid; grid-template-columns: 80px 1fr; gap: 10px; align-items: start; }
.sw-pts-wrap { display: flex; flex-direction: column; gap: 4px; }
.sw-pts-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .3px; color: #555; }
.sw-pts-input { width: 72px; padding: 7px 10px; background: rgba(255,255,0,0.05); border: 1px solid rgba(255,255,0,0.2); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 900; color: #FFFF00; outline: none; text-align: center; }
.sw-pts-input:focus { border-color: #FFFF00; background: rgba(255,255,0,0.1); }
.sw-gpt-wrap { display: flex; flex-direction: column; gap: 4px; }
.sw-gpt-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .3px; color: #555; }
.sw-gpt-input { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 11px; color: #ccc; outline: none; resize: vertical; min-height: 56px; line-height: 1.6; transition: border-color .12s; }
.sw-gpt-input:focus { border-color: rgba(255,255,0,0.35); }
.sw-section-hdr { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; color: #333; padding: 12px 0 6px; border-bottom: 1px solid #1e1e1e; margin-bottom: 8px; }
.sw-empty { text-align: center; padding: 32px; color: #333; font-size: 13px; }
/* Intake in registry */
#reg-intake-card .iq-card { margin-bottom: 10px; }

.threshold-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.threshold-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.threshold-label { font-size: 11px; color: #aaa; width: 60px; }
.threshold-input { width: 70px; padding: 5px 9px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; text-align: center; }
.threshold-suffix { font-size: 11px; color: #555; }

/* User table */
.user-table { width: 100%; border-collapse: collapse; }
.user-table th { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #555; padding: 8px 12px; text-align: left; border-bottom: 1px solid #222; }
.user-table td { font-size: 12px; color: #aaa; padding: 10px 12px; border-bottom: 1px solid #1a1a1a; }
.user-table tr:hover td { background: rgba(255,255,255,0.02); }
.user-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 2px 8px; border-radius: 20px; }
.user-badge.pro { background: rgba(255,255,0,0.15); color: #FFFF00; }
.user-badge.free { background: rgba(255,255,255,0.06); color: #666; }
.user-count { font-size: 24px; font-weight: 900; color: #fff; }
.user-count-lbl { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 0.4px; margin-top: 2px; }
.stats-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 20px; }
.stat-box { background: #1a1f2e; border-radius: 10px; padding: 14px 16px; }

/* Intake question editor */
.iq-card { background: #1e2535; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; transition: border-color .15s; }
.iq-card:hover { border-color: rgba(255,255,0,0.12); }
.iq-card-header { display: flex; align-items: center; gap: 10px; padding: 11px 14px; background: rgba(255,255,255,0.02); cursor: grab; }
.iq-card-header:active { cursor: grabbing; }
.iq-drag-handle { color: #333; font-size: 14px; flex-shrink: 0; }
.iq-card-label { flex: 1; font-size: 12px; font-weight: 700; color: #ddd; }
.iq-card-type-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; padding: 2px 8px; border-radius: 20px; background: rgba(255,255,0,0.1); color: #FFFF00; flex-shrink: 0; }
.iq-card-req { font-size: 9px; font-weight: 700; color: #c0392b; padding: 2px 6px; border-radius: 20px; background: rgba(192,57,43,0.15); flex-shrink: 0; }
.iq-card-body { padding: 12px 14px; border-top: 1px solid rgba(255,255,255,0.04); display: flex; flex-direction: column; gap: 10px; }
.iq-row { display: grid; gap: 10px; }
.iq-row-2 { grid-template-columns: 1fr 1fr; }
.iq-row-3 { grid-template-columns: 1fr 1fr auto; align-items: end; }
.iq-field-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #555; margin-bottom: 4px; display: block; }
.iq-field-input { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; transition: border-color .12s; }
.iq-field-input:focus { border-color: #FFFF00; }
.iq-field-select { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; cursor: pointer; }
.iq-field-select:focus { border-color: #FFFF00; }
.iq-check-row { display: flex; align-items: center; gap: 7px; }
.iq-check-row input[type=checkbox] { accent-color: #FFFF00; width: 14px; height: 14px; cursor: pointer; }
.iq-check-row label { font-size: 11px; color: #aaa; cursor: pointer; }
.iq-del-btn { padding: 7px 14px; background: none; border: 1px solid rgba(192,57,43,0.3); color: #c0392b; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; white-space: nowrap; }
.iq-del-btn:hover { background: #c0392b; color: #fff; border-color: #c0392b; }
.iq-move-btn { padding: 6px 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); color: #555; font-family: 'Inter', sans-serif; font-size: 11px; cursor: pointer; border-radius: 7px; }
.iq-move-btn:hover { border-color: #FFFF00; color: #FFFF00; }
.iq-empty { text-align: center; padding: 40px 20px; color: #333; font-size: 13px; }


/* Intake question cards */
.iq-card{background:#1e2535;border-radius:10px;border:1px solid rgba(255,255,255,0.05);margin-bottom:10px;overflow:hidden;transition:border-color .15s;}
.iq-card:hover{border-color:rgba(255,255,0,0.12);}
.iq-card[style*="0.4"]{border:2px dashed rgba(255,255,0,0.3);}
.iq-card-hdr{display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(0,0,0,0.15);cursor:grab;user-select:none;}
.iq-card-hdr:active{cursor:grabbing;}
.iq-drag{color:#2a2a2a;font-size:15px;flex-shrink:0;letter-spacing:-2px;}
.iq-hdr-label{flex:1;font-size:12px;font-weight:700;color:#ccc;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.iq-req-badge{font-size:9px;font-weight:700;text-transform:uppercase;padding:2px 7px;border-radius:20px;background:rgba(192,57,43,0.2);color:#e07b7b;flex-shrink:0;}
.iq-type-badge{font-size:9px;font-weight:700;text-transform:uppercase;padding:2px 8px;border-radius:20px;flex-shrink:0;}
.iq-move-btn{padding:4px 8px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:#444;font-family:'Inter',sans-serif;font-size:11px;cursor:pointer;border-radius:6px;flex-shrink:0;transition:all .1s;}
.iq-move-btn:hover{border-color:#FFFF00;color:#FFFF00;}
.iq-move-btn:disabled{opacity:.2;cursor:default;}
.iq-card-body{padding:12px 14px;border-top:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:10px;}
.iq-row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.iq-fl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.3px;color:#555;margin-bottom:4px;display:block;}
.iq-fi{width:100%;padding:7px 10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:7px;font-family:'Inter',sans-serif;font-size:12px;color:#ddd;outline:none;transition:border-color .12s;}
.iq-fi:focus{border-color:#FFFF00;}
.iq-fs{width:100%;padding:7px 10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:7px;font-family:'Inter',sans-serif;font-size:12px;color:#ddd;outline:none;cursor:pointer;}
.iq-fs:focus{border-color:#FFFF00;}
.iq-del-btn{padding:5px 12px;background:none;border:1px solid rgba(192,57,43,0.3);color:#c0392b;font-family:'Inter',sans-serif;font-size:10px;font-weight:700;text-transform:uppercase;cursor:pointer;border-radius:20px;transition:all .12s;flex-shrink:0;}
.iq-del-btn:hover{background:#c0392b;color:#fff;border-color:#c0392b;}

/* ‚îÄ‚îÄ FIELD REGISTRY PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.reg-drop-zone{border:2px dashed rgba(255,255,0,0.25);border-radius:12px;padding:40px 24px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(255,255,0,0.02);margin-bottom:16px;}
.reg-drop-zone:hover,.reg-drop-zone.drag-over{border-color:#FFFF00;background:rgba(255,255,0,0.06);}
.reg-tab{background:rgba(255,255,255,0.05);color:#888;border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:5px 12px;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;}
.reg-tab:hover{background:rgba(255,255,0,0.08);color:#ccc;border-color:rgba(255,255,0,0.2);}
.reg-tab.active{background:rgba(255,255,0,0.12);color:#FFFF00;border-color:rgba(255,255,0,0.35);}
.reg-tbl{width:100%;border-collapse:collapse;font-size:11px;}
.reg-tbl th{background:#1a2030;color:#FFFF00;font-weight:700;padding:7px 8px;text-align:left;border-bottom:1px solid rgba(255,255,0,0.15);font-size:10px;text-transform:uppercase;letter-spacing:.3px;}
.reg-tbl td{padding:5px 8px;border-bottom:1px solid rgba(255,255,255,0.04);vertical-align:middle;}
.reg-tbl tr:hover td{background:rgba(255,255,255,0.02);}
.reg-tbl input,.reg-tbl select{background:#0d1220;border:1px solid rgba(255,255,255,0.1);color:#ccc;border-radius:4px;padding:3px 6px;font-size:11px;width:100%;box-sizing:border-box;}
.reg-tbl input:focus,.reg-tbl select:focus{outline:none;border-color:rgba(255,255,0,0.4);}
.reg-sec-row td{background:#131828;color:#7aa3f5;font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:.4px;padding:8px 8px 4px;}
.reg-del-btn{background:none;border:none;color:#c0392b;cursor:pointer;font-size:13px;padding:0 4px;opacity:.6;}
.reg-del-btn:hover{opacity:1;}
.reg-key-cell{color:#7aa3f5;font-family:monospace;font-size:10px;}

.reg-drop-icon{font-size:36px;margin-bottom:10px;}
.reg-drop-text{font-size:13px;font-weight:700;color:#ccc;margin-bottom:4px;}
.reg-drop-sub{font-size:11px;color:#444;}
.reg-file-input{display:none;}
.reg-preview{background:#12161f;border-radius:10px;padding:16px 18px;margin-bottom:16px;border:1px solid rgba(255,255,0,0.08);}
.reg-preview-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;color:#FFFF00;opacity:0.6;margin-bottom:12px;}
.reg-cat-row{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04);}
.reg-cat-row:last-child{border-bottom:none;}
.reg-cat-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.reg-cat-name{font-size:12px;font-weight:700;color:#ccc;flex:1;}
.reg-cat-count{font-size:10px;color:#555;}
.reg-cat-subs{font-size:10px;color:#444;font-style:italic;}
.reg-warn{background:rgba(192,57,43,0.12);border:1px solid rgba(192,57,43,0.3);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:11px;color:#e07b7b;display:none;}
.reg-warn.show{display:block;}
.reg-status{background:#1a1f2e;border-radius:10px;padding:14px 18px;border:1px solid rgba(255,255,255,0.06);}
.reg-status-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.reg-status-row:last-child{margin-bottom:0;}
.reg-status-lbl{font-size:10px;color:#555;text-transform:uppercase;font-weight:700;letter-spacing:0.3px;}
.reg-status-val{font-size:11px;color:#aaa;font-weight:600;}
.reg-version-badge{display:inline-block;background:rgba(255,255,0,0.12);color:#FFFF00;font-size:10px;font-weight:700;padding:2px 10px;border-radius:20px;border:1px solid rgba(255,255,0,0.25);}

/* ‚îÄ‚îÄ Field Registry panel ‚îÄ‚îÄ */
.fr-upload-zone { border: 2px dashed rgba(255,255,0,0.2); border-radius: 12px; padding: 28px 20px; text-align: center; cursor: pointer; transition: all .2s; margin-bottom: 16px; }
.fr-upload-zone:hover, .fr-upload-zone.drag { border-color: #FFFF00; background: rgba(255,255,0,0.03); }
.fr-upload-icon { font-size: 28px; margin-bottom: 8px; }
.fr-upload-title { font-size: 13px; font-weight: 700; color: #ddd; margin-bottom: 4px; }
.fr-upload-hint { font-size: 11px; color: #444; }
.fr-status-bar { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 9px; margin-bottom: 14px; font-size: 11px; }
.fr-status-bar.none  { background: rgba(255,255,255,0.03); color: #444; }
.fr-status-bar.ok    { background: rgba(46,125,79,0.12);   color: #6ec997; }
.fr-status-bar.warn  { background: rgba(224,123,32,0.12);  color: #f5a742; }
.fr-status-bar.error { background: rgba(192,57,43,0.12);   color: #f08080; }
.fr-status-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.fr-status-bar.none  .fr-status-dot { background: #444; }
.fr-status-bar.ok    .fr-status-dot { background: #6ec997; box-shadow: 0 0 5px rgba(110,201,151,.6); }
.fr-status-bar.warn  .fr-status-dot { background: #f5a742; }
.fr-status-bar.error .fr-status-dot { background: #f08080; }
.fr-status-text { flex: 1; line-height: 1.5; }
.fr-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 2px 8px; border-radius: 20px; background: rgba(255,255,0,0.12); color: #FFFF00; flex-shrink: 0; }
.fr-preview { background: rgba(0,0,0,0.2); border-radius: 9px; padding: 12px 14px; margin-bottom: 14px; max-height: 220px; overflow-y: auto; }
.fr-preview::-webkit-scrollbar { width: 3px; }
.fr-preview::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius:2px; }
.fr-preview-row { display: grid; grid-template-columns: 160px 1fr 80px 80px; gap: 6px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 10px; color: #888; }
.fr-preview-row.hdr { color: #FFFF00; opacity: 0.6; font-weight: 700; text-transform: uppercase; font-size: 9px; letter-spacing: 0.4px; }
.fr-preview-row.new-field { color: #6ec997; }
.fr-preview-row.changed  { color: #f5a742; }
.fr-preview-row.removed  { color: #f08080; text-decoration: line-through; }
.fr-warn-list { margin: 10px 0; padding: 10px 14px; background: rgba(192,57,43,0.08); border-radius: 8px; border-left: 3px solid #c0392b; }
.fr-warn-list p { font-size: 10px; color: #f08080; margin-bottom: 4px; }
.fr-warn-list p:last-child { margin-bottom: 0; }
.fr-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.fr-versions { font-size: 10px; color: #444; margin-top: 16px; }
.fr-versions table { width: 100%; border-collapse: collapse; margin-top: 6px; }
.fr-versions td { padding: 5px 8px; font-size: 10px; color: #666; border-bottom: 1px solid rgba(255,255,255,0.04); }
.fr-versions td:first-child { color: #FFFF00; opacity: 0.7; font-weight: 700; }

</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">Sun<span>Hash</span></div>
    <div class="login-sub">Admin Panel</div>
    <div class="login-field">
      <label class="login-label">Username</label>
      <input class="login-input" id="adm-user" type="text" autocomplete="off" onkeydown="if(event.key==='Enter')adminLogin()"/>
    </div>
    <div class="login-field">
      <label class="login-label">Password</label>
      <input class="login-input" id="adm-pass" type="password" onkeydown="if(event.key==='Enter')adminLogin()"/>
    </div>
    <button class="login-btn" onclick="adminLogin()">Enter Admin</button>
    <div class="login-err" id="login-err">Invalid credentials</div>
  </div>
</div>

<!-- ADMIN -->
<div class="admin-screen" id="admin-screen">
  <div class="topbar">
    <div style="display:flex;align-items:center;">
      <span class="topbar-logo">Sun<span>Hash</span></span>
      <span class="topbar-badge">Admin</span>
    </div>
    <div class="topbar-right">
      <span class="topbar-lock" onclick="adminLogout()">&#128274; Lock</span>
    </div>
  </div>

  <div class="admin-body">
    <div class="admin-nav">
      <div class="nav-section">Verification</div>
      <div class="nav-item" onclick="showPanel('datasources')">Data Sources</div>
      <div class="nav-section">Registry</div>
      <div class="nav-item" onclick="showPanel('registry')">Field Registry</div>
      <div class="nav-item" onclick="showPanel('scoring_rules')">Score Weights</div>
      <div class="nav-section">Content</div>
      <div class="nav-item active" onclick="showPanel('terms')">Terms & Conditions</div>
      <!-- Intake now lives inside Field Registry tab -->
      <div class="nav-section">AI Configuration</div>
      <div class="nav-item" onclick="showPanel('prompts')">GPT Prompts</div>
      <div class="nav-section">Scoring</div>
      <div class="nav-item" onclick="showPanel('scoring')">Score Thresholds</div>
      <div class="nav-item" onclick="showPanel('required')">Required Fields</div>
      <div class="nav-section">Users</div>
      <div class="nav-item" onclick="showPanel('users')">User Management</div>
      <div class="nav-section">Security</div>
      <div class="nav-item" onclick="showPanel('credentials')">Admin Credentials</div>
    </div>

    <div class="admin-main">

      <!-- TERMS -->
      <div class="admin-panel active" id="panel-terms">
        <div class="panel-title">Terms & Conditions</div>
        <div class="panel-sub">This text is shown to users at signup. Update the version number when making significant changes.</div>
        <div class="admin-card">
          <div class="admin-card-title">Current T&C</div>
          <div class="field-row">
            <label class="field-label">Version</label>
            <input class="field-input" id="terms-version" type="text" style="width:120px;" placeholder="e.g. 1.0"/>
          </div>
          <div class="field-row">
            <label class="field-label">Terms Text</label>
            <textarea class="field-textarea" id="terms-text" style="min-height:200px;" placeholder="Enter your terms and conditions text..."></textarea>
            <div class="field-hint">Plain text. Line breaks are preserved.</div>
          </div>
          <button class="save-btn" onclick="saveTerms()">Save Terms</button>
          <span class="save-msg" id="msg-terms">Saved</span>
        </div>
      </div>


      <!-- FIELD REGISTRY -->
      <div class="admin-panel" id="panel-registry">
        <div class="panel-title">Field Registry</div>
        <div class="panel-sub">Edit fields directly in-app, or bulk-upload via Excel. Changes publish instantly to Supabase and take effect on the next page load in the app.</div>

        <!-- Status + actions -->
        <div class="admin-card" style="margin-bottom:14px;">
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
            <div>
              <div style="font-size:10px;text-transform:uppercase;color:#555;letter-spacing:.4px;margin-bottom:4px;">Active Version</div>
              <div id="reg-cur-version" style="font-size:13px;color:#FFFF00;font-weight:700;">‚Äî</div>
              <div id="reg-cur-date" style="font-size:10px;color:#555;margin-top:2px;">‚Äî</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button class="save-btn" style="background:rgba(122,163,245,0.15);color:#7aa3f5;border:1px solid rgba(122,163,245,0.25);" onclick="regDownloadExcel()">‚¨á Download Excel</button>
              <button class="save-btn" style="background:rgba(255,255,0,0.08);color:#FFFF00;border:1px solid rgba(255,255,0,0.2);" onclick="regQuerySupabase()">üîç Inspect Supabase</button>
            </div>
          </div>
        </div>

        <!-- Tab bar -->
        <div style="font-size:9px;color:#444;margin-bottom:6px;letter-spacing:.4px;">
          <span style="color:#FFFF00;text-transform:uppercase;">Category KPI panels</span> ¬∑ fields on the right side of each panel &nbsp;&nbsp;
          <span style="color:#7aa3f5;text-transform:uppercase;">Builder fields</span> ¬∑ fields inside cards (arrays / crews / contracts / equipment‚Ä¶)
        </div>
        <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:14px;" id="reg-tab-bar">
          <button class="reg-tab active" onclick="regShowTab('cat','Design & Engineering')" data-tab="cat" data-cat="Design & Engineering">üìê Design</button>
          <button class="reg-tab" onclick="regShowTab('cat','Construction')" data-tab="cat" data-cat="Construction">üèóÔ∏è Construct</button>
          <button class="reg-tab" onclick="regShowTab('cat','Permitting')" data-tab="cat" data-cat="Permitting">üìã Permit</button>
          <button class="reg-tab" onclick="regShowTab('cat','Procurement')" data-tab="cat" data-cat="Procurement" title="KPI fields on Procurement right panel ‚Äî NOT the contract card fields">üì¶ Procure KPIs</button>
          <button class="reg-tab" onclick="regShowTab('cat','Legal & Contract')" data-tab="cat" data-cat="Legal & Contract">‚öñÔ∏è Legal</button>
          <button class="reg-tab" onclick="regShowTab('cat','Grid Interconnection')" data-tab="cat" data-cat="Grid Interconnection">üîå Grid</button>
          <button class="reg-tab" onclick="regShowTab('cat','Financial')" data-tab="cat" data-cat="Financial">üí∞ Finance</button>
          <span style="display:inline-block;width:1px;background:rgba(122,163,245,0.3);align-self:stretch;margin:0 6px;"></span>
          <button class="reg-tab" style="color:#7aa3f5;" onclick="regShowTab('arrays','')" data-tab="arrays" title="Sub-sections inside each Design Array card">‚òÄÔ∏è Array Sections</button>
          <button class="reg-tab" style="color:#7aa3f5;" onclick="regShowTab('crews','')" data-tab="crews" title="Manpower fields inside Civil / Install / Electrical crew cards">üë∑ Crew Fields</button>
          <button class="reg-tab" style="color:#7aa3f5;" onclick="regShowTab('contracts','')" data-tab="contracts" title="Fields inside Procurement contract cards (Contract Terms, Milestones, LDs)">üìë Contract Fields</button>
          <button class="reg-tab" style="color:#7aa3f5;" onclick="regShowTab('components','')" data-tab="components" title="Spec fields inside Component cards">‚öôÔ∏è Components</button>
          <button class="reg-tab" style="color:#7aa3f5;" onclick="regShowTab('suppliers','')" data-tab="suppliers" title="Company fields for all supplier types">üè¢ Suppliers</button>
          <button class="reg-tab" style="color:#7aa3f5;" onclick="regShowTab('equipment','')" data-tab="equipment" title="Spec fields inside equipment cards">üöú Equipment</button>
          <button class="reg-tab" onclick="regShowTab('upload','')" data-tab="upload">üìä Excel Upload</button>
          <span style="display:inline-block;width:1px;background:rgba(255,165,0,0.3);align-self:stretch;margin:0 6px;"></span>
          <button class="reg-tab" style="color:#f5a742;" onclick="regShowTab('intake','')" data-tab="intake" title="Questions shown on new project intake form">üìù Intake Questions</button>
        </div>

        <!-- Field editor card -->
        <div class="admin-card" id="reg-editor-card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
            <div class="admin-card-title" id="reg-editor-title" style="margin:0;">Select a tab</div>
            <div style="display:flex;gap:8px;align-items:center;">
              <button class="save-btn" onclick="regAddField()" id="reg-add-btn" style="display:none;font-size:11px;padding:5px 12px;">+ Add Field</button>
              <button class="save-btn" onclick="regSaveTab()" id="reg-save-tab-btn" style="display:none;font-size:11px;padding:5px 12px;">‚úì Save</button>
              <button class="save-btn" onclick="regVerifyDB()" id="reg-verify-btn" style="display:none;font-size:11px;padding:5px 12px;background:rgba(122,163,245,0.12);color:#7aa3f5;border:1px solid rgba(122,163,245,0.25);">üîç Verify DB</button>
              <span class="save-msg" id="reg-save-msg" style="font-size:11px;"></span>
            </div>
          </div>
          <div id="reg-field-table" style="overflow-x:auto;"></div>
        </div>

        <!-- Excel upload card -->
        <div class="admin-card" id="reg-upload-card" style="display:none;">
          <div class="admin-card-title">Bulk Upload via Excel</div>
          <div style="font-size:11px;color:#555;margin-bottom:10px;line-height:1.7;">
            Use the downloaded template. Each sheet maps to one builder type.<br>
            <strong style="color:#aaa;">Column order matters:</strong> A=Group/Section, B=blank, C=Field Label, D=Field Key (immutable), E=Type, F=Options (/ separated)
          </div>
          <div class="reg-warn" id="reg-warn"></div>
          <div class="reg-drop-zone" id="reg-drop-zone"
               onclick="document.getElementById('reg-file-input').click()"
               ondragover="regDragOver(event)" ondragleave="regDragLeave(event)" ondrop="regDrop(event)">
            <div class="reg-drop-icon">üìä</div>
            <div class="reg-drop-text">Drop SunHash_Field_Registry.xlsx here</div>
            <div class="reg-drop-sub">or click to browse</div>
          </div>
          <input type="file" id="reg-file-input" accept=".xlsx" style="display:none" onchange="regFileSelected(this)"/>
          <div id="reg-parse-status" style="display:none;margin-top:8px;" class="fr-status-bar none">
            <div class="fr-status-dot"></div>
            <div class="fr-status-text" id="reg-parse-msg">Parsing‚Ä¶</div>
            <div class="fr-badge" id="reg-parse-badge"></div>
          </div>
          <div id="reg-preview" class="reg-preview" style="display:none;margin-top:8px;">
            <div class="reg-preview-title">Parsed Sheets</div>
            <div id="reg-preview-body"></div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;margin-top:8px;">
            <button class="save-btn" id="reg-publish-btn" onclick="publishRegistry()" style="display:none;">‚¨Ü Publish Registry</button>
          </div>
        </div>

        <!-- Intake Questions card (shown when intake tab is active) -->
        <div class="admin-card" id="reg-intake-card" style="display:none;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px;">
            <div>
              <div class="admin-card-title" style="margin:0;color:#f5a742;">üìù Intake Questions</div>
              <div style="font-size:11px;color:#555;margin-top:4px;">Questions shown on the new project intake form. Same field types as registry. Drag to reorder. Save to publish immediately.</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <button class="save-btn" style="background:rgba(245,167,66,0.12);color:#f5a742;border:1px solid rgba(245,167,66,0.25);" onclick="addIQ()">+ Add Question</button>
              <button class="save-btn" onclick="saveIntakeQs()">‚úì Save All</button>
              <span class="save-msg" id="iq-save-msg-reg">Saved</span>
            </div>
          </div>
          <div style="font-size:10px;color:#444;margin-bottom:12px;line-height:1.7;background:#0d1017;padding:10px 14px;border-radius:8px;border:1px solid rgba(245,167,66,0.08);">
            <strong style="color:#f5a742;">IDs with special meaning:</strong>
            <code style="color:#FFFF00;margin-left:4px;">q_name</code> ‚Üí project name &nbsp;¬∑&nbsp;
            <code style="color:#FFFF00;">q_cap</code> ‚Üí capacity (MWp) &nbsp;¬∑&nbsp;
            <code style="color:#FFFF00;">q_stage</code> ‚Üí stage &nbsp;¬∑&nbsp;
            <code style="color:#FFFF00;">q_location</code> ‚Üí GPS coordinates
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px;font-size:11px;color:#444;">
            <span><span style="color:#7aa3f5;font-weight:700;">text</span> ¬∑ short text</span>
            <span style="color:#333;">|</span>
            <span><span style="color:#c39af5;font-weight:700;">number</span> ¬∑ numeric</span>
            <span style="color:#333;">|</span>
            <span><span style="color:#6ec997;font-weight:700;">select</span> ¬∑ dropdown</span>
            <span style="color:#333;">|</span>
            <span><span style="color:#f5a742;font-weight:700;">date</span> ¬∑ date picker</span>
            <span style="color:#333;">|</span>
            <span><span style="color:#4ecdc4;font-weight:700;">toggle</span> ¬∑ yes/no</span>
            <span style="color:#333;">|</span>
            <span><span style="color:#aaa;font-weight:700;">textarea</span> ¬∑ multi-line</span>
          </div>
          <div id="iq-cards"></div>
          <div id="iq-empty" style="text-align:center;padding:32px;color:#333;font-size:13px;display:none;">No intake questions yet. Click "+ Add Question" to start.</div>
        </div>

        <!-- Supabase inspect output -->
        <div class="admin-card" id="reg-supabase-out" style="display:none;">
          <div class="admin-card-title">Supabase Registry Data</div>
          <pre id="reg-supabase-json" style="font-size:10px;color:#7aa3f5;max-height:300px;overflow:auto;white-space:pre-wrap;word-break:break-all;background:#0a0d15;padding:10px;border-radius:6px;margin:0;"></pre>
        </div>
      </div>

      <!-- INTAKE QUESTIONS -->
      <!-- Hidden legacy element for backward compat -->
      <span class="save-msg" id="iq-save-msg" style="display:none;"></span>
      <!-- DATA SOURCES -->
      <div class="admin-panel" id="panel-datasources">
        <div class="panel-title">Data Sources</div>
        <div class="panel-sub">APIs, webpages, and files used by the cross-verification engine. Add, configure, enable, or disable without redeploying.</div>

        <div class="ds-toolbar">
          <input class="ds-search" id="ds-search" type="text" placeholder="Search sources..." oninput="filterSources()"/>
          <select class="ds-filter" id="ds-filter-type" onchange="filterSources()">
            <option value="">All types</option>
            <option value="api">API</option>
            <option value="webpage">Webpage</option>
            <option value="file">File / CSV</option>
            <option value="scrape">Scrape</option>
          </select>
          <select class="ds-filter" id="ds-filter-cat" onchange="filterSources()">
            <option value="">All categories</option>
            <option value="solar">Solar Yield</option>
            <option value="financial">Financial</option>
            <option value="weather">Weather / Climate</option>
            <option value="land">Land & Site</option>
            <option value="regulatory">Regulatory</option>
            <option value="grid">Grid & Power</option>
            <option value="cost">Cost Benchmarks</option>
            <option value="environmental">Environmental</option>
            <option value="labor">Labor & Compliance</option>
            <option value="other">Other</option>
          </select>
          <button class="ds-add-btn" onclick="openAddSourceModal()">&#43; Add Source</button>
        </div>

        <div class="ds-grid" id="ds-grid">
          <div class="ds-empty-state">
            <div class="ds-empty-icon">üîå</div>
            <div class="ds-empty-text">Loading sources...</div>
          </div>
        </div>
      </div>

      <!-- Add Source Modal -->
      <div class="ds-modal-overlay" id="ds-modal-overlay">
        <div class="ds-modal">
          <h3>Add Data Source</h3>
          <div class="ds-modal-sub">Choose the type of source you want to connect.</div>
          <div class="ds-type-grid" id="ds-type-grid">
            <div class="ds-type-btn selected" onclick="selectSourceType('api',this)">
              <div class="ds-type-icon">‚ö°</div>
              <div class="ds-type-label">REST API</div>
            </div>
            <div class="ds-type-btn" onclick="selectSourceType('webpage',this)">
              <div class="ds-type-icon">üåê</div>
              <div class="ds-type-label">Webpage</div>
            </div>
            <div class="ds-type-btn" onclick="selectSourceType('file',this)">
              <div class="ds-type-icon">üìÑ</div>
              <div class="ds-type-label">File / CSV</div>
            </div>
            <div class="ds-type-btn" onclick="selectSourceType('scrape',this)">
              <div class="ds-type-icon">üï∑</div>
              <div class="ds-type-label">Scrape</div>
            </div>
          </div>

          <div class="ds-row-2">
            <div class="ds-field-row">
              <label class="ds-field-label">Source Name *</label>
              <input class="ds-field-input" id="new-ds-name" type="text" placeholder="e.g. NREL PVWatts V8"/>
            </div>
            <div class="ds-field-row">
              <label class="ds-field-label">Category *</label>
              <select class="ds-field-input" id="new-ds-category">
                <option value="solar">Solar Yield</option>
                <option value="financial">Financial</option>
                <option value="weather">Weather / Climate</option>
                <option value="land">Land & Site</option>
                <option value="regulatory">Regulatory</option>
                <option value="grid">Grid & Power</option>
                <option value="cost">Cost Benchmarks</option>
                <option value="environmental">Environmental</option>
                <option value="labor">Labor & Compliance</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="ds-field-row">
            <label class="ds-field-label">Base URL / Endpoint *</label>
            <input class="ds-field-input" id="new-ds-url" type="url" placeholder="https://developer.nrel.gov/api/pvwatts/v8.json"/>
          </div>

          <div class="ds-field-row">
            <label class="ds-field-label">Description</label>
            <input class="ds-field-input" id="new-ds-desc" type="text" placeholder="What this source verifies"/>
          </div>

          <div class="ds-modal-actions">
            <button class="ds-modal-cancel" onclick="closeAddSourceModal()">Cancel</button>
            <button class="ds-modal-create" onclick="createSource()">Add Source</button>
          </div>
        </div>
      </div>

      <!-- GPT PROMPTS -->
      <div class="admin-panel" id="panel-prompts">
        <div class="panel-title">GPT Prompts</div>
        <div class="panel-sub">Customize the AI instructions sent to GPT-4o-mini for overview summaries and category Q&amp;A. Use {project_data} as a placeholder for project fields.</div>

        <div class="admin-card">
          <div class="admin-card-title">Overview Brief Prompt</div>
          <div class="field-row">
            <label class="field-label">System prompt ‚Äî Overview generation</label>
            <textarea class="field-textarea" id="prompt-overview" style="min-height:160px;" placeholder="You are a solar project analyst. Generate a concise professional brief for the following project data: {project_data}"></textarea>
            <div class="field-hint">Sent to GPT-4o-mini when generating the AI Project Brief on the overview page.</div>
          </div>
          <button class="save-btn" onclick="savePrompt('overview')">Save</button>
          <span class="save-msg" id="msg-prompt-overview">Saved</span>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">Category Q&amp;A Prompt</div>
          <div class="field-row">
            <label class="field-label">System prompt ‚Äî Category Q&amp;A assistant</label>
            <textarea class="field-textarea" id="prompt-category-qa" style="min-height:160px;" placeholder="You are a due diligence expert in solar energy projects. Answer the user's question using the provided project data."></textarea>
            <div class="field-hint">Sent to GPT-4o-mini for the AI Q&amp;A tab inside each category panel.</div>
          </div>
          <button class="save-btn" onclick="savePrompt('category-qa')">Save</button>
          <span class="save-msg" id="msg-prompt-category-qa">Saved</span>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">Per-Category AI Prompts</div>
          <div class="panel-sub" style="margin-bottom:16px;">Override the general Q&amp;A prompt for specific categories. Leave blank to use the default above.</div>
          <div class="field-row">
            <label class="field-label">Design & Engineering</label>
            <textarea class="field-textarea" id="prompt-cat-design" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <div class="field-row">
            <label class="field-label">Construction</label>
            <textarea class="field-textarea" id="prompt-cat-construct" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <div class="field-row">
            <label class="field-label">Legal & Contract</label>
            <textarea class="field-textarea" id="prompt-cat-contract" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <div class="field-row">
            <label class="field-label">Grid Interconnection</label>
            <textarea class="field-textarea" id="prompt-cat-intercon" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <div class="field-row">
            <label class="field-label">Financial</label>
            <textarea class="field-textarea" id="prompt-cat-financial" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <div class="field-row">
            <label class="field-label">Permitting</label>
            <textarea class="field-textarea" id="prompt-cat-permit" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <div class="field-row">
            <label class="field-label">Procurement</label>
            <textarea class="field-textarea" id="prompt-cat-procurement" style="min-height:90px;" placeholder="Leave blank to use the default Category Q&A prompt above."></textarea>
          </div>
          <button class="save-btn" onclick="saveCatPrompts()">Save All Category Prompts</button>
          <span class="save-msg" id="msg-cat-all">Saved</span>
        </div>
      </div>

      <!-- SCORE WEIGHTS -->
      <div class="admin-panel" id="panel-scoring_rules">
        <div class="panel-title">Score Weights</div>
        <div class="panel-sub">All registry fields grouped by category. Assign a score point value and provide GPT instructions for how each field should be weighted ‚Äî including conditional logic based on other variables (e.g. contract type, project stage).</div>

        <!-- Toolbar -->
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px;">
          <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;" id="sw-cat-tabs">
            <button class="sw-cat-btn active" onclick="swShowCat('score_design',this)">üìê Design</button>
            <button class="sw-cat-btn" onclick="swShowCat('score_construct',this)">üèóÔ∏è Construct</button>
            <button class="sw-cat-btn" onclick="swShowCat('score_permit',this)">üìã Permit</button>
            <button class="sw-cat-btn" onclick="swShowCat('score_procurement',this)">üì¶ Procure</button>
            <button class="sw-cat-btn" onclick="swShowCat('score_contract',this)">‚öñÔ∏è Legal</button>
            <button class="sw-cat-btn" onclick="swShowCat('score_intercon',this)">üîå Grid</button>
            <button class="sw-cat-btn" onclick="swShowCat('score_financial',this)">üí∞ Finance</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="save-btn" onclick="swSaveWeights()">‚úì Save Weights</button>
            <span class="save-msg" id="sw-save-msg2">Saved</span>
          </div>
        </div>

        <!-- Category header info -->
        <div class="admin-card" style="margin-bottom:12px;padding:14px 18px;">
          <div style="display:flex;align-items:flex-start;gap:16px;flex-wrap:wrap;">
            <div style="flex:1;min-width:220px;">
              <div class="admin-card-title" id="sw-cat-title" style="margin-bottom:6px;">Design & Engineering</div>
              <div style="font-size:11px;color:#555;line-height:1.7;">Total points assigned: <span id="sw-total-pts" style="color:#FFFF00;font-weight:700;">0</span> &nbsp;¬∑&nbsp; Fields: <span id="sw-field-count" style="color:#aaa;">0</span></div>
            </div>
            <div style="flex:2;min-width:260px;">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#555;margin-bottom:5px;">Category-Level GPT Context</div>
              <textarea id="sw-cat-gpt" class="field-textarea" rows="3" style="min-height:72px;font-size:11px;" placeholder="Instructions for how GPT should approach scoring this entire category. E.g. 'For turnkey EPC contracts, weight procurement delays heavily. For split contracts, assess each sub-contractor separately.'"></textarea>
            </div>
          </div>
        </div>

        <!-- Fields list -->
        <div id="sw-fields-wrap">
          <div style="text-align:center;padding:40px;color:#333;font-size:13px;">Loading registry fields‚Ä¶</div>
        </div>
      </div>

      <!-- SCORING -->
      <div class="admin-panel" id="panel-scoring">
        <div class="panel-title">Score Thresholds</div>
        <div class="panel-sub">Define the score boundaries for red, yellow, and green status across all categories and the timeline.</div>
        <div class="admin-card">
          <div class="admin-card-title">Category Score Colours</div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#2e7d4f;"></div>
            <span class="threshold-label">Green above</span>
            <input class="threshold-input" id="score-green" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#e07b20;"></div>
            <span class="threshold-label">Yellow above</span>
            <input class="threshold-input" id="score-yellow" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#c0392b;"></div>
            <span class="threshold-label">Red below</span>
            <span style="font-size:11px;color:#555;" id="score-red-label">--</span>
          </div>
          <button class="save-btn" onclick="saveScoreThresholds()">Save</button>
          <span class="save-msg" id="msg-scoring">Saved</span>
        </div>
        <div class="admin-card">
          <div class="admin-card-title">Timeline Milestone Thresholds (based on Permit score)</div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#2e7d4f;"></div>
            <span class="threshold-label">Green above</span>
            <input class="threshold-input" id="tl-green" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#e07b20;"></div>
            <span class="threshold-label">Yellow above</span>
            <input class="threshold-input" id="tl-yellow" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <button class="save-btn" onclick="saveTimelineThresholds()">Save</button>
          <span class="save-msg" id="msg-timeline">Saved</span>
        </div>
      </div>

      <!-- REQUIRED FIELDS -->
      <div class="admin-panel" id="panel-required">
        <div class="panel-title">Required Fields</div>
        <div class="panel-sub">Comma-separated field keys for each category. Used to calculate the completeness indicator on each button.</div>
        <div class="admin-card">
          <div class="admin-card-title">Per-Category Required Fields</div>
          <div id="required-fields-body"></div>
          <button class="save-btn" onclick="saveRequiredFields()">Save All</button>
          <span class="save-msg" id="msg-required">Saved</span>
        </div>
      </div>

      <!-- USERS -->
      <div class="admin-panel" id="panel-users">
        <div class="panel-title">User Management</div>
        <div class="panel-sub">All registered accounts. Subscription status reflects latest Stripe sync.</div>
        <div class="stats-row" id="user-stats"></div>
        <div class="admin-card">
          <div class="admin-card-title">All Users</div>
          <table class="user-table">
            <thead><tr><th>Email</th><th>Joined</th><th>Plan</th><th>T&C Accepted</th><th>Projects</th></tr></thead>
            <tbody id="user-table-body"><tr><td colspan="5" style="color:#444;text-align:center;padding:20px;">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- CREDENTIALS -->
      <div class="admin-panel" id="panel-credentials">
        <div class="panel-title">Admin Credentials</div>
        <div class="panel-sub">Change the username and password used to access this admin panel.</div>
        <div class="admin-card">
          <div class="admin-card-title">Update Login</div>
          <div class="field-row">
            <label class="field-label">New Username</label>
            <input class="field-input" id="new-username" type="text" style="max-width:300px;"/>
          </div>
          <div class="field-row">
            <label class="field-label">New Password</label>
            <input class="field-input" id="new-password" type="password" style="max-width:300px;"/>
          </div>
          <div class="field-row">
            <label class="field-label">Confirm Password</label>
            <input class="field-input" id="new-password2" type="password" style="max-width:300px;"/>
          </div>
          <button class="save-btn" onclick="saveCredentials()">Update Credentials</button>
          <span class="save-msg" id="msg-credentials">Updated</span>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

var CONFIG_KEYS = [
  "admin_username","admin_password","terms_text","terms_version",
  "prompt_overview","prompt_category_qa",
  "score_green_threshold","score_yellow_threshold",
  "timeline_permit_green","timeline_permit_yellow",
  "cat_required_design","cat_required_construct","cat_required_contract",
  "cat_required_intercon","cat_required_financial","cat_required_permit"
];

var config = {};
var CAT_LABELS = {
  design: "Design & Engineering", construct: "Construction",
  contract: "Legal & Contract", intercon: "Grid Interconnection",
  financial: "Financial", permit: "Permitting"
};

/* ---- AUTH ---- */
function adminLogin() {
  var user = document.getElementById("adm-user").value.trim();
  var pass = document.getElementById("adm-pass").value.trim();

  // Load config to verify credentials
  sb.from("admin_config").select("key,value").then(function(res) {
    if (res.error) { showLoginErr("Database error: " + res.error.message); return; }
    var cfg = {};
    (res.data || []).forEach(function(r) { cfg[r.key] = r.value; });

    var validUser = cfg["admin_username"] || "sunhash_admin";
    var validPass = cfg["admin_password"] || "SunHash2026!";

    if (user === validUser && pass === validPass) {
      config = cfg;
      sessionStorage.setItem("admin_auth", "1");
      showAdmin();
    } else {
      showLoginErr("Invalid credentials");
    }
  });
}

function showLoginErr(msg) {
  var el = document.getElementById("login-err");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(function() { el.style.display = "none"; }, 3000);
}

function adminLogout() {
  sessionStorage.removeItem("admin_auth");
  document.getElementById("admin-screen").style.display = "none";
  document.getElementById("login-screen").style.display = "flex";
  document.getElementById("adm-pass").value = "";
}

function showAdmin() {
  document.getElementById("login-screen").style.display = "none";
  document.getElementById("admin-screen").style.display = "block";
  populateFields();
  loadUsers();
  loadIntakeQs();
}

// Check session on load
window.addEventListener("load", function() {
  if (sessionStorage.getItem("admin_auth") === "1") {
    sb.from("admin_config").select("key,value").then(function(res) {
      if (!res.error) {
        (res.data || []).forEach(function(r) { config[r.key] = r.value; });
        showAdmin();
      }
    });
  }
});

/* ---- NAVIGATION ---- */
function showPanel(id) {
  document.querySelectorAll(".admin-panel").forEach(function(p) { p.classList.remove("active"); });
  document.querySelectorAll(".nav-item").forEach(function(n) { n.classList.remove("active"); });
  document.getElementById("panel-" + id).classList.add("active");
  event.target.classList.add("active");
  if (id === "users") loadUsers();
}

/* ---- POPULATE ---- */
function populateFields() {
  setValue("terms-version",    config["terms_version"]         || "1.0");
  setValue("terms-text",       config["terms_text"]            || "");
  setValue("prompt-overview",  config["prompt_overview"]       || "");
  setValue("prompt-category-qa", config["prompt_category_qa"] || "");
  setValue("score-green",      config["score_green_threshold"] || "70");
  setValue("score-yellow",     config["score_yellow_threshold"]|| "40");
  setValue("tl-green",         config["timeline_permit_green"] || "70");
  setValue("tl-yellow",        config["timeline_permit_yellow"]|| "40");
  updateRedLabel();

  // Per-category AI prompts
  var catKeys = ['design','construct','contract','intercon','financial','permit','procurement'];
  catKeys.forEach(function(k) {
    var el = document.getElementById('prompt-cat-' + k);
    if (el) el.value = config['prompt_cat_' + k] || '';
  });

  // Overview + QA prompts
  setValue("prompt-overview",     config["prompt_overview"]     || "");
  setValue("prompt-category-qa",  config["prompt_category_qa"]  || "");
  setValue("prompt-category_qa",  config["prompt_category_qa"]  || "");

  // Per-category prompts
  var catKeys2 = ['design','construct','contract','intercon','financial','permit','procurement'];
  catKeys2.forEach(function(k) {
    var el = document.getElementById('prompt-cat-' + k);
    if (el) el.value = config['prompt_cat_' + k] || '';
  });

  // Required fields per category
  var body = document.getElementById("required-fields-body");
  body.innerHTML = Object.keys(CAT_LABELS).map(function(cat) {
    var val = config["cat_required_" + cat] || "";
    return '<div class="field-row">' +
      '<label class="field-label">' + CAT_LABELS[cat] + '</label>' +
      '<input class="field-input" id="req-' + cat + '" type="text" value="' + val + '"/>' +
      '<div class="field-hint">Comma-separated field keys. Used for completeness indicator.</div>' +
    '</div>';
  }).join("");
}

function setValue(id, val) {
  var el = document.getElementById(id);
  if (el) el.value = val;
}

function updateRedLabel() {
  var y = document.getElementById("score-yellow");
  var lbl = document.getElementById("score-red-label");
  if (y && lbl) lbl.textContent = "Score below " + (y.value || "40");
}
document.addEventListener("input", function(e) {
  if (e.target.id === "score-yellow") updateRedLabel();
});

/* ---- SAVE FUNCTIONS ---- */
function saveConfig(updates, msgId) {
  var rows = Object.keys(updates).map(function(k) {
    return { key: k, value: String(updates[k]), updated_at: new Date().toISOString() };
  });
  // Get fresh session token so RLS allows the upsert
  sb.auth.getSession().then(function(sessionRes) {
    var token = sessionRes.data && sessionRes.data.session && sessionRes.data.session.access_token;
    var client = token
      ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { global: { headers: { Authorization: 'Bearer ' + token } } })
      : sb;
    var chain = Promise.resolve();
    rows.forEach(function(row) {
      chain = chain.then(function() {
        return client.from("admin_config").upsert(row, { onConflict: "key" });
      });
    });
    chain.then(function() {
      Object.assign(config, updates);
      showMsg(msgId);
    }).catch(function(e) { alert("Save failed: " + e.message); });
  });
}

function showMsg(id) {
  var el = document.getElementById(id);
  if (!el) return;
  el.classList.add("show");
  setTimeout(function() { el.classList.remove("show"); }, 2500);
}

function saveTerms() {
  saveConfig({
    terms_text:    document.getElementById("terms-text").value,
    terms_version: document.getElementById("terms-version").value
  }, "msg-terms");
}

function savePrompt(key) {
  var inputId = "prompt-" + key;
  var configKey = "prompt_" + key.replace(/-/g, '_');
  var updates = {};
  var el = document.getElementById(inputId);
  if (el) updates[configKey] = el.value;
  saveConfig(updates, "msg-prompt-" + key);
}

function saveCatPrompts() {
  var cats = ['design','construct','contract','intercon','financial','permit','procurement'];
  var updates = {};
  cats.forEach(function(k) {
    var el = document.getElementById('prompt-cat-' + k);
    if (el) updates['prompt_cat_' + k] = el.value.trim();
  });
  saveConfig(updates, 'msg-cat-all');
}

function saveScoreThresholds() {
  saveConfig({
    score_green_threshold:  document.getElementById("score-green").value,
    score_yellow_threshold: document.getElementById("score-yellow").value
  }, "msg-scoring");
}

function saveTimelineThresholds() {
  saveConfig({
    timeline_permit_green:  document.getElementById("tl-green").value,
    timeline_permit_yellow: document.getElementById("tl-yellow").value
  }, "msg-timeline");
}

function saveRequiredFields() {
  var updates = {};
  Object.keys(CAT_LABELS).forEach(function(cat) {
    var el = document.getElementById("req-" + cat);
    if (el) updates["cat_required_" + cat] = el.value.trim();
  });
  saveConfig(updates, "msg-required");
}

function saveCredentials() {
  var u  = document.getElementById("new-username").value.trim();
  var p  = document.getElementById("new-password").value;
  var p2 = document.getElementById("new-password2").value;
  if (!u || !p) { alert("Username and password required."); return; }
  if (p !== p2) { alert("Passwords do not match."); return; }
  saveConfig({ admin_username: u, admin_password: p }, "msg-credentials");
  document.getElementById("new-password").value  = "";
  document.getElementById("new-password2").value = "";
}

/* ---- USERS ---- */
function loadUsers() {
  sb.from("profiles").select("id, email, subscription_status, subscription_plan, terms_accepted_at, created_at")
    .order("created_at", { ascending: false })
    .then(function(res) {
      if (res.error) { console.error(res.error); return; }
      var users = res.data || [];
      var pro   = users.filter(function(u) { return u.subscription_status === "active"; }).length;
      var tac   = users.filter(function(u) { return u.terms_accepted_at; }).length;

      document.getElementById("user-stats").innerHTML =
        stat(users.length, "Total Users") +
        stat(pro, "Pro Subscribers") +
        stat(users.length - pro, "Free Users") +
        stat(tac, "T&C Accepted");

      // Load project counts
      sb.from("projects").select("user_id").then(function(pr) {
        var counts = {};
        (pr.data || []).forEach(function(p) { counts[p.user_id] = (counts[p.user_id] || 0) + 1; });

        document.getElementById("user-table-body").innerHTML = users.map(function(u) {
          var plan = u.subscription_status === "active"
            ? '<span class="user-badge pro">' + (u.subscription_plan || "Pro") + '</span>'
            : '<span class="user-badge free">Free</span>';
          var tac = u.terms_accepted_at
            ? new Date(u.terms_accepted_at).toLocaleDateString("en-GB")
            : '<span style="color:#444;">No</span>';
          var joined = new Date(u.created_at).toLocaleDateString("en-GB", {day:"2-digit",month:"short",year:"numeric"});
          return '<tr>' +
            '<td>' + (u.email || u.id.slice(0,8) + "...") + '</td>' +
            '<td>' + joined + '</td>' +
            '<td>' + plan + '</td>' +
            '<td>' + tac + '</td>' +
            '<td>' + (counts[u.id] || 0) + '</td>' +
            '</tr>';
        }).join("");
      });
    });
}

function stat(val, lbl) {
  return '<div class="stat-box"><div class="user-count">' + val + '</div><div class="user-count-lbl">' + lbl + '</div></div>';
}
/* =============================================
   DATA SOURCES PANEL
   ============================================= */
var allSources = [];
var newSourceType = 'api';

// Load sources when panel shown
var _origShowPanel = showPanel;
showPanel = function(id) {
  _origShowPanel.call(this, id);
  if (id === 'datasources') loadSources();
  if (id === 'intake') loadIntakeQs();
  if (id === 'registry') frLoadCurrentStatus();
};

function loadSources() {
  sb.from('data_sources').select('*').order('created_at', { ascending: false })
    .then(function(res) {
      if (res.error) { console.error('DS load error:', res.error); return; }
      allSources = res.data || [];
      renderSources(allSources);
    });
}

var CAT_LABELS_DS = {
  solar:'Solar Yield', financial:'Financial', weather:'Weather / Climate',
  land:'Land & Site', regulatory:'Regulatory', grid:'Grid & Power',
  cost:'Cost Benchmarks', environmental:'Environmental', labor:'Labor & Compliance', other:'Other'
};
var TYPE_LABELS = { api:'API', webpage:'Webpage', file:'File / CSV', scrape:'Scrape' };

function filterSources() {
  var q    = (document.getElementById('ds-search').value || '').toLowerCase();
  var type = document.getElementById('ds-filter-type').value;
  var cat  = document.getElementById('ds-filter-cat').value;
  var filtered = allSources.filter(function(s) {
    var matchQ = !q || (s.name||'').toLowerCase().includes(q) || (s.description||'').toLowerCase().includes(q) || (s.base_url||'').toLowerCase().includes(q);
    var matchT = !type || s.source_type === type;
    var matchC = !cat  || s.category === cat;
    return matchQ && matchT && matchC;
  });
  renderSources(filtered);
}

function renderSources(sources) {
  var grid = document.getElementById('ds-grid');
  if (!sources.length) {
    grid.innerHTML = '<div class="ds-empty-state"><div class="ds-empty-icon">üîå</div><div class="ds-empty-text">No sources found.</div><div class="ds-empty-sub">Click "+ Add Source" to connect your first API or webpage.</div></div>';
    return;
  }
  grid.innerHTML = sources.map(function(s) { return buildSourceCard(s); }).join('');
}

function buildSourceCard(s) {
  var statusCls = s.enabled ? (s.last_test_ok === false ? 'error' : 'active') : 'inactive';
  var typeCls   = s.source_type || 'api';
  var typeLabel = TYPE_LABELS[typeCls] || typeCls;
  var catLabel  = CAT_LABELS_DS[s.category] || s.category || '';
  var freq_opts = ['realtime','hourly','daily','weekly','monthly','manual'].map(function(f) {
    return '<option value="' + f + '"' + (s.refresh_frequency===f?' selected':'') + '>' + f.charAt(0).toUpperCase()+f.slice(1) + '</option>';
  }).join('');
  var cat_opts = Object.keys(CAT_LABELS_DS).map(function(k) {
    return '<option value="'+k+'"'+(s.category===k?' selected':'')+'>'+CAT_LABELS_DS[k]+'</option>';
  }).join('');
  var type_opts = Object.keys(TYPE_LABELS).map(function(k) {
    return '<option value="'+k+'"'+(s.source_type===k?' selected':'')+'>'+TYPE_LABELS[k]+'</option>';
  }).join('');
  var lastTested = s.last_tested_at ? new Date(s.last_tested_at).toLocaleString() : 'Never';
  var testResult = '';
  if (s.last_test_ok === true)  testResult = '<div class="ds-test-result ok">‚úì Last test passed ‚Äî ' + lastTested + '</div>';
  if (s.last_test_ok === false) testResult = '<div class="ds-test-result err">‚úó Last test failed ‚Äî ' + lastTested + (s.last_test_error ? '<br>' + escAdm(s.last_test_error) : '') + '</div>';

  return '<div class="ds-card" id="dscard-' + s.id + '">' +
    '<div class="ds-card-top" onclick="toggleDsCard(\'' + s.id + '\')">' +
      '<div class="ds-status-dot ' + statusCls + '"></div>' +
      '<span class="ds-card-name">' + escAdm(s.name) + '</span>' +
      '<span class="ds-card-type ' + typeCls + '">' + typeLabel + '</span>' +
      '<span class="ds-card-category">' + escAdm(catLabel) + '</span>' +
      '<span class="ds-card-chevron" id="dsv-' + s.id + '">‚ñº</span>' +
    '</div>' +
    '<div class="ds-card-body" id="dsbody-' + s.id + '">' +
      '<div class="ds-row-3">' +
        '<div class="ds-field-row"><label class="ds-field-label">Source Name</label>' +
          '<input class="ds-field-input" id="dsf-name-' + s.id + '" value="' + escAdm(s.name) + '"/></div>' +
        '<div class="ds-field-row"><label class="ds-field-label">Type</label>' +
          '<select class="ds-field-input" id="dsf-type-' + s.id + '">' + type_opts + '</select></div>' +
        '<div class="ds-field-row"><label class="ds-field-label">Category</label>' +
          '<select class="ds-field-input" id="dsf-cat-' + s.id + '">' + cat_opts + '</select></div>' +
      '</div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Base URL / Endpoint</label>' +
        '<input class="ds-field-input" id="dsf-url-' + s.id + '" type="url" value="' + escAdm(s.base_url||'') + '"/>' +
        '<div class="ds-field-hint">Full URL. Use {PARAM} placeholders for dynamic values, e.g. {lat}, {lon}, {api_key}</div></div>' +
      '<div class="ds-row-2">' +
        '<div class="ds-field-row"><label class="ds-field-label">API Key / Auth Token</label>' +
          '<input class="ds-field-input" id="dsf-key-' + s.id + '" type="password" value="' + escAdm(s.api_key||'') + '" placeholder="Leave blank if none"/></div>' +
        '<div class="ds-field-row"><label class="ds-field-label">Refresh Frequency</label>' +
          '<select class="ds-field-input" id="dsf-freq-' + s.id + '">' + freq_opts + '</select></div>' +
      '</div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Request Parameters (JSON)</label>' +
        '<textarea class="ds-field-textarea" id="dsf-params-' + s.id + '" placeholder=\'{"format":"json","units":"metric"}\'>' + escAdm(s.request_params||'') + '</textarea>' +
        '<div class="ds-field-hint">Extra query parameters sent with every request. Use {project_lat}, {project_lon}, {api_key} as runtime substitutions.</div></div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Response Path (dot notation)</label>' +
        '<input class="ds-field-input" id="dsf-path-' + s.id + '" value="' + escAdm(s.response_path||'') + '" placeholder="e.g. outputs.ac_annual or data[0].value"/>' +
        '<div class="ds-field-hint">Where to find the benchmark value in the JSON response. Leave blank for full response.</div></div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Verification Rules (one per line)</label>' +
        '<textarea class="ds-field-textarea" id="dsf-rules-' + s.id + '" style="min-height:100px;" placeholder="e.g. user_yield > baseline * 1.15 ‚Üí RED \'Yield exceeds satellite model\'">' + escAdm(s.verification_rules||'') + '</textarea>' +
        '<div class="ds-field-hint">Plain-text rule descriptions. The cross-verify edge function reads these to apply logic.</div></div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Notes / Documentation</label>' +
        '<textarea class="ds-field-textarea" id="dsf-notes-' + s.id + '" style="min-height:60px;">' + escAdm(s.notes||'') + '</textarea></div>' +
      '<div class="ds-field-row" style="display:flex;align-items:center;gap:12px;">' +
        '<label style="font-size:11px;color:#aaa;cursor:pointer;display:flex;align-items:center;gap:7px;">' +
          '<input type="checkbox" id="dsf-enabled-' + s.id + '"' + (s.enabled?' checked':'') + ' style="accent-color:#FFFF00;width:14px;height:14px;cursor:pointer;"/> Enabled' +
        '</label>' +
        '<label style="font-size:11px;color:#aaa;cursor:pointer;display:flex;align-items:center;gap:7px;">' +
          '<input type="checkbox" id="dsf-cache-' + s.id + '"' + (s.cache_results?' checked':'') + ' style="accent-color:#FFFF00;width:14px;height:14px;cursor:pointer;"/> Cache results in market_benchmarks' +
        '</label>' +
      '</div>' +
      testResult +
      '<div class="ds-card-actions">' +
        '<button class="ds-save-btn" onclick="saveSource(\'' + s.id + '\')">Save</button>' +
        '<button class="ds-test-btn" onclick="testSource(\'' + s.id + '\')">Test Connection</button>' +
        '<span class="ds-save-msg" id="ds-msg-' + s.id + '">Saved</span>' +
        '<button class="ds-del-btn" onclick="deleteSource(\'' + s.id + '\',\'' + escAdm(s.name) + '\')">Delete</button>' +
      '</div>' +
    '</div>' +
  '</div>';
}

function toggleDsCard(id) {
  var body = document.getElementById('dsbody-' + id);
  var chev = document.getElementById('dsv-' + id);
  if (!body) return;
  var isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  if (chev) chev.classList.toggle('open', !isOpen);
}

function escAdm(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function saveSource(id) {
  var updates = {
    name:               (document.getElementById('dsf-name-' + id)||{}).value || '',
    source_type:        (document.getElementById('dsf-type-' + id)||{}).value || 'api',
    category:           (document.getElementById('dsf-cat-' + id)||{}).value  || 'other',
    base_url:           (document.getElementById('dsf-url-' + id)||{}).value  || '',
    api_key:            (document.getElementById('dsf-key-' + id)||{}).value  || '',
    refresh_frequency:  (document.getElementById('dsf-freq-' + id)||{}).value || 'manual',
    request_params:     (document.getElementById('dsf-params-' + id)||{}).value || '',
    response_path:      (document.getElementById('dsf-path-' + id)||{}).value  || '',
    verification_rules: (document.getElementById('dsf-rules-' + id)||{}).value || '',
    notes:              (document.getElementById('dsf-notes-' + id)||{}).value || '',
    enabled:            (document.getElementById('dsf-enabled-' + id)||{}).checked || false,
    cache_results:      (document.getElementById('dsf-cache-' + id)||{}).checked || false,
    updated_at:         new Date().toISOString()
  };
  sb.from('data_sources').update(updates).eq('id', id).then(function(res) {
    if (res.error) { alert('Save failed: ' + res.error.message); return; }
    // update local cache
    var idx = allSources.findIndex(function(s) { return s.id === id; });
    if (idx >= 0) Object.assign(allSources[idx], updates);
    var msg = document.getElementById('ds-msg-' + id);
    if (msg) { msg.classList.add('show'); setTimeout(function() { msg.classList.remove('show'); }, 2500); }
  });
}

function testSource(id) {
  var src = allSources.find(function(s) { return s.id === id; });
  if (!src) return;
  var btn  = document.querySelector('#dscard-' + id + ' .ds-test-btn');
  if (btn) { btn.textContent = 'Testing...'; btn.disabled = true; }

  // Attempt a lightweight HEAD/GET to the base URL
  var url  = src.base_url || '';
  var ok   = false;
  var errMsg = '';

  if (!url) { recordTestResult(id, false, 'No URL configured', btn); return; }

  fetch(url, { method: 'HEAD', mode: 'no-cors' })
    .then(function() {
      // no-cors always "succeeds" ‚Äî treat as reachable
      recordTestResult(id, true, '', btn);
    })
    .catch(function(err) {
      recordTestResult(id, false, err.message, btn);
    });
}

function recordTestResult(id, success, errMsg, btn) {
  var now = new Date().toISOString();
  var update = { last_tested_at: now, last_test_ok: success, last_test_error: errMsg || null, updated_at: now };
  sb.from('data_sources').update(update).eq('id', id).then(function() {
    Object.assign(allSources.find(function(s){return s.id===id;})||{}, update);
    if (btn) { btn.textContent = 'Test Connection'; btn.disabled = false; }
    // Re-render just this card
    var card = document.getElementById('dscard-' + id);
    var src  = allSources.find(function(s){return s.id===id;});
    if (card && src) {
      var wasOpen = document.getElementById('dsbody-' + id).classList.contains('open');
      card.outerHTML = buildSourceCard(src);
      if (wasOpen) {
        document.getElementById('dsbody-' + id).classList.add('open');
        document.getElementById('dsv-' + id).classList.add('open');
      }
    }
  });
}

function deleteSource(id, name) {
  if (!confirm('Delete source "' + name + '"? This cannot be undone.')) return;
  sb.from('data_sources').delete().eq('id', id).then(function(res) {
    if (res.error) { alert('Delete failed: ' + res.error.message); return; }
    allSources = allSources.filter(function(s) { return s.id !== id; });
    renderSources(allSources);
  });
}

/* Add modal */
function openAddSourceModal() {
  document.getElementById('ds-modal-overlay').classList.add('open');
  document.getElementById('new-ds-name').value = '';
  document.getElementById('new-ds-url').value  = '';
  document.getElementById('new-ds-desc').value = '';
  newSourceType = 'api';
  document.querySelectorAll('.ds-type-btn').forEach(function(b,i) {
    b.classList.toggle('selected', i===0);
  });
}

function closeAddSourceModal() {
  document.getElementById('ds-modal-overlay').classList.remove('open');
}

function selectSourceType(type, el) {
  newSourceType = type;
  document.querySelectorAll('.ds-type-btn').forEach(function(b) { b.classList.remove('selected'); });
  el.classList.add('selected');
}

function createSource() {
  var name = (document.getElementById('new-ds-name').value||'').trim();
  var url  = (document.getElementById('new-ds-url').value||'').trim();
  var cat  = document.getElementById('new-ds-category').value;
  var desc = (document.getElementById('new-ds-desc').value||'').trim();
  if (!name) { alert('Source name is required.'); return; }
  var row = {
    name: name, source_type: newSourceType, category: cat,
    base_url: url, description: desc,
    enabled: true, cache_results: false,
    refresh_frequency: 'manual',
    api_key: '', request_params: '', response_path: '',
    verification_rules: '', notes: '',
    created_at: new Date().toISOString(), updated_at: new Date().toISOString()
  };
  sb.from('data_sources').insert(row).select().then(function(res) {
    if (res.error) { alert('Create failed: ' + res.error.message); return; }
    var created = res.data && res.data[0];
    if (created) { allSources.unshift(created); renderSources(allSources); }
    closeAddSourceModal();
    // Auto-open new card
    if (created) {
      setTimeout(function() { toggleDsCard(created.id); }, 100);
    }
  });
}

// Close modal on overlay click
window.addEventListener('load', function() {
  var overlay = document.getElementById('ds-modal-overlay');
  if (overlay) overlay.addEventListener('click', function(e) {
    if (e.target === this) closeAddSourceModal();
  });
});

function saveCatPrompt(catKey) {
  var el = document.getElementById('prompt-cat-' + catKey);
  if (!el) return;
  var updates = {};
  updates['prompt_cat_' + catKey] = el.value.trim();
  saveConfig(updates, 'msg-cat-' + catKey);
}


/* ================================================================
   INTAKE QUESTIONS PANEL
   Stored in admin_config: key="intake_questions", value=JSON array
   Each question: { id, label, type, opts, required, order }
   Types: text | number | select | date | toggle | textarea
   ================================================================ */

var iqList    = [];   // working copy
var iqDragId  = null; // id of card being dragged

/* Called on panel load and on showPanel('intake') */
function loadIntakeQs() {
  sb.from("admin_config").select("value").eq("key", "intake_questions").single().then(function(res) {
    if (res.data && res.data.value) {
      try {
        var p = JSON.parse(res.data.value);
        if (Array.isArray(p) && p.length > 0) {
          iqList = p.slice().sort(function(a, b) { return (a.order || 0) - (b.order || 0); });
          renderIQPanel();
          return;
        }
      } catch (e) {}
    }
    // Seed with defaults
    iqList = [
      { id:"q_name",     label:"Project Name",                        type:"text",     required:true,  order:1, opts:"" },
      { id:"q_cap",      label:"Capacity (MWp)",                      type:"number",   required:true,  order:2, opts:"" },
      { id:"q_state",    label:"State / Province",                    type:"select",   required:true,  order:3,
        opts:"Alabama,Alaska,Arizona,Arkansas,California,Colorado,Connecticut,Delaware,Florida,Georgia,Hawaii,Idaho,Illinois,Indiana,Iowa,Kansas,Kentucky,Louisiana,Maine,Maryland,Massachusetts,Michigan,Minnesota,Mississippi,Missouri,Montana,Nebraska,Nevada,New Hampshire,New Jersey,New Mexico,New York,North Carolina,North Dakota,Ohio,Oklahoma,Oregon,Pennsylvania,Rhode Island,South Carolina,South Dakota,Tennessee,Texas,Utah,Vermont,Virginia,Washington,West Virginia,Wisconsin,Wyoming" },
      { id:"q_stage",    label:"Project Stage",                       type:"select",   required:true,  order:4, opts:"Development,Pre-Construction,Construction,Operational" },
      { id:"q_location", label:"Google Maps Link",                    type:"text",     required:false, order:5, opts:"" },
      { id:"q_notes",    label:"Brief Project Description",           type:"textarea", required:false, order:6, opts:"" }
    ];
    renderIQPanel();
  });
}

function saveIntakeQs() {
  // Pull current values from DOM into iqList
  iqList.forEach(function(q) {
    var lblEl  = document.getElementById("iq_lbl_"  + q.id);
    var typEl  = document.getElementById("iq_typ_"  + q.id);
    var optEl  = document.getElementById("iq_opt_"  + q.id);
    var reqEl  = document.getElementById("iq_req_"  + q.id);
    if (lblEl) q.label    = lblEl.value.trim()  || q.label;
    if (typEl) q.type     = typEl.value;
    if (optEl) q.opts     = optEl.value.trim();
    if (reqEl) q.required = reqEl.checked;
  });
  iqList.forEach(function(q, i) { q.order = i + 1; });

  var payload = { intake_questions: JSON.stringify(iqList) };
  // Flash both msg elements (registry tab and legacy hidden span)
  ['iq-save-msg', 'iq-save-msg-reg'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) { el.classList.add('show'); setTimeout(function() { el.classList.remove('show'); }, 2000); }
  });
  saveConfig(payload, null);
  renderIQPanel();
}

function addIQ() {
  iqList.push({
    id:       "q_" + Date.now(),
    label:    "New Question",
    type:     "text",
    opts:     "",
    required: false,
    order:    iqList.length + 1
  });
  renderIQPanel();
  setTimeout(function() {
    var last = document.querySelector("#iq-cards .iq-card:last-child");
    if (last) last.scrollIntoView({ behavior: "smooth", block: "center" });
  }, 60);
}

function deleteIQ(id) {
  if (!confirm("Delete this question? This cannot be undone.")) return;
  iqList = iqList.filter(function(q) { return q.id !== id; });
  renderIQPanel();
}

function moveIQ(id, dir) {
  var idx = iqList.findIndex(function(q) { return q.id === id; });
  var to  = idx + dir;
  if (idx < 0 || to < 0 || to >= iqList.length) return;
  // Read DOM values before re-render to preserve unsaved edits
  iqList.forEach(function(q) {
    var lblEl = document.getElementById("iq_lbl_" + q.id);
    var typEl = document.getElementById("iq_typ_" + q.id);
    var optEl = document.getElementById("iq_opt_" + q.id);
    var reqEl = document.getElementById("iq_req_" + q.id);
    if (lblEl) q.label    = lblEl.value;
    if (typEl) q.type     = typEl.value;
    if (optEl) q.opts     = optEl.value;
    if (reqEl) q.required = reqEl.checked;
  });
  var tmp       = iqList[idx];
  iqList[idx]   = iqList[to];
  iqList[to]    = tmp;
  renderIQPanel();
}

function iqTypeChange(id) {
  var el = document.getElementById("iq_typ_" + id);
  if (!el) return;
  var q = iqList.find(function(q) { return q.id === id; });
  if (q) q.type = el.value;
  var wrap = document.getElementById("iq_optwrap_" + id);
  if (wrap) wrap.style.display = el.value === "select" ? "block" : "none";
  var badge = document.getElementById("iq_typbadge_" + id);
  if (badge) { badge.textContent = el.value; badge.setAttribute("data-t", el.value); }
}

function iqLabelChange(id) {
  var el = document.getElementById("iq_lbl_" + id);
  if (!el) return;
  var q = iqList.find(function(q) { return q.id === id; });
  if (q) q.label = el.value;
  var hdr = document.getElementById("iq_hdrlbl_" + id);
  if (hdr) hdr.textContent = el.value || "Untitled";
}

function iqReqChange(id) {
  var el = document.getElementById("iq_req_" + id);
  if (!el) return;
  var q = iqList.find(function(q) { return q.id === id; });
  if (q) q.required = el.checked;
  var badge = document.getElementById("iq_reqbadge_" + id);
  if (badge) badge.style.display = el.checked ? "inline-flex" : "none";
}

function renderIQPanel() {
  var countEl = document.getElementById("iq-count");
  if (countEl) countEl.textContent = iqList.length;

  var container = document.getElementById("iq-cards");
  if (!container) return;

  if (!iqList.length) {
    container.innerHTML = '<div style="text-align:center;padding:48px 20px;color:#444;font-size:13px;">No questions yet. Click <strong>+ Add Question</strong> to start.</div>';
    return;
  }

  var TYPE_COLORS = {
    text:     "rgba(36,113,163,0.25);color:#7aa3f5",
    number:   "rgba(125,60,152,0.25);color:#c39af5",
    select:   "rgba(46,125,79,0.25);color:#6ec997",
    date:     "rgba(224,123,32,0.25);color:#f5a742",
    toggle:   "rgba(17,122,101,0.25);color:#4ecdc4",
    textarea: "rgba(90,90,90,0.25);color:#aaa"
  };

  container.innerHTML = iqList.map(function(q, i) {
    var tc  = TYPE_COLORS[q.type] || TYPE_COLORS.text;
    var last = i === iqList.length - 1;
    return '<div class="iq-card" id="iqcard_' + q.id + '" draggable="true" ' +
      'ondragstart="iqDragStart(event,\'' + q.id + '\')" ' +
      'ondragover="iqDragOver(event)" ' +
      'ondrop="iqDrop(event,\'' + q.id + '\')" ' +
      'ondragend="iqDragEnd()">' +

      // Header row
      '<div class="iq-card-hdr">' +
        '<span class="iq-drag">&#8942;&#8942;</span>' +
        '<span class="iq-hdr-label" id="iq_hdrlbl_' + q.id + '">' + escAdm(q.label) + '</span>' +
        '<span class="iq-req-badge" id="iq_reqbadge_' + q.id + '" style="display:' + (q.required ? "inline-flex" : "none") + ';">Required</span>' +
        '<span class="iq-type-badge" id="iq_typbadge_' + q.id + '" data-t="' + q.type + '" style="background:' + tc + '">' + q.type + '</span>' +
        '<button class="iq-move-btn" onclick="moveIQ(\'' + q.id + '\',-1)"' + (i === 0 ? ' disabled' : '') + '>&#8593;</button>' +
        '<button class="iq-move-btn" onclick="moveIQ(\'' + q.id + '\',1)"' + (last ? ' disabled' : '') + '>&#8595;</button>' +
      '</div>' +

      // Body
      '<div class="iq-card-body">' +
        '<div class="iq-row2">' +
          '<div>' +
            '<label class="iq-fl">Question Label</label>' +
            '<input class="iq-fi" id="iq_lbl_' + q.id + '" type="text" value="' + escAdm(q.label) + '" placeholder="e.g. Project Name" oninput="iqLabelChange(\'' + q.id + '\')" />' +
          '</div>' +
          '<div>' +
            '<label class="iq-fl">Field Type</label>' +
            '<select class="iq-fs" id="iq_typ_' + q.id + '" onchange="iqTypeChange(\'' + q.id + '\')">' +
              ['text','number','select','date','toggle','textarea'].map(function(t) {
                return '<option value="' + t + '"' + (q.type === t ? ' selected' : '') + '>' + t + '</option>';
              }).join('') +
            '</select>' +
          '</div>' +
        '</div>' +
        '<div id="iq_optwrap_' + q.id + '" style="display:' + (q.type === 'select' ? 'block' : 'none') + ';">' +
          '<label class="iq-fl">Options <span style="color:#555;font-weight:400;">(comma-separated)</span></label>' +
          '<input class="iq-fi" id="iq_opt_' + q.id + '" type="text" value="' + escAdm(q.opts || '') + '" placeholder="Option A, Option B, Option C" />' +
        '</div>' +
        '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:4px;">' +
          '<label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px;color:#aaa;">' +
            '<input type="checkbox" id="iq_req_' + q.id + '"' + (q.required ? ' checked' : '') + ' onchange="iqReqChange(\'' + q.id + '\')" style="accent-color:#FFFF00;width:13px;height:13px;"/>' +
            'Required field' +
          '</label>' +
          '<span style="font-size:9px;color:#2a2a2a;">id: ' + escAdm(q.id) + '</span>' +
          '<button class="iq-del-btn" onclick="deleteIQ(\'' + q.id + '\')">&#x2715; Delete</button>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join("");
}

/* Drag & drop reorder */
function iqDragStart(e, id) {
  iqDragId = id;
  e.dataTransfer.effectAllowed = "move";
  setTimeout(function() {
    var el = document.getElementById("iqcard_" + id);
    if (el) el.style.opacity = "0.4";
  }, 0);
}
function iqDragOver(e) { e.preventDefault(); return false; }
function iqDrop(e, targetId) {
  e.stopPropagation();
  if (!iqDragId || iqDragId === targetId) return;
  // Read DOM before re-render
  iqList.forEach(function(q) {
    var l = document.getElementById("iq_lbl_" + q.id);
    var t = document.getElementById("iq_typ_" + q.id);
    var o = document.getElementById("iq_opt_" + q.id);
    var r = document.getElementById("iq_req_" + q.id);
    if (l) q.label    = l.value;
    if (t) q.type     = t.value;
    if (o) q.opts     = o.value;
    if (r) q.required = r.checked;
  });
  var srcIdx = iqList.findIndex(function(q) { return q.id === iqDragId; });
  var tgtIdx = iqList.findIndex(function(q) { return q.id === targetId; });
  if (srcIdx < 0 || tgtIdx < 0) return;
  var moved = iqList.splice(srcIdx, 1)[0];
  iqList.splice(tgtIdx, 0, moved);
  renderIQPanel();
}
function iqDragEnd() {
  iqDragId = null;
  document.querySelectorAll(".iq-card").forEach(function(c) { c.style.opacity = ""; });
}

/* ================================================================
   FIELD REGISTRY ‚Äî Excel upload, parse, diff, publish
   ================================================================ */

var frParsed       = null;   // parsed registry object from Excel
var frCurrentReg   = null;   // registry currently live in admin_config

// Expected category sheet names ‚Üí CATEGORIES keys
var FR_CAT_SHEETS = [
  'score_permit','score_design','score_construct',
  'score_procurement','score_contract','score_intercon','score_financial'
];

/* Load current registry status from admin_config */
function frLoadCurrentStatus() {
  sb.from('admin_config').select('value').eq('key','field_registry_meta').single()
    .then(function(res) {
      var el = document.getElementById('fr-current-status');
      var hist = document.getElementById('fr-version-history');
      if (!el) return;
      if (res.error || !res.data) {
        el.className = 'fr-status-bar none';
        el.innerHTML = '<div class="fr-status-dot"></div><div class="fr-status-text">No registry uploaded yet ‚Äî hardcoded defaults are active.</div>';
        return;
      }
      try {
        var meta = JSON.parse(res.data.value);
        el.className = 'fr-status-bar ok';
        el.innerHTML = '<div class="fr-status-dot"></div>' +
          '<div class="fr-status-text">Registry <strong>' + escAdm(meta.version) + '</strong> active ‚Äî ' +
          escAdm(meta.total_fields) + ' fields across ' + escAdm(meta.total_cats) + ' categories. ' +
          'Published ' + new Date(meta.published_at).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}) + '</div>' +
          '<div class="fr-badge">' + escAdm(meta.version) + '</div>';
        // History
        if (meta.history && meta.history.length) {
          hist.style.display = 'block';
          var htbl = document.getElementById('fr-history-table');
          if (htbl) htbl.innerHTML = meta.history.slice().reverse().slice(0,5).map(function(h) {
            return '<tr><td>' + escAdm(h.version) + '</td><td>' + escAdm(h.total_fields) + ' fields</td>' +
              '<td>' + new Date(h.published_at).toLocaleDateString('en-GB') + '</td></tr>';
          }).join('');
        }
      } catch(e) {
        el.className = 'fr-status-bar warn';
        el.innerHTML = '<div class="fr-status-dot"></div><div class="fr-status-text">Registry metadata corrupt.</div>';
      }
    });

  // Also load the actual registry for diffing
  sb.from('admin_config').select('value').eq('key','field_registry').single()
    .then(function(res) {
      if (!res.error && res.data) {
        try { frCurrentReg = JSON.parse(res.data.value); } catch(e) { frCurrentReg = null; }
      }
    });
}

/* Handle drag drop */
function frHandleDrop(e) {
  e.preventDefault();
  document.getElementById('fr-drop-zone').classList.remove('drag');
  var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) frHandleFile(f);
}

/* Parse the uploaded Excel into a registry object */
function frHandleFile(file) {
  if (!file) return;
  if (!file.name.match(/\.xlsx$/i)) {
    frShowParseStatus('error', 'Invalid file type ‚Äî please upload a .xlsx file.', '');
    return;
  }
  document.getElementById('fr-preview-wrap').style.display = 'block';
  frShowParseStatus('none', 'Reading file‚Ä¶', '');

  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = new Uint8Array(e.target.result);
      var wb   = XLSX.read(data, { type: 'array' });

      var registry  = {};   // { catKey: [ {id,label,section,section_icon,type,opts,required,col}, ‚Ä¶ ] }
      var errors    = [];
      var totalFields = 0;
      var foundCats   = 0;

      FR_CAT_SHEETS.forEach(function(catKey) {
        // Accept sheet named exactly catKey OR the human label
        var sheetName = wb.SheetNames.find(function(n) {
          return n.trim() === catKey ||
                 n.trim().toLowerCase().replace(/[^a-z]/g,'') === catKey.replace(/[^a-z]/g,'');
        });
        if (!sheetName) {
          // Not present ‚Äî keep existing definition for this cat (won't overwrite)
          return;
        }
        var ws   = wb.Sheets[sheetName];
        var rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
        if (!rows.length) return;
        foundCats++;

        // sheet_to_json uses row 1 as headers. If the sheet has a hint row (row 2)
        // that SheetJS might pick up, normalise and filter it out.
        // Normalise column names: lowercase + trim
        var norm = rows.map(function(r) {
          var out = {};
          Object.keys(r).forEach(function(k) { out[k.trim().toLowerCase().replace(/^‚Ü≥\s*/,'')] = r[k]; });
          return out;
        // Filter: keep only rows where id is a non-empty string NOT starting with ‚Ü≥ or a space
        }).filter(function(r) {
          var id = String(r.id || '').trim();
          return id && !id.startsWith('‚Ü≥') && !id.startsWith('Field key') && id.length > 0;
        });

        // Validate required columns
        if (!rows.length || !('id' in rows[0]) && !('ID' in rows[0])) {
          // Try to detect if user uploaded with wrong header ‚Äî scan all SheetNames for id column
          var rawKeys = rows.length ? Object.keys(rows[0]) : [];
          var hasId = rawKeys.some(function(k){ return k.trim().toLowerCase() === 'id'; });
          if (!hasId) {
            errors.push('Sheet "' + sheetName + '" is missing required column: id  (found columns: ' + rawKeys.slice(0,5).join(', ') + ')');
            return;
          }
        }
        if (!norm.length) return; // empty after filtering

        // Check for duplicate IDs within sheet
        var seen = {};
        norm.forEach(function(r) {
          var id = String(r.id || '').trim();
          if (!id) return;
          if (seen[id]) errors.push('Duplicate field id "' + id + '" in sheet ' + sheetName);
          seen[id] = true;
        });

        registry[catKey] = norm.filter(function(r) { return String(r.id||'').trim(); }).map(function(r) {
          var opts = String(r.opts || '').trim();
          var optsArr = opts ? opts.split(',').map(function(o){return o.trim();}) : [];
          return {
            id:           String(r.id).trim(),
            label:        String(r.label || '').trim(),
            section:      String(r.section || 'General').trim(),
            section_icon: String(r.section_icon || 'üìã').trim(),
            type:         String(r.type || 'text').trim().toLowerCase(),
            opts:         optsArr,
            required:     String(r.required || '').toLowerCase() === 'true' || r.required === 1,
            col:          parseInt(r.col) === 2 ? 2 : 1
          };
        });
        totalFields += registry[catKey].length;
      });

      if (errors.length) {
        document.getElementById('fr-warn-wrap').style.display = 'block';
        document.getElementById('fr-warn-wrap').innerHTML = errors.map(function(e) {
          return '<p>‚ö† ' + escAdm(e) + '</p>';
        }).join('');
      } else {
        document.getElementById('fr-warn-wrap').style.display = 'none';
      }

      frParsed = { registry: registry, totalFields: totalFields, foundCats: foundCats };
      frRenderDiff(registry, totalFields, foundCats, errors.length > 0);

    } catch(err) {
      frShowParseStatus('error', 'Parse error: ' + err.message, '');
    }
  };
  reader.readAsArrayBuffer(file);
}

/* Build diff view comparing parsed vs current */
function frRenderDiff(registry, totalFields, foundCats, hasErrors) {
  var rows   = [];
  var newCnt = 0, changedCnt = 0, removedCnt = 0;

  FR_CAT_SHEETS.forEach(function(catKey) {
    var newFields = registry[catKey] || [];
    var oldFields = (frCurrentReg && frCurrentReg[catKey]) || [];
    var oldById   = {};
    oldFields.forEach(function(f) { oldById[f.id] = f; });
    var newById   = {};
    newFields.forEach(function(f) { newById[f.id] = f; });

    // New or changed
    newFields.forEach(function(f) {
      var old = oldById[f.id];
      if (!old) {
        rows.push({ id: f.id, label: f.label, cat: catKey, change: 'new' });
        newCnt++;
      } else if (old.label !== f.label || old.type !== f.type || old.section !== f.section) {
        rows.push({ id: f.id, label: f.label, cat: catKey, change: 'changed' });
        changedCnt++;
      }
    });

    // Removed
    oldFields.forEach(function(f) {
      if (!newById[f.id]) {
        rows.push({ id: f.id, label: f.label, cat: catKey, change: 'removed' });
        removedCnt++;
      }
    });
  });

  var summaryParts = [totalFields + ' fields', foundCats + ' sheets'];
  if (newCnt)     summaryParts.push('+' + newCnt + ' new');
  if (changedCnt) summaryParts.push(changedCnt + ' changed');
  if (removedCnt) summaryParts.push(removedCnt + ' removed');

  var statusClass = hasErrors ? 'error' : (removedCnt > 0 ? 'warn' : 'ok');
  var statusMsg   = hasErrors
    ? 'Errors found ‚Äî fix the Excel before publishing.'
    : (removedCnt > 0
      ? removedCnt + ' field(s) will be removed. Check scoring rules still reference valid IDs.'
      : 'Registry parsed successfully. Review changes below and publish when ready.');

  frShowParseStatus(statusClass, statusMsg, summaryParts.join('  ¬∑  '));

  // Render diff rows (show all if ‚â§50, else show changed/new/removed only)
  var showRows = rows.length ? rows : [{ id:'(no changes)', label:'All fields match current registry', cat:'', change:'ok' }];
  document.getElementById('fr-preview-rows').innerHTML = showRows.slice(0,60).map(function(r) {
    var cls = r.change === 'new' ? 'new-field' : r.change === 'changed' ? 'changed' : r.change === 'removed' ? 'removed' : '';
    var tag = r.change === 'new' ? '+ new' : r.change === 'changed' ? '~ changed' : r.change === 'removed' ? '‚úï removed' : '‚úì';
    return '<div class="fr-preview-row ' + cls + '">' +
      '<span>' + escAdm(r.id) + '</span>' +
      '<span>' + escAdm(r.label) + '</span>' +
      '<span>' + escAdm(r.cat) + '</span>' +
      '<span>' + tag + '</span></div>';
  }).join('');

  var publishBtn = document.getElementById('fr-publish-btn');
  if (publishBtn) publishBtn.disabled = hasErrors;
}

function frShowParseStatus(cls, msg, badge) {
  var el   = document.getElementById('fr-parse-status');
  var msgEl = document.getElementById('fr-parse-msg');
  var bdgEl = document.getElementById('fr-parse-badge');
  if (!el) return;
  el.className = 'fr-status-bar ' + cls;
  if (msgEl) msgEl.textContent = msg;
  if (bdgEl) { bdgEl.textContent = badge; bdgEl.style.display = badge ? 'inline-block' : 'none'; }
}

/* Publish ‚Äî save to admin_config */
function frPublish() {
  if (!frParsed) return;
  var publishBtn = document.getElementById('fr-publish-btn');
  if (publishBtn) { publishBtn.disabled = true; publishBtn.textContent = 'Publishing‚Ä¶'; }

  // Calculate version string
  var now     = new Date();
  var version = 'v' + now.getFullYear().toString().slice(2) + '.' +
    String(now.getMonth()+1).padStart(2,'0') + '.' +
    String(now.getDate()).padStart(2,'0') + '.' +
    String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');

  var meta = {
    version:      version,
    total_fields: frParsed.totalFields,
    total_cats:   frParsed.foundCats,
    published_at: now.toISOString(),
    history:      []
  };

  // Merge history from existing meta
  sb.from('admin_config').select('value').eq('key','field_registry_meta').single()
    .then(function(res) {
      if (!res.error && res.data) {
        try {
          var existing = JSON.parse(res.data.value);
          meta.history = (existing.history || []).concat([{
            version: existing.version,
            total_fields: existing.total_fields,
            published_at: existing.published_at
          }]).slice(-10); // keep last 10
        } catch(e) {}
      }

      // Save both registry data and meta
      var rows = [
        { key: 'field_registry',      value: JSON.stringify(frParsed.registry),  updated_at: now.toISOString() },
        { key: 'field_registry_meta', value: JSON.stringify(meta),               updated_at: now.toISOString() },
        { key: 'field_registry_version', value: version,                         updated_at: now.toISOString() }
      ];

      sb.auth.getSession().then(function(sessionRes) {
        var token  = sessionRes.data && sessionRes.data.session && sessionRes.data.session.access_token;
        var client = token
          ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { global: { headers: { Authorization: 'Bearer ' + token } } })
          : sb;

        var chain = Promise.resolve();
        rows.forEach(function(row) {
          chain = chain.then(function() {
            return client.from('admin_config').insert(row);
          });
        });
        chain.then(function() {
          // Also update local config
          config['field_registry']         = rows[0].value;
          config['field_registry_meta']     = rows[1].value;
          config['field_registry_version']  = version;
          showMsg('fr-save-msg');
          frLoadCurrentStatus();
          frCancelUpload();
          if (publishBtn) { publishBtn.disabled = false; publishBtn.textContent = '‚úì Publish Registry'; }
        }).catch(function(e) {
          alert('Publish failed: ' + e.message);
          if (publishBtn) { publishBtn.disabled = false; publishBtn.textContent = '‚úì Publish Registry'; }
        });
      });
    });
}

function frCancelUpload() {
  frParsed = null;
  document.getElementById('fr-preview-wrap').style.display = 'none';
  document.getElementById('fr-file-input').value = '';
}



/* ================================================================
   FIELD REGISTRY ‚Äî In-app editor + Excel upload
   Primary flow: Load from Supabase ‚Üí edit in table ‚Üí save directly
   Secondary:    Upload Excel ‚Üí parse ‚Üí preview ‚Üí publish
   ================================================================ */

/* ‚îÄ‚îÄ Tab state ‚îÄ‚îÄ */
var regCurrentTab = null;
var regCurrentCat = null;

/* ‚îÄ‚îÄ Live data cache (loaded from Supabase) ‚îÄ‚îÄ */
var REG_LIVE = {};

/* ‚îÄ‚îÄ Category ‚Üí admin_config key map ‚îÄ‚îÄ */
var CAT_TO_KEY = {
  'Design & Engineering':  'score_design',
  'Construction':          'score_construct',
  'Permitting':            'score_permit',
  'Procurement':           'score_procurement',
  'Legal & Contract':      'score_contract',
  'Grid Interconnection':  'score_intercon',
  'Financial':             'score_financial',
};
var SHEET_TO_CAT = CAT_TO_KEY; // alias for Excel parser

var ALL_REG_KEYS = [
  'field_registry','field_registry_version','field_registry_date','field_registry_meta',
  'reg_design_arrays','reg_crews','reg_procurement_contracts',
  'reg_components','reg_suppliers','reg_equipment'
];

/* ‚îÄ‚îÄ Hardcoded defaults ‚Äî extracted directly from overview.html data structures ‚îÄ‚îÄ
   These populate the editor immediately without waiting for Supabase.
   If Supabase has published overrides they will be merged on top. ‚îÄ‚îÄ */
var REG_DEFAULTS = (function() {
  try { return JSON.parse("{\"field_registry\":{\"score_permit\":[{\"id\":\"proj_name\",\"field\":\"proj_name\",\"lbl\":\"Project Name\",\"label\":\"Project Name\",\"type\":\"text\",\"opts\":[],\"col\":2,\"section\":\"Project Location\",\"section_icon\":\"\"},{\"id\":\"county\",\"field\":\"county\",\"lbl\":\"County\",\"label\":\"County\",\"type\":\"text\",\"opts\":[],\"col\":1,\"section\":\"Project Location\",\"section_icon\":\"\"},{\"id\":\"state\",\"field\":\"state\",\"lbl\":\"State\",\"label\":\"State\",\"type\":\"select\",\"opts\":[\"\",\"AL\",\"AK\",\"AZ\",\"AR\",\"CA\",\"CO\",\"CT\",\"DE\",\"FL\",\"GA\",\"HI\",\"ID\",\"IL\",\"IN\",\"IA\",\"KS\",\"KY\",\"LA\",\"ME\",\"MD\",\"MA\",\"MI\",\"MN\",\"MS\",\"MO\",\"MT\",\"NE\",\"NV\",\"NH\",\"NJ\",\"NM\",\"NY\",\"NC\",\"ND\",\"OH\",\"OK\",\"OR\",\"PA\",\"RI\",\"SC\",\"SD\",\"TN\",\"TX\",\"UT\",\"VT\",\"VA\",\"WA\",\"WV\",\"WI\",\"WY\"],\"col\":1,\"section\":\"Project Location\",\"section_icon\":\"\"},{\"id\":\"iso_rto\",\"field\":\"iso_rto\",\"lbl\":\"ISO / RTO\",\"label\":\"ISO / RTO\",\"type\":\"select\",\"opts\":[\"\",\"PJM\",\"CAISO\",\"ERCOT\",\"MISO\",\"SPP\",\"NYISO\",\"ISO-NE\",\"WECC\",\"Other\"],\"col\":1,\"section\":\"Project Location\",\"section_icon\":\"\"},{\"id\":\"latitude\",\"field\":\"latitude\",\"lbl\":\"Latitude\",\"label\":\"Latitude\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Project Location\",\"section_icon\":\"\"},{\"id\":\"longitude\",\"field\":\"longitude\",\"lbl\":\"Longitude\",\"label\":\"Longitude\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Project Location\",\"section_icon\":\"\"},{\"id\":\"parcel_numbers\",\"field\":\"parcel_numbers\",\"lbl\":\"Parcel Numbers\",\"label\":\"Parcel Numbers\",\"type\":\"text\",\"opts\":[],\"col\":2,\"section\":\"Project Location\",\"section_icon\":\"\"},{\"id\":\"flood_zone\",\"field\":\"flood_zone\",\"lbl\":\"Flood Zone Classification\",\"label\":\"Flood Zone Classification\",\"type\":\"select\",\"opts\":[\"\",\"Zone X (minimal)\",\"Zone AE\",\"Zone A\",\"Zone VE\",\"Zone V\",\"Unknown\"],\"col\":1,\"section\":\"Project Location\",\"section_icon\":\"\"},{\"id\":\"seismic_zone\",\"field\":\"seismic_zone\",\"lbl\":\"Seismic Zone\",\"label\":\"Seismic Zone\",\"type\":\"select\",\"opts\":[\"\",\"Zone 0\",\"Zone 1\",\"Zone 2A\",\"Zone 2B\",\"Zone 3\",\"Zone 4\"],\"col\":1,\"section\":\"Project Location\",\"section_icon\":\"\"},{\"id\":\"zoning_class\",\"field\":\"zoning_class\",\"lbl\":\"Zoning Classification\",\"label\":\"Zoning Classification\",\"type\":\"text\",\"opts\":[],\"col\":1,\"section\":\"Zoning & Land\",\"section_icon\":\"\"},{\"id\":\"cup_status\",\"field\":\"cup_status\",\"lbl\":\"CUP Status\",\"label\":\"CUP Status\",\"type\":\"select\",\"opts\":[\"\",\"Approved\",\"Pending\",\"Not Required\",\"Denied\"],\"col\":1,\"section\":\"Zoning & Land\",\"section_icon\":\"\"},{\"id\":\"setback_ft\",\"field\":\"setback_ft\",\"lbl\":\"Setback Requirements (ft)\",\"label\":\"Setback Requirements (ft)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Zoning & Land\",\"section_icon\":\"\"},{\"id\":\"site_acres\",\"field\":\"site_acres\",\"lbl\":\"Total Site Acreage\",\"label\":\"Total Site Acreage\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Zoning & Land\",\"section_icon\":\"\"},{\"id\":\"buildable_acres\",\"field\":\"buildable_acres\",\"lbl\":\"Buildable Acreage\",\"label\":\"Buildable Acreage\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Zoning & Land\",\"section_icon\":\"\"},{\"id\":\"land_ownership\",\"field\":\"land_ownership\",\"lbl\":\"Land Ownership\",\"label\":\"Land Ownership\",\"type\":\"select\",\"opts\":[\"\",\"Fee Simple\",\"Lease\",\"Mixed\",\"Option\"],\"col\":1,\"section\":\"Zoning & Land\",\"section_icon\":\"\"},{\"id\":\"lease_term_yrs\",\"field\":\"lease_term_yrs\",\"lbl\":\"Lease Term (years)\",\"label\":\"Lease Term (years)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Zoning & Land\",\"section_icon\":\"\"},{\"id\":\"lease_esc_pct\",\"field\":\"lease_esc_pct\",\"lbl\":\"Lease Escalator (%/yr)\",\"label\":\"Lease Escalator (%/yr)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Zoning & Land\",\"section_icon\":\"\"},{\"id\":\"decomm_bond\",\"field\":\"decomm_bond\",\"lbl\":\"Decommissioning Bond ($)\",\"label\":\"Decommissioning Bond ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Zoning & Land\",\"section_icon\":\"\"},{\"id\":\"esa_status\",\"field\":\"esa_status\",\"lbl\":\"Phase I ESA Status\",\"label\":\"Phase I ESA Status\",\"type\":\"select\",\"opts\":[\"\",\"Complete \\u2013 Clean\",\"Complete \\u2013 REC Identified\",\"In Progress\",\"Not Started\"],\"col\":1,\"section\":\"Environmental\",\"section_icon\":\"\"},{\"id\":\"wetlands_acres\",\"field\":\"wetlands_acres\",\"lbl\":\"Wetlands Acreage\",\"label\":\"Wetlands Acreage\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Environmental\",\"section_icon\":\"\"},{\"id\":\"esa_species\",\"field\":\"esa_species\",\"lbl\":\"Endangered Species Impact\",\"label\":\"Endangered Species Impact\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"Environmental\",\"section_icon\":\"\"},{\"id\":\"mitigation_cost\",\"field\":\"mitigation_cost\",\"lbl\":\"Mitigation Cost ($)\",\"label\":\"Mitigation Cost ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Environmental\",\"section_icon\":\"\"},{\"id\":\"cultural_constraints\",\"field\":\"cultural_constraints\",\"lbl\":\"Cultural Resource Constraints\",\"label\":\"Cultural Resource Constraints\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"Environmental\",\"section_icon\":\"\"},{\"id\":\"swppp_req\",\"field\":\"swppp_req\",\"lbl\":\"SWPPP Required\",\"label\":\"SWPPP Required\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"Environmental\",\"section_icon\":\"\"},{\"id\":\"nepa_req\",\"field\":\"nepa_req\",\"lbl\":\"NEPA Required\",\"label\":\"NEPA Required\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"Environmental\",\"section_icon\":\"\"}],\"score_design\":[],\"score_construct\":[{\"id\":\"ntp_date\",\"field\":\"ntp_date\",\"lbl\":\"NTP Date\",\"label\":\"NTP Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"section\":\"Overall Schedule\",\"section_icon\":\"\"},{\"id\":\"construction_start\",\"field\":\"construction_start\",\"lbl\":\"Construction Start\",\"label\":\"Construction Start\",\"type\":\"date\",\"opts\":[],\"col\":1,\"section\":\"Overall Schedule\",\"section_icon\":\"\"},{\"id\":\"mech_complete_date\",\"field\":\"mech_complete_date\",\"lbl\":\"Mechanical Completion\",\"label\":\"Mechanical Completion\",\"type\":\"date\",\"opts\":[],\"col\":1,\"section\":\"Overall Schedule\",\"section_icon\":\"\"},{\"id\":\"pac_date\",\"field\":\"pac_date\",\"lbl\":\"PAC Date\",\"label\":\"PAC Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"section\":\"Overall Schedule\",\"section_icon\":\"\"},{\"id\":\"cod_target_date\",\"field\":\"cod_target_date\",\"lbl\":\"FAC / COD Target\",\"label\":\"FAC / COD Target\",\"type\":\"date\",\"opts\":[],\"col\":1,\"section\":\"Overall Schedule\",\"section_icon\":\"\"},{\"id\":\"const_duration_mo\",\"field\":\"const_duration_mo\",\"lbl\":\"Total Duration (months)\",\"label\":\"Total Duration (months)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Overall Schedule\",\"section_icon\":\"\"},{\"id\":\"weather_days\",\"field\":\"weather_days\",\"lbl\":\"Weather Contingency (days)\",\"label\":\"Weather Contingency (days)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Overall Schedule\",\"section_icon\":\"\"},{\"id\":\"cp_float_days\",\"field\":\"cp_float_days\",\"lbl\":\"Float on Critical Path (days)\",\"label\":\"Float on Critical Path (days)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Overall Schedule\",\"section_icon\":\"\"},{\"id\":\"epc_price\",\"field\":\"epc_price\",\"lbl\":\"Total EPC Price ($)\",\"label\":\"Total EPC Price ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Budget & Cost\",\"section_icon\":\"\"},{\"id\":\"epc_per_wdc\",\"field\":\"epc_per_wdc\",\"lbl\":\"EPC Price ($/Wdc)\",\"label\":\"EPC Price ($/Wdc)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Budget & Cost\",\"section_icon\":\"\"},{\"id\":\"intercon_cost\",\"field\":\"intercon_cost\",\"lbl\":\"Interconnection Cost ($)\",\"label\":\"Interconnection Cost ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Budget & Cost\",\"section_icon\":\"\"},{\"id\":\"land_permit_cost\",\"field\":\"land_permit_cost\",\"lbl\":\"Land & Permitting ($)\",\"label\":\"Land & Permitting ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Budget & Cost\",\"section_icon\":\"\"},{\"id\":\"contingency_usd\",\"field\":\"contingency_usd\",\"lbl\":\"Contingency ($)\",\"label\":\"Contingency ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Budget & Cost\",\"section_icon\":\"\"},{\"id\":\"contingency_pct\",\"field\":\"contingency_pct\",\"lbl\":\"Contingency (%)\",\"label\":\"Contingency (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Budget & Cost\",\"section_icon\":\"\"},{\"id\":\"sales_tax\",\"field\":\"sales_tax\",\"lbl\":\"Sales / Use Tax ($)\",\"label\":\"Sales / Use Tax ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Budget & Cost\",\"section_icon\":\"\"},{\"id\":\"peak_manpower\",\"field\":\"peak_manpower\",\"lbl\":\"Peak Manpower (workers)\",\"label\":\"Peak Manpower (workers)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Workforce & Logistics\",\"section_icon\":\"\"},{\"id\":\"total_labour_hrs\",\"field\":\"total_labour_hrs\",\"lbl\":\"Total Labour Hours\",\"label\":\"Total Labour Hours\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Workforce & Logistics\",\"section_icon\":\"\"},{\"id\":\"subcontractor_count\",\"field\":\"subcontractor_count\",\"lbl\":\"Subcontractors Count\",\"label\":\"Subcontractors Count\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Workforce & Logistics\",\"section_icon\":\"\"},{\"id\":\"mod_rate_day\",\"field\":\"mod_rate_day\",\"lbl\":\"Module Install Rate (mod/day)\",\"label\":\"Module Install Rate (mod/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Workforce & Logistics\",\"section_icon\":\"\"},{\"id\":\"pile_rate_day\",\"field\":\"pile_rate_day\",\"lbl\":\"Pile Drive Rate (piles/day)\",\"label\":\"Pile Drive Rate (piles/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Workforce & Logistics\",\"section_icon\":\"\"},{\"id\":\"laydown_acres\",\"field\":\"laydown_acres\",\"lbl\":\"Laydown Area (acres)\",\"label\":\"Laydown Area (acres)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Workforce & Logistics\",\"section_icon\":\"\"},{\"id\":\"truck_access_km\",\"field\":\"truck_access_km\",\"lbl\":\"Nearest Truck Access (km)\",\"label\":\"Nearest Truck Access (km)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Workforce & Logistics\",\"section_icon\":\"\"},{\"id\":\"hse_plan\",\"field\":\"hse_plan\",\"lbl\":\"HSE Plan Approved\",\"label\":\"HSE Plan Approved\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"Workforce & Logistics\",\"section_icon\":\"\"},{\"id\":\"qaqc_plan\",\"field\":\"qaqc_plan\",\"lbl\":\"QA/QC Plan Approved\",\"label\":\"QA/QC Plan Approved\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"Workforce & Logistics\",\"section_icon\":\"\"}],\"score_procurement\":[{\"id\":\"epc_contractor_name\",\"field\":\"epc_contractor_name\",\"lbl\":\"EPC Contractor\",\"label\":\"EPC Contractor\",\"type\":\"text\",\"opts\":[],\"col\":2,\"section\":\"EPC Contract Terms\",\"section_icon\":\"\"},{\"id\":\"epc_contract_type\",\"field\":\"epc_contract_type\",\"lbl\":\"Contract Type\",\"label\":\"Contract Type\",\"type\":\"select\",\"opts\":[\"\",\"Lump-sum Turnkey (LSTK)\",\"EPC with GMP\",\"Cost-plus\",\"Split-contract\"],\"col\":1,\"section\":\"EPC Contract Terms\",\"section_icon\":\"\"},{\"id\":\"epc_contract_value\",\"field\":\"epc_contract_value\",\"lbl\":\"Contract Value ($)\",\"label\":\"Contract Value ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"EPC Contract Terms\",\"section_icon\":\"\"},{\"id\":\"epc_usd_wdc\",\"field\":\"epc_usd_wdc\",\"lbl\":\"$/Wdc\",\"label\":\"$/Wdc\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"EPC Contract Terms\",\"section_icon\":\"\"},{\"id\":\"epc_currency\",\"field\":\"epc_currency\",\"lbl\":\"Currency\",\"label\":\"Currency\",\"type\":\"select\",\"opts\":[\"\",\"USD\",\"EUR\",\"GBP\",\"AUD\",\"CAD\",\"Other\"],\"col\":1,\"section\":\"EPC Contract Terms\",\"section_icon\":\"\"},{\"id\":\"epc_incoterms\",\"field\":\"epc_incoterms\",\"lbl\":\"Incoterms\",\"label\":\"Incoterms\",\"type\":\"select\",\"opts\":[\"\",\"DDP\",\"DAP\",\"FCA\",\"EXW\",\"CIF\",\"FOB\"],\"col\":1,\"section\":\"EPC Contract Terms\",\"section_icon\":\"\"},{\"id\":\"epc_governing_law\",\"field\":\"epc_governing_law\",\"lbl\":\"Governing Law\",\"label\":\"Governing Law\",\"type\":\"text\",\"opts\":[],\"col\":1,\"section\":\"EPC Contract Terms\",\"section_icon\":\"\"},{\"id\":\"epc_parent_guarantee\",\"field\":\"epc_parent_guarantee\",\"lbl\":\"Parent Guarantee\",\"label\":\"Parent Guarantee\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"EPC Contract Terms\",\"section_icon\":\"\"},{\"id\":\"epc_exec_date\",\"field\":\"epc_exec_date\",\"lbl\":\"Contract Execution Date\",\"label\":\"Contract Execution Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"section\":\"EPC Contract Terms\",\"section_icon\":\"\"},{\"id\":\"pmt_ntp_pct\",\"field\":\"pmt_ntp_pct\",\"lbl\":\"NTP Payment (%)\",\"label\":\"NTP Payment (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Milestone Payment Schedule\",\"section_icon\":\"\"},{\"id\":\"pmt_mob_pct\",\"field\":\"pmt_mob_pct\",\"lbl\":\"Mobilisation (%)\",\"label\":\"Mobilisation (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Milestone Payment Schedule\",\"section_icon\":\"\"},{\"id\":\"pmt_mod_delivery_pct\",\"field\":\"pmt_mod_delivery_pct\",\"lbl\":\"Module Delivery (%)\",\"label\":\"Module Delivery (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Milestone Payment Schedule\",\"section_icon\":\"\"},{\"id\":\"pmt_mech_comp_pct\",\"field\":\"pmt_mech_comp_pct\",\"lbl\":\"Mechanical Complete (%)\",\"label\":\"Mechanical Complete (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Milestone Payment Schedule\",\"section_icon\":\"\"},{\"id\":\"pmt_pac_pct\",\"field\":\"pmt_pac_pct\",\"lbl\":\"PAC (%)\",\"label\":\"PAC (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Milestone Payment Schedule\",\"section_icon\":\"\"},{\"id\":\"pmt_fac_pct\",\"field\":\"pmt_fac_pct\",\"lbl\":\"FAC / Final (%)\",\"label\":\"FAC / Final (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Milestone Payment Schedule\",\"section_icon\":\"\"},{\"id\":\"pmt_retention_pct\",\"field\":\"pmt_retention_pct\",\"lbl\":\"Retention Amount (%)\",\"label\":\"Retention Amount (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Milestone Payment Schedule\",\"section_icon\":\"\"},{\"id\":\"pmt_retention_release\",\"field\":\"pmt_retention_release\",\"lbl\":\"Retention Release\",\"label\":\"Retention Release\",\"type\":\"select\",\"opts\":[\"\",\"At FAC\",\"12 months post-FAC\",\"Split PAC/FAC\"],\"col\":1,\"section\":\"Milestone Payment Schedule\",\"section_icon\":\"\"},{\"id\":\"ld_perf_day\",\"field\":\"ld_perf_day\",\"lbl\":\"Performance LD ($/day)\",\"label\":\"Performance LD ($/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Liquidated Damages & Bonds\",\"section_icon\":\"\"},{\"id\":\"ld_delay_day\",\"field\":\"ld_delay_day\",\"lbl\":\"Delay LD ($/day)\",\"label\":\"Delay LD ($/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Liquidated Damages & Bonds\",\"section_icon\":\"\"},{\"id\":\"ld_perf_cap_pct\",\"field\":\"ld_perf_cap_pct\",\"lbl\":\"Performance LD Cap (%)\",\"label\":\"Performance LD Cap (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Liquidated Damages & Bonds\",\"section_icon\":\"\"},{\"id\":\"ld_delay_cap_pct\",\"field\":\"ld_delay_cap_pct\",\"lbl\":\"Delay LD Cap (%)\",\"label\":\"Delay LD Cap (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Liquidated Damages & Bonds\",\"section_icon\":\"\"},{\"id\":\"perf_bond_pct\",\"field\":\"perf_bond_pct\",\"lbl\":\"Performance Bond (%)\",\"label\":\"Performance Bond (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Liquidated Damages & Bonds\",\"section_icon\":\"\"},{\"id\":\"pay_bond_pct\",\"field\":\"pay_bond_pct\",\"lbl\":\"Payment Bond (%)\",\"label\":\"Payment Bond (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Liquidated Damages & Bonds\",\"section_icon\":\"\"},{\"id\":\"mod_supplier_name\",\"field\":\"mod_supplier_name\",\"lbl\":\"Module Supplier\",\"label\":\"Module Supplier\",\"type\":\"text\",\"opts\":[],\"col\":2,\"section\":\"Module Supply Agreement\",\"section_icon\":\"\"},{\"id\":\"mod_contract_value\",\"field\":\"mod_contract_value\",\"lbl\":\"Contract Value ($)\",\"label\":\"Contract Value ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Module Supply Agreement\",\"section_icon\":\"\"},{\"id\":\"mod_incoterms\",\"field\":\"mod_incoterms\",\"lbl\":\"Incoterms\",\"label\":\"Incoterms\",\"type\":\"select\",\"opts\":[\"\",\"DDP\",\"DAP\",\"FCA\",\"EXW\",\"CIF\",\"FOB\"],\"col\":1,\"section\":\"Module Supply Agreement\",\"section_icon\":\"\"},{\"id\":\"mod_price_validity\",\"field\":\"mod_price_validity\",\"lbl\":\"Price Validity Date\",\"label\":\"Price Validity Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"section\":\"Module Supply Agreement\",\"section_icon\":\"\"},{\"id\":\"mod_del_ld_day\",\"field\":\"mod_del_ld_day\",\"lbl\":\"Delivery LD ($/day)\",\"label\":\"Delivery LD ($/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Module Supply Agreement\",\"section_icon\":\"\"},{\"id\":\"mod_insolvency_guar\",\"field\":\"mod_insolvency_guar\",\"lbl\":\"Insolvency Guarantee\",\"label\":\"Insolvency Guarantee\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"Module Supply Agreement\",\"section_icon\":\"\"},{\"id\":\"mod_dom_content_cert\",\"field\":\"mod_dom_content_cert\",\"lbl\":\"Domestic Content Cert\",\"label\":\"Domestic Content Cert\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"Module Supply Agreement\",\"section_icon\":\"\"},{\"id\":\"inv_supplier_name\",\"field\":\"inv_supplier_name\",\"lbl\":\"Inverter Supplier\",\"label\":\"Inverter Supplier\",\"type\":\"text\",\"opts\":[],\"col\":1,\"section\":\"Major Equipment Agreements\",\"section_icon\":\"\"},{\"id\":\"inv_agr_date\",\"field\":\"inv_agr_date\",\"lbl\":\"Inverter Agreement Date\",\"label\":\"Inverter Agreement Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"section\":\"Major Equipment Agreements\",\"section_icon\":\"\"},{\"id\":\"tracker_supplier_name\",\"field\":\"tracker_supplier_name\",\"lbl\":\"Tracker Supplier\",\"label\":\"Tracker Supplier\",\"type\":\"text\",\"opts\":[],\"col\":1,\"section\":\"Major Equipment Agreements\",\"section_icon\":\"\"},{\"id\":\"tracker_agr_date\",\"field\":\"tracker_agr_date\",\"lbl\":\"Tracker Agreement Date\",\"label\":\"Tracker Agreement Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"section\":\"Major Equipment Agreements\",\"section_icon\":\"\"},{\"id\":\"bess_supplier_name\",\"field\":\"bess_supplier_name\",\"lbl\":\"BESS Supplier\",\"label\":\"BESS Supplier\",\"type\":\"text\",\"opts\":[],\"col\":1,\"section\":\"Major Equipment Agreements\",\"section_icon\":\"\"},{\"id\":\"bess_agr_date\",\"field\":\"bess_agr_date\",\"lbl\":\"BESS Agreement Date\",\"label\":\"BESS Agreement Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"section\":\"Major Equipment Agreements\",\"section_icon\":\"\"},{\"id\":\"xfmr_lead_wks\",\"field\":\"xfmr_lead_wks\",\"lbl\":\"Transformer Lead Time (wks)\",\"label\":\"Transformer Lead Time (wks)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Major Equipment Agreements\",\"section_icon\":\"\"},{\"id\":\"spare_parts_budget\",\"field\":\"spare_parts_budget\",\"lbl\":\"Spare Parts Budget ($)\",\"label\":\"Spare Parts Budget ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Major Equipment Agreements\",\"section_icon\":\"\"}],\"score_contract\":[{\"id\":\"offtaker_name\",\"field\":\"offtaker_name\",\"lbl\":\"Offtaker Name\",\"label\":\"Offtaker Name\",\"type\":\"text\",\"opts\":[],\"col\":2,\"section\":\"PPA / Offtake\",\"section_icon\":\"\"},{\"id\":\"offtaker_rating\",\"field\":\"offtaker_rating\",\"lbl\":\"Offtaker Credit Rating\",\"label\":\"Offtaker Credit Rating\",\"type\":\"select\",\"opts\":[\"\",\"AAA\",\"AA+\",\"AA\",\"AA-\",\"A+\",\"A\",\"A-\",\"BBB+\",\"BBB\",\"BBB-\",\"Below Investment Grade\",\"Not Rated\"],\"col\":1,\"section\":\"PPA / Offtake\",\"section_icon\":\"\"},{\"id\":\"ppa_term_yrs\",\"field\":\"ppa_term_yrs\",\"lbl\":\"PPA Term (years)\",\"label\":\"PPA Term (years)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"PPA / Offtake\",\"section_icon\":\"\"},{\"id\":\"ppa_price\",\"field\":\"ppa_price\",\"lbl\":\"Fixed Price ($/MWh)\",\"label\":\"Fixed Price ($/MWh)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"PPA / Offtake\",\"section_icon\":\"\"},{\"id\":\"ppa_escalator_pct\",\"field\":\"ppa_escalator_pct\",\"lbl\":\"Price Escalator (%/yr)\",\"label\":\"Price Escalator (%/yr)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"PPA / Offtake\",\"section_icon\":\"\"},{\"id\":\"ppa_start_date\",\"field\":\"ppa_start_date\",\"lbl\":\"PPA Start Date\",\"label\":\"PPA Start Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"section\":\"PPA / Offtake\",\"section_icon\":\"\"},{\"id\":\"merchant_tail_yrs\",\"field\":\"merchant_tail_yrs\",\"lbl\":\"Merchant Tail (years)\",\"label\":\"Merchant Tail (years)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"PPA / Offtake\",\"section_icon\":\"\"},{\"id\":\"curtail_comp\",\"field\":\"curtail_comp\",\"lbl\":\"Curtailment Compensation\",\"label\":\"Curtailment Compensation\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"PPA / Offtake\",\"section_icon\":\"\"},{\"id\":\"itc_ptc\",\"field\":\"itc_ptc\",\"lbl\":\"ITC or PTC Election\",\"label\":\"ITC or PTC Election\",\"type\":\"select\",\"opts\":[\"\",\"ITC (30%)\",\"PTC\",\"Not Determined\"],\"col\":1,\"section\":\"Tax & Incentives\",\"section_icon\":\"\"},{\"id\":\"itc_pct\",\"field\":\"itc_pct\",\"lbl\":\"ITC Percentage (%)\",\"label\":\"ITC Percentage (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Tax & Incentives\",\"section_icon\":\"\"},{\"id\":\"dom_content_bonus\",\"field\":\"dom_content_bonus\",\"lbl\":\"Domestic Content Bonus\",\"label\":\"Domestic Content Bonus\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"Tax & Incentives\",\"section_icon\":\"\"},{\"id\":\"energy_comm_bonus\",\"field\":\"energy_comm_bonus\",\"lbl\":\"Energy Community Bonus\",\"label\":\"Energy Community Bonus\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"Tax & Incentives\",\"section_icon\":\"\"},{\"id\":\"prev_wage\",\"field\":\"prev_wage\",\"lbl\":\"Prevailing Wage Compliance\",\"label\":\"Prevailing Wage Compliance\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"Tax & Incentives\",\"section_icon\":\"\"},{\"id\":\"state_incentives\",\"field\":\"state_incentives\",\"lbl\":\"State Incentives ($)\",\"label\":\"State Incentives ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Tax & Incentives\",\"section_icon\":\"\"},{\"id\":\"prop_tax_abate\",\"field\":\"prop_tax_abate\",\"lbl\":\"Property Tax Abatement\",\"label\":\"Property Tax Abatement\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"section\":\"Tax & Incentives\",\"section_icon\":\"\"},{\"id\":\"om_coverage_limit\",\"field\":\"om_coverage_limit\",\"lbl\":\"O&M Coverage Limit ($)\",\"label\":\"O&M Coverage Limit ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Insurance\",\"section_icon\":\"\"},{\"id\":\"bi_months\",\"field\":\"bi_months\",\"lbl\":\"Business Interruption (months)\",\"label\":\"Business Interruption (months)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Insurance\",\"section_icon\":\"\"}],\"score_intercon\":[{\"id\":\"queue_position\",\"field\":\"queue_position\",\"lbl\":\"Queue Position\",\"label\":\"Queue Position\",\"type\":\"text\",\"opts\":[],\"col\":1,\"section\":\"Interconnection\",\"section_icon\":\"\"},{\"id\":\"poi_substation\",\"field\":\"poi_substation\",\"lbl\":\"POI Substation Name\",\"label\":\"POI Substation Name\",\"type\":\"text\",\"opts\":[],\"col\":1,\"section\":\"Interconnection\",\"section_icon\":\"\"},{\"id\":\"intercon_kv\",\"field\":\"intercon_kv\",\"lbl\":\"Interconnection Voltage (kV)\",\"label\":\"Interconnection Voltage (kV)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Interconnection\",\"section_icon\":\"\"},{\"id\":\"network_upgrade_cost\",\"field\":\"network_upgrade_cost\",\"lbl\":\"Network Upgrade Cost ($)\",\"label\":\"Network Upgrade Cost ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Interconnection\",\"section_icon\":\"\"},{\"id\":\"upgrade_scope\",\"field\":\"upgrade_scope\",\"lbl\":\"Upgrade Scope Description\",\"label\":\"Upgrade Scope Description\",\"type\":\"text\",\"opts\":[],\"col\":2,\"section\":\"Interconnection\",\"section_icon\":\"\"},{\"id\":\"milestone_security\",\"field\":\"milestone_security\",\"lbl\":\"Milestone Security Posted ($)\",\"label\":\"Milestone Security Posted ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Interconnection\",\"section_icon\":\"\"},{\"id\":\"ia_exec_date\",\"field\":\"ia_exec_date\",\"lbl\":\"IA Execution Date\",\"label\":\"IA Execution Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"section\":\"Interconnection\",\"section_icon\":\"\"},{\"id\":\"upgrade_complete_date\",\"field\":\"upgrade_complete_date\",\"lbl\":\"Expected Upgrade Completion\",\"label\":\"Expected Upgrade Completion\",\"type\":\"date\",\"opts\":[],\"col\":1,\"section\":\"Interconnection\",\"section_icon\":\"\"},{\"id\":\"cap_accredit_pct\",\"field\":\"cap_accredit_pct\",\"lbl\":\"Capacity Accreditation (%)\",\"label\":\"Capacity Accreditation (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Market & Deliverability\",\"section_icon\":\"\"},{\"id\":\"elcc_method\",\"field\":\"elcc_method\",\"lbl\":\"ELCC Methodology\",\"label\":\"ELCC Methodology\",\"type\":\"text\",\"opts\":[],\"col\":1,\"section\":\"Market & Deliverability\",\"section_icon\":\"\"},{\"id\":\"congestion_score\",\"field\":\"congestion_score\",\"lbl\":\"Congestion Risk Score (1\\u201310)\",\"label\":\"Congestion Risk Score (1\\u201310)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Market & Deliverability\",\"section_icon\":\"\"},{\"id\":\"deliverability\",\"field\":\"deliverability\",\"lbl\":\"Deliverability Status\",\"label\":\"Deliverability Status\",\"type\":\"select\",\"opts\":[\"\",\"Full Capacity Deliverability\",\"Partial Capacity Deliverability\",\"Energy-Only\",\"Unknown\"],\"col\":1,\"section\":\"Market & Deliverability\",\"section_icon\":\"\"}],\"score_financial\":[{\"id\":\"total_capex\",\"field\":\"total_capex\",\"lbl\":\"Total Capex ($)\",\"label\":\"Total Capex ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Capital Stack\",\"section_icon\":\"\"},{\"id\":\"debt_amount\",\"field\":\"debt_amount\",\"lbl\":\"Debt Amount ($)\",\"label\":\"Debt Amount ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Capital Stack\",\"section_icon\":\"\"},{\"id\":\"debt_tenor_yrs\",\"field\":\"debt_tenor_yrs\",\"lbl\":\"Debt Tenor (years)\",\"label\":\"Debt Tenor (years)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Capital Stack\",\"section_icon\":\"\"},{\"id\":\"interest_rate_pct\",\"field\":\"interest_rate_pct\",\"lbl\":\"Interest Rate (%)\",\"label\":\"Interest Rate (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Capital Stack\",\"section_icon\":\"\"},{\"id\":\"sculpted_dscr\",\"field\":\"sculpted_dscr\",\"lbl\":\"Sculpted DSCR\",\"label\":\"Sculpted DSCR\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Capital Stack\",\"section_icon\":\"\"},{\"id\":\"min_dscr\",\"field\":\"min_dscr\",\"lbl\":\"Minimum DSCR\",\"label\":\"Minimum DSCR\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Capital Stack\",\"section_icon\":\"\"},{\"id\":\"tax_equity_amt\",\"field\":\"tax_equity_amt\",\"lbl\":\"Tax Equity Amount ($)\",\"label\":\"Tax Equity Amount ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Capital Stack\",\"section_icon\":\"\"},{\"id\":\"flip_year\",\"field\":\"flip_year\",\"lbl\":\"Target Flip Year\",\"label\":\"Target Flip Year\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Capital Stack\",\"section_icon\":\"\"},{\"id\":\"sponsor_equity\",\"field\":\"sponsor_equity\",\"lbl\":\"Sponsor Equity ($)\",\"label\":\"Sponsor Equity ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Capital Stack\",\"section_icon\":\"\"},{\"id\":\"levered_irr_pct\",\"field\":\"levered_irr_pct\",\"lbl\":\"Levered IRR (%)\",\"label\":\"Levered IRR (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Financial Metrics\",\"section_icon\":\"\"},{\"id\":\"unlevered_irr_pct\",\"field\":\"unlevered_irr_pct\",\"lbl\":\"Unlevered IRR (%)\",\"label\":\"Unlevered IRR (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Financial Metrics\",\"section_icon\":\"\"},{\"id\":\"npv\",\"field\":\"npv\",\"lbl\":\"NPV ($)\",\"label\":\"NPV ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Financial Metrics\",\"section_icon\":\"\"},{\"id\":\"lcoe\",\"field\":\"lcoe\",\"lbl\":\"LCOE ($/MWh)\",\"label\":\"LCOE ($/MWh)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Financial Metrics\",\"section_icon\":\"\"},{\"id\":\"breakeven_ppa\",\"field\":\"breakeven_ppa\",\"lbl\":\"Breakeven PPA Price ($/MWh)\",\"label\":\"Breakeven PPA Price ($/MWh)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Financial Metrics\",\"section_icon\":\"\"},{\"id\":\"p50_dscr\",\"field\":\"p50_dscr\",\"lbl\":\"P50 DSCR\",\"label\":\"P50 DSCR\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Financial Metrics\",\"section_icon\":\"\"},{\"id\":\"p90_dscr\",\"field\":\"p90_dscr\",\"lbl\":\"P90 DSCR\",\"label\":\"P90 DSCR\",\"type\":\"number\",\"opts\":[],\"col\":1,\"section\":\"Financial Metrics\",\"section_icon\":\"\"}]},\"reg_design_arrays\":[{\"key\":\"yield\",\"title\":\"Resource & Yield\",\"icon\":\"\",\"fields\":[{\"id\":\"irr_source\",\"field\":\"irr_source\",\"lbl\":\"Irradiance Data Source\",\"label\":\"Irradiance Data Source\",\"type\":\"select\",\"opts\":[\"\",\"NSRDB\",\"Meteonorm\",\"SolarAnywhere\",\"Solargis\",\"Other\"],\"col\":1,\"req\":false},{\"id\":\"ghi\",\"field\":\"ghi\",\"lbl\":\"GHI (kWh/m/yr)\",\"label\":\"GHI (kWh/m/yr)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"p50_mwh\",\"field\":\"p50_mwh\",\"lbl\":\"P50 Production (MWh/yr)\",\"label\":\"P50 Production (MWh/yr)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"p90_mwh\",\"field\":\"p90_mwh\",\"lbl\":\"P90 Production (MWh/yr)\",\"label\":\"P90 Production (MWh/yr)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"p99_mwh\",\"field\":\"p99_mwh\",\"lbl\":\"P99 Production (MWh/yr)\",\"label\":\"P99 Production (MWh/yr)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"net_cf_pct\",\"field\":\"net_cf_pct\",\"lbl\":\"Net Capacity Factor (%)\",\"label\":\"Net Capacity Factor (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"degradation_pct\",\"field\":\"degradation_pct\",\"lbl\":\"Annual Degradation (%/yr)\",\"label\":\"Annual Degradation (%/yr)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"availability_pct\",\"field\":\"availability_pct\",\"lbl\":\"Availability (%)\",\"label\":\"Availability (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"curtailment_pct\",\"field\":\"curtailment_pct\",\"lbl\":\"Curtailment (%)\",\"label\":\"Curtailment (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"dc_mw\",\"field\":\"dc_mw\",\"lbl\":\"DC Size (MWdc)\",\"label\":\"DC Size (MWdc)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ac_mw\",\"field\":\"ac_mw\",\"lbl\":\"AC Size (MWac)\",\"label\":\"AC Size (MWac)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ilr\",\"field\":\"ilr\",\"lbl\":\"DC:AC Ratio (ILR)\",\"label\":\"DC:AC Ratio (ILR)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"yield_software\",\"field\":\"yield_software\",\"lbl\":\"Yield Model Software\",\"label\":\"Yield Model Software\",\"type\":\"select\",\"opts\":[\"\",\"PVsyst\",\"SAM\",\"PVsol\",\"Homer\",\"Other\"],\"col\":1,\"req\":false},{\"id\":\"ie_review\",\"field\":\"ie_review\",\"lbl\":\"Independent Engineer Review\",\"label\":\"Independent Engineer Review\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false}]},{\"key\":\"civil\",\"title\":\"Civil & Structural\",\"icon\":\"\",\"fields\":[{\"id\":\"racking_type\",\"field\":\"racking_type\",\"lbl\":\"Racking System\",\"label\":\"Racking System\",\"type\":\"select\",\"opts\":[\"\",\"Single-Axis Tracker\",\"Fixed Tilt\",\"Dual-Axis\",\"Floating\"],\"col\":1,\"req\":false},{\"id\":\"pile_type\",\"field\":\"pile_type\",\"lbl\":\"Pile Type\",\"label\":\"Pile Type\",\"type\":\"select\",\"opts\":[\"\",\"Driven Steel\",\"Helical\",\"Ground Screw\",\"Ballasted\",\"Concrete Cast In-Situ\"],\"col\":1,\"req\":false},{\"id\":\"wind_speed_ms\",\"field\":\"wind_speed_ms\",\"lbl\":\"Max Wind Design (m/s)\",\"label\":\"Max Wind Design (m/s)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"snow_load_knm2\",\"field\":\"snow_load_knm2\",\"lbl\":\"Snow Load (kN/m)\",\"label\":\"Snow Load (kN/m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"gcr_pct\",\"field\":\"gcr_pct\",\"lbl\":\"Ground Coverage Ratio (%)\",\"label\":\"Ground Coverage Ratio (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"row_pitch_m\",\"field\":\"row_pitch_m\",\"lbl\":\"Row Pitch (m)\",\"label\":\"Row Pitch (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"tilt_deg\",\"field\":\"tilt_deg\",\"lbl\":\"Module Tilt Angle ()\",\"label\":\"Module Tilt Angle ()\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"clearance_mm\",\"field\":\"clearance_mm\",\"lbl\":\"Ground Clearance Min (mm)\",\"label\":\"Ground Clearance Min (mm)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"site_ha\",\"field\":\"site_ha\",\"lbl\":\"Total Site Area (ha)\",\"label\":\"Total Site Area (ha)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"grading_m3\",\"field\":\"grading_m3\",\"lbl\":\"Total Site Grading (m)\",\"label\":\"Total Site Grading (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"road_km\",\"field\":\"road_km\",\"lbl\":\"Access Road Length (km)\",\"label\":\"Access Road Length (km)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"fence_km\",\"field\":\"fence_km\",\"lbl\":\"Site Boundary Fencing (km)\",\"label\":\"Site Boundary Fencing (km)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"corrosion_cat\",\"field\":\"corrosion_cat\",\"lbl\":\"Corrosion Category\",\"label\":\"Corrosion Category\",\"type\":\"select\",\"opts\":[\"\",\"C1 (Very Low)\",\"C2 (Low)\",\"C3 (Medium)\",\"C4 (High)\",\"C5 (Very High)\"],\"col\":1,\"req\":false},{\"id\":\"civil_firm\",\"field\":\"civil_firm\",\"lbl\":\"Civil Design Firm\",\"label\":\"Civil Design Firm\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}]},{\"key\":\"geo\",\"title\":\"Geological Study\",\"icon\":\"\",\"fields\":[{\"id\":\"geo_firm\",\"field\":\"geo_firm\",\"lbl\":\"Geotechnical Firm\",\"label\":\"Geotechnical Firm\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false},{\"id\":\"geo_status\",\"field\":\"geo_status\",\"lbl\":\"Study Status\",\"label\":\"Study Status\",\"type\":\"select\",\"opts\":[\"\",\"Not Started\",\"In Progress\",\"Phase I Complete\",\"Phase II Complete\",\"Final Report Issued\"],\"col\":1,\"req\":false},{\"id\":\"soil_uscs\",\"field\":\"soil_uscs\",\"lbl\":\"Soil Classification (USCS)\",\"label\":\"Soil Classification (USCS)\",\"type\":\"select\",\"opts\":[\"\",\"GW (Well-graded gravel)\",\"GP (Poorly-graded gravel)\",\"GM (Silty gravel)\",\"GC (Clayey gravel)\",\"SW (Well-graded sand)\",\"SP (Poorly-graded sand)\",\"SM (Silty sand)\",\"SC (Clayey sand)\",\"ML (Silt low plasticity)\",\"CL (Lean clay)\",\"CH (Fat clay)\",\"MH (Elastic silt)\",\"OH (Organic clay)\",\"PT (Peat)\",\"Other\"],\"col\":1,\"req\":false},{\"id\":\"soil_aashto\",\"field\":\"soil_aashto\",\"lbl\":\"AASHTO Soil Classification\",\"label\":\"AASHTO Soil Classification\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"rock_class\",\"field\":\"rock_class\",\"lbl\":\"Rock Classification\",\"label\":\"Rock Classification\",\"type\":\"select\",\"opts\":[\"\",\"None / Soil Only\",\"Weathered Rock\",\"Soft Rock\",\"Medium Rock\",\"Hard Rock\",\"Very Hard Rock\"],\"col\":1,\"req\":false},{\"id\":\"rock_depth_m\",\"field\":\"rock_depth_m\",\"lbl\":\"Rock Depth (m)\",\"label\":\"Rock Depth (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"gw_depth_m\",\"field\":\"gw_depth_m\",\"lbl\":\"Groundwater Depth (m)\",\"label\":\"Groundwater Depth (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"spt_n\",\"field\":\"spt_n\",\"lbl\":\"SPT N-value (avg)\",\"label\":\"SPT N-value (avg)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"cu_kpa\",\"field\":\"cu_kpa\",\"lbl\":\"Undrained Shear Strength (kPa)\",\"label\":\"Undrained Shear Strength (kPa)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"bearing_kpa\",\"field\":\"bearing_kpa\",\"lbl\":\"Bearing Capacity (kN/m)\",\"label\":\"Bearing Capacity (kN/m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"liquefaction\",\"field\":\"liquefaction\",\"lbl\":\"Liquefaction Risk\",\"label\":\"Liquefaction Risk\",\"type\":\"select\",\"opts\":[\"\",\"None\",\"Low\",\"Moderate\",\"High\",\"Not Assessed\"],\"col\":1,\"req\":false},{\"id\":\"expansive_soils\",\"field\":\"expansive_soils\",\"lbl\":\"Expansive Soils\",\"label\":\"Expansive Soils\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"contaminated\",\"field\":\"contaminated\",\"lbl\":\"Contaminated Land\",\"label\":\"Contaminated Land\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pullout_test\",\"field\":\"pullout_test\",\"lbl\":\"Pull-out Test Conducted\",\"label\":\"Pull-out Test Conducted\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pullout_kn\",\"field\":\"pullout_kn\",\"lbl\":\"Pull-out Resistance (kN)\",\"label\":\"Pull-out Resistance (kN)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"embedment_m\",\"field\":\"embedment_m\",\"lbl\":\"Pile Embedment Depth (m)\",\"label\":\"Pile Embedment Depth (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pile_comp_kn\",\"field\":\"pile_comp_kn\",\"lbl\":\"Pile Design Load Compression (kN)\",\"label\":\"Pile Design Load Compression (kN)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pile_tens_kn\",\"field\":\"pile_tens_kn\",\"lbl\":\"Pile Design Load Tension (kN)\",\"label\":\"Pile Design Load Tension (kN)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pile_spacing_m\",\"field\":\"pile_spacing_m\",\"lbl\":\"Pile Spacing (m)\",\"label\":\"Pile Spacing (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"test_pile_report\",\"field\":\"test_pile_report\",\"lbl\":\"Test Pile Report\",\"label\":\"Test Pile Report\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"slope_stability\",\"field\":\"slope_stability\",\"lbl\":\"Slope Stability Analysis\",\"label\":\"Slope Stability Analysis\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"erosion_risk\",\"field\":\"erosion_risk\",\"lbl\":\"Erosion / Sedimentation Risk\",\"label\":\"Erosion / Sedimentation Risk\",\"type\":\"select\",\"opts\":[\"\",\"Low\",\"Moderate\",\"High\",\"Not Assessed\"],\"col\":1,\"req\":false},{\"id\":\"seismic_pga\",\"field\":\"seismic_pga\",\"lbl\":\"Seismic Zone / PGA (g)\",\"label\":\"Seismic Zone / PGA (g)\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"buried_corrosion\",\"field\":\"buried_corrosion\",\"lbl\":\"Corrosion of Buried Steel\",\"label\":\"Corrosion of Buried Steel\",\"type\":\"select\",\"opts\":[\"\",\"Low\",\"Moderate\",\"High  galv. required\",\"Not Assessed\"],\"col\":1,\"req\":false},{\"id\":\"geo_notes\",\"field\":\"geo_notes\",\"lbl\":\"Notes\",\"label\":\"Notes\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}]},{\"key\":\"elec\",\"title\":\"Electrical\",\"icon\":\"\",\"fields\":[{\"id\":\"strings_per_inv\",\"field\":\"strings_per_inv\",\"lbl\":\"Strings per Inverter\",\"label\":\"Strings per Inverter\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"mods_per_string\",\"field\":\"mods_per_string\",\"lbl\":\"Modules per String\",\"label\":\"Modules per String\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"collector_kv\",\"field\":\"collector_kv\",\"lbl\":\"Collector Voltage (kV)\",\"label\":\"Collector Voltage (kV)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"poi_kv\",\"field\":\"poi_kv\",\"lbl\":\"POI Voltage (kV)\",\"label\":\"POI Voltage (kV)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"dc_cable_km\",\"field\":\"dc_cable_km\",\"lbl\":\"DC Cable Total (km)\",\"label\":\"DC Cable Total (km)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ac_cable_km\",\"field\":\"ac_cable_km\",\"lbl\":\"AC Cable Total (km)\",\"label\":\"AC Cable Total (km)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"mv_cable_km\",\"field\":\"mv_cable_km\",\"lbl\":\"MV Cable (km)\",\"label\":\"MV Cable (km)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"combiner_boxes\",\"field\":\"combiner_boxes\",\"lbl\":\"Number of Combiner Boxes\",\"label\":\"Number of Combiner Boxes\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"scada_vendor\",\"field\":\"scada_vendor\",\"lbl\":\"SCADA Vendor\",\"label\":\"SCADA Vendor\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"reactive_power\",\"field\":\"reactive_power\",\"lbl\":\"Reactive Power Capability\",\"label\":\"Reactive Power Capability\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"protection_std\",\"field\":\"protection_std\",\"lbl\":\"Protection Relay Standard\",\"label\":\"Protection Relay Standard\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"anti_islanding\",\"field\":\"anti_islanding\",\"lbl\":\"Anti-Islanding Protection\",\"label\":\"Anti-Islanding Protection\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ifc_sld\",\"field\":\"ifc_sld\",\"lbl\":\"IFC SLD Issued\",\"label\":\"IFC SLD Issued\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"elec_firm\",\"field\":\"elec_firm\",\"lbl\":\"Electrical Design Firm\",\"label\":\"Electrical Design Firm\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}]},{\"key\":\"mech\",\"title\":\"Mechanical & BESS Integration\",\"icon\":\"\",\"fields\":[{\"id\":\"bess_included\",\"field\":\"bess_included\",\"lbl\":\"BESS Included in Array\",\"label\":\"BESS Included in Array\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"bess_mwh\",\"field\":\"bess_mwh\",\"lbl\":\"BESS Energy (MWh)\",\"label\":\"BESS Energy (MWh)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"bess_mw\",\"field\":\"bess_mw\",\"lbl\":\"BESS Power (MW)\",\"label\":\"BESS Power (MW)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"bess_dur_hr\",\"field\":\"bess_dur_hr\",\"lbl\":\"BESS Duration (hr)\",\"label\":\"BESS Duration (hr)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"bess_coupling\",\"field\":\"bess_coupling\",\"lbl\":\"BESS Coupling\",\"label\":\"BESS Coupling\",\"type\":\"select\",\"opts\":[\"\",\"AC-coupled\",\"DC-coupled\",\"Not applicable\"],\"col\":1,\"req\":false},{\"id\":\"shared_poi\",\"field\":\"shared_poi\",\"lbl\":\"Shared POI (Solar+BESS)\",\"label\":\"Shared POI (Solar+BESS)\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"fire_system\",\"field\":\"fire_system\",\"lbl\":\"Firefighting System\",\"label\":\"Firefighting System\",\"type\":\"select\",\"opts\":[\"\",\"Inert Gas\",\"FM200\",\"Water Mist\",\"Dry Chemical\",\"Sprinkler\",\"Not Required\"],\"col\":1,\"req\":false},{\"id\":\"security_system\",\"field\":\"security_system\",\"lbl\":\"Security System\",\"label\":\"Security System\",\"type\":\"select\",\"opts\":[\"\",\"CCTV + Motion\",\"Perimeter Fence Sensor\",\"Thermal\",\"CCTV Only\",\"None\"],\"col\":1,\"req\":false},{\"id\":\"met_station\",\"field\":\"met_station\",\"lbl\":\"Met Station\",\"label\":\"Met Station\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"om_building\",\"field\":\"om_building\",\"lbl\":\"O&M Building\",\"label\":\"O&M Building\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"mech_firm\",\"field\":\"mech_firm\",\"lbl\":\"Mechanical Design Firm\",\"label\":\"Mechanical Design Firm\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}]}],\"reg_crews\":[{\"key\":\"civil\",\"fields\":[{\"id\":\"nickname\",\"field\":\"nickname\",\"lbl\":\"Crew Name / ID\",\"label\":\"Crew Name / ID\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false},{\"id\":\"subcontractor\",\"field\":\"subcontractor\",\"lbl\":\"Subcontractor\",\"label\":\"Subcontractor\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false},{\"id\":\"crew_size\",\"field\":\"crew_size\",\"lbl\":\"Crew Size (workers)\",\"label\":\"Crew Size (workers)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"supervisors\",\"field\":\"supervisors\",\"lbl\":\"Supervisors\",\"label\":\"Supervisors\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"shift\",\"field\":\"shift\",\"lbl\":\"Shift Pattern\",\"label\":\"Shift Pattern\",\"type\":\"select\",\"opts\":[\"\",\"Single Shift\",\"Double Shift\",\"24/7\"],\"col\":1,\"req\":false},{\"id\":\"start_date\",\"field\":\"start_date\",\"lbl\":\"Start Date\",\"label\":\"Start Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"end_date\",\"field\":\"end_date\",\"lbl\":\"End Date\",\"label\":\"End Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"scope\",\"field\":\"scope\",\"lbl\":\"Scope\",\"label\":\"Scope\",\"type\":\"select\",\"opts\":[\"\",\"Earthworks\",\"Pile Driving\",\"Roads & Fencing\",\"All Civil\"],\"col\":1,\"req\":false},{\"id\":\"pile_rate\",\"field\":\"pile_rate\",\"lbl\":\"Pile Drive Rate (piles/day)\",\"label\":\"Pile Drive Rate (piles/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"grade_rate\",\"field\":\"grade_rate\",\"lbl\":\"Grading Rate (m/day)\",\"label\":\"Grading Rate (m/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"hse_officer\",\"field\":\"hse_officer\",\"lbl\":\"HSE Officer on Site\",\"label\":\"HSE Officer on Site\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false}],\"milestones\":[\"Mobilisation\",\"Site Clearance\",\"Grading Complete\",\"Pile Driving Start\",\"Pile Driving 50%\",\"Pile Driving Complete\",\"Roads Complete\",\"Fencing Complete\",\"Demobilisation\"]},{\"key\":\"install\",\"fields\":[{\"id\":\"nickname\",\"field\":\"nickname\",\"lbl\":\"Crew Name / ID\",\"label\":\"Crew Name / ID\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false},{\"id\":\"subcontractor\",\"field\":\"subcontractor\",\"lbl\":\"Subcontractor\",\"label\":\"Subcontractor\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false},{\"id\":\"crew_size\",\"field\":\"crew_size\",\"lbl\":\"Crew Size (workers)\",\"label\":\"Crew Size (workers)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"supervisors\",\"field\":\"supervisors\",\"lbl\":\"Supervisors\",\"label\":\"Supervisors\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"shift\",\"field\":\"shift\",\"lbl\":\"Shift Pattern\",\"label\":\"Shift Pattern\",\"type\":\"select\",\"opts\":[\"\",\"Single Shift\",\"Double Shift\"],\"col\":1,\"req\":false},{\"id\":\"start_date\",\"field\":\"start_date\",\"lbl\":\"Start Date\",\"label\":\"Start Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"end_date\",\"field\":\"end_date\",\"lbl\":\"End Date\",\"label\":\"End Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"mod_rate\",\"field\":\"mod_rate\",\"lbl\":\"Modules per Crew per Day\",\"label\":\"Modules per Crew per Day\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"peak_daily\",\"field\":\"peak_daily\",\"lbl\":\"Peak Daily Output (mod/day)\",\"label\":\"Peak Daily Output (mod/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"string_rate\",\"field\":\"string_rate\",\"lbl\":\"String Testing Rate (str/day)\",\"label\":\"String Testing Rate (str/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"hse_officer\",\"field\":\"hse_officer\",\"lbl\":\"HSE Officer on Site\",\"label\":\"HSE Officer on Site\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false}],\"milestones\":[\"Mobilisation\",\"Rack Assembly Start\",\"First Modules Racked\",\"25% Complete\",\"50% Complete\",\"75% Complete\",\"Last Module Racked\",\"String Testing Complete\",\"Final Inspection\"]},{\"key\":\"electrical\",\"fields\":[{\"id\":\"nickname\",\"field\":\"nickname\",\"lbl\":\"Crew Name / ID\",\"label\":\"Crew Name / ID\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false},{\"id\":\"subcontractor\",\"field\":\"subcontractor\",\"lbl\":\"Subcontractor\",\"label\":\"Subcontractor\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false},{\"id\":\"crew_size\",\"field\":\"crew_size\",\"lbl\":\"Crew Size (workers)\",\"label\":\"Crew Size (workers)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"electricians\",\"field\":\"electricians\",\"lbl\":\"Electricians (licensed)\",\"label\":\"Electricians (licensed)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"shift\",\"field\":\"shift\",\"lbl\":\"Shift Pattern\",\"label\":\"Shift Pattern\",\"type\":\"select\",\"opts\":[\"\",\"Single Shift\",\"Double Shift\"],\"col\":1,\"req\":false},{\"id\":\"start_date\",\"field\":\"start_date\",\"lbl\":\"Start Date\",\"label\":\"Start Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"end_date\",\"field\":\"end_date\",\"lbl\":\"End Date\",\"label\":\"End Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"dc_rate\",\"field\":\"dc_rate\",\"lbl\":\"DC Trench Rate (m/day)\",\"label\":\"DC Trench Rate (m/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ac_rate\",\"field\":\"ac_rate\",\"lbl\":\"AC Trench Rate (m/day)\",\"label\":\"AC Trench Rate (m/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"mv_rate\",\"field\":\"mv_rate\",\"lbl\":\"MV Cable Pull Rate (m/day)\",\"label\":\"MV Cable Pull Rate (m/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"hse_officer\",\"field\":\"hse_officer\",\"lbl\":\"HSE Officer on Site\",\"label\":\"HSE Officer on Site\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false}],\"milestones\":[\"Mobilisation\",\"DC Cable Trench Start\",\"DC Cable Pull Complete\",\"AC Cable Trench Start\",\"AC Cable Pull Complete\",\"MV Cable Complete\",\"Inverter Terminations\",\"Transformer Connections\",\"SCADA Wiring\",\"Energisation Test\",\"PAC\"]}],\"reg_procurement_contracts\":[{\"key\":\"common\",\"fields\":[{\"id\":\"title\",\"field\":\"title\",\"lbl\":\"Contract / Agreement Title\",\"label\":\"Contract / Agreement Title\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false},{\"id\":\"contract_type\",\"field\":\"contract_type\",\"lbl\":\"Contract Type\",\"label\":\"Contract Type\",\"type\":\"select\",\"opts\":[\"\",\"Lump-sum Turnkey\",\"EPC\",\"Supply Agreement\",\"Service Agreement\",\"Framework\",\"Letter of Intent\",\"MOU\"],\"col\":1,\"req\":false},{\"id\":\"value_usd\",\"field\":\"value_usd\",\"lbl\":\"Contract Value ($)\",\"label\":\"Contract Value ($)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"currency\",\"field\":\"currency\",\"lbl\":\"Currency\",\"label\":\"Currency\",\"type\":\"select\",\"opts\":[\"\",\"USD\",\"EUR\",\"GBP\",\"AUD\",\"CAD\",\"Other\"],\"col\":1,\"req\":false},{\"id\":\"exec_date\",\"field\":\"exec_date\",\"lbl\":\"Contract Execution Date\",\"label\":\"Contract Execution Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"governing_law\",\"field\":\"governing_law\",\"lbl\":\"Governing Law\",\"label\":\"Governing Law\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"incoterms\",\"field\":\"incoterms\",\"lbl\":\"Incoterms\",\"label\":\"Incoterms\",\"type\":\"select\",\"opts\":[\"\",\"DDP\",\"DAP\",\"FCA\",\"EXW\",\"CIF\",\"FOB\",\"CPT\",\"Not Applicable\"],\"col\":1,\"req\":false},{\"id\":\"parent_guar\",\"field\":\"parent_guar\",\"lbl\":\"Parent Guarantee\",\"label\":\"Parent Guarantee\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"perf_bond_pct\",\"field\":\"perf_bond_pct\",\"lbl\":\"Performance Bond (%)\",\"label\":\"Performance Bond (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pay_bond_pct\",\"field\":\"pay_bond_pct\",\"lbl\":\"Payment Bond (%)\",\"label\":\"Payment Bond (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false}]},{\"key\":\"payments\",\"fields\":[{\"id\":\"pmt1_desc\",\"field\":\"pmt1_desc\",\"lbl\":\"Milestone 1  Description\",\"label\":\"Milestone 1  Description\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pmt1_pct\",\"field\":\"pmt1_pct\",\"lbl\":\"Milestone 1  % of Value\",\"label\":\"Milestone 1  % of Value\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pmt2_desc\",\"field\":\"pmt2_desc\",\"lbl\":\"Milestone 2  Description\",\"label\":\"Milestone 2  Description\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pmt2_pct\",\"field\":\"pmt2_pct\",\"lbl\":\"Milestone 2  % of Value\",\"label\":\"Milestone 2  % of Value\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pmt3_desc\",\"field\":\"pmt3_desc\",\"lbl\":\"Milestone 3  Description\",\"label\":\"Milestone 3  Description\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pmt3_pct\",\"field\":\"pmt3_pct\",\"lbl\":\"Milestone 3  % of Value\",\"label\":\"Milestone 3  % of Value\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pmt4_desc\",\"field\":\"pmt4_desc\",\"lbl\":\"Milestone 4  Description\",\"label\":\"Milestone 4  Description\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pmt4_pct\",\"field\":\"pmt4_pct\",\"lbl\":\"Milestone 4  % of Value\",\"label\":\"Milestone 4  % of Value\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pmt5_desc\",\"field\":\"pmt5_desc\",\"lbl\":\"Milestone 5  Description\",\"label\":\"Milestone 5  Description\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pmt5_pct\",\"field\":\"pmt5_pct\",\"lbl\":\"Milestone 5  % of Value\",\"label\":\"Milestone 5  % of Value\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"retention_pct\",\"field\":\"retention_pct\",\"lbl\":\"Retention (%)\",\"label\":\"Retention (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"retention_trig\",\"field\":\"retention_trig\",\"lbl\":\"Retention Release Trigger\",\"label\":\"Retention Release Trigger\",\"type\":\"select\",\"opts\":[\"\",\"At PAC\",\"At FAC\",\"12 months post-FAC\",\"Split PAC/FAC\"],\"col\":1,\"req\":false}]},{\"key\":\"ld_delivery\",\"fields\":[{\"id\":\"delivery_date\",\"field\":\"delivery_date\",\"lbl\":\"Delivery / Completion Date\",\"label\":\"Delivery / Completion Date\",\"type\":\"date\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"lead_wks\",\"field\":\"lead_wks\",\"lbl\":\"Lead Time (weeks)\",\"label\":\"Lead Time (weeks)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ld_delay_day\",\"field\":\"ld_delay_day\",\"lbl\":\"Delay LD ($/day)\",\"label\":\"Delay LD ($/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ld_delay_cap\",\"field\":\"ld_delay_cap\",\"lbl\":\"Delay LD Cap (%)\",\"label\":\"Delay LD Cap (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ld_perf_day\",\"field\":\"ld_perf_day\",\"lbl\":\"Performance LD ($/day)\",\"label\":\"Performance LD ($/day)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ld_perf_cap\",\"field\":\"ld_perf_cap\",\"lbl\":\"Performance LD Cap (%)\",\"label\":\"Performance LD Cap (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"warranty_mo\",\"field\":\"warranty_mo\",\"lbl\":\"Warranty Period (months)\",\"label\":\"Warranty Period (months)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"dlp_mo\",\"field\":\"dlp_mo\",\"lbl\":\"Defects Liability Period (mo)\",\"label\":\"Defects Liability Period (mo)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false}]},{\"key\":\"module_supplier_extra\",\"fields\":[{\"id\":\"dom_content_cert\",\"field\":\"dom_content_cert\",\"lbl\":\"Domestic Content Certification\",\"label\":\"Domestic Content Certification\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ira_adder\",\"field\":\"ira_adder\",\"lbl\":\"IRA Adder Eligible\",\"label\":\"IRA Adder Eligible\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"degrad_guar\",\"field\":\"degrad_guar\",\"lbl\":\"Annual Degradation Guarantee (%)\",\"label\":\"Annual Degradation Guarantee (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"insolvency_guar\",\"field\":\"insolvency_guar\",\"lbl\":\"Insolvency / Repurchase Guarantee\",\"label\":\"Insolvency / Repurchase Guarantee\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false}]},{\"key\":\"inverter_supplier_extra\",\"fields\":[{\"id\":\"ext_warranty\",\"field\":\"ext_warranty\",\"lbl\":\"Extended Warranty Option\",\"label\":\"Extended Warranty Option\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"remote_mon\",\"field\":\"remote_mon\",\"lbl\":\"Remote Monitoring Included\",\"label\":\"Remote Monitoring Included\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false}]},{\"key\":\"tracker_supplier_extra\",\"fields\":[{\"id\":\"terrain_follow\",\"field\":\"terrain_follow\",\"lbl\":\"Terrain Following Algorithm\",\"label\":\"Terrain Following Algorithm\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"install_assist\",\"field\":\"install_assist\",\"lbl\":\"Installation Assistance\",\"label\":\"Installation Assistance\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false}]},{\"key\":\"bess_supplier_extra\",\"fields\":[{\"id\":\"cap_guar_pct\",\"field\":\"cap_guar_pct\",\"lbl\":\"Capacity Guarantee (%)\",\"label\":\"Capacity Guarantee (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"rte_guar\",\"field\":\"rte_guar\",\"lbl\":\"Round-trip Efficiency Guarantee (%)\",\"label\":\"Round-trip Efficiency Guarantee (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"aug_commit\",\"field\":\"aug_commit\",\"lbl\":\"Augmentation Commitment\",\"label\":\"Augmentation Commitment\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"service_10yr\",\"field\":\"service_10yr\",\"lbl\":\"10-Year Service Agreement\",\"label\":\"10-Year Service Agreement\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false}]},{\"key\":\"epc_extra\",\"fields\":[{\"id\":\"epc_scope\",\"field\":\"epc_scope\",\"lbl\":\"EPC Scope\",\"label\":\"EPC Scope\",\"type\":\"select\",\"opts\":[\"\",\"Full EPC\",\"Civil Only\",\"Electrical Only\",\"Split EPC\"],\"col\":1,\"req\":false},{\"id\":\"prev_wage\",\"field\":\"prev_wage\",\"lbl\":\"Prevailing Wage Compliance\",\"label\":\"Prevailing Wage Compliance\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"dom_content\",\"field\":\"dom_content\",\"lbl\":\"Domestic Content Compliance\",\"label\":\"Domestic Content Compliance\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false}]},{\"key\":\"design_firm_extra\",\"fields\":[{\"id\":\"design_stage\",\"field\":\"design_stage\",\"lbl\":\"Design Stage\",\"label\":\"Design Stage\",\"type\":\"select\",\"opts\":[\"\",\"Concept\",\"30%\",\"60%\",\"90%\",\"IFC\",\"As-Built\"],\"col\":1,\"req\":false},{\"id\":\"stamped\",\"field\":\"stamped\",\"lbl\":\"Stamped Drawings\",\"label\":\"Stamped Drawings\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false}]}],\"reg_components\":[{\"key\":\"module\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Manufacturer\",\"label\":\"Manufacturer\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Model / Part Number\",\"label\":\"Model / Part Number\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"tech\",\"field\":\"tech\",\"lbl\":\"Technology\",\"label\":\"Technology\",\"type\":\"select\",\"opts\":[\"\",\"Mono PERC\",\"TOPCon\",\"HJT\",\"CIGS\",\"CdTe\",\"Bifacial TOPCon\",\"Other\"],\"col\":1,\"req\":false},{\"id\":\"watt\",\"field\":\"watt\",\"lbl\":\"Nominal Power (W)\",\"label\":\"Nominal Power (W)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"eff_pct\",\"field\":\"eff_pct\",\"lbl\":\"Module Efficiency (%)\",\"label\":\"Module Efficiency (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"bifac_pct\",\"field\":\"bifac_pct\",\"lbl\":\"Bifaciality Factor (%)\",\"label\":\"Bifaciality Factor (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"voc\",\"field\":\"voc\",\"lbl\":\"Voc (V)\",\"label\":\"Voc (V)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"vmp\",\"field\":\"vmp\",\"lbl\":\"Vmp (V)\",\"label\":\"Vmp (V)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"isc\",\"field\":\"isc\",\"lbl\":\"Isc (A)\",\"label\":\"Isc (A)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"imp\",\"field\":\"imp\",\"lbl\":\"Imp (A)\",\"label\":\"Imp (A)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"tempco\",\"field\":\"tempco\",\"lbl\":\"Temp Coeff Pmax (%/C)\",\"label\":\"Temp Coeff Pmax (%/C)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"noct\",\"field\":\"noct\",\"lbl\":\"NOCT (C)\",\"label\":\"NOCT (C)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"length_mm\",\"field\":\"length_mm\",\"lbl\":\"Length (mm)\",\"label\":\"Length (mm)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"width_mm\",\"field\":\"width_mm\",\"lbl\":\"Width (mm)\",\"label\":\"Width (mm)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"weight_kg\",\"field\":\"weight_kg\",\"lbl\":\"Weight (kg)\",\"label\":\"Weight (kg)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"cells_s\",\"field\":\"cells_s\",\"lbl\":\"Cells in Series\",\"label\":\"Cells in Series\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"cells_p\",\"field\":\"cells_p\",\"lbl\":\"Cells in Parallel\",\"label\":\"Cells in Parallel\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"frames_pallet\",\"field\":\"frames_pallet\",\"lbl\":\"Frames per Pallet\",\"label\":\"Frames per Pallet\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"country\",\"field\":\"country\",\"lbl\":\"Country of Manufacture\",\"label\":\"Country of Manufacture\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"prod_warranty\",\"field\":\"prod_warranty\",\"lbl\":\"Product Warranty (yrs)\",\"label\":\"Product Warranty (yrs)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"degrad_yr1\",\"field\":\"degrad_yr1\",\"lbl\":\"Linear Degradation (%)\",\"label\":\"Linear Degradation (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"degrad_ann\",\"field\":\"degrad_ann\",\"lbl\":\"Annual Degradation (%)\",\"label\":\"Annual Degradation (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"iec_cert\",\"field\":\"iec_cert\",\"lbl\":\"IEC Certifications\",\"label\":\"IEC Certifications\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false},{\"id\":\"dom_content\",\"field\":\"dom_content\",\"lbl\":\"Domestic Content Eligible\",\"label\":\"Domestic Content Eligible\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"datasheet_url\",\"field\":\"datasheet_url\",\"lbl\":\"Datasheet URL\",\"label\":\"Datasheet URL\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}]},{\"key\":\"inverter\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Manufacturer\",\"label\":\"Manufacturer\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Model / Part Number\",\"label\":\"Model / Part Number\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"type\",\"field\":\"type\",\"lbl\":\"Type\",\"label\":\"Type\",\"type\":\"select\",\"opts\":[\"\",\"Central\",\"String\",\"Micro\",\"Hybrid\"],\"col\":1,\"req\":false},{\"id\":\"kw_ac\",\"field\":\"kw_ac\",\"lbl\":\"AC Power Rating (kW)\",\"label\":\"AC Power Rating (kW)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"kw_dc_max\",\"field\":\"kw_dc_max\",\"lbl\":\"DC Max Input (kW)\",\"label\":\"DC Max Input (kW)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"vdc_max\",\"field\":\"vdc_max\",\"lbl\":\"Max DC Voltage (V)\",\"label\":\"Max DC Voltage (V)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"mppt_low\",\"field\":\"mppt_low\",\"lbl\":\"MPPT Range Low (V)\",\"label\":\"MPPT Range Low (V)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"mppt_high\",\"field\":\"mppt_high\",\"lbl\":\"MPPT Range High (V)\",\"label\":\"MPPT Range High (V)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"n_mppt\",\"field\":\"n_mppt\",\"lbl\":\"Number of MPPTs\",\"label\":\"Number of MPPTs\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"idc_max\",\"field\":\"idc_max\",\"lbl\":\"Max Input Current (A)\",\"label\":\"Max Input Current (A)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"vac\",\"field\":\"vac\",\"lbl\":\"AC Voltage (V)\",\"label\":\"AC Voltage (V)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"freq_hz\",\"field\":\"freq_hz\",\"lbl\":\"Frequency (Hz)\",\"label\":\"Frequency (Hz)\",\"type\":\"select\",\"opts\":[\"\",\"50\",\"60\"],\"col\":1,\"req\":false},{\"id\":\"eff_peak\",\"field\":\"eff_peak\",\"lbl\":\"Peak Efficiency (%)\",\"label\":\"Peak Efficiency (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"eff_cec\",\"field\":\"eff_cec\",\"lbl\":\"CEC Efficiency (%)\",\"label\":\"CEC Efficiency (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"thd_pct\",\"field\":\"thd_pct\",\"lbl\":\"THD (%)\",\"label\":\"THD (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pf_range\",\"field\":\"pf_range\",\"lbl\":\"Power Factor Range\",\"label\":\"Power Factor Range\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"night_power\",\"field\":\"night_power\",\"lbl\":\"Night Power (W)\",\"label\":\"Night Power (W)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"weight_kg\",\"field\":\"weight_kg\",\"lbl\":\"Weight (kg)\",\"label\":\"Weight (kg)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ip_rating\",\"field\":\"ip_rating\",\"lbl\":\"IP Rating\",\"label\":\"IP Rating\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"temp_range\",\"field\":\"temp_range\",\"lbl\":\"Operating Temp (C)\",\"label\":\"Operating Temp (C)\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"warranty_yrs\",\"field\":\"warranty_yrs\",\"lbl\":\"Warranty (years)\",\"label\":\"Warranty (years)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"datasheet_url\",\"field\":\"datasheet_url\",\"lbl\":\"Datasheet URL\",\"label\":\"Datasheet URL\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}]},{\"key\":\"racking\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Manufacturer\",\"label\":\"Manufacturer\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"System Name / Model\",\"label\":\"System Name / Model\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"type\",\"field\":\"type\",\"lbl\":\"Type\",\"label\":\"Type\",\"type\":\"select\",\"opts\":[\"\",\"Fixed Tilt\",\"Single-Axis Tracker\",\"Dual-Axis Tracker\",\"Ballasted\",\"Floating\"],\"col\":1,\"req\":false},{\"id\":\"tilt_deg\",\"field\":\"tilt_deg\",\"lbl\":\"Tilt Angle ()\",\"label\":\"Tilt Angle ()\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"max_rows\",\"field\":\"max_rows\",\"lbl\":\"Max Module Rows\",\"label\":\"Max Module Rows\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"wind_ms\",\"field\":\"wind_ms\",\"lbl\":\"Max Wind Speed (m/s)\",\"label\":\"Max Wind Speed (m/s)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"snow_load\",\"field\":\"snow_load\",\"lbl\":\"Snow Load (kN/m)\",\"label\":\"Snow Load (kN/m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"clearance_mm\",\"field\":\"clearance_mm\",\"lbl\":\"Ground Clearance (mm)\",\"label\":\"Ground Clearance (mm)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"material\",\"field\":\"material\",\"lbl\":\"Material\",\"label\":\"Material\",\"type\":\"select\",\"opts\":[\"\",\"Hot-dip Galvanised Steel\",\"Aluminium\",\"Stainless Steel\",\"Composite\"],\"col\":1,\"req\":false},{\"id\":\"corr_cat\",\"field\":\"corr_cat\",\"lbl\":\"Corrosion Category\",\"label\":\"Corrosion Category\",\"type\":\"select\",\"opts\":[\"\",\"C1\",\"C2\",\"C3\",\"C4\",\"C5\"],\"col\":1,\"req\":false},{\"id\":\"design_life\",\"field\":\"design_life\",\"lbl\":\"Design Lifetime (yrs)\",\"label\":\"Design Lifetime (yrs)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"warranty_yrs\",\"field\":\"warranty_yrs\",\"lbl\":\"Warranty (years)\",\"label\":\"Warranty (years)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"mod_per_table\",\"field\":\"mod_per_table\",\"lbl\":\"Modules per Table\",\"label\":\"Modules per Table\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"wt_per_table\",\"field\":\"wt_per_table\",\"lbl\":\"Weight per Table (kg)\",\"label\":\"Weight per Table (kg)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"certifications\",\"field\":\"certifications\",\"lbl\":\"Certifications\",\"label\":\"Certifications\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false},{\"id\":\"datasheet_url\",\"field\":\"datasheet_url\",\"lbl\":\"Datasheet URL\",\"label\":\"Datasheet URL\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}]},{\"key\":\"tracker\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Manufacturer\",\"label\":\"Manufacturer\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Model\",\"label\":\"Model\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"type\",\"field\":\"type\",\"lbl\":\"Type\",\"label\":\"Type\",\"type\":\"select\",\"opts\":[\"\",\"Single-Axis\",\"Dual-Axis\",\"Seasonal Tilt\"],\"col\":1,\"req\":false},{\"id\":\"drive\",\"field\":\"drive\",\"lbl\":\"Drive Type\",\"label\":\"Drive Type\",\"type\":\"select\",\"opts\":[\"\",\"Slew Drive\",\"Linear Actuator\",\"Distributed Drive\",\"Centralized Drive\"],\"col\":1,\"req\":false},{\"id\":\"max_angle\",\"field\":\"max_angle\",\"lbl\":\"Max Tracking Angle ()\",\"label\":\"Max Tracking Angle ()\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"backtracking\",\"field\":\"backtracking\",\"lbl\":\"Backtracking Algorithm\",\"label\":\"Backtracking Algorithm\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"terrain_follow\",\"field\":\"terrain_follow\",\"lbl\":\"Terrain Following\",\"label\":\"Terrain Following\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"wind_ms\",\"field\":\"wind_ms\",\"lbl\":\"Max Wind Speed (m/s)\",\"label\":\"Max Wind Speed (m/s)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"snow_load\",\"field\":\"snow_load\",\"lbl\":\"Snow Load (kN/m)\",\"label\":\"Snow Load (kN/m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"mod_per_tracker\",\"field\":\"mod_per_tracker\",\"lbl\":\"Modules per Tracker\",\"label\":\"Modules per Tracker\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"pile_type\",\"field\":\"pile_type\",\"lbl\":\"Pile Type\",\"label\":\"Pile Type\",\"type\":\"select\",\"opts\":[\"\",\"Driven\",\"Helical\",\"Ground Screw\",\"Concrete\"],\"col\":1,\"req\":false},{\"id\":\"motor_w\",\"field\":\"motor_w\",\"lbl\":\"Motor Power (W)\",\"label\":\"Motor Power (W)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"comm_protocol\",\"field\":\"comm_protocol\",\"lbl\":\"Communication Protocol\",\"label\":\"Communication Protocol\",\"type\":\"select\",\"opts\":[\"\",\"RS-485\",\"Modbus\",\"CAN\",\"Ethernet\",\"Wireless\"],\"col\":1,\"req\":false},{\"id\":\"warranty_yrs\",\"field\":\"warranty_yrs\",\"lbl\":\"Warranty (years)\",\"label\":\"Warranty (years)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"datasheet_url\",\"field\":\"datasheet_url\",\"lbl\":\"Datasheet URL\",\"label\":\"Datasheet URL\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}]},{\"key\":\"transformer\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Manufacturer\",\"label\":\"Manufacturer\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Model / Tag\",\"label\":\"Model / Tag\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"type\",\"field\":\"type\",\"lbl\":\"Type\",\"label\":\"Type\",\"type\":\"select\",\"opts\":[\"\",\"Oil-immersed\",\"Dry-type\",\"Cast Resin\",\"Pad-mounted\"],\"col\":1,\"req\":false},{\"id\":\"kva\",\"field\":\"kva\",\"lbl\":\"Rating (kVA)\",\"label\":\"Rating (kVA)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"hv_kv\",\"field\":\"hv_kv\",\"lbl\":\"Primary Voltage (kV)\",\"label\":\"Primary Voltage (kV)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"lv_v\",\"field\":\"lv_v\",\"lbl\":\"Secondary Voltage (V)\",\"label\":\"Secondary Voltage (V)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"vector_group\",\"field\":\"vector_group\",\"lbl\":\"Vector Group\",\"label\":\"Vector Group\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"cooling\",\"field\":\"cooling\",\"lbl\":\"Cooling Type\",\"label\":\"Cooling Type\",\"type\":\"select\",\"opts\":[\"\",\"ONAN\",\"ONAF\",\"OFAF\",\"AN\",\"AF\"],\"col\":1,\"req\":false},{\"id\":\"impedance_pct\",\"field\":\"impedance_pct\",\"lbl\":\"Impedance (%)\",\"label\":\"Impedance (%)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"no_load_loss\",\"field\":\"no_load_loss\",\"lbl\":\"No-Load Losses (W)\",\"label\":\"No-Load Losses (W)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"load_loss\",\"field\":\"load_loss\",\"lbl\":\"Load Losses (W)\",\"label\":\"Load Losses (W)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ip_rating\",\"field\":\"ip_rating\",\"lbl\":\"IP Rating\",\"label\":\"IP Rating\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"wt_oil\",\"field\":\"wt_oil\",\"lbl\":\"Weight Oil (kg)\",\"label\":\"Weight Oil (kg)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"wt_total\",\"field\":\"wt_total\",\"lbl\":\"Weight Total (kg)\",\"label\":\"Weight Total (kg)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"insul_class\",\"field\":\"insul_class\",\"lbl\":\"Insulation Class\",\"label\":\"Insulation Class\",\"type\":\"select\",\"opts\":[\"\",\"A\",\"B\",\"F\",\"H\"],\"col\":1,\"req\":false},{\"id\":\"standards\",\"field\":\"standards\",\"lbl\":\"Standards\",\"label\":\"Standards\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false},{\"id\":\"datasheet_url\",\"field\":\"datasheet_url\",\"lbl\":\"Datasheet URL\",\"label\":\"Datasheet URL\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}]},{\"key\":\"dc_cable\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Manufacturer\",\"label\":\"Manufacturer\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Product Name\",\"label\":\"Product Name\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"size_mm2\",\"field\":\"size_mm2\",\"lbl\":\"Conductor Size (mm)\",\"label\":\"Conductor Size (mm)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"rated_v\",\"field\":\"rated_v\",\"lbl\":\"Rated Voltage (V)\",\"label\":\"Rated Voltage (V)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"conductor\",\"field\":\"conductor\",\"lbl\":\"Conductor Material\",\"label\":\"Conductor Material\",\"type\":\"select\",\"opts\":[\"\",\"Copper\",\"Tinned Copper\",\"Aluminium\"],\"col\":1,\"req\":false},{\"id\":\"insulation\",\"field\":\"insulation\",\"lbl\":\"Insulation Type\",\"label\":\"Insulation Type\",\"type\":\"select\",\"opts\":[\"\",\"XLPE\",\"EPR\",\"PVC\",\"Silicone\"],\"col\":1,\"req\":false},{\"id\":\"sheath\",\"field\":\"sheath\",\"lbl\":\"Sheath Material\",\"label\":\"Sheath Material\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"max_a\",\"field\":\"max_a\",\"lbl\":\"Max Current (A)\",\"label\":\"Max Current (A)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"temp_range\",\"field\":\"temp_range\",\"lbl\":\"Temp Range (C)\",\"label\":\"Temp Range (C)\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"uv_resistant\",\"field\":\"uv_resistant\",\"lbl\":\"UV Resistant\",\"label\":\"UV Resistant\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"standard\",\"field\":\"standard\",\"lbl\":\"Standard\",\"label\":\"Standard\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"datasheet_url\",\"field\":\"datasheet_url\",\"lbl\":\"Datasheet URL\",\"label\":\"Datasheet URL\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}]},{\"key\":\"ac_cable\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Manufacturer\",\"label\":\"Manufacturer\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Product Name\",\"label\":\"Product Name\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"rated_kv\",\"field\":\"rated_kv\",\"lbl\":\"Voltage Rating (kV)\",\"label\":\"Voltage Rating (kV)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"size_mm2\",\"field\":\"size_mm2\",\"lbl\":\"Conductor Size (mm)\",\"label\":\"Conductor Size (mm)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"cores\",\"field\":\"cores\",\"lbl\":\"Number of Cores\",\"label\":\"Number of Cores\",\"type\":\"select\",\"opts\":[\"\",\"1\",\"3\",\"4\"],\"col\":1,\"req\":false},{\"id\":\"conductor\",\"field\":\"conductor\",\"lbl\":\"Conductor Material\",\"label\":\"Conductor Material\",\"type\":\"select\",\"opts\":[\"\",\"Copper\",\"Aluminium\"],\"col\":1,\"req\":false},{\"id\":\"insulation\",\"field\":\"insulation\",\"lbl\":\"Insulation\",\"label\":\"Insulation\",\"type\":\"select\",\"opts\":[\"\",\"XLPE\",\"EPR\",\"PVC\"],\"col\":1,\"req\":false},{\"id\":\"armoring\",\"field\":\"armoring\",\"lbl\":\"Armoring\",\"label\":\"Armoring\",\"type\":\"select\",\"opts\":[\"\",\"None\",\"SWA\",\"STA\",\"AWA\"],\"col\":1,\"req\":false},{\"id\":\"max_a\",\"field\":\"max_a\",\"lbl\":\"Max Current (A)\",\"label\":\"Max Current (A)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"sc_ka\",\"field\":\"sc_ka\",\"lbl\":\"Short Circuit Rating (kA)\",\"label\":\"Short Circuit Rating (kA)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"standard\",\"field\":\"standard\",\"lbl\":\"Standard\",\"label\":\"Standard\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"datasheet_url\",\"field\":\"datasheet_url\",\"lbl\":\"Datasheet URL\",\"label\":\"Datasheet URL\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}]},{\"key\":\"piles\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Manufacturer / Supplier\",\"label\":\"Manufacturer / Supplier\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Product Name\",\"label\":\"Product Name\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"pile_type\",\"field\":\"pile_type\",\"lbl\":\"Pile Type\",\"label\":\"Pile Type\",\"type\":\"select\",\"opts\":[\"\",\"Driven Steel\",\"Helical\",\"Ground Screw\",\"Concrete Cast In-Situ\",\"Precast Concrete\"],\"col\":1,\"req\":false},{\"id\":\"material\",\"field\":\"material\",\"lbl\":\"Material\",\"label\":\"Material\",\"type\":\"select\",\"opts\":[\"\",\"Hot-rolled Steel\",\"Cold-formed Steel\",\"Galvanised Steel\",\"Concrete\"],\"col\":1,\"req\":false},{\"id\":\"cross_section\",\"field\":\"cross_section\",\"lbl\":\"Cross Section (mm)\",\"label\":\"Cross Section (mm)\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"length_m\",\"field\":\"length_m\",\"lbl\":\"Standard Length (m)\",\"label\":\"Standard Length (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"max_pen_m\",\"field\":\"max_pen_m\",\"lbl\":\"Max Penetration (m)\",\"label\":\"Max Penetration (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"load_kn\",\"field\":\"load_kn\",\"lbl\":\"Load Capacity (kN)\",\"label\":\"Load Capacity (kN)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"corr_prot\",\"field\":\"corr_prot\",\"lbl\":\"Corrosion Protection\",\"label\":\"Corrosion Protection\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"soil_class\",\"field\":\"soil_class\",\"lbl\":\"Soil Class Suitability\",\"label\":\"Soil Class Suitability\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"standard\",\"field\":\"standard\",\"lbl\":\"Standard\",\"label\":\"Standard\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"datasheet_url\",\"field\":\"datasheet_url\",\"lbl\":\"Datasheet URL\",\"label\":\"Datasheet URL\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}]}],\"reg_suppliers\":[{\"id\":\"name\",\"field\":\"name\",\"lbl\":\"Company Name\",\"label\":\"Company Name\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":true},{\"id\":\"country\",\"field\":\"country\",\"lbl\":\"Country\",\"label\":\"Country\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"website\",\"field\":\"website\",\"lbl\":\"Website\",\"label\":\"Website\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"contact_name\",\"field\":\"contact_name\",\"lbl\":\"Primary Contact Name\",\"label\":\"Primary Contact Name\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"contact_email\",\"field\":\"contact_email\",\"lbl\":\"Contact Email\",\"label\":\"Contact Email\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"contact_phone\",\"field\":\"contact_phone\",\"lbl\":\"Contact Phone\",\"label\":\"Contact Phone\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"credit_rating\",\"field\":\"credit_rating\",\"lbl\":\"Credit Rating / Standing\",\"label\":\"Credit Rating / Standing\",\"type\":\"select\",\"opts\":[\"\",\"AAA\",\"AA\",\"A\",\"BBB\",\"BB\",\"B\",\"Not Rated\",\"Public Entity\"],\"col\":1,\"req\":false},{\"id\":\"years_biz\",\"field\":\"years_biz\",\"lbl\":\"Years in Business\",\"label\":\"Years in Business\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"parent_co\",\"field\":\"parent_co\",\"lbl\":\"Parent Company\",\"label\":\"Parent Company\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"certs\",\"field\":\"certs\",\"lbl\":\"Certifications / Quals\",\"label\":\"Certifications / Quals\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false},{\"id\":\"notes\",\"field\":\"notes\",\"lbl\":\"Notes\",\"label\":\"Notes\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}],\"reg_equipment\":[{\"key\":\"dozer\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Make / Brand\",\"label\":\"Make / Brand\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Model\",\"label\":\"Model\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"weight_t\",\"field\":\"weight_t\",\"lbl\":\"Operating Weight (t)\",\"label\":\"Operating Weight (t)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"blade_m3\",\"field\":\"blade_m3\",\"lbl\":\"Blade Capacity (m)\",\"label\":\"Blade Capacity (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"power_kw\",\"field\":\"power_kw\",\"lbl\":\"Engine Power (kW)\",\"label\":\"Engine Power (kW)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"track\",\"field\":\"track\",\"lbl\":\"Track Type\",\"label\":\"Track Type\",\"type\":\"select\",\"opts\":[\"\",\"Steel Tracks\",\"Rubber Tracks\"],\"col\":1,\"req\":false},{\"id\":\"fuel\",\"field\":\"fuel\",\"lbl\":\"Fuel Type\",\"label\":\"Fuel Type\",\"type\":\"select\",\"opts\":[\"\",\"Diesel\",\"Electric\",\"Hybrid\"],\"col\":1,\"req\":false},{\"id\":\"gps_grade\",\"field\":\"gps_grade\",\"lbl\":\"GPS Grade Control\",\"label\":\"GPS Grade Control\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"qty\",\"field\":\"qty\",\"lbl\":\"Quantity on Site\",\"label\":\"Quantity on Site\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ownership\",\"field\":\"ownership\",\"lbl\":\"Ownership\",\"label\":\"Ownership\",\"type\":\"select\",\"opts\":[\"\",\"Owned\",\"Rented\",\"Contractor-supplied\"],\"col\":1,\"req\":false}]},{\"key\":\"excavator\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Make / Brand\",\"label\":\"Make / Brand\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Model\",\"label\":\"Model\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"weight_t\",\"field\":\"weight_t\",\"lbl\":\"Operating Weight (t)\",\"label\":\"Operating Weight (t)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"bucket_m3\",\"field\":\"bucket_m3\",\"lbl\":\"Bucket Capacity (m)\",\"label\":\"Bucket Capacity (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"dig_depth_m\",\"field\":\"dig_depth_m\",\"lbl\":\"Max Dig Depth (m)\",\"label\":\"Max Dig Depth (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"arm_reach_m\",\"field\":\"arm_reach_m\",\"lbl\":\"Arm Reach (m)\",\"label\":\"Arm Reach (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"power_kw\",\"field\":\"power_kw\",\"lbl\":\"Engine Power (kW)\",\"label\":\"Engine Power (kW)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"fuel\",\"field\":\"fuel\",\"lbl\":\"Fuel Type\",\"label\":\"Fuel Type\",\"type\":\"select\",\"opts\":[\"\",\"Diesel\",\"Electric\",\"Hybrid\"],\"col\":1,\"req\":false},{\"id\":\"qty\",\"field\":\"qty\",\"lbl\":\"Quantity on Site\",\"label\":\"Quantity on Site\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ownership\",\"field\":\"ownership\",\"lbl\":\"Ownership\",\"label\":\"Ownership\",\"type\":\"select\",\"opts\":[\"\",\"Owned\",\"Rented\",\"Contractor-supplied\"],\"col\":1,\"req\":false}]},{\"key\":\"pile_driver\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Make / Brand\",\"label\":\"Make / Brand\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Model\",\"label\":\"Model\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"method\",\"field\":\"method\",\"lbl\":\"Drive Method\",\"label\":\"Drive Method\",\"type\":\"select\",\"opts\":[\"\",\"Hydraulic Impact\",\"Vibratory\",\"Hydraulic Press\",\"Rotary\"],\"col\":1,\"req\":false},{\"id\":\"energy_j\",\"field\":\"energy_j\",\"lbl\":\"Max Hammer Energy (J)\",\"label\":\"Max Hammer Energy (J)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"max_pile_m\",\"field\":\"max_pile_m\",\"lbl\":\"Max Pile Length (m)\",\"label\":\"Max Pile Length (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"max_dia_mm\",\"field\":\"max_dia_mm\",\"lbl\":\"Max Pile Dia (mm)\",\"label\":\"Max Pile Dia (mm)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"rate_hr\",\"field\":\"rate_hr\",\"lbl\":\"Driving Rate (piles/hr)\",\"label\":\"Driving Rate (piles/hr)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"gps\",\"field\":\"gps\",\"lbl\":\"GPS Positioning\",\"label\":\"GPS Positioning\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"qty\",\"field\":\"qty\",\"lbl\":\"Quantity on Site\",\"label\":\"Quantity on Site\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ownership\",\"field\":\"ownership\",\"lbl\":\"Ownership\",\"label\":\"Ownership\",\"type\":\"select\",\"opts\":[\"\",\"Owned\",\"Rented\",\"Contractor-supplied\"],\"col\":1,\"req\":false}]},{\"key\":\"robot_installer\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Manufacturer\",\"label\":\"Manufacturer\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Model\",\"label\":\"Model\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"rate_mod_hr\",\"field\":\"rate_mod_hr\",\"lbl\":\"Install Rate (mod/hr)\",\"label\":\"Install Rate (mod/hr)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"mod_compat\",\"field\":\"mod_compat\",\"lbl\":\"Module Compatibility\",\"label\":\"Module Compatibility\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"tracker_compat\",\"field\":\"tracker_compat\",\"lbl\":\"Tracker Compatible\",\"label\":\"Tracker Compatible\",\"type\":\"toggle\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"lift_kg\",\"field\":\"lift_kg\",\"lbl\":\"Lifting Capacity (kg)\",\"label\":\"Lifting Capacity (kg)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"nav\",\"field\":\"nav\",\"lbl\":\"Navigation\",\"label\":\"Navigation\",\"type\":\"select\",\"opts\":[\"\",\"GPS + Vision\",\"LiDAR\",\"Camera Only\",\"Manual Assist\"],\"col\":1,\"req\":false},{\"id\":\"crew\",\"field\":\"crew\",\"lbl\":\"Crew Required\",\"label\":\"Crew Required\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"qty\",\"field\":\"qty\",\"lbl\":\"Quantity on Site\",\"label\":\"Quantity on Site\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ownership\",\"field\":\"ownership\",\"lbl\":\"Ownership\",\"label\":\"Ownership\",\"type\":\"select\",\"opts\":[\"\",\"Owned\",\"Rented\",\"Contractor-supplied\"],\"col\":1,\"req\":false}]},{\"key\":\"crane\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Make / Brand\",\"label\":\"Make / Brand\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Model\",\"label\":\"Model\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"type\",\"field\":\"type\",\"lbl\":\"Type\",\"label\":\"Type\",\"type\":\"select\",\"opts\":[\"\",\"Mobile Crane\",\"Tower Crane\",\"Crawler Crane\",\"All-Terrain\"],\"col\":1,\"req\":false},{\"id\":\"max_lift_t\",\"field\":\"max_lift_t\",\"lbl\":\"Max Lift Capacity (t)\",\"label\":\"Max Lift Capacity (t)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"boom_m\",\"field\":\"boom_m\",\"lbl\":\"Boom Length (m)\",\"label\":\"Boom Length (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"qty\",\"field\":\"qty\",\"lbl\":\"Quantity on Site\",\"label\":\"Quantity on Site\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ownership\",\"field\":\"ownership\",\"lbl\":\"Ownership\",\"label\":\"Ownership\",\"type\":\"select\",\"opts\":[\"\",\"Owned\",\"Rented\",\"Contractor-supplied\"],\"col\":1,\"req\":false}]},{\"key\":\"cable_trencher\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Make / Brand\",\"label\":\"Make / Brand\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Model\",\"label\":\"Model\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"method\",\"field\":\"method\",\"lbl\":\"Trench Type\",\"label\":\"Trench Type\",\"type\":\"select\",\"opts\":[\"\",\"Chain Trencher\",\"Wheel Trencher\",\"Micro-trencher\",\"Plough\"],\"col\":1,\"req\":false},{\"id\":\"depth_m\",\"field\":\"depth_m\",\"lbl\":\"Max Trench Depth (m)\",\"label\":\"Max Trench Depth (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"width_mm\",\"field\":\"width_mm\",\"lbl\":\"Max Trench Width (mm)\",\"label\":\"Max Trench Width (mm)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"rate_m_hr\",\"field\":\"rate_m_hr\",\"lbl\":\"Production Rate (m/hr)\",\"label\":\"Production Rate (m/hr)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"power_kw\",\"field\":\"power_kw\",\"lbl\":\"Engine Power (kW)\",\"label\":\"Engine Power (kW)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"qty\",\"field\":\"qty\",\"lbl\":\"Quantity on Site\",\"label\":\"Quantity on Site\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ownership\",\"field\":\"ownership\",\"lbl\":\"Ownership\",\"label\":\"Ownership\",\"type\":\"select\",\"opts\":[\"\",\"Owned\",\"Rented\",\"Contractor-supplied\"],\"col\":1,\"req\":false}]},{\"key\":\"forklift\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Make / Brand\",\"label\":\"Make / Brand\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Model\",\"label\":\"Model\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"lift_kg\",\"field\":\"lift_kg\",\"lbl\":\"Max Lift Capacity (kg)\",\"label\":\"Max Lift Capacity (kg)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"lift_m\",\"field\":\"lift_m\",\"lbl\":\"Max Lift Height (m)\",\"label\":\"Max Lift Height (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"reach_m\",\"field\":\"reach_m\",\"lbl\":\"Reach (m)\",\"label\":\"Reach (m)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"fuel\",\"field\":\"fuel\",\"lbl\":\"Fuel Type\",\"label\":\"Fuel Type\",\"type\":\"select\",\"opts\":[\"\",\"Diesel\",\"Electric\",\"LPG\"],\"col\":1,\"req\":false},{\"id\":\"qty\",\"field\":\"qty\",\"lbl\":\"Quantity on Site\",\"label\":\"Quantity on Site\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ownership\",\"field\":\"ownership\",\"lbl\":\"Ownership\",\"label\":\"Ownership\",\"type\":\"select\",\"opts\":[\"\",\"Owned\",\"Rented\",\"Contractor-supplied\"],\"col\":1,\"req\":false}]},{\"key\":\"generator\",\"fields\":[{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Make / Brand\",\"label\":\"Make / Brand\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Model\",\"label\":\"Model\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":true},{\"id\":\"kva\",\"field\":\"kva\",\"lbl\":\"Rated Power (kVA)\",\"label\":\"Rated Power (kVA)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"fuel\",\"field\":\"fuel\",\"lbl\":\"Fuel Type\",\"label\":\"Fuel Type\",\"type\":\"select\",\"opts\":[\"\",\"Diesel\",\"Gas\",\"HVO\",\"Hybrid\"],\"col\":1,\"req\":false},{\"id\":\"tank_l\",\"field\":\"tank_l\",\"lbl\":\"Tank Capacity (L)\",\"label\":\"Tank Capacity (L)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"fuel_lhr\",\"field\":\"fuel_lhr\",\"lbl\":\"Fuel Consumption (L/hr)\",\"label\":\"Fuel Consumption (L/hr)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"qty\",\"field\":\"qty\",\"lbl\":\"Quantity on Site\",\"label\":\"Quantity on Site\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ownership\",\"field\":\"ownership\",\"lbl\":\"Ownership\",\"label\":\"Ownership\",\"type\":\"select\",\"opts\":[\"\",\"Owned\",\"Rented\",\"Contractor-supplied\"],\"col\":1,\"req\":false}]},{\"key\":\"other_equip\",\"fields\":[{\"id\":\"model\",\"field\":\"model\",\"lbl\":\"Description\",\"label\":\"Description\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":true},{\"id\":\"mfr\",\"field\":\"mfr\",\"lbl\":\"Make / Brand\",\"label\":\"Make / Brand\",\"type\":\"text\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"qty\",\"field\":\"qty\",\"lbl\":\"Quantity on Site\",\"label\":\"Quantity on Site\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"power_kw\",\"field\":\"power_kw\",\"lbl\":\"Engine Power (kW)\",\"label\":\"Engine Power (kW)\",\"type\":\"number\",\"opts\":[],\"col\":1,\"req\":false},{\"id\":\"ownership\",\"field\":\"ownership\",\"lbl\":\"Ownership\",\"label\":\"Ownership\",\"type\":\"select\",\"opts\":[\"\",\"Owned\",\"Rented\",\"Contractor-supplied\"],\"col\":1,\"req\":false},{\"id\":\"notes\",\"field\":\"notes\",\"lbl\":\"Notes\",\"label\":\"Notes\",\"type\":\"text\",\"opts\":[],\"col\":2,\"req\":false}]}]}"); } catch(e) { return {}; }
})();

/* ‚îÄ‚îÄ Boot: seed from defaults, then overlay with any Supabase overrides ‚îÄ‚îÄ */
function loadRegistryFromDB(cb) {
  // 1. Seed REG_LIVE from hardcoded defaults immediately
  Object.keys(REG_DEFAULTS).forEach(function(k) {
    REG_LIVE[k] = JSON.stringify(REG_DEFAULTS[k]);
  });

  // 2. Fetch live Supabase data and overlay on top
  sb.from('admin_config').select('key,value')
    .in('key', ALL_REG_KEYS.concat(['field_registry_version','field_registry_date']))
    .then(function(res) {
      if (!res.error && res.data) {
        res.data.forEach(function(r) {
          // Only override if the DB value is non-empty and valid JSON
          if (r.value && r.value !== 'null' && r.value !== '{}' && r.value !== '[]') {
            try {
              var parsed = JSON.parse(r.value);
              // For field_registry: merge per-key so we don't lose default cats
              if (r.key === 'field_registry' && typeof parsed === 'object' && !Array.isArray(parsed)) {
                var base = {};
                try { base = JSON.parse(REG_LIVE['field_registry'] || '{}'); } catch(e) {}
                Object.keys(parsed).forEach(function(catKey) {
                  if (Array.isArray(parsed[catKey]) && parsed[catKey].length) {
                    base[catKey] = parsed[catKey];
                  }
                });
                REG_LIVE['field_registry'] = JSON.stringify(base);
              } else if (Array.isArray(parsed) && parsed.length > 0) {
                REG_LIVE[r.key] = r.value;
              } else if (!Array.isArray(parsed)) {
                REG_LIVE[r.key] = r.value;
              }
            } catch(e) { /* keep default */ }
          }
        });
      }
      if (cb) cb();
    }).catch(function() { if (cb) cb(); });
}

/* ‚îÄ‚îÄ Show tab ‚îÄ‚îÄ */
function regShowTab(tab, cat) {
  regCurrentTab = tab;
  regCurrentCat = cat;

  // Update tab highlight
  document.querySelectorAll('.reg-tab').forEach(function(b) { b.classList.remove('active'); });
  var clicked = Array.from(document.querySelectorAll('.reg-tab')).find(function(b) {
    return b.getAttribute('data-tab') === tab && (b.getAttribute('data-cat')||'') === cat;
  });
  if (clicked) clicked.classList.add('active');

  var edCard = document.getElementById('reg-editor-card');
  var upCard = document.getElementById('reg-upload-card');
  var sbOut  = document.getElementById('reg-supabase-out');
  var iqCard = document.getElementById('reg-intake-card');

  edCard.style.display  = (tab === 'upload' || tab === 'intake') ? 'none' : 'block';
  upCard.style.display  = (tab === 'upload') ? 'block' : 'none';
  iqCard.style.display  = (tab === 'intake') ? 'block' : 'none';
  sbOut.style.display   = 'none';

  if (tab === 'upload') return;
  if (tab === 'intake') { loadIntakeQs(); return; }
  renderRegTab(tab, cat);
}

/* ‚îÄ‚îÄ Render the editable field table for the selected tab ‚îÄ‚îÄ */
/* ‚îÄ‚îÄ Render section input: dropdown for builder tabs, text for cat tabs ‚îÄ‚îÄ */
function renderSecInput(tab, i, currentSec) {
  var sectionOptions = {
    arrays:    ['yield','civil','geo','elec','mech'],
    crews:     ['civil','install','electrical'],
    contracts: ['common','payments','ld_delivery','module_supplier_extra','inverter_supplier_extra','tracker_supplier_extra','bess_supplier_extra','epc_extra','design_firm_extra'],
    components:['module','inverter','racking','tracker','transformer','dc_cable','ac_cable','piles'],
    equipment: ['dozer','excavator','pile_driver','robot_installer','crane','cable_trencher','forklift','generator','other_equip'],
  };
  var opts = sectionOptions[tab];
  if (opts) {
    // Builder tab ‚Äî show a dropdown of valid group keys
    var html = '<select class="reg-inp-sec" data-i="' + i + '" style="width:100%;background:#0d1220;color:#ccc;border:1px solid rgba(255,255,255,0.08);border-radius:4px;padding:3px 5px;font-size:11px;">';
    opts.forEach(function(o) {
      html += '<option value="' + o + '"' + (currentSec === o ? ' selected' : '') + '>' + o + '</option>';
    });
    html += '</select>';
    return html;
  }
  // Category KPI tab ‚Äî free text section name
  return '<input class="reg-inp-sec" data-i="' + i + '" value="' + escAdm(currentSec) + '" placeholder="Section name" style="width:100%;">';
}

function renderRegTab(tab, cat) {
  var title = document.getElementById('reg-editor-title');
  var table = document.getElementById('reg-field-table');
  var addBtn = document.getElementById('reg-add-btn');
  var saveBtn = document.getElementById('reg-save-tab-btn');

  addBtn.style.display  = 'inline-block';
  saveBtn.style.display = 'inline-block';
  var vBtn = document.getElementById('reg-verify-btn'); if (vBtn) vBtn.style.display = 'inline-block';

  var fields = regGetFields(tab, cat);
  var label  = cat || tab.charAt(0).toUpperCase() + tab.slice(1);
  title.textContent = label + ' ‚Äî ' + fields.length + ' fields';

  // Special case: score_design has no KPI panel fields (design fields live in Array Sections)
  if (tab === 'cat' && cat === 'Design & Engineering' && fields.length === 0) {
    document.getElementById('reg-field-table').innerHTML =
      '<div style="background:#0d1220;border:1px solid rgba(255,255,0,0.12);border-radius:6px;padding:20px;color:#666;font-size:12px;line-height:1.8;">' +
      '<strong style="color:#FFFF00;">Design & Engineering has no KPI panel fields.</strong><br>' +
      'All Design fields live inside individual Array cards (Resource & Yield, Civil & Structural, Geological Study, Electrical, Mechanical & BESS).<br><br>' +
      'To edit Design fields ‚Üí click the <strong style="color:#7aa3f5;">‚òÄÔ∏è Array Sections</strong> tab.' +
      '</div>';
    document.getElementById('reg-add-btn').style.display = 'none';
    document.getElementById('reg-save-tab-btn').style.display = 'none';
    var vb=document.getElementById('reg-verify-btn'); if(vb) vb.style.display='none';
    return;
  }

  // Generic empty state
  if (fields.length === 0) {
    document.getElementById('reg-field-table').innerHTML =
      '<div style="background:#0d1220;border:1px dashed rgba(255,255,255,0.08);border-radius:6px;padding:20px;color:#555;font-size:12px;text-align:center;">' +
      'No fields yet. Click <strong style="color:#FFFF00;">+ Add Field</strong> to add the first one.' +
      '</div>';
  }
  var hints = {
    'Design & Engineering': 'üìê Right-side KPI spec fields on the Design panel (DC capacity, P50 yield, geo report etc)',
    'Construction': 'üèóÔ∏è Right-side KPI spec fields on the Construction panel (NTP date, EPC price, peak manpower etc)',
    'Permitting': 'üìã Right-side KPI spec fields on the Permitting panel (CUP status, site acres, flood zone etc)',
    'Procurement': 'üì¶ Right-side KPI spec fields on the Procurement panel. ‚ö†Ô∏è For the fields INSIDE contract cards (Contract Terms / Milestones / LDs) ‚Üí use the üìë Contract Fields tab instead',
    'Legal & Contract': '‚öñÔ∏è Right-side KPI spec fields on the Legal panel (PPA term, ITC %, LCOE etc)',
    'Grid Interconnection': 'üîå Right-side KPI spec fields on the Grid panel (queue position, upgrade cost etc)',
    'Financial': 'üí∞ Right-side KPI spec fields on the Financial panel (capex, DSCR, IRR, LCOE etc)',
    'arrays': '‚òÄÔ∏è Sub-sections inside each Design Array card ‚Äî sections are: yield / civil / geo / elec / mech. Each field inside a section appears in that array card.',
    'crews': 'üë∑ Manpower fields inside crew cards. Groups = crew type: civil / install / electrical',
    'contracts': 'üìë Fields inside Procurement contract cards. Groups = contract section: common (terms) / payments (milestones) / ld_delivery / epc_extra / module_extra / bess_extra',
    'components': '‚öôÔ∏è Spec fields inside component cards. Groups = component type: module / inverter / racking / tracker / transformer / bess',
    'suppliers': 'üè¢ Company info fields shared by all 13 supplier types (EPC, Module Supplier, Lender, Offtaker etc)',
    'equipment': 'üöú Spec fields inside equipment cards. Groups = equipment type: dozer / excavator / pile_driver / crane / robot_installer etc',
  };
  var hKey = cat || tab;
  var existingHint = document.getElementById('reg-tab-hint');
  if (existingHint) existingHint.remove();
  if (hints[hKey]) {
    var hEl = document.createElement('div');
    hEl.id = 'reg-tab-hint';
    hEl.style.cssText = 'font-size:11px;color:#778;background:#0d1220;border:1px solid rgba(255,255,0,0.08);border-left:3px solid rgba(255,255,0,0.3);border-radius:4px;padding:8px 12px;margin-bottom:10px;line-height:1.6;';
    hEl.textContent = hints[hKey];
    document.getElementById('reg-field-table').before(hEl);
  }

  var html = '<table class="reg-tbl"><thead><tr>' +
    '<th style="width:28%">Label</th>' +
    '<th style="width:20%">Field Key <span style="color:#555;font-weight:400;">(immutable ‚Äî never change)</span></th>' +
    '<th style="width:9%">Type</th>' +
    '<th style="width:12%">Section</th>' +
    '<th>Options (/ separated, for select type only)</th>' +
    '<th style="width:44px;text-align:center;">Del</th>' +
    '</tr></thead><tbody>';

  var lastSec = null;
  fields.forEach(function(f, i) {
    var sec = f.section || '';
    if (sec !== lastSec) {
      html += '<tr class="reg-sec-row"><td colspan="6">üìÅ ' + escAdm(sec || 'General') + '</td></tr>';
      lastSec = sec;
    }
    var opts = Array.isArray(f.opts) ? f.opts.filter(Boolean).join(' / ') : (f.opts||'');
    html += '<tr data-idx="' + i + '" data-field-key="' + escAdm(f.id||f.field||('field_'+i)) + '">' +
      '<td><input class="reg-inp-lbl" data-i="' + i + '" value="' + escAdm(f.label||f.lbl||'') + '"></td>' +
      '<td class="reg-key-cell">' + escAdm(f.id||f.field||'') + '</td>' +
      '<td><select class="reg-inp-type" data-i="' + i + '">' +
        ['text','number','select','toggle','date','textarea'].map(function(t){
          return '<option value="'+t+'"'+(f.type===t?' selected':'')+'>'+t+'</option>';
        }).join('') +
      '</select></td>' +
      '<td>' + renderSecInput(regCurrentTab, i, sec) + '</td>' +
      '<td><input class="reg-inp-opts" data-i="' + i + '" value="' + escAdm(opts) + '" placeholder="Opt A / Opt B / Opt C"></td>' +
      '<td style="text-align:center;"><button class="reg-del-btn" title="Delete this field" onclick="regDeleteField(\'' + (f.id||f.field||String(i)).replace(/\\/g,'\\\\').replace(/'/g,"\\'") + '\')" style="background:rgba(192,57,43,0.15);border:1px solid rgba(192,57,43,0.3);color:#e74c3c;border-radius:4px;padding:2px 7px;cursor:pointer;font-size:12px;font-weight:700;">‚úï</button></td>' +
      '</tr>';
  });

  html += '</tbody></table>';
  table.innerHTML = html;
}

/* ‚îÄ‚îÄ Get field array for current tab ‚îÄ‚îÄ */
function regGetFields(tab, cat) {
  try {
    if (tab === 'cat') {
      var key = CAT_TO_KEY[cat];
      var raw = REG_LIVE['field_registry'];
      if (raw) {
        var reg = JSON.parse(raw);
        return reg[key] || [];
      }
      return [];
    }
    var keyMap = {
      arrays:     'reg_design_arrays',
      crews:      'reg_crews',
      contracts:  'reg_procurement_contracts',
      components: 'reg_components',
      suppliers:  'reg_suppliers',
      equipment:  'reg_equipment',
    };
    var dbKey = keyMap[tab];
    if (!dbKey || !REG_LIVE[dbKey]) return [];
    var data = JSON.parse(REG_LIVE[dbKey]);
    // Flatten groups into a single list with section = group key
    if (Array.isArray(data) && data.length && data[0].fields) {
      var flat = [];
      data.forEach(function(g) {
        (g.fields||[]).forEach(function(f) {
          flat.push(Object.assign({}, f, { section: g.key }));
        });
      });
      return flat;
    }
    return Array.isArray(data) ? data : [];
  } catch(e) { return []; }
}

/* ‚îÄ‚îÄ Collect edits entirely from DOM ‚Äî no REG_LIVE index dependency ‚îÄ‚îÄ */
function regCollectEdits() {
  var rows = document.querySelectorAll('#reg-field-table tbody tr[data-idx]');
  var fields = [];
  rows.forEach(function(row) {
    var fieldKey = row.getAttribute('data-field-key') || ('field_' + Date.now() + '_' + Math.random().toString(36).slice(2,6));
    var lbl  = (row.querySelector('.reg-inp-lbl')  || {}).value || '';
    var typ  = (row.querySelector('.reg-inp-type') || {}).value || 'text';
    var sec  = (row.querySelector('.reg-inp-sec')  || {}).value || '';
    var optsRaw = (row.querySelector('.reg-inp-opts') || {}).value || '';
    var opts = optsRaw.trim() ? [''].concat(optsRaw.split('/').map(function(o){return o.trim();}).filter(Boolean)) : [];
    if (!lbl.trim() && !fieldKey) return; // skip completely empty rows
    fields.push({
      id:      fieldKey,
      field:   fieldKey,
      label:   lbl.trim(),
      lbl:     lbl.trim(),
      type:    typ,
      section: sec.trim(),
      opts:    opts,
      col:     1
    });
  });
  return fields;
}

/* ‚îÄ‚îÄ Add a new blank field ‚îÄ‚îÄ */
function regAddField() {
  var fields = regCollectEdits();
  var newKey = 'field_' + Date.now();
  // Determine default section from existing fields
  var defaultSec = fields.length ? (fields[fields.length-1].section || '') : '';
  fields.push({ id: newKey, field: newKey, label: 'New Field', lbl: 'New Field', type: 'text', opts: [], section: defaultSec, col: 1 });
  regSetFields(regCurrentTab, regCurrentCat, fields);
  renderRegTab(regCurrentTab, regCurrentCat);
}

/* ‚îÄ‚îÄ Delete a field ‚Äî identified by field key, auto-saves immediately ‚îÄ‚îÄ */
function regDeleteField(fieldKey) {
  var fields = regCollectEdits();
  var idx = fields.findIndex(function(f){ return (f.id||f.field) === fieldKey; });
  if (idx < 0) { console.warn('regDeleteField: key not found:', fieldKey); return; }
  var name = fields[idx].label || fields[idx].lbl || fieldKey;
  if (!confirm('Delete "' + name + '"?')) return;
  fields.splice(idx, 1);
  regSetFields(regCurrentTab, regCurrentCat, fields);
  renderRegTab(regCurrentTab, regCurrentCat);
  regSaveTab();
}

/* ‚îÄ‚îÄ Write edited fields back to REG_LIVE ‚îÄ‚îÄ */
function regSetFields(tab, cat, fields) {
  try {
    if (tab === 'cat') {
      var key = CAT_TO_KEY[cat];
      var reg = {};
      try { reg = JSON.parse(REG_LIVE['field_registry'] || '{}'); } catch(e) {}
      reg[key] = fields;
      REG_LIVE['field_registry'] = JSON.stringify(reg);
      return;
    }
    var keyMap = {
      arrays:     'reg_design_arrays',
      crews:      'reg_crews',
      contracts:  'reg_procurement_contracts',
      components: 'reg_components',
      suppliers:  'reg_suppliers',
      equipment:  'reg_equipment',
    };
    var dbKey = keyMap[tab];
    if (!dbKey) return;
    // Re-group by section
    var groups = {};
    var order  = [];
    fields.forEach(function(f) {
      var sec = f.section || '__default';
      if (!groups[sec]) { groups[sec] = []; order.push(sec); }
      groups[sec].push(f);
    });
    var grouped = order.filter(function(k,i){ return order.indexOf(k)===i; }).map(function(k) {
      return { key: k, fields: groups[k].map(function(f){ return Object.assign({},f,{section:undefined}); }) };
    });
    REG_LIVE[dbKey] = JSON.stringify(grouped);
  } catch(e) { console.error('regSetFields error', e); }
}

/* ‚îÄ‚îÄ Save current tab to Supabase ‚îÄ‚îÄ */
function regSaveTab() {
  var fields = regCollectEdits();
  regSetFields(regCurrentTab, regCurrentCat, fields);

  var now    = new Date();
  var version = regMakeVersion();
  var saveBtn = document.getElementById('reg-save-tab-btn');
  var msg     = document.getElementById('reg-save-msg');
  saveBtn.disabled   = true;
  saveBtn.textContent = 'Saving‚Ä¶';

  // Determine which keys to save
  var pairs = [];
  if (regCurrentTab === 'cat') {
    pairs.push({ key: 'field_registry', value: REG_LIVE['field_registry'] || '{}' });
  } else {
    var keyMap = { arrays:'reg_design_arrays', crews:'reg_crews', contracts:'reg_procurement_contracts', components:'reg_components', suppliers:'reg_suppliers', equipment:'reg_equipment' };
    var dbKey  = keyMap[regCurrentTab];
    if (dbKey) pairs.push({ key: dbKey, value: REG_LIVE[dbKey] || '[]' });
  }
  pairs.push({ key: 'field_registry_version', value: version });
  pairs.push({ key: 'field_registry_date',    value: now.toISOString() });

  regUpsertAll(pairs, function(err) {
    saveBtn.disabled    = false;
    saveBtn.textContent = '‚úì Save';
    if (err) {
      msg.style.opacity = 1; msg.style.color = '#e74c3c';
      msg.textContent = 'SAVE FAILED: ' + err;
      alert('Save failed: ' + err + '\n\nYou must be logged in to admin for writes to succeed.');
    } else {
      msg.textContent = 'Saved ‚úì'; msg.style.color = '#2ecc71'; msg.style.opacity = 1;
      loadRegistryStatus();
      renderRegTab(regCurrentTab, regCurrentCat);
      // Read-back verification ‚Äî catches silent failures
      var checkKey = pairs[0] && pairs[0].key;
      if (checkKey) {
        sb.from('admin_config').select('key,value').eq('key', checkKey).limit(1)
          .then(function(vres) {
            if (vres.error || !vres.data || !vres.data.length) {
              console.warn('[Registry] ‚ö† Read-back failed for', checkKey, vres.error && vres.error.message);
              msg.textContent = '‚ö† Saved but not found in DB'; msg.style.color='#f39c12'; msg.style.opacity=1;
            } else {
              var len = (vres.data[0].value||'').length;
              console.log('[Registry] ‚úì Read-back OK:', checkKey, len, 'chars');
              msg.textContent = 'Saved ‚úì (' + len + ' chars in DB)'; msg.style.color='#2ecc71'; msg.style.opacity=1;
            }
          });
      }
    }
    setTimeout(function(){ msg.style.opacity=0; }, 4000);
  });
}

/* ‚îÄ‚îÄ Verify what is actually in Supabase for the current tab ‚îÄ‚îÄ */
function regVerifyDB() {
  var keyMap = { cat:'field_registry', arrays:'reg_design_arrays', crews:'reg_crews',
    contracts:'reg_procurement_contracts', components:'reg_components', suppliers:'reg_suppliers', equipment:'reg_equipment' };
  var dbKey = keyMap[regCurrentTab];
  if (!dbKey) { alert('Select a tab first'); return; }
  sb.from('admin_config').select('key,value,updated_at').eq('key', dbKey).order('updated_at', {ascending:false}).limit(1)
    .then(function(res) {
      if (res.error) { alert('DB Error: ' + res.error.message + '\nKey: ' + dbKey); return; }
      if (!res.data || !res.data.length) { alert('Key "' + dbKey + '" NOT FOUND in Supabase.\nSaves are failing ‚Äî check browser console for auth errors.'); return; }
      if (res.data.length > 1) { alert('WARNING: ' + res.data.length + ' duplicate rows found for key "' + dbKey + '"!\nThe DELETE+INSERT fix should prevent this going forward. Old duplicates may need manual cleanup in Supabase.'); }
      var val = res.data[0].value || '';
      var updated = res.data[0].updated_at || 'unknown';
      var summary = 'Key: ' + dbKey + '\nLast updated: ' + updated + '\nValue length: ' + val.length + ' chars\n\n';
      try {
        var parsed = JSON.parse(val);
        if (Array.isArray(parsed)) {
          summary += parsed.length + ' groups:\n';
          parsed.forEach(function(g){ summary += '  ' + (g.key||'?') + ': ' + (g.fields||[]).length + ' fields\n'; });
        } else if (typeof parsed === 'object') {
          var keys = Object.keys(parsed);
          summary += keys.length + ' category keys:\n';
          keys.forEach(function(k){ summary += '  ' + k + ': ' + (Array.isArray(parsed[k]) ? parsed[k].length : '?') + ' fields\n'; });
        }
      } catch(e) { summary += 'Raw: ' + val.slice(0,300); }
      alert(summary);
    });
}

/* ‚îÄ‚îÄ Upsert pairs ‚Äî works after UNIQUE constraint added to key column ‚îÄ‚îÄ */
function regUpsertAll(pairs, cb) {
  sb.auth.getSession().then(function(sessionRes) {
    var session = sessionRes.data && sessionRes.data.session;
    var token   = session && session.access_token;
    if (!token) { cb('Not authenticated ‚Äî log in to admin first'); return; }
    var client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      global: { headers: { Authorization: 'Bearer ' + token } }
    });
    var now  = new Date().toISOString();
    var rows = pairs.map(function(p) {
      return { key: p.key, value: String(p.value), updated_at: now };
    });
    var chain = Promise.resolve();
    rows.forEach(function(row) {
      chain = chain.then(function() {
        return client.from('admin_config').upsert(row, { onConflict: 'key' });
      });
    });
    chain.then(function() { cb(null); })
         .catch(function(e) { cb(e.message || String(e)); });
  }).catch(function(e) { cb('Auth error: ' + (e.message || String(e))); });
}

function regMakeVersion() {
  var now = new Date();
  return 'v' + now.getFullYear().toString().slice(2) + '.' +
    String(now.getMonth()+1).padStart(2,'0') + '.' +
    String(now.getDate()).padStart(2,'0') + '.' +
    String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');
}

/* ‚îÄ‚îÄ Download Excel (generates from current REG_LIVE data via SheetJS) ‚îÄ‚îÄ */
function regDownloadExcel() {
  if (typeof XLSX === 'undefined') { alert('SheetJS not loaded'); return; }
  var xlwb = XLSX.utils.book_new();
  var headers = ['Section','','Field Label','Field Key','Type','Options (/ separated)'];

  function makeSheet(fields) {
    var rows = [headers];
    var lastSec = null;
    fields.forEach(function(f) {
      var sec = f.section||f.group||'';
      if (sec !== lastSec) { rows.push([sec,'','','','','']); lastSec = sec; }
      var opts = Array.isArray(f.opts) ? f.opts.filter(Boolean).join(' / ') : (f.opts||'');
      rows.push(['', '', f.label||f.lbl||'', f.id||f.field||'', f.type||'text', opts]);
    });
    return XLSX.utils.aoa_to_sheet(rows);
  }

  // Category sheets
  try {
    var reg = JSON.parse(REG_LIVE['field_registry'] || '{}');
    Object.keys(CAT_TO_KEY).forEach(function(catName) {
      var catKey = CAT_TO_KEY[catName];
      var fields = reg[catKey] || [];
      XLSX.utils.book_append_sheet(xlwb, makeSheet(fields), catName.slice(0,31));
    });
  } catch(e) {}

  // Builder sheets
  var builders = [
    ['Design Arrays',         'reg_design_arrays'],
    ['Construction Crews',    'reg_crews'],
    ['Components',            'reg_components'],
    ['Suppliers',             'reg_suppliers'],
    ['Equipment',             'reg_equipment'],
  ];
  builders.forEach(function(b) {
    try {
      var data = JSON.parse(REG_LIVE[b[1]] || '[]');
      var flat = [];
      if (data.length && data[0].fields) {
        data.forEach(function(g) {
          (g.fields||[]).forEach(function(f) { flat.push(Object.assign({},f,{section:g.key})); });
        });
      } else { flat = data; }
      XLSX.utils.book_append_sheet(xlwb, makeSheet(flat), b[0]);
    } catch(e) {}
  });

  XLSX.writeFile(xlwb, 'SunHash_Field_Registry_' + regMakeVersion() + '.xlsx');
}

/* ‚îÄ‚îÄ Excel Upload (secondary path) ‚îÄ‚îÄ */
function regDragOver(e)  { e.preventDefault(); document.getElementById('reg-drop-zone').classList.add('drag-over'); }
function regDragLeave()  { document.getElementById('reg-drop-zone').classList.remove('drag-over'); }
function regDrop(e) {
  e.preventDefault();
  document.getElementById('reg-drop-zone').classList.remove('drag-over');
  var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) parseRegistryFile(f);
}
function regFileSelected(input) {
  var f = input && input.files && input.files[0];
  if (f) parseRegistryFile(f);
}

var parsedRegistry = null;

function parseRegistryFile(file) {
  document.getElementById('reg-warn').className       = 'reg-warn';
  document.getElementById('reg-warn').textContent     = '';
  document.getElementById('reg-preview').style.display  = 'none';
  document.getElementById('reg-parse-status').style.display = 'none';
  document.getElementById('reg-publish-btn').style.display  = 'none';
  parsedRegistry = null;

  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var xlwb  = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
      var payload = { categories:{}, builders:{}, total_fields:0, total_sheets:0 };
      var preview = [];

      xlwb.SheetNames.forEach(function(sn) {
        if (sn === 'INDEX') return;
        var ws   = xlwb.Sheets[sn];
        var rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });

        // Find header row (contains "Field Label" in any cell)
        var hdr = -1;
        for (var i=0; i<Math.min(6,rows.length); i++) {
          if (rows[i].some(function(c){ return String(c).trim()==='Field Label'; })) { hdr=i; break; }
        }
        if (hdr<0) return;

        var fields=[], groups=[], curGroup=null, curSec='';
        for (var r=hdr+1; r<rows.length; r++) {
          var row = rows[r];
          var c0  = String(row[0]||'').trim();
          var c2  = String(row[2]||'').trim();
          var c3  = String(row[3]||'').trim();
          var c4  = String(row[4]||'').trim().toLowerCase();
          var c5  = String(row[5]||'').trim();
          if (!c2 && !c3) {
            // Section/group header ‚Äî any non-empty cell in col 0 or merged col
            var hdrText = c0 || String(row[1]||'').trim();
            if (hdrText) {
              var keyMatch = hdrText.match(/\[(?:type|key)=([^\]]+)\]/);
              curSec = keyMatch ? keyMatch[1].trim() : hdrText.replace(/\s*\[.*?\]\s*/g,'').trim();
              curGroup = { key: curSec, fields: [] };
              groups.push(curGroup);
            }
            continue;
          }
          if (!c3 || c3==='Field Key'||c3==='tally_fields Key'||c3==='field key') continue;
          var opts=[];
          if (c4==='select'&&c5) opts=[''].concat(c5.split('/').map(function(o){return o.trim();}).filter(Boolean));
          var field = { id:c3, field:c3, label:c2, lbl:c2, type:c4||'text', opts:opts, section:curSec };
          fields.push(field);
          if (curGroup) curGroup.fields.push(field);
          else { if (!curGroup){curGroup={key:'General',fields:[]};groups.push(curGroup);} curGroup.fields.push(field); }
        }

        payload.total_fields += fields.length;
        payload.total_sheets++;

        var catKey = SHEET_TO_CAT[sn];
        if (catKey) {
          payload.categories[catKey] = fields;
          preview.push({ sheet:sn, count:fields.length, type:'Category spec' });
          return;
        }
        var snl = sn.toLowerCase().replace(/[^a-z ]/g,'').trim();
        var bMap = { 'design arrays':'reg_design_arrays','construction crews':'reg_crews',
                     'procurement contracts':'reg_procurement_contracts','components':'reg_components',
                     'suppliers':'reg_suppliers','equipment':'reg_equipment' };
        var bKey = bMap[snl];
        if (bKey) {
          payload.builders[bKey] = groups.length ? groups : fields;
          preview.push({ sheet:sn, count:fields.length, type:bKey });
        }
      });

      if (!preview.length) {
        document.getElementById('reg-warn').textContent='No recognised sheets found. Check sheet names match exactly.';
        document.getElementById('reg-warn').className='reg-warn show'; return;
      }

      parsedRegistry = payload;

      var st = document.getElementById('reg-parse-status');
      st.style.display=''; st.className='fr-status-bar ok';
      document.getElementById('reg-parse-msg').textContent = payload.total_sheets+' sheets ¬∑ '+payload.total_fields+' fields';
      document.getElementById('reg-preview-body').innerHTML = preview.map(function(p){
        return '<div style="font-size:11px;color:#aaa;padding:3px 0;">‚úì <strong style="color:#FFFF00;">'+escAdm(p.sheet)+'</strong> ‚Äî '+p.count+' fields</div>';
      }).join('');
      document.getElementById('reg-preview').style.display='block';
      document.getElementById('reg-publish-btn').style.display='inline-block';

    } catch(err) {
      document.getElementById('reg-warn').textContent='Parse error: '+err.message;
      document.getElementById('reg-warn').className='reg-warn show';
    }
  };
  reader.readAsArrayBuffer(file);
}

function publishRegistry() {
  if (!parsedRegistry) return;
  var btn = document.getElementById('reg-publish-btn');
  btn.disabled=true; btn.textContent='Publishing‚Ä¶';

  var version = regMakeVersion();
  var now     = new Date().toISOString();
  var pairs   = [];

  // Category flat registry
  var reg = {};
  try { reg = JSON.parse(REG_LIVE['field_registry']||'{}'); } catch(e){}
  Object.keys(parsedRegistry.categories||{}).forEach(function(k){ reg[k]=parsedRegistry.categories[k]; });
  pairs.push({ key:'field_registry', value:JSON.stringify(reg) });

  // Builder data
  Object.keys(parsedRegistry.builders||{}).forEach(function(k) {
    pairs.push({ key:k, value:JSON.stringify(parsedRegistry.builders[k]) });
    REG_LIVE[k] = JSON.stringify(parsedRegistry.builders[k]);
  });
  REG_LIVE['field_registry'] = JSON.stringify(reg);

  pairs.push({ key:'field_registry_version', value:version });
  pairs.push({ key:'field_registry_date',    value:now });
  pairs.push({ key:'field_registry_meta',    value:JSON.stringify({ version:version, total_sheets:parsedRegistry.total_sheets, total_fields:parsedRegistry.total_fields, published_at:now }) });

  regUpsertAll(pairs, function(err) {
    btn.disabled=false; btn.textContent='‚¨Ü Publish Registry';
    if (err) { alert('Publish failed: '+err); return; }
    loadRegistryStatus();
    var msg=document.getElementById('reg-save-msg');
    if(msg){msg.textContent='Published ‚úì';msg.style.color='#2ecc71';msg.style.opacity=1;setTimeout(function(){msg.style.opacity=0;},2500);}
  });
}

/* ‚îÄ‚îÄ Query Supabase raw ‚îÄ‚îÄ */
function regQuerySupabase() {
  var out  = document.getElementById('reg-supabase-out');
  var json = document.getElementById('reg-supabase-json');
  out.style.display='block';
  json.textContent='Loading‚Ä¶';
  sb.from('admin_config').select('key,value,updated_at')
    .in('key', ALL_REG_KEYS.concat(['field_registry_version','field_registry_date']))
    .then(function(res) {
      if (res.error) { json.textContent='Error: '+res.error.message; return; }
      var out2={};
      (res.data||[]).forEach(function(r){
        try { out2[r.key]={ updated:r.updated_at, data:JSON.parse(r.value) }; }
        catch(e){ out2[r.key]={ updated:r.updated_at, raw:r.value }; }
      });
      json.textContent=JSON.stringify(out2,null,2);
    });
}

/* ‚îÄ‚îÄ Status bar ‚îÄ‚îÄ */
function loadRegistryStatus() {
  sb.from('admin_config').select('key,value')
    .in('key',['field_registry_version','field_registry_date','field_registry_meta'])
    .then(function(res) {
      if (res.error||!res.data) return;
      var map={};
      res.data.forEach(function(r){ map[r.key]=r.value; });
      var ver  = map['field_registry_version']||'‚Äî';
      var date = map['field_registry_date'] ? new Date(map['field_registry_date']).toLocaleString() : '‚Äî';
      var vEl=document.getElementById('reg-cur-version');
      var dEl=document.getElementById('reg-cur-date');
      if(vEl) vEl.innerHTML = ver!=='‚Äî' ? '<span class="reg-version-badge">'+ver+'</span>' : '‚Äî';
      if(dEl) dEl.textContent = date;
    });
}

/* ‚îÄ‚îÄ Hook: load data when panel opens, open first tab ‚îÄ‚îÄ */
var _origShowPanelReg = showPanel;
showPanel = function(id) {
  _origShowPanelReg.call(this, id);
  if (id === 'registry') {
    loadRegistryStatus();
    loadRegistryFromDB(function() {
      regShowTab('cat', 'Design & Engineering');
    });
  }
};


/* ================================================================
   SCORE WEIGHTS ‚Äî download template, upload rules, publish version
   ================================================================ */

var swParsed = null;

// Load status on panel open
var _origShowPanelSW = showPanel;
showPanel = function(id) {
  _origShowPanelSW.call(this, id);
  if (id === 'scoring_rules') swLoadStatus();
};

function swLoadStatus() {
  sb.from('admin_config').select('key,value')
    .in('key', ['scoring_rules_version', 'scoring_rules_date', 'scoring_rules'])
    .then(function(res) {
      if (res.error || !res.data) return;
      var map = {};
      res.data.forEach(function(r) { map[r.key] = r.value; });
      var ver  = map['scoring_rules_version'];
      var date = map['scoring_rules_date'];
      var el   = document.getElementById('sw-current-status');
      var txt  = document.getElementById('sw-status-text');
      var bdg  = document.getElementById('sw-version-badge');
      if (!el) return;
      if (ver) {
        el.className = 'fr-status-bar ok';
        txt.textContent = 'Scoring rules ' + ver + ' active ¬∑ published ' +
          new Date(date).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
        bdg.textContent = ver;
        bdg.style.display = 'inline-block';
      } else {
        el.className = 'fr-status-bar none';
        txt.textContent = 'No scoring rules uploaded yet ‚Äî default weights are active.';
        bdg.style.display = 'none';
      }
    });
}

/* Build and download scoring template using current field registry */
function swDownloadTemplate() {
  document.getElementById('sw-dl-hint').textContent = 'Loading registry‚Ä¶';

  Promise.all([
    sb.from('admin_config').select('value').eq('key','field_registry').single(),
    sb.from('admin_config').select('value').eq('key','scoring_rules').single()
  ]).then(function(results) {
    var regRes  = results[0];
    var rulesRes = results[1];

    var flat = {};
    if (!regRes.error && regRes.data) {
      try { flat = JSON.parse(regRes.data.value); } catch(e) {}
    }

    // Load existing rules for pre-filling weights
    var existingRules = {};
    if (!rulesRes.error && rulesRes.data) {
      try {
        var rules = JSON.parse(rulesRes.data.value);
        (rules.rules || rules).forEach && (rules.rules || rules).forEach(function(r){
          existingRules[r.field_id] = r;
        });
      } catch(e) {}
    }

    // Build CSV rows
    var rows = [['field_id','field_label','category','section','weight','logic','threshold','direction','notes']];

    var CAT_LABELS = {
      score_permit:'Permits', score_design:'Design', score_construct:'Construction',
      score_procurement:'Procurement', score_contract:'Legal',
      score_intercon:'Grid Connection', score_financial:'Finance'
    };

    Object.keys(flat).forEach(function(catKey) {
      var fields = flat[catKey] || [];
      fields.forEach(function(f) {
        var ex = existingRules[f.id] || {};
        rows.push([
          f.id,
          f.label,
          CAT_LABELS[catKey] || catKey,
          f.section || '',
          ex.weight     !== undefined ? ex.weight     : 1,
          ex.logic      || 'any',          // any | filled | equals | gte | lte | between
          ex.threshold  || '',             // value or "min,max" for between
          ex.direction  || 'higher_better',// higher_better | lower_better | neutral
          ex.notes      || ''
        ]);
      });
    });

    // Convert to CSV and trigger download
    var csv = rows.map(function(r) {
      return r.map(function(v) {
        var s = String(v === null || v === undefined ? '' : v);
        return (s.indexOf(',') >= 0 || s.indexOf('"') >= 0 || s.indexOf('\n') >= 0)
          ? '"' + s.replace(/"/g, '""') + '"' : s;
      }).join(',');
    }).join('\n');

    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href   = url;
    a.download = 'SunHash_Scoring_Rules.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    document.getElementById('sw-dl-hint').textContent = 'Downloaded ‚úì  ‚Äî edit and re-upload as .xlsx or .csv';
  });
}

function swHandleDrop(e) {
  e.preventDefault();
  document.getElementById('sw-drop-zone').classList.remove('drag');
  var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) swHandleFile(f);
}

function swHandleFile(file) {
  if (!file) return;
  var ext = file.name.split('.').pop().toLowerCase();
  if (ext !== 'xlsx' && ext !== 'csv') {
    alert('Please upload a .xlsx or .csv file');
    return;
  }
  document.getElementById('sw-preview-wrap').style.display = 'block';
  swSetStatus('none', 'Reading file‚Ä¶', '');

  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var rows;
      if (ext === 'csv') {
        // Parse CSV manually
        var text = e.target.result;
        var lines = text.split('\n').filter(function(l){ return l.trim(); });
        var headers = lines[0].split(',').map(function(h){ return h.trim().replace(/^"|"$/g,''); });
        rows = lines.slice(1).map(function(line) {
          // handle quoted commas
          var vals = []; var cur = ''; var inQ = false;
          for (var i=0;i<line.length;i++){
            var c=line[i];
            if(c==='"'){inQ=!inQ;}
            else if(c===','&&!inQ){vals.push(cur.replace(/^"|"$/g,'').replace(/""/g,'"'));cur='';}
            else{cur+=c;}
          }
          vals.push(cur.replace(/^"|"$/g,'').replace(/""/g,'"'));
          var obj = {};
          headers.forEach(function(h,i){ obj[h] = vals[i] !== undefined ? vals[i] : ''; });
          return obj;
        });
      } else {
        var data = new Uint8Array(e.target.result);
        var wb   = XLSX.read(data, { type: 'array' });
        rows     = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' });
      }

      // Validate
      if (!rows.length) { swSetStatus('error', 'File is empty.', ''); return; }
      var sample = rows[0];
      if (!('field_id' in sample)) { swSetStatus('error', 'Missing required column: field_id', ''); return; }
      if (!('weight' in sample))   { swSetStatus('error', 'Missing required column: weight', ''); return; }

      // Filter blank rows
      rows = rows.filter(function(r){ return String(r.field_id||'').trim(); });

      swParsed = rows;
      swSetStatus('ok', rows.length + ' rules parsed. Review and publish when ready.', rows.length + ' rules');

      // Preview
      document.getElementById('sw-preview-rows').innerHTML = rows.slice(0,40).map(function(r) {
        return '<div class="fr-preview-row" style="grid-template-columns:160px 1fr 80px 80px 80px;">' +
          '<span style="color:#7aa3f5;">' + escAdm(r.field_id) + '</span>' +
          '<span>' + escAdm(r.field_label||'') + '</span>' +
          '<span>' + escAdm(r.category||'') + '</span>' +
          '<span style="color:#FFFF00;">' + escAdm(String(r.weight)) + '</span>' +
          '<span>' + escAdm(r.logic||'any') + '</span>' +
          '</div>';
      }).join('');

      document.getElementById('sw-publish-btn').disabled = false;

    } catch(err) {
      swSetStatus('error', 'Parse error: ' + err.message, '');
    }
  };
  if (ext === 'csv') {
    reader.readAsText(file);
  } else {
    reader.readAsArrayBuffer(file);
  }
}

function swSetStatus(cls, msg, badge) {
  var el  = document.getElementById('sw-parse-status');
  var msgEl = document.getElementById('sw-parse-msg');
  var bdgEl = document.getElementById('sw-parse-badge');
  if (!el) return;
  el.className = 'fr-status-bar ' + cls;
  if (msgEl) msgEl.textContent = msg;
  if (bdgEl) { bdgEl.textContent = badge; bdgEl.style.display = badge ? 'inline-block' : 'none'; }
}

function swPublish() {
  if (!swParsed) return;
  var btn = document.getElementById('sw-publish-btn');
  btn.disabled = true;
  btn.textContent = 'Publishing‚Ä¶';

  var now     = new Date();
  var version = 'v' + now.getFullYear().toString().slice(2) + '.' +
    String(now.getMonth()+1).padStart(2,'0') + '.' +
    String(now.getDate()).padStart(2,'0') + '.' +
    String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');

  var payload = {
    version:    version,
    published_at: now.toISOString(),
    total_rules:  swParsed.length,
    rules: swParsed.map(function(r) {
      return {
        field_id:  String(r.field_id  || '').trim(),
        field_label: String(r.field_label || '').trim(),
        category:  String(r.category  || '').trim(),
        section:   String(r.section   || '').trim(),
        weight:    parseFloat(r.weight) || 1,
        logic:     String(r.logic     || 'any').trim(),
        threshold: String(r.threshold || '').trim(),
        direction: String(r.direction || 'higher_better').trim(),
        notes:     String(r.notes     || '').trim(),
      };
    })
  };

  var rows = [
    { key: 'scoring_rules',         value: JSON.stringify(payload),  updated_at: now.toISOString() },
    { key: 'scoring_rules_version', value: version,                  updated_at: now.toISOString() },
    { key: 'scoring_rules_date',    value: now.toISOString(),        updated_at: now.toISOString() },
  ];

  sb.auth.getSession().then(function(sessionRes) {
    var token  = sessionRes.data && sessionRes.data.session && sessionRes.data.session.access_token;
    var client = token
      ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { global: { headers: { Authorization: 'Bearer ' + token } } })
      : sb;

    var chain = Promise.resolve();
    rows.forEach(function(row) {
      chain = chain.then(function() {
        return client.from('admin_config').insert(row);
      });
    });
    chain.then(function() {
      var msg = document.getElementById('sw-save-msg');
      if (msg) { msg.style.opacity = 1; setTimeout(function(){ msg.style.opacity = 0; }, 2500); }
      swLoadStatus();
      swCancel();
      btn.disabled = false;
      btn.textContent = '‚úì Publish Scoring Rules';
    }).catch(function(e) {
      alert('Publish failed: ' + e.message);
      btn.disabled = false;
      btn.textContent = '‚úì Publish Scoring Rules';
    });
  });
}

function swCancel() {
  swParsed = null;
  document.getElementById('sw-preview-wrap').style.display = 'none';
  document.getElementById('sw-file-input').value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCORE WEIGHTS ‚Äî field-level scoring UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

var SW_WEIGHTS = {};   // { [catKey]: { fields: { [fieldId]: {pts, gpt} }, catGpt: '' } }
var SW_CURRENT_CAT = 'score_design';

var CAT_LABELS = {
  score_design:     'Design & Engineering',
  score_construct:  'Construction',
  score_permit:     'Permitting',
  score_procurement:'Procurement',
  score_contract:   'Legal & Contract',
  score_intercon:   'Grid Interconnection',
  score_financial:  'Financial',
};

// Triggered when panel opens
var _swPanelHooked = false;
(function() {
  var _origSW = showPanel;
  showPanel = function(id) {
    _origSW.call(this, id);
    if (id === 'scoring_rules') { swInitWeights(); }
  };
})();

function swInitWeights() {
  // Load saved weights + registry in parallel
  Promise.all([
    sb.from('admin_config').select('value').eq('key','scoring_weights').single(),
    sb.from('admin_config').select('value').eq('key','field_registry').single(),
  ]).then(function(results) {
    var weightsRow = results[0].data;
    var regRow     = results[1].data;
    try { SW_WEIGHTS = weightsRow && weightsRow.value ? JSON.parse(weightsRow.value) : {}; } catch(e) { SW_WEIGHTS = {}; }
    var reg = {};
    try { reg = regRow && regRow.value ? JSON.parse(regRow.value) : {}; } catch(e) {}
    // Also pull from REG_LIVE if available
    if (!regRow || !regRow.value) {
      try { reg = JSON.parse(REG_LIVE['field_registry'] || '{}'); } catch(e) {}
    }
    window._SW_REG = reg;
    swShowCat(SW_CURRENT_CAT, document.querySelector('.sw-cat-btn.active'));
  });
}

function swShowCat(catKey, btn) {
  SW_CURRENT_CAT = catKey;
  // Button highlight
  document.querySelectorAll('.sw-cat-btn').forEach(function(b) { b.classList.remove('active'); });
  if (btn) btn.classList.add('active');

  // Set title
  document.getElementById('sw-cat-title').textContent = CAT_LABELS[catKey] || catKey;

  // Load category-level GPT instruction
  var catData = SW_WEIGHTS[catKey] || {};
  var catGptEl = document.getElementById('sw-cat-gpt');
  if (catGptEl) catGptEl.value = catData.catGpt || '';

  // Get fields for this category from registry
  var reg = window._SW_REG || {};
  var fields = reg[catKey] || [];

  if (!fields.length) {
    document.getElementById('sw-fields-wrap').innerHTML = '<div class="sw-empty">No fields found in registry for this category. Load the Field Registry first.</div>';
    document.getElementById('sw-total-pts').textContent = '0';
    document.getElementById('sw-field-count').textContent = '0';
    return;
  }

  // Group fields by section
  var sections = {};
  var sectionOrder = [];
  fields.forEach(function(f) {
    var sec = f.section || f.lbl || 'General';
    if (!sections[sec]) { sections[sec] = []; sectionOrder.push(sec); }
    sections[sec].push(f);
  });
  // Dedupe section order
  sectionOrder = sectionOrder.filter(function(v,i,a) { return a.indexOf(v) === i; });

  var catFields = catData.fields || {};

  var html = '';
  sectionOrder.forEach(function(sec) {
    html += '<div class="sw-section-hdr">' + escAdm(sec) + '</div>';
    sections[sec].forEach(function(f) {
      var fid = f.id || f.field;
      var saved = catFields[fid] || {};
      var pts  = saved.pts !== undefined ? saved.pts : '';
      var gpt  = saved.gpt || '';
      html += '<div class="sw-field-row" data-fid="' + escAdm(fid) + '">';
      html += '<div class="sw-field-header">';
      html += '<div class="sw-field-lbl">' + escAdm(f.lbl || f.label || fid) + '</div>';
      html += '<span class="sw-field-key">' + escAdm(fid) + '</span>';
      html += '<span class="sw-field-type">' + escAdm(f.type || 'text') + '</span>';
      html += '</div>';
      html += '<div class="sw-field-body">';
      html += '<div class="sw-pts-wrap"><div class="sw-pts-label">Points</div>';
      html += '<input type="number" class="sw-pts-input" data-fid="' + escAdm(fid) + '" value="' + escAdm(String(pts)) + '" min="0" max="100" placeholder="0" oninput="swUpdateTotals()"/>';
      html += '</div>';
      html += '<div class="sw-gpt-wrap"><div class="sw-gpt-label">GPT Weighting Instructions</div>';
      html += '<textarea class="sw-gpt-input" data-fid="' + escAdm(fid) + '" placeholder="How should GPT weight this field? E.g. \'If contract type = turnkey, treat procurement delays as HIGH risk. If split contract, assess each party separately. If blank, default to medium risk.\'">' + escAdm(gpt) + '</textarea>';
      html += '</div>';
      html += '</div></div>';
    });
  });

  document.getElementById('sw-fields-wrap').innerHTML = html;
  document.getElementById('sw-field-count').textContent = fields.length;
  swUpdateTotals();
}

function swUpdateTotals() {
  var total = 0;
  document.querySelectorAll('.sw-pts-input').forEach(function(inp) {
    total += parseFloat(inp.value || 0) || 0;
  });
  var el = document.getElementById('sw-total-pts');
  if (el) el.textContent = total;
}

function swSaveWeights() {
  // Collect current category data from DOM
  if (!SW_WEIGHTS[SW_CURRENT_CAT]) SW_WEIGHTS[SW_CURRENT_CAT] = { catGpt: '', fields: {} };
  var catGptEl = document.getElementById('sw-cat-gpt');
  SW_WEIGHTS[SW_CURRENT_CAT].catGpt = catGptEl ? catGptEl.value.trim() : '';
  SW_WEIGHTS[SW_CURRENT_CAT].fields = {};

  document.querySelectorAll('.sw-pts-input').forEach(function(inp) {
    var fid = inp.getAttribute('data-fid');
    if (!fid) return;
    if (!SW_WEIGHTS[SW_CURRENT_CAT].fields[fid]) SW_WEIGHTS[SW_CURRENT_CAT].fields[fid] = {};
    SW_WEIGHTS[SW_CURRENT_CAT].fields[fid].pts = parseFloat(inp.value || 0) || 0;
  });
  document.querySelectorAll('.sw-gpt-input').forEach(function(ta) {
    var fid = ta.getAttribute('data-fid');
    if (!fid) return;
    if (!SW_WEIGHTS[SW_CURRENT_CAT].fields[fid]) SW_WEIGHTS[SW_CURRENT_CAT].fields[fid] = {};
    SW_WEIGHTS[SW_CURRENT_CAT].fields[fid].gpt = ta.value.trim();
  });

  saveConfig({ scoring_weights: JSON.stringify(SW_WEIGHTS) }, 'sw-save-msg2');
}

</script>
</body>
</html>
