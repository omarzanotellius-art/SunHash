<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #0f1117; color: #e0e0e0; min-height: 100vh; }

/* Login screen */
.login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
.login-box { background: #1a1f2e; border-radius: 16px; padding: 36px 32px; width: 360px; box-shadow: 0 8px 40px rgba(0,0,0,0.4); }
.login-logo { font-size: 22px; font-weight: 900; text-transform: uppercase; color: #fff; margin-bottom: 4px; }
.login-logo span { color: #FFFF00; }
.login-sub { font-size: 11px; color: #444; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 28px; }
.login-field { margin-bottom: 14px; }
.login-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #666; margin-bottom: 5px; display: block; }
.login-input { width: 100%; padding: 10px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 13px; color: #fff; outline: none; }
.login-input:focus { border-color: #FFFF00; }
.login-btn { width: 100%; padding: 12px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 8px; margin-top: 8px; }
.login-btn:hover { background: #fff; }
.login-err { font-size: 12px; color: #e74c3c; margin-top: 10px; text-align: center; display: none; }

/* Admin layout */
.admin-screen { display: none; }
.topbar { height: 52px; background: #111; border-bottom: 2px solid #FFFF00; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; position: fixed; top: 0; left: 0; right: 0; z-index: 10; }
.topbar-logo { font-size: 18px; font-weight: 900; text-transform: uppercase; color: #fff; }
.topbar-logo span { color: #FFFF00; }
.topbar-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; background: #FFFF00; color: #1a1f2e; padding: 2px 8px; border-radius: 20px; margin-left: 8px; }
.topbar-right { display: flex; align-items: center; gap: 12px; }
.topbar-lock { font-size: 11px; color: #555; cursor: pointer; }
.topbar-lock:hover { color: #e74c3c; }

.admin-body { padding-top: 52px; display: flex; min-height: 100vh; }

/* Sidebar nav */
.admin-nav { width: 200px; background: #111; padding: 20px 0; position: fixed; top: 52px; bottom: 0; display: flex; flex-direction: column; gap: 2px; border-right: 1px solid #1e1e1e; }
.nav-item { padding: 10px 20px; font-size: 12px; font-weight: 600; color: #555; cursor: pointer; text-transform: uppercase; letter-spacing: 0.3px; transition: all .12s; border-left: 3px solid transparent; }
.nav-item:hover { color: #aaa; background: rgba(255,255,255,0.03); }
.nav-item.active { color: #FFFF00; border-left-color: #FFFF00; background: rgba(255,255,0,0.04); }
.nav-section { padding: 16px 20px 6px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #333; }

/* Main content */
.admin-main { margin-left: 200px; flex: 1; padding: 28px 32px; }
.admin-panel { display: none; }
.admin-panel.active { display: block; }
.panel-title { font-size: 20px; font-weight: 900; color: #fff; margin-bottom: 4px; }
.panel-sub { font-size: 12px; color: #555; margin-bottom: 24px; }

/* Cards */
.admin-card { background: #1a1f2e; border-radius: 12px; padding: 20px 22px; margin-bottom: 16px; }
.admin-card-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #FFFF00; opacity: 0.7; margin-bottom: 14px; }
.field-row { margin-bottom: 14px; }
.field-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #666; margin-bottom: 5px; display: block; }
.field-input { width: 100%; padding: 9px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; transition: border-color .12s; }
.field-input:focus { border-color: #FFFF00; }
.field-textarea { width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; resize: vertical; min-height: 120px; line-height: 1.6; transition: border-color .12s; }
.field-textarea:focus { border-color: #FFFF00; }
.field-hint { font-size: 10px; color: #444; margin-top: 4px; }
.save-btn { padding: 9px 22px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.save-btn:hover { background: #fff; }
.save-msg { font-size: 11px; color: #2e7d4f; margin-left: 12px; opacity: 0; transition: opacity .3s; display: inline-block; }
.save-msg.show { opacity: 1; }

/* Score config */
.score-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.threshold-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.threshold-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.threshold-label { font-size: 11px; color: #aaa; width: 60px; }
.threshold-input { width: 70px; padding: 5px 9px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; text-align: center; }
.threshold-suffix { font-size: 11px; color: #555; }

/* User table */
.user-table { width: 100%; border-collapse: collapse; }
.user-table th { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #555; padding: 8px 12px; text-align: left; border-bottom: 1px solid #222; }
.user-table td { font-size: 12px; color: #aaa; padding: 10px 12px; border-bottom: 1px solid #1a1a1a; }
.user-table tr:hover td { background: rgba(255,255,255,0.02); }
.user-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 2px 8px; border-radius: 20px; }
.user-badge.pro { background: rgba(255,255,0,0.15); color: #FFFF00; }
.user-badge.free { background: rgba(255,255,255,0.06); color: #666; }
.user-count { font-size: 24px; font-weight: 900; color: #fff; }
.user-count-lbl { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 0.4px; margin-top: 2px; }
.stats-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 20px; }
.stat-box { background: #1a1f2e; border-radius: 10px; padding: 14px 16px; }
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">Sun<span>Hash</span></div>
    <div class="login-sub">Admin Panel</div>
    <div class="login-field">
      <label class="login-label">Username</label>
      <input class="login-input" id="adm-user" type="text" autocomplete="off" onkeydown="if(event.key==='Enter')adminLogin()"/>
    </div>
    <div class="login-field">
      <label class="login-label">Password</label>
      <input class="login-input" id="adm-pass" type="password" onkeydown="if(event.key==='Enter')adminLogin()"/>
    </div>
    <button class="login-btn" onclick="adminLogin()">Enter Admin</button>
    <div class="login-err" id="login-err">Invalid credentials</div>
  </div>
</div>

<!-- ADMIN -->
<div class="admin-screen" id="admin-screen">
  <div class="topbar">
    <div style="display:flex;align-items:center;">
      <span class="topbar-logo">Sun<span>Hash</span></span>
      <span class="topbar-badge">Admin</span>
    </div>
    <div class="topbar-right">
      <span class="topbar-lock" onclick="adminLogout()">&#128274; Lock</span>
    </div>
  </div>

  <div class="admin-body">
    <div class="admin-nav">
      <div class="nav-section">Content</div>
      <div class="nav-item active" onclick="showPanel('terms')">Terms & Conditions</div>
      <div class="nav-section">AI Configuration</div>
      <div class="nav-item" onclick="showPanel('prompts')">GPT Prompts</div>
      <div class="nav-section">Scoring</div>
      <div class="nav-item" onclick="showPanel('scoring')">Score Thresholds</div>
      <div class="nav-item" onclick="showPanel('required')">Required Fields</div>
      <div class="nav-section">Users</div>
      <div class="nav-item" onclick="showPanel('users')">User Management</div>
      <div class="nav-section">Security</div>
      <div class="nav-item" onclick="showPanel('credentials')">Admin Credentials</div>
    </div>

    <div class="admin-main">

      <!-- TERMS -->
      <div class="admin-panel active" id="panel-terms">
        <div class="panel-title">Terms & Conditions</div>
        <div class="panel-sub">This text is shown to users at signup. Update the version number when making significant changes.</div>
        <div class="admin-card">
          <div class="admin-card-title">Current T&C</div>
          <div class="field-row">
            <label class="field-label">Version</label>
            <input class="field-input" id="terms-version" type="text" style="width:120px;" placeholder="e.g. 1.0"/>
          </div>
          <div class="field-row">
            <label class="field-label">Terms Text</label>
            <textarea class="field-textarea" id="terms-text" style="min-height:200px;" placeholder="Enter your terms and conditions text..."></textarea>
            <div class="field-hint">Plain text. Line breaks are preserved.</div>
          </div>
          <button class="save-btn" onclick="saveTerms()">Save Terms</button>
          <span class="save-msg" id="msg-terms">Saved</span>
        </div>
      </div>

      <!-- PROMPTS -->
      <div class="admin-panel" id="panel-prompts">
        <div class="panel-title">GPT Prompts</div>
        <div class="panel-sub">System prompts sent to OpenAI. Changes take effect immediately on next AI request.</div>
        <div class="admin-card">
          <div class="admin-card-title">Project Brief Prompt (generate-overview)</div>
          <div class="field-row">
            <textarea class="field-textarea" id="prompt-overview" style="min-height:150px;"></textarea>
            <div class="field-hint">Injected as the system prompt when generating the AI project brief on the overview page.</div>
          </div>
          <button class="save-btn" onclick="savePrompt('overview')">Save</button>
          <span class="save-msg" id="msg-prompt-overview">Saved</span>
        </div>
        <div class="admin-card">
          <div class="admin-card-title">Category Q&A Prompt (category-qa)</div>
          <div class="field-row">
            <textarea class="field-textarea" id="prompt-category-qa" style="min-height:150px;"></textarea>
            <div class="field-hint">Injected as the system prompt when users ask questions about a specific category in the detail panel.</div>
          </div>
          <button class="save-btn" onclick="savePrompt('category_qa')">Save</button>
          <span class="save-msg" id="msg-prompt-category_qa">Saved</span>
        </div>
      </div>

      <!-- SCORING -->
      <div class="admin-panel" id="panel-scoring">
        <div class="panel-title">Score Thresholds</div>
        <div class="panel-sub">Define the score boundaries for red, yellow, and green status across all categories and the timeline.</div>
        <div class="admin-card">
          <div class="admin-card-title">Category Score Colours</div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#2e7d4f;"></div>
            <span class="threshold-label">Green above</span>
            <input class="threshold-input" id="score-green" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#e07b20;"></div>
            <span class="threshold-label">Yellow above</span>
            <input class="threshold-input" id="score-yellow" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#c0392b;"></div>
            <span class="threshold-label">Red below</span>
            <span style="font-size:11px;color:#555;" id="score-red-label">--</span>
          </div>
          <button class="save-btn" onclick="saveScoreThresholds()">Save</button>
          <span class="save-msg" id="msg-scoring">Saved</span>
        </div>
        <div class="admin-card">
          <div class="admin-card-title">Timeline Milestone Thresholds (based on Permit score)</div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#2e7d4f;"></div>
            <span class="threshold-label">Green above</span>
            <input class="threshold-input" id="tl-green" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#e07b20;"></div>
            <span class="threshold-label">Yellow above</span>
            <input class="threshold-input" id="tl-yellow" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <button class="save-btn" onclick="saveTimelineThresholds()">Save</button>
          <span class="save-msg" id="msg-timeline">Saved</span>
        </div>
      </div>

      <!-- REQUIRED FIELDS -->
      <div class="admin-panel" id="panel-required">
        <div class="panel-title">Required Fields</div>
        <div class="panel-sub">Comma-separated field keys for each category. Used to calculate the completeness indicator on each button.</div>
        <div class="admin-card">
          <div class="admin-card-title">Per-Category Required Fields</div>
          <div id="required-fields-body"></div>
          <button class="save-btn" onclick="saveRequiredFields()">Save All</button>
          <span class="save-msg" id="msg-required">Saved</span>
        </div>
      </div>

      <!-- USERS -->
      <div class="admin-panel" id="panel-users">
        <div class="panel-title">User Management</div>
        <div class="panel-sub">All registered accounts. Subscription status reflects latest Stripe sync.</div>
        <div class="stats-row" id="user-stats"></div>
        <div class="admin-card">
          <div class="admin-card-title">All Users</div>
          <table class="user-table">
            <thead><tr><th>Email</th><th>Joined</th><th>Plan</th><th>T&C Accepted</th><th>Projects</th></tr></thead>
            <tbody id="user-table-body"><tr><td colspan="5" style="color:#444;text-align:center;padding:20px;">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- CREDENTIALS -->
      <div class="admin-panel" id="panel-credentials">
        <div class="panel-title">Admin Credentials</div>
        <div class="panel-sub">Change the username and password used to access this admin panel.</div>
        <div class="admin-card">
          <div class="admin-card-title">Update Login</div>
          <div class="field-row">
            <label class="field-label">New Username</label>
            <input class="field-input" id="new-username" type="text" style="max-width:300px;"/>
          </div>
          <div class="field-row">
            <label class="field-label">New Password</label>
            <input class="field-input" id="new-password" type="password" style="max-width:300px;"/>
          </div>
          <div class="field-row">
            <label class="field-label">Confirm Password</label>
            <input class="field-input" id="new-password2" type="password" style="max-width:300px;"/>
          </div>
          <button class="save-btn" onclick="saveCredentials()">Update Credentials</button>
          <span class="save-msg" id="msg-credentials">Updated</span>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

var CONFIG_KEYS = [
  "admin_username","admin_password","terms_text","terms_version",
  "prompt_overview","prompt_category_qa",
  "score_green_threshold","score_yellow_threshold",
  "timeline_permit_green","timeline_permit_yellow",
  "cat_required_design","cat_required_construct","cat_required_contract",
  "cat_required_intercon","cat_required_financial","cat_required_permit"
];

var config = {};
var CAT_LABELS = {
  design: "Design & Engineering", construct: "Construction",
  contract: "Legal & Contract", intercon: "Grid Interconnection",
  financial: "Financial", permit: "Permitting"
};

/* ---- AUTH ---- */
function adminLogin() {
  var user = document.getElementById("adm-user").value.trim();
  var pass = document.getElementById("adm-pass").value.trim();

  // Load config to verify credentials
  sb.from("admin_config").select("key,value").then(function(res) {
    if (res.error) { showLoginErr("Database error: " + res.error.message); return; }
    var cfg = {};
    (res.data || []).forEach(function(r) { cfg[r.key] = r.value; });

    var validUser = cfg["admin_username"] || "sunhash_admin";
    var validPass = cfg["admin_password"] || "SunHash2026!";

    if (user === validUser && pass === validPass) {
      config = cfg;
      sessionStorage.setItem("admin_auth", "1");
      showAdmin();
    } else {
      showLoginErr("Invalid credentials");
    }
  });
}

function showLoginErr(msg) {
  var el = document.getElementById("login-err");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(function() { el.style.display = "none"; }, 3000);
}

function adminLogout() {
  sessionStorage.removeItem("admin_auth");
  document.getElementById("admin-screen").style.display = "none";
  document.getElementById("login-screen").style.display = "flex";
  document.getElementById("adm-pass").value = "";
}

function showAdmin() {
  document.getElementById("login-screen").style.display = "none";
  document.getElementById("admin-screen").style.display = "block";
  populateFields();
  loadUsers();
}

// Check session on load
window.addEventListener("load", function() {
  if (sessionStorage.getItem("admin_auth") === "1") {
    sb.from("admin_config").select("key,value").then(function(res) {
      if (!res.error) {
        (res.data || []).forEach(function(r) { config[r.key] = r.value; });
        showAdmin();
      }
    });
  }
});

/* ---- NAVIGATION ---- */
function showPanel(id) {
  document.querySelectorAll(".admin-panel").forEach(function(p) { p.classList.remove("active"); });
  document.querySelectorAll(".nav-item").forEach(function(n) { n.classList.remove("active"); });
  document.getElementById("panel-" + id).classList.add("active");
  event.target.classList.add("active");
  if (id === "users") loadUsers();
}

/* ---- POPULATE ---- */
function populateFields() {
  setValue("terms-version",    config["terms_version"]         || "1.0");
  setValue("terms-text",       config["terms_text"]            || "");
  setValue("prompt-overview",  config["prompt_overview"]       || "");
  setValue("prompt-category-qa", config["prompt_category_qa"] || "");
  setValue("score-green",      config["score_green_threshold"] || "70");
  setValue("score-yellow",     config["score_yellow_threshold"]|| "40");
  setValue("tl-green",         config["timeline_permit_green"] || "70");
  setValue("tl-yellow",        config["timeline_permit_yellow"]|| "40");
  updateRedLabel();

  // Required fields per category
  var body = document.getElementById("required-fields-body");
  body.innerHTML = Object.keys(CAT_LABELS).map(function(cat) {
    var val = config["cat_required_" + cat] || "";
    return '<div class="field-row">' +
      '<label class="field-label">' + CAT_LABELS[cat] + '</label>' +
      '<input class="field-input" id="req-' + cat + '" type="text" value="' + val + '"/>' +
      '<div class="field-hint">Comma-separated field keys. Used for completeness indicator.</div>' +
    '</div>';
  }).join("");
}

function setValue(id, val) {
  var el = document.getElementById(id);
  if (el) el.value = val;
}

function updateRedLabel() {
  var y = document.getElementById("score-yellow");
  var lbl = document.getElementById("score-red-label");
  if (y && lbl) lbl.textContent = "Score below " + (y.value || "40");
}
document.addEventListener("input", function(e) {
  if (e.target.id === "score-yellow") updateRedLabel();
});

/* ---- SAVE FUNCTIONS ---- */
function saveConfig(updates, msgId) {
  var rows = Object.keys(updates).map(function(k) {
    return { key: k, value: String(updates[k]), updated_at: new Date().toISOString() };
  });
  var chain = Promise.resolve();
  rows.forEach(function(row) {
    chain = chain.then(function() {
      return sb.from("admin_config").upsert(row, { onConflict: "key" });
    });
  });
  chain.then(function() {
    Object.assign(config, updates);
    showMsg(msgId);
  }).catch(function(e) { alert("Save failed: " + e.message); });
}

function showMsg(id) {
  var el = document.getElementById(id);
  if (!el) return;
  el.classList.add("show");
  setTimeout(function() { el.classList.remove("show"); }, 2500);
}

function saveTerms() {
  saveConfig({
    terms_text:    document.getElementById("terms-text").value,
    terms_version: document.getElementById("terms-version").value
  }, "msg-terms");
}

function savePrompt(key) {
  var inputId = key === "overview" ? "prompt-overview" : "prompt-category-qa";
  var configKey = "prompt_" + key;
  var updates = {};
  updates[configKey] = document.getElementById(inputId).value;
  saveConfig(updates, "msg-prompt-" + key);
}

function saveScoreThresholds() {
  saveConfig({
    score_green_threshold:  document.getElementById("score-green").value,
    score_yellow_threshold: document.getElementById("score-yellow").value
  }, "msg-scoring");
}

function saveTimelineThresholds() {
  saveConfig({
    timeline_permit_green:  document.getElementById("tl-green").value,
    timeline_permit_yellow: document.getElementById("tl-yellow").value
  }, "msg-timeline");
}

function saveRequiredFields() {
  var updates = {};
  Object.keys(CAT_LABELS).forEach(function(cat) {
    var el = document.getElementById("req-" + cat);
    if (el) updates["cat_required_" + cat] = el.value.trim();
  });
  saveConfig(updates, "msg-required");
}

function saveCredentials() {
  var u  = document.getElementById("new-username").value.trim();
  var p  = document.getElementById("new-password").value;
  var p2 = document.getElementById("new-password2").value;
  if (!u || !p) { alert("Username and password required."); return; }
  if (p !== p2) { alert("Passwords do not match."); return; }
  saveConfig({ admin_username: u, admin_password: p }, "msg-credentials");
  document.getElementById("new-password").value  = "";
  document.getElementById("new-password2").value = "";
}

/* ---- USERS ---- */
function loadUsers() {
  sb.from("profiles").select("id, email, subscription_status, subscription_plan, terms_accepted_at, created_at")
    .order("created_at", { ascending: false })
    .then(function(res) {
      if (res.error) { console.error(res.error); return; }
      var users = res.data || [];
      var pro   = users.filter(function(u) { return u.subscription_status === "active"; }).length;
      var tac   = users.filter(function(u) { return u.terms_accepted_at; }).length;

      document.getElementById("user-stats").innerHTML =
        stat(users.length, "Total Users") +
        stat(pro, "Pro Subscribers") +
        stat(users.length - pro, "Free Users") +
        stat(tac, "T&C Accepted");

      // Load project counts
      sb.from("projects").select("user_id").then(function(pr) {
        var counts = {};
        (pr.data || []).forEach(function(p) { counts[p.user_id] = (counts[p.user_id] || 0) + 1; });

        document.getElementById("user-table-body").innerHTML = users.map(function(u) {
          var plan = u.subscription_status === "active"
            ? '<span class="user-badge pro">' + (u.subscription_plan || "Pro") + '</span>'
            : '<span class="user-badge free">Free</span>';
          var tac = u.terms_accepted_at
            ? new Date(u.terms_accepted_at).toLocaleDateString("en-GB")
            : '<span style="color:#444;">No</span>';
          var joined = new Date(u.created_at).toLocaleDateString("en-GB", {day:"2-digit",month:"short",year:"numeric"});
          return '<tr>' +
            '<td>' + (u.email || u.id.slice(0,8) + "...") + '</td>' +
            '<td>' + joined + '</td>' +
            '<td>' + plan + '</td>' +
            '<td>' + tac + '</td>' +
            '<td>' + (counts[u.id] || 0) + '</td>' +
            '</tr>';
        }).join("");
      });
    });
}

function stat(val, lbl) {
  return '<div class="stat-box"><div class="user-count">' + val + '</div><div class="user-count-lbl">' + lbl + '</div></div>';
}
</script>
</body>
</html>
