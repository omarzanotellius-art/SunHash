<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #0f1117; color: #e0e0e0; min-height: 100vh; }

/* Login screen */
.login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
.login-box { background: #1a1f2e; border-radius: 16px; padding: 36px 32px; width: 360px; box-shadow: 0 8px 40px rgba(0,0,0,0.4); }
.login-logo { font-size: 22px; font-weight: 900; text-transform: uppercase; color: #fff; margin-bottom: 4px; }
.login-logo span { color: #FFFF00; }
.login-sub { font-size: 11px; color: #444; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 28px; }
.login-field { margin-bottom: 14px; }
.login-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #666; margin-bottom: 5px; display: block; }
.login-input { width: 100%; padding: 10px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 13px; color: #fff; outline: none; }
.login-input:focus { border-color: #FFFF00; }
.login-btn { width: 100%; padding: 12px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 8px; margin-top: 8px; }
.login-btn:hover { background: #fff; }
.login-err { font-size: 12px; color: #e74c3c; margin-top: 10px; text-align: center; display: none; }

/* Admin layout */
.admin-screen { display: none; }
.topbar { height: 52px; background: #111; border-bottom: 2px solid #FFFF00; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; position: fixed; top: 0; left: 0; right: 0; z-index: 10; }
.topbar-logo { font-size: 18px; font-weight: 900; text-transform: uppercase; color: #fff; }
.topbar-logo span { color: #FFFF00; }
.topbar-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; background: #FFFF00; color: #1a1f2e; padding: 2px 8px; border-radius: 20px; margin-left: 8px; }
.topbar-right { display: flex; align-items: center; gap: 12px; }
.topbar-lock { font-size: 11px; color: #555; cursor: pointer; }
.topbar-lock:hover { color: #e74c3c; }

.admin-body { padding-top: 52px; display: flex; min-height: 100vh; }

/* Sidebar nav */
.admin-nav { width: 200px; background: #111; padding: 20px 0; position: fixed; top: 52px; bottom: 0; display: flex; flex-direction: column; gap: 2px; border-right: 1px solid #1e1e1e; }
.nav-item { padding: 10px 20px; font-size: 12px; font-weight: 600; color: #555; cursor: pointer; text-transform: uppercase; letter-spacing: 0.3px; transition: all .12s; border-left: 3px solid transparent; }
.nav-item:hover { color: #aaa; background: rgba(255,255,255,0.03); }
.nav-item.active { color: #FFFF00; border-left-color: #FFFF00; background: rgba(255,255,0,0.04); }
.nav-section { padding: 16px 20px 6px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #333; }

/* Main content */
.admin-main { margin-left: 200px; flex: 1; padding: 28px 32px; }
.admin-panel { display: none; }
.admin-panel.active { display: block; }
.panel-title { font-size: 20px; font-weight: 900; color: #fff; margin-bottom: 4px; }
.panel-sub { font-size: 12px; color: #555; margin-bottom: 24px; }

/* Cards */
.admin-card { background: #1a1f2e; border-radius: 12px; padding: 20px 22px; margin-bottom: 16px; }
.admin-card-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #FFFF00; opacity: 0.7; margin-bottom: 14px; }
.field-row { margin-bottom: 14px; }
.field-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #666; margin-bottom: 5px; display: block; }
.field-input { width: 100%; padding: 9px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; transition: border-color .12s; }
.field-input:focus { border-color: #FFFF00; }
.field-textarea { width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; resize: vertical; min-height: 120px; line-height: 1.6; transition: border-color .12s; }
.field-textarea:focus { border-color: #FFFF00; }
.field-hint { font-size: 10px; color: #444; margin-top: 4px; }
.save-btn { padding: 9px 22px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.save-btn:hover { background: #fff; }
.save-msg { font-size: 11px; color: #2e7d4f; margin-left: 12px; opacity: 0; transition: opacity .3s; display: inline-block; }
.save-msg.show { opacity: 1; }

/* Data Sources panel */
.ds-toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.ds-search { flex: 1; min-width: 200px; padding: 9px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; }
.ds-search::placeholder { color: #444; }
.ds-search:focus { border-color: #FFFF00; }
.ds-filter { padding: 9px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 12px; color: #aaa; outline: none; cursor: pointer; }
.ds-filter:focus { border-color: #FFFF00; }
.ds-add-btn { padding: 9px 18px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; white-space: nowrap; }
.ds-add-btn:hover { background: #fff; }

/* Source card grid */
.ds-grid { display: flex; flex-direction: column; gap: 10px; }
.ds-card { background: #1a1f2e; border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.04); transition: border-color .15s; }
.ds-card:hover { border-color: rgba(255,255,0,0.15); }
.ds-card-top { display: flex; align-items: center; gap: 14px; padding: 14px 18px; cursor: pointer; }
.ds-status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.ds-status-dot.active   { background: #2e7d4f; box-shadow: 0 0 6px rgba(46,125,79,0.5); }
.ds-status-dot.inactive { background: #555; }
.ds-status-dot.error    { background: #c0392b; box-shadow: 0 0 6px rgba(192,57,43,0.5); }
.ds-card-name { font-size: 13px; font-weight: 700; color: #fff; flex: 1; }
.ds-card-type { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; padding: 2px 9px; border-radius: 20px; flex-shrink: 0; }
.ds-card-type.api      { background: rgba(30,80,200,0.18); color: #7aa3f5; }
.ds-card-type.webpage  { background: rgba(100,50,200,0.18); color: #b08af5; }
.ds-card-type.file     { background: rgba(46,125,79,0.18); color: #6ec997; }
.ds-card-type.scrape   { background: rgba(180,83,9,0.18); color: #f5a742; }
.ds-card-category { font-size: 10px; color: #555; margin-left: auto; padding-right: 4px; }
.ds-card-chevron { font-size: 10px; color: #444; transition: transform .2s; flex-shrink: 0; }
.ds-card-chevron.open { transform: rotate(180deg); }
.ds-card-body { display: none; padding: 0 18px 16px; border-top: 1px solid rgba(255,255,255,0.04); }
.ds-card-body.open { display: block; }
.ds-field-row { margin-bottom: 12px; margin-top: 12px; }
.ds-field-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #555; margin-bottom: 5px; display: block; }
.ds-field-input { width: 100%; padding: 8px 11px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; transition: border-color .12s; }
.ds-field-input:focus { border-color: #FFFF00; }
.ds-field-textarea { width: 100%; padding: 8px 11px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; resize: vertical; min-height: 80px; line-height: 1.6; transition: border-color .12s; }
.ds-field-textarea:focus { border-color: #FFFF00; }
.ds-field-hint { font-size: 10px; color: #444; margin-top: 4px; }
.ds-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.ds-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.ds-card-actions { display: flex; align-items: center; gap: 8px; margin-top: 14px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
.ds-save-btn { padding: 7px 18px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; }
.ds-save-btn:hover { background: #fff; }
.ds-test-btn { padding: 7px 16px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: #aaa; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .12s; }
.ds-test-btn:hover { border-color: #FFFF00; color: #FFFF00; }
.ds-del-btn { padding: 7px 16px; background: none; border: 1px solid rgba(192,57,43,0.3); color: #c0392b; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; margin-left: auto; transition: all .12s; }
.ds-del-btn:hover { background: #c0392b; color: #fff; border-color: #c0392b; }
.ds-save-msg { font-size: 11px; color: #2e7d4f; opacity: 0; transition: opacity .3s; }
.ds-save-msg.show { opacity: 1; }
.ds-test-result { font-size: 11px; margin-top: 8px; padding: 8px 11px; border-radius: 7px; display: none; line-height: 1.5; }
.ds-test-result.ok  { background: rgba(46,125,79,0.12); color: #6ec997; display: block; }
.ds-test-result.err { background: rgba(192,57,43,0.12); color: #f08080; display: block; }

/* Add modal */
.ds-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; display: none; align-items: center; justify-content: center; }
.ds-modal-overlay.open { display: flex; }
.ds-modal { background: #1a1f2e; border-radius: 14px; padding: 28px 26px; width: 560px; max-width: 95vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 12px 60px rgba(0,0,0,0.5); }
.ds-modal h3 { font-size: 16px; font-weight: 900; color: #fff; margin-bottom: 4px; }
.ds-modal-sub { font-size: 12px; color: #555; margin-bottom: 22px; }
.ds-type-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; margin-bottom: 20px; }
.ds-type-btn { padding: 10px 6px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 9px; cursor: pointer; text-align: center; transition: all .12s; }
.ds-type-btn:hover, .ds-type-btn.selected { border-color: #FFFF00; background: rgba(255,255,0,0.06); }
.ds-type-icon { font-size: 22px; margin-bottom: 4px; }
.ds-type-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #aaa; }
.ds-modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 22px; }
.ds-modal-cancel { padding: 9px 18px; background: rgba(255,255,255,0.06); border: none; color: #aaa; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 20px; }
.ds-modal-create { padding: 9px 22px; background: #FFFF00; border: none; color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; }
.ds-modal-create:hover { background: #fff; }
.ds-empty-state { text-align: center; padding: 48px 20px; color: #444; }
.ds-empty-icon { font-size: 36px; margin-bottom: 12px; opacity: 0.4; }
.ds-empty-text { font-size: 13px; margin-bottom: 6px; color: #555; }
.ds-empty-sub { font-size: 11px; color: #333; }
.score-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.threshold-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.threshold-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.threshold-label { font-size: 11px; color: #aaa; width: 60px; }
.threshold-input { width: 70px; padding: 5px 9px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; text-align: center; }
.threshold-suffix { font-size: 11px; color: #555; }

/* User table */
.user-table { width: 100%; border-collapse: collapse; }
.user-table th { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; color: #555; padding: 8px 12px; text-align: left; border-bottom: 1px solid #222; }
.user-table td { font-size: 12px; color: #aaa; padding: 10px 12px; border-bottom: 1px solid #1a1a1a; }
.user-table tr:hover td { background: rgba(255,255,255,0.02); }
.user-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 2px 8px; border-radius: 20px; }
.user-badge.pro { background: rgba(255,255,0,0.15); color: #FFFF00; }
.user-badge.free { background: rgba(255,255,255,0.06); color: #666; }
.user-count { font-size: 24px; font-weight: 900; color: #fff; }
.user-count-lbl { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 0.4px; margin-top: 2px; }
.stats-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 20px; }
.stat-box { background: #1a1f2e; border-radius: 10px; padding: 14px 16px; }

/* Intake question editor */
.iq-card { background: #1e2535; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; transition: border-color .15s; }
.iq-card:hover { border-color: rgba(255,255,0,0.12); }
.iq-card-header { display: flex; align-items: center; gap: 10px; padding: 11px 14px; background: rgba(255,255,255,0.02); cursor: grab; }
.iq-card-header:active { cursor: grabbing; }
.iq-drag-handle { color: #333; font-size: 14px; flex-shrink: 0; }
.iq-card-label { flex: 1; font-size: 12px; font-weight: 700; color: #ddd; }
.iq-card-type-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; padding: 2px 8px; border-radius: 20px; background: rgba(255,255,0,0.1); color: #FFFF00; flex-shrink: 0; }
.iq-card-req { font-size: 9px; font-weight: 700; color: #c0392b; padding: 2px 6px; border-radius: 20px; background: rgba(192,57,43,0.15); flex-shrink: 0; }
.iq-card-body { padding: 12px 14px; border-top: 1px solid rgba(255,255,255,0.04); display: flex; flex-direction: column; gap: 10px; }
.iq-row { display: grid; gap: 10px; }
.iq-row-2 { grid-template-columns: 1fr 1fr; }
.iq-row-3 { grid-template-columns: 1fr 1fr auto; align-items: end; }
.iq-field-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #555; margin-bottom: 4px; display: block; }
.iq-field-input { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; transition: border-color .12s; }
.iq-field-input:focus { border-color: #FFFF00; }
.iq-field-select { width: 100%; padding: 7px 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 12px; color: #ddd; outline: none; cursor: pointer; }
.iq-field-select:focus { border-color: #FFFF00; }
.iq-check-row { display: flex; align-items: center; gap: 7px; }
.iq-check-row input[type=checkbox] { accent-color: #FFFF00; width: 14px; height: 14px; cursor: pointer; }
.iq-check-row label { font-size: 11px; color: #aaa; cursor: pointer; }
.iq-del-btn { padding: 7px 14px; background: none; border: 1px solid rgba(192,57,43,0.3); color: #c0392b; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 20px; white-space: nowrap; }
.iq-del-btn:hover { background: #c0392b; color: #fff; border-color: #c0392b; }
.iq-move-btn { padding: 6px 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); color: #555; font-family: 'Inter', sans-serif; font-size: 11px; cursor: pointer; border-radius: 7px; }
.iq-move-btn:hover { border-color: #FFFF00; color: #FFFF00; }
.iq-empty { text-align: center; padding: 40px 20px; color: #333; font-size: 13px; }


/* Intake question cards */
.iq-card{background:#1e2535;border-radius:10px;border:1px solid rgba(255,255,255,0.05);margin-bottom:10px;overflow:hidden;transition:border-color .15s;}
.iq-card:hover{border-color:rgba(255,255,0,0.12);}
.iq-card[style*="0.4"]{border:2px dashed rgba(255,255,0,0.3);}
.iq-card-hdr{display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(0,0,0,0.15);cursor:grab;user-select:none;}
.iq-card-hdr:active{cursor:grabbing;}
.iq-drag{color:#2a2a2a;font-size:15px;flex-shrink:0;letter-spacing:-2px;}
.iq-hdr-label{flex:1;font-size:12px;font-weight:700;color:#ccc;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.iq-req-badge{font-size:9px;font-weight:700;text-transform:uppercase;padding:2px 7px;border-radius:20px;background:rgba(192,57,43,0.2);color:#e07b7b;flex-shrink:0;}
.iq-type-badge{font-size:9px;font-weight:700;text-transform:uppercase;padding:2px 8px;border-radius:20px;flex-shrink:0;}
.iq-move-btn{padding:4px 8px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:#444;font-family:'Inter',sans-serif;font-size:11px;cursor:pointer;border-radius:6px;flex-shrink:0;transition:all .1s;}
.iq-move-btn:hover{border-color:#FFFF00;color:#FFFF00;}
.iq-move-btn:disabled{opacity:.2;cursor:default;}
.iq-card-body{padding:12px 14px;border-top:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:10px;}
.iq-row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.iq-fl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.3px;color:#555;margin-bottom:4px;display:block;}
.iq-fi{width:100%;padding:7px 10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:7px;font-family:'Inter',sans-serif;font-size:12px;color:#ddd;outline:none;transition:border-color .12s;}
.iq-fi:focus{border-color:#FFFF00;}
.iq-fs{width:100%;padding:7px 10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:7px;font-family:'Inter',sans-serif;font-size:12px;color:#ddd;outline:none;cursor:pointer;}
.iq-fs:focus{border-color:#FFFF00;}
.iq-del-btn{padding:5px 12px;background:none;border:1px solid rgba(192,57,43,0.3);color:#c0392b;font-family:'Inter',sans-serif;font-size:10px;font-weight:700;text-transform:uppercase;cursor:pointer;border-radius:20px;transition:all .12s;flex-shrink:0;}
.iq-del-btn:hover{background:#c0392b;color:#fff;border-color:#c0392b;}

</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">Sun<span>Hash</span></div>
    <div class="login-sub">Admin Panel</div>
    <div class="login-field">
      <label class="login-label">Username</label>
      <input class="login-input" id="adm-user" type="text" autocomplete="off" onkeydown="if(event.key==='Enter')adminLogin()"/>
    </div>
    <div class="login-field">
      <label class="login-label">Password</label>
      <input class="login-input" id="adm-pass" type="password" onkeydown="if(event.key==='Enter')adminLogin()"/>
    </div>
    <button class="login-btn" onclick="adminLogin()">Enter Admin</button>
    <div class="login-err" id="login-err">Invalid credentials</div>
  </div>
</div>

<!-- ADMIN -->
<div class="admin-screen" id="admin-screen">
  <div class="topbar">
    <div style="display:flex;align-items:center;">
      <span class="topbar-logo">Sun<span>Hash</span></span>
      <span class="topbar-badge">Admin</span>
    </div>
    <div class="topbar-right">
      <span class="topbar-lock" onclick="adminLogout()">&#128274; Lock</span>
    </div>
  </div>

  <div class="admin-body">
    <div class="admin-nav">
      <div class="nav-section">Verification</div>
      <div class="nav-item" onclick="showPanel('datasources')">Data Sources</div>
      <div class="nav-section">Content</div>
      <div class="nav-item active" onclick="showPanel('terms')">Terms & Conditions</div>
      <div class="nav-item" onclick="showPanel('intake')">Intake Questions</div>
      <div class="nav-section">AI Configuration</div>
      <div class="nav-item" onclick="showPanel('prompts')">GPT Prompts</div>
      <div class="nav-section">Scoring</div>
      <div class="nav-item" onclick="showPanel('scoring')">Score Thresholds</div>
      <div class="nav-item" onclick="showPanel('required')">Required Fields</div>
      <div class="nav-section">Users</div>
      <div class="nav-item" onclick="showPanel('users')">User Management</div>
      <div class="nav-section">Security</div>
      <div class="nav-item" onclick="showPanel('credentials')">Admin Credentials</div>
    </div>

    <div class="admin-main">

      <!-- TERMS -->
      <div class="admin-panel active" id="panel-terms">
        <div class="panel-title">Terms & Conditions</div>
        <div class="panel-sub">This text is shown to users at signup. Update the version number when making significant changes.</div>
        <div class="admin-card">
          <div class="admin-card-title">Current T&C</div>
          <div class="field-row">
            <label class="field-label">Version</label>
            <input class="field-input" id="terms-version" type="text" style="width:120px;" placeholder="e.g. 1.0"/>
          </div>
          <div class="field-row">
            <label class="field-label">Terms Text</label>
            <textarea class="field-textarea" id="terms-text" style="min-height:200px;" placeholder="Enter your terms and conditions text..."></textarea>
            <div class="field-hint">Plain text. Line breaks are preserved.</div>
          </div>
          <button class="save-btn" onclick="saveTerms()">Save Terms</button>
          <span class="save-msg" id="msg-terms">Saved</span>
        </div>
      </div>

      <!-- INTAKE QUESTIONS -->
      <div class="admin-panel" id="panel-intake">
        <div class="panel-title">Intake Questions</div>
        <div class="panel-sub">Questions shown when a user clicks "New Assessment" or "Edit Intake" on the dashboard. Drag rows to reorder. Save to publish changes immediately.</div>

        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
          <div style="font-size:11px;color:#555;line-height:1.7;">
            <span id="iq-count">0</span> questions &nbsp;&middot;&nbsp;
            Fields with IDs <span style="color:#FFFF00;">q_name</span>, <span style="color:#FFFF00;">q_cap</span>, <span style="color:#FFFF00;">q_stage</span> &amp; <span style="color:#FFFF00;">q_location</span> auto-populate project card data.
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="save-btn" onclick="addIQ()">+ Add Question</button>
            <button class="save-btn" style="background:rgba(255,255,255,0.06);color:#aaa;" onclick="saveIntakeQs()">&#10003; Save All</button>
            <span class="save-msg" id="iq-save-msg">Saved</span>
          </div>
        </div>

        <div id="iq-cards"></div>

        <div style="margin-top:20px;background:#12161f;border-radius:10px;padding:14px 18px;border:1px solid rgba(255,255,0,0.06);">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;color:#FFFF00;opacity:0.55;margin-bottom:10px;">Field Type Reference</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px 16px;">
            <div style="font-size:11px;color:#444;"><span style="color:#7aa3f5;font-weight:700;">text</span> &mdash; Short free text</div>
            <div style="font-size:11px;color:#444;"><span style="color:#c39af5;font-weight:700;">number</span> &mdash; Numeric input</div>
            <div style="font-size:11px;color:#444;"><span style="color:#6ec997;font-weight:700;">select</span> &mdash; Dropdown (comma list)</div>
            <div style="font-size:11px;color:#444;"><span style="color:#f5a742;font-weight:700;">date</span> &mdash; Date picker</div>
            <div style="font-size:11px;color:#444;"><span style="color:#4ecdc4;font-weight:700;">toggle</span> &mdash; Yes / No switch</div>
            <div style="font-size:11px;color:#444;"><span style="color:#aaa;font-weight:700;">textarea</span> &mdash; Multi-line text</div>
          </div>
        </div>
      </div>

      <!-- DATA SOURCES -->
      <div class="admin-panel" id="panel-datasources">
        <div class="panel-title">Data Sources</div>
        <div class="panel-sub">APIs, webpages, and files used by the cross-verification engine. Add, configure, enable, or disable without redeploying.</div>

        <div class="ds-toolbar">
          <input class="ds-search" id="ds-search" type="text" placeholder="Search sources..." oninput="filterSources()"/>
          <select class="ds-filter" id="ds-filter-type" onchange="filterSources()">
            <option value="">All types</option>
            <option value="api">API</option>
            <option value="webpage">Webpage</option>
            <option value="file">File / CSV</option>
            <option value="scrape">Scrape</option>
          </select>
          <select class="ds-filter" id="ds-filter-cat" onchange="filterSources()">
            <option value="">All categories</option>
            <option value="solar">Solar Yield</option>
            <option value="financial">Financial</option>
            <option value="weather">Weather / Climate</option>
            <option value="land">Land & Site</option>
            <option value="regulatory">Regulatory</option>
            <option value="grid">Grid & Power</option>
            <option value="cost">Cost Benchmarks</option>
            <option value="environmental">Environmental</option>
            <option value="labor">Labor & Compliance</option>
            <option value="other">Other</option>
          </select>
          <button class="ds-add-btn" onclick="openAddSourceModal()">&#43; Add Source</button>
        </div>

        <div class="ds-grid" id="ds-grid">
          <div class="ds-empty-state">
            <div class="ds-empty-icon">üîå</div>
            <div class="ds-empty-text">Loading sources...</div>
          </div>
        </div>
      </div>

      <!-- Add Source Modal -->
      <div class="ds-modal-overlay" id="ds-modal-overlay">
        <div class="ds-modal">
          <h3>Add Data Source</h3>
          <div class="ds-modal-sub">Choose the type of source you want to connect.</div>
          <div class="ds-type-grid" id="ds-type-grid">
            <div class="ds-type-btn selected" onclick="selectSourceType('api',this)">
              <div class="ds-type-icon">‚ö°</div>
              <div class="ds-type-label">REST API</div>
            </div>
            <div class="ds-type-btn" onclick="selectSourceType('webpage',this)">
              <div class="ds-type-icon">üåê</div>
              <div class="ds-type-label">Webpage</div>
            </div>
            <div class="ds-type-btn" onclick="selectSourceType('file',this)">
              <div class="ds-type-icon">üìÑ</div>
              <div class="ds-type-label">File / CSV</div>
            </div>
            <div class="ds-type-btn" onclick="selectSourceType('scrape',this)">
              <div class="ds-type-icon">üï∑</div>
              <div class="ds-type-label">Scrape</div>
            </div>
          </div>

          <div class="ds-row-2">
            <div class="ds-field-row">
              <label class="ds-field-label">Source Name *</label>
              <input class="ds-field-input" id="new-ds-name" type="text" placeholder="e.g. NREL PVWatts V8"/>
            </div>
            <div class="ds-field-row">
              <label class="ds-field-label">Category *</label>
              <select class="ds-field-input" id="new-ds-category">
                <option value="solar">Solar Yield</option>
                <option value="financial">Financial</option>
                <option value="weather">Weather / Climate</option>
                <option value="land">Land & Site</option>
                <option value="regulatory">Regulatory</option>
                <option value="grid">Grid & Power</option>
                <option value="cost">Cost Benchmarks</option>
                <option value="environmental">Environmental</option>
                <option value="labor">Labor & Compliance</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="ds-field-row">
            <label class="ds-field-label">Base URL / Endpoint *</label>
            <input class="ds-field-input" id="new-ds-url" type="url" placeholder="https://developer.nrel.gov/api/pvwatts/v8.json"/>
          </div>

          <div class="ds-field-row">
            <label class="ds-field-label">Description</label>
            <input class="ds-field-input" id="new-ds-desc" type="text" placeholder="What this source verifies"/>
          </div>

          <div class="ds-modal-actions">
            <button class="ds-modal-cancel" onclick="closeAddSourceModal()">Cancel</button>
            <button class="ds-modal-create" onclick="createSource()">Add Source</button>
          </div>
        </div>
      </div>

      <!-- SCORING -->
      <div class="admin-panel" id="panel-scoring">
        <div class="panel-title">Score Thresholds</div>
        <div class="panel-sub">Define the score boundaries for red, yellow, and green status across all categories and the timeline.</div>
        <div class="admin-card">
          <div class="admin-card-title">Category Score Colours</div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#2e7d4f;"></div>
            <span class="threshold-label">Green above</span>
            <input class="threshold-input" id="score-green" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#e07b20;"></div>
            <span class="threshold-label">Yellow above</span>
            <input class="threshold-input" id="score-yellow" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#c0392b;"></div>
            <span class="threshold-label">Red below</span>
            <span style="font-size:11px;color:#555;" id="score-red-label">--</span>
          </div>
          <button class="save-btn" onclick="saveScoreThresholds()">Save</button>
          <span class="save-msg" id="msg-scoring">Saved</span>
        </div>
        <div class="admin-card">
          <div class="admin-card-title">Timeline Milestone Thresholds (based on Permit score)</div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#2e7d4f;"></div>
            <span class="threshold-label">Green above</span>
            <input class="threshold-input" id="tl-green" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <div class="threshold-row">
            <div class="threshold-dot" style="background:#e07b20;"></div>
            <span class="threshold-label">Yellow above</span>
            <input class="threshold-input" id="tl-yellow" type="number" min="0" max="100"/>
            <span class="threshold-suffix">/ 100</span>
          </div>
          <button class="save-btn" onclick="saveTimelineThresholds()">Save</button>
          <span class="save-msg" id="msg-timeline">Saved</span>
        </div>
      </div>

      <!-- REQUIRED FIELDS -->
      <div class="admin-panel" id="panel-required">
        <div class="panel-title">Required Fields</div>
        <div class="panel-sub">Comma-separated field keys for each category. Used to calculate the completeness indicator on each button.</div>
        <div class="admin-card">
          <div class="admin-card-title">Per-Category Required Fields</div>
          <div id="required-fields-body"></div>
          <button class="save-btn" onclick="saveRequiredFields()">Save All</button>
          <span class="save-msg" id="msg-required">Saved</span>
        </div>
      </div>

      <!-- USERS -->
      <div class="admin-panel" id="panel-users">
        <div class="panel-title">User Management</div>
        <div class="panel-sub">All registered accounts. Subscription status reflects latest Stripe sync.</div>
        <div class="stats-row" id="user-stats"></div>
        <div class="admin-card">
          <div class="admin-card-title">All Users</div>
          <table class="user-table">
            <thead><tr><th>Email</th><th>Joined</th><th>Plan</th><th>T&C Accepted</th><th>Projects</th></tr></thead>
            <tbody id="user-table-body"><tr><td colspan="5" style="color:#444;text-align:center;padding:20px;">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- CREDENTIALS -->
      <div class="admin-panel" id="panel-credentials">
        <div class="panel-title">Admin Credentials</div>
        <div class="panel-sub">Change the username and password used to access this admin panel.</div>
        <div class="admin-card">
          <div class="admin-card-title">Update Login</div>
          <div class="field-row">
            <label class="field-label">New Username</label>
            <input class="field-input" id="new-username" type="text" style="max-width:300px;"/>
          </div>
          <div class="field-row">
            <label class="field-label">New Password</label>
            <input class="field-input" id="new-password" type="password" style="max-width:300px;"/>
          </div>
          <div class="field-row">
            <label class="field-label">Confirm Password</label>
            <input class="field-input" id="new-password2" type="password" style="max-width:300px;"/>
          </div>
          <button class="save-btn" onclick="saveCredentials()">Update Credentials</button>
          <span class="save-msg" id="msg-credentials">Updated</span>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

var CONFIG_KEYS = [
  "admin_username","admin_password","terms_text","terms_version",
  "prompt_overview","prompt_category_qa",
  "score_green_threshold","score_yellow_threshold",
  "timeline_permit_green","timeline_permit_yellow",
  "cat_required_design","cat_required_construct","cat_required_contract",
  "cat_required_intercon","cat_required_financial","cat_required_permit"
];

var config = {};
var CAT_LABELS = {
  design: "Design & Engineering", construct: "Construction",
  contract: "Legal & Contract", intercon: "Grid Interconnection",
  financial: "Financial", permit: "Permitting"
};

/* ---- AUTH ---- */
function adminLogin() {
  var user = document.getElementById("adm-user").value.trim();
  var pass = document.getElementById("adm-pass").value.trim();

  // Load config to verify credentials
  sb.from("admin_config").select("key,value").then(function(res) {
    if (res.error) { showLoginErr("Database error: " + res.error.message); return; }
    var cfg = {};
    (res.data || []).forEach(function(r) { cfg[r.key] = r.value; });

    var validUser = cfg["admin_username"] || "sunhash_admin";
    var validPass = cfg["admin_password"] || "SunHash2026!";

    if (user === validUser && pass === validPass) {
      config = cfg;
      sessionStorage.setItem("admin_auth", "1");
      showAdmin();
    } else {
      showLoginErr("Invalid credentials");
    }
  });
}

function showLoginErr(msg) {
  var el = document.getElementById("login-err");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(function() { el.style.display = "none"; }, 3000);
}

function adminLogout() {
  sessionStorage.removeItem("admin_auth");
  document.getElementById("admin-screen").style.display = "none";
  document.getElementById("login-screen").style.display = "flex";
  document.getElementById("adm-pass").value = "";
}

function showAdmin() {
  document.getElementById("login-screen").style.display = "none";
  document.getElementById("admin-screen").style.display = "block";
  populateFields();
  loadUsers();
  loadIntakeQs();
}

// Check session on load
window.addEventListener("load", function() {
  if (sessionStorage.getItem("admin_auth") === "1") {
    sb.from("admin_config").select("key,value").then(function(res) {
      if (!res.error) {
        (res.data || []).forEach(function(r) { config[r.key] = r.value; });
        showAdmin();
      }
    });
  }
});

/* ---- NAVIGATION ---- */
function showPanel(id) {
  document.querySelectorAll(".admin-panel").forEach(function(p) { p.classList.remove("active"); });
  document.querySelectorAll(".nav-item").forEach(function(n) { n.classList.remove("active"); });
  document.getElementById("panel-" + id).classList.add("active");
  event.target.classList.add("active");
  if (id === "users") loadUsers();
}

/* ---- POPULATE ---- */
function populateFields() {
  setValue("terms-version",    config["terms_version"]         || "1.0");
  setValue("terms-text",       config["terms_text"]            || "");
  setValue("prompt-overview",  config["prompt_overview"]       || "");
  setValue("prompt-category-qa", config["prompt_category_qa"] || "");
  setValue("score-green",      config["score_green_threshold"] || "70");
  setValue("score-yellow",     config["score_yellow_threshold"]|| "40");
  setValue("tl-green",         config["timeline_permit_green"] || "70");
  setValue("tl-yellow",        config["timeline_permit_yellow"]|| "40");
  updateRedLabel();

  // Per-category AI prompts
  var catKeys = ['design','construct','contract','intercon','financial','permit','procurement'];
  catKeys.forEach(function(k) {
    var el = document.getElementById('prompt-cat-' + k);
    if (el) el.value = config['prompt_cat_' + k] || '';
  });

  // Required fields per category
  var body = document.getElementById("required-fields-body");
  body.innerHTML = Object.keys(CAT_LABELS).map(function(cat) {
    var val = config["cat_required_" + cat] || "";
    return '<div class="field-row">' +
      '<label class="field-label">' + CAT_LABELS[cat] + '</label>' +
      '<input class="field-input" id="req-' + cat + '" type="text" value="' + val + '"/>' +
      '<div class="field-hint">Comma-separated field keys. Used for completeness indicator.</div>' +
    '</div>';
  }).join("");
}

function setValue(id, val) {
  var el = document.getElementById(id);
  if (el) el.value = val;
}

function updateRedLabel() {
  var y = document.getElementById("score-yellow");
  var lbl = document.getElementById("score-red-label");
  if (y && lbl) lbl.textContent = "Score below " + (y.value || "40");
}
document.addEventListener("input", function(e) {
  if (e.target.id === "score-yellow") updateRedLabel();
});

/* ---- SAVE FUNCTIONS ---- */
function saveConfig(updates, msgId) {
  var rows = Object.keys(updates).map(function(k) {
    return { key: k, value: String(updates[k]), updated_at: new Date().toISOString() };
  });
  var chain = Promise.resolve();
  rows.forEach(function(row) {
    chain = chain.then(function() {
      return sb.from("admin_config").upsert(row, { onConflict: "key" });
    });
  });
  chain.then(function() {
    Object.assign(config, updates);
    showMsg(msgId);
  }).catch(function(e) { alert("Save failed: " + e.message); });
}

function showMsg(id) {
  var el = document.getElementById(id);
  if (!el) return;
  el.classList.add("show");
  setTimeout(function() { el.classList.remove("show"); }, 2500);
}

function saveTerms() {
  saveConfig({
    terms_text:    document.getElementById("terms-text").value,
    terms_version: document.getElementById("terms-version").value
  }, "msg-terms");
}

function savePrompt(key) {
  var inputId = key === "overview" ? "prompt-overview" : "prompt-category-qa";
  var configKey = "prompt_" + key;
  var updates = {};
  updates[configKey] = document.getElementById(inputId).value;
  saveConfig(updates, "msg-prompt-" + key);
}

function saveScoreThresholds() {
  saveConfig({
    score_green_threshold:  document.getElementById("score-green").value,
    score_yellow_threshold: document.getElementById("score-yellow").value
  }, "msg-scoring");
}

function saveTimelineThresholds() {
  saveConfig({
    timeline_permit_green:  document.getElementById("tl-green").value,
    timeline_permit_yellow: document.getElementById("tl-yellow").value
  }, "msg-timeline");
}

function saveRequiredFields() {
  var updates = {};
  Object.keys(CAT_LABELS).forEach(function(cat) {
    var el = document.getElementById("req-" + cat);
    if (el) updates["cat_required_" + cat] = el.value.trim();
  });
  saveConfig(updates, "msg-required");
}

function saveCredentials() {
  var u  = document.getElementById("new-username").value.trim();
  var p  = document.getElementById("new-password").value;
  var p2 = document.getElementById("new-password2").value;
  if (!u || !p) { alert("Username and password required."); return; }
  if (p !== p2) { alert("Passwords do not match."); return; }
  saveConfig({ admin_username: u, admin_password: p }, "msg-credentials");
  document.getElementById("new-password").value  = "";
  document.getElementById("new-password2").value = "";
}

/* ---- USERS ---- */
function loadUsers() {
  sb.from("profiles").select("id, email, subscription_status, subscription_plan, terms_accepted_at, created_at")
    .order("created_at", { ascending: false })
    .then(function(res) {
      if (res.error) { console.error(res.error); return; }
      var users = res.data || [];
      var pro   = users.filter(function(u) { return u.subscription_status === "active"; }).length;
      var tac   = users.filter(function(u) { return u.terms_accepted_at; }).length;

      document.getElementById("user-stats").innerHTML =
        stat(users.length, "Total Users") +
        stat(pro, "Pro Subscribers") +
        stat(users.length - pro, "Free Users") +
        stat(tac, "T&C Accepted");

      // Load project counts
      sb.from("projects").select("user_id").then(function(pr) {
        var counts = {};
        (pr.data || []).forEach(function(p) { counts[p.user_id] = (counts[p.user_id] || 0) + 1; });

        document.getElementById("user-table-body").innerHTML = users.map(function(u) {
          var plan = u.subscription_status === "active"
            ? '<span class="user-badge pro">' + (u.subscription_plan || "Pro") + '</span>'
            : '<span class="user-badge free">Free</span>';
          var tac = u.terms_accepted_at
            ? new Date(u.terms_accepted_at).toLocaleDateString("en-GB")
            : '<span style="color:#444;">No</span>';
          var joined = new Date(u.created_at).toLocaleDateString("en-GB", {day:"2-digit",month:"short",year:"numeric"});
          return '<tr>' +
            '<td>' + (u.email || u.id.slice(0,8) + "...") + '</td>' +
            '<td>' + joined + '</td>' +
            '<td>' + plan + '</td>' +
            '<td>' + tac + '</td>' +
            '<td>' + (counts[u.id] || 0) + '</td>' +
            '</tr>';
        }).join("");
      });
    });
}

function stat(val, lbl) {
  return '<div class="stat-box"><div class="user-count">' + val + '</div><div class="user-count-lbl">' + lbl + '</div></div>';
}
/* =============================================
   DATA SOURCES PANEL
   ============================================= */
var allSources = [];
var newSourceType = 'api';

// Load sources when panel shown
var _origShowPanel = showPanel;
showPanel = function(id) {
  _origShowPanel.call(this, id);
  if (id === 'datasources') loadSources();
  if (id === 'intake') loadIntakeQs();
};

function loadSources() {
  sb.from('data_sources').select('*').order('created_at', { ascending: false })
    .then(function(res) {
      if (res.error) { console.error('DS load error:', res.error); return; }
      allSources = res.data || [];
      renderSources(allSources);
    });
}

var CAT_LABELS_DS = {
  solar:'Solar Yield', financial:'Financial', weather:'Weather / Climate',
  land:'Land & Site', regulatory:'Regulatory', grid:'Grid & Power',
  cost:'Cost Benchmarks', environmental:'Environmental', labor:'Labor & Compliance', other:'Other'
};
var TYPE_LABELS = { api:'API', webpage:'Webpage', file:'File / CSV', scrape:'Scrape' };

function filterSources() {
  var q    = (document.getElementById('ds-search').value || '').toLowerCase();
  var type = document.getElementById('ds-filter-type').value;
  var cat  = document.getElementById('ds-filter-cat').value;
  var filtered = allSources.filter(function(s) {
    var matchQ = !q || (s.name||'').toLowerCase().includes(q) || (s.description||'').toLowerCase().includes(q) || (s.base_url||'').toLowerCase().includes(q);
    var matchT = !type || s.source_type === type;
    var matchC = !cat  || s.category === cat;
    return matchQ && matchT && matchC;
  });
  renderSources(filtered);
}

function renderSources(sources) {
  var grid = document.getElementById('ds-grid');
  if (!sources.length) {
    grid.innerHTML = '<div class="ds-empty-state"><div class="ds-empty-icon">üîå</div><div class="ds-empty-text">No sources found.</div><div class="ds-empty-sub">Click "+ Add Source" to connect your first API or webpage.</div></div>';
    return;
  }
  grid.innerHTML = sources.map(function(s) { return buildSourceCard(s); }).join('');
}

function buildSourceCard(s) {
  var statusCls = s.enabled ? (s.last_test_ok === false ? 'error' : 'active') : 'inactive';
  var typeCls   = s.source_type || 'api';
  var typeLabel = TYPE_LABELS[typeCls] || typeCls;
  var catLabel  = CAT_LABELS_DS[s.category] || s.category || '';
  var freq_opts = ['realtime','hourly','daily','weekly','monthly','manual'].map(function(f) {
    return '<option value="' + f + '"' + (s.refresh_frequency===f?' selected':'') + '>' + f.charAt(0).toUpperCase()+f.slice(1) + '</option>';
  }).join('');
  var cat_opts = Object.keys(CAT_LABELS_DS).map(function(k) {
    return '<option value="'+k+'"'+(s.category===k?' selected':'')+'>'+CAT_LABELS_DS[k]+'</option>';
  }).join('');
  var type_opts = Object.keys(TYPE_LABELS).map(function(k) {
    return '<option value="'+k+'"'+(s.source_type===k?' selected':'')+'>'+TYPE_LABELS[k]+'</option>';
  }).join('');
  var lastTested = s.last_tested_at ? new Date(s.last_tested_at).toLocaleString() : 'Never';
  var testResult = '';
  if (s.last_test_ok === true)  testResult = '<div class="ds-test-result ok">‚úì Last test passed ‚Äî ' + lastTested + '</div>';
  if (s.last_test_ok === false) testResult = '<div class="ds-test-result err">‚úó Last test failed ‚Äî ' + lastTested + (s.last_test_error ? '<br>' + escAdm(s.last_test_error) : '') + '</div>';

  return '<div class="ds-card" id="dscard-' + s.id + '">' +
    '<div class="ds-card-top" onclick="toggleDsCard(\'' + s.id + '\')">' +
      '<div class="ds-status-dot ' + statusCls + '"></div>' +
      '<span class="ds-card-name">' + escAdm(s.name) + '</span>' +
      '<span class="ds-card-type ' + typeCls + '">' + typeLabel + '</span>' +
      '<span class="ds-card-category">' + escAdm(catLabel) + '</span>' +
      '<span class="ds-card-chevron" id="dsv-' + s.id + '">‚ñº</span>' +
    '</div>' +
    '<div class="ds-card-body" id="dsbody-' + s.id + '">' +
      '<div class="ds-row-3">' +
        '<div class="ds-field-row"><label class="ds-field-label">Source Name</label>' +
          '<input class="ds-field-input" id="dsf-name-' + s.id + '" value="' + escAdm(s.name) + '"/></div>' +
        '<div class="ds-field-row"><label class="ds-field-label">Type</label>' +
          '<select class="ds-field-input" id="dsf-type-' + s.id + '">' + type_opts + '</select></div>' +
        '<div class="ds-field-row"><label class="ds-field-label">Category</label>' +
          '<select class="ds-field-input" id="dsf-cat-' + s.id + '">' + cat_opts + '</select></div>' +
      '</div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Base URL / Endpoint</label>' +
        '<input class="ds-field-input" id="dsf-url-' + s.id + '" type="url" value="' + escAdm(s.base_url||'') + '"/>' +
        '<div class="ds-field-hint">Full URL. Use {PARAM} placeholders for dynamic values, e.g. {lat}, {lon}, {api_key}</div></div>' +
      '<div class="ds-row-2">' +
        '<div class="ds-field-row"><label class="ds-field-label">API Key / Auth Token</label>' +
          '<input class="ds-field-input" id="dsf-key-' + s.id + '" type="password" value="' + escAdm(s.api_key||'') + '" placeholder="Leave blank if none"/></div>' +
        '<div class="ds-field-row"><label class="ds-field-label">Refresh Frequency</label>' +
          '<select class="ds-field-input" id="dsf-freq-' + s.id + '">' + freq_opts + '</select></div>' +
      '</div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Request Parameters (JSON)</label>' +
        '<textarea class="ds-field-textarea" id="dsf-params-' + s.id + '" placeholder=\'{"format":"json","units":"metric"}\'>' + escAdm(s.request_params||'') + '</textarea>' +
        '<div class="ds-field-hint">Extra query parameters sent with every request. Use {project_lat}, {project_lon}, {api_key} as runtime substitutions.</div></div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Response Path (dot notation)</label>' +
        '<input class="ds-field-input" id="dsf-path-' + s.id + '" value="' + escAdm(s.response_path||'') + '" placeholder="e.g. outputs.ac_annual or data[0].value"/>' +
        '<div class="ds-field-hint">Where to find the benchmark value in the JSON response. Leave blank for full response.</div></div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Verification Rules (one per line)</label>' +
        '<textarea class="ds-field-textarea" id="dsf-rules-' + s.id + '" style="min-height:100px;" placeholder="e.g. user_yield > baseline * 1.15 ‚Üí RED \'Yield exceeds satellite model\'">' + escAdm(s.verification_rules||'') + '</textarea>' +
        '<div class="ds-field-hint">Plain-text rule descriptions. The cross-verify edge function reads these to apply logic.</div></div>' +
      '<div class="ds-field-row"><label class="ds-field-label">Notes / Documentation</label>' +
        '<textarea class="ds-field-textarea" id="dsf-notes-' + s.id + '" style="min-height:60px;">' + escAdm(s.notes||'') + '</textarea></div>' +
      '<div class="ds-field-row" style="display:flex;align-items:center;gap:12px;">' +
        '<label style="font-size:11px;color:#aaa;cursor:pointer;display:flex;align-items:center;gap:7px;">' +
          '<input type="checkbox" id="dsf-enabled-' + s.id + '"' + (s.enabled?' checked':'') + ' style="accent-color:#FFFF00;width:14px;height:14px;cursor:pointer;"/> Enabled' +
        '</label>' +
        '<label style="font-size:11px;color:#aaa;cursor:pointer;display:flex;align-items:center;gap:7px;">' +
          '<input type="checkbox" id="dsf-cache-' + s.id + '"' + (s.cache_results?' checked':'') + ' style="accent-color:#FFFF00;width:14px;height:14px;cursor:pointer;"/> Cache results in market_benchmarks' +
        '</label>' +
      '</div>' +
      testResult +
      '<div class="ds-card-actions">' +
        '<button class="ds-save-btn" onclick="saveSource(\'' + s.id + '\')">Save</button>' +
        '<button class="ds-test-btn" onclick="testSource(\'' + s.id + '\')">Test Connection</button>' +
        '<span class="ds-save-msg" id="ds-msg-' + s.id + '">Saved</span>' +
        '<button class="ds-del-btn" onclick="deleteSource(\'' + s.id + '\',\'' + escAdm(s.name) + '\')">Delete</button>' +
      '</div>' +
    '</div>' +
  '</div>';
}

function toggleDsCard(id) {
  var body = document.getElementById('dsbody-' + id);
  var chev = document.getElementById('dsv-' + id);
  if (!body) return;
  var isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  if (chev) chev.classList.toggle('open', !isOpen);
}

function escAdm(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function saveSource(id) {
  var updates = {
    name:               (document.getElementById('dsf-name-' + id)||{}).value || '',
    source_type:        (document.getElementById('dsf-type-' + id)||{}).value || 'api',
    category:           (document.getElementById('dsf-cat-' + id)||{}).value  || 'other',
    base_url:           (document.getElementById('dsf-url-' + id)||{}).value  || '',
    api_key:            (document.getElementById('dsf-key-' + id)||{}).value  || '',
    refresh_frequency:  (document.getElementById('dsf-freq-' + id)||{}).value || 'manual',
    request_params:     (document.getElementById('dsf-params-' + id)||{}).value || '',
    response_path:      (document.getElementById('dsf-path-' + id)||{}).value  || '',
    verification_rules: (document.getElementById('dsf-rules-' + id)||{}).value || '',
    notes:              (document.getElementById('dsf-notes-' + id)||{}).value || '',
    enabled:            (document.getElementById('dsf-enabled-' + id)||{}).checked || false,
    cache_results:      (document.getElementById('dsf-cache-' + id)||{}).checked || false,
    updated_at:         new Date().toISOString()
  };
  sb.from('data_sources').update(updates).eq('id', id).then(function(res) {
    if (res.error) { alert('Save failed: ' + res.error.message); return; }
    // update local cache
    var idx = allSources.findIndex(function(s) { return s.id === id; });
    if (idx >= 0) Object.assign(allSources[idx], updates);
    var msg = document.getElementById('ds-msg-' + id);
    if (msg) { msg.classList.add('show'); setTimeout(function() { msg.classList.remove('show'); }, 2500); }
  });
}

function testSource(id) {
  var src = allSources.find(function(s) { return s.id === id; });
  if (!src) return;
  var btn  = document.querySelector('#dscard-' + id + ' .ds-test-btn');
  if (btn) { btn.textContent = 'Testing...'; btn.disabled = true; }

  // Attempt a lightweight HEAD/GET to the base URL
  var url  = src.base_url || '';
  var ok   = false;
  var errMsg = '';

  if (!url) { recordTestResult(id, false, 'No URL configured', btn); return; }

  fetch(url, { method: 'HEAD', mode: 'no-cors' })
    .then(function() {
      // no-cors always "succeeds" ‚Äî treat as reachable
      recordTestResult(id, true, '', btn);
    })
    .catch(function(err) {
      recordTestResult(id, false, err.message, btn);
    });
}

function recordTestResult(id, success, errMsg, btn) {
  var now = new Date().toISOString();
  var update = { last_tested_at: now, last_test_ok: success, last_test_error: errMsg || null, updated_at: now };
  sb.from('data_sources').update(update).eq('id', id).then(function() {
    Object.assign(allSources.find(function(s){return s.id===id;})||{}, update);
    if (btn) { btn.textContent = 'Test Connection'; btn.disabled = false; }
    // Re-render just this card
    var card = document.getElementById('dscard-' + id);
    var src  = allSources.find(function(s){return s.id===id;});
    if (card && src) {
      var wasOpen = document.getElementById('dsbody-' + id).classList.contains('open');
      card.outerHTML = buildSourceCard(src);
      if (wasOpen) {
        document.getElementById('dsbody-' + id).classList.add('open');
        document.getElementById('dsv-' + id).classList.add('open');
      }
    }
  });
}

function deleteSource(id, name) {
  if (!confirm('Delete source "' + name + '"? This cannot be undone.')) return;
  sb.from('data_sources').delete().eq('id', id).then(function(res) {
    if (res.error) { alert('Delete failed: ' + res.error.message); return; }
    allSources = allSources.filter(function(s) { return s.id !== id; });
    renderSources(allSources);
  });
}

/* Add modal */
function openAddSourceModal() {
  document.getElementById('ds-modal-overlay').classList.add('open');
  document.getElementById('new-ds-name').value = '';
  document.getElementById('new-ds-url').value  = '';
  document.getElementById('new-ds-desc').value = '';
  newSourceType = 'api';
  document.querySelectorAll('.ds-type-btn').forEach(function(b,i) {
    b.classList.toggle('selected', i===0);
  });
}

function closeAddSourceModal() {
  document.getElementById('ds-modal-overlay').classList.remove('open');
}

function selectSourceType(type, el) {
  newSourceType = type;
  document.querySelectorAll('.ds-type-btn').forEach(function(b) { b.classList.remove('selected'); });
  el.classList.add('selected');
}

function createSource() {
  var name = (document.getElementById('new-ds-name').value||'').trim();
  var url  = (document.getElementById('new-ds-url').value||'').trim();
  var cat  = document.getElementById('new-ds-category').value;
  var desc = (document.getElementById('new-ds-desc').value||'').trim();
  if (!name) { alert('Source name is required.'); return; }
  var row = {
    name: name, source_type: newSourceType, category: cat,
    base_url: url, description: desc,
    enabled: true, cache_results: false,
    refresh_frequency: 'manual',
    api_key: '', request_params: '', response_path: '',
    verification_rules: '', notes: '',
    created_at: new Date().toISOString(), updated_at: new Date().toISOString()
  };
  sb.from('data_sources').insert(row).select().then(function(res) {
    if (res.error) { alert('Create failed: ' + res.error.message); return; }
    var created = res.data && res.data[0];
    if (created) { allSources.unshift(created); renderSources(allSources); }
    closeAddSourceModal();
    // Auto-open new card
    if (created) {
      setTimeout(function() { toggleDsCard(created.id); }, 100);
    }
  });
}

// Close modal on overlay click
window.addEventListener('load', function() {
  var overlay = document.getElementById('ds-modal-overlay');
  if (overlay) overlay.addEventListener('click', function(e) {
    if (e.target === this) closeAddSourceModal();
  });
});

function saveCatPrompt(catKey) {
  var el = document.getElementById('prompt-cat-' + catKey);
  if (!el) return;
  var updates = {};
  updates['prompt_cat_' + catKey] = el.value.trim();
  saveConfig(updates, 'msg-cat-' + catKey);
}


/* ================================================================
   INTAKE QUESTIONS PANEL
   Stored in admin_config: key="intake_questions", value=JSON array
   Each question: { id, label, type, opts, required, order }
   Types: text | number | select | date | toggle | textarea
   ================================================================ */

var iqList    = [];   // working copy
var iqDragId  = null; // id of card being dragged

/* Called on panel load and on showPanel('intake') */
function loadIntakeQs() {
  sb.from("admin_config").select("value").eq("key", "intake_questions").single().then(function(res) {
    if (res.data && res.data.value) {
      try {
        var p = JSON.parse(res.data.value);
        if (Array.isArray(p) && p.length > 0) {
          iqList = p.slice().sort(function(a, b) { return (a.order || 0) - (b.order || 0); });
          renderIQPanel();
          return;
        }
      } catch (e) {}
    }
    // Seed with defaults
    iqList = [
      { id:"q_name",     label:"Project Name",                        type:"text",     required:true,  order:1, opts:"" },
      { id:"q_cap",      label:"Capacity (MWp)",                      type:"number",   required:true,  order:2, opts:"" },
      { id:"q_state",    label:"State / Province",                    type:"select",   required:true,  order:3,
        opts:"Alabama,Alaska,Arizona,Arkansas,California,Colorado,Connecticut,Delaware,Florida,Georgia,Hawaii,Idaho,Illinois,Indiana,Iowa,Kansas,Kentucky,Louisiana,Maine,Maryland,Massachusetts,Michigan,Minnesota,Mississippi,Missouri,Montana,Nebraska,Nevada,New Hampshire,New Jersey,New Mexico,New York,North Carolina,North Dakota,Ohio,Oklahoma,Oregon,Pennsylvania,Rhode Island,South Carolina,South Dakota,Tennessee,Texas,Utah,Vermont,Virginia,Washington,West Virginia,Wisconsin,Wyoming" },
      { id:"q_stage",    label:"Project Stage",                       type:"select",   required:true,  order:4, opts:"Development,Pre-Construction,Construction,Operational" },
      { id:"q_location", label:"Google Maps Link",                    type:"text",     required:false, order:5, opts:"" },
      { id:"q_notes",    label:"Brief Project Description",           type:"textarea", required:false, order:6, opts:"" }
    ];
    renderIQPanel();
  });
}

function saveIntakeQs() {
  // Pull current values from DOM into iqList
  iqList.forEach(function(q) {
    var lblEl  = document.getElementById("iq_lbl_"  + q.id);
    var typEl  = document.getElementById("iq_typ_"  + q.id);
    var optEl  = document.getElementById("iq_opt_"  + q.id);
    var reqEl  = document.getElementById("iq_req_"  + q.id);
    if (lblEl) q.label    = lblEl.value.trim()  || q.label;
    if (typEl) q.type     = typEl.value;
    if (optEl) q.opts     = optEl.value.trim();
    if (reqEl) q.required = reqEl.checked;
  });
  iqList.forEach(function(q, i) { q.order = i + 1; });

  saveConfig({ intake_questions: JSON.stringify(iqList) }, "iq-save-msg");
  renderIQPanel();
}

function addIQ() {
  iqList.push({
    id:       "q_" + Date.now(),
    label:    "New Question",
    type:     "text",
    opts:     "",
    required: false,
    order:    iqList.length + 1
  });
  renderIQPanel();
  setTimeout(function() {
    var last = document.querySelector("#iq-cards .iq-card:last-child");
    if (last) last.scrollIntoView({ behavior: "smooth", block: "center" });
  }, 60);
}

function deleteIQ(id) {
  if (!confirm("Delete this question? This cannot be undone.")) return;
  iqList = iqList.filter(function(q) { return q.id !== id; });
  renderIQPanel();
}

function moveIQ(id, dir) {
  var idx = iqList.findIndex(function(q) { return q.id === id; });
  var to  = idx + dir;
  if (idx < 0 || to < 0 || to >= iqList.length) return;
  // Read DOM values before re-render to preserve unsaved edits
  iqList.forEach(function(q) {
    var lblEl = document.getElementById("iq_lbl_" + q.id);
    var typEl = document.getElementById("iq_typ_" + q.id);
    var optEl = document.getElementById("iq_opt_" + q.id);
    var reqEl = document.getElementById("iq_req_" + q.id);
    if (lblEl) q.label    = lblEl.value;
    if (typEl) q.type     = typEl.value;
    if (optEl) q.opts     = optEl.value;
    if (reqEl) q.required = reqEl.checked;
  });
  var tmp       = iqList[idx];
  iqList[idx]   = iqList[to];
  iqList[to]    = tmp;
  renderIQPanel();
}

function iqTypeChange(id) {
  var el = document.getElementById("iq_typ_" + id);
  if (!el) return;
  var q = iqList.find(function(q) { return q.id === id; });
  if (q) q.type = el.value;
  var wrap = document.getElementById("iq_optwrap_" + id);
  if (wrap) wrap.style.display = el.value === "select" ? "block" : "none";
  var badge = document.getElementById("iq_typbadge_" + id);
  if (badge) { badge.textContent = el.value; badge.setAttribute("data-t", el.value); }
}

function iqLabelChange(id) {
  var el = document.getElementById("iq_lbl_" + id);
  if (!el) return;
  var q = iqList.find(function(q) { return q.id === id; });
  if (q) q.label = el.value;
  var hdr = document.getElementById("iq_hdrlbl_" + id);
  if (hdr) hdr.textContent = el.value || "Untitled";
}

function iqReqChange(id) {
  var el = document.getElementById("iq_req_" + id);
  if (!el) return;
  var q = iqList.find(function(q) { return q.id === id; });
  if (q) q.required = el.checked;
  var badge = document.getElementById("iq_reqbadge_" + id);
  if (badge) badge.style.display = el.checked ? "inline-flex" : "none";
}

function renderIQPanel() {
  var countEl = document.getElementById("iq-count");
  if (countEl) countEl.textContent = iqList.length;

  var container = document.getElementById("iq-cards");
  if (!container) return;

  if (!iqList.length) {
    container.innerHTML = '<div style="text-align:center;padding:48px 20px;color:#444;font-size:13px;">No questions yet. Click <strong>+ Add Question</strong> to start.</div>';
    return;
  }

  var TYPE_COLORS = {
    text:     "rgba(36,113,163,0.25);color:#7aa3f5",
    number:   "rgba(125,60,152,0.25);color:#c39af5",
    select:   "rgba(46,125,79,0.25);color:#6ec997",
    date:     "rgba(224,123,32,0.25);color:#f5a742",
    toggle:   "rgba(17,122,101,0.25);color:#4ecdc4",
    textarea: "rgba(90,90,90,0.25);color:#aaa"
  };

  container.innerHTML = iqList.map(function(q, i) {
    var tc  = TYPE_COLORS[q.type] || TYPE_COLORS.text;
    var last = i === iqList.length - 1;
    return '<div class="iq-card" id="iqcard_' + q.id + '" draggable="true" ' +
      'ondragstart="iqDragStart(event,\'' + q.id + '\')" ' +
      'ondragover="iqDragOver(event)" ' +
      'ondrop="iqDrop(event,\'' + q.id + '\')" ' +
      'ondragend="iqDragEnd()">' +

      // Header row
      '<div class="iq-card-hdr">' +
        '<span class="iq-drag">&#8942;&#8942;</span>' +
        '<span class="iq-hdr-label" id="iq_hdrlbl_' + q.id + '">' + escAdm(q.label) + '</span>' +
        '<span class="iq-req-badge" id="iq_reqbadge_' + q.id + '" style="display:' + (q.required ? "inline-flex" : "none") + ';">Required</span>' +
        '<span class="iq-type-badge" id="iq_typbadge_' + q.id + '" data-t="' + q.type + '" style="background:' + tc + '">' + q.type + '</span>' +
        '<button class="iq-move-btn" onclick="moveIQ(\'' + q.id + '\',-1)"' + (i === 0 ? ' disabled' : '') + '>&#8593;</button>' +
        '<button class="iq-move-btn" onclick="moveIQ(\'' + q.id + '\',1)"' + (last ? ' disabled' : '') + '>&#8595;</button>' +
      '</div>' +

      // Body
      '<div class="iq-card-body">' +
        '<div class="iq-row2">' +
          '<div>' +
            '<label class="iq-fl">Question Label</label>' +
            '<input class="iq-fi" id="iq_lbl_' + q.id + '" type="text" value="' + escAdm(q.label) + '" placeholder="e.g. Project Name" oninput="iqLabelChange(\'' + q.id + '\')" />' +
          '</div>' +
          '<div>' +
            '<label class="iq-fl">Field Type</label>' +
            '<select class="iq-fs" id="iq_typ_' + q.id + '" onchange="iqTypeChange(\'' + q.id + '\')">' +
              ['text','number','select','date','toggle','textarea'].map(function(t) {
                return '<option value="' + t + '"' + (q.type === t ? ' selected' : '') + '>' + t + '</option>';
              }).join('') +
            '</select>' +
          '</div>' +
        '</div>' +
        '<div id="iq_optwrap_' + q.id + '" style="display:' + (q.type === 'select' ? 'block' : 'none') + ';">' +
          '<label class="iq-fl">Options <span style="color:#555;font-weight:400;">(comma-separated)</span></label>' +
          '<input class="iq-fi" id="iq_opt_' + q.id + '" type="text" value="' + escAdm(q.opts || '') + '" placeholder="Option A, Option B, Option C" />' +
        '</div>' +
        '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:4px;">' +
          '<label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px;color:#aaa;">' +
            '<input type="checkbox" id="iq_req_' + q.id + '"' + (q.required ? ' checked' : '') + ' onchange="iqReqChange(\'' + q.id + '\')" style="accent-color:#FFFF00;width:13px;height:13px;"/>' +
            'Required field' +
          '</label>' +
          '<span style="font-size:9px;color:#2a2a2a;">id: ' + escAdm(q.id) + '</span>' +
          '<button class="iq-del-btn" onclick="deleteIQ(\'' + q.id + '\')">&#x2715; Delete</button>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join("");
}

/* Drag & drop reorder */
function iqDragStart(e, id) {
  iqDragId = id;
  e.dataTransfer.effectAllowed = "move";
  setTimeout(function() {
    var el = document.getElementById("iqcard_" + id);
    if (el) el.style.opacity = "0.4";
  }, 0);
}
function iqDragOver(e) { e.preventDefault(); return false; }
function iqDrop(e, targetId) {
  e.stopPropagation();
  if (!iqDragId || iqDragId === targetId) return;
  // Read DOM before re-render
  iqList.forEach(function(q) {
    var l = document.getElementById("iq_lbl_" + q.id);
    var t = document.getElementById("iq_typ_" + q.id);
    var o = document.getElementById("iq_opt_" + q.id);
    var r = document.getElementById("iq_req_" + q.id);
    if (l) q.label    = l.value;
    if (t) q.type     = t.value;
    if (o) q.opts     = o.value;
    if (r) q.required = r.checked;
  });
  var srcIdx = iqList.findIndex(function(q) { return q.id === iqDragId; });
  var tgtIdx = iqList.findIndex(function(q) { return q.id === targetId; });
  if (srcIdx < 0 || tgtIdx < 0) return;
  var moved = iqList.splice(srcIdx, 1)[0];
  iqList.splice(tgtIdx, 0, moved);
  renderIQPanel();
}
function iqDragEnd() {
  iqDragId = null;
  document.querySelectorAll(".iq-card").forEach(function(c) { c.style.opacity = ""; });
}

</script>
</body>
</html>
