<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash - Profile</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #eef0f4; color: #1a1f2e; min-height: 100vh; }
body.hidden { visibility: hidden; }
a { text-decoration: none; }
.topbar { position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; background: #111; border-bottom: 3px solid #FFFF00; display: flex; align-items: center; justify-content: space-between; padding: 0 32px; }
.logo { font-size: 22px; font-weight: 900; letter-spacing: 0.3px; text-transform: uppercase; color: #fff; }
.logo span { color: #FFFF00; }
.tb-right { display: flex; align-items: center; gap: 10px; }
.btn-back { padding: 7px 16px; border: none; background: rgba(255,255,255,0.1); color: #aaa; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; text-transform: uppercase; border-radius: 20px; cursor: pointer; }
.btn-back:hover { background: rgba(255,255,255,0.2); color: #fff; }
.btn-out { background: none; border: 1px solid #444; color: #777; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; padding: 7px 14px; cursor: pointer; text-transform: uppercase; border-radius: 20px; }
.btn-out:hover { border-color: #E83535; color: #E83535; }
.page { padding-top: 56px; }
.hero { background: #111; padding: 40px 40px 36px; display: flex; align-items: center; gap: 20px; }
.av-lg { width: 60px; height: 60px; border-radius: 50%; background: #FFFF00; color: #111; font-size: 24px; font-weight: 900; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.hero-name { font-size: 32px; font-weight: 900; letter-spacing: -0.5px; color: #fff; }
.hero-sub { font-size: 13px; color: #555; margin-top: 4px; }
.body { max-width: 1100px; margin: 0 auto; padding: 28px 32px 80px; }

/* Top row: 3 equal cards */
.row-top { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
/* Bottom row: danger zone full width */
.row-bottom { display: grid; grid-template-columns: 1fr; gap: 20px; }

.pcard { background: #dde1ea; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.07); overflow: hidden; display: flex; flex-direction: column; }
.pcard-hdr { padding: 16px 22px 14px; border-bottom: 1px solid rgba(0,0,0,0.07); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
.pcard-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #5a6474; }
.pcard-body { padding: 20px 22px; flex: 1; }

label { display: block; font-size: 10px; font-weight: 700; letter-spacing: 0.3px; text-transform: uppercase; color: #6b7585; margin-bottom: 5px; }
input, select { width: 100%; padding: 9px 13px; background: rgba(255,255,255,0.55); border: none; border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 13px; color: #1a1f2e; outline: none; -webkit-appearance: none; transition: background .15s; }
input:focus, select:focus { background: rgba(255,255,255,0.85); box-shadow: 0 0 0 2px #1a1f2e; }
input[readonly] { background: rgba(0,0,0,0.06); color: #6b7585; cursor: not-allowed; }
.field { margin-bottom: 12px; }
.field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
.btn { padding: 10px 20px; background: #1a1f2e; border: none; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 800; letter-spacing: 0.3px; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .15s; }
.btn:hover { background: #FFFF00; color: #1a1f2e; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-danger { padding: 10px 20px; background: rgba(232,53,53,0.1); border: none; color: #E83535; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 20px; }
.btn-danger:hover { background: #E83535; color: #fff; }
.msg { margin-top: 8px; font-size: 12px; min-height: 18px; }
.msg.err { color: #E83535; }
.msg.ok { color: #2e7d4f; }

/* Subscription card internals */
.sub-status-bar { display: flex; align-items: center; justify-content: space-between; background: #1a1f2e; border-radius: 10px; padding: 14px 16px; margin-bottom: 14px; }
.sub-status-lbl { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: #555; }
.sub-status-val { font-size: 13px; font-weight: 800; color: #FFFF00; }
.sub-status-val.inactive { color: #555; }
.plan-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; }
.plan-opt { border-radius: 10px; padding: 14px 12px; cursor: pointer; border: 2px solid transparent; background: rgba(255,255,255,0.4); transition: all .15s; text-align: center; }
.plan-opt.selected { border-color: #1a1f2e; background: rgba(255,255,255,0.7); }
.plan-opt-name { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.3px; color: #1a1f2e; margin-bottom: 4px; }
.plan-opt-price { font-size: 20px; font-weight: 900; color: #1a1f2e; letter-spacing: -0.5px; }
.plan-opt-price span { font-size: 11px; font-weight: 500; color: #6b7585; }
.plan-opt-save { font-size: 10px; font-weight: 700; color: #2e7d4f; margin-top: 3px; }
.sub-features { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
.sub-feat { font-size: 12px; color: #1a1f2e; font-weight: 500; display: flex; align-items: center; gap: 8px; }
.sub-feat::before { content: ""; width: 6px; height: 6px; border-radius: 50%; background: #2e7d4f; flex-shrink: 0; }
.btn-subscribe { width: 100%; padding: 12px; background: #1a1f2e; border: none; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 800; letter-spacing: 0.3px; text-transform: uppercase; cursor: pointer; border-radius: 20px; transition: all .15s; }
.btn-subscribe:hover { background: #FFFF00; color: #1a1f2e; }
.btn-subscribe:disabled { opacity: 0.5; cursor: not-allowed; }
.sub-badge { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; padding: 3px 10px; border-radius: 20px; background: rgba(46,125,79,0.15); color: #2e7d4f; border: 1px solid rgba(46,125,79,0.3); }
.sub-badge.inactive { background: rgba(0,0,0,0.06); color: #6b7585; border-color: transparent; }

@media(max-width:900px){ .row-top { grid-template-columns: 1fr; } .field-row { grid-template-columns: 1fr; } }
</style>
</head>
<body class="hidden">

<div class="topbar">
  <a href="dashboard.html" class="logo">Sun<span>Hash</span></a>
  <div class="tb-right">
    <a href="dashboard.html" class="btn-back">Back to Dashboard</a>
    <button class="btn-out" onclick="doSignout()">Sign Out</button>
  </div>
</div>

<div class="page">
  <div class="hero">
    <div class="av-lg" id="av">?</div>
    <div>
      <div class="hero-name" id="hero-name">Loading...</div>
      <div class="hero-sub" id="hero-sub"></div>
    </div>
  </div>

  <div class="body">
    <div class="row-top">

      <!-- 1. Personal Info -->
      <div class="pcard">
        <div class="pcard-hdr"><span class="pcard-title">Personal Info</span></div>
        <div class="pcard-body">
          <div class="field-row">
            <div class="field"><label>First name</label><input type="text" id="first" placeholder="Alessandro"/></div>
            <div class="field"><label>Last name</label><input type="text" id="last" placeholder="Rossi"/></div>
          </div>
          <div class="field"><label>Company</label><input type="text" id="company" placeholder="Company name"/></div>
          <div class="field">
            <label>Role</label>
            <select id="role">
              <option value="">Select role...</option>
              <option>Developer / Project Owner</option>
              <option>Investor / Lender</option>
              <option>EPC Contractor</option>
              <option>Independent Engineer</option>
              <option>Legal Counsel</option>
              <option>Financial Advisor</option>
              <option>Other</option>
            </select>
          </div>
          <div class="field">
            <label>Country</label>
            <select id="country">
              <option value="">Select country...</option>
              <optgroup label="Europe"><option>Italy</option><option>Spain</option><option>France</option><option>Germany</option><option>United Kingdom</option><option>Portugal</option><option>Netherlands</option><option>Poland</option><option>Greece</option><option>Romania</option><option>Other Europe</option></optgroup>
              <optgroup label="Americas"><option>United States</option><option>Canada</option><option>Brazil</option><option>Mexico</option><option>Chile</option><option>Other Americas</option></optgroup>
              <optgroup label="Middle East and Africa"><option>UAE</option><option>Saudi Arabia</option><option>South Africa</option><option>Other MEA</option></optgroup>
              <optgroup label="Asia Pacific"><option>Australia</option><option>India</option><option>Japan</option><option>Other APAC</option></optgroup>
            </select>
          </div>
          <div class="field">
            <label>LinkedIn <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:11px;">optional</span></label>
            <input type="url" id="linkedin" placeholder="https://linkedin.com/in/yourname"/>
          </div>
          <button class="btn" id="btn-save" onclick="doSave()">Save Changes</button>
          <div class="msg" id="msg-profile"></div>
        </div>
      </div>

      <!-- 2. Account & Security -->
      <div class="pcard">
        <div class="pcard-hdr"><span class="pcard-title">Account &amp; Security</span></div>
        <div class="pcard-body">
          <div class="field">
            <label>Email address</label>
            <input type="email" id="email" readonly/>
          </div>
          <p style="font-size:12px;color:#6b7585;line-height:1.6;margin-bottom:16px;">To change your email contact <a href="mailto:support@sunhash.io" style="color:#1a1f2e;text-decoration:underline;">support@sunhash.io</a></p>
          <div class="field"><label>New password</label><input type="password" id="pw1" placeholder="Leave blank to keep current"/></div>
          <div class="field"><label>Confirm password</label><input type="password" id="pw2" placeholder="Repeat new password"/></div>
          <button class="btn" onclick="doPassword()">Update Password</button>
          <div class="msg" id="msg-pw"></div>
        </div>
      </div>

      <!-- 3. Subscription -->
      <div class="pcard">
        <div class="pcard-hdr">
          <span class="pcard-title">Subscription</span>
          <span class="sub-badge inactive" id="sub-badge">Free</span>
        </div>
        <div class="pcard-body">
          <div class="sub-status-bar">
            <div class="sub-status-lbl">Current plan</div>
            <div class="sub-status-val inactive" id="sub-plan-name">Free</div>
          </div>

          <!-- Plan toggle (hidden when already subscribed) -->
          <div id="plan-chooser">
            <div class="plan-toggle">
              <div class="plan-opt selected" id="opt-monthly" onclick="selectPlan('monthly')">
                <div class="plan-opt-name">Monthly</div>
                <div class="plan-opt-price">$10<span>/mo</span></div>
                <div class="plan-opt-save" style="color:#6b7585;">Flexible</div>
              </div>
              <div class="plan-opt" id="opt-yearly" onclick="selectPlan('yearly')">
                <div class="plan-opt-name">Yearly</div>
                <div class="plan-opt-price">$60<span>/yr</span></div>
                <div class="plan-opt-save">Save 50%</div>
              </div>
            </div>
            <div class="sub-features">
              <div class="sub-feat">Unlimited assessments</div>
              <div class="sub-feat">All 6 category scores</div>
              <div class="sub-feat">AI project briefs</div>
              <div class="sub-feat">Full risk reports &amp; PDF export</div>
            </div>
            <button class="btn-subscribe" id="btn-subscribe" onclick="handleSubscribe()">Upgrade to Pro</button>
            <div class="msg" id="msg-sub" style="text-align:center;"></div>
          </div>

          <!-- Manage (shown when subscribed) -->
          <div id="plan-active" style="display:none;">
            <div class="sub-features" style="margin-bottom:18px;">
              <div class="sub-feat">Unlimited assessments</div>
              <div class="sub-feat">All 6 category scores</div>
              <div class="sub-feat">AI project briefs</div>
              <div class="sub-feat">Full risk reports &amp; PDF export</div>
            </div>
            <button class="btn" onclick="alert('Subscription management coming soon. Contact support@sunhash.io')">Manage Subscription</button>
            <div class="msg" id="msg-sub-active" style="text-align:center;"></div>
          </div>
        </div>
      </div>

    </div><!-- /row-top -->

    <!-- Danger zone -->
    <div class="row-bottom">
      <div class="pcard">
        <div class="pcard-hdr"><span class="pcard-title" style="color:#c0392b;">Danger Zone</span></div>
        <div class="pcard-body" style="display:flex;align-items:center;justify-content:space-between;gap:24px;flex-wrap:wrap;">
          <p style="font-size:13px;color:#6b7585;line-height:1.7;max-width:580px;">Deleting your account is permanent. All projects, assessments and reports will be removed and cannot be recovered.</p>
          <button class="btn-danger" onclick="doDelete()">Delete My Account</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var currentUser = null;
var selectedPlan = "monthly";

function setMsg(id, text, type) {
  var el = document.getElementById(id);
  if (!el) return;
  el.textContent = text;
  el.className = "msg " + (type || "");
  if (type === "ok") setTimeout(function(){ el.textContent = ""; el.className = "msg"; }, 5000);
}

function selectPlan(plan) {
  selectedPlan = plan;
  document.getElementById("opt-monthly").className = "plan-opt" + (plan === "monthly" ? " selected" : "");
  document.getElementById("opt-yearly").className  = "plan-opt" + (plan === "yearly"  ? " selected" : "");
}

var authTimeout = setTimeout(function() { window.location.href = "login.html"; }, 5000);

sb.auth.onAuthStateChange(function(event, session) {
  if (session && session.user) {
    clearTimeout(authTimeout);
    document.body.classList.remove("hidden");
    currentUser = session.user;
    document.getElementById("email").value = session.user.email || "";
    loadProfile();
    checkStripeReturn();
  } else if (event === "SIGNED_OUT") {
    window.location.href = "login.html";
  }
});

function loadProfile() {
  sb.from("profiles")
    .select("first_name,last_name,company,role,country,linkedin,subscription_status,subscription_plan")
    .eq("id", currentUser.id).single()
    .then(function(res) {
      if (!res.data) return;
      var d = res.data;
      var first = d.first_name || "";
      var last  = d.last_name  || "";
      document.getElementById("av").textContent = ((first[0]||"")+(last[0]||"")).toUpperCase() || "?";
      document.getElementById("hero-name").textContent = (first+" "+last).trim() || currentUser.email;
      document.getElementById("hero-sub").textContent  = [d.role, d.company, d.country].filter(Boolean).join(" - ");
      document.getElementById("first").value   = first;
      document.getElementById("last").value    = last;
      document.getElementById("company").value = d.company  || "";
      document.getElementById("linkedin").value = d.linkedin || "";
      var roleEl = document.getElementById("role");
      for (var i=0;i<roleEl.options.length;i++) { if (roleEl.options[i].value===d.role){roleEl.selectedIndex=i;break;} }
      var cEl = document.getElementById("country");
      for (var i=0;i<cEl.options.length;i++) { if (cEl.options[i].value===d.country){cEl.selectedIndex=i;break;} }

      // Subscription UI
      if (d.subscription_status === "active") {
        var planLabel = d.subscription_plan === "yearly" ? "Pro Yearly" : "Pro Monthly";
        document.getElementById("sub-badge").textContent = "Active";
        document.getElementById("sub-badge").className = "sub-badge";
        document.getElementById("sub-plan-name").textContent = planLabel;
        document.getElementById("sub-plan-name").className = "sub-status-val";
        document.getElementById("plan-chooser").style.display = "none";
        document.getElementById("plan-active").style.display  = "block";
      }
    });
}

function doSave() {
  var btn = document.getElementById("btn-save");
  btn.disabled = true; btn.textContent = "Saving...";
  sb.from("profiles").upsert({
    id: currentUser.id,
    first_name: document.getElementById("first").value.trim(),
    last_name:  document.getElementById("last").value.trim(),
    company:    document.getElementById("company").value.trim(),
    role:       document.getElementById("role").value,
    country:    document.getElementById("country").value,
    linkedin:   document.getElementById("linkedin").value.trim()
  }).then(function(res) {
    btn.disabled = false; btn.textContent = "Save Changes";
    if (res.error) { setMsg("msg-profile", res.error.message, "err"); return; }
    setMsg("msg-profile", "Saved.", "ok");
    loadProfile();
  });
}

function doPassword() {
  var pw1 = document.getElementById("pw1").value;
  var pw2 = document.getElementById("pw2").value;
  if (!pw1) { setMsg("msg-pw","Enter a new password.","err"); return; }
  if (pw1.length < 8) { setMsg("msg-pw","Password must be at least 8 characters.","err"); return; }
  if (pw1 !== pw2) { setMsg("msg-pw","Passwords do not match.","err"); return; }
  sb.auth.updateUser({ password: pw1 }).then(function(res) {
    if (res.error) { setMsg("msg-pw", res.error.message, "err"); return; }
    setMsg("msg-pw","Password updated.","ok");
    document.getElementById("pw1").value = "";
    document.getElementById("pw2").value = "";
  });
}

function handleSubscribe() {
  var btn = document.getElementById("btn-subscribe");
  btn.disabled = true;
  btn.textContent = "Redirecting...";
  setMsg("msg-sub","","");

  fetch(SUPABASE_URL + "/functions/v1/create-checkout", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: currentUser.id, email: currentUser.email, plan: selectedPlan })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.error) {
      btn.disabled = false;
      btn.textContent = "Upgrade to Pro";
      setMsg("msg-sub", "Error: " + data.error, "err");
      return;
    }
    window.location.href = data.url;
  })
  .catch(function(err) {
    btn.disabled = false;
    btn.textContent = "Upgrade to Pro";
    setMsg("msg-sub", "Network error. Please try again.", "err");
  });
}

function checkStripeReturn() {
  var params = new URLSearchParams(window.location.search);
  if (params.get("subscribed") === "1") {
    var plan = params.get("plan") || "monthly";
    var planLabel = plan === "yearly" ? "Pro Yearly" : "Pro Monthly";
    document.getElementById("sub-badge").textContent = "Active";
    document.getElementById("sub-badge").className = "sub-badge";
    document.getElementById("sub-plan-name").textContent = planLabel;
    document.getElementById("sub-plan-name").className = "sub-status-val";
    document.getElementById("plan-chooser").style.display = "none";
    document.getElementById("plan-active").style.display  = "block";
    setMsg("msg-sub-active", "Subscription activated! Welcome to SunHash Pro.", "ok");
    window.history.replaceState({}, "", "profile.html");
  }
  if (params.get("cancelled") === "1") {
    setMsg("msg-sub", "Payment cancelled.", "");
    window.history.replaceState({}, "", "profile.html");
  }
}

function doDelete() {
  if (!confirm("This will permanently delete all your data. This cannot be undone.")) return;
  if (!confirm("Are you sure? This cannot be reversed.")) return;
  sb.from("projects").delete().eq("user_id", currentUser.id).then(function() {
    sb.from("profiles").delete().eq("id", currentUser.id).then(function() {
      sb.rpc("delete_user").then(function() {
        sb.auth.signOut().then(function() { window.location.href = "index.html"; });
      });
    });
  });
}

function doSignout() { sb.auth.signOut(); }
</script>
</body>
</html>
