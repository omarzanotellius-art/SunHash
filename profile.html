<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash - Profile</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@700;900&family=Barlow:wght@400;600&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Barlow', sans-serif; background: #E4E4E0; color: #111; min-height: 100vh; }
body.hidden { visibility: hidden; }
a { text-decoration: none; }
.topbar { position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; background: #111; border-bottom: 3px solid #DDFF00; display: flex; align-items: center; justify-content: space-between; padding: 0 32px; }
.logo { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; color: #fff; }
.logo span { color: #DDFF00; }
.tb-right { display: flex; align-items: center; gap: 10px; }
.btn-back { padding: 7px 14px; border: 1px solid #444; color: #888; font-family: 'Barlow Condensed', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
.btn-back:hover { border-color: #fff; color: #fff; }
.btn-out { background: none; border: 1px solid #444; color: #777; font-family: 'Barlow Condensed', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 1px; padding: 7px 14px; cursor: pointer; text-transform: uppercase; }
.btn-out:hover { border-color: #E83535; color: #E83535; }
.page { padding-top: 56px; }
.hero { background: #111; padding: 40px 32px; display: flex; align-items: center; gap: 24px; flex-wrap: wrap; }
.av-lg { width: 64px; height: 64px; background: #DDFF00; color: #111; font-family: 'Barlow Condensed', sans-serif; font-size: 26px; font-weight: 900; display: flex; align-items: center; justify-content: center; border: 2px solid #111; flex-shrink: 0; }
.hero-name { font-family: 'Barlow Condensed', sans-serif; font-size: 36px; font-weight: 900; text-transform: uppercase; letter-spacing: -1px; color: #fff; }
.hero-sub { font-size: 13px; color: #555; margin-top: 4px; }
.body { max-width: 900px; margin: 0 auto; padding: 0 32px 80px; display: grid; grid-template-columns: 1fr 1fr; }
.sec { border: 2px solid #111; border-top: none; border-right: none; background: #F0F0EC; }
.sec:nth-child(odd) { border-right: 2px solid #111; }
.sec-hdr { background: #111; padding: 12px 20px; }
.sec-title { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: #DDFF00; }
.sec-body { padding: 20px; }
.field { margin-bottom: 14px; }
.field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
label { display: block; font-family: 'Barlow Condensed', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: #888; margin-bottom: 5px; }
input, select { width: 100%; padding: 10px 12px; background: #E4E4E0; border: 2px solid #111; font-family: 'Barlow', sans-serif; font-size: 14px; color: #111; outline: none; -webkit-appearance: none; }
input:focus, select:focus { box-shadow: 3px 3px 0 #DDFF00; }
input[readonly] { background: #D4D4D0; color: #888; cursor: not-allowed; }
.btn { padding: 12px 20px; background: #111; border: 2px solid #111; color: #DDFF00; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; }
.btn:hover { background: #DDFF00; color: #111; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-danger { padding: 12px 20px; background: none; border: 2px solid #E83535; color: #E83535; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; }
.btn-danger:hover { background: #E83535; color: #fff; }
.msg { margin-top: 10px; font-size: 12px; min-height: 18px; }
.msg.err { color: #E83535; }
.msg.ok { color: #22883a; }
.full { grid-column: 1 / -1; }
@media(max-width:600px){ .body { grid-template-columns: 1fr; padding: 0 16px 60px; } .sec:nth-child(odd) { border-right: none; } .field-row { grid-template-columns: 1fr; } }
</style>
</head>
<body class="hidden">

<div class="topbar">
  <a href="dashboard.html" class="logo">Sun<span>Hash</span></a>
  <div class="tb-right">
    <a href="dashboard.html" class="btn-back">Back to Dashboard</a>
    <button class="btn-out" onclick="doSignout()">Sign Out</button>
  </div>
</div>

<div class="page">
  <div class="hero">
    <div class="av-lg" id="av">?</div>
    <div>
      <div class="hero-name" id="hero-name">Loading...</div>
      <div class="hero-sub" id="hero-sub"></div>
    </div>
  </div>

  <div class="body">

    <div class="sec">
      <div class="sec-hdr"><div class="sec-title">Personal Info</div></div>
      <div class="sec-body">
        <div class="field-row">
          <div class="field"><label>First name</label><input type="text" id="first" placeholder="Alessandro"/></div>
          <div class="field"><label>Last name</label><input type="text" id="last" placeholder="Rossi"/></div>
        </div>
        <div class="field"><label>Company</label><input type="text" id="company" placeholder="Company name"/></div>
        <div class="field">
          <label>Role</label>
          <select id="role">
            <option value="">Select role...</option>
            <option>Developer / Project Owner</option>
            <option>Investor / Lender</option>
            <option>EPC Contractor</option>
            <option>Independent Engineer</option>
            <option>Legal Counsel</option>
            <option>Financial Advisor</option>
            <option>Other</option>
          </select>
        </div>
        <div class="field">
          <label>Country</label>
          <select id="country">
            <option value="">Select country...</option>
            <optgroup label="Europe"><option>Italy</option><option>Spain</option><option>France</option><option>Germany</option><option>United Kingdom</option><option>Portugal</option><option>Netherlands</option><option>Poland</option><option>Greece</option><option>Romania</option><option>Other Europe</option></optgroup>
            <optgroup label="Americas"><option>United States</option><option>Canada</option><option>Brazil</option><option>Mexico</option><option>Chile</option><option>Other Americas</option></optgroup>
            <optgroup label="Middle East and Africa"><option>UAE</option><option>Saudi Arabia</option><option>South Africa</option><option>Other MEA</option></optgroup>
            <optgroup label="Asia Pacific"><option>Australia</option><option>India</option><option>Japan</option><option>Other APAC</option></optgroup>
          </select>
        </div>
        <div class="field">
          <label>LinkedIn profile <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:11px;color:#888;">optional</span></label>
          <input type="url" id="linkedin" placeholder="https://linkedin.com/in/yourname"/>
        </div>
        <button class="btn" id="btn-save" onclick="doSave()">Save Changes</button>
        <div class="msg" id="msg-profile"></div>
      </div>
    </div>

    <div class="sec">
      <div class="sec-hdr"><div class="sec-title">Account &amp; Security</div></div>
      <div class="sec-body">
        <div class="field">
          <label>Email address</label>
          <input type="email" id="email" readonly/>
        </div>
        <p style="font-size:12px;color:#888;line-height:1.6;margin-bottom:16px;">To change your email contact <a href="mailto:support@sunhash.io" style="color:#111;">support@sunhash.io</a></p>
        <div class="field"><label>New password</label><input type="password" id="pw1" placeholder="Leave blank to keep current"/></div>
        <div class="field"><label>Confirm password</label><input type="password" id="pw2" placeholder="Repeat new password"/></div>
        <button class="btn" onclick="doPassword()">Update Password</button>
        <div class="msg" id="msg-pw"></div>
      </div>
    </div>

    <div class="sec full" style="border-right: 2px solid #111; margin-top: 0;">
      <div class="sec-hdr" style="background:#1a0000;"><div class="sec-title" style="color:#ff6b6b;">Danger Zone</div></div>
      <div class="sec-body" style="display:flex;align-items:center;justify-content:space-between;gap:24px;flex-wrap:wrap;">
        <p style="font-size:13px;color:#888;line-height:1.7;max-width:500px;">Deleting your account is permanent. All projects and reports will be removed and cannot be recovered.</p>
        <button class="btn-danger" onclick="doDelete()">Delete My Account</button>
      </div>
    </div>

  </div>
</div>

<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var currentUser = null;

function setMsg(id, text, type) {
  var el = document.getElementById(id);
  el.textContent = text;
  el.className = "msg " + (type || "");
  if (type === "ok") setTimeout(function(){ el.textContent = ""; el.className = "msg"; }, 4000);
}

var authTimeout = setTimeout(function() {
  window.location.href = "login.html";
}, 3000);

sb.auth.onAuthStateChange(function(event, session) {
  if (session) {
    clearTimeout(authTimeout);
    document.body.classList.remove("hidden");
    currentUser = session.user;
    document.getElementById("email").value = session.user.email || "";
    loadProfile();
    if (window.location.hash.indexOf("type=recovery") !== -1) {
      document.getElementById("pw1").focus();
    }
  } else if (event === "INITIAL_SESSION" || event === "SIGNED_OUT") {
    window.location.href = "login.html";
  }
});

function loadProfile() {
  sb.from("profiles").select("first_name,last_name,company,role,country,linkedin").eq("id", currentUser.id).single()
    .then(function(res) {
      if (!res.data) return;
      var d = res.data;
      var first = d.first_name || "";
      var last = d.last_name || "";
      var initials = ((first[0] || "") + (last[0] || "")).toUpperCase() || "?";
      document.getElementById("av").textContent = initials;
      document.getElementById("hero-name").textContent = (first + " " + last).trim() || currentUser.email;
      document.getElementById("hero-sub").textContent = [d.role, d.company, d.country].filter(Boolean).join(" - ");
      document.getElementById("first").value = first;
      document.getElementById("last").value = last;
      document.getElementById("company").value = d.company || "";
      document.getElementById("linkedin").value = d.linkedin || "";
      var roleEl = document.getElementById("role");
      for (var i = 0; i < roleEl.options.length; i++) {
        if (roleEl.options[i].value === d.role) { roleEl.selectedIndex = i; break; }
      }
      var countryEl = document.getElementById("country");
      for (var i = 0; i < countryEl.options.length; i++) {
        if (countryEl.options[i].value === d.country) { countryEl.selectedIndex = i; break; }
      }
    });
}

function doSave() {
  var btn = document.getElementById("btn-save");
  btn.disabled = true; btn.textContent = "Saving...";
  sb.from("profiles").upsert({
    id: currentUser.id,
    first_name: document.getElementById("first").value.trim(),
    last_name: document.getElementById("last").value.trim(),
    company: document.getElementById("company").value.trim(),
    role: document.getElementById("role").value,
    country: document.getElementById("country").value,
    linkedin: document.getElementById("linkedin").value.trim()
  }).then(function(res) {
    btn.disabled = false; btn.textContent = "Save Changes";
    if (res.error) { setMsg("msg-profile", res.error.message, "err"); return; }
    setMsg("msg-profile", "Saved.", "ok");
    loadProfile();
  });
}

function doPassword() {
  var pw1 = document.getElementById("pw1").value;
  var pw2 = document.getElementById("pw2").value;
  if (!pw1) { setMsg("msg-pw", "Enter a new password.", "err"); return; }
  if (pw1.length < 8) { setMsg("msg-pw", "Password must be at least 8 characters.", "err"); return; }
  if (pw1 !== pw2) { setMsg("msg-pw", "Passwords do not match.", "err"); return; }
  sb.auth.updateUser({ password: pw1 }).then(function(res) {
    if (res.error) { setMsg("msg-pw", res.error.message, "err"); return; }
    setMsg("msg-pw", "Password updated.", "ok");
    document.getElementById("pw1").value = "";
    document.getElementById("pw2").value = "";
  });
}

function doDelete() {
  if (!confirm("This will permanently delete all your data. This cannot be undone.")) return;
  if (!confirm("Are you sure? This cannot be reversed.")) return;
  // Delete projects and profile data
  sb.from("projects").delete().eq("user_id", currentUser.id).then(function() {
    sb.from("profiles").delete().eq("id", currentUser.id).then(function() {
      // Delete the auth user via the RPC function
      sb.rpc("delete_user").then(function(res) {
        sb.auth.signOut().then(function() {
          window.location.href = "index.html";
        });
      });
    });
  });
}

function doSignout() {
  sb.auth.signOut();
}
</script>

</body>
</html>
