<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash - Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #E4E4E0; color: #3A3A3A; min-height: 100vh; }
body.hidden { visibility: hidden; }
a { text-decoration: none; }
.topbar { position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; background: #111; border-bottom: 3px solid #FFFF00; display: flex; align-items: center; justify-content: space-between; padding: 0 32px; }
.logo { font-family: 'Inter', sans-serif; font-size: 22px; font-weight: 900; letter-spacing: 0.3px; text-transform: uppercase; color: #fff; }
.logo span { color: #FFFF00; }
.tb-right { display: flex; align-items: center; gap: 12px; }
.user-chip { display: flex; align-items: center; gap: 8px; background: #1E1E1E; padding: 4px 12px 4px 4px; cursor: pointer; text-decoration: none; }
.avatar { width: 28px; height: 28px; background: #FFFF00; color: #111; font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 900; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.user-name { font-size: 13px; font-weight: 600; color: #fff; }
.btn-out { background: none; border: 1px solid #444; color: #777; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.1px; padding: 7px 14px; cursor: pointer; text-transform: uppercase; }
.btn-out:hover { border-color: #fff; color: #fff; }
.page { padding-top: 56px; }
.hero { background: #111; padding: 40px 32px; display: flex; align-items: flex-end; justify-content: space-between; gap: 24px; flex-wrap: wrap; }
.hero-tag { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; color: #FFFF00; margin-bottom: 8px; }
.hero h1 { font-family: 'Inter', sans-serif; font-size: 48px; font-weight: 900; letter-spacing: -1.5px; text-transform: uppercase; color: #fff; line-height: 0.95; }
.hero h1 em { color: #FFFF00; font-style: normal; }
.btn-new { padding: 14px 24px; background: #FFFF00; border: 2px solid #3A3A3A; color: #3A3A3A; font-family: 'Inter', sans-serif; font-size: 15px; font-weight: 900; letter-spacing: 0.3px; text-transform: uppercase; cursor: pointer; white-space: nowrap; }
.btn-new:hover { background: #fff; }
.stats { display: grid; grid-template-columns: repeat(4, 1fr); border: 2px solid #111; border-top: none; }
.stat { padding: 20px 24px; border-right: 2px solid #111; }
.stat:last-child { border-right: none; }
.stat:nth-child(1) { background: #111; }
.stat:nth-child(2) { background: #D4D4D0; }
.stat:nth-child(3) { background: #FFFF00; }
.stat:nth-child(4) { background: #D4D4D0; }
.stat-lbl { font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 6px; }
.stat:nth-child(1) .stat-lbl { color: #FFFF00; }
.stat:nth-child(2) .stat-lbl, .stat:nth-child(4) .stat-lbl { color: #888; }
.stat:nth-child(3) .stat-lbl { color: #555; }
.stat-val { font-family: 'Inter', sans-serif; font-size: 36px; font-weight: 900; letter-spacing: -0.5px; line-height: 1; }
.stat:nth-child(1) .stat-val { color: #fff; }
.body { padding: 24px 32px 80px; }
.filter-bar { display: flex; align-items: center; justify-content: space-between; gap: 16px; padding-bottom: 20px; flex-wrap: wrap; }
.filters { display: flex; border: 2px solid #111; }
.fbtn { padding: 8px 16px; background: none; border: none; border-right: 2px solid #111; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.1px; text-transform: uppercase; color: #888; cursor: pointer; }
.fbtn:last-child { border-right: none; }
.fbtn.active { background: #111; color: #FFFF00; }
.grid { display: grid; grid-template-columns: repeat(3, 1fr); border-left: 2px solid #111; border-top: 2px solid #111; }
.card { background: #F0F0EC; border-right: 2px solid #111; border-bottom: 2px solid #111; display: flex; flex-direction: column; }
.card-hdr { padding: 18px 20px 14px; border-bottom: 2px solid #111; }
.card-stage { font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.3px; text-transform: uppercase; color: #888; margin-bottom: 4px; }
.card-name { font-family: 'Inter', sans-serif; font-size: 20px; font-weight: 900; letter-spacing: -0.5px; margin-bottom: 3px; }
.card-loc { font-size: 12px; color: #888; }
.card-scores { padding: 12px 20px; border-bottom: 2px solid #111; display: flex; gap: 10px; align-items: center; }
.score-circle { width: 48px; height: 48px; border: 2px solid #111; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.score-num { font-family: 'Inter', sans-serif; font-size: 20px; font-weight: 900; }
.score-circle.hi { background: #FFFF00; }
.score-circle.lo .score-num { color: #E83535; }
.bars { flex: 1; }
.bar-row { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
.bar-row:last-child { margin-bottom: 0; }
.bar-lbl { font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; text-transform: uppercase; color: #888; width: 52px; flex-shrink: 0; }
.bar-track { flex: 1; height: 3px; background: #D4D4D0; }
.bar-fill { height: 100%; background: #111; }
.bar-fill.hi { background: #FFFF00; border: 1px solid #999; }
.bar-fill.lo { background: #E83535; }
.bar-num { font-family: 'Inter', sans-serif; font-size: 9px; color: #888; width: 20px; text-align: right; }
.card-ftr { padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; margin-top: auto; }
.card-date { font-size: 11px; color: #888; }
.badge { font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.1px; text-transform: uppercase; padding: 3px 8px; border: 1px solid; }
.badge.draft { color: #888; border-color: #ccc; }
.badge.in-progress { color: #FF8C00; border-color: #FF8C00; }
.badge.complete { background: #111; color: #FFFF00; border-color: #111; }
.empty { border: 2px solid #111; border-top: none; padding: 60px; text-align: center; background: #F0F0EC; display: none; }
.empty.show { display: block; }
.empty h3 { font-family: 'Inter', sans-serif; font-size: 24px; font-weight: 900; text-transform: uppercase; margin-bottom: 8px; }
.empty p { font-size: 14px; color: #888; margin-bottom: 20px; }
.overlay { display: none; position: fixed; inset: 0; z-index: 500; background: #111; flex-direction: column; }
.overlay.open { display: flex; }
.ov-bar { height: 52px; background: #111; border-bottom: 2px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 28px; flex-shrink: 0; }
.ov-lbl { font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; color: #FFFF00; }
.btn-close { background: none; border: 1px solid #444; color: #888; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.1px; padding: 7px 14px; cursor: pointer; text-transform: uppercase; }
.btn-close:hover { border-color: #fff; color: #fff; }
#tally-frame { flex: 1; border: none; width: 100%; background: #fff; }
@media(max-width:900px){ .grid { grid-template-columns: repeat(2,1fr); } .stats { grid-template-columns: repeat(2,1fr); } }
@media(max-width:600px){ .grid { grid-template-columns: 1fr; } }
</style>
</head>
<body class="hidden">

<div class="topbar">
  <div class="logo">Sun<span>Hash</span></div>
  <div class="tb-right">
    <a href="profile.html" class="user-chip">
      <div class="avatar" id="av">?</div>
      <div class="user-name" id="uname">Loading...</div>
    </a>
    <button class="btn-out" onclick="doSignout()">Sign Out</button>
  </div>
</div>

<div class="page">
  <div class="hero">
    <div>
      <div class="hero-tag">Dashboard</div>
      <h1>Welcome back,<br><em id="firstname">-</em></h1>
    </div>
    <button class="btn-new" onclick="openForm()">+ New Assessment</button>
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-lbl">Assessments</div><div class="stat-val" id="st-total">0</div></div>
    <div class="stat"><div class="stat-lbl">Reports</div><div class="stat-val" id="st-reports">0</div></div>
    <div class="stat"><div class="stat-lbl">Avg Score</div><div class="stat-val" id="st-avg">-</div></div>
    <div class="stat"><div class="stat-lbl">In Progress</div><div class="stat-val" id="st-prog">0</div></div>
  </div>

  <div class="body">
    <div class="filter-bar">
      <div class="filters">
        <button class="fbtn active" onclick="filter(this,'all')">All</button>
        <button class="fbtn" onclick="filter(this,'complete')">Complete</button>
        <button class="fbtn" onclick="filter(this,'in-progress')">In Progress</button>
        <button class="fbtn" onclick="filter(this,'draft')">Draft</button>
      </div>
    </div>
    <div class="grid" id="grid"></div>
    <div class="empty" id="empty">
      <h3>No assessments yet</h3>
      <p>Start your first project risk assessment.</p>
      <button class="btn-new" onclick="openForm()">+ Start Assessment</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="ov-bar">
    <div class="ov-lbl">New Assessment</div>
    <button class="btn-close" onclick="closeForm()">X Close</button>
  </div>
  <iframe id="tally-frame" src="" title="Assessment Form"></iframe>
</div>

<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var TALLY_FORM_ID = "https://tally.so/r/BzXLPR";
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var projects = [];
var currentFilter = "all";
var currentUser = null;

// Redirect to login if no session after 3 seconds
var authTimeout = setTimeout(function() {
  window.location.href = "login.html";
}, 3000);

sb.auth.onAuthStateChange(function(event, session) {
  if (session) {
    clearTimeout(authTimeout);
    document.body.classList.remove("hidden");
    currentUser = session.user;
    loadProfile(session.user.id);
    loadProjects(session.user.id);
  } else if (event === "INITIAL_SESSION" || event === "SIGNED_OUT") {
    window.location.href = "login.html";
  }
});

function loadProfile(uid) {
  sb.from("profiles").select("first_name,last_name,company").eq("id", uid).single()
    .then(function(res) {
      if (!res.data) return;
      var first = res.data.first_name || "";
      var last = res.data.last_name || "";
      var initials = ((first[0] || "") + (last[0] || "")).toUpperCase() || "?";
      document.getElementById("av").textContent = initials;
      document.getElementById("uname").textContent = first + " " + last;
      document.getElementById("firstname").textContent = first || "there";
    });
}

function loadProjects(uid) {
  sb.from("projects").select("*").eq("user_id", uid).order("created_at", { ascending: false })
    .then(function(res) {
      projects = res.data || [];
      renderStats();
      renderCards();
    });
}

function renderStats() {
  var complete = projects.filter(function(p){ return p.status === "complete"; });
  var scored = complete.filter(function(p){ return p.score_overall != null; });
  var avg = scored.length ? Math.round(scored.reduce(function(a,p){ return a + p.score_overall; }, 0) / scored.length) : null;
  document.getElementById("st-total").textContent = projects.length;
  document.getElementById("st-reports").textContent = complete.length;
  document.getElementById("st-avg").textContent = avg || "-";
  document.getElementById("st-prog").textContent = projects.filter(function(p){ return p.status === "in-progress"; }).length;
}

function scoreClass(v) { return v >= 70 ? "hi" : v < 50 ? "lo" : ""; }

function renderCards() {
  var list = projects;
  if (currentFilter !== "all") list = list.filter(function(p){ return p.status === currentFilter; });
  var grid = document.getElementById("grid");
  var empty = document.getElementById("empty");
  grid.innerHTML = "";
  if (!list.length) { empty.className = "empty show"; return; }
  empty.className = "empty";
  list.forEach(function(p) {
    var date = new Date(p.created_at).toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" });
    var status = p.status || "draft";
    var sc = p.score_overall;
    var cats = [
      { l:"Design", v:p.score_design },
      { l:"Build",  v:p.score_construct },
      { l:"Legal",  v:p.score_contract },
      { l:"Grid",   v:p.score_intercon },
      { l:"Finance",v:p.score_financial }
    ].filter(function(c){ return c.v != null; });
    var barsHtml = cats.map(function(c){
      return '<div class="bar-row"><span class="bar-lbl">' + c.l + '</span><div class="bar-track"><div class="bar-fill ' + scoreClass(c.v) + '" style="width:' + c.v + '%"></div></div><span class="bar-num">' + c.v + '</span></div>';
    }).join("");
    var div = document.createElement("div");
    div.className = "card";
    div.innerHTML = '<div class="card-hdr"><div class="card-stage">' + (p.stage || "Pre-construction") + (p.capacity_mw ? " - " + p.capacity_mw + " MWp" : "") + '</div><div class="card-name">' + (p.name || "Unnamed Project") + '</div><div class="card-loc">' + (p.location || "") + '</div></div><div class="card-scores"><div class="score-circle ' + (sc != null ? scoreClass(sc) : "") + '"><span class="score-num">' + (sc != null ? sc : "-") + '</span></div><div class="bars">' + (barsHtml || '<span style="font-size:12px;color:#888;">Assessment in progress</span>') + '</div></div><div class="card-ftr"><span class="card-date">' + date + '</span><span class="badge ' + status + '">' + status.replace("-"," ") + '</span></div>';
    grid.appendChild(div);
  });
}

function filter(btn, status) {
  document.querySelectorAll(".fbtn").forEach(function(b){ b.classList.remove("active"); });
  btn.classList.add("active");
  currentFilter = status;
  renderCards();
}

function openForm() {
  document.getElementById("tally-frame").src = "https://tally.so/embed/" + TALLY_FORM_ID + "?transparentBackground=1";
  document.getElementById("overlay").classList.add("open");
  document.body.style.overflow = "hidden";
}

function closeForm() {
  document.getElementById("overlay").classList.remove("open");
  document.getElementById("tally-frame").src = "";
  document.body.style.overflow = "";
  if (currentUser) loadProjects(currentUser.id);
}

function doSignout() {
  sb.auth.signOut();
}
</script>

</body>
</html>
