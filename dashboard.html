<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SunHash - Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #eef0f4; color: #1a1f2e; min-height: 100vh; }
body.hidden { visibility: hidden; }
a { text-decoration: none; }
.topbar { position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; background: #111; border-bottom: 3px solid #FFFF00; display: flex; align-items: center; justify-content: space-between; padding: 0 32px; }
.logo { font-family: 'Inter', sans-serif; font-size: 22px; font-weight: 900; letter-spacing: 0.3px; text-transform: uppercase; color: #fff; }
.logo span { color: #FFFF00; }
.tb-right { display: flex; align-items: center; gap: 12px; }
.user-chip { display: flex; align-items: center; gap: 8px; background: #1E1E1E; padding: 4px 12px 4px 4px; cursor: pointer; text-decoration: none; }
.avatar { width: 28px; height: 28px; background: #FFFF00; color: #111; font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 900; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.user-name { font-size: 13px; font-weight: 600; color: #fff; }
.btn-out { background: none; border: 1px solid #444; color: #777; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.1px; padding: 7px 14px; cursor: pointer; text-transform: uppercase; }
.btn-out:hover { border-color: #fff; color: #fff; }
.card-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
.card-summary { font-size: 11px; color: #888; margin-top: 8px; padding-top: 8px; border-top: 1px solid #D4D4D0; }
.card-intake-msg { padding: 12px 22px; font-size: 12px; color: #6b7585; font-style: italic; background: rgba(255,255,255,0.25); border-radius: 8px; margin: 0 12px 8px; }
.card-cats { padding: 8px 14px 12px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
.cat-btn { padding: 7px 6px; border: none; background: rgba(255,255,255,0.45); color: #1a1f2e; font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; letter-spacing: 0.2px; border-radius: 8px; transition: all .15s; text-align: center; }
.cat-btn:hover { background: #1a1f2e; color: #FFFF00; }
.cat-btn.done { background: #1a1f2e; color: #FFFF00; }
.btn-retake { padding: 5px 11px; border: none; background: rgba(255,255,255,0.4); color: #4a5568; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 20px; transition: all .15s; }
.btn-retake:hover { background: rgba(255,255,255,0.7); color: #1a1f2e; }
.btn-delete-card { padding: 5px 11px; border: none; background: rgba(192,57,43,0.12); color: #c0392b; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 20px; transition: all .15s; }
.btn-delete-card:hover { background: #c0392b; color: #fff; }
.btn-overview { padding: 5px 14px; border: none; background: #1a1f2e; color: #FFFF00; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.3px; border-radius: 20px; transition: all .15s; }
.btn-overview:hover { background: #FFFF00; color: #1a1f2e; }
.geo-check { display: inline-block; margin-left: 4px; font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 10px; }
.geo-ok  { color: #2e7d4f; background: rgba(46,125,79,0.12); }
.geo-warn { color: #e07b20; background: rgba(224,123,32,0.12); }
.maps-link { font-size: 12px; color: #5a6474; text-decoration: underline; }
.maps-link:hover { color: #1a1f2e; }
.page { padding-top: 56px; }
.hero { background: #111; padding: 40px 32px; display: flex; align-items: flex-end; justify-content: space-between; gap: 24px; flex-wrap: wrap; }
.hero-tag { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; color: #FFFF00; margin-bottom: 8px; }
.hero h1 { font-family: 'Inter', sans-serif; font-size: 48px; font-weight: 900; letter-spacing: -1.5px; text-transform: uppercase; color: #fff; line-height: 0.95; }
.hero h1 em { color: #FFFF00; font-style: normal; }
.btn-new { padding: 14px 24px; background: #FFFF00; border: 2px solid #3A3A3A; color: #3A3A3A; font-family: 'Inter', sans-serif; font-size: 15px; font-weight: 900; letter-spacing: 0.3px; text-transform: uppercase; cursor: pointer; white-space: nowrap; }
.btn-new:hover { background: #fff; }
.btn-refresh { width: 36px; height: 36px; background: none; border: 2px solid #333; color: #888; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.btn-refresh:hover { border-color: #FFFF00; color: #FFFF00; }
.stats { display: grid; grid-template-columns: repeat(4, 1fr); border: none; border-top: none; gap: 0; }
.stat { padding: 20px 24px; border-right: 1px solid rgba(0,0,0,0.08); }
.stat:last-child { border-right: none; }
.stat:nth-child(1) { background: #111; }
.stat:nth-child(2) { background: #e2e5ec; }
.stat:nth-child(3) { background: #FFFF00; }
.stat:nth-child(4) { background: #e2e5ec; }
.stat-lbl { font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 6px; }
.stat:nth-child(1) .stat-lbl { color: #FFFF00; }
.stat:nth-child(2) .stat-lbl, .stat:nth-child(4) .stat-lbl { color: #888; }
.stat:nth-child(3) .stat-lbl { color: #555; }
.stat-val { font-family: 'Inter', sans-serif; font-size: 36px; font-weight: 900; letter-spacing: -0.5px; line-height: 1; }
.stat:nth-child(1) .stat-val { color: #fff; }
.body { padding: 24px 32px 80px; } .grid-wrap { }
.filter-bar { display: flex; align-items: center; justify-content: space-between; gap: 16px; padding-bottom: 20px; flex-wrap: wrap; }
.filters { display: flex; border: 2px solid #1a1f2e; border-radius: 8px; overflow: hidden; }
.fbtn { padding: 8px 16px; background: none; border: none; border-right: 1px solid rgba(0,0,0,0.15); font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.1px; text-transform: uppercase; color: #6b7585; cursor: pointer; }
.fbtn:last-child { border-right: none; }
.fbtn.active { background: #1a1f2e; color: #FFFF00; }
.grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 4px 0; }
.card { background: #dde1ea; border-radius: 16px; display: flex; flex-direction: column; box-shadow: 0 2px 12px rgba(0,0,0,0.07); overflow: hidden; transition: transform 0.15s, box-shadow 0.15s; }
.card:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(0,0,0,0.12); }
.card-hdr { padding: 20px 22px 16px; }
.card-stage { font-size: 10px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; color: #5a6474; margin-bottom: 6px; }
.card-name { font-size: 21px; font-weight: 800; letter-spacing: -0.5px; color: #1a1f2e; margin-bottom: 4px; line-height: 1.15; }
.card-loc { font-size: 12px; color: #6b7585; }
.card-scores { padding: 12px 22px; background: rgba(255,255,255,0.4); display: flex; gap: 12px; align-items: center; }
.score-circle { width: 52px; height: 52px; border-radius: 50%; background: #1a1f2e; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
.score-num { font-size: 18px; font-weight: 900; color: #fff; }
.score-circle.hi { background: #1a1f2e; }
.score-circle.hi .score-num { color: #FFFF00; }
.score-circle.lo .score-num { color: #ff6b6b; }
.bars { flex: 1; }
.bar-row { display: flex; align-items: center; gap: 6px; margin-bottom: 5px; }
.bar-row:last-child { margin-bottom: 0; }
.bar-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #6b7585; width: 48px; flex-shrink: 0; }
.bar-track { flex: 1; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; }
.bar-fill { height: 100%; background: #1a1f2e; border-radius: 2px; }
.bar-fill.hi { background: #3a7d44; }
.bar-fill.lo { background: #c0392b; }
.bar-num { font-size: 9px; color: #6b7585; width: 20px; text-align: right; font-weight: 600; }
.card-ftr { padding: 12px 22px 16px; display: flex; align-items: center; justify-content: space-between; margin-top: auto; background: rgba(255,255,255,0.25); }
.card-date { font-size: 11px; color: #6b7585; font-weight: 500; }
.badge { font-size: 10px; font-weight: 700; letter-spacing: 0.3px; text-transform: uppercase; padding: 3px 10px; border-radius: 20px; border: none; }
.badge.draft { color: #6b7585; background: rgba(0,0,0,0.08); }
.badge.in-progress { color: #fff; background: #e07b20; }
.badge.complete { color: #fff; background: #2e7d4f; }
.empty { border-radius: 16px; background: #D8DDE6; padding: 60px; text-align: center; display: none; margin-top: 4px; }
.empty.show { display: block; }
.empty h3 { font-size: 24px; font-weight: 900; text-transform: uppercase; margin-bottom: 8px; color: #1a1f2e; }
.empty p { font-size: 14px; color: #6b7585; margin-bottom: 20px; }
.overlay { display: none; position: fixed; inset: 0; z-index: 500; background: #111; flex-direction: column; }
.overlay.open { display: flex; }
.ov-bar { height: 52px; background: #111; border-bottom: 2px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 28px; flex-shrink: 0; }
.ov-lbl { font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; color: #FFFF00; }
.btn-close { background: none; border: 1px solid #444; color: #888; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.1px; padding: 7px 14px; cursor: pointer; text-transform: uppercase; }
.btn-close:hover { border-color: #fff; color: #fff; }
#tally-frame { flex: 1; border: none; width: 100%; background: #fff; }
@media(max-width:900px){ .grid { grid-template-columns: repeat(2,1fr); } .stats { grid-template-columns: repeat(2,1fr); } }
@media(max-width:600px){ .grid { grid-template-columns: 1fr; } }
</style>
</head>
<body class="hidden">

<div class="topbar">
  <div class="logo">Sun<span>Hash</span></div>
  <div class="tb-right">
    <a href="profile.html" class="user-chip">
      <div class="avatar" id="av">?</div>
      <div class="user-name" id="uname">Loading...</div>
    </a>
    <button class="btn-out" onclick="doSignout()">Sign Out</button>
  </div>
</div>

<div class="page">
  <div class="hero">
    <div>
      <div class="hero-tag">Dashboard</div>
      <h1>Welcome back,<br><em id="firstname">-</em></h1>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <button class="btn-refresh" onclick="loadProjects(currentUser.id)" title="Refresh">&#8635;</button>
      <button class="btn-new" onclick="openForm()">+ New Assessment</button>
    </div>
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-lbl">Assessments</div><div class="stat-val" id="st-total">0</div></div>
    <div class="stat"><div class="stat-lbl">Reports</div><div class="stat-val" id="st-reports">0</div></div>
    <div class="stat"><div class="stat-lbl">Avg Score</div><div class="stat-val" id="st-avg">-</div></div>
    <div class="stat"><div class="stat-lbl">In Progress</div><div class="stat-val" id="st-prog">0</div></div>
  </div>

  <div class="body">
    <div class="filter-bar">
      <div class="filters">
        <button class="fbtn active" onclick="filter(this,'all')">All</button>
        <button class="fbtn" onclick="filter(this,'complete')">Complete</button>
        <button class="fbtn" onclick="filter(this,'in-progress')">In Progress</button>
        <button class="fbtn" onclick="filter(this,'draft')">Draft</button>
      </div>
    </div>
    <div class="grid" id="grid"></div>
    <div class="empty" id="empty">
      <h3>No assessments yet</h3>
      <p>Start your first project risk assessment.</p>
      <button class="btn-new" onclick="openForm()">+ Start Assessment</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="ov-bar">
    <div class="ov-lbl">New Assessment</div>
    <button class="btn-close" onclick="closeForm()">X Close</button>
  </div>
  <iframe id="tally-frame" src="" title="Assessment Form"></iframe>
</div>

<script>
var SUPABASE_URL = "https://pyetvugwochlqdxjchwp.supabase.co";
var SUPABASE_KEY = "sb_publishable_wcO7yhermAiLYrltUILrlw_thJ-I-de";
var TALLY_FORM_ID = "BzXLPR";  // intake form
// Six category form IDs - add these as you create the Tally forms
var CAT_FORM_DESIGN    = "1ArXEg";  // Design & Engineering
var CAT_FORM_CONSTRUCT = "0QEdP9";  // Construction
var CAT_FORM_CONTRACT  = "D4VBel";  // Contract & Legal
var CAT_FORM_INTERCON  = "Gxr6Le";  // Interconnection
var CAT_FORM_FINANCIAL = "rjl5Vo";  // Financial
var CAT_FORM_PERMIT    = "xXdr2d";  // Permitting
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var projects = [];
var currentFilter = "all";
var currentUser = null;

// Redirect to login if no session after 3 seconds
var authTimeout = setTimeout(function() {
  window.location.href = "login.html";
}, 3000);

sb.auth.onAuthStateChange(function(event, session) {
  if (session) {
    clearTimeout(authTimeout);
    document.body.classList.remove("hidden");
    currentUser = session.user;
    loadProfile(session.user.id);
    loadProjects(session.user.id);
  } else if (event === "INITIAL_SESSION" || event === "SIGNED_OUT") {
    window.location.href = "login.html";
  }
});

function loadProfile(uid) {
  sb.from("profiles").select("first_name,last_name,company").eq("id", uid).single()
    .then(function(res) {
      if (!res.data) return;
      var first = res.data.first_name || "";
      var last = res.data.last_name || "";
      var initials = ((first[0] || "") + (last[0] || "")).toUpperCase() || "?";
      document.getElementById("av").textContent = initials;
      document.getElementById("uname").textContent = first + " " + last;
      document.getElementById("firstname").textContent = first || "there";
    });
}

function loadProjects(uid) {
  sb.from("projects").select("*, tally_fields").eq("user_id", uid).order("created_at", { ascending: false })
    .then(function(res) {
      projects = res.data || [];
      renderStats();
      renderCards();
    });
}

function renderStats() {
  var complete = projects.filter(function(p){ return p.status === "complete"; });
  var scored = complete.filter(function(p){ return p.score_overall != null; });
  var avg = scored.length ? Math.round(scored.reduce(function(a,p){ return a + p.score_overall; }, 0) / scored.length) : null;
  document.getElementById("st-total").textContent = projects.length;
  document.getElementById("st-reports").textContent = complete.length;
  document.getElementById("st-avg").textContent = avg || "-";
  document.getElementById("st-prog").textContent = projects.filter(function(p){ return p.status === "in-progress"; }).length;
}

function scoreClass(v) { return v >= 70 ? "hi" : v < 50 ? "lo" : ""; }

// Category definitions
var CATS = [
  { key:"score_design",    label:"Design",        short:"Design"   },
  { key:"score_construct", label:"Construction",   short:"Build"    },
  { key:"score_contract",  label:"Contract",       short:"Legal"    },
  { key:"score_intercon",  label:"Interconnection",short:"Grid"     },
  { key:"score_financial", label:"Financial",      short:"Finance"  },
  { key:"score_permit",    label:"Permitting",     short:"Permit"   }
];

function renderCards() {
  var list = projects;
  if (currentFilter !== "all") list = list.filter(function(p){ return p.status === currentFilter; });
  var grid = document.getElementById("grid");
  var empty = document.getElementById("empty");
  grid.innerHTML = "";
  if (!list.length) { empty.className = "empty show"; return; }
  empty.className = "empty";

  list.forEach(function(p) {
    var date = new Date(p.created_at).toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" });
    var status = p.status || "draft";
    var sc = p.score_overall;

    // Shorten stage: strip anything in parentheses
    var stageShort = (p.stage || "").replace(/\s*\(.*?\)/g, "").trim();
    // Also shorten each part if stage contains " - "
    stageShort = stageShort.split(" - ").map(function(s){ return s.replace(/\s*\(.*?\)/g,"").trim(); }).join(" - ");

    // Score bars
    var scoredCats = CATS.filter(function(c){ return p[c.key] != null; });
    var barsHtml = scoredCats.map(function(c){
      var v = p[c.key];
      return '<div class="bar-row"><span class="bar-lbl">' + c.short + '</span><div class="bar-track"><div class="bar-fill ' + scoreClass(v) + '" style="width:' + v + '%"></div></div><span class="bar-num">' + v + '</span></div>';
    }).join("");

    // 6 category buttons in 3x2 grid
    var catBtns = CATS.map(function(c){
      var done = p[c.key] != null;
      return '<button class="cat-btn ' + (done ? "done" : "") + '" onclick="openCatForm(\'' + p.id + '\',\'' + c.key + '\')" title="' + c.label + '">' + c.short + (done ? " " + p[c.key] : "+") + '</button>';
    }).join("");

    // Location: only show "View on Maps" link, never raw URL
    var locHtml = "";
    if (p.location) {
      if (p.location.startsWith("http")) {
        locHtml = '<a href="' + p.location + '" target="_blank" class="maps-link">View on Maps</a>';
      } else {
        locHtml = p.location;
      }
    }

    // Geo check: get state from tally_fields directly (most reliable source)
    var fields = p.tally_fields || {};
    var stateFromFields = fields["in_which_state_is_the_project_located?"] ||
                          fields["In which State is the project located?"] || null;
    var geoCheckHtml = "";
    if (stateFromFields && p.location) {
      var geoKey = "geo_" + p.id;
      geoCheckHtml = '<span class="geo-check" id="' + geoKey + '">...</span>';
      setTimeout(function(pid, state, mapsUrl) {
        return function() { checkGeoMatch(pid, state, mapsUrl); };
      }(p.id, stateFromFields, p.location), 200);
    }

    // Info line: capacity + state
    var infoLine = [
      p.capacity_mw ? p.capacity_mw + " MWp" : null,
      stageShort || null
    ].filter(Boolean).join("  &middot;  ");

    // Left border color by status
    var borderColor = status === "complete" ? "#FFFF00" : status === "in-progress" ? "#FF8C00" : "#ccc";

    var div = document.createElement("div");
    div.className = "card";
    div.style.borderLeft = "4px solid " + borderColor;
    div.innerHTML =
      '<div class="card-hdr">' +
        // Top row: score circle top-right with sun icon inside when no score yet
        '<div style="display:flex;justify-content:flex-end;align-items:flex-start;margin-bottom:18px;">' +
          '<div class="score-circle ' + (sc != null ? scoreClass(sc) : "") + '">' +
            (sc != null
              ? '<span class="score-num">' + sc + '</span>'
              : '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>'
            ) +
          '</div>' +
        '</div>' +
        // Status badge
        '<span class="badge ' + status + '" style="margin-bottom:10px;display:inline-block;">' + status.replace("-"," ") + '</span>' +
        // Project name - large and bold at the bottom like "Hello, Omar"
        '<div class="card-name">' + (p.name || "Unnamed Project") + '</div>' +
        '<div class="card-loc" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:5px;">' +
          (locHtml ? locHtml : "") +
          geoCheckHtml +
        '</div>' +
        (infoLine ? '<div class="card-stage" style="margin-top:6px;">' + infoLine + '</div>' : '') +
      '</div>' +
      (scoredCats.length
        ? '<div class="card-scores"><div class="bars">' + barsHtml + '</div></div>'
        : '<div class="card-intake-msg">Intake complete. Start category assessments below.</div>'
      ) +
      '<div class="card-cats">' + catBtns + '</div>' +
      '<div class="card-ftr">' +
        '<span class="card-date">' + date + '</span>' +
        '<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">' +
          '<button class="btn-delete-card" onclick="deleteProject(\'' + p.id + '\',\'' + (p.name || "this project").replace(/'/g,"") + '\')" title="Delete">Delete</button>' +
          '<button class="btn-retake" onclick="openForm(\'' + p.id + '\')" title="Edit intake">Edit intake</button>' +
          '<button class="btn-overview" onclick="openOverview(\'' + p.id + '\')">Overview</button>' +
        '</div>' +
      '</div>';
    grid.appendChild(div);
  });
}

function openCatForm(projectId, catKey) {
  // Map category key to its Tally form ID
  var catForms = {
    score_design:    CAT_FORM_DESIGN,
    score_construct: CAT_FORM_CONSTRUCT,
    score_contract:  CAT_FORM_CONTRACT,
    score_intercon:  CAT_FORM_INTERCON,
    score_financial: CAT_FORM_FINANCIAL,
    score_permit:    CAT_FORM_PERMIT
  };
  var formId = catForms[catKey];
  if (!formId || formId === "") {
    alert("This assessment form is not set up yet. Add the Tally form ID to dashboard.html.");
    return;
  }
  var url = "https://tally.so/embed/" + formId + "?transparentBackground=1&hideTitle=1";
  if (currentUser) url += "&email=" + encodeURIComponent(currentUser.email);
  url += "&project_id=" + projectId;
  document.getElementById("tally-frame").src = url;
  document.getElementById("overlay").classList.add("open");
  document.body.style.overflow = "hidden";
}

function filter(btn, status) {
  document.querySelectorAll(".fbtn").forEach(function(b){ b.classList.remove("active"); });
  btn.classList.add("active");
  currentFilter = status;
  renderCards();
}

function openForm(projectId) {
  var base = "https://tally.so/embed/" + TALLY_FORM_ID + "?transparentBackground=1&hideTitle=1";
  // Pass user_id and email as hidden fields so the webhook can identify the user
  if (currentUser) {
    base += "&user_id=" + encodeURIComponent(currentUser.id);
    base += "&email=" + encodeURIComponent(currentUser.email);
  }
  if (projectId) base += "&project_id=" + projectId;
  document.getElementById("tally-frame").src = base;
  document.getElementById("overlay").classList.add("open");
  document.body.style.overflow = "hidden";
}

var pollTimer = null;

function closeForm() {
  document.getElementById("overlay").classList.remove("open");
  document.getElementById("tally-frame").src = "";
  document.body.style.overflow = "";
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
  // Reload immediately and again after 3s to catch webhook delay
  if (currentUser) {
    loadProjects(currentUser.id);
    setTimeout(function() { loadProjects(currentUser.id); }, 3000);
  }
}

// Listen for Tally completion message (auto-close overlay)
window.addEventListener("message", function(e) {
  var msg = e.data;
  if (!msg) return;
  var str = typeof msg === "string" ? msg : JSON.stringify(msg);
  if (str.indexOf("Tally.FormSubmitted") !== -1 || str.indexOf("formSubmitted") !== -1) {
    setTimeout(function() { closeForm(); }, 1500);
  }
});

// Geo check: verify the Maps link location matches the selected state
// Strategy: use a hidden iframe to resolve the short URL, then extract coords from the redirected URL
function checkGeoMatch(projectId, stateName, mapsUrl) {
  var el = document.getElementById("geo_" + projectId);
  if (!el) return;
  el.textContent = "...";

  // Try to extract lat/lng from a full Google Maps URL
  var coordPatterns = [
    /@(-?[0-9]+\.[0-9]+),(-?[0-9]+\.[0-9]+)/,
    /q=(-?[0-9]+\.[0-9]+),(-?[0-9]+\.[0-9]+)/,
    /ll=(-?[0-9]+\.[0-9]+),(-?[0-9]+\.[0-9]+)/
  ];
  var lat = null, lng = null;
  for (var i = 0; i < coordPatterns.length; i++) {
    var m = mapsUrl.match(coordPatterns[i]);
    if (m) { lat = parseFloat(m[1]); lng = parseFloat(m[2]); break; }
  }

  if (lat !== null && lng !== null) {
    // Full URL with coords: reverse geocode via Nominatim
    fetch("https://nominatim.openstreetmap.org/reverse?lat=" + lat + "&lon=" + lng + "&format=json&accept-language=en")
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var addr = data && data.address ? data.address : {};
        var locState = (addr.state || "").toLowerCase().trim();
        var selState = stateName.toLowerCase().trim();
        // Must match properly - not just substring (Indiana != Indiana-polis etc)
        var match = (locState === selState) ||
                    (locState.indexOf(selState) !== -1 && selState.length > 4) ||
                    (selState.indexOf(locState) !== -1 && locState.length > 4);
        if (match) {
          el.textContent = "State OK";
          el.className = "geo-check geo-ok";
          el.title = "Map location confirmed in " + (addr.state || stateName);
        } else {
          el.textContent = "Mismatch: map is in " + (addr.state || "unknown");
          el.className = "geo-check geo-warn";
          el.title = "Selected: " + stateName + " / Map shows: " + (addr.state || "unknown");
        }
      })
      .catch(function() { el.style.display = "none"; });
  } else {
    // Short URL (goo.gl/maps.app) - cannot resolve client-side due to CORS
    // Show orange warning so user knows to verify manually
    el.textContent = "Verify location";
    el.className = "geo-check geo-warn";
    el.title = "Short URL - cannot auto-verify. Confirm map is in " + stateName;
  }
}

// Overview page - placeholder until full reporting is built
function openOverview(projectId) {
  window.location.href = "overview.html?id=" + projectId;
}

function deleteProject(id, name) {
  if (!confirm('Delete "' + name + '"?\n\nThis will permanently remove the project and all its data. This cannot be undone.')) return;
  var entered = prompt('To confirm, type your email address:');
  if (!entered) return;
  if (entered.trim().toLowerCase() !== (currentUser.email || "").toLowerCase()) {
    alert("Email does not match. Deletion cancelled.");
    return;
  }
  sb.from("projects").delete().eq("id", id).eq("user_id", currentUser.id)
    .then(function(res) {
      if (res.error) { alert("Error: " + res.error.message); return; }
      loadProjects(currentUser.id);
    });
}

function doSignout() {
  sb.auth.signOut();
}
</script>

</body>
</html>
